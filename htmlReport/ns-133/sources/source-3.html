<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > BaseEntityData</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.edqs.data</a>
</div>

<h1>Coverage Summary for Class: BaseEntityData (org.thingsboard.server.edqs.data)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BaseEntityData</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/55)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BaseEntityData$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/55)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.edqs.data;
&nbsp;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import lombok.ToString;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.edqs.fields.EntityFields;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.permission.QueryContext;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyType;
&nbsp;import org.thingsboard.server.edqs.data.dp.BoolDataPoint;
&nbsp;import org.thingsboard.server.common.data.edqs.DataPoint;
&nbsp;import org.thingsboard.server.edqs.data.dp.LongDataPoint;
&nbsp;import org.thingsboard.server.edqs.data.dp.StringDataPoint;
&nbsp;import org.thingsboard.server.edqs.query.DataKey;
&nbsp;import org.thingsboard.server.edqs.repo.TenantRepo;
&nbsp;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;
&nbsp;@ToString
&nbsp;public abstract class BaseEntityData&lt;T extends EntityFields&gt; implements EntityData&lt;T&gt; {
&nbsp;
&nbsp;    @Getter
&nbsp;    private final UUID id;
&nbsp;    @Getter
&nbsp;    protected final Map&lt;Integer, DataPoint&gt; serverAttrMap;
&nbsp;    @Getter
&nbsp;    private final Map&lt;Integer, DataPoint&gt; tMap;
&nbsp;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private volatile UUID customerId;
&nbsp;
&nbsp;    @Setter
&nbsp;    protected TenantRepo repo;
&nbsp;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    protected volatile T fields;
&nbsp;
<b class="nc">&nbsp;    public BaseEntityData(UUID id) {</b>
<b class="nc">&nbsp;        this.id = id;</b>
<b class="nc">&nbsp;        this.serverAttrMap = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        this.tMap = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DataPoint getAttr(Integer keyId, EntityKeyType entityKeyType) {
<b class="nc">&nbsp;        return switch (entityKeyType) {</b>
<b class="nc">&nbsp;            case ATTRIBUTE, SERVER_ATTRIBUTE -&gt; serverAttrMap.get(keyId);</b>
<b class="nc">&nbsp;            default -&gt; null;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean putAttr(Integer keyId, AttributeScope scope, DataPoint value) {
<b class="nc">&nbsp;        return serverAttrMap.put(keyId, value) == null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean removeAttr(Integer keyId, AttributeScope scope) {
<b class="nc">&nbsp;        return serverAttrMap.remove(keyId) != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DataPoint getTs(Integer keyId) {
<b class="nc">&nbsp;        return tMap.get(keyId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean putTs(Integer keyId, DataPoint value) {
<b class="nc">&nbsp;        return tMap.put(keyId, value) == null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean removeTs(Integer keyId) {
<b class="nc">&nbsp;        return tMap.remove(keyId) != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getOwnerName() {
<b class="nc">&nbsp;        return repo.getOwnerEntityName(isTenantEntity() ? repo.getTenantId() : new CustomerId(getCustomerId()));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getOwnerType() {
<b class="nc">&nbsp;        return isTenantEntity() ? EntityType.TENANT.name() :  EntityType.CUSTOMER.name();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DataPoint getDataPoint(DataKey key, QueryContext ctx) {
<b class="nc">&nbsp;        return switch (key.type()) {</b>
<b class="nc">&nbsp;            case TIME_SERIES -&gt; getTs(key.keyId());</b>
<b class="nc">&nbsp;            case ATTRIBUTE, SERVER_ATTRIBUTE, CLIENT_ATTRIBUTE, SHARED_ATTRIBUTE -&gt; getAttr(key.keyId(), key.type());</b>
<b class="nc">&nbsp;            case ENTITY_FIELD -&gt; getField(key, ctx);</b>
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(key.type() + &quot; not supported&quot;);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private DataPoint getField(DataKey newKey, QueryContext ctx) {
<b class="nc">&nbsp;        if (fields == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        String key = newKey.key();</b>
<b class="nc">&nbsp;        return switch (key) {</b>
<b class="nc">&nbsp;            case &quot;createdTime&quot; -&gt; new LongDataPoint(System.currentTimeMillis(), fields.getCreatedTime());</b>
<b class="nc">&nbsp;            case &quot;edgeTemplate&quot; -&gt; new BoolDataPoint(System.currentTimeMillis(), fields.isEdgeTemplate());</b>
<b class="nc">&nbsp;            case &quot;parentId&quot; -&gt; new StringDataPoint(System.currentTimeMillis(), getRelatedParentId(ctx), false);</b>
<b class="nc">&nbsp;            default -&gt; new StringDataPoint(System.currentTimeMillis(), getField(key), false);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getField(String name) {
<b class="nc">&nbsp;        if (fields == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (name) {</b>
<b class="nc">&nbsp;            case &quot;name&quot; -&gt; getEntityName();</b>
<b class="nc">&nbsp;            case &quot;ownerName&quot; -&gt; getOwnerName();</b>
<b class="nc">&nbsp;            case &quot;ownerType&quot; -&gt; getOwnerType();</b>
<b class="nc">&nbsp;            case &quot;displayName&quot; -&gt; getDisplayName();</b>
<b class="nc">&nbsp;            case &quot;entityType&quot; -&gt; Optional.ofNullable(getEntityType()).map(EntityType::name).orElse(&quot;&quot;);</b>
<b class="nc">&nbsp;            default -&gt; fields.getAsString(name);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public String getDisplayName(){
<b class="nc">&nbsp;        return switch (getEntityType()) {</b>
<b class="nc">&nbsp;            case DEVICE, ASSET -&gt; StringUtils.isNotBlank(fields.getLabel()) ? fields.getLabel() : fields.getName();</b>
&nbsp;            case USER -&gt; {
<b class="nc">&nbsp;                boolean firstNameSet = StringUtils.isNotBlank(fields.getFirstName());</b>
<b class="nc">&nbsp;                boolean lastNameSet = StringUtils.isNotBlank(fields.getLastName());</b>
<b class="nc">&nbsp;                if(firstNameSet &amp;&amp; lastNameSet) {</b>
<b class="nc">&nbsp;                    yield fields.getFirstName() + &quot; &quot; + fields.getLastName();</b>
<b class="nc">&nbsp;                } else if(firstNameSet) {</b>
<b class="nc">&nbsp;                    yield fields.getFirstName();</b>
<b class="nc">&nbsp;                } else if  (lastNameSet) {</b>
<b class="nc">&nbsp;                    yield fields.getLastName();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    yield fields.getEmail();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; fields.getName();</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public String getEntityName() {
<b class="nc">&nbsp;        return getFields().getName();</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isTenantEntity() {
<b class="nc">&nbsp;        return getCustomerId() == null || CustomerId.NULL_UUID.equals(getCustomerId());</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getRelatedParentId(QueryContext ctx) {
<b class="nc">&nbsp;        return Optional.ofNullable(ctx.getRelatedParentIdMap().get(getId()))</b>
<b class="nc">&nbsp;                .map(UUID::toString)</b>
<b class="nc">&nbsp;                .orElse(&quot;&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isEmpty() {
<b class="nc">&nbsp;        return fields == null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean equals(Object o) {
<b class="nc">&nbsp;        if (this == o) return true;</b>
<b class="nc">&nbsp;        if (o == null || getClass() != o.getClass()) return false;</b>
<b class="nc">&nbsp;        BaseEntityData&lt;?&gt; that = (BaseEntityData&lt;?&gt;) o;</b>
<b class="nc">&nbsp;        return Objects.equals(id, that.id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int hashCode() {
<b class="nc">&nbsp;        return Objects.hash(id);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultLwM2MAttributesService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.transport.lwm2m.server.attributes</a>
</div>

<h1>Coverage Summary for Class: DefaultLwM2MAttributesService (org.thingsboard.server.transport.lwm2m.server.attributes)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultLwM2MAttributesService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/110)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultLwM2MAttributesService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultLwM2MAttributesService$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultLwM2MAttributesService$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/121)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.transport.lwm2m.server.attributes;
&nbsp;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.SettableFuture;
&nbsp;import com.google.gson.JsonElement;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.eclipse.leshan.core.model.ResourceModel;
&nbsp;import org.eclipse.leshan.core.node.LwM2mPath;
&nbsp;import org.eclipse.leshan.core.node.LwM2mResource;
&nbsp;import org.eclipse.leshan.core.node.LwM2mResourceInstance;
&nbsp;import org.eclipse.leshan.core.request.WriteRequest;
&nbsp;import org.eclipse.leshan.core.response.WriteResponse;
&nbsp;import org.eclipse.leshan.server.model.LwM2mModelProvider;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.server.common.transport.TransportService;
&nbsp;import org.thingsboard.server.common.transport.TransportServiceCallback;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetAttributeResponseMsg;
&nbsp;import org.thingsboard.server.queue.util.TbLwM2mTransportComponent;
&nbsp;import org.thingsboard.server.transport.lwm2m.config.LwM2MTransportServerConfig;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.LwM2mTransportServerHelper;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.client.LwM2mClient;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.client.LwM2mClientContext;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.downlink.LwM2mDownlinkMsgHandler;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.downlink.TbLwM2MWriteReplaceRequest;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.downlink.TbLwM2MWriteResponseCallback;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.log.LwM2MTelemetryLogService;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.ota.LwM2MOtaUpdateService;
&nbsp;import org.thingsboard.server.transport.lwm2m.server.uplink.LwM2mUplinkMsgHandler;
&nbsp;import org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil;
&nbsp;import org.thingsboard.server.transport.lwm2m.utils.LwM2mValueConverterImpl;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.LwM2mTransportServerHelper.getValueFromKvProto;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.FIRMWARE_TAG;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.FIRMWARE_TITLE;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.FIRMWARE_URL;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.FIRMWARE_VERSION;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.SOFTWARE_TAG;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.SOFTWARE_TITLE;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.SOFTWARE_URL;
&nbsp;import static org.thingsboard.server.transport.lwm2m.server.ota.DefaultLwM2MOtaUpdateService.SOFTWARE_VERSION;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.LOG_LWM2M_ERROR;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.LOG_LWM2M_WARN;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.compareAttNameKeyOta;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.convertMultiResourceValuesFromJson;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.fromVersionedIdToObjectId;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.valueEquals;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@TbLwM2mTransportComponent
&nbsp;@RequiredArgsConstructor
&nbsp;public class DefaultLwM2MAttributesService implements LwM2MAttributesService {
&nbsp;
&nbsp;    //TODO: add timeout logic
&nbsp;    private final AtomicInteger reqIdSeq = new AtomicInteger();
&nbsp;    private final Map&lt;Integer, SettableFuture&lt;List&lt;TransportProtos.TsKvProto&gt;&gt;&gt; futures;
&nbsp;
&nbsp;    private final TransportService transportService;
&nbsp;    private final LwM2mTransportServerHelper helper;
&nbsp;    private final LwM2mClientContext clientContext;
&nbsp;    private final LwM2MTransportServerConfig config;
&nbsp;    private final LwM2mUplinkMsgHandler uplinkHandler;
&nbsp;    private final LwM2mDownlinkMsgHandler downlinkHandler;
&nbsp;    private final LwM2MTelemetryLogService logService;
&nbsp;    private final LwM2MOtaUpdateService otaUpdateService;
&nbsp;    private final LwM2mModelProvider modelProvider;
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;TransportProtos.TsKvProto&gt;&gt; getSharedAttributes(LwM2mClient client, Collection&lt;String&gt; keys) {
<b class="nc">&nbsp;        SettableFuture&lt;List&lt;TransportProtos.TsKvProto&gt;&gt; future = SettableFuture.create();</b>
<b class="nc">&nbsp;        int requestId = reqIdSeq.incrementAndGet();</b>
<b class="nc">&nbsp;        futures.put(requestId, future);</b>
<b class="nc">&nbsp;        transportService.process(client.getSession(), TransportProtos.GetAttributeRequestMsg.newBuilder().setRequestId(requestId).</b>
<b class="nc">&nbsp;                addAllSharedAttributeNames(keys).build(), new TransportServiceCallback&lt;Void&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(Void msg) {
&nbsp;
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void onError(Throwable e) {
<b class="nc">&nbsp;                SettableFuture&lt;List&lt;TransportProtos.TsKvProto&gt;&gt; callback = futures.remove(requestId);</b>
<b class="nc">&nbsp;                if (callback != null) {</b>
<b class="nc">&nbsp;                    callback.setException(e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        return future;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onGetAttributesResponse(GetAttributeResponseMsg getAttributesResponse, TransportProtos.SessionInfoProto sessionInfo) {
<b class="nc">&nbsp;        var callback = futures.remove(getAttributesResponse.getRequestId());</b>
<b class="nc">&nbsp;        if (callback != null) {</b>
<b class="nc">&nbsp;            callback.set(getAttributesResponse.getSharedAttributeListList());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Update - send request in change value resources in Client
&nbsp;     * 1. FirmwareUpdate:
&nbsp;     * - If msg.getSharedUpdatedList().forEach(tsKvProto -&gt; {tsKvProto.getKv().getKey().indexOf(FIRMWARE_UPDATE_PREFIX, 0) == 0
&nbsp;     * 2. Shared Other AttributeUpdate
&nbsp;     * -- Path to resources from profile equal keyName or from ModelObject equal name
&nbsp;     * -- Only for resources:  isWritable &amp;&amp; isPresent as attribute in profile -&gt; LwM2MClientProfile (format: CamelCase)
&nbsp;     * 3. Delete - nothing
&nbsp;     *
&nbsp;     * @param msg -
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void onAttributesUpdate(TransportProtos.AttributeUpdateNotificationMsg msg, TransportProtos.SessionInfoProto sessionInfo) {
<b class="nc">&nbsp;        LwM2mClient lwM2MClient = clientContext.getClientBySessionInfo(sessionInfo);</b>
<b class="nc">&nbsp;        if (msg.getSharedUpdatedCount() &gt; 0 &amp;&amp; lwM2MClient != null) {</b>
<b class="nc">&nbsp;            String newFirmwareTitle = null;</b>
<b class="nc">&nbsp;            String newFirmwareVersion = null;</b>
<b class="nc">&nbsp;            String newFirmwareTag = null;</b>
<b class="nc">&nbsp;            String newFirmwareUrl = null;</b>
<b class="nc">&nbsp;            String newSoftwareTitle = null;</b>
<b class="nc">&nbsp;            String newSoftwareVersion = null;</b>
<b class="nc">&nbsp;            String newSoftwareTag = null;</b>
<b class="nc">&nbsp;            String newSoftwareUrl = null;</b>
<b class="nc">&nbsp;            List&lt;TransportProtos.TsKvProto&gt; otherAttributes = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (TransportProtos.TsKvProto tsKvProto : msg.getSharedUpdatedList()) {</b>
<b class="nc">&nbsp;                String attrName = tsKvProto.getKv().getKey();</b>
<b class="nc">&nbsp;                if (compareAttNameKeyOta(attrName)) {</b>
<b class="nc">&nbsp;                    if (FIRMWARE_TITLE.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newFirmwareTitle = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (FIRMWARE_VERSION.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newFirmwareVersion = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (FIRMWARE_TAG.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newFirmwareTag = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (FIRMWARE_URL.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newFirmwareUrl = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (SOFTWARE_TITLE.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newSoftwareTitle = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (SOFTWARE_VERSION.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newSoftwareVersion = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (SOFTWARE_TAG.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newSoftwareTag = getStrValue(tsKvProto);</b>
<b class="nc">&nbsp;                    } else if (SOFTWARE_URL.equals(attrName)) {</b>
<b class="nc">&nbsp;                        newSoftwareUrl = getStrValue(tsKvProto);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    otherAttributes.add(tsKvProto);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (newFirmwareTitle != null || newFirmwareVersion != null) {</b>
<b class="nc">&nbsp;                otaUpdateService.onTargetFirmwareUpdate(lwM2MClient, newFirmwareTitle, newFirmwareVersion, Optional.ofNullable(newFirmwareUrl), Optional.ofNullable(newFirmwareTag));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (newSoftwareTitle != null || newSoftwareVersion != null) {</b>
<b class="nc">&nbsp;                otaUpdateService.onTargetSoftwareUpdate(lwM2MClient, newSoftwareTitle, newSoftwareVersion, Optional.ofNullable(newSoftwareUrl), Optional.ofNullable(newSoftwareTag));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!otherAttributes.isEmpty()) {</b>
<b class="nc">&nbsp;                onAttributesUpdate(lwM2MClient, otherAttributes, true);</b>
&nbsp;            }
<b class="nc">&nbsp;        } else if (lwM2MClient == null) {</b>
<b class="nc">&nbsp;            log.error(&quot;OnAttributeUpdate, lwM2MClient is null&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * #1.1 If two names have equal path =&gt; last time attribute
&nbsp;     * #2.1 if there is a difference in values between the current resource values and the shared attribute values
&nbsp;     * =&gt; send to client Request Update of value (new value from shared attribute)
&nbsp;     * and LwM2MClient.delayedRequests.add(path)
&nbsp;     * #2.1 if there is not a difference in values between the current resource values and the shared attribute values
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void onAttributesUpdate(LwM2mClient lwM2MClient, List&lt;TransportProtos.TsKvProto&gt; tsKvProtos, boolean logFailedUpdateOfNonChangedValue) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] onAttributesUpdate [{}]&quot;, lwM2MClient.getEndpoint(), tsKvProtos);</b>
<b class="nc">&nbsp;        Map&lt;String, TransportProtos.TsKvProto&gt; attributesUpdate = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        tsKvProtos.forEach(tsKvProto -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                String pathIdVer = clientContext.getObjectIdByKeyNameFromProfile(lwM2MClient, tsKvProto.getKv().getKey());</b>
<b class="nc">&nbsp;                if (pathIdVer != null) {</b>
&nbsp;                    // #1.1
<b class="nc">&nbsp;                    if (lwM2MClient.getSharedAttributes().containsKey(pathIdVer)) {</b>
<b class="nc">&nbsp;                        if (tsKvProto.getTs() &gt; lwM2MClient.getSharedAttributes().get(pathIdVer).getTs()) {</b>
<b class="nc">&nbsp;                            attributesUpdate.put(pathIdVer, tsKvProto);</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        attributesUpdate.put(pathIdVer, tsKvProto);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;                log.error(&quot;Failed update resource [&quot; + lwM2MClient.getEndpoint() + &quot;] onAttributesUpdate:&quot;, e);</b>
<b class="nc">&nbsp;                String logMsg = String.format(&quot;%s: Failed update resource onAttributesUpdate %s.&quot;,</b>
<b class="nc">&nbsp;                        LOG_LWM2M_ERROR, e.getMessage());</b>
<b class="nc">&nbsp;                logService.log(lwM2MClient, logMsg);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        clientContext.update(lwM2MClient);</b>
&nbsp;        // #2.1
<b class="nc">&nbsp;        attributesUpdate.forEach((pathIdVer, tsKvProto) -&gt; {</b>
<b class="nc">&nbsp;            ResourceModel resourceModel = lwM2MClient.getResourceModel(pathIdVer, modelProvider);</b>
<b class="nc">&nbsp;            Object newValProto = getValueFromKvProto(tsKvProto.getKv());</b>
<b class="nc">&nbsp;            Object oldResourceValue = this.getResourceValueFormatKv(lwM2MClient, pathIdVer);</b>
<b class="nc">&nbsp;            if (!resourceModel.multiple || !(newValProto instanceof JsonElement)) {</b>
<b class="nc">&nbsp;                this.pushUpdateToClientIfNeeded(lwM2MClient, oldResourceValue, newValProto, pathIdVer, tsKvProto, logFailedUpdateOfNonChangedValue);</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    pushUpdateMultiToClientIfNeeded(lwM2MClient, resourceModel, (JsonElement) newValProto,</b>
&nbsp;                            (Map&lt;Integer, LwM2mResourceInstance&gt;) oldResourceValue, pathIdVer, tsKvProto, logFailedUpdateOfNonChangedValue);
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.error(&quot;Failed update resource [&quot; + lwM2MClient.getEndpoint() + &quot;] onAttributesUpdate:&quot;, e);</b>
<b class="nc">&nbsp;                    String logMsg = String.format(&quot;%s: Failed update resource onAttributesUpdate %s.&quot;,</b>
<b class="nc">&nbsp;                            LOG_LWM2M_ERROR, e.getMessage());</b>
<b class="nc">&nbsp;                    logService.log(lwM2MClient, logMsg);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private void pushUpdateToClientIfNeeded(LwM2mClient lwM2MClient, Object oldValue, Object newValue,
&nbsp;                                            String versionedId, TransportProtos.TsKvProto tsKvProto, boolean logFailedUpdateOfNonChangedValue) {
<b class="nc">&nbsp;        if (newValue == null) {</b>
<b class="nc">&nbsp;            String logMsg = String.format(&quot;%s: Failed update resource versionedId - %s value - %s. New value is  bad&quot;,</b>
&nbsp;                    LOG_LWM2M_ERROR, versionedId, &quot;null&quot;);
<b class="nc">&nbsp;            logService.log(lwM2MClient, logMsg);</b>
<b class="nc">&nbsp;            log.error(&quot;Failed update resource [{}] [{}]&quot;, versionedId, &quot;null&quot;);</b>
<b class="nc">&nbsp;        } else if ((oldValue == null) || !valueEquals(newValue, oldValue)) {</b>
<b class="nc">&nbsp;            TbLwM2MWriteReplaceRequest request = TbLwM2MWriteReplaceRequest.builder().versionedId(versionedId).value(newValue).timeout(clientContext.getRequestTimeout(lwM2MClient)).build();</b>
<b class="nc">&nbsp;            downlinkHandler.sendWriteReplaceRequest(lwM2MClient, request, new TbLwM2MWriteResponseCallback(uplinkHandler, logService, lwM2MClient, versionedId) {</b>
&nbsp;                @Override
&nbsp;                public void onSuccess(WriteRequest request, WriteResponse response) {
<b class="nc">&nbsp;                    client.getSharedAttributes().put(versionedId, tsKvProto);</b>
<b class="nc">&nbsp;                    super.onSuccess(request, response);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;        } else if (logFailedUpdateOfNonChangedValue) {</b>
<b class="nc">&nbsp;            String logMsg = String.format(&quot;%s: Didn&#39;t update the versionedId resource - %s value - %s. Value is not changed&quot;,</b>
&nbsp;                    LOG_LWM2M_WARN, versionedId, newValue);
<b class="nc">&nbsp;            logService.log(lwM2MClient, logMsg);</b>
<b class="nc">&nbsp;            log.warn(&quot;Didn&#39;t update resource [{}] [{}]. Value is not changed&quot;, versionedId, newValue);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void pushUpdateMultiToClientIfNeeded(LwM2mClient client, ResourceModel resourceModel, JsonElement newValProto,
&nbsp;                                                 Map&lt;Integer, LwM2mResourceInstance&gt; valueOld, String versionedId,
&nbsp;                                                 TransportProtos.TsKvProto tsKvProto, boolean logFailedUpdateOfNonChangedValue) {
<b class="nc">&nbsp;        Map&lt;Integer, Object&gt; newValues = convertMultiResourceValuesFromJson(newValProto, resourceModel.type, versionedId);</b>
<b class="nc">&nbsp;        if (newValues.size() &gt; 0 &amp;&amp; valueOld != null &amp;&amp; valueOld.size() &gt; 0) {</b>
<b class="nc">&nbsp;            valueOld.values().forEach((v) -&gt; {</b>
<b class="nc">&nbsp;                if (newValues.containsKey(v.getId())) {</b>
<b class="nc">&nbsp;                    if (valueEquals(newValues.get(v.getId()), v.getValue())) {</b>
<b class="nc">&nbsp;                        newValues.remove(v.getId());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (newValues.size() &gt; 0) {</b>
<b class="nc">&nbsp;            TbLwM2MWriteReplaceRequest request = TbLwM2MWriteReplaceRequest.builder().versionedId(versionedId).value(newValues).timeout(this.config.getTimeout()).build();</b>
<b class="nc">&nbsp;            downlinkHandler.sendWriteReplaceRequest(client, request, new TbLwM2MWriteResponseCallback(uplinkHandler, logService, client, versionedId) {</b>
&nbsp;                @Override
&nbsp;                public void onSuccess(WriteRequest request, WriteResponse response) {
<b class="nc">&nbsp;                    client.getSharedAttributes().put(versionedId, tsKvProto);</b>
<b class="nc">&nbsp;                    super.onSuccess(request, response);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;        } else if (logFailedUpdateOfNonChangedValue) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Didn&#39;t update resource [{}] [{}]&quot;, versionedId, newValProto);</b>
<b class="nc">&nbsp;            String logMsg = String.format(&quot;%s: Didn&#39;t update resource versionedId - %s value - %s. Value is not changed&quot;,</b>
&nbsp;                    LOG_LWM2M_WARN, versionedId, newValProto);
<b class="nc">&nbsp;            logService.log(client, logMsg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param pathIdVer - path resource
&nbsp;     * @return - value of Resource into format KvProto or null
&nbsp;     */
&nbsp;    private Object getResourceValueFormatKv(LwM2mClient lwM2MClient, String pathIdVer) {
<b class="nc">&nbsp;        LwM2mResource resourceValue = LwM2MTransportUtil.getResourceValueFromLwM2MClient(lwM2MClient, pathIdVer);</b>
<b class="nc">&nbsp;        if (resourceValue != null) {</b>
<b class="nc">&nbsp;            ResourceModel.Type currentType = resourceValue.getType();</b>
<b class="nc">&nbsp;            ResourceModel.Type expectedType = helper.getResourceModelTypeEqualsKvProtoValueType(currentType, pathIdVer);</b>
<b class="nc">&nbsp;            if (!resourceValue.isMultiInstances()) {</b>
<b class="nc">&nbsp;                return LwM2mValueConverterImpl.getInstance().convertValue(resourceValue.getValue(), currentType, expectedType,</b>
<b class="nc">&nbsp;                        new LwM2mPath(fromVersionedIdToObjectId(pathIdVer)));</b>
<b class="nc">&nbsp;            } else if (resourceValue.getInstances().size() &gt; 0) {</b>
<b class="nc">&nbsp;                return resourceValue.getInstances();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String getStrValue(TransportProtos.TsKvProto tsKvProto) {
<b class="nc">&nbsp;        return tsKvProto.getKv().getStringV();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

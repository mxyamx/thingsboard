<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AbstractTbQueueConsumerTemplate</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.queue.common</a>
</div>

<h1>Coverage Summary for Class: AbstractTbQueueConsumerTemplate (org.thingsboard.server.queue.common)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AbstractTbQueueConsumerTemplate</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.queue.common;
&nbsp;
&nbsp;import jakarta.annotation.Nonnull;
&nbsp;import lombok.Getter;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;
&nbsp;import org.thingsboard.server.queue.TbQueueConsumer;
&nbsp;import org.thingsboard.server.queue.TbQueueMsg;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Queue;
&nbsp;import java.util.Set;
&nbsp;import java.util.concurrent.ConcurrentLinkedQueue;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;
&nbsp;import static java.util.Collections.emptyList;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public abstract class AbstractTbQueueConsumerTemplate&lt;R, T extends TbQueueMsg&gt; implements TbQueueConsumer&lt;T&gt; {
&nbsp;
<b class="nc">&nbsp;    public static final long ONE_MILLISECOND_IN_NANOS = TimeUnit.MILLISECONDS.toNanos(1);</b>
&nbsp;    private volatile boolean subscribed;
<b class="nc">&nbsp;    protected volatile boolean stopped = false;</b>
&nbsp;    protected volatile Set&lt;TopicPartitionInfo&gt; partitions;
<b class="nc">&nbsp;    protected final ReentrantLock consumerLock = new ReentrantLock(); //NonfairSync</b>
<b class="nc">&nbsp;    final Queue&lt;Set&lt;TopicPartitionInfo&gt;&gt; subscribeQueue = new ConcurrentLinkedQueue&lt;&gt;();</b>
&nbsp;
&nbsp;    @Getter
&nbsp;    private final String topic;
&nbsp;
<b class="nc">&nbsp;    public AbstractTbQueueConsumerTemplate(String topic) {</b>
<b class="nc">&nbsp;        this.topic = topic;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void subscribe() {
<b class="nc">&nbsp;        log.debug(&quot;enqueue topic subscribe {} &quot;, topic);</b>
<b class="nc">&nbsp;        if (stopped) {</b>
<b class="nc">&nbsp;            log.error(&quot;trying subscribe, but consumer stopped for topic {}&quot;, topic);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        subscribeQueue.add(Collections.singleton(new TopicPartitionInfo(topic, null, null, true)));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void subscribe(Set&lt;TopicPartitionInfo&gt; partitions) {
<b class="nc">&nbsp;        log.debug(&quot;enqueue topics subscribe {} &quot;, partitions);</b>
<b class="nc">&nbsp;        if (stopped) {</b>
<b class="nc">&nbsp;            log.error(&quot;trying subscribe, but consumer stopped for topic {}&quot;, topic);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        subscribeQueue.add(partitions);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;T&gt; poll(long durationInMillis) {
&nbsp;        List&lt;R&gt; records;
<b class="nc">&nbsp;        long startNanos = System.nanoTime();</b>
<b class="nc">&nbsp;        if (stopped) {</b>
<b class="nc">&nbsp;            log.error(&quot;poll invoked but consumer stopped for topic &quot; + topic, new RuntimeException(&quot;stacktrace&quot;));</b>
<b class="nc">&nbsp;            return emptyList();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!subscribed &amp;&amp; partitions == null &amp;&amp; subscribeQueue.isEmpty()) {</b>
<b class="nc">&nbsp;            return sleepAndReturnEmpty(startNanos, durationInMillis);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (consumerLock.isLocked()) {</b>
<b class="nc">&nbsp;            log.error(&quot;poll. consumerLock is locked. will wait with no timeout. it looks like a race conditions or deadlock topic &quot; + topic, new RuntimeException(&quot;stacktrace&quot;));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        consumerLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            while (!subscribeQueue.isEmpty()) {</b>
<b class="nc">&nbsp;                subscribed = false;</b>
<b class="nc">&nbsp;                partitions = subscribeQueue.poll();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!subscribed) {</b>
<b class="nc">&nbsp;                log.info(&quot;Subscribing to {}&quot;, partitions);</b>
<b class="nc">&nbsp;                doSubscribe(partitions);</b>
<b class="nc">&nbsp;                subscribed = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            records = partitions.isEmpty() ? emptyList() : doPoll(durationInMillis);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            consumerLock.unlock();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (records.isEmpty() &amp;&amp; !isLongPollingSupported()) {</b>
<b class="nc">&nbsp;            return sleepAndReturnEmpty(startNanos, durationInMillis);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return decodeRecords(records);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Nonnull
&nbsp;    List&lt;T&gt; decodeRecords(@Nonnull List&lt;R&gt; records) {
<b class="nc">&nbsp;        List&lt;T&gt; result = new ArrayList&lt;&gt;(records.size());</b>
<b class="nc">&nbsp;        records.forEach(record -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                if (record != null) {</b>
<b class="nc">&nbsp;                    result.add(decode(record));</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Failed to decode record {}&quot;, record, e);</b>
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Failed to decode record &quot; + record, e);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    List&lt;T&gt; sleepAndReturnEmpty(final long startNanos, final long durationInMillis) {
<b class="nc">&nbsp;        long durationNanos = TimeUnit.MILLISECONDS.toNanos(durationInMillis);</b>
<b class="nc">&nbsp;        long spentNanos = System.nanoTime() - startNanos;</b>
<b class="nc">&nbsp;        long nanosLeft = durationNanos - spentNanos;</b>
<b class="nc">&nbsp;        if (nanosLeft &gt;= ONE_MILLISECOND_IN_NANOS) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                long sleepMs = TimeUnit.NANOSECONDS.toMillis(nanosLeft);</b>
<b class="nc">&nbsp;                log.trace(&quot;Going to sleep after poll: topic {} for {}ms&quot;, topic, sleepMs);</b>
<b class="nc">&nbsp;                Thread.sleep(sleepMs);</b>
&nbsp;            } catch (InterruptedException e) {
<b class="nc">&nbsp;                if (!stopped) {</b>
<b class="nc">&nbsp;                    log.error(&quot;Failed to wait&quot;, e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return emptyList();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void commit() {
<b class="nc">&nbsp;        if (consumerLock.isLocked()) {</b>
<b class="nc">&nbsp;            if (stopped) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            log.error(&quot;commit. consumerLock is locked. will wait with no timeout. it looks like a race conditions or deadlock topic &quot; + topic, new RuntimeException(&quot;stacktrace&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        consumerLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            doCommit();</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            consumerLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void stop() {
<b class="nc">&nbsp;        stopped = true;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unsubscribe() {
<b class="nc">&nbsp;        log.info(&quot;Unsubscribing and stopping consumer for {}&quot;, partitions);</b>
<b class="nc">&nbsp;        stopped = true;</b>
<b class="nc">&nbsp;        consumerLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (subscribed) {</b>
<b class="nc">&nbsp;                doUnsubscribe();</b>
&nbsp;            }
&nbsp;        } finally {
<b class="nc">&nbsp;            consumerLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isStopped() {
<b class="nc">&nbsp;        return stopped;</b>
&nbsp;    }
&nbsp;
&nbsp;    abstract protected List&lt;R&gt; doPoll(long durationInMillis);
&nbsp;
&nbsp;    abstract protected T decode(R record) throws IOException;
&nbsp;
&nbsp;    abstract protected void doSubscribe(Set&lt;TopicPartitionInfo&gt; partitions);
&nbsp;
&nbsp;    abstract protected void doCommit();
&nbsp;
&nbsp;    abstract protected void doUnsubscribe();
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;TopicPartitionInfo&gt; getPartitions() {
<b class="nc">&nbsp;        return partitions;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;String&gt; getFullTopicNames() {
<b class="nc">&nbsp;        if (partitions == null) {</b>
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        }
<b class="nc">&nbsp;        return partitions.stream()</b>
<b class="nc">&nbsp;                .map(TopicPartitionInfo::getFullTopicName)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    protected boolean isLongPollingSupported() {
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

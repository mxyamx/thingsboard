<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultTbEntityViewService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.entitiy.entityview</a>
</div>

<h1>Coverage Summary for Class: DefaultTbEntityViewService (org.thingsboard.server.service.entitiy.entityview)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultTbEntityViewService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/174)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultTbEntityViewService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultTbEntityViewService$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultTbEntityViewService$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultTbEntityViewService$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.entitiy.entityview;
&nbsp;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import com.google.common.util.concurrent.SettableFuture;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.util.ConcurrentReferenceHashMap;
&nbsp;import org.thingsboard.rule.engine.api.AttributesDeleteRequest;
&nbsp;import org.thingsboard.rule.engine.api.AttributesSaveRequest;
&nbsp;import org.thingsboard.rule.engine.api.TimeseriesDeleteRequest;
&nbsp;import org.thingsboard.rule.engine.api.TimeseriesSaveRequest;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.NameConflictStrategy;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityViewId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.kv.AttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.BaseReadTsKvQuery;
&nbsp;import org.thingsboard.server.common.data.kv.ReadTsKvQuery;
&nbsp;import org.thingsboard.server.common.data.kv.TsKvEntry;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentLifecycleEvent;
&nbsp;import org.thingsboard.server.common.msg.plugin.ComponentLifecycleMsg;
&nbsp;import org.thingsboard.server.dao.attributes.AttributesService;
&nbsp;import org.thingsboard.server.dao.entityview.EntityViewService;
&nbsp;import org.thingsboard.server.dao.timeseries.TimeseriesService;
&nbsp;import org.thingsboard.server.service.entitiy.AbstractTbEntityService;
&nbsp;import org.thingsboard.server.service.telemetry.TelemetrySubscriptionService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.isBlank;
&nbsp;
&nbsp;@Service
&nbsp;@AllArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class DefaultTbEntityViewService extends AbstractTbEntityService implements TbEntityViewService {
&nbsp;
&nbsp;    private final EntityViewService entityViewService;
&nbsp;    private final AttributesService attributesService;
&nbsp;    private final TelemetrySubscriptionService tsSubService;
&nbsp;    private final TimeseriesService tsService;
&nbsp;
&nbsp;    final Map&lt;TenantId, Map&lt;EntityId, List&lt;EntityView&gt;&gt;&gt; localCache = new ConcurrentHashMap&lt;&gt;();
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView save(EntityView entityView, EntityView existingEntityView, User user) throws Exception {
<b class="nc">&nbsp;        return save(entityView, existingEntityView, NameConflictStrategy.DEFAULT, user);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView save(EntityView entityView, EntityView existingEntityView, NameConflictStrategy nameConflictStrategy, User user) throws Exception {
<b class="nc">&nbsp;        ActionType actionType = entityView.getId() == null ? ActionType.ADDED : ActionType.UPDATED;</b>
<b class="nc">&nbsp;        TenantId tenantId = entityView.getTenantId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.saveEntityView(entityView, nameConflictStrategy));</b>
<b class="nc">&nbsp;            this.updateEntityViewAttributes(tenantId, savedEntityView, existingEntityView, user);</b>
<b class="nc">&nbsp;            autoCommit(user, savedEntityView.getId());</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(savedEntityView.getTenantId(), savedEntityView.getId(), savedEntityView,</b>
&nbsp;                    null, actionType, user);
<b class="nc">&nbsp;            localCache.computeIfAbsent(savedEntityView.getTenantId(), (k) -&gt; new ConcurrentReferenceHashMap&lt;&gt;()).clear();</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(user.getTenantId(), emptyId(EntityType.ENTITY_VIEW), entityView, actionType, user, e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateEntityViewAttributes(TenantId tenantId, EntityView savedEntityView, EntityView oldEntityView, User user) throws ThingsboardException {
<b class="nc">&nbsp;        List&lt;ListenableFuture&lt;?&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        if (oldEntityView != null) {</b>
<b class="nc">&nbsp;            if (oldEntityView.getKeys() != null &amp;&amp; oldEntityView.getKeys().getAttributes() != null) {</b>
<b class="nc">&nbsp;                futures.add(deleteAttributesFromEntityView(oldEntityView, AttributeScope.CLIENT_SCOPE, oldEntityView.getKeys().getAttributes().getCs(), user));</b>
<b class="nc">&nbsp;                futures.add(deleteAttributesFromEntityView(oldEntityView, AttributeScope.SERVER_SCOPE, oldEntityView.getKeys().getAttributes().getSs(), user));</b>
<b class="nc">&nbsp;                futures.add(deleteAttributesFromEntityView(oldEntityView, AttributeScope.SHARED_SCOPE, oldEntityView.getKeys().getAttributes().getSh(), user));</b>
&nbsp;            }
<b class="nc">&nbsp;            List&lt;String&gt; tsKeys = oldEntityView.getKeys() != null &amp;&amp; oldEntityView.getKeys().getTimeseries() != null ?</b>
<b class="nc">&nbsp;                    oldEntityView.getKeys().getTimeseries() : Collections.emptyList();</b>
<b class="nc">&nbsp;            futures.add(deleteLatestFromEntityView(oldEntityView, tsKeys, user));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (savedEntityView.getKeys() != null) {</b>
<b class="nc">&nbsp;            if (savedEntityView.getKeys().getAttributes() != null) {</b>
<b class="nc">&nbsp;                futures.add(copyAttributesFromEntityToEntityView(savedEntityView, AttributeScope.CLIENT_SCOPE, savedEntityView.getKeys().getAttributes().getCs(), user));</b>
<b class="nc">&nbsp;                futures.add(copyAttributesFromEntityToEntityView(savedEntityView, AttributeScope.SERVER_SCOPE, savedEntityView.getKeys().getAttributes().getSs(), user));</b>
<b class="nc">&nbsp;                futures.add(copyAttributesFromEntityToEntityView(savedEntityView, AttributeScope.SHARED_SCOPE, savedEntityView.getKeys().getAttributes().getSh(), user));</b>
&nbsp;            }
<b class="nc">&nbsp;            futures.add(copyLatestFromEntityToEntityView(tenantId, savedEntityView));</b>
&nbsp;        }
<b class="nc">&nbsp;        for (ListenableFuture&lt;?&gt; future : futures) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                future.get();</b>
&nbsp;            } catch (InterruptedException | ExecutionException e) {
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Failed to copy attributes to entity view&quot;, e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void delete(EntityView entityView, User user) throws ThingsboardException {
<b class="nc">&nbsp;        TenantId tenantId = entityView.getTenantId();</b>
<b class="nc">&nbsp;        EntityViewId entityViewId = entityView.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            entityViewService.deleteEntityView(tenantId, entityViewId);</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, entityView, entityView.getCustomerId(),</b>
<b class="nc">&nbsp;                    ActionType.DELETED, user, entityViewId.toString());</b>
&nbsp;
<b class="nc">&nbsp;            localCache.computeIfAbsent(tenantId, (k) -&gt; new ConcurrentReferenceHashMap&lt;&gt;()).clear();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    ActionType.DELETED, user, e, entityViewId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView assignEntityViewToCustomer(TenantId tenantId, EntityViewId entityViewId, Customer customer, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_CUSTOMER;</b>
<b class="nc">&nbsp;        CustomerId customerId = customer.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.assignEntityViewToCustomer(tenantId, entityViewId, customerId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, savedEntityView, savedEntityView.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, entityViewId.toString(), customerId.toString(), customer.getName());</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    actionType, user, e, entityViewId.toString(), customerId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView unassignEntityViewFromCustomer(TenantId tenantId, EntityViewId entityViewId, Customer customer, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.UNASSIGNED_FROM_CUSTOMER;</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.unassignEntityViewFromCustomer(tenantId, entityViewId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, savedEntityView, customer.getId(),</b>
<b class="nc">&nbsp;                    actionType, user, savedEntityView.getId().toString(), customer.getId().toString(), customer.getName());</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    actionType, user, e, entityViewId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView assignEntityViewToPublicCustomer(TenantId tenantId, EntityViewId entityViewId, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_CUSTOMER;</b>
<b class="nc">&nbsp;        Customer publicCustomer = customerService.findOrCreatePublicCustomer(tenantId);</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.assignEntityViewToCustomer(tenantId,</b>
<b class="nc">&nbsp;                    entityViewId, publicCustomer.getId()));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, savedEntityView, savedEntityView.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, savedEntityView.getId().toString(), publicCustomer.getId().toString(), publicCustomer.getName());</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    actionType, user, e, entityViewId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView assignEntityViewToEdge(TenantId tenantId, CustomerId customerId, EntityViewId entityViewId, Edge edge, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_EDGE;</b>
<b class="nc">&nbsp;        EdgeId edgeId = edge.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.assignEntityViewToEdge(tenantId, entityViewId, edgeId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, savedEntityView, customerId, actionType,</b>
<b class="nc">&nbsp;                    user, savedEntityView.getEntityId().toString(), edgeId.toString(), edge.getName());</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    actionType, user, e, entityViewId.toString(), edgeId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView unassignEntityViewFromEdge(TenantId tenantId, CustomerId customerId, EntityView entityView,
&nbsp;                                                 Edge edge, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.UNASSIGNED_FROM_EDGE;</b>
<b class="nc">&nbsp;        EntityViewId entityViewId = entityView.getId();</b>
<b class="nc">&nbsp;        EdgeId edgeId = edge.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            EntityView savedEntityView = checkNotNull(entityViewService.unassignEntityViewFromEdge(tenantId, entityViewId, edgeId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, entityViewId, savedEntityView, customerId, actionType,</b>
<b class="nc">&nbsp;                    user, entityViewId.toString(), edgeId.toString(), edge.getName());</b>
<b class="nc">&nbsp;            return savedEntityView;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.ENTITY_VIEW),</b>
<b class="nc">&nbsp;                    actionType, user, e, entityViewId.toString(), edgeId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntityView&gt;&gt; findEntityViewsByTenantIdAndEntityIdAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        Map&lt;EntityId, List&lt;EntityView&gt;&gt; localCacheByTenant = localCache.computeIfAbsent(tenantId, (k) -&gt; new ConcurrentReferenceHashMap&lt;&gt;());</b>
<b class="nc">&nbsp;        List&lt;EntityView&gt; fromLocalCache = localCacheByTenant.get(entityId);</b>
<b class="nc">&nbsp;        if (fromLocalCache != null) {</b>
<b class="nc">&nbsp;            return Futures.immediateFuture(fromLocalCache);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntityView&gt;&gt; future = entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(tenantId, entityId);</b>
&nbsp;
<b class="nc">&nbsp;        return Futures.transform(future, (entityViewList) -&gt; {</b>
<b class="nc">&nbsp;            localCacheByTenant.put(entityId, entityViewList);</b>
<b class="nc">&nbsp;            return entityViewList;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onComponentLifecycleMsg(ComponentLifecycleMsg componentLifecycleMsg) {
<b class="nc">&nbsp;        Map&lt;EntityId, List&lt;EntityView&gt;&gt; localCacheByTenant = localCache.computeIfAbsent(componentLifecycleMsg.getTenantId(), (k) -&gt; new ConcurrentReferenceHashMap&lt;&gt;());</b>
<b class="nc">&nbsp;        EntityViewId entityViewId = new EntityViewId(componentLifecycleMsg.getEntityId().getId());</b>
<b class="nc">&nbsp;        deleteOldCacheValue(localCacheByTenant, entityViewId);</b>
<b class="nc">&nbsp;        if (componentLifecycleMsg.getEvent() != ComponentLifecycleEvent.DELETED) {</b>
<b class="nc">&nbsp;            EntityView entityView = entityViewService.findEntityViewById(componentLifecycleMsg.getTenantId(), entityViewId);</b>
<b class="nc">&nbsp;            if (entityView != null) {</b>
<b class="nc">&nbsp;                localCacheByTenant.remove(entityView.getEntityId());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void deleteOldCacheValue(Map&lt;EntityId, List&lt;EntityView&gt;&gt; localCacheByTenant, EntityViewId entityViewId) {
<b class="nc">&nbsp;        for (var entry : localCacheByTenant.entrySet()) {</b>
<b class="nc">&nbsp;            EntityView toDelete = null;</b>
<b class="nc">&nbsp;            for (EntityView view : entry.getValue()) {</b>
<b class="nc">&nbsp;                if (entityViewId.equals(view.getId())) {</b>
<b class="nc">&nbsp;                    toDelete = view;</b>
&nbsp;                    break;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (toDelete != null) {</b>
<b class="nc">&nbsp;                entry.getValue().remove(toDelete);</b>
&nbsp;                break;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;List&lt;Void&gt;&gt; copyAttributesFromEntityToEntityView(EntityView entityView, AttributeScope scope, Collection&lt;String&gt; keys, User user) throws ThingsboardException {
<b class="nc">&nbsp;        EntityViewId entityId = entityView.getId();</b>
<b class="nc">&nbsp;        if (keys != null &amp;&amp; !keys.isEmpty()) {</b>
<b class="nc">&nbsp;            ListenableFuture&lt;List&lt;AttributeKvEntry&gt;&gt; getAttrFuture = attributesService.find(entityView.getTenantId(), entityView.getEntityId(), scope, keys);</b>
<b class="nc">&nbsp;            return Futures.transform(getAttrFuture, attributeKvEntries -&gt; {</b>
&nbsp;                List&lt;AttributeKvEntry&gt; attributes;
<b class="nc">&nbsp;                if (attributeKvEntries != null &amp;&amp; !attributeKvEntries.isEmpty()) {</b>
<b class="nc">&nbsp;                    attributes = attributeKvEntries.stream()</b>
<b class="nc">&nbsp;                            .filter(attributeKvEntry -&gt; {</b>
<b class="nc">&nbsp;                                long startTime = entityView.getStartTimeMs();</b>
<b class="nc">&nbsp;                                long endTime = entityView.getEndTimeMs();</b>
<b class="nc">&nbsp;                                long lastUpdateTs = attributeKvEntry.getLastUpdateTs();</b>
<b class="nc">&nbsp;                                return startTime == 0 &amp;&amp; endTime == 0 ||</b>
&nbsp;                                        (endTime == 0 &amp;&amp; startTime &lt; lastUpdateTs) ||
&nbsp;                                        (startTime == 0 &amp;&amp; endTime &gt; lastUpdateTs) ||
&nbsp;                                        (startTime &lt; lastUpdateTs &amp;&amp; endTime &gt; lastUpdateTs);
<b class="nc">&nbsp;                            }).collect(Collectors.toList());</b>
<b class="nc">&nbsp;                    tsSubService.saveAttributes(AttributesSaveRequest.builder()</b>
<b class="nc">&nbsp;                            .tenantId(entityView.getTenantId())</b>
<b class="nc">&nbsp;                            .entityId(entityId)</b>
<b class="nc">&nbsp;                            .scope(scope)</b>
<b class="nc">&nbsp;                            .entries(attributes)</b>
<b class="nc">&nbsp;                            .callback(new FutureCallback&lt;&gt;() {</b>
&nbsp;                                @Override
&nbsp;                                public void onSuccess(@Nullable Void tmp) {
&nbsp;                                    try {
<b class="nc">&nbsp;                                        logAttributesUpdated(entityView.getTenantId(), user, entityId, scope, attributes, null);</b>
&nbsp;                                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                                        log.error(&quot;Failed to log attribute updates&quot;, e);</b>
&nbsp;                                    }
&nbsp;                                }
&nbsp;
&nbsp;                                @Override
&nbsp;                                public void onFailure(Throwable t) {
&nbsp;                                    try {
<b class="nc">&nbsp;                                        logAttributesUpdated(entityView.getTenantId(), user, entityId, scope, attributes, t);</b>
&nbsp;                                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                                        log.error(&quot;Failed to log attribute updates&quot;, e);</b>
&nbsp;                                    }
&nbsp;                                }
&nbsp;                            })
<b class="nc">&nbsp;                            .build());</b>
&nbsp;                }
<b class="nc">&nbsp;                return null;</b>
<b class="nc">&nbsp;            }, MoreExecutors.directExecutor());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Futures.immediateFuture(null);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;List&lt;Void&gt;&gt; copyLatestFromEntityToEntityView(TenantId tenantId, EntityView entityView) {
<b class="nc">&nbsp;        EntityViewId entityId = entityView.getId();</b>
<b class="nc">&nbsp;        List&lt;String&gt; keys = entityView.getKeys() != null &amp;&amp; entityView.getKeys().getTimeseries() != null ?</b>
<b class="nc">&nbsp;                entityView.getKeys().getTimeseries() : Collections.emptyList();</b>
<b class="nc">&nbsp;        long startTs = entityView.getStartTimeMs();</b>
<b class="nc">&nbsp;        long endTs = entityView.getEndTimeMs() == 0 ? Long.MAX_VALUE : entityView.getEndTimeMs();</b>
&nbsp;        ListenableFuture&lt;List&lt;String&gt;&gt; keysFuture;
<b class="nc">&nbsp;        if (keys.isEmpty()) {</b>
<b class="nc">&nbsp;            keysFuture = Futures.transform(tsService.findAllLatest(tenantId,</b>
<b class="nc">&nbsp;                    entityView.getEntityId()), latest -&gt; latest.stream().map(TsKvEntry::getKey).collect(Collectors.toList()), MoreExecutors.directExecutor());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            keysFuture = Futures.immediateFuture(keys);</b>
&nbsp;        }
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;TsKvEntry&gt;&gt; latestFuture = Futures.transformAsync(keysFuture, fetchKeys -&gt; {</b>
<b class="nc">&nbsp;            List&lt;ReadTsKvQuery&gt; queries = fetchKeys.stream().filter(key -&gt; !isBlank(key)).map(key -&gt; new BaseReadTsKvQuery(key, startTs, endTs, 1, &quot;DESC&quot;)).collect(Collectors.toList());</b>
<b class="nc">&nbsp;            if (!queries.isEmpty()) {</b>
<b class="nc">&nbsp;                return tsService.findAll(tenantId, entityView.getEntityId(), queries);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return Futures.immediateFuture(null);</b>
&nbsp;            }
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;        return Futures.transform(latestFuture, latestValues -&gt; {</b>
<b class="nc">&nbsp;            if (latestValues != null &amp;&amp; !latestValues.isEmpty()) {</b>
<b class="nc">&nbsp;                tsSubService.saveTimeseries(TimeseriesSaveRequest.builder()</b>
<b class="nc">&nbsp;                        .tenantId(entityView.getTenantId())</b>
<b class="nc">&nbsp;                        .entityId(entityId)</b>
<b class="nc">&nbsp;                        .entries(latestValues)</b>
<b class="nc">&nbsp;                        .strategy(TimeseriesSaveRequest.Strategy.LATEST_AND_WS)</b>
<b class="nc">&nbsp;                        .callback(new FutureCallback&lt;Void&gt;() {</b>
&nbsp;                            @Override
&nbsp;                            public void onSuccess(@Nullable Void tmp) {
<b class="nc">&nbsp;                            }</b>
&nbsp;
&nbsp;                            @Override
&nbsp;                            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                                log.error(&quot;[{}][{}] Failed to save entity view latest timeseries: {}&quot;, tenantId, entityView.getId(), latestValues, t);</b>
&nbsp;                            }
&nbsp;                        })
<b class="nc">&nbsp;                        .build());</b>
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; deleteAttributesFromEntityView(EntityView entityView, AttributeScope scope, List&lt;String&gt; keys, User user) {
<b class="nc">&nbsp;        EntityViewId entityId = entityView.getId();</b>
<b class="nc">&nbsp;        SettableFuture&lt;Void&gt; resultFuture = SettableFuture.create();</b>
<b class="nc">&nbsp;        if (keys != null &amp;&amp; !keys.isEmpty()) {</b>
<b class="nc">&nbsp;            tsSubService.deleteAttributes(AttributesDeleteRequest.builder()</b>
<b class="nc">&nbsp;                    .tenantId(entityView.getTenantId())</b>
<b class="nc">&nbsp;                    .entityId(entityId)</b>
<b class="nc">&nbsp;                    .scope(scope)</b>
<b class="nc">&nbsp;                    .keys(keys)</b>
<b class="nc">&nbsp;                    .callback(new FutureCallback&lt;&gt;() {</b>
&nbsp;                        @Override
&nbsp;                        public void onSuccess(@Nullable Void tmp) {
&nbsp;                            try {
<b class="nc">&nbsp;                                logAttributesDeleted(entityView.getTenantId(), user, entityId, scope, keys, null);</b>
&nbsp;                            } catch (ThingsboardException e) {
<b class="nc">&nbsp;                                log.error(&quot;Failed to log attribute delete&quot;, e);</b>
&nbsp;                            }
<b class="nc">&nbsp;                            resultFuture.set(tmp);</b>
&nbsp;                        }
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void onFailure(Throwable t) {
&nbsp;                            try {
<b class="nc">&nbsp;                                logAttributesDeleted(entityView.getTenantId(), user, entityId, scope, keys, t);</b>
&nbsp;                            } catch (ThingsboardException e) {
<b class="nc">&nbsp;                                log.error(&quot;Failed to log attribute delete&quot;, e);</b>
&nbsp;                            }
<b class="nc">&nbsp;                            resultFuture.setException(t);</b>
&nbsp;                        }
&nbsp;                    })
<b class="nc">&nbsp;                    .build());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            resultFuture.set(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        return resultFuture;</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; deleteLatestFromEntityView(EntityView entityView, List&lt;String&gt; keys, User user) {
<b class="nc">&nbsp;        EntityViewId entityId = entityView.getId();</b>
<b class="nc">&nbsp;        SettableFuture&lt;Void&gt; resultFuture = SettableFuture.create();</b>
<b class="nc">&nbsp;        tsSubService.deleteTimeseries(TimeseriesDeleteRequest.builder()</b>
<b class="nc">&nbsp;                .tenantId(entityView.getTenantId())</b>
<b class="nc">&nbsp;                .entityId(entityId)</b>
<b class="nc">&nbsp;                .keys(keys)</b>
<b class="nc">&nbsp;                .callback(new FutureCallback&lt;&gt;() {</b>
&nbsp;                    @Override
&nbsp;                    public void onSuccess(@Nullable List&lt;String&gt; result) {
&nbsp;                        try {
<b class="nc">&nbsp;                            logTimeseriesDeleted(entityView.getTenantId(), user, entityId, result, null);</b>
&nbsp;                        } catch (ThingsboardException e) {
<b class="nc">&nbsp;                            log.error(&quot;Failed to log timeseries delete&quot;, e);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        resultFuture.set(null);</b>
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void onFailure(Throwable t) {
&nbsp;                        try {
<b class="nc">&nbsp;                            logTimeseriesDeleted(entityView.getTenantId(), user, entityId, Optional.ofNullable(keys).orElse(Collections.emptyList()), t);</b>
&nbsp;                        } catch (ThingsboardException e) {
<b class="nc">&nbsp;                            log.error(&quot;Failed to log timeseries delete&quot;, e);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        resultFuture.setException(t);</b>
&nbsp;                    }
&nbsp;                })
<b class="nc">&nbsp;                .build());</b>
<b class="nc">&nbsp;        return resultFuture;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logAttributesUpdated(TenantId tenantId, User user, EntityId entityId, AttributeScope scope, List&lt;AttributeKvEntry&gt; attributes, Throwable e) throws ThingsboardException {
<b class="nc">&nbsp;        logEntityActionService.logEntityAction(tenantId, entityId, ActionType.ATTRIBUTES_UPDATED, user, toException(e), scope, attributes);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logAttributesDeleted(TenantId tenantId, User user, EntityId entityId, AttributeScope scope, List&lt;String&gt; keys, Throwable e) throws ThingsboardException {
<b class="nc">&nbsp;        logEntityActionService.logEntityAction(tenantId, entityId, ActionType.ATTRIBUTES_DELETED, user, toException(e), scope, keys);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logTimeseriesDeleted(TenantId tenantId, User user, EntityId entityId, List&lt;String&gt; keys, Throwable e) throws ThingsboardException {
<b class="nc">&nbsp;        logEntityActionService.logEntityAction(tenantId, entityId, ActionType.TIMESERIES_DELETED, user, toException(e), keys);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static Exception toException(Throwable error) {
<b class="nc">&nbsp;        return error != null ? (Exception.class.isInstance(error) ? (Exception) error : new Exception(error)) : null;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

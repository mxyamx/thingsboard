<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultTransportApiService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.transport</a>
</div>

<h1>Coverage Summary for Class: DefaultTransportApiService (org.thingsboard.server.service.transport)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultTransportApiService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/146)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/338)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultTransportApiService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/146)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/339)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.transport;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.JsonProcessingException;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.ListeningExecutorService;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import com.google.protobuf.ByteString;
&nbsp;import org.thingsboard.server.exception.EntitiesLimitExceededException;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.util.ConcurrentReferenceHashMap;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.server.cache.ota.OtaPackageDataCache;
&nbsp;import org.thingsboard.server.cluster.TbClusterService;
&nbsp;import org.thingsboard.server.common.data.ApiUsageState;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileProvisionType;
&nbsp;import org.thingsboard.server.common.data.DeviceTransportType;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.OtaPackage;
&nbsp;import org.thingsboard.server.common.data.OtaPackageInfo;
&nbsp;import org.thingsboard.server.common.data.ResourceType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.TbResource;
&nbsp;import org.thingsboard.server.common.data.TenantProfile;
&nbsp;import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;
&nbsp;import org.thingsboard.server.common.data.device.credentials.ProvisionDeviceCredentialsData;
&nbsp;import org.thingsboard.server.common.data.device.profile.ProvisionDeviceProfileCredentials;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.OtaPackageId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.data.ota.OtaPackageType;
&nbsp;import org.thingsboard.server.common.data.ota.OtaPackageUtil;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.queue.Queue;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentialsType;
&nbsp;import org.thingsboard.server.common.msg.EncryptionUtil;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgDataType;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;import org.thingsboard.server.common.util.ProtoUtils;
&nbsp;import org.thingsboard.server.dao.device.DeviceCredentialsService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProfileService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProvisionService;
&nbsp;import org.thingsboard.server.dao.device.DeviceService;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionFailedException;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionRequest;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionResponse;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;
&nbsp;import org.thingsboard.server.dao.ota.OtaPackageService;
&nbsp;import org.thingsboard.server.dao.queue.QueueService;
&nbsp;import org.thingsboard.server.dao.relation.RelationService;
&nbsp;import org.thingsboard.server.dao.resource.ResourceService;
&nbsp;import org.thingsboard.server.dao.tenant.TbTenantProfileCache;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetDeviceCredentialsRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetDeviceRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetEntityProfileRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetEntityProfileResponseMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetOrCreateDeviceFromGatewayRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetOrCreateDeviceFromGatewayResponseMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetResourceRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetSnmpDevicesRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GetSnmpDevicesResponseMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ProvisionDeviceRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TransportApiRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TransportApiResponseMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ValidateDeviceCredentialsResponseMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ValidateDeviceLwM2MCredentialsRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ValidateDeviceTokenRequestMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ValidateDeviceX509CertRequestMsg;
&nbsp;import org.thingsboard.server.queue.common.TbProtoQueueMsg;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.apiusage.TbApiUsageStateService;
&nbsp;import org.thingsboard.server.service.profile.TbDeviceProfileCache;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.locks.Lock;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.service.transport.BasicCredentialsValidationResult.PASSWORD_MISMATCH;
&nbsp;import static org.thingsboard.server.service.transport.BasicCredentialsValidationResult.VALID;
&nbsp;
&nbsp;/**
&nbsp; * Created by ashvayka on 05.10.18.
&nbsp; */
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@TbCoreComponent
&nbsp;@RequiredArgsConstructor
&nbsp;public class DefaultTransportApiService implements TransportApiService {
&nbsp;
<b class="nc">&nbsp;    private static final Pattern X509_CERTIFICATE_TRIM_CHAIN_PATTERN = Pattern.compile(&quot;-----BEGIN CERTIFICATE-----\\s*.*?\\s*-----END CERTIFICATE-----&quot;);</b>
&nbsp;
&nbsp;    private final TbDeviceProfileCache deviceProfileCache;
&nbsp;    private final TbTenantProfileCache tenantProfileCache;
&nbsp;    private final TbApiUsageStateService apiUsageStateService;
&nbsp;    private final DeviceService deviceService;
&nbsp;    private final DeviceProfileService deviceProfileService;
&nbsp;    private final RelationService relationService;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final TbClusterService tbClusterService;
&nbsp;    private final DeviceProvisionService deviceProvisionService;
&nbsp;    private final ResourceService resourceService;
&nbsp;    private final OtaPackageService otaPackageService;
&nbsp;    private final OtaPackageDataCache otaPackageDataCache;
&nbsp;    private final QueueService queueService;
&nbsp;
&nbsp;    private final ConcurrentMap&lt;String, ReentrantLock&gt; deviceCreationLocks = new ConcurrentReferenceHashMap&lt;&gt;(16, ConcurrentReferenceHashMap.ReferenceType.WEAK);
&nbsp;
&nbsp;    @Value(&quot;${queue.transport_api.max_core_handler_threads:16}&quot;)
&nbsp;    private int maxCoreHandlerThreads;
&nbsp;
&nbsp;    ListeningExecutorService handlerExecutor;
&nbsp;
&nbsp;    private static boolean checkIsMqttCredentials(DeviceCredentials credentials) {
<b class="nc">&nbsp;        return credentials != null &amp;&amp; DeviceCredentialsType.MQTT_BASIC.equals(credentials.getCredentialsType());</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void init() {
<b class="nc">&nbsp;        handlerExecutor = MoreExecutors.listeningDecorator(ThingsBoardExecutors.newWorkStealingPool(maxCoreHandlerThreads, &quot;transport-api-service-core-handler&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        if (handlerExecutor != null) {</b>
<b class="nc">&nbsp;            handlerExecutor.shutdownNow();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;TbProtoQueueMsg&lt;TransportApiResponseMsg&gt;&gt; handle(TbProtoQueueMsg&lt;TransportApiRequestMsg&gt; tbProtoQueueMsg) {
<b class="nc">&nbsp;        TransportApiRequestMsg transportApiRequestMsg = tbProtoQueueMsg.getValue();</b>
<b class="nc">&nbsp;        return handlerExecutor.submit(() -&gt; {</b>
<b class="nc">&nbsp;            TransportApiResponseMsg result = handle(transportApiRequestMsg);</b>
<b class="nc">&nbsp;            return new TbProtoQueueMsg&lt;&gt;(tbProtoQueueMsg.getKey(), result, tbProtoQueueMsg.getHeaders());</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(TransportApiRequestMsg transportApiRequestMsg) {
<b class="nc">&nbsp;        if (transportApiRequestMsg.hasValidateTokenRequestMsg()) {</b>
<b class="nc">&nbsp;            ValidateDeviceTokenRequestMsg msg = transportApiRequestMsg.getValidateTokenRequestMsg();</b>
<b class="nc">&nbsp;            final String token = msg.getToken();</b>
<b class="nc">&nbsp;            return validateCredentials(token, DeviceCredentialsType.ACCESS_TOKEN);</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasValidateBasicMqttCredRequestMsg()) {</b>
<b class="nc">&nbsp;            TransportProtos.ValidateBasicMqttCredRequestMsg msg = transportApiRequestMsg.getValidateBasicMqttCredRequestMsg();</b>
<b class="nc">&nbsp;            return validateCredentials(msg);</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasValidateX509CertRequestMsg()) {</b>
<b class="nc">&nbsp;            ValidateDeviceX509CertRequestMsg msg = transportApiRequestMsg.getValidateX509CertRequestMsg();</b>
<b class="nc">&nbsp;            final String hash = msg.getHash();</b>
<b class="nc">&nbsp;            return validateCredentials(hash, DeviceCredentialsType.X509_CERTIFICATE);</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasValidateOrCreateX509CertRequestMsg()) {</b>
<b class="nc">&nbsp;            TransportProtos.ValidateOrCreateDeviceX509CertRequestMsg msg = transportApiRequestMsg.getValidateOrCreateX509CertRequestMsg();</b>
<b class="nc">&nbsp;            final String certChain = msg.getCertificateChain();</b>
<b class="nc">&nbsp;            return validateOrCreateDeviceX509Certificate(certChain);</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasGetOrCreateDeviceRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getGetOrCreateDeviceRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasEntityProfileRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getEntityProfileRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasLwM2MRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getLwM2MRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasValidateDeviceLwM2MCredentialsRequestMsg()) {</b>
<b class="nc">&nbsp;            ValidateDeviceLwM2MCredentialsRequestMsg msg = transportApiRequestMsg.getValidateDeviceLwM2MCredentialsRequestMsg();</b>
<b class="nc">&nbsp;            final String credentialsId = msg.getCredentialsId();</b>
<b class="nc">&nbsp;            return validateCredentials(credentialsId, DeviceCredentialsType.LWM2M_CREDENTIALS);</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasProvisionDeviceRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getProvisionDeviceRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasResourceRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getResourceRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasSnmpDevicesRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getSnmpDevicesRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasDeviceRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getDeviceRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasDeviceCredentialsRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getDeviceCredentialsRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasOtaPackageRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getOtaPackageRequestMsg());</b>
<b class="nc">&nbsp;        } else if (transportApiRequestMsg.hasGetAllQueueRoutingInfoRequestMsg()) {</b>
<b class="nc">&nbsp;            return handle(transportApiRequestMsg.getGetAllQueueRoutingInfoRequestMsg());</b>
&nbsp;        }
<b class="nc">&nbsp;        return getEmptyTransportApiResponse();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg validateCredentials(String credentialsId, DeviceCredentialsType credentialsType) {
<b class="nc">&nbsp;        DeviceCredentials credentials = deviceCredentialsService.findDeviceCredentialsByCredentialsId(credentialsId);</b>
<b class="nc">&nbsp;        if (credentials != null &amp;&amp; credentials.getCredentialsType() == credentialsType) {</b>
<b class="nc">&nbsp;            return getDeviceInfo(credentials);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return getEmptyTransportApiResponse();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg validateCredentials(TransportProtos.ValidateBasicMqttCredRequestMsg mqtt) {
&nbsp;        DeviceCredentials credentials;
<b class="nc">&nbsp;        if (StringUtils.isEmpty(mqtt.getUserName())) {</b>
<b class="nc">&nbsp;            credentials = checkMqttCredentials(mqtt, EncryptionUtil.getSha3Hash(mqtt.getClientId()));</b>
<b class="nc">&nbsp;            if (credentials != null) {</b>
<b class="nc">&nbsp;                return getDeviceInfo(credentials);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return getEmptyTransportApiResponse();</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            credentials = deviceCredentialsService.findDeviceCredentialsByCredentialsId(</b>
<b class="nc">&nbsp;                    EncryptionUtil.getSha3Hash(&quot;|&quot;, mqtt.getClientId(), mqtt.getUserName()));</b>
<b class="nc">&nbsp;            if (checkIsMqttCredentials(credentials)) {</b>
<b class="nc">&nbsp;                var validationResult = validateMqttCredentials(mqtt, credentials);</b>
<b class="nc">&nbsp;                if (VALID.equals(validationResult)) {</b>
<b class="nc">&nbsp;                    return getDeviceInfo(credentials);</b>
<b class="nc">&nbsp;                } else if (PASSWORD_MISMATCH.equals(validationResult)) {</b>
<b class="nc">&nbsp;                    return getEmptyTransportApiResponse();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return validateUserNameCredentials(mqtt);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                return validateUserNameCredentials(mqtt);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected TransportApiResponseMsg validateOrCreateDeviceX509Certificate(String certificateChain) {
<b class="nc">&nbsp;        List&lt;String&gt; chain = X509_CERTIFICATE_TRIM_CHAIN_PATTERN.matcher(certificateChain).results().map(match -&gt;</b>
<b class="nc">&nbsp;                EncryptionUtil.certTrimNewLines(match.group())).collect(Collectors.toList());</b>
<b class="nc">&nbsp;        for (String certificateValue : chain) {</b>
<b class="nc">&nbsp;            String certificateHash = EncryptionUtil.getSha3Hash(certificateValue);</b>
<b class="nc">&nbsp;            DeviceCredentials credentials = deviceCredentialsService.findDeviceCredentialsByCredentialsId(certificateHash);</b>
<b class="nc">&nbsp;            if (credentials != null &amp;&amp; DeviceCredentialsType.X509_CERTIFICATE.equals(credentials.getCredentialsType())) {</b>
<b class="nc">&nbsp;                return getDeviceInfo(credentials);</b>
&nbsp;            }
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileService.findDeviceProfileByProvisionDeviceKey(certificateHash);</b>
<b class="nc">&nbsp;            if (deviceProfile != null &amp;&amp; DeviceProfileProvisionType.X509_CERTIFICATE_CHAIN.equals(deviceProfile.getProvisionType())) {</b>
<b class="nc">&nbsp;                String updatedDeviceProvisionSecret = chain.get(0);</b>
<b class="nc">&nbsp;                ProvisionRequest provisionRequest = createProvisionRequest(updatedDeviceProvisionSecret);</b>
&nbsp;                try {
<b class="nc">&nbsp;                    ProvisionResponse provisionResponse = deviceProvisionService.provisionDeviceViaX509Chain(deviceProfile, provisionRequest);</b>
<b class="nc">&nbsp;                    if (ProvisionResponseStatus.SUCCESS.equals(provisionResponse.getResponseStatus())) {</b>
<b class="nc">&nbsp;                        return getDeviceInfo(provisionResponse.getDeviceCredentials());</b>
&nbsp;                    }
&nbsp;                } catch (ProvisionFailedException e) {
<b class="nc">&nbsp;                    log.debug(&quot;[{}][{}] Failed to provision device with cert chain: {}&quot;, deviceProfile.getTenantId(), deviceProfile.getId(), provisionRequest, e);</b>
<b class="nc">&nbsp;                    return getEmptyTransportApiResponse();</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (deviceProfile != null) {</b>
<b class="nc">&nbsp;                log.warn(&quot;[{}][{}] Device Profile provision configuration mismatched: expected {}, actual {}&quot;, deviceProfile.getTenantId(), deviceProfile.getId(), DeviceProfileProvisionType.X509_CERTIFICATE_CHAIN, deviceProfile.getProvisionType());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return getEmptyTransportApiResponse();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg validateUserNameCredentials(TransportProtos.ValidateBasicMqttCredRequestMsg mqtt) {
<b class="nc">&nbsp;        DeviceCredentials credentials = deviceCredentialsService.findDeviceCredentialsByCredentialsId(mqtt.getUserName());</b>
<b class="nc">&nbsp;        if (credentials != null) {</b>
<b class="nc">&nbsp;            switch (credentials.getCredentialsType()) {</b>
&nbsp;                case ACCESS_TOKEN:
<b class="nc">&nbsp;                    return getDeviceInfo(credentials);</b>
&nbsp;                case MQTT_BASIC:
<b class="nc">&nbsp;                    if (VALID.equals(validateMqttCredentials(mqtt, credentials))) {</b>
<b class="nc">&nbsp;                        return getDeviceInfo(credentials);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        return getEmptyTransportApiResponse();</b>
&nbsp;                    }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return getEmptyTransportApiResponse();</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceCredentials checkMqttCredentials(TransportProtos.ValidateBasicMqttCredRequestMsg clientCred, String credId) {
<b class="nc">&nbsp;        return checkMqttCredentials(clientCred, deviceCredentialsService.findDeviceCredentialsByCredentialsId(credId));</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceCredentials checkMqttCredentials(TransportProtos.ValidateBasicMqttCredRequestMsg clientCred, DeviceCredentials deviceCredentials) {
<b class="nc">&nbsp;        if (deviceCredentials != null &amp;&amp; deviceCredentials.getCredentialsType() == DeviceCredentialsType.MQTT_BASIC) {</b>
<b class="nc">&nbsp;            if (VALID.equals(validateMqttCredentials(clientCred, deviceCredentials))) {</b>
<b class="nc">&nbsp;                return deviceCredentials;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private BasicCredentialsValidationResult validateMqttCredentials(TransportProtos.ValidateBasicMqttCredRequestMsg clientCred, DeviceCredentials deviceCredentials) {
<b class="nc">&nbsp;        BasicMqttCredentials dbCred = JacksonUtil.fromString(deviceCredentials.getCredentialsValue(), BasicMqttCredentials.class);</b>
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(dbCred.getClientId()) &amp;&amp; !dbCred.getClientId().equals(clientCred.getClientId())) {</b>
<b class="nc">&nbsp;            return BasicCredentialsValidationResult.HASH_MISMATCH;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(dbCred.getUserName()) &amp;&amp; !dbCred.getUserName().equals(clientCred.getUserName())) {</b>
<b class="nc">&nbsp;            return BasicCredentialsValidationResult.HASH_MISMATCH;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(dbCred.getPassword())) {</b>
<b class="nc">&nbsp;            if (StringUtils.isEmpty(clientCred.getPassword())) {</b>
<b class="nc">&nbsp;                return BasicCredentialsValidationResult.PASSWORD_MISMATCH;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return dbCred.getPassword().equals(clientCred.getPassword()) ? VALID : BasicCredentialsValidationResult.PASSWORD_MISMATCH;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return VALID;</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetOrCreateDeviceFromGatewayRequestMsg requestMsg) {
<b class="nc">&nbsp;        DeviceId gatewayId = new DeviceId(new UUID(requestMsg.getGatewayIdMSB(), requestMsg.getGatewayIdLSB()));</b>
<b class="nc">&nbsp;        Device gateway = deviceService.findDeviceById(TenantId.SYS_TENANT_ID, gatewayId);</b>
<b class="nc">&nbsp;        Lock deviceCreationLock = deviceCreationLocks.computeIfAbsent(requestMsg.getDeviceName(), id -&gt; new ReentrantLock());</b>
<b class="nc">&nbsp;        deviceCreationLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device device = deviceService.findDeviceByTenantIdAndName(gateway.getTenantId(), requestMsg.getDeviceName());</b>
<b class="nc">&nbsp;            if (device == null) {</b>
<b class="nc">&nbsp;                TenantId tenantId = gateway.getTenantId();</b>
<b class="nc">&nbsp;                device = new Device();</b>
<b class="nc">&nbsp;                device.setTenantId(tenantId);</b>
<b class="nc">&nbsp;                device.setName(requestMsg.getDeviceName());</b>
<b class="nc">&nbsp;                device.setType(requestMsg.getDeviceType());</b>
<b class="nc">&nbsp;                device.setCustomerId(gateway.getCustomerId());</b>
<b class="nc">&nbsp;                DeviceProfile deviceProfile = deviceProfileCache.findOrCreateDeviceProfile(gateway.getTenantId(), requestMsg.getDeviceType());</b>
&nbsp;
<b class="nc">&nbsp;                device.setDeviceProfileId(deviceProfile.getId());</b>
<b class="nc">&nbsp;                ObjectNode additionalInfo = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;                additionalInfo.put(DataConstants.LAST_CONNECTED_GATEWAY, gatewayId.toString());</b>
<b class="nc">&nbsp;                device.setAdditionalInfo(additionalInfo);</b>
<b class="nc">&nbsp;                device = deviceService.saveDevice(device);</b>
&nbsp;
<b class="nc">&nbsp;                relationService.saveRelation(tenantId, new EntityRelation(gateway.getId(), device.getId(), &quot;Created&quot;));</b>
&nbsp;
<b class="nc">&nbsp;                TbMsgMetaData metaData = new TbMsgMetaData();</b>
<b class="nc">&nbsp;                CustomerId customerId = gateway.getCustomerId();</b>
<b class="nc">&nbsp;                if (customerId != null &amp;&amp; !customerId.isNullUid()) {</b>
<b class="nc">&nbsp;                    metaData.putValue(&quot;customerId&quot;, customerId.toString());</b>
&nbsp;                }
<b class="nc">&nbsp;                metaData.putValue(&quot;gatewayId&quot;, gatewayId.toString());</b>
&nbsp;
<b class="nc">&nbsp;                DeviceId deviceId = device.getId();</b>
<b class="nc">&nbsp;                JsonNode entityNode = JacksonUtil.valueToTree(device);</b>
<b class="nc">&nbsp;                TbMsg tbMsg = TbMsg.newMsg()</b>
<b class="nc">&nbsp;                        .type(TbMsgType.ENTITY_CREATED)</b>
<b class="nc">&nbsp;                        .originator(deviceId)</b>
<b class="nc">&nbsp;                        .customerId(customerId)</b>
<b class="nc">&nbsp;                        .copyMetaData(metaData)</b>
<b class="nc">&nbsp;                        .dataType(TbMsgDataType.JSON)</b>
<b class="nc">&nbsp;                        .data(JacksonUtil.toString(entityNode))</b>
<b class="nc">&nbsp;                        .build();</b>
<b class="nc">&nbsp;                tbClusterService.pushMsgToRuleEngine(tenantId, deviceId, tbMsg, null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                JsonNode deviceAdditionalInfo = device.getAdditionalInfo();</b>
<b class="nc">&nbsp;                if (deviceAdditionalInfo == null) {</b>
<b class="nc">&nbsp;                    deviceAdditionalInfo = JacksonUtil.newObjectNode();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (deviceAdditionalInfo.isObject() &amp;&amp;</b>
<b class="nc">&nbsp;                        (!deviceAdditionalInfo.has(DataConstants.LAST_CONNECTED_GATEWAY)</b>
<b class="nc">&nbsp;                                || !gatewayId.toString().equals(deviceAdditionalInfo.get(DataConstants.LAST_CONNECTED_GATEWAY).asText()))) {</b>
<b class="nc">&nbsp;                    ObjectNode newDeviceAdditionalInfo = (ObjectNode) deviceAdditionalInfo;</b>
<b class="nc">&nbsp;                    newDeviceAdditionalInfo.put(DataConstants.LAST_CONNECTED_GATEWAY, gatewayId.toString());</b>
<b class="nc">&nbsp;                    deviceService.saveDevice(device);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            GetOrCreateDeviceFromGatewayResponseMsg.Builder builder = GetOrCreateDeviceFromGatewayResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setDeviceInfo(ProtoUtils.toDeviceInfoProto(device));</b>
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileCache.get(device.getTenantId(), device.getDeviceProfileId());</b>
<b class="nc">&nbsp;            if (deviceProfile != null) {</b>
<b class="nc">&nbsp;                builder.setDeviceProfile(ProtoUtils.toProto(deviceProfile));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                log.warn(&quot;[{}] Failed to find device profile [{}] for device. &quot;, device.getId(), device.getDeviceProfileId());</b>
&nbsp;            }
<b class="nc">&nbsp;            return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setGetOrCreateDeviceResponseMsg(builder.build())</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        } catch (JsonProcessingException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to lookup device by gateway id and name: [{}]&quot;, gatewayId, requestMsg.getDeviceName(), e);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        } catch (EntitiesLimitExceededException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}][{}] API limit exception: [{}]&quot;, e.getTenantId(), gatewayId, e.getMessage());</b>
<b class="nc">&nbsp;            return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setGetOrCreateDeviceResponseMsg(</b>
<b class="nc">&nbsp;                            GetOrCreateDeviceFromGatewayResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                                    .setError(TransportProtos.TransportApiRequestErrorCode.ENTITY_LIMIT))</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            deviceCreationLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(ProvisionDeviceRequestMsg requestMsg) {
&nbsp;        ProvisionResponse provisionResponse;
&nbsp;        try {
<b class="nc">&nbsp;            provisionResponse = deviceProvisionService.provisionDevice(</b>
&nbsp;                    new ProvisionRequest(
<b class="nc">&nbsp;                            requestMsg.getDeviceName(),</b>
<b class="nc">&nbsp;                            requestMsg.getCredentialsType() != null ? DeviceCredentialsType.valueOf(requestMsg.getCredentialsType().name()) : null,</b>
<b class="nc">&nbsp;                            new ProvisionDeviceCredentialsData(requestMsg.getCredentialsDataProto().getValidateDeviceTokenRequestMsg().getToken(),</b>
<b class="nc">&nbsp;                                    requestMsg.getCredentialsDataProto().getValidateBasicMqttCredRequestMsg().getClientId(),</b>
<b class="nc">&nbsp;                                    requestMsg.getCredentialsDataProto().getValidateBasicMqttCredRequestMsg().getUserName(),</b>
<b class="nc">&nbsp;                                    requestMsg.getCredentialsDataProto().getValidateBasicMqttCredRequestMsg().getPassword(),</b>
<b class="nc">&nbsp;                                    requestMsg.getCredentialsDataProto().getValidateDeviceX509CertRequestMsg().getHash()),</b>
&nbsp;                            new ProvisionDeviceProfileCredentials(
<b class="nc">&nbsp;                                    requestMsg.getProvisionDeviceCredentialsMsg().getProvisionDeviceKey(),</b>
<b class="nc">&nbsp;                                    requestMsg.getProvisionDeviceCredentialsMsg().getProvisionDeviceSecret()),</b>
<b class="nc">&nbsp;                            requestMsg.getGateway()));</b>
&nbsp;        } catch (ProvisionFailedException e) {
<b class="nc">&nbsp;            return getTransportApiResponseMsg(new DeviceCredentials(), TransportProtos.ResponseStatus.valueOf(e.getMessage()));</b>
&nbsp;        }
<b class="nc">&nbsp;        return getTransportApiResponseMsg(provisionResponse.getDeviceCredentials(), TransportProtos.ResponseStatus.SUCCESS);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg getTransportApiResponseMsg(DeviceCredentials deviceCredentials, TransportProtos.ResponseStatus status) {
<b class="nc">&nbsp;        if (!status.equals(TransportProtos.ResponseStatus.SUCCESS)) {</b>
<b class="nc">&nbsp;            return TransportApiResponseMsg.newBuilder().setProvisionDeviceResponseMsg(TransportProtos.ProvisionDeviceResponseMsg.newBuilder().setStatus(status).build()).build();</b>
&nbsp;        }
<b class="nc">&nbsp;        TransportProtos.ProvisionDeviceResponseMsg.Builder provisionResponse = TransportProtos.ProvisionDeviceResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setCredentialsType(TransportProtos.CredentialsType.valueOf(deviceCredentials.getCredentialsType().name()))</b>
<b class="nc">&nbsp;                .setStatus(status);</b>
<b class="nc">&nbsp;        switch (deviceCredentials.getCredentialsType()) {</b>
&nbsp;            case ACCESS_TOKEN:
<b class="nc">&nbsp;                provisionResponse.setCredentialsValue(deviceCredentials.getCredentialsId());</b>
&nbsp;                break;
&nbsp;            case MQTT_BASIC:
&nbsp;            case X509_CERTIFICATE:
&nbsp;            case LWM2M_CREDENTIALS:
<b class="nc">&nbsp;                provisionResponse.setCredentialsValue(deviceCredentials.getCredentialsValue());</b>
&nbsp;                break;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setProvisionDeviceResponseMsg(provisionResponse.build())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetEntityProfileRequestMsg requestMsg) {
<b class="nc">&nbsp;        EntityType entityType = EntityType.valueOf(requestMsg.getEntityType());</b>
<b class="nc">&nbsp;        UUID entityUuid = new UUID(requestMsg.getEntityIdMSB(), requestMsg.getEntityIdLSB());</b>
<b class="nc">&nbsp;        GetEntityProfileResponseMsg.Builder builder = GetEntityProfileResponseMsg.newBuilder();</b>
<b class="nc">&nbsp;        if (entityType.equals(EntityType.DEVICE_PROFILE)) {</b>
<b class="nc">&nbsp;            DeviceProfileId deviceProfileId = new DeviceProfileId(entityUuid);</b>
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileCache.find(deviceProfileId);</b>
<b class="nc">&nbsp;            builder.setDeviceProfile(ProtoUtils.toProto(deviceProfile));</b>
<b class="nc">&nbsp;        } else if (entityType.equals(EntityType.TENANT)) {</b>
<b class="nc">&nbsp;            TenantId tenantId = TenantId.fromUUID(entityUuid);</b>
<b class="nc">&nbsp;            TenantProfile tenantProfile = tenantProfileCache.get(tenantId);</b>
<b class="nc">&nbsp;            ApiUsageState state = apiUsageStateService.getApiUsageState(tenantId);</b>
<b class="nc">&nbsp;            builder.setTenantProfile(ProtoUtils.toProto(tenantProfile));</b>
<b class="nc">&nbsp;            builder.setApiState(ProtoUtils.toProto(state));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Invalid entity profile request: &quot; + entityType);</b>
&nbsp;        }
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder().setEntityProfileResponseMsg(builder).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetDeviceRequestMsg requestMsg) {
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(new UUID(requestMsg.getDeviceIdMSB(), requestMsg.getDeviceIdLSB()));</b>
<b class="nc">&nbsp;        Device device = deviceService.findDeviceById(TenantId.SYS_TENANT_ID, deviceId);</b>
&nbsp;
&nbsp;        TransportApiResponseMsg responseMsg;
<b class="nc">&nbsp;        if (device != null) {</b>
<b class="nc">&nbsp;            UUID deviceProfileId = device.getDeviceProfileId().getId();</b>
<b class="nc">&nbsp;            responseMsg = TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setDeviceResponseMsg(TransportProtos.GetDeviceResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                            .setDeviceProfileIdMSB(deviceProfileId.getMostSignificantBits())</b>
<b class="nc">&nbsp;                            .setDeviceProfileIdLSB(deviceProfileId.getLeastSignificantBits())</b>
<b class="nc">&nbsp;                            .setDeviceTransportConfiguration(ByteString.copyFrom(</b>
<b class="nc">&nbsp;                                    JacksonUtil.writeValueAsBytes(device.getDeviceData().getTransportConfiguration())</b>
&nbsp;                            )))
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            responseMsg = TransportApiResponseMsg.getDefaultInstance();</b>
&nbsp;        }
<b class="nc">&nbsp;        return responseMsg;</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetDeviceCredentialsRequestMsg requestMsg) {
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(new UUID(requestMsg.getDeviceIdMSB(), requestMsg.getDeviceIdLSB()));</b>
<b class="nc">&nbsp;        DeviceCredentials deviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(TenantId.SYS_TENANT_ID, deviceId);</b>
&nbsp;
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setDeviceCredentialsResponseMsg(TransportProtos.GetDeviceCredentialsResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                        .setDeviceCredentialsData(ProtoUtils.toProto(deviceCredentials)))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetResourceRequestMsg requestMsg) {
<b class="nc">&nbsp;        TenantId tenantId = TenantId.fromUUID(new UUID(requestMsg.getTenantIdMSB(), requestMsg.getTenantIdLSB()));</b>
<b class="nc">&nbsp;        ResourceType resourceType = ResourceType.valueOf(requestMsg.getResourceType());</b>
<b class="nc">&nbsp;        String resourceKey = requestMsg.getResourceKey();</b>
<b class="nc">&nbsp;        TransportProtos.GetResourceResponseMsg.Builder builder = TransportProtos.GetResourceResponseMsg.newBuilder();</b>
<b class="nc">&nbsp;        TbResource resource = resourceService.findResourceByTenantIdAndKey(tenantId, resourceType, resourceKey);</b>
&nbsp;
<b class="nc">&nbsp;        if (resource == null &amp;&amp; !tenantId.equals(TenantId.SYS_TENANT_ID)) {</b>
<b class="nc">&nbsp;            resource = resourceService.findResourceByTenantIdAndKey(TenantId.SYS_TENANT_ID, resourceType, resourceKey);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (resource != null) {</b>
<b class="nc">&nbsp;            builder.setResource(ProtoUtils.toProto(resource));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder().setResourceResponseMsg(builder).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(GetSnmpDevicesRequestMsg requestMsg) {
<b class="nc">&nbsp;        PageLink pageLink = new PageLink(requestMsg.getPageSize(), requestMsg.getPage());</b>
<b class="nc">&nbsp;        PageData&lt;UUID&gt; result = deviceService.findDevicesIdsByDeviceProfileTransportType(DeviceTransportType.SNMP, pageLink);</b>
&nbsp;
<b class="nc">&nbsp;        GetSnmpDevicesResponseMsg responseMsg = GetSnmpDevicesResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .addAllIds(result.getData().stream()</b>
<b class="nc">&nbsp;                        .map(UUID::toString)</b>
<b class="nc">&nbsp;                        .collect(Collectors.toList()))</b>
<b class="nc">&nbsp;                .setHasNextPage(result.hasNext())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setSnmpDevicesResponseMsg(responseMsg)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    TransportApiResponseMsg getDeviceInfo(DeviceCredentials credentials) {
<b class="nc">&nbsp;        Device device = deviceService.findDeviceById(TenantId.SYS_TENANT_ID, credentials.getDeviceId());</b>
<b class="nc">&nbsp;        if (device == null) {</b>
<b class="nc">&nbsp;            log.trace(&quot;[{}] Failed to lookup device by id&quot;, credentials.getDeviceId());</b>
<b class="nc">&nbsp;            return getEmptyTransportApiResponse();</b>
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            ValidateDeviceCredentialsResponseMsg.Builder builder = ValidateDeviceCredentialsResponseMsg.newBuilder();</b>
<b class="nc">&nbsp;            builder.setDeviceInfo(ProtoUtils.toDeviceInfoProto(device));</b>
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileCache.get(device.getTenantId(), device.getDeviceProfileId());</b>
<b class="nc">&nbsp;            if (deviceProfile != null) {</b>
<b class="nc">&nbsp;                builder.setDeviceProfile(ProtoUtils.toProto(deviceProfile));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                log.warn(&quot;[{}] Failed to find device profile [{}] for device. &quot;, device.getId(), device.getDeviceProfileId());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!StringUtils.isEmpty(credentials.getCredentialsValue())) {</b>
<b class="nc">&nbsp;                builder.setCredentialsBody(credentials.getCredentialsValue());</b>
&nbsp;            }
<b class="nc">&nbsp;            return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setValidateCredResponseMsg(builder.build()).build();</b>
&nbsp;        } catch (JsonProcessingException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to lookup device by id&quot;, credentials.getDeviceId(), e);</b>
<b class="nc">&nbsp;            return getEmptyTransportApiResponse();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg getEmptyTransportApiResponse() {
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setValidateCredResponseMsg(ValidateDeviceCredentialsResponseMsg.getDefaultInstance()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(TransportProtos.LwM2MRequestMsg requestMsg) {
<b class="nc">&nbsp;        if (requestMsg.hasRegistrationMsg()) {</b>
<b class="nc">&nbsp;            return handleRegistration(requestMsg.getRegistrationMsg());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Not supported!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(TransportProtos.GetOtaPackageRequestMsg requestMsg) {
<b class="nc">&nbsp;        TenantId tenantId = TenantId.fromUUID(new UUID(requestMsg.getTenantIdMSB(), requestMsg.getTenantIdLSB()));</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(new UUID(requestMsg.getDeviceIdMSB(), requestMsg.getDeviceIdLSB()));</b>
<b class="nc">&nbsp;        OtaPackageType otaPackageType = OtaPackageType.valueOf(requestMsg.getType());</b>
<b class="nc">&nbsp;        Device device = deviceService.findDeviceById(tenantId, deviceId);</b>
<b class="nc">&nbsp;        if (device == null) {</b>
<b class="nc">&nbsp;            return getEmptyTransportApiResponse();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        OtaPackageId otaPackageId = OtaPackageUtil.getOtaPackageId(device, otaPackageType);</b>
<b class="nc">&nbsp;        if (otaPackageId == null) {</b>
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileCache.find(device.getDeviceProfileId());</b>
<b class="nc">&nbsp;            otaPackageId = OtaPackageUtil.getOtaPackageId(deviceProfile, otaPackageType);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        TransportProtos.GetOtaPackageResponseMsg.Builder builder = TransportProtos.GetOtaPackageResponseMsg.newBuilder();</b>
&nbsp;
<b class="nc">&nbsp;        if (otaPackageId == null) {</b>
<b class="nc">&nbsp;            builder.setResponseStatus(TransportProtos.ResponseStatus.NOT_FOUND);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            OtaPackageInfo otaPackageInfo = otaPackageService.findOtaPackageInfoById(tenantId, otaPackageId);</b>
&nbsp;
<b class="nc">&nbsp;            if (otaPackageInfo == null) {</b>
<b class="nc">&nbsp;                builder.setResponseStatus(TransportProtos.ResponseStatus.NOT_FOUND);</b>
<b class="nc">&nbsp;            } else if (otaPackageInfo.hasUrl()) {</b>
<b class="nc">&nbsp;                builder.setResponseStatus(TransportProtos.ResponseStatus.FAILURE);</b>
<b class="nc">&nbsp;                log.trace(&quot;[{}] Can`t send OtaPackage with URL data!&quot;, otaPackageInfo.getId());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                builder.setResponseStatus(TransportProtos.ResponseStatus.SUCCESS);</b>
<b class="nc">&nbsp;                builder.setOtaPackageIdMSB(otaPackageId.getId().getMostSignificantBits());</b>
<b class="nc">&nbsp;                builder.setOtaPackageIdLSB(otaPackageId.getId().getLeastSignificantBits());</b>
<b class="nc">&nbsp;                builder.setType(otaPackageInfo.getType().name());</b>
<b class="nc">&nbsp;                builder.setTitle(otaPackageInfo.getTitle());</b>
<b class="nc">&nbsp;                builder.setVersion(otaPackageInfo.getVersion());</b>
<b class="nc">&nbsp;                builder.setFileName(otaPackageInfo.getFileName());</b>
<b class="nc">&nbsp;                builder.setContentType(otaPackageInfo.getContentType());</b>
<b class="nc">&nbsp;                if (!otaPackageDataCache.has(otaPackageId.toString())) {</b>
<b class="nc">&nbsp;                    OtaPackage otaPackage = otaPackageService.findOtaPackageById(tenantId, otaPackageId);</b>
<b class="nc">&nbsp;                    otaPackageDataCache.put(otaPackageId.toString(), otaPackage.getData().array());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setOtaPackageResponseMsg(builder.build())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handleRegistration(TransportProtos.LwM2MRegistrationRequestMsg msg) {
<b class="nc">&nbsp;        TenantId tenantId = TenantId.fromUUID(UUID.fromString(msg.getTenantId()));</b>
<b class="nc">&nbsp;        String deviceName = msg.getEndpoint();</b>
<b class="nc">&nbsp;        Lock deviceCreationLock = deviceCreationLocks.computeIfAbsent(deviceName, id -&gt; new ReentrantLock());</b>
<b class="nc">&nbsp;        deviceCreationLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device device = deviceService.findDeviceByTenantIdAndName(tenantId, deviceName);</b>
<b class="nc">&nbsp;            if (device == null) {</b>
<b class="nc">&nbsp;                device = new Device();</b>
<b class="nc">&nbsp;                device.setTenantId(tenantId);</b>
<b class="nc">&nbsp;                device.setName(deviceName);</b>
<b class="nc">&nbsp;                device.setType(&quot;LwM2M&quot;);</b>
<b class="nc">&nbsp;                device = deviceService.saveDevice(device);</b>
&nbsp;            }
&nbsp;            TransportProtos.LwM2MRegistrationResponseMsg registrationResponseMsg =
<b class="nc">&nbsp;                    TransportProtos.LwM2MRegistrationResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                            .setDeviceInfo(ProtoUtils.toDeviceInfoProto(device)).build();</b>
<b class="nc">&nbsp;            TransportProtos.LwM2MResponseMsg responseMsg = TransportProtos.LwM2MResponseMsg.newBuilder().setRegistrationMsg(registrationResponseMsg).build();</b>
<b class="nc">&nbsp;            return TransportApiResponseMsg.newBuilder().setLwM2MResponseMsg(responseMsg).build();</b>
&nbsp;        } catch (JsonProcessingException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}][{}] Failed to lookup device by name&quot;, tenantId, deviceName, e);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            deviceCreationLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TransportApiResponseMsg handle(TransportProtos.GetAllQueueRoutingInfoRequestMsg requestMsg) {
<b class="nc">&nbsp;        List&lt;Queue&gt; queues = queueService.findAllQueues();</b>
<b class="nc">&nbsp;        return TransportApiResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                .addAllGetQueueRoutingInfoResponseMsgs(queues.stream()</b>
<b class="nc">&nbsp;                        .map(queue -&gt; TransportProtos.GetQueueRoutingInfoResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                                .setTenantIdMSB(queue.getTenantId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                                .setTenantIdLSB(queue.getTenantId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                                .setQueueIdMSB(queue.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                                .setQueueIdLSB(queue.getId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                                .setQueueName(queue.getName())</b>
<b class="nc">&nbsp;                                .setQueueTopic(queue.getTopic())</b>
<b class="nc">&nbsp;                                .setPartitions(queue.getPartitions())</b>
<b class="nc">&nbsp;                                .setDuplicateMsgToAllPartitions(queue.isDuplicateMsgToAllPartitions())</b>
<b class="nc">&nbsp;                                .build()).collect(Collectors.toList())).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private ProvisionRequest createProvisionRequest(String certificateValue) {
<b class="nc">&nbsp;        return new ProvisionRequest(null, DeviceCredentialsType.X509_CERTIFICATE,</b>
&nbsp;                new ProvisionDeviceCredentialsData(null, null, null, null, certificateValue),
&nbsp;                null, null);
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

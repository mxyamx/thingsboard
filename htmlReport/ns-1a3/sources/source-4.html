<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ResourcesUpdater</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.install.update</a>
</div>

<h1>Coverage Summary for Class: ResourcesUpdater (org.thingsboard.server.service.install.update)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ResourcesUpdater</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/103)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.install.update;
&nbsp;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.SneakyThrows;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.collections4.CollectionUtils;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.server.common.data.Dashboard;
&nbsp;import org.thingsboard.server.common.data.HasImage;
&nbsp;import org.thingsboard.server.common.data.id.DashboardId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.WidgetTypeId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterable;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.widget.WidgetTypeDetails;
&nbsp;import org.thingsboard.server.dao.Dao;
&nbsp;import org.thingsboard.server.dao.asset.AssetProfileDao;
&nbsp;import org.thingsboard.server.dao.dashboard.DashboardDao;
&nbsp;import org.thingsboard.server.dao.dashboard.DashboardService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProfileDao;
&nbsp;import org.thingsboard.server.dao.resource.ImageService;
&nbsp;import org.thingsboard.server.dao.resource.ResourceService;
&nbsp;import org.thingsboard.server.dao.tenant.TenantDao;
&nbsp;import org.thingsboard.server.dao.widget.WidgetTypeDao;
&nbsp;import org.thingsboard.server.dao.widget.WidgetTypeService;
&nbsp;import org.thingsboard.server.dao.widget.WidgetsBundleDao;
&nbsp;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;import java.util.function.BiFunction;
&nbsp;import java.util.function.Function;
&nbsp;
&nbsp;@Component
&nbsp;@RequiredArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class ResourcesUpdater {
&nbsp;    private final ImageService imageService;
&nbsp;    private final ResourceService resourceService;
&nbsp;    private final WidgetsBundleDao widgetsBundleDao;
&nbsp;    private final WidgetTypeDao widgetTypeDao;
&nbsp;    private final WidgetTypeService widgetTypeService;
&nbsp;    private final TenantDao tenantDao;
&nbsp;    private final DashboardDao dashboardDao;
&nbsp;    private final DashboardService dashboardService;
&nbsp;    private final DeviceProfileDao deviceProfileDao;
&nbsp;    private final AssetProfileDao assetProfileDao;
&nbsp;
&nbsp;    public void updateWidgetsBundlesImages() {
<b class="nc">&nbsp;        log.info(&quot;Updating widgets bundles images...&quot;);</b>
<b class="nc">&nbsp;        var widgetsBundles = new PageDataIterable&lt;&gt;(widgetsBundleDao::findAllWidgetsBundles, 128);</b>
<b class="nc">&nbsp;        updateImages(widgetsBundles, &quot;bundle&quot;, imageService::replaceBase64WithImageUrl, widgetsBundleDao);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateWidgetTypesImages() {
<b class="nc">&nbsp;        log.info(&quot;Updating widget types images...&quot;);</b>
<b class="nc">&nbsp;        var widgetTypesIds = new PageDataIterable&lt;&gt;(widgetTypeDao::findAllWidgetTypesIds, 1024);</b>
<b class="nc">&nbsp;        updateImages(widgetTypesIds, &quot;widget type&quot;, imageService::updateImagesUsage, widgetTypeDao);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateDashboardsImages() {
<b class="nc">&nbsp;        log.info(&quot;Updating dashboards images...&quot;);</b>
<b class="nc">&nbsp;        updateImages(&quot;dashboard&quot;, dashboardDao::findIdsByTenantId, imageService::updateImagesUsage, dashboardDao);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void createSystemImagesAndResources(Dashboard defaultDashboard) {
<b class="nc">&nbsp;        defaultDashboard.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;        if (CollectionUtils.isNotEmpty(defaultDashboard.getResources())) {</b>
<b class="nc">&nbsp;            resourceService.importResources(defaultDashboard.getTenantId(), defaultDashboard.getResources());</b>
&nbsp;        }
<b class="nc">&nbsp;        imageService.updateImagesUsage(defaultDashboard);</b>
<b class="nc">&nbsp;        log.debug(&quot;Created/updated system images and resources for default dashboard &#39;{}&#39;&quot;, defaultDashboard.getTitle());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public void updateDashboardsResources() {
<b class="nc">&nbsp;        log.info(&quot;Updating resources usage in dashboards&quot;);</b>
<b class="nc">&nbsp;        var executor = ThingsBoardExecutors.newLimitedTasksExecutor(4, 4, &quot;dashboards-resources-upgrade&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        var dashboards = new PageDataIterable&lt;&gt;(dashboardService::findAllDashboardsIds, 512);</b>
<b class="nc">&nbsp;        AtomicInteger totalCount = new AtomicInteger();</b>
<b class="nc">&nbsp;        AtomicInteger updatedCount = new AtomicInteger();</b>
<b class="nc">&nbsp;        for (DashboardId dashboardId : dashboards) {</b>
<b class="nc">&nbsp;            executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;                Dashboard dashboard = dashboardService.findDashboardById(TenantId.SYS_TENANT_ID, dashboardId);</b>
<b class="nc">&nbsp;                boolean updated = resourceService.updateResourcesUsage(dashboard.getTenantId(), dashboard); // will convert resources ids to new structure</b>
<b class="nc">&nbsp;                if (updated) {</b>
<b class="nc">&nbsp;                    dashboardService.saveDashboard(dashboard);</b>
<b class="nc">&nbsp;                    updatedCount.incrementAndGet();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (totalCount.incrementAndGet() % 1000 == 0) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Processed {} dashboards, updated {}&quot;, totalCount, updatedCount);</b>
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        executor.shutdown();</b>
<b class="nc">&nbsp;        if (!executor.awaitTermination(5, TimeUnit.HOURS)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Dashboards resources update timeout&quot;); // just in case, should happen</b>
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;Updated {} dashboards&quot;, updatedCount);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public void updateWidgetsResources() {
<b class="nc">&nbsp;        log.info(&quot;Updating resources usage in widgets&quot;);</b>
<b class="nc">&nbsp;        var executor = ThingsBoardExecutors.newLimitedTasksExecutor(4, 4, &quot;widgets-resources-upgrade&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        AtomicInteger totalCount = new AtomicInteger();</b>
<b class="nc">&nbsp;        AtomicInteger updatedCount = new AtomicInteger();</b>
<b class="nc">&nbsp;        var widgets = new PageDataIterable&lt;&gt;(widgetTypeService::findAllWidgetTypesIds, 512);</b>
<b class="nc">&nbsp;        for (WidgetTypeId widgetTypeId : widgets) {</b>
<b class="nc">&nbsp;            executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;                WidgetTypeDetails widgetTypeDetails = widgetTypeService.findWidgetTypeDetailsById(TenantId.SYS_TENANT_ID, widgetTypeId);</b>
<b class="nc">&nbsp;                boolean updated = resourceService.updateResourcesUsage(widgetTypeDetails.getTenantId(), widgetTypeDetails);</b>
<b class="nc">&nbsp;                if (updated) {</b>
<b class="nc">&nbsp;                    widgetTypeService.saveWidgetType(widgetTypeDetails);</b>
<b class="nc">&nbsp;                    updatedCount.incrementAndGet();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (totalCount.incrementAndGet() % 200 == 0) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Processed {} widgets, updated {}&quot;, totalCount, updatedCount);</b>
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        executor.shutdown();</b>
<b class="nc">&nbsp;        if (!executor.awaitTermination(5, TimeUnit.HOURS)) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Widgets resources update timeout&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;Updated {} widgets&quot;, updatedCount);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateDeviceProfilesImages() {
<b class="nc">&nbsp;        log.info(&quot;Updating device profiles images...&quot;);</b>
<b class="nc">&nbsp;        var deviceProfiles = new PageDataIterable&lt;&gt;(deviceProfileDao::findAllWithImages, 256);</b>
<b class="nc">&nbsp;        updateImages(deviceProfiles, &quot;device profile&quot;, imageService::replaceBase64WithImageUrl, deviceProfileDao);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateAssetProfilesImages() {
<b class="nc">&nbsp;        log.info(&quot;Updating asset profiles images...&quot;);</b>
<b class="nc">&nbsp;        var assetProfiles = new PageDataIterable&lt;&gt;(assetProfileDao::findAllWithImages, 256);</b>
<b class="nc">&nbsp;        updateImages(assetProfiles, &quot;asset profile&quot;, imageService::replaceBase64WithImageUrl, assetProfileDao);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;E extends HasImage&gt; void updateImages(Iterable&lt;E&gt; entities, String type,
&nbsp;                                                   BiFunction&lt;E, String, Boolean&gt; updater, Dao&lt;E&gt; dao) {
<b class="nc">&nbsp;        int updatedCount = 0;</b>
<b class="nc">&nbsp;        int totalCount = 0;</b>
<b class="nc">&nbsp;        for (E entity : entities) {</b>
<b class="nc">&nbsp;            totalCount++;</b>
&nbsp;            try {
<b class="nc">&nbsp;                boolean updated = updater.apply(entity, type);</b>
<b class="nc">&nbsp;                if (updated) {</b>
<b class="nc">&nbsp;                    dao.save(entity.getTenantId(), entity);</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}][{}] Updated {} images&quot;, entity.getTenantId(), entity.getName(), type);</b>
<b class="nc">&nbsp;                    updatedCount++;</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;[{}][{}] Failed to update {} images&quot;, entity.getTenantId(), entity.getName(), type, e);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (totalCount % 100 == 0) {</b>
<b class="nc">&nbsp;                log.info(&quot;Processed {} {}s so far&quot;, totalCount, type);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;Updated {} {}s out of {}&quot;, updatedCount, type, totalCount);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;E extends HasImage&gt; void updateImages(Iterable&lt;? extends EntityId&gt; entitiesIds, String type,
&nbsp;                                                   Function&lt;E, Boolean&gt; updater, Dao&lt;E&gt; dao) {
<b class="nc">&nbsp;        int totalCount = 0;</b>
<b class="nc">&nbsp;        int updatedCount = 0;</b>
<b class="nc">&nbsp;        var counts = updateImages(entitiesIds, type, updater, dao, totalCount, updatedCount);</b>
<b class="nc">&nbsp;        totalCount = counts[0];</b>
<b class="nc">&nbsp;        updatedCount = counts[1];</b>
<b class="nc">&nbsp;        log.info(&quot;Updated {} {}s out of {}&quot;, updatedCount, type, totalCount);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;E extends HasImage&gt; void updateImages(String type, BiFunction&lt;TenantId, PageLink, PageData&lt;? extends EntityId&gt;&gt; entityIdsByTenantId,
&nbsp;                                                   Function&lt;E, Boolean&gt; updater, Dao&lt;E&gt; dao) {
<b class="nc">&nbsp;        int tenantCount = 0;</b>
<b class="nc">&nbsp;        int totalCount = 0;</b>
<b class="nc">&nbsp;        int updatedCount = 0;</b>
<b class="nc">&nbsp;        var tenantIds = new PageDataIterable&lt;&gt;(tenantDao::findTenantsIds, 128);</b>
<b class="nc">&nbsp;        for (var tenantId : tenantIds) {</b>
<b class="nc">&nbsp;            tenantCount++;</b>
<b class="nc">&nbsp;            var entitiesIds = new PageDataIterable&lt;&gt;(link -&gt; entityIdsByTenantId.apply(tenantId, link), 128);</b>
<b class="nc">&nbsp;            var counts = updateImages(entitiesIds, type, updater, dao, totalCount, updatedCount);</b>
<b class="nc">&nbsp;            totalCount = counts[0];</b>
<b class="nc">&nbsp;            updatedCount = counts[1];</b>
<b class="nc">&nbsp;            if (tenantCount % 100 == 0) {</b>
<b class="nc">&nbsp;                log.info(&quot;Update {}s images: processed {} tenants so far&quot;, type, tenantCount);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;Updated {} {}s out of {}&quot;, updatedCount, type, totalCount);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;E extends HasImage&gt; int[] updateImages(Iterable&lt;? extends EntityId&gt; entitiesIds, String type,
&nbsp;                                                    Function&lt;E, Boolean&gt; updater, Dao&lt;E&gt; dao, int totalCount, int updatedCount) {
<b class="nc">&nbsp;        for (EntityId id : entitiesIds) {</b>
<b class="nc">&nbsp;            totalCount++;</b>
&nbsp;            E entity;
&nbsp;            try {
<b class="nc">&nbsp;                entity = dao.findById(TenantId.SYS_TENANT_ID, id.getId());</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Failed to update {} images: error fetching entity by id [{}]: {}&quot;, type, id.getId(), StringUtils.abbreviate(e.toString(), 1000));</b>
&nbsp;                continue;
&nbsp;            }
&nbsp;            try {
<b class="nc">&nbsp;                boolean updated = updater.apply(entity);</b>
<b class="nc">&nbsp;                if (updated) {</b>
<b class="nc">&nbsp;                    dao.save(entity.getTenantId(), entity);</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}][{}] Updated {} images&quot;, entity.getTenantId(), entity.getName(), type);</b>
<b class="nc">&nbsp;                    updatedCount++;</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;[{}][{}] Failed to update {} images&quot;, entity.getTenantId(), entity.getName(), type, e);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (totalCount % 100 == 0) {</b>
<b class="nc">&nbsp;                log.info(&quot;Processed {} {}s so far&quot;, totalCount, type);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return new int[]{totalCount, updatedCount};</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

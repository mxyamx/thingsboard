<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultDataUpdateService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.install.update</a>
</div>

<h1>Coverage Summary for Class: DefaultDataUpdateService (org.thingsboard.server.service.install.update)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultDataUpdateService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.install.update;
&nbsp;
&nbsp;import com.google.common.collect.Lists;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.context.annotation.Profile;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.server.common.data.id.RuleNodeId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterable;
&nbsp;import org.thingsboard.server.dao.rule.RuleChainService;
&nbsp;import org.thingsboard.server.service.component.ComponentDiscoveryService;
&nbsp;import org.thingsboard.server.service.component.RuleNodeClassInfo;
&nbsp;import org.thingsboard.server.service.install.DbUpgradeExecutorService;
&nbsp;import org.thingsboard.server.utils.TbNodeUpgradeUtils;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;
&nbsp;@Service
&nbsp;@Profile(&quot;install&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class DefaultDataUpdateService implements DataUpdateService {
&nbsp;
&nbsp;    private static final int MAX_PENDING_SAVE_RULE_NODE_FUTURES = 256;
&nbsp;    private static final int DEFAULT_PAGE_SIZE = 1024;
&nbsp;
&nbsp;    private final RuleChainService ruleChainService;
&nbsp;    private final ComponentDiscoveryService componentDiscoveryService;
&nbsp;    private final DbUpgradeExecutorService executorService;
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateData() throws Exception {
<b class="nc">&nbsp;        log.info(&quot;Updating data ...&quot;);</b>
&nbsp;        //TODO: should be cleaned after each release
&nbsp;
<b class="nc">&nbsp;        log.info(&quot;Data updated.&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void upgradeRuleNodes() {
<b class="nc">&nbsp;        int totalRuleNodesUpgraded = 0;</b>
<b class="nc">&nbsp;        log.info(&quot;Starting rule nodes upgrade ...&quot;);</b>
<b class="nc">&nbsp;        var nodeClassToVersionMap = componentDiscoveryService.getVersionedNodes();</b>
<b class="nc">&nbsp;        log.debug(&quot;Found {} versioned nodes to check for upgrade!&quot;, nodeClassToVersionMap.size());</b>
<b class="nc">&nbsp;        for (var ruleNodeClassInfo : nodeClassToVersionMap) {</b>
<b class="nc">&nbsp;            var ruleNodeTypeForLogs = ruleNodeClassInfo.getSimpleName();</b>
<b class="nc">&nbsp;            var toVersion = ruleNodeClassInfo.getCurrentVersion();</b>
&nbsp;            try {
<b class="nc">&nbsp;                log.debug(&quot;Going to check for nodes with type: {} to upgrade to version: {}.&quot;, ruleNodeTypeForLogs, toVersion);</b>
<b class="nc">&nbsp;                var ruleNodesIdsToUpgrade = getRuleNodesIdsWithTypeAndVersionLessThan(ruleNodeClassInfo.getClassName(), toVersion);</b>
<b class="nc">&nbsp;                if (ruleNodesIdsToUpgrade.isEmpty()) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;There are no active nodes with type {}, or all nodes with this type already set to latest version!&quot;, ruleNodeTypeForLogs);</b>
&nbsp;                    continue;
&nbsp;                }
<b class="nc">&nbsp;                var ruleNodeIdsPartitions = Lists.partition(ruleNodesIdsToUpgrade, MAX_PENDING_SAVE_RULE_NODE_FUTURES);</b>
<b class="nc">&nbsp;                for (var ruleNodePack : ruleNodeIdsPartitions) {</b>
<b class="nc">&nbsp;                    totalRuleNodesUpgraded += processRuleNodePack(ruleNodePack, ruleNodeClassInfo);</b>
<b class="nc">&nbsp;                    log.info(&quot;{} upgraded rule nodes so far ...&quot;, totalRuleNodesUpgraded);</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Unexpected error during {} rule nodes upgrade: &quot;, ruleNodeTypeForLogs, e);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;Finished rule nodes upgrade. Upgraded rule nodes count: {}&quot;, totalRuleNodesUpgraded);</b>
&nbsp;    }
&nbsp;
&nbsp;    private int processRuleNodePack(List&lt;RuleNodeId&gt; ruleNodeIdsBatch, RuleNodeClassInfo ruleNodeClassInfo) {
<b class="nc">&nbsp;        var saveFutures = new ArrayList&lt;ListenableFuture&lt;?&gt;&gt;(MAX_PENDING_SAVE_RULE_NODE_FUTURES);</b>
<b class="nc">&nbsp;        String ruleNodeType = ruleNodeClassInfo.getSimpleName();</b>
<b class="nc">&nbsp;        int toVersion = ruleNodeClassInfo.getCurrentVersion();</b>
<b class="nc">&nbsp;        var ruleNodesPack = ruleChainService.findAllRuleNodesByIds(ruleNodeIdsBatch);</b>
<b class="nc">&nbsp;        for (var ruleNode : ruleNodesPack) {</b>
<b class="nc">&nbsp;            if (ruleNode == null) {</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            var ruleNodeId = ruleNode.getId();</b>
<b class="nc">&nbsp;            int fromVersion = ruleNode.getConfigurationVersion();</b>
<b class="nc">&nbsp;            log.debug(&quot;Going to upgrade rule node with id: {} type: {} fromVersion: {} toVersion: {}&quot;,</b>
<b class="nc">&nbsp;                    ruleNodeId, ruleNodeType, fromVersion, toVersion);</b>
&nbsp;            try {
<b class="nc">&nbsp;                TbNodeUpgradeUtils.upgradeConfigurationAndVersion(ruleNode, ruleNodeClassInfo);</b>
<b class="nc">&nbsp;                saveFutures.add(executorService.submit(() -&gt; {</b>
<b class="nc">&nbsp;                    ruleChainService.saveRuleNode(TenantId.SYS_TENANT_ID, ruleNode);</b>
<b class="nc">&nbsp;                    log.debug(&quot;Successfully upgrade rule node with id: {} type: {} fromVersion: {} toVersion: {}&quot;,</b>
<b class="nc">&nbsp;                            ruleNodeId, ruleNodeType, fromVersion, toVersion);</b>
&nbsp;                }));
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.warn(&quot;Failed to upgrade rule node with id: {} type: {} fromVersion: {} toVersion: {} due to: &quot;,</b>
<b class="nc">&nbsp;                        ruleNodeId, ruleNodeType, fromVersion, toVersion, e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            return Futures.allAsList(saveFutures).get().size();</b>
&nbsp;        } catch (ExecutionException | InterruptedException e) {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Failed to process save rule nodes requests due to: &quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RuleNodeId&gt; getRuleNodesIdsWithTypeAndVersionLessThan(String type, int toVersion) {
<b class="nc">&nbsp;        var ruleNodeIds = new ArrayList&lt;RuleNodeId&gt;();</b>
<b class="nc">&nbsp;        new PageDataIterable&lt;&gt;(pageLink -&gt;</b>
<b class="nc">&nbsp;                ruleChainService.findAllRuleNodeIdsByTypeAndVersionLessThan(type, toVersion, pageLink), DEFAULT_PAGE_SIZE</b>
<b class="nc">&nbsp;        ).forEach(ruleNodeIds::add);</b>
<b class="nc">&nbsp;        return ruleNodeIds;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static boolean getEnv(String name, boolean defaultValue) {
<b class="nc">&nbsp;        String env = System.getenv(name);</b>
<b class="nc">&nbsp;        if (env == null) {</b>
<b class="nc">&nbsp;            return defaultValue;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Boolean.parseBoolean(env);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

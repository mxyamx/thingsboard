<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AuthController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: AuthController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AuthController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/90)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.ApplicationEventPublisher;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
&nbsp;import org.springframework.web.bind.annotation.GetMapping;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.thingsboard.rule.engine.api.MailService;
&nbsp;import org.thingsboard.server.cache.limits.RateLimitService;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.limit.LimitedApi;
&nbsp;import org.thingsboard.server.common.data.security.Authority;
&nbsp;import org.thingsboard.server.common.data.security.UserCredentials;
&nbsp;import org.thingsboard.server.common.data.security.event.UserCredentialsInvalidationEvent;
&nbsp;import org.thingsboard.server.common.data.security.event.UserSessionInvalidationEvent;
&nbsp;import org.thingsboard.server.common.data.security.model.JwtPair;
&nbsp;import org.thingsboard.server.common.data.security.model.SecuritySettings;
&nbsp;import org.thingsboard.server.common.data.security.model.UserPasswordPolicy;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.settings.SecuritySettingsService;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.security.auth.mfa.TwoFactorAuthService;
&nbsp;import org.thingsboard.server.service.security.auth.rest.RestAuthenticationDetails;
&nbsp;import org.thingsboard.server.service.security.auth.rest.RestAwareAuthenticationSuccessHandler;
&nbsp;import org.thingsboard.server.service.security.model.ActivateUserRequest;
&nbsp;import org.thingsboard.server.service.security.model.ChangePasswordRequest;
&nbsp;import org.thingsboard.server.service.security.model.ResetPasswordEmailRequest;
&nbsp;import org.thingsboard.server.service.security.model.ResetPasswordRequest;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.model.UserPrincipal;
&nbsp;import org.thingsboard.server.service.security.model.token.JwtTokenFactory;
&nbsp;import org.thingsboard.server.service.security.system.SystemSecurityService;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
&nbsp;@RequestMapping(&quot;/api&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class AuthController extends BaseController {
&nbsp;
&nbsp;    @Value(&quot;${server.rest.rate_limits.reset_password_per_user:5:3600}&quot;)
&nbsp;    private String defaultLimitsConfiguration;
&nbsp;    private final BCryptPasswordEncoder passwordEncoder;
&nbsp;    private final JwtTokenFactory tokenFactory;
&nbsp;    private final MailService mailService;
&nbsp;    private final SystemSecurityService systemSecurityService;
&nbsp;    private final SecuritySettingsService securitySettingsService;
&nbsp;    private final RateLimitService rateLimitService;
&nbsp;    private final ApplicationEventPublisher eventPublisher;
&nbsp;    private final TwoFactorAuthService twoFactorAuthService;
&nbsp;    private final RestAwareAuthenticationSuccessHandler authenticationSuccessHandler;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get current User (getUser)&quot;,
&nbsp;            notes = &quot;Get the information about the User which credentials are used to perform this REST API call.&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/auth/user&quot;)
&nbsp;    public User getUser() throws ThingsboardException {
<b class="nc">&nbsp;        SecurityUser securityUser = getCurrentUser();</b>
<b class="nc">&nbsp;        User user = userService.findUserById(securityUser.getTenantId(), securityUser.getId());</b>
<b class="nc">&nbsp;        checkDashboardInfo(user.getAdditionalInfo());</b>
<b class="nc">&nbsp;        return user;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Logout (logout)&quot;,
&nbsp;            notes = &quot;Special API call to record the &#39;logout&#39; of the user to the Audit Logs. Since platform uses [JWT](https://jwt.io/), the actual logout is the procedure of clearing the [JWT](https://jwt.io/) token on the client side. &quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/auth/logout&quot;)
&nbsp;    public void logout(HttpServletRequest request) throws ThingsboardException {
<b class="nc">&nbsp;        logLogoutAction(request);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Change password for current User (changePassword)&quot;,
&nbsp;            notes = &quot;Change the password for the User which credentials are used to perform this REST API call. Be aware that previously generated [JWT](https://jwt.io/) tokens will be still valid until they expire.&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/auth/changePassword&quot;)
&nbsp;    public JwtPair changePassword(@Parameter(description = &quot;Change Password Request&quot;)
&nbsp;                                  @RequestBody ChangePasswordRequest changePasswordRequest) throws ThingsboardException {
<b class="nc">&nbsp;        String currentPassword = changePasswordRequest.getCurrentPassword();</b>
<b class="nc">&nbsp;        String newPassword = changePasswordRequest.getNewPassword();</b>
<b class="nc">&nbsp;        SecurityUser securityUser = getCurrentUser();</b>
<b class="nc">&nbsp;        UserCredentials userCredentials = userService.findUserCredentialsByUserId(TenantId.SYS_TENANT_ID, securityUser.getId());</b>
<b class="nc">&nbsp;        if (!passwordEncoder.matches(currentPassword, userCredentials.getPassword())) {</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Current password doesn&#39;t match!&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
<b class="nc">&nbsp;        systemSecurityService.validatePassword(newPassword, userCredentials);</b>
<b class="nc">&nbsp;        if (passwordEncoder.matches(newPassword, userCredentials.getPassword())) {</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;New password should be different from existing!&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
<b class="nc">&nbsp;        userCredentials.setPassword(passwordEncoder.encode(newPassword));</b>
<b class="nc">&nbsp;        userService.replaceUserCredentials(securityUser.getTenantId(), userCredentials);</b>
&nbsp;
<b class="nc">&nbsp;        eventPublisher.publishEvent(new UserCredentialsInvalidationEvent(securityUser.getId()));</b>
<b class="nc">&nbsp;        return tokenFactory.createTokenPair(securityUser);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get the current User password policy (getUserPasswordPolicy)&quot;,
&nbsp;            notes = &quot;API call to get the password policy for the password validation form(s).&quot;)
&nbsp;    @GetMapping(value = &quot;/noauth/userPasswordPolicy&quot;)
&nbsp;    public UserPasswordPolicy getUserPasswordPolicy() throws ThingsboardException {
<b class="nc">&nbsp;        SecuritySettings securitySettings = checkNotNull(securitySettingsService.getSecuritySettings());</b>
<b class="nc">&nbsp;        return securitySettings.getPasswordPolicy();</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check Activate User Token (checkActivateToken)&quot;,
&nbsp;            notes = &quot;Checks the activation token and forwards user to &#39;Create Password&#39; page. &quot; +
&nbsp;                    &quot;If token is valid, returns &#39;303 See Other&#39; (redirect) response code with the correct address of &#39;Create Password&#39; page and same &#39;activateToken&#39; specified in the URL parameters. &quot; +
&nbsp;                    &quot;If token is not valid, returns &#39;409 Conflict&#39;. &quot; +
&nbsp;                    &quot;If token is expired, redirects to error page.&quot;)
&nbsp;    @GetMapping(value = &quot;/noauth/activate&quot;, params = {&quot;activateToken&quot;})
&nbsp;    public ResponseEntity&lt;?&gt; checkActivateToken(
&nbsp;            @Parameter(description = &quot;The activate token string.&quot;)
&nbsp;            @RequestParam(value = &quot;activateToken&quot;) String activateToken) {
<b class="nc">&nbsp;        UserCredentials userCredentials = userService.findUserCredentialsByActivateToken(TenantId.SYS_TENANT_ID, activateToken);</b>
<b class="nc">&nbsp;        if (userCredentials == null) {</b>
<b class="nc">&nbsp;            return response(HttpStatus.CONFLICT);</b>
<b class="nc">&nbsp;        } else if (userCredentials.isActivationTokenExpired()) {</b>
<b class="nc">&nbsp;            return redirectTo(&quot;/activationLinkExpired&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return redirectTo(&quot;/login/createPassword?activateToken=&quot; + activateToken);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Request reset password email (requestResetPasswordByEmail)&quot;,
&nbsp;            notes = &quot;Request to send the reset password email if the user with specified email address is present in the database. &quot; +
&nbsp;                    &quot;Always return &#39;200 OK&#39; status for security purposes.&quot;)
&nbsp;    @PostMapping(value = &quot;/noauth/resetPasswordByEmail&quot;)
&nbsp;    public void requestResetPasswordByEmail(
&nbsp;            @Parameter(description = &quot;The JSON object representing the reset password email request.&quot;)
&nbsp;            @RequestBody ResetPasswordEmailRequest resetPasswordByEmailRequest,
&nbsp;            HttpServletRequest request) throws ThingsboardException {
&nbsp;        try {
<b class="nc">&nbsp;            String email = resetPasswordByEmailRequest.getEmail();</b>
<b class="nc">&nbsp;            UserCredentials userCredentials = userService.requestPasswordReset(TenantId.SYS_TENANT_ID, email);</b>
<b class="nc">&nbsp;            User user = userService.findUserById(TenantId.SYS_TENANT_ID, userCredentials.getUserId());</b>
<b class="nc">&nbsp;            String baseUrl = systemSecurityService.getBaseUrl(user.getTenantId(), user.getCustomerId(), request);</b>
<b class="nc">&nbsp;            String resetUrl = String.format(&quot;%s/api/noauth/resetPassword?resetToken=%s&quot;, baseUrl,</b>
<b class="nc">&nbsp;                    userCredentials.getResetToken());</b>
&nbsp;
<b class="nc">&nbsp;            mailService.sendResetPasswordEmailAsync(resetUrl, userCredentials.getResetTokenTtl(), email);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;Error occurred: {}&quot;, e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check password reset token (checkResetToken)&quot;,
&nbsp;            notes = &quot;Checks the password reset token and forwards user to &#39;Reset Password&#39; page. &quot; +
&nbsp;                    &quot;If token is valid, returns &#39;303 See Other&#39; (redirect) response code with the correct address of &#39;Reset Password&#39; page and same &#39;resetToken&#39; specified in the URL parameters. &quot; +
&nbsp;                    &quot;If token is not valid, returns &#39;409 Conflict&#39;. &quot; +
&nbsp;                    &quot;If token is expired, redirects to error page.&quot;)
&nbsp;    @GetMapping(value = &quot;/noauth/resetPassword&quot;, params = {&quot;resetToken&quot;})
&nbsp;    public ResponseEntity&lt;?&gt; checkResetToken(
&nbsp;            @Parameter(description = &quot;The reset token string.&quot;)
&nbsp;            @RequestParam(value = &quot;resetToken&quot;) String resetToken) {
<b class="nc">&nbsp;        UserCredentials userCredentials = userService.findUserCredentialsByResetToken(TenantId.SYS_TENANT_ID, resetToken);</b>
<b class="nc">&nbsp;        if (userCredentials == null) {</b>
<b class="nc">&nbsp;            return response(HttpStatus.CONFLICT);</b>
<b class="nc">&nbsp;        } else if (userCredentials.isResetTokenExpired()) {</b>
<b class="nc">&nbsp;            return redirectTo(&quot;/passwordResetLinkExpired&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!rateLimitService.checkRateLimit(LimitedApi.PASSWORD_RESET, userCredentials.getUserId(), defaultLimitsConfiguration)) {</b>
<b class="nc">&nbsp;            return response(HttpStatus.TOO_MANY_REQUESTS);</b>
&nbsp;        }
<b class="nc">&nbsp;        return redirectTo(&quot;/login/resetPassword?resetToken=&quot; + resetToken);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Activate User&quot;,
&nbsp;            notes = &quot;Checks the activation token and updates corresponding user password in the database. &quot; +
&nbsp;                    &quot;Now the user may start using his password to login. &quot; +
&nbsp;                    &quot;The response already contains the [JWT](https://jwt.io) activation and refresh tokens, &quot; +
&nbsp;                    &quot;to simplify the user activation flow and avoid asking user to input password again after activation. &quot; +
&nbsp;                    &quot;If token is valid, returns the object that contains [JWT](https://jwt.io/) access and refresh tokens. &quot; +
&nbsp;                    &quot;If token is not valid, returns &#39;400 Bad Request&#39;.&quot;)
&nbsp;    @PostMapping(value = &quot;/noauth/activate&quot;)
&nbsp;    public JwtPair activateUser(@Parameter(description = &quot;Activate user request.&quot;)
&nbsp;                                @RequestBody ActivateUserRequest activateRequest,
&nbsp;                                @RequestParam(required = false, defaultValue = &quot;true&quot;) boolean sendActivationMail,
&nbsp;                                HttpServletRequest request) {
<b class="nc">&nbsp;        String activateToken = activateRequest.getActivateToken();</b>
<b class="nc">&nbsp;        String password = activateRequest.getPassword();</b>
<b class="nc">&nbsp;        systemSecurityService.validatePassword(password, null);</b>
<b class="nc">&nbsp;        String encodedPassword = passwordEncoder.encode(password);</b>
<b class="nc">&nbsp;        UserCredentials credentials = userService.activateUserCredentials(TenantId.SYS_TENANT_ID, activateToken, encodedPassword);</b>
<b class="nc">&nbsp;        User user = userService.findUserById(TenantId.SYS_TENANT_ID, credentials.getUserId());</b>
<b class="nc">&nbsp;        UserPrincipal principal = new UserPrincipal(UserPrincipal.Type.USER_NAME, user.getEmail());</b>
<b class="nc">&nbsp;        SecurityUser securityUser = new SecurityUser(user, credentials.isEnabled(), principal);</b>
<b class="nc">&nbsp;        userService.setUserCredentialsEnabled(user.getTenantId(), user.getId(), true);</b>
<b class="nc">&nbsp;        String baseUrl = systemSecurityService.getBaseUrl(user.getTenantId(), user.getCustomerId(), request);</b>
<b class="nc">&nbsp;        String loginUrl = String.format(&quot;%s/login&quot;, baseUrl);</b>
<b class="nc">&nbsp;        String email = user.getEmail();</b>
&nbsp;
<b class="nc">&nbsp;        if (sendActivationMail) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                mailService.sendAccountActivatedEmail(loginUrl, email);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.warn(&quot;Unable to send account activation email [{}]&quot;, e.getMessage());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        JwtPair tokenPair;
<b class="nc">&nbsp;        if (twoFactorAuthService.isEnforceTwoFaEnabled(securityUser.getTenantId(), user)) {</b>
<b class="nc">&nbsp;            tokenPair = authenticationSuccessHandler.createMfaTokenPair(securityUser, Authority.MFA_CONFIGURATION_TOKEN);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            tokenPair = tokenFactory.createTokenPair(securityUser);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        systemSecurityService.logLoginAction(user, new RestAuthenticationDetails(request), ActionType.LOGIN, null);</b>
<b class="nc">&nbsp;        return tokenPair;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Reset password (resetPassword)&quot;,
&nbsp;            notes = &quot;Checks the password reset token and updates the password. &quot; +
&nbsp;                    &quot;If token is not valid, returns &#39;400 Bad Request&#39;.&quot;)
&nbsp;    @PostMapping(value = &quot;/noauth/resetPassword&quot;)
&nbsp;    public void resetPassword(@Parameter(description = &quot;Reset password request.&quot;)
&nbsp;                                 @RequestBody ResetPasswordRequest resetPasswordRequest,
&nbsp;                                 HttpServletRequest request) throws ThingsboardException {
<b class="nc">&nbsp;        String resetToken = resetPasswordRequest.getResetToken();</b>
<b class="nc">&nbsp;        String password = resetPasswordRequest.getPassword();</b>
<b class="nc">&nbsp;        UserCredentials userCredentials = userService.findUserCredentialsByResetToken(TenantId.SYS_TENANT_ID, resetToken);</b>
<b class="nc">&nbsp;        if (userCredentials != null) {</b>
<b class="nc">&nbsp;            if (userCredentials.isResetTokenExpired()) {</b>
<b class="nc">&nbsp;                throw new ThingsboardException(&quot;Password reset token expired&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;            }
<b class="nc">&nbsp;            systemSecurityService.validatePassword(password, userCredentials);</b>
<b class="nc">&nbsp;            if (passwordEncoder.matches(password, userCredentials.getPassword())) {</b>
<b class="nc">&nbsp;                throw new ThingsboardException(&quot;New password should be different from existing!&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;            }
<b class="nc">&nbsp;            String encodedPassword = passwordEncoder.encode(password);</b>
<b class="nc">&nbsp;            userCredentials.setPassword(encodedPassword);</b>
<b class="nc">&nbsp;            userCredentials.setResetToken(null);</b>
<b class="nc">&nbsp;            userCredentials.setResetTokenExpTime(null);</b>
<b class="nc">&nbsp;            userCredentials = userService.replaceUserCredentials(TenantId.SYS_TENANT_ID, userCredentials);</b>
<b class="nc">&nbsp;            User user = userService.findUserById(TenantId.SYS_TENANT_ID, userCredentials.getUserId());</b>
<b class="nc">&nbsp;            UserPrincipal principal = new UserPrincipal(UserPrincipal.Type.USER_NAME, user.getEmail());</b>
<b class="nc">&nbsp;            SecurityUser securityUser = new SecurityUser(user, userCredentials.isEnabled(), principal);</b>
<b class="nc">&nbsp;            String baseUrl = systemSecurityService.getBaseUrl(user.getTenantId(), user.getCustomerId(), request);</b>
<b class="nc">&nbsp;            String loginUrl = String.format(&quot;%s/login&quot;, baseUrl);</b>
<b class="nc">&nbsp;            String email = user.getEmail();</b>
&nbsp;            try {
<b class="nc">&nbsp;                mailService.sendPasswordWasResetEmail(loginUrl, email);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.warn(&quot;Couldn&#39;t send password was reset email: {}&quot;, e.getMessage());</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            eventPublisher.publishEvent(new UserCredentialsInvalidationEvent(securityUser.getId()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Invalid reset token!&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void logLogoutAction(HttpServletRequest request) throws ThingsboardException {
<b class="nc">&nbsp;        var user = getCurrentUser();</b>
<b class="nc">&nbsp;        systemSecurityService.logLoginAction(user, new RestAuthenticationDetails(request), ActionType.LOGOUT, null);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(new UserSessionInvalidationEvent(user.getSessionId()));</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AdminController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: AdminController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AdminController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/139)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AdminController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/140)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.type.TypeReference;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.api.client.auth.oauth2.AuthorizationCodeRequestUrl;
&nbsp;import com.google.api.client.auth.oauth2.AuthorizationCodeTokenRequest;
&nbsp;import com.google.api.client.auth.oauth2.ClientParametersAuthentication;
&nbsp;import com.google.api.client.auth.oauth2.TokenResponse;
&nbsp;import com.google.api.client.http.GenericUrl;
&nbsp;import com.google.api.client.http.javanet.NetHttpTransport;
&nbsp;import com.google.api.client.json.gson.GsonFactory;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import jakarta.servlet.http.Cookie;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import jakarta.servlet.http.HttpServletResponse;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.DeleteMapping;
&nbsp;import org.springframework.web.bind.annotation.GetMapping;
&nbsp;import org.springframework.web.bind.annotation.PathVariable;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.ResponseStatus;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.springframework.web.context.request.async.DeferredResult;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.rule.engine.api.MailService;
&nbsp;import org.thingsboard.rule.engine.api.SmsService;
&nbsp;import org.thingsboard.server.common.data.AdminSettings;
&nbsp;import org.thingsboard.server.common.data.FeaturesInfo;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.SystemInfo;
&nbsp;import org.thingsboard.server.common.data.UpdateMessage;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.security.model.JwtPair;
&nbsp;import org.thingsboard.server.common.data.security.model.JwtSettings;
&nbsp;import org.thingsboard.server.common.data.security.model.SecuritySettings;
&nbsp;import org.thingsboard.server.common.data.sms.config.TestSmsRequest;
&nbsp;import org.thingsboard.server.common.data.sync.vc.AutoCommitSettings;
&nbsp;import org.thingsboard.server.common.data.sync.vc.RepositorySettings;
&nbsp;import org.thingsboard.server.common.data.sync.vc.RepositorySettingsInfo;
&nbsp;import org.thingsboard.server.common.data.sync.vc.VcUtils;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.audit.AuditLogService;
&nbsp;import org.thingsboard.server.dao.settings.AdminSettingsService;
&nbsp;import org.thingsboard.server.dao.settings.SecuritySettingsService;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.security.auth.jwt.settings.JwtSettingsService;
&nbsp;import org.thingsboard.server.service.security.auth.oauth2.CookieUtils;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.model.token.JwtTokenFactory;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;import org.thingsboard.server.service.security.permission.Resource;
&nbsp;import org.thingsboard.server.service.security.system.SystemSecurityService;
&nbsp;import org.thingsboard.server.service.sync.vc.EntitiesVersionControlService;
&nbsp;import org.thingsboard.server.service.sync.vc.autocommit.TbAutoCommitSettingsService;
&nbsp;import org.thingsboard.server.service.system.SystemInfoService;
&nbsp;import org.thingsboard.server.service.update.UpdateService;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SYSTEM_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.TENANT_AUTHORITY_PARAGRAPH;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequestMapping(&quot;/api/admin&quot;)
&nbsp;@RequiredArgsConstructor
&nbsp;public class AdminController extends BaseController {
&nbsp;
&nbsp;    private static final String PREV_URI_PATH_PARAMETER = &quot;prevUri&quot;;
&nbsp;    private static final String PREV_URI_COOKIE_NAME = &quot;prev_uri&quot;;
&nbsp;    private static final String STATE_COOKIE_NAME = &quot;state&quot;;
&nbsp;    private static final String MAIL_SETTINGS_KEY = &quot;mail&quot;;
&nbsp;
&nbsp;    private final MailService mailService;
&nbsp;    private final SmsService smsService;
&nbsp;    private final AdminSettingsService adminSettingsService;
&nbsp;    private final SystemSecurityService systemSecurityService;
&nbsp;    private final SecuritySettingsService securitySettingsService;
&nbsp;    private final JwtSettingsService jwtSettingsService;
&nbsp;    private final JwtTokenFactory tokenFactory;
&nbsp;    private final EntitiesVersionControlService versionControlService;
&nbsp;    private final TbAutoCommitSettingsService autoCommitSettingsService;
&nbsp;    private final UpdateService updateService;
&nbsp;    private final SystemInfoService systemInfoService;
&nbsp;    private final AuditLogService auditLogService;
&nbsp;
&nbsp;    @Value(&quot;${queue.vc.request-timeout:180000}&quot;)
&nbsp;    private int vcRequestTimeout;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get the Administration Settings object using key (getAdminSettings)&quot;,
&nbsp;            notes = &quot;Get the Administration Settings object using specified string key. Referencing non-existing key will cause an error.&quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/settings/{key}&quot;)
&nbsp;    public AdminSettings getAdminSettings(
&nbsp;            @Parameter(description = &quot;A string value of the key (e.g. &#39;general&#39; or &#39;mail&#39;).&quot;)
&nbsp;            @PathVariable(&quot;key&quot;) String key) throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        AdminSettings adminSettings = checkNotNull(adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, key), &quot;No Administration settings found for key: &quot; + key);</b>
<b class="nc">&nbsp;        if (adminSettings.getKey().equals(MAIL_SETTINGS_KEY)) {</b>
<b class="nc">&nbsp;            ((ObjectNode) adminSettings.getJsonValue()).remove(&quot;password&quot;);</b>
<b class="nc">&nbsp;            ((ObjectNode) adminSettings.getJsonValue()).remove(&quot;refreshToken&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return adminSettings;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Creates or Updates the Administration Settings (saveAdminSettings)&quot;,
&nbsp;            notes = &quot;Creates or Updates the Administration Settings. Platform generates random Administration Settings Id during settings creation. &quot; +
&nbsp;                    &quot;The Administration Settings Id will be present in the response. Specify the Administration Settings Id when you would like to update the Administration Settings. &quot; +
&nbsp;                    &quot;Referencing non-existing Administration Settings Id will cause an error.&quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/settings&quot;)
&nbsp;    public AdminSettings saveAdminSettings(
&nbsp;            @Parameter(description = &quot;A JSON value representing the Administration Settings.&quot;)
&nbsp;            @RequestBody AdminSettings adminSettings) throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.WRITE);</b>
<b class="nc">&nbsp;        adminSettings.setTenantId(getTenantId());</b>
<b class="nc">&nbsp;        adminSettings = checkNotNull(adminSettingsService.saveAdminSettings(TenantId.SYS_TENANT_ID, adminSettings));</b>
<b class="nc">&nbsp;        if (adminSettings.getKey().equals(MAIL_SETTINGS_KEY)) {</b>
<b class="nc">&nbsp;            mailService.updateMailConfiguration();</b>
<b class="nc">&nbsp;            ((ObjectNode) adminSettings.getJsonValue()).remove(&quot;password&quot;);</b>
<b class="nc">&nbsp;            ((ObjectNode) adminSettings.getJsonValue()).remove(&quot;refreshToken&quot;);</b>
<b class="nc">&nbsp;        } else if (adminSettings.getKey().equals(&quot;sms&quot;)) {</b>
<b class="nc">&nbsp;            smsService.updateSmsConfiguration();</b>
&nbsp;        }
<b class="nc">&nbsp;        return adminSettings;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get the Security Settings object (getSecuritySettings)&quot;,
&nbsp;            notes = &quot;Get the Security Settings object that contains password policy, etc.&quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/securitySettings&quot;)
&nbsp;    public SecuritySettings getSecuritySettings() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        return checkNotNull(securitySettingsService.getSecuritySettings());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Update Security Settings (saveSecuritySettings)&quot;,
&nbsp;            notes = &quot;Updates the Security Settings object that contains password policy, etc.&quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/securitySettings&quot;)
&nbsp;    public SecuritySettings saveSecuritySettings(
&nbsp;            @Parameter(description = &quot;A JSON value representing the Security Settings.&quot;)
&nbsp;            @RequestBody SecuritySettings securitySettings) throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.WRITE);</b>
<b class="nc">&nbsp;        securitySettings = checkNotNull(securitySettingsService.saveSecuritySettings(securitySettings));</b>
<b class="nc">&nbsp;        return securitySettings;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get the JWT Settings object (getJwtSettings)&quot;,
&nbsp;            notes = &quot;Get the JWT Settings object that contains JWT token policy, etc. &quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/jwtSettings&quot;)
&nbsp;    public JwtSettings getJwtSettings() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        return checkNotNull(jwtSettingsService.getJwtSettings());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Update JWT Settings (saveJwtSettings)&quot;,
&nbsp;            notes = &quot;Updates the JWT Settings object that contains JWT token policy, etc. The tokenSigningKey field is a Base64 encoded string.&quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/jwtSettings&quot;)
&nbsp;    public JwtPair saveJwtSettings(
&nbsp;            @Parameter(description = &quot;A JSON value representing the JWT Settings.&quot;)
&nbsp;            @RequestBody JwtSettings jwtSettings) throws ThingsboardException {
<b class="nc">&nbsp;        SecurityUser securityUser = getCurrentUser();</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(securityUser, Resource.ADMIN_SETTINGS, Operation.WRITE);</b>
<b class="nc">&nbsp;        checkNotNull(jwtSettingsService.saveJwtSettings(jwtSettings));</b>
<b class="nc">&nbsp;        return tokenFactory.createTokenPair(securityUser);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Send test email (sendTestMail)&quot;,
&nbsp;            notes = &quot;Attempts to send test email to the System Administrator User using Mail Settings provided as a parameter. &quot; +
&nbsp;                    &quot;You may change the &#39;To&#39; email in the user profile of the System Administrator. &quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/settings/testMail&quot;)
&nbsp;    public void sendTestMail(
&nbsp;            @Parameter(description = &quot;A JSON value representing the Mail Settings.&quot;)
&nbsp;            @RequestBody AdminSettings adminSettings) throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        adminSettings = checkNotNull(adminSettings);</b>
<b class="nc">&nbsp;        if (adminSettings.getKey().equals(MAIL_SETTINGS_KEY)) {</b>
<b class="nc">&nbsp;            if (adminSettings.getJsonValue().has(&quot;enableOauth2&quot;) &amp;&amp; adminSettings.getJsonValue().get(&quot;enableOauth2&quot;).asBoolean()) {</b>
<b class="nc">&nbsp;                AdminSettings mailSettings = checkNotNull(adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, MAIL_SETTINGS_KEY));</b>
<b class="nc">&nbsp;                JsonNode refreshToken = mailSettings.getJsonValue().get(&quot;refreshToken&quot;);</b>
<b class="nc">&nbsp;                if (refreshToken == null) {</b>
<b class="nc">&nbsp;                    throw new ThingsboardException(&quot;Refresh token was not generated. Please, generate refresh token.&quot;, ThingsboardErrorCode.GENERAL);</b>
&nbsp;                }
<b class="nc">&nbsp;                ObjectNode settings = (ObjectNode) adminSettings.getJsonValue();</b>
<b class="nc">&nbsp;                settings.put(&quot;refreshToken&quot;, refreshToken.asText());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (!adminSettings.getJsonValue().has(&quot;password&quot;)) {</b>
<b class="nc">&nbsp;                    AdminSettings mailSettings = checkNotNull(adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, MAIL_SETTINGS_KEY));</b>
<b class="nc">&nbsp;                    ((ObjectNode) adminSettings.getJsonValue()).put(&quot;password&quot;, mailSettings.getJsonValue().get(&quot;password&quot;).asText());</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            String email = getCurrentUser().getEmail();</b>
&nbsp;            try {
<b class="nc">&nbsp;                mailService.sendTestMail(adminSettings.getJsonValue(), email);</b>
&nbsp;            } catch (ThingsboardException e) {
<b class="nc">&nbsp;                String error = e.getMessage();</b>
<b class="nc">&nbsp;                if (e.getCause() != null) {</b>
<b class="nc">&nbsp;                    error += &quot;: &quot; + e.getCause().getMessage(); // showing actual underlying error for testing purposes</b>
&nbsp;                }
<b class="nc">&nbsp;                throw new ThingsboardException(error, e.getErrorCode());</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Send test sms (sendTestSms)&quot;,
&nbsp;            notes = &quot;Attempts to send test sms to the System Administrator User using SMS Settings and phone number provided as a parameters of the request. &quot;
&nbsp;                    + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/settings/testSms&quot;)
&nbsp;    public void sendTestSms(
&nbsp;            @Parameter(description = &quot;A JSON value representing the Test SMS request.&quot;)
&nbsp;            @RequestBody TestSmsRequest testSmsRequest) throws ThingsboardException {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(user, Resource.ADMIN_SETTINGS, Operation.READ);</b>
&nbsp;        try {
<b class="nc">&nbsp;            smsService.sendTestSms(testSmsRequest);</b>
<b class="nc">&nbsp;            auditLogService.logEntityAction(user.getTenantId(), user.getCustomerId(), user.getId(), user.getName(), user.getId(), user, ActionType.SMS_SENT, null, testSmsRequest.getNumberTo());</b>
&nbsp;        } catch (ThingsboardException e) {
<b class="nc">&nbsp;            auditLogService.logEntityAction(user.getTenantId(), user.getCustomerId(), user.getId(), user.getName(), user.getId(), user, ActionType.SMS_SENT, e, testSmsRequest.getNumberTo());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get repository settings (getRepositorySettings)&quot;,
&nbsp;            notes = &quot;Get the repository settings object. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/repositorySettings&quot;)
&nbsp;    public RepositorySettings getRepositorySettings() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        RepositorySettings versionControlSettings = checkNotNull(versionControlService.getVersionControlSettings(getTenantId()));</b>
<b class="nc">&nbsp;        versionControlSettings.setPassword(null);</b>
<b class="nc">&nbsp;        versionControlSettings.setPrivateKey(null);</b>
<b class="nc">&nbsp;        versionControlSettings.setPrivateKeyPassword(null);</b>
<b class="nc">&nbsp;        return versionControlSettings;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check repository settings exists (repositorySettingsExists)&quot;,
&nbsp;            notes = &quot;Check whether the repository settings exists. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/repositorySettings/exists&quot;)
&nbsp;    public Boolean repositorySettingsExists() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        return versionControlService.getVersionControlSettings(getTenantId()) != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/repositorySettings/info&quot;)
&nbsp;    public RepositorySettingsInfo getRepositorySettingsInfo() throws Exception {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        RepositorySettings repositorySettings = versionControlService.getVersionControlSettings(getTenantId());</b>
<b class="nc">&nbsp;        if (repositorySettings != null) {</b>
<b class="nc">&nbsp;            return RepositorySettingsInfo.builder()</b>
<b class="nc">&nbsp;                    .configured(true)</b>
<b class="nc">&nbsp;                    .readOnly(repositorySettings.isReadOnly())</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return RepositorySettingsInfo.builder()</b>
<b class="nc">&nbsp;                    .configured(false)</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Creates or Updates the repository settings (saveRepositorySettings)&quot;,
&nbsp;            notes = &quot;Creates or Updates the repository settings object. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(&quot;/repositorySettings&quot;)
&nbsp;    public DeferredResult&lt;RepositorySettings&gt; saveRepositorySettings(@RequestBody RepositorySettings settings) throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.WRITE);</b>
<b class="nc">&nbsp;        settings.setLocalOnly(false); // only to be used in tests</b>
<b class="nc">&nbsp;        ListenableFuture&lt;RepositorySettings&gt; future = versionControlService.saveVersionControlSettings(getTenantId(), settings);</b>
<b class="nc">&nbsp;        return wrapFuture(Futures.transform(future, savedSettings -&gt; {</b>
<b class="nc">&nbsp;            savedSettings.setPassword(null);</b>
<b class="nc">&nbsp;            savedSettings.setPrivateKey(null);</b>
<b class="nc">&nbsp;            savedSettings.setPrivateKeyPassword(null);</b>
<b class="nc">&nbsp;            return savedSettings;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor()), vcRequestTimeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Delete repository settings (deleteRepositorySettings)&quot;,
&nbsp;            notes = &quot;Deletes the repository settings.&quot;
&nbsp;                    + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @DeleteMapping(value = &quot;/repositorySettings&quot;)
&nbsp;    @ResponseStatus(value = HttpStatus.OK)
&nbsp;    public DeferredResult&lt;Void&gt; deleteRepositorySettings() throws Exception {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.DELETE);</b>
<b class="nc">&nbsp;        return wrapFuture(versionControlService.deleteVersionControlSettings(getTenantId()), vcRequestTimeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check repository access (checkRepositoryAccess)&quot;,
&nbsp;            notes = &quot;Attempts to check repository access. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/repositorySettings/checkAccess&quot;)
&nbsp;    public DeferredResult&lt;Void&gt; checkRepositoryAccess(
&nbsp;            @Parameter(description = &quot;A JSON value representing the Repository Settings.&quot;)
&nbsp;            @RequestBody RepositorySettings settings) throws Exception {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        settings.setLocalOnly(false); // only to be used in tests</b>
<b class="nc">&nbsp;        return wrapFuture(versionControlService.checkVersionControlAccess(getTenantId(), settings), vcRequestTimeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get auto commit settings (getAutoCommitSettings)&quot;,
&nbsp;            notes = &quot;Get the auto commit settings object. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/autoCommitSettings&quot;)
&nbsp;    public AutoCommitSettings getAutoCommitSettings() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        return checkNotNull(autoCommitSettingsService.get(getTenantId()));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check auto commit settings exists (autoCommitSettingsExists)&quot;,
&nbsp;            notes = &quot;Check whether the auto commit settings exists. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/autoCommitSettings/exists&quot;)
&nbsp;    public Boolean autoCommitSettingsExists() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.READ);</b>
<b class="nc">&nbsp;        return autoCommitSettingsService.get(getTenantId()) != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Creates or Updates the auto commit settings (saveAutoCommitSettings)&quot;,
&nbsp;            notes = &quot;Creates or Updates the auto commit settings object. &quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(&quot;/autoCommitSettings&quot;)
&nbsp;    public AutoCommitSettings saveAutoCommitSettings(@RequestBody AutoCommitSettings settings) throws ThingsboardException {
<b class="nc">&nbsp;        settings.values().forEach(config -&gt; VcUtils.checkBranchName(config.getBranch()));</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.WRITE);</b>
<b class="nc">&nbsp;        return autoCommitSettingsService.save(getTenantId(), settings);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Delete auto commit settings (deleteAutoCommitSettings)&quot;,
&nbsp;            notes = &quot;Deletes the auto commit settings.&quot;
&nbsp;                    + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @DeleteMapping(value = &quot;/autoCommitSettings&quot;)
&nbsp;    @ResponseStatus(value = HttpStatus.OK)
&nbsp;    public void deleteAutoCommitSettings() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.VERSION_CONTROL, Operation.DELETE);</b>
<b class="nc">&nbsp;        autoCommitSettingsService.delete(getTenantId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check for new Platform Releases (checkUpdates)&quot;,
&nbsp;            notes = &quot;Check notifications about new platform releases. &quot;
&nbsp;                    + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/updates&quot;)
&nbsp;    public UpdateMessage checkUpdates() {
<b class="nc">&nbsp;        return updateService.checkUpdates();</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get system info (getSystemInfo)&quot;,
&nbsp;            notes = &quot;Get main information about system. &quot;
&nbsp;                    + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/systemInfo&quot;)
&nbsp;    public SystemInfo getSystemInfo() {
<b class="nc">&nbsp;        return systemInfoService.getSystemInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get features info (getFeaturesInfo)&quot;,
&nbsp;            notes = &quot;Get information about enabled/disabled features. &quot;
&nbsp;                    + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/featuresInfo&quot;)
&nbsp;    public FeaturesInfo getFeaturesInfo() {
<b class="nc">&nbsp;        return systemInfoService.getFeaturesInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 log in processing URL (getMailProcessingUrl)&quot;, notes = &quot;Returns the URL enclosed in &quot; +
&nbsp;            &quot;double quotes. After successful authentication with OAuth2 provider and user consent for requested scope, it makes a redirect to this path so that the platform can do &quot; +
&nbsp;            &quot;further log in processing and generating access tokens. &quot; + SYSTEM_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/mail/oauth2/loginProcessingUrl&quot;)
&nbsp;    public String getMailProcessingUrl() throws ThingsboardException {
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        return &quot;\&quot;/api/admin/mail/oauth2/code\&quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Redirect user to mail provider login page. &quot;, notes = &quot;After user logged in and provided access&quot; +
&nbsp;            &quot;provider sends authorization code to specified redirect uri.)&quot;)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;SYS_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/mail/oauth2/authorize&quot;, produces = &quot;application/text&quot;)
&nbsp;    public String getAuthorizationUrl(HttpServletRequest request, HttpServletResponse response) throws ThingsboardException {
<b class="nc">&nbsp;        String state = StringUtils.generateSafeToken();</b>
<b class="nc">&nbsp;        if (request.getParameter(PREV_URI_PATH_PARAMETER) != null) {</b>
<b class="nc">&nbsp;            CookieUtils.addCookie(response, PREV_URI_COOKIE_NAME, request.getParameter(PREV_URI_PATH_PARAMETER), 180);</b>
&nbsp;        }
<b class="nc">&nbsp;        CookieUtils.addCookie(response, STATE_COOKIE_NAME, state, 180);</b>
&nbsp;
<b class="nc">&nbsp;        accessControlService.checkPermission(getCurrentUser(), Resource.ADMIN_SETTINGS, Operation.READ);</b>
<b class="nc">&nbsp;        AdminSettings adminSettings = checkNotNull(adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, MAIL_SETTINGS_KEY), &quot;No Administration mail settings found&quot;);</b>
<b class="nc">&nbsp;        JsonNode jsonValue = adminSettings.getJsonValue();</b>
&nbsp;
<b class="nc">&nbsp;        String clientId = checkNotNull(jsonValue.get(&quot;clientId&quot;), &quot;No clientId was configured&quot;).asText();</b>
<b class="nc">&nbsp;        String authUri = checkNotNull(jsonValue.get(&quot;authUri&quot;), &quot;No authorization uri was configured&quot;).asText();</b>
<b class="nc">&nbsp;        String redirectUri = checkNotNull(jsonValue.get(&quot;redirectUri&quot;), &quot;No Redirect uri was configured&quot;).asText();</b>
<b class="nc">&nbsp;        List&lt;String&gt; scope = JacksonUtil.convertValue(checkNotNull(jsonValue.get(&quot;scope&quot;), &quot;No scope was configured&quot;), new TypeReference&lt;&gt;() {</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        return &quot;\&quot;&quot; + new AuthorizationCodeRequestUrl(authUri, clientId)</b>
<b class="nc">&nbsp;                .setScopes(scope)</b>
<b class="nc">&nbsp;                .setState(state)</b>
<b class="nc">&nbsp;                .setRedirectUri(redirectUri)</b>
<b class="nc">&nbsp;                .build() + &quot;\&quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(value = &quot;/mail/oauth2/code&quot;, params = {&quot;code&quot;, &quot;state&quot;})
&nbsp;    public void codeProcessingUrl(
&nbsp;            @RequestParam(value = &quot;code&quot;) String code, @RequestParam(value = &quot;state&quot;) String state,
&nbsp;            HttpServletRequest request, HttpServletResponse response) throws ThingsboardException, IOException {
<b class="nc">&nbsp;        Optional&lt;Cookie&gt; prevUrlOpt = CookieUtils.getCookie(request, PREV_URI_COOKIE_NAME);</b>
<b class="nc">&nbsp;        Optional&lt;Cookie&gt; cookieState = CookieUtils.getCookie(request, STATE_COOKIE_NAME);</b>
&nbsp;
<b class="nc">&nbsp;        String baseUrl = this.systemSecurityService.getBaseUrl(TenantId.SYS_TENANT_ID, new CustomerId(EntityId.NULL_UUID), request);</b>
<b class="nc">&nbsp;        String prevUri = baseUrl + (prevUrlOpt.isPresent() ? prevUrlOpt.get().getValue() : &quot;/settings/outgoing-mail&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        if (cookieState.isEmpty() || !cookieState.get().getValue().equals(state)) {</b>
<b class="nc">&nbsp;            CookieUtils.deleteCookie(request, response, STATE_COOKIE_NAME);</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Refresh token was not generated, invalid state param&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
<b class="nc">&nbsp;        CookieUtils.deleteCookie(request, response, STATE_COOKIE_NAME);</b>
<b class="nc">&nbsp;        CookieUtils.deleteCookie(request, response, PREV_URI_COOKIE_NAME);</b>
&nbsp;
<b class="nc">&nbsp;        AdminSettings adminSettings = checkNotNull(adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, MAIL_SETTINGS_KEY), &quot;No Administration mail settings found&quot;);</b>
<b class="nc">&nbsp;        JsonNode jsonValue = adminSettings.getJsonValue();</b>
&nbsp;
<b class="nc">&nbsp;        String clientId = checkNotNull(jsonValue.get(&quot;clientId&quot;), &quot;No clientId was configured&quot;).asText();</b>
<b class="nc">&nbsp;        String clientSecret = checkNotNull(jsonValue.get(&quot;clientSecret&quot;), &quot;No client secret was configured&quot;).asText();</b>
<b class="nc">&nbsp;        String clientRedirectUri = checkNotNull(jsonValue.get(&quot;redirectUri&quot;), &quot;No Redirect uri was configured&quot;).asText();</b>
<b class="nc">&nbsp;        String tokenUri = checkNotNull(jsonValue.get(&quot;tokenUri&quot;), &quot;No authorization uri was configured&quot;).asText();</b>
&nbsp;
&nbsp;        TokenResponse tokenResponse;
&nbsp;        try {
<b class="nc">&nbsp;            tokenResponse = new AuthorizationCodeTokenRequest(new NetHttpTransport(), new GsonFactory(), new GenericUrl(tokenUri), code)</b>
<b class="nc">&nbsp;                    .setRedirectUri(clientRedirectUri)</b>
<b class="nc">&nbsp;                    .setClientAuthentication(new ClientParametersAuthentication(clientId, clientSecret))</b>
<b class="nc">&nbsp;                    .execute();</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            log.warn(&quot;Unable to retrieve refresh token: {}&quot;, e.getMessage());</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Error while requesting access token: &quot; + e.getMessage(), ThingsboardErrorCode.GENERAL);</b>
&nbsp;        }
<b class="nc">&nbsp;        ((ObjectNode) jsonValue).put(&quot;refreshToken&quot;, tokenResponse.getRefreshToken());</b>
<b class="nc">&nbsp;        ((ObjectNode) jsonValue).put(&quot;tokenGenerated&quot;, true);</b>
&nbsp;
<b class="nc">&nbsp;        adminSettingsService.saveAdminSettings(TenantId.SYS_TENANT_ID, adminSettings);</b>
<b class="nc">&nbsp;        response.sendRedirect(prevUri);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > OAuth2Controller</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: OAuth2Controller (org.thingsboard.server.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">OAuth2Controller</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import io.swagger.v3.oas.annotations.media.ArraySchema;
&nbsp;import io.swagger.v3.oas.annotations.media.Schema;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import jakarta.validation.Valid;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.DeleteMapping;
&nbsp;import org.springframework.web.bind.annotation.GetMapping;
&nbsp;import org.springframework.web.bind.annotation.PathVariable;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.OAuth2ClientId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.oauth2.OAuth2Client;
&nbsp;import org.thingsboard.server.common.data.oauth2.OAuth2ClientInfo;
&nbsp;import org.thingsboard.server.common.data.oauth2.OAuth2ClientLoginInfo;
&nbsp;import org.thingsboard.server.common.data.oauth2.PlatformType;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.oauth2.OAuth2Configuration;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.entitiy.oauth2client.TbOauth2ClientService;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;import org.thingsboard.server.service.security.permission.Resource;
&nbsp;import org.thingsboard.server.utils.MiscUtils;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Enumeration;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_NUMBER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_SIZE_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_ORDER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_PROPERTY_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SYSTEM_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
&nbsp;@RequestMapping(&quot;/api&quot;)
&nbsp;@RequiredArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class OAuth2Controller extends BaseController {
&nbsp;
&nbsp;    private final OAuth2Configuration oAuth2Configuration;
&nbsp;
&nbsp;    private final TbOauth2ClientService tbOauth2ClientService;
&nbsp;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 clients (getOAuth2Clients)&quot;, notes = &quot;Get the list of OAuth2 clients &quot; +
&nbsp;            &quot;to log in with, available for such domain scheme (HTTP or HTTPS) (if x-forwarded-proto request header is present - &quot; +
&nbsp;            &quot;the scheme is known from it) and domain name and port (port may be known from x-forwarded-port header)&quot;)
&nbsp;    @PostMapping(value = &quot;/noauth/oauth2Clients&quot;)
&nbsp;    public List&lt;OAuth2ClientLoginInfo&gt; getOAuth2Clients(HttpServletRequest request,
&nbsp;                                                        @Parameter(description = &quot;Mobile application package name, to find OAuth2 clients &quot; +
&nbsp;                                                                &quot;where there is configured mobile application with such package name&quot;)
&nbsp;                                                        @RequestParam(required = false) String pkgName,
&nbsp;                                                        @Parameter(description = &quot;Platform type to search OAuth2 clients for which &quot; +
&nbsp;                                                                &quot;the usage with this platform type is allowed in the settings. &quot; +
&nbsp;                                                                &quot;If platform type is not one of allowable values - it will just be ignored&quot;,
&nbsp;                                                                schema = @Schema(allowableValues = {&quot;WEB&quot;, &quot;ANDROID&quot;, &quot;IOS&quot;}))
&nbsp;                                                        @RequestParam(required = false) String platform) {
<b class="nc">&nbsp;        if (log.isDebugEnabled()) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Executing getOAuth2Clients: [{}][{}][{}]&quot;, request.getScheme(), request.getServerName(), request.getServerPort());</b>
<b class="nc">&nbsp;            Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</b>
<b class="nc">&nbsp;            while (headerNames.hasMoreElements()) {</b>
<b class="nc">&nbsp;                String header = headerNames.nextElement();</b>
<b class="nc">&nbsp;                log.debug(&quot;Header: {} {}&quot;, header, request.getHeader(header));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        PlatformType platformType = null;</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(platform)) {</b>
<b class="nc">&nbsp;            platformType = PlatformType.valueOf(platform);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(pkgName)) {</b>
<b class="nc">&nbsp;            return oAuth2ClientService.findOAuth2ClientLoginInfosByMobilePkgNameAndPlatformType(pkgName, platformType);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return oAuth2ClientService.findOAuth2ClientLoginInfosByDomainName(MiscUtils.getDomainNameAndPort(request));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Save OAuth2 Client (saveOAuth2Client)&quot;, notes = SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(value = &quot;/oauth2/client&quot;)
&nbsp;    public OAuth2Client saveOAuth2Client(@RequestBody @Valid OAuth2Client oAuth2Client) throws Exception {
<b class="nc">&nbsp;        TenantId tenantId = getTenantId();</b>
<b class="nc">&nbsp;        oAuth2Client.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        checkEntity(oAuth2Client.getId(), oAuth2Client, Resource.OAUTH2_CLIENT);</b>
<b class="nc">&nbsp;        return tbOauth2ClientService.save(oAuth2Client, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 Client infos (findTenantOAuth2ClientInfos)&quot;, notes = SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/oauth2/client/infos&quot;)
&nbsp;    public PageData&lt;OAuth2ClientInfo&gt; findTenantOAuth2ClientInfos(@Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;                                                                  @RequestParam int pageSize,
&nbsp;                                                                  @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;                                                                  @RequestParam int page,
&nbsp;                                                                  @Parameter(description = &quot;Case-insensitive &#39;substring&#39; filter based on client&#39;s title&quot;)
&nbsp;                                                                  @RequestParam(required = false) String textSearch,
&nbsp;                                                                  @Parameter(description = SORT_PROPERTY_DESCRIPTION)
&nbsp;                                                                  @RequestParam(required = false) String sortProperty,
&nbsp;                                                                  @Parameter(description = SORT_ORDER_DESCRIPTION)
&nbsp;                                                                  @RequestParam(required = false) String sortOrder) throws ThingsboardException {
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        return oAuth2ClientService.findOAuth2ClientInfosByTenantId(getTenantId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 Client infos By Ids (findTenantOAuth2ClientInfosByIds)&quot;,
&nbsp;            notes = &quot;Fetch OAuth2 Client info objects based on the provided ids. &quot; + SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/oauth2/client/infos&quot;, params = {&quot;clientIds&quot;})
&nbsp;    public List&lt;OAuth2ClientInfo&gt; findTenantOAuth2ClientInfosByIds(
&nbsp;            @Parameter(description = &quot;A list of oauth2 ids, separated by comma &#39;,&#39;&quot;, array = @ArraySchema(schema = @Schema(type = &quot;string&quot;)), required = true)
&nbsp;            @RequestParam(&quot;clientIds&quot;) UUID[] clientIds) throws ThingsboardException {
<b class="nc">&nbsp;        List&lt;OAuth2ClientId&gt; oAuth2ClientIds = getOAuth2ClientIds(clientIds);</b>
<b class="nc">&nbsp;        return oAuth2ClientService.findOAuth2ClientInfosByIds(getTenantId(), oAuth2ClientIds);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 Client by id (getOAuth2ClientById)&quot;, notes = SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/oauth2/client/{id}&quot;)
&nbsp;    public OAuth2Client getOAuth2ClientById(@PathVariable UUID id) throws ThingsboardException {
<b class="nc">&nbsp;        OAuth2ClientId oAuth2ClientId = new OAuth2ClientId(id);</b>
<b class="nc">&nbsp;        return checkEntityId(oAuth2ClientId, oAuth2ClientService::findOAuth2ClientById, Operation.READ);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Delete oauth2 client (deleteOauth2Client)&quot;,
&nbsp;            notes = &quot;Deletes the oauth2 client. Referencing non-existing oauth2 client Id will cause an error.&quot; + SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @DeleteMapping(value = &quot;/oauth2/client/{id}&quot;)
&nbsp;    public void deleteOauth2Client(@PathVariable UUID id) throws Exception {
<b class="nc">&nbsp;        OAuth2ClientId oAuth2ClientId = new OAuth2ClientId(id);</b>
<b class="nc">&nbsp;        OAuth2Client oAuth2Client = checkOauth2ClientId(oAuth2ClientId, Operation.DELETE);</b>
<b class="nc">&nbsp;        tbOauth2ClientService.delete(oAuth2Client, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get OAuth2 log in processing URL (getLoginProcessingUrl)&quot;, notes = &quot;Returns the URL enclosed in &quot; +
&nbsp;            &quot;double quotes. After successful authentication with OAuth2 provider, it makes a redirect to this path so that the platform can do &quot; +
&nbsp;            &quot;further log in processing. This URL may be configured as &#39;security.oauth2.loginProcessingUrl&#39; property in yml configuration file, or &quot; +
&nbsp;            &quot;as &#39;SECURITY_OAUTH2_LOGIN_PROCESSING_URL&#39; env variable. By default it is &#39;/login/oauth2/code/&#39;&quot; + SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @GetMapping(value = &quot;/oauth2/loginProcessingUrl&quot;)
&nbsp;    public String getLoginProcessingUrl() {
<b class="nc">&nbsp;        return &quot;\&quot;&quot; + oAuth2Configuration.getLoginProcessingUrl() + &quot;\&quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

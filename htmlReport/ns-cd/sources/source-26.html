<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > NotificationTargetController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: NotificationTargetController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">NotificationTargetController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
</tr>
  <tr>
    <td class="name">NotificationTargetController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import io.swagger.v3.oas.annotations.media.ArraySchema;
&nbsp;import io.swagger.v3.oas.annotations.media.Schema;
&nbsp;import jakarta.validation.Valid;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.collections4.CollectionUtils;
&nbsp;import org.springframework.security.access.AccessDeniedException;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.security.core.annotation.AuthenticationPrincipal;
&nbsp;import org.springframework.web.bind.annotation.DeleteMapping;
&nbsp;import org.springframework.web.bind.annotation.GetMapping;
&nbsp;import org.springframework.web.bind.annotation.PathVariable;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.NotificationTargetId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.notification.NotificationType;
&nbsp;import org.thingsboard.server.common.data.notification.targets.NotificationTarget;
&nbsp;import org.thingsboard.server.common.data.notification.targets.NotificationTargetConfig;
&nbsp;import org.thingsboard.server.common.data.notification.targets.NotificationTargetType;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.CustomerUsersFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.PlatformUsersNotificationTargetConfig;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.TenantAdministratorsFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.UserListFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.UsersFilter;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.notification.NotificationTargetService;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.MARKDOWN_CODE_BLOCK_END;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.MARKDOWN_CODE_BLOCK_START;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.NEW_LINE;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_DATA_PARAMETERS;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_NUMBER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_SIZE_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_ORDER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_PROPERTY_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.service.security.permission.Resource.NOTIFICATION;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
&nbsp;@RequestMapping(&quot;/api/notification&quot;)
&nbsp;@RequiredArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class NotificationTargetController extends BaseController {
&nbsp;
&nbsp;    private final NotificationTargetService notificationTargetService;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Save notification target (saveNotificationTarget)&quot;,
&nbsp;            notes = &quot;Creates or updates notification target.&quot; + NEW_LINE +
&nbsp;                    &quot;Available `configuration` types are `PLATFORM_USERS` and `SLACK`.\n&quot; +
&nbsp;                    &quot;For `PLATFORM_USERS` the `usersFilter` must be specified. &quot; +
&nbsp;                    &quot;For tenant, there are following users filter types available: &quot; +
&nbsp;                    &quot;`USER_LIST`, `CUSTOMER_USERS`, `TENANT_ADMINISTRATORS`, `ALL_USERS`, &quot; +
&nbsp;                    &quot;`ORIGINATOR_ENTITY_OWNER_USERS`, `AFFECTED_USER`.\n&quot; +
&nbsp;                    &quot;For sysadmin: `TENANT_ADMINISTRATORS`, `AFFECTED_TENANT_ADMINISTRATORS`, &quot; +
&nbsp;                    &quot;`SYSTEM_ADMINISTRATORS`, `ALL_USERS`.&quot; + NEW_LINE +
&nbsp;                    &quot;Here is an example of tenant-level notification target to send notification to customer&#39;s users:\n&quot; +
&nbsp;                    MARKDOWN_CODE_BLOCK_START +
&nbsp;                    &quot;{\n&quot; +
&nbsp;                    &quot;  \&quot;name\&quot;: \&quot;Users of Customer A\&quot;,\n&quot; +
&nbsp;                    &quot;  \&quot;configuration\&quot;: {\n&quot; +
&nbsp;                    &quot;    \&quot;type\&quot;: \&quot;PLATFORM_USERS\&quot;,\n&quot; +
&nbsp;                    &quot;    \&quot;usersFilter\&quot;: {\n&quot; +
&nbsp;                    &quot;      \&quot;type\&quot;: \&quot;CUSTOMER_USERS\&quot;,\n&quot; +
&nbsp;                    &quot;      \&quot;customerId\&quot;: \&quot;32499a20-d785-11ed-a06c-21dd57dd88ca\&quot;\n&quot; +
&nbsp;                    &quot;    },\n&quot; +
&nbsp;                    &quot;    \&quot;description\&quot;: \&quot;Users of Customer A\&quot;\n&quot; +
&nbsp;                    &quot;  }\n&quot; +
&nbsp;                    &quot;}&quot; +
&nbsp;                    MARKDOWN_CODE_BLOCK_END +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PostMapping(&quot;/target&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public NotificationTarget saveNotificationTarget(@RequestBody @Valid NotificationTarget notificationTarget,
&nbsp;                                                     @AuthenticationPrincipal SecurityUser user) throws Exception {
<b class="nc">&nbsp;        notificationTarget.setTenantId(user.getTenantId());</b>
<b class="nc">&nbsp;        checkEntity(notificationTarget.getId(), notificationTarget, NOTIFICATION);</b>
&nbsp;
<b class="nc">&nbsp;        NotificationTargetConfig targetConfig = notificationTarget.getConfiguration();</b>
<b class="nc">&nbsp;        if (targetConfig.getType() == NotificationTargetType.PLATFORM_USERS) {</b>
<b class="nc">&nbsp;            checkTargetUsers(user, targetConfig);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return doSaveAndLog(EntityType.NOTIFICATION_TARGET, notificationTarget, notificationTargetService::saveNotificationTarget);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get notification target by id (getNotificationTargetById)&quot;,
&nbsp;            notes = &quot;Fetches notification target by id.&quot; +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @GetMapping(&quot;/target/{id}&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public NotificationTarget getNotificationTargetById(@PathVariable UUID id) throws ThingsboardException {
<b class="nc">&nbsp;        NotificationTargetId notificationTargetId = new NotificationTargetId(id);</b>
<b class="nc">&nbsp;        return checkNotificationTargetId(notificationTargetId, Operation.READ);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get recipients for notification target config (getRecipientsForNotificationTargetConfig)&quot;,
&nbsp;            notes = &quot;Returns the page of recipients for such notification target configuration.&quot; +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PostMapping(&quot;/target/recipients&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public PageData&lt;User&gt; getRecipientsForNotificationTargetConfig(@RequestBody NotificationTarget notificationTarget,
&nbsp;                                                                   @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;                                                                   @RequestParam int pageSize,
&nbsp;                                                                   @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;                                                                   @RequestParam int page,
&nbsp;                                                                   @AuthenticationPrincipal SecurityUser user) throws ThingsboardException {
&nbsp;        // PE: generic permission
<b class="nc">&nbsp;        NotificationTargetConfig targetConfig = notificationTarget.getConfiguration();</b>
<b class="nc">&nbsp;        if (targetConfig.getType() == NotificationTargetType.PLATFORM_USERS) {</b>
<b class="nc">&nbsp;            checkTargetUsers(user, targetConfig);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Target type is not platform users&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, null, null, null);</b>
<b class="nc">&nbsp;        return notificationTargetService.findRecipientsForNotificationTargetConfig(user.getTenantId(), (PlatformUsersNotificationTargetConfig) notificationTarget.getConfiguration(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get notification targets by ids (getNotificationTargetsByIds)&quot;,
&nbsp;            notes = &quot;Returns the list of notification targets found by provided ids.&quot; +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @GetMapping(value = &quot;/targets&quot;, params = {&quot;ids&quot;})
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public List&lt;NotificationTarget&gt; getNotificationTargetsByIds(@Parameter(description = &quot;Comma-separated list of uuids representing targets ids&quot;, array = @ArraySchema(schema = @Schema(type = &quot;string&quot;)), required = true)
&nbsp;                                                                @RequestParam(&quot;ids&quot;) UUID[] ids,
&nbsp;                                                                @AuthenticationPrincipal SecurityUser user) {
&nbsp;        // PE: generic permission
<b class="nc">&nbsp;        List&lt;NotificationTargetId&gt; targetsIds = Arrays.stream(ids).map(NotificationTargetId::new).collect(Collectors.toList());</b>
<b class="nc">&nbsp;        return notificationTargetService.findNotificationTargetsByTenantIdAndIds(user.getTenantId(), targetsIds);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get notification targets (getNotificationTargets)&quot;,
&nbsp;            notes = &quot;Returns the page of notification targets owned by sysadmin or tenant.&quot; + NEW_LINE +
&nbsp;                    PAGE_DATA_PARAMETERS +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @GetMapping(&quot;/targets&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public PageData&lt;NotificationTarget&gt; getNotificationTargets(@Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;                                                               @RequestParam int pageSize,
&nbsp;                                                               @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;                                                               @RequestParam int page,
&nbsp;                                                               @Parameter(description = &quot;Case-insensitive &#39;substring&#39; filed based on the target&#39;s name&quot;)
&nbsp;                                                               @RequestParam(required = false) String textSearch,
&nbsp;                                                               @Parameter(description = SORT_PROPERTY_DESCRIPTION)
&nbsp;                                                               @RequestParam(required = false) String sortProperty,
&nbsp;                                                               @Parameter(description = SORT_ORDER_DESCRIPTION)
&nbsp;                                                               @RequestParam(required = false) String sortOrder,
&nbsp;                                                               @AuthenticationPrincipal SecurityUser user) throws ThingsboardException {
&nbsp;        // PE: generic permission
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        return notificationTargetService.findNotificationTargetsByTenantId(user.getTenantId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get notification targets by supported notification type (getNotificationTargetsBySupportedNotificationType)&quot;,
&nbsp;            notes = &quot;Returns the page of notification targets filtered by notification type that they can be used for.&quot; + NEW_LINE +
&nbsp;                    PAGE_DATA_PARAMETERS +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @GetMapping(value = &quot;/targets&quot;, params = &quot;notificationType&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public PageData&lt;NotificationTarget&gt; getNotificationTargetsBySupportedNotificationType(@RequestParam int pageSize,
&nbsp;                                                                                          @RequestParam int page,
&nbsp;                                                                                          @RequestParam(required = false) String textSearch,
&nbsp;                                                                                          @RequestParam(required = false) String sortProperty,
&nbsp;                                                                                          @RequestParam(required = false) String sortOrder,
&nbsp;                                                                                          @RequestParam(required = false) NotificationType notificationType,
&nbsp;                                                                                          @AuthenticationPrincipal SecurityUser user) throws ThingsboardException {
&nbsp;        // PE: generic permission
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        return notificationTargetService.findNotificationTargetsByTenantIdAndSupportedNotificationType(user.getTenantId(), notificationType, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Delete notification target by id (deleteNotificationTargetById)&quot;,
&nbsp;            notes = &quot;Deletes notification target by its id.&quot; + NEW_LINE +
&nbsp;                    &quot;This target cannot be referenced by existing scheduled notification requests or any notification rules.&quot; +
&nbsp;                    SYSTEM_OR_TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @DeleteMapping(&quot;/target/{id}&quot;)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    public void deleteNotificationTargetById(@PathVariable UUID id) throws Exception {
<b class="nc">&nbsp;        NotificationTargetId notificationTargetId = new NotificationTargetId(id);</b>
<b class="nc">&nbsp;        NotificationTarget notificationTarget = checkNotificationTargetId(notificationTargetId, Operation.DELETE);</b>
<b class="nc">&nbsp;        doDeleteAndLog(EntityType.NOTIFICATION_TARGET, notificationTarget, notificationTargetService::deleteNotificationTargetById);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void checkTargetUsers(SecurityUser user, NotificationTargetConfig targetConfig) throws ThingsboardException {
<b class="nc">&nbsp;        if (user.isSystemAdmin()) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        // PE: generic permission for users
<b class="nc">&nbsp;        UsersFilter usersFilter = ((PlatformUsersNotificationTargetConfig) targetConfig).getUsersFilter();</b>
<b class="nc">&nbsp;        switch (usersFilter.getType()) {</b>
&nbsp;            case USER_LIST:
<b class="nc">&nbsp;                for (UUID recipientId : ((UserListFilter) usersFilter).getUsersIds()) {</b>
<b class="nc">&nbsp;                    checkUserId(new UserId(recipientId), Operation.READ);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case CUSTOMER_USERS:
<b class="nc">&nbsp;                CustomerId customerId = new CustomerId(((CustomerUsersFilter) usersFilter).getCustomerId());</b>
<b class="nc">&nbsp;                checkEntityId(customerId, Operation.READ);</b>
&nbsp;                break;
&nbsp;            case TENANT_ADMINISTRATORS:
<b class="nc">&nbsp;                if (CollectionUtils.isNotEmpty(((TenantAdministratorsFilter) usersFilter).getTenantsIds()) ||</b>
<b class="nc">&nbsp;                        CollectionUtils.isNotEmpty(((TenantAdministratorsFilter) usersFilter).getTenantProfilesIds())) {</b>
<b class="nc">&nbsp;                    throw new AccessDeniedException(&quot;&quot;);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case SYSTEM_ADMINISTRATORS:
<b class="nc">&nbsp;                throw new AccessDeniedException(&quot;&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

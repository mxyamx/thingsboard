<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TwoFactorAuthController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: TwoFactorAuthController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TwoFactorAuthController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/37)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TwoFactorAuthController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TwoFactorAuthController$TwoFaProviderInfo</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.Builder;
&nbsp;import lombok.Data;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.GetMapping;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.security.model.JwtPair;
&nbsp;import org.thingsboard.server.common.data.security.model.mfa.PlatformTwoFaSettings;
&nbsp;import org.thingsboard.server.common.data.security.model.mfa.account.EmailTwoFaAccountConfig;
&nbsp;import org.thingsboard.server.common.data.security.model.mfa.account.SmsTwoFaAccountConfig;
&nbsp;import org.thingsboard.server.common.data.security.model.mfa.provider.TwoFaProviderType;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.user.UserService;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.security.auth.mfa.TwoFactorAuthService;
&nbsp;import org.thingsboard.server.service.security.auth.mfa.config.TwoFaConfigManager;
&nbsp;import org.thingsboard.server.service.security.auth.rest.RestAuthenticationDetails;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.model.token.JwtTokenFactory;
&nbsp;import org.thingsboard.server.service.security.system.SystemSecurityService;
&nbsp;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.NEW_LINE;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/api/auth/2fa&quot;)
&nbsp;@TbCoreComponent
&nbsp;@RequiredArgsConstructor
&nbsp;public class TwoFactorAuthController extends BaseController {
&nbsp;
&nbsp;    private final TwoFactorAuthService twoFactorAuthService;
&nbsp;    private final TwoFaConfigManager twoFaConfigManager;
&nbsp;    private final JwtTokenFactory tokenFactory;
&nbsp;    private final SystemSecurityService systemSecurityService;
&nbsp;    private final UserService userService;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Request 2FA verification code (requestTwoFaVerificationCode)&quot;,
&nbsp;            notes = &quot;Request 2FA verification code.&quot; + NEW_LINE +
&nbsp;                    &quot;To make a request to this endpoint, you need an access token with the scope of PRE_VERIFICATION_TOKEN, &quot; +
&nbsp;                    &quot;which is issued on username/password auth if 2FA is enabled.&quot; + NEW_LINE +
&nbsp;                    &quot;The API method is rate limited (using rate limit config from TwoFactorAuthSettings). &quot; +
&nbsp;                    &quot;Will return a Bad Request error if provider is not configured for usage, &quot; +
&nbsp;                    &quot;and Too Many Requests error if rate limits are exceeded.&quot;)
&nbsp;    @PostMapping(&quot;/verification/send&quot;)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;PRE_VERIFICATION_TOKEN&#39;)&quot;)
&nbsp;    public void requestTwoFaVerificationCode(@RequestParam TwoFaProviderType providerType) throws Exception {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        twoFactorAuthService.prepareVerificationCode(user, providerType, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Check 2FA verification code (checkTwoFaVerificationCode)&quot;,
&nbsp;            notes = &quot;Checks 2FA verification code, and if it is correct the method returns a regular access and refresh token pair.&quot; + NEW_LINE +
&nbsp;                    &quot;The API method is rate limited (using rate limit config from TwoFactorAuthSettings), and also will block a user &quot; +
&nbsp;                    &quot;after X unsuccessful verification attempts if such behavior is configured (in TwoFactorAuthSettings).&quot; + NEW_LINE +
&nbsp;                    &quot;Will return a Bad Request error if provider is not configured for usage, &quot; +
&nbsp;                    &quot;and Too Many Requests error if rate limits are exceeded.&quot;)
&nbsp;    @PostMapping(&quot;/verification/check&quot;)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;PRE_VERIFICATION_TOKEN&#39;)&quot;)
&nbsp;    public JwtPair checkTwoFaVerificationCode(@RequestParam TwoFaProviderType providerType,
&nbsp;                                              @RequestParam String verificationCode, HttpServletRequest servletRequest) throws Exception {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        boolean verificationSuccess = twoFactorAuthService.checkVerificationCode(user, providerType, verificationCode, true);</b>
<b class="nc">&nbsp;        if (verificationSuccess) {</b>
<b class="nc">&nbsp;            logLogInAction(servletRequest, user, null);</b>
<b class="nc">&nbsp;            return createTokenPair(user);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            IllegalArgumentException error = new IllegalArgumentException(&quot;Verification code is incorrect&quot;);</b>
<b class="nc">&nbsp;            logLogInAction(servletRequest, user, error);</b>
&nbsp;            throw error;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get available 2FA providers (getAvailableTwoFaProviders)&quot;, notes =
&nbsp;            &quot;Get the list of 2FA provider infos available for user to use. Example:\n&quot; +
&nbsp;            &quot;```\n[\n&quot; +
&nbsp;            &quot;  {\n    \&quot;type\&quot;: \&quot;EMAIL\&quot;,\n    \&quot;default\&quot;: true,\n    \&quot;contact\&quot;: \&quot;ab*****ko@gmail.com\&quot;\n  },\n&quot; +
&nbsp;            &quot;  {\n    \&quot;type\&quot;: \&quot;TOTP\&quot;,\n    \&quot;default\&quot;: false,\n    \&quot;contact\&quot;: null\n  },\n&quot; +
&nbsp;            &quot;  {\n    \&quot;type\&quot;: \&quot;SMS\&quot;,\n    \&quot;default\&quot;: false,\n    \&quot;contact\&quot;: \&quot;+38********12\&quot;\n  }\n&quot; +
&nbsp;            &quot;]\n```&quot;)
&nbsp;    @GetMapping(&quot;/providers&quot;)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;PRE_VERIFICATION_TOKEN&#39;)&quot;)
&nbsp;    public List&lt;TwoFaProviderInfo&gt; getAvailableTwoFaProviders() throws ThingsboardException {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        Optional&lt;PlatformTwoFaSettings&gt; platformTwoFaSettings = twoFaConfigManager.getPlatformTwoFaSettings(user.getTenantId(), true);</b>
<b class="nc">&nbsp;        return twoFaConfigManager.getAccountTwoFaSettings(user.getTenantId(), user)</b>
<b class="nc">&nbsp;                .map(settings -&gt; settings.getConfigs().values()).orElse(Collections.emptyList())</b>
<b class="nc">&nbsp;                .stream().map(config -&gt; {</b>
<b class="nc">&nbsp;                    String contact = null;</b>
<b class="nc">&nbsp;                    switch (config.getProviderType()) {</b>
&nbsp;                        case SMS:
<b class="nc">&nbsp;                            String phoneNumber = ((SmsTwoFaAccountConfig) config).getPhoneNumber();</b>
<b class="nc">&nbsp;                            contact = StringUtils.obfuscate(phoneNumber, 2, &#39;*&#39;, phoneNumber.indexOf(&#39;+&#39;) + 1, phoneNumber.length());</b>
&nbsp;                            break;
&nbsp;                        case EMAIL:
<b class="nc">&nbsp;                            String email = ((EmailTwoFaAccountConfig) config).getEmail();</b>
<b class="nc">&nbsp;                            contact = StringUtils.obfuscate(email, 2, &#39;*&#39;, 0, email.indexOf(&#39;@&#39;));</b>
&nbsp;                            break;
&nbsp;                    }
<b class="nc">&nbsp;                    return TwoFaProviderInfo.builder()</b>
<b class="nc">&nbsp;                            .type(config.getProviderType())</b>
<b class="nc">&nbsp;                            .isDefault(config.isUseByDefault())</b>
<b class="nc">&nbsp;                            .contact(contact)</b>
<b class="nc">&nbsp;                            .minVerificationCodeSendPeriod(platformTwoFaSettings.get().getMinVerificationCodeSendPeriod())</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get regular token pair after successfully configuring 2FA&quot;,
&nbsp;            notes = &quot;Checks 2FA is configured, returning token pair on success.&quot;)
&nbsp;    @PostMapping(&quot;/login&quot;)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;MFA_CONFIGURATION_TOKEN&#39;)&quot;)
&nbsp;    public JwtPair authenticateByTwoFaConfigurationToken(HttpServletRequest servletRequest) throws ThingsboardException {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        if (twoFactorAuthService.isTwoFaEnabled(user.getTenantId(), user)) {</b>
<b class="nc">&nbsp;            logLogInAction(servletRequest, user, null);</b>
<b class="nc">&nbsp;            return createTokenPair(user);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            IllegalArgumentException error = new IllegalArgumentException(&quot;2FA is not configured&quot;);</b>
<b class="nc">&nbsp;            logLogInAction(servletRequest, user, error);</b>
&nbsp;            throw error;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private JwtPair createTokenPair(SecurityUser user) {
<b class="nc">&nbsp;        log.debug(&quot;[{}][{}] Creating token pair for user&quot;, user.getTenantId(), user.getId());</b>
<b class="nc">&nbsp;        user = new SecurityUser(userService.findUserById(user.getTenantId(), user.getId()), true, user.getUserPrincipal());</b>
<b class="nc">&nbsp;        return tokenFactory.createTokenPair(user);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logLogInAction(HttpServletRequest servletRequest, SecurityUser user, Exception error) {
<b class="nc">&nbsp;        systemSecurityService.logLoginAction(user, new RestAuthenticationDetails(servletRequest), ActionType.LOGIN, error);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Data
&nbsp;    @AllArgsConstructor
&nbsp;    @Builder
&nbsp;    public static class TwoFaProviderInfo {
&nbsp;        private TwoFaProviderType type;
&nbsp;        private boolean isDefault;
&nbsp;        private String contact;
&nbsp;        private Integer minVerificationCodeSendPeriod;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

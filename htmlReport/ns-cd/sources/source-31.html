<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RuleEngineController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: RuleEngineController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RuleEngineController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
</tr>
  <tr>
    <td class="name">RuleEngineController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RuleEngineController$LocalRequestMetaData</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.PathVariable;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestMethod;
&nbsp;import org.springframework.web.bind.annotation.ResponseBody;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.springframework.web.context.request.async.DeferredResult;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.exception.ToErrorResponseEntity;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.ruleengine.RuleEngineCallService;
&nbsp;import org.thingsboard.server.service.security.AccessValidator;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.TimeoutException;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.ENTITY_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.ENTITY_TYPE_PARAM_DESCRIPTION;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
&nbsp;@RequestMapping(TbUrlConstants.RULE_ENGINE_URL_PREFIX)
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class RuleEngineController extends BaseController {</b>
&nbsp;
&nbsp;    @Value(&quot;${server.rest.rule_engine.response_timeout:10000}&quot;)
&nbsp;    public int defaultResponseTimeout;
&nbsp;
&nbsp;    private static final String MSG_DESCRIPTION_PREFIX = &quot;Creates the Message with type &#39;REST_API_REQUEST&#39; and payload taken from the request body. &quot;;
&nbsp;    private static final String MSG_DESCRIPTION = &quot;This method allows you to extend the regular platform API with the power of Rule Engine. You may use default and custom rule nodes to handle the message. &quot; +
&nbsp;            &quot;The generated message contains two important metadata fields:\n\n&quot; +
&nbsp;            &quot; * **&#39;serviceId&#39;** to identify the platform server that received the request;\n&quot; +
&nbsp;            &quot; * **&#39;requestUUID&#39;** to identify the request and route possible response from the Rule Engine;\n\n&quot; +
&nbsp;            &quot;Use **&#39;rest call reply&#39;** rule node to push the reply from rule engine back as a REST API call response. &quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private RuleEngineCallService ruleEngineCallService;
&nbsp;    @Autowired
&nbsp;    private AccessValidator accessValidator;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Push user message to the rule engine (handleRuleEngineRequest)&quot;,
&nbsp;            notes = MSG_DESCRIPTION_PREFIX +
&nbsp;                    &quot;Uses current User Id ( the one which credentials is used to perform the request) as the Rule Engine message originator. &quot; +
&nbsp;                    MSG_DESCRIPTION +
&nbsp;                    &quot;The default timeout of the request processing is 10 seconds.&quot;
&nbsp;                    + &quot;\n\n&quot; + ControllerConstants.SECURITY_WRITE_CHECK)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; handleRuleEngineRequest(
&nbsp;            @Parameter(description = &quot;A JSON value representing the message.&quot;, required = true)
&nbsp;            @RequestBody String requestBody) throws ThingsboardException {
<b class="nc">&nbsp;        return handleRuleEngineRequest(null, null, null, defaultResponseTimeout, requestBody);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Push entity message to the rule engine (handleRuleEngineRequest)&quot;,
&nbsp;            notes = MSG_DESCRIPTION_PREFIX +
&nbsp;                    &quot;Uses specified Entity Id as the Rule Engine message originator. &quot; +
&nbsp;                    MSG_DESCRIPTION +
&nbsp;                    &quot;The default timeout of the request processing is 10 seconds.&quot;
&nbsp;                    + &quot;\n\n&quot; + ControllerConstants.SECURITY_WRITE_CHECK)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/{entityType}/{entityId}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; handleRuleEngineRequest(
&nbsp;            @Parameter(description = ENTITY_TYPE_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityType&quot;) String entityType,
&nbsp;            @Parameter(description = ENTITY_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityId&quot;) String entityIdStr,
&nbsp;            @Parameter(description = &quot;A JSON value representing the message.&quot;, required = true)
&nbsp;            @RequestBody String requestBody) throws ThingsboardException {
<b class="nc">&nbsp;        return handleRuleEngineRequest(entityType, entityIdStr, null, defaultResponseTimeout, requestBody);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Push entity message with timeout to the rule engine (handleRuleEngineRequest)&quot;,
&nbsp;            notes = MSG_DESCRIPTION_PREFIX +
&nbsp;                    &quot;Uses specified Entity Id as the Rule Engine message originator. &quot; +
&nbsp;                    MSG_DESCRIPTION +
&nbsp;                    &quot;The platform expects the timeout value in milliseconds.&quot;
&nbsp;                    + &quot;\n\n&quot; + ControllerConstants.SECURITY_WRITE_CHECK)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/{entityType}/{entityId}/{timeout}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; handleRuleEngineRequest(
&nbsp;            @Parameter(description = ENTITY_TYPE_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityType&quot;) String entityType,
&nbsp;            @Parameter(description = ENTITY_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityId&quot;) String entityIdStr,
&nbsp;            @Parameter(description = &quot;Timeout to process the request in milliseconds&quot;, required = true)
&nbsp;            @PathVariable(&quot;timeout&quot;) int timeout,
&nbsp;            @Parameter(description = &quot;A JSON value representing the message.&quot;, required = true)
&nbsp;            @RequestBody String requestBody) throws ThingsboardException {
<b class="nc">&nbsp;        return handleRuleEngineRequest(entityType, entityIdStr, null, timeout, requestBody);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Push entity message with timeout and specified queue to the rule engine (handleRuleEngineRequest)&quot;,
&nbsp;            notes = MSG_DESCRIPTION_PREFIX +
&nbsp;                    &quot;Uses specified Entity Id as the Rule Engine message originator. &quot; +
&nbsp;                    MSG_DESCRIPTION +
&nbsp;                    &quot;If request sent for Device/Device Profile or Asset/Asset Profile entity, specified queue will be used instead of the queue selected in the device or asset profile. &quot; +
&nbsp;                    &quot;The platform expects the timeout value in milliseconds.&quot;
&nbsp;                    + &quot;\n\n&quot; + ControllerConstants.SECURITY_WRITE_CHECK)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;SYS_ADMIN&#39;, &#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/{entityType}/{entityId}/{queueName}/{timeout}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; handleRuleEngineRequest(
&nbsp;            @Parameter(description = ENTITY_TYPE_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityType&quot;) String entityType,
&nbsp;            @Parameter(description = ENTITY_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;entityId&quot;) String entityIdStr,
&nbsp;            @Parameter(description = &quot;Queue name to process the request in the rule engine&quot;, required = true)
&nbsp;            @PathVariable(&quot;queueName&quot;) String queueName,
&nbsp;            @Parameter(description = &quot;Timeout to process the request in milliseconds&quot;, required = true)
&nbsp;            @PathVariable(&quot;timeout&quot;) int timeout,
&nbsp;            @Parameter(description = &quot;A JSON value representing the message.&quot;, required = true)
&nbsp;            @RequestBody String requestBody) throws ThingsboardException {
&nbsp;        try {
<b class="nc">&nbsp;            SecurityUser currentUser = getCurrentUser();</b>
&nbsp;            EntityId entityId;
<b class="nc">&nbsp;            if (StringUtils.isEmpty(entityType) || StringUtils.isEmpty(entityIdStr)) {</b>
<b class="nc">&nbsp;                entityId = currentUser.getId();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entityId = EntityIdFactory.getByTypeAndId(entityType, entityIdStr);</b>
&nbsp;            }
&nbsp;            //Check that this is a valid JSON
<b class="nc">&nbsp;            JacksonUtil.toJsonNode(requestBody);</b>
<b class="nc">&nbsp;            final DeferredResult&lt;ResponseEntity&gt; response = new DeferredResult&lt;&gt;();</b>
<b class="nc">&nbsp;            accessValidator.validate(currentUser, Operation.WRITE, entityId, new HttpValidationCallback(response, new FutureCallback&lt;DeferredResult&lt;ResponseEntity&gt;&gt;() {</b>
&nbsp;                @Override
&nbsp;                public void onSuccess(@Nullable DeferredResult&lt;ResponseEntity&gt; result) {
<b class="nc">&nbsp;                    long expTime = System.currentTimeMillis() + timeout;</b>
<b class="nc">&nbsp;                    HashMap&lt;String, String&gt; metaData = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                    UUID requestId = UUID.randomUUID();</b>
<b class="nc">&nbsp;                    metaData.put(&quot;serviceId&quot;, serviceInfoProvider.getServiceId());</b>
<b class="nc">&nbsp;                    metaData.put(&quot;requestUUID&quot;, requestId.toString());</b>
<b class="nc">&nbsp;                    metaData.put(&quot;expirationTime&quot;, Long.toString(expTime));</b>
<b class="nc">&nbsp;                    TbMsg msg = TbMsg.newMsg()</b>
<b class="nc">&nbsp;                            .queueName(queueName)</b>
<b class="nc">&nbsp;                            .type(TbMsgType.REST_API_REQUEST)</b>
<b class="nc">&nbsp;                            .originator(entityId)</b>
<b class="nc">&nbsp;                            .customerId(currentUser.getCustomerId())</b>
<b class="nc">&nbsp;                            .copyMetaData(new TbMsgMetaData(metaData))</b>
<b class="nc">&nbsp;                            .data(requestBody)</b>
<b class="nc">&nbsp;                            .build();</b>
<b class="nc">&nbsp;                    ruleEngineCallService.processRestApiCallToRuleEngine(currentUser.getTenantId(), requestId, msg, queueName != null,</b>
<b class="nc">&nbsp;                            reply -&gt; reply(new LocalRequestMetaData(msg, currentUser, result), reply));</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public void onFailure(Throwable e) {
&nbsp;                    ResponseEntity entity;
<b class="nc">&nbsp;                    if (e instanceof ToErrorResponseEntity) {</b>
<b class="nc">&nbsp;                        entity = ((ToErrorResponseEntity) e).toErrorResponseEntity();</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        entity = new ResponseEntity(HttpStatus.UNAUTHORIZED);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    logRuleEngineCall(currentUser, entityId, requestBody, null, e);</b>
<b class="nc">&nbsp;                    response.setResult(entity);</b>
&nbsp;                }
&nbsp;            }));
<b class="nc">&nbsp;            return response;</b>
&nbsp;        } catch (IllegalArgumentException iae) {
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Invalid request body&quot;, iae, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void reply(LocalRequestMetaData rpcRequest, TbMsg response) {
<b class="nc">&nbsp;        DeferredResult&lt;ResponseEntity&gt; responseWriter = rpcRequest.responseWriter();</b>
<b class="nc">&nbsp;        if (response == null) {</b>
<b class="nc">&nbsp;            logRuleEngineCall(rpcRequest, null, new TimeoutException(&quot;Processing timeout detected!&quot;));</b>
<b class="nc">&nbsp;            responseWriter.setResult(new ResponseEntity&lt;&gt;(HttpStatus.REQUEST_TIMEOUT));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            String responseData = response.getData();</b>
<b class="nc">&nbsp;            if (!StringUtils.isEmpty(responseData)) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    logRuleEngineCall(rpcRequest, response, null);</b>
<b class="nc">&nbsp;                    responseWriter.setResult(new ResponseEntity&lt;&gt;(JacksonUtil.toJsonNode(responseData), HttpStatus.OK));</b>
&nbsp;                } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;                    log.debug(&quot;Failed to decode device response: {}&quot;, responseData, e);</b>
<b class="nc">&nbsp;                    logRuleEngineCall(rpcRequest, response, e);</b>
<b class="nc">&nbsp;                    responseWriter.setResult(new ResponseEntity&lt;&gt;(HttpStatus.NOT_ACCEPTABLE));</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                logRuleEngineCall(rpcRequest, response, null);</b>
<b class="nc">&nbsp;                responseWriter.setResult(new ResponseEntity&lt;&gt;(HttpStatus.OK));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void logRuleEngineCall(LocalRequestMetaData rpcRequest, TbMsg response, Throwable e) {
<b class="nc">&nbsp;        logRuleEngineCall(rpcRequest.user(), rpcRequest.request().getOriginator(), rpcRequest.request().getData(), response, e);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logRuleEngineCall(SecurityUser user, EntityId entityId, String request, TbMsg response, Throwable e) {
<b class="nc">&nbsp;        auditLogService.logEntityAction(</b>
<b class="nc">&nbsp;                user.getTenantId(),</b>
<b class="nc">&nbsp;                user.getCustomerId(),</b>
<b class="nc">&nbsp;                user.getId(),</b>
<b class="nc">&nbsp;                user.getName(),</b>
&nbsp;                entityId,
&nbsp;                null,
&nbsp;                ActionType.REST_API_RULE_ENGINE_CALL,
<b class="nc">&nbsp;                BaseController.toException(e),</b>
&nbsp;                request,
<b class="nc">&nbsp;                response != null ? response.getData() : &quot;&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private record LocalRequestMetaData(TbMsg request, SecurityUser user, DeferredResult&lt;ResponseEntity&gt; responseWriter) {}</b>
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeviceController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.controller</a>
</div>

<h1>Coverage Summary for Class: DeviceController (org.thingsboard.server.controller)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeviceController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/184)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DeviceController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DeviceController$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.controller;
&nbsp;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import io.swagger.v3.oas.annotations.Parameter;
&nbsp;import io.swagger.v3.oas.annotations.media.ArraySchema;
&nbsp;import io.swagger.v3.oas.annotations.media.Schema;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import jakarta.validation.Valid;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.PathVariable;
&nbsp;import org.springframework.web.bind.annotation.PostMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestBody;
&nbsp;import org.springframework.web.bind.annotation.RequestMapping;
&nbsp;import org.springframework.web.bind.annotation.RequestMethod;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.springframework.web.bind.annotation.ResponseBody;
&nbsp;import org.springframework.web.bind.annotation.ResponseStatus;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;import org.springframework.web.context.request.async.DeferredResult;
&nbsp;import org.thingsboard.server.common.data.ClaimRequest;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceInfo;
&nbsp;import org.thingsboard.server.common.data.DeviceInfoFilter;
&nbsp;import org.thingsboard.server.common.data.EntitySubtype;
&nbsp;import org.thingsboard.server.common.data.NameConflictPolicy;
&nbsp;import org.thingsboard.server.common.data.NameConflictStrategy;
&nbsp;import org.thingsboard.server.common.data.SaveDeviceWithCredentialsRequest;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.UniquifyStrategy;
&nbsp;import org.thingsboard.server.common.data.device.DeviceSearchQuery;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.ota.OtaPackageType;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.page.TimePageLink;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.sync.ie.importing.csv.BulkImportRequest;
&nbsp;import org.thingsboard.server.common.data.sync.ie.importing.csv.BulkImportResult;
&nbsp;import org.thingsboard.server.config.annotations.ApiOperation;
&nbsp;import org.thingsboard.server.dao.device.claim.ClaimResponse;
&nbsp;import org.thingsboard.server.dao.device.claim.ClaimResult;
&nbsp;import org.thingsboard.server.dao.device.claim.ReclaimResult;
&nbsp;import org.thingsboard.server.dao.exception.IncorrectParameterException;
&nbsp;import org.thingsboard.server.dao.model.ModelConstants;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.device.DeviceBulkImportService;
&nbsp;import org.thingsboard.server.service.entitiy.device.TbDeviceService;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;import org.thingsboard.server.service.security.permission.Resource;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.CUSTOMER_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.CUSTOMER_ID;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.CUSTOMER_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_ACTIVE_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_ID;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_INFO_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_NAME_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_PROFILE_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_TEXT_SEARCH_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_TYPE_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_UPDATE_CREDENTIALS_PARAM_ACCESS_TOKEN_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_UPDATE_CREDENTIALS_PARAM_LVM2M_RPK_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_UPDATE_CREDENTIALS_PARAM_MQTT_BASIC_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_UPDATE_CREDENTIALS_PARAM_X509_CERTIFICATE_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_ACCESS_TOKEN_DEFAULT_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_ACCESS_TOKEN_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_LVM2M_RPK_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_MQTT_BASIC_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_X509_CERTIFICATE_DESCRIPTION_MARKDOWN;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.EDGE_ASSIGN_ASYNC_FIRST_STEP_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.EDGE_ASSIGN_RECEIVE_STEP_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.EDGE_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.EDGE_UNASSIGN_ASYNC_FIRST_STEP_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.EDGE_UNASSIGN_RECEIVE_STEP_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.NAME_CONFLICT_POLICY_DESC;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.UNIQUIFY_SEPARATOR_DESC;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_DATA_PARAMETERS;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_NUMBER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.PAGE_SIZE_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_ORDER_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.SORT_PROPERTY_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.TENANT_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.TENANT_ID;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.TENANT_ID_PARAM_DESCRIPTION;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.UNIQUIFY_STRATEGY_DESC;
&nbsp;import static org.thingsboard.server.controller.ControllerConstants.UUID_WIKI_LINK;
&nbsp;import static org.thingsboard.server.controller.EdgeController.EDGE_ID;
&nbsp;
&nbsp;@RestController
&nbsp;@TbCoreComponent
&nbsp;@RequestMapping(&quot;/api&quot;)
&nbsp;@RequiredArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class DeviceController extends BaseController {
&nbsp;
&nbsp;    protected static final String DEVICE_NAME = &quot;deviceName&quot;;
&nbsp;
&nbsp;    private final DeviceBulkImportService deviceBulkImportService;
&nbsp;
&nbsp;    private final TbDeviceService tbDeviceService;
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Device (getDeviceById)&quot;,
&nbsp;            notes = &quot;Fetch the Device object based on the provided Device Id. &quot; +
&nbsp;                    &quot;If the user has the authority of &#39;TENANT_ADMIN&#39;, the server checks that the device is owned by the same tenant. &quot; +
&nbsp;                    &quot;If the user has the authority of &#39;CUSTOMER_USER&#39;, the server checks that the device is assigned to the same customer.&quot; +
&nbsp;                    TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/{deviceId}&quot;, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public Device getDeviceById(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        return checkDeviceId(deviceId, Operation.READ);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Device Info (getDeviceInfoById)&quot;,
&nbsp;            notes = &quot;Fetch the Device Info object based on the provided Device Id. &quot; +
&nbsp;                    &quot;If the user has the authority of &#39;Tenant Administrator&#39;, the server checks that the device is owned by the same tenant. &quot; +
&nbsp;                    &quot;If the user has the authority of &#39;Customer User&#39;, the server checks that the device is assigned to the same customer. &quot; +
&nbsp;                    DEVICE_INFO_DESCRIPTION + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/info/{deviceId}&quot;, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public DeviceInfo getDeviceInfoById(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                        @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        return checkDeviceInfoId(deviceId, Operation.READ);</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Create Or Update Device (saveDevice)&quot;,
&nbsp;            notes = &quot;Create or update the Device. When creating device, platform generates Device Id as &quot; + UUID_WIKI_LINK +
&nbsp;                    &quot;Device credentials are also generated if not provided in the &#39;accessToken&#39; request parameter. &quot; +
&nbsp;                    &quot;The newly created device id will be present in the response. &quot; +
&nbsp;                    &quot;Specify existing Device id to update the device. &quot; +
&nbsp;                    &quot;Referencing non-existing device Id will cause &#39;Not Found&#39; error.&quot; +
&nbsp;                    &quot;\n\nDevice name is unique in the scope of tenant. Use unique identifiers like MAC or IMEI for the device names and non-unique &#39;label&#39; field for user-friendly visualization purposes.&quot; +
&nbsp;                    &quot;Remove &#39;id&#39;, &#39;tenantId&#39; and optionally &#39;customerId&#39; from the request body example (below) to create new Device entity. &quot; +
&nbsp;                    TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device saveDevice(@io.swagger.v3.oas.annotations.parameters.RequestBody(description = &quot;A JSON value representing the device.&quot;) @RequestBody Device device,
&nbsp;                             @Parameter(description = &quot;Optional value of the device credentials to be used during device creation. &quot; +
&nbsp;                                     &quot;If omitted, access token will be auto-generated.&quot;)
&nbsp;                             @RequestParam(name = &quot;accessToken&quot;, required = false) String accessToken,
&nbsp;                             @Parameter(description = NAME_CONFLICT_POLICY_DESC)
&nbsp;                             @RequestParam(name = &quot;nameConflictPolicy&quot;, defaultValue = &quot;FAIL&quot;) NameConflictPolicy nameConflictPolicy,
&nbsp;                             @Parameter(description = UNIQUIFY_SEPARATOR_DESC)
&nbsp;                             @RequestParam(name = &quot;uniquifySeparator&quot;, defaultValue = &quot;_&quot;) String uniquifySeparator,
&nbsp;                             @Parameter(description = UNIQUIFY_STRATEGY_DESC)
&nbsp;                             @RequestParam(name = &quot;uniquifyStrategy&quot;, defaultValue = &quot;RANDOM&quot;) UniquifyStrategy uniquifyStrategy) throws Exception {
<b class="nc">&nbsp;        device.setTenantId(getCurrentUser().getTenantId());</b>
<b class="nc">&nbsp;        if (device.getId() != null) {</b>
<b class="nc">&nbsp;            checkDeviceId(device.getId(), Operation.WRITE);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            checkEntity(null, device, Resource.DEVICE);</b>
&nbsp;        }
<b class="nc">&nbsp;        return tbDeviceService.save(device, accessToken, new NameConflictStrategy(nameConflictPolicy, uniquifySeparator, uniquifyStrategy), getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Create Device (saveDevice) with credentials &quot;,
&nbsp;            notes = &quot;Create or update the Device. When creating device, platform generates Device Id as &quot; + UUID_WIKI_LINK +
&nbsp;                    &quot;Requires to provide the Device Credentials object as well as an existing device profile ID or use \&quot;default\&quot;.\n&quot; +
&nbsp;                    &quot;You may find the example of device with different type of credentials below: \n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;Access token\&quot;&lt;/b&gt; with &lt;b&gt;device profile ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_ACCESS_TOKEN_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;Access token\&quot;&lt;/b&gt; with  &lt;b&gt;device profile default&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_ACCESS_TOKEN_DEFAULT_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;X509\&quot;&lt;/b&gt; with &lt;b&gt;device profile ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    &quot;Note: &lt;b&gt;credentialsId&lt;/b&gt; -  format &lt;b&gt;Sha3Hash&lt;/b&gt;, &lt;b&gt;certificateValue&lt;/b&gt; - format &lt;b&gt;PEM&lt;/b&gt; (with \&quot;--BEGIN CERTIFICATE----\&quot; and  -\&quot;----END CERTIFICATE-\&quot;).\n\n&quot; +
&nbsp;                    DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_X509_CERTIFICATE_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;MQTT_BASIC\&quot;&lt;/b&gt; with &lt;b&gt;device profile ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_MQTT_BASIC_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- You may find the example of &lt;b&gt;LwM2M&lt;/b&gt; device and &lt;b&gt;RPK&lt;/b&gt; credentials below: \n\n&quot; +
&nbsp;                    &quot;Note: LwM2M device - only existing device profile ID (Transport configuration -&gt; Transport type: \&quot;LWM2M\&quot;.\n\n&quot; +
&nbsp;                    DEVICE_WITH_DEVICE_CREDENTIALS_PARAM_LVM2M_RPK_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;Remove &#39;id&#39;, &#39;tenantId&#39; and optionally &#39;customerId&#39; from the request body example (below) to create new Device entity. &quot; +
&nbsp;                    TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device-with-credentials&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device saveDeviceWithCredentials(@Parameter(description = &quot;The JSON object with device and credentials. See method description above for example.&quot;)
&nbsp;                                            @Valid @RequestBody SaveDeviceWithCredentialsRequest deviceAndCredentials,
&nbsp;                                            @Parameter(description = NAME_CONFLICT_POLICY_DESC)
&nbsp;                                            @RequestParam(name = &quot;nameConflictPolicy&quot;, defaultValue = &quot;FAIL&quot;) NameConflictPolicy nameConflictPolicy,
&nbsp;                                            @Parameter(description = UNIQUIFY_SEPARATOR_DESC)
&nbsp;                                            @RequestParam(name = &quot;uniquifySeparator&quot;, defaultValue = &quot;_&quot;) String uniquifySeparator,
&nbsp;                                            @Parameter(description = UNIQUIFY_STRATEGY_DESC)
&nbsp;                                            @RequestParam(name = &quot;uniquifyStrategy&quot;, defaultValue = &quot;RANDOM&quot;) UniquifyStrategy uniquifyStrategy) throws ThingsboardException {
<b class="nc">&nbsp;        Device device = deviceAndCredentials.getDevice();</b>
<b class="nc">&nbsp;        DeviceCredentials credentials = deviceAndCredentials.getCredentials();</b>
<b class="nc">&nbsp;        device.setTenantId(getCurrentUser().getTenantId());</b>
<b class="nc">&nbsp;        checkEntity(device.getId(), device, Resource.DEVICE);</b>
<b class="nc">&nbsp;        return tbDeviceService.saveDeviceWithCredentials(device, credentials, new NameConflictStrategy(nameConflictPolicy, uniquifySeparator, uniquifyStrategy), getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Delete device (deleteDevice)&quot;,
&nbsp;            notes = &quot;Deletes the device, it&#39;s credentials and all the relations (from and to the device). Referencing non-existing device Id will cause an error.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/{deviceId}&quot;, method = RequestMethod.DELETE)
&nbsp;    @ResponseStatus(value = HttpStatus.OK)
&nbsp;    public void deleteDevice(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                             @PathVariable(DEVICE_ID) String strDeviceId) throws Exception {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceId, Operation.DELETE);</b>
<b class="nc">&nbsp;        tbDeviceService.delete(device, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Assign device to customer (assignDeviceToCustomer)&quot;,
&nbsp;            notes = &quot;Creates assignment of the device to customer. Customer will be able to query device afterwards.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/{customerId}/device/{deviceId}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device assignDeviceToCustomer(@Parameter(description = CUSTOMER_ID_PARAM_DESCRIPTION)
&nbsp;                                         @PathVariable(&quot;customerId&quot;) String strCustomerId,
&nbsp;                                         @Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                         @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(&quot;customerId&quot;, strCustomerId);</b>
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        CustomerId customerId = new CustomerId(toUUID(strCustomerId));</b>
<b class="nc">&nbsp;        Customer customer = checkCustomerId(customerId, Operation.READ);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        checkDeviceId(deviceId, Operation.ASSIGN_TO_CUSTOMER);</b>
<b class="nc">&nbsp;        return tbDeviceService.assignDeviceToCustomer(getTenantId(), deviceId, customer, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Unassign device from customer (unassignDeviceFromCustomer)&quot;,
&nbsp;            notes = &quot;Clears assignment of the device to customer. Customer will not be able to query device afterwards.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/device/{deviceId}&quot;, method = RequestMethod.DELETE)
&nbsp;    @ResponseBody
&nbsp;    public Device unassignDeviceFromCustomer(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                             @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceId, Operation.UNASSIGN_FROM_CUSTOMER);</b>
<b class="nc">&nbsp;        if (device.getCustomerId() == null || device.getCustomerId().getId().equals(ModelConstants.NULL_UUID)) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;Device isn&#39;t assigned to any customer!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Customer customer = checkCustomerId(device.getCustomerId(), Operation.READ);</b>
&nbsp;
<b class="nc">&nbsp;        return tbDeviceService.unassignDeviceFromCustomer(device, customer, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Make device publicly available (assignDeviceToPublicCustomer)&quot;,
&nbsp;            notes = &quot;Device will be available for non-authorized (not logged-in) users. &quot; +
&nbsp;                    &quot;This is useful to create dashboards that you plan to share/embed on a publicly available website. &quot; +
&nbsp;                    &quot;However, users that are logged-in and belong to different tenant will not be able to access the device.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/public/device/{deviceId}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device assignDeviceToPublicCustomer(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                               @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        checkDeviceId(deviceId, Operation.ASSIGN_TO_CUSTOMER);</b>
<b class="nc">&nbsp;        return tbDeviceService.assignDeviceToPublicCustomer(getTenantId(), deviceId, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Device Credentials (getDeviceCredentialsByDeviceId)&quot;,
&nbsp;            notes = &quot;If during device creation there wasn&#39;t specified any credentials, platform generates random &#39;ACCESS_TOKEN&#39; credentials.&quot; + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/{deviceId}/credentials&quot;, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public DeviceCredentials getDeviceCredentialsByDeviceId(@Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                                            @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceId, Operation.READ_CREDENTIALS);</b>
<b class="nc">&nbsp;        return tbDeviceService.getDeviceCredentialsByDeviceId(device, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Update device credentials (updateDeviceCredentials)&quot;,
&nbsp;            notes = &quot;During device creation, platform generates random &#39;ACCESS_TOKEN&#39; credentials. \&quot; +\n&quot; +
&nbsp;                    &quot;Use this method to update the device credentials. First use &#39;getDeviceCredentialsByDeviceId&#39; to get the credentials id and value.\n&quot; +
&nbsp;                    &quot;Then use current method to update the credentials type and value. It is not possible to create multiple device credentials for the same device.\n&quot; +
&nbsp;                    &quot;The structure of device credentials id and value is simple for the &#39;ACCESS_TOKEN&#39; but is much more complex for the &#39;MQTT_BASIC&#39; or &#39;LWM2M_CREDENTIALS&#39;.\n&quot; +
&nbsp;                    &quot;You may find the example of device with different type of credentials below: \n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;Access token\&quot;&lt;/b&gt; with &lt;b&gt;device ID&lt;/b&gt; and with &lt;b&gt;device ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    DEVICE_UPDATE_CREDENTIALS_PARAM_ACCESS_TOKEN_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;X509\&quot;&lt;/b&gt; with &lt;b&gt;device profile ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    &quot;Note: &lt;b&gt;credentialsId&lt;/b&gt; -  format &lt;b&gt;Sha3Hash&lt;/b&gt;, &lt;b&gt;certificateValue&lt;/b&gt; - format &lt;b&gt;PEM&lt;/b&gt; (with \&quot;--BEGIN CERTIFICATE----\&quot; and  -\&quot;----END CERTIFICATE-\&quot;).\n\n&quot; +
&nbsp;                    DEVICE_UPDATE_CREDENTIALS_PARAM_X509_CERTIFICATE_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- Credentials type: &lt;b&gt;\&quot;MQTT_BASIC\&quot;&lt;/b&gt; with &lt;b&gt;device profile ID&lt;/b&gt; below: \n\n&quot; +
&nbsp;                    DEVICE_UPDATE_CREDENTIALS_PARAM_MQTT_BASIC_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;- You may find the example of &lt;b&gt;LwM2M&lt;/b&gt; device and &lt;b&gt;RPK&lt;/b&gt; credentials below: \n\n&quot; +
&nbsp;                    &quot;Note: LwM2M device - only existing device profile ID (Transport configuration -&gt; Transport type: \&quot;LWM2M\&quot;.\n\n&quot; +
&nbsp;                    DEVICE_UPDATE_CREDENTIALS_PARAM_LVM2M_RPK_DESCRIPTION_MARKDOWN + &quot;\n\n&quot; +
&nbsp;                    &quot;Update to real value:\n&quot; +
&nbsp;                    &quot; - &#39;id&#39; (this is id of Device Credentials -&gt;  \&quot;Get Device Credentials (getDeviceCredentialsByDeviceId)\&quot;,\n&quot; +
&nbsp;                    &quot; - &#39;deviceId.id&#39; (this is id of Device).\n&quot; +
&nbsp;                    &quot;Remove &#39;tenantId&#39; and optionally &#39;customerId&#39; from the request body example (below) to create new Device entity.&quot; +
&nbsp;                    TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/credentials&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeviceCredentials updateDeviceCredentials(
&nbsp;            @Parameter(description = &quot;A JSON value representing the device credentials.&quot;)
&nbsp;            @RequestBody DeviceCredentials deviceCredentials) throws ThingsboardException {
<b class="nc">&nbsp;        checkNotNull(deviceCredentials);</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceCredentials.getDeviceId(), Operation.WRITE_CREDENTIALS);</b>
<b class="nc">&nbsp;        return tbDeviceService.updateDeviceCredentials(device, deviceCredentials, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Tenant Devices (getTenantDevices)&quot;,
&nbsp;            notes = &quot;Returns a page of devices owned by tenant. &quot; +
&nbsp;                    PAGE_DATA_PARAMETERS + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/tenant/devices&quot;, params = {&quot;pageSize&quot;, &quot;page&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public PageData&lt;Device&gt; getTenantDevices(
&nbsp;            @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;            @RequestParam int pageSize,
&nbsp;            @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;            @RequestParam int page,
&nbsp;            @Parameter(description = DEVICE_TYPE_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String type,
&nbsp;            @Parameter(description = DEVICE_TEXT_SEARCH_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String textSearch,
&nbsp;            @Parameter(description = SORT_PROPERTY_DESCRIPTION, schema = @Schema(allowableValues = {&quot;createdTime&quot;, &quot;name&quot;, &quot;deviceProfileName&quot;, &quot;label&quot;, &quot;customerTitle&quot;}))
&nbsp;            @RequestParam(required = false) String sortProperty,
&nbsp;            @Parameter(description = SORT_ORDER_DESCRIPTION, schema = @Schema(allowableValues = {&quot;ASC&quot;, &quot;DESC&quot;}))
&nbsp;            @RequestParam(required = false) String sortOrder) throws ThingsboardException {
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        if (type != null &amp;&amp; type.trim().length() &gt; 0) {</b>
<b class="nc">&nbsp;            return checkNotNull(deviceService.findDevicesByTenantIdAndType(tenantId, type, pageLink));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return checkNotNull(deviceService.findDevicesByTenantId(tenantId, pageLink));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Tenant Device Infos (getTenantDeviceInfos)&quot;,
&nbsp;            notes = &quot;Returns a page of devices info objects owned by tenant. &quot; +
&nbsp;                    PAGE_DATA_PARAMETERS + DEVICE_INFO_DESCRIPTION + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/tenant/deviceInfos&quot;, params = {&quot;pageSize&quot;, &quot;page&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public PageData&lt;DeviceInfo&gt; getTenantDeviceInfos(
&nbsp;            @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;            @RequestParam int pageSize,
&nbsp;            @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;            @RequestParam int page,
&nbsp;            @Parameter(description = DEVICE_TYPE_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String type,
&nbsp;            @Parameter(description = DEVICE_PROFILE_ID_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String deviceProfileId,
&nbsp;            @Parameter(description = DEVICE_ACTIVE_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) Boolean active,
&nbsp;            @Parameter(description = DEVICE_TEXT_SEARCH_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String textSearch,
&nbsp;            @Parameter(description = SORT_PROPERTY_DESCRIPTION, schema = @Schema(allowableValues = {&quot;createdTime&quot;, &quot;name&quot;, &quot;deviceProfileName&quot;, &quot;label&quot;, &quot;customerTitle&quot;}))
&nbsp;            @RequestParam(required = false) String sortProperty,
&nbsp;            @Parameter(description = SORT_ORDER_DESCRIPTION, schema = @Schema(allowableValues = {&quot;ASC&quot;, &quot;DESC&quot;}))
&nbsp;            @RequestParam(required = false) String sortOrder
&nbsp;    ) throws ThingsboardException {
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        DeviceInfoFilter.DeviceInfoFilterBuilder filter = DeviceInfoFilter.builder();</b>
<b class="nc">&nbsp;        filter.tenantId(tenantId);</b>
<b class="nc">&nbsp;        filter.active(active);</b>
<b class="nc">&nbsp;        if (type != null &amp;&amp; type.trim().length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.type(type);</b>
<b class="nc">&nbsp;        } else if (deviceProfileId != null &amp;&amp; deviceProfileId.length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.deviceProfileId(new DeviceProfileId(toUUID(deviceProfileId)));</b>
&nbsp;        }
<b class="nc">&nbsp;        return checkNotNull(deviceService.findDeviceInfosByFilter(filter.build(), pageLink));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Tenant Device (getTenantDevice)&quot;,
&nbsp;            notes = &quot;Requested device must be owned by tenant that the user belongs to. &quot; +
&nbsp;                    &quot;Device name is an unique property of device. So it can be used to identify the device.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/tenant/devices&quot;, params = {&quot;deviceName&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public Device getTenantDevice(
&nbsp;            @Parameter(description = DEVICE_NAME_DESCRIPTION)
&nbsp;            @RequestParam String deviceName) throws ThingsboardException {
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        return checkNotNull(deviceService.findDeviceByTenantIdAndName(tenantId, deviceName));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Customer Devices (getCustomerDevices)&quot;,
&nbsp;            notes = &quot;Returns a page of devices objects assigned to customer. &quot; +
&nbsp;                    PAGE_DATA_PARAMETERS + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/{customerId}/devices&quot;, params = {&quot;pageSize&quot;, &quot;page&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public PageData&lt;Device&gt; getCustomerDevices(
&nbsp;            @Parameter(description = CUSTOMER_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(CUSTOMER_ID) String strCustomerId,
&nbsp;            @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;            @RequestParam int pageSize,
&nbsp;            @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;            @RequestParam int page,
&nbsp;            @Parameter(description = DEVICE_TYPE_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String type,
&nbsp;            @Parameter(description = DEVICE_TEXT_SEARCH_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String textSearch,
&nbsp;            @Parameter(description = SORT_PROPERTY_DESCRIPTION, schema = @Schema(allowableValues = {&quot;createdTime&quot;, &quot;name&quot;, &quot;deviceProfileName&quot;, &quot;label&quot;, &quot;customerTitle&quot;}))
&nbsp;            @RequestParam(required = false) String sortProperty,
&nbsp;            @Parameter(description = SORT_ORDER_DESCRIPTION, schema = @Schema(allowableValues = {&quot;ASC&quot;, &quot;DESC&quot;}))
&nbsp;            @RequestParam(required = false) String sortOrder) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(&quot;customerId&quot;, strCustomerId);</b>
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        CustomerId customerId = new CustomerId(toUUID(strCustomerId));</b>
<b class="nc">&nbsp;        checkCustomerId(customerId, Operation.READ);</b>
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        if (type != null &amp;&amp; type.trim().length() &gt; 0) {</b>
<b class="nc">&nbsp;            return checkNotNull(deviceService.findDevicesByTenantIdAndCustomerIdAndType(tenantId, customerId, type, pageLink));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return checkNotNull(deviceService.findDevicesByTenantIdAndCustomerId(tenantId, customerId, pageLink));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Customer Device Infos (getCustomerDeviceInfos)&quot;,
&nbsp;            notes = &quot;Returns a page of devices info objects assigned to customer. &quot; +
&nbsp;                    PAGE_DATA_PARAMETERS + DEVICE_INFO_DESCRIPTION + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/{customerId}/deviceInfos&quot;, params = {&quot;pageSize&quot;, &quot;page&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public PageData&lt;DeviceInfo&gt; getCustomerDeviceInfos(
&nbsp;            @Parameter(description = CUSTOMER_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(&quot;customerId&quot;) String strCustomerId,
&nbsp;            @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;            @RequestParam int pageSize,
&nbsp;            @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;            @RequestParam int page,
&nbsp;            @Parameter(description = DEVICE_TYPE_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String type,
&nbsp;            @Parameter(description = DEVICE_PROFILE_ID_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String deviceProfileId,
&nbsp;            @Parameter(description = DEVICE_ACTIVE_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) Boolean active,
&nbsp;            @Parameter(description = DEVICE_TEXT_SEARCH_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String textSearch,
&nbsp;            @Parameter(description = SORT_PROPERTY_DESCRIPTION, schema = @Schema(allowableValues = {&quot;createdTime&quot;, &quot;name&quot;, &quot;deviceProfileName&quot;, &quot;label&quot;, &quot;customerTitle&quot;}))
&nbsp;            @RequestParam(required = false) String sortProperty,
&nbsp;            @Parameter(description = SORT_ORDER_DESCRIPTION, schema = @Schema(allowableValues = {&quot;ASC&quot;, &quot;DESC&quot;}))
&nbsp;            @RequestParam(required = false) String sortOrder) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(&quot;customerId&quot;, strCustomerId);</b>
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        CustomerId customerId = new CustomerId(toUUID(strCustomerId));</b>
<b class="nc">&nbsp;        checkCustomerId(customerId, Operation.READ);</b>
<b class="nc">&nbsp;        PageLink pageLink = createPageLink(pageSize, page, textSearch, sortProperty, sortOrder);</b>
<b class="nc">&nbsp;        DeviceInfoFilter.DeviceInfoFilterBuilder filter = DeviceInfoFilter.builder();</b>
<b class="nc">&nbsp;        filter.tenantId(tenantId);</b>
<b class="nc">&nbsp;        filter.customerId(customerId);</b>
<b class="nc">&nbsp;        filter.active(active);</b>
<b class="nc">&nbsp;        if (type != null &amp;&amp; type.trim().length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.type(type);</b>
<b class="nc">&nbsp;        } else if (deviceProfileId != null &amp;&amp; deviceProfileId.length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.deviceProfileId(new DeviceProfileId(toUUID(deviceProfileId)));</b>
&nbsp;        }
<b class="nc">&nbsp;        return checkNotNull(deviceService.findDeviceInfosByFilter(filter.build(), pageLink));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Devices By Ids (getDevicesByIds)&quot;,
&nbsp;            notes = &quot;Requested devices must be owned by tenant or assigned to customer which user is performing the request. &quot; + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/devices&quot;, params = {&quot;deviceIds&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public List&lt;Device&gt; getDevicesByIds(
&nbsp;            @Parameter(description = &quot;A list of devices ids, separated by comma &#39;,&#39;&quot;,  array = @ArraySchema(schema = @Schema(type = &quot;string&quot;)))
&nbsp;            @RequestParam(&quot;deviceIds&quot;) String[] strDeviceIds) throws ThingsboardException, ExecutionException, InterruptedException {
<b class="nc">&nbsp;        checkArrayParameter(&quot;deviceIds&quot;, strDeviceIds);</b>
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        TenantId tenantId = user.getTenantId();</b>
<b class="nc">&nbsp;        CustomerId customerId = user.getCustomerId();</b>
<b class="nc">&nbsp;        List&lt;DeviceId&gt; deviceIds = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (String strDeviceId : strDeviceIds) {</b>
<b class="nc">&nbsp;            deviceIds.add(new DeviceId(toUUID(strDeviceId)));</b>
&nbsp;        }
&nbsp;        ListenableFuture&lt;List&lt;Device&gt;&gt; devices;
<b class="nc">&nbsp;        if (customerId == null || customerId.isNullUid()) {</b>
<b class="nc">&nbsp;            devices = deviceService.findDevicesByTenantIdAndIdsAsync(tenantId, deviceIds);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            devices = deviceService.findDevicesByTenantIdCustomerIdAndIdsAsync(tenantId, customerId, deviceIds);</b>
&nbsp;        }
<b class="nc">&nbsp;        return checkNotNull(devices.get());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Find related devices (findByQuery)&quot;,
&nbsp;            notes = &quot;Returns all devices that are related to the specific entity. &quot; +
&nbsp;                    &quot;The entity id, relation type, device types, depth of the search, and other query parameters defined using complex &#39;DeviceSearchQuery&#39; object. &quot; +
&nbsp;                    &quot;See &#39;Model&#39; tab of the Parameters for more info.&quot; + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/devices&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public List&lt;Device&gt; findByQuery(
&nbsp;            @Parameter(description = &quot;The device search query JSON&quot;)
&nbsp;            @RequestBody DeviceSearchQuery query) throws ThingsboardException, ExecutionException, InterruptedException {
<b class="nc">&nbsp;        checkNotNull(query);</b>
<b class="nc">&nbsp;        checkNotNull(query.getParameters());</b>
<b class="nc">&nbsp;        checkNotNull(query.getDeviceTypes());</b>
<b class="nc">&nbsp;        checkEntityId(query.getParameters().getEntityId(), Operation.READ);</b>
<b class="nc">&nbsp;        List&lt;Device&gt; devices = checkNotNull(deviceService.findDevicesByQuery(getCurrentUser().getTenantId(), query).get());</b>
<b class="nc">&nbsp;        devices = devices.stream().filter(device -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                accessControlService.checkPermission(getCurrentUser(), Resource.DEVICE, Operation.READ, device.getId(), device);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            } catch (ThingsboardException e) {
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
<b class="nc">&nbsp;        }).collect(Collectors.toList());</b>
<b class="nc">&nbsp;        return devices;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get Device Types (getDeviceTypes)&quot;,
&nbsp;            notes = &quot;Deprecated. See &#39;getDeviceProfileNames&#39; API from Device Profile Controller instead.&quot; + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/device/types&quot;, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    @Deprecated(since = &quot;3.6.2&quot;)
&nbsp;    public List&lt;EntitySubtype&gt; getDeviceTypes() throws ThingsboardException, ExecutionException, InterruptedException {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        TenantId tenantId = user.getTenantId();</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; deviceTypes = deviceService.findDeviceTypesByTenantId(tenantId);</b>
<b class="nc">&nbsp;        return checkNotNull(deviceTypes.get());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Claim device (claimDevice)&quot;,
&nbsp;            notes = &quot;Claiming makes it possible to assign a device to the specific customer using device/server side claiming data (in the form of secret key).&quot; +
&nbsp;                    &quot;To make this happen you have to provide unique device name and optional claiming data (it is needed only for device-side claiming).&quot; +
&nbsp;                    &quot;Once device is claimed, the customer becomes its owner and customer users may access device data as well as control the device. \n&quot; +
&nbsp;                    &quot;In order to enable claiming devices feature a system parameter security.claim.allowClaimingByDefault should be set to true, &quot; +
&nbsp;                    &quot;otherwise a server-side claimingAllowed attribute with the value true is obligatory for provisioned devices. \n&quot; +
&nbsp;                    &quot;See official documentation for more details regarding claiming.&quot; + CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/device/{deviceName}/claim&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; claimDevice(@Parameter(description = &quot;Unique name of the device which is going to be claimed&quot;)
&nbsp;                                                      @PathVariable(DEVICE_NAME) String deviceName,
&nbsp;                                                      @Parameter(description = &quot;Claiming request which can optionally contain secret key&quot;)
&nbsp;                                                      @RequestBody(required = false) ClaimRequest claimRequest) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_NAME, deviceName);</b>
<b class="nc">&nbsp;        final DeferredResult&lt;ResponseEntity&gt; deferredResult = new DeferredResult&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        TenantId tenantId = user.getTenantId();</b>
<b class="nc">&nbsp;        CustomerId customerId = user.getCustomerId();</b>
&nbsp;
<b class="nc">&nbsp;        Device device = checkNotNull(deviceService.findDeviceByTenantIdAndName(tenantId, deviceName));</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(user, Resource.DEVICE, Operation.CLAIM_DEVICES,</b>
<b class="nc">&nbsp;                device.getId(), device);</b>
<b class="nc">&nbsp;        String secretKey = getSecretKey(claimRequest);</b>
&nbsp;
<b class="nc">&nbsp;        ListenableFuture&lt;ClaimResult&gt; future = tbDeviceService.claimDevice(tenantId, device, customerId, secretKey, user);</b>
&nbsp;
<b class="nc">&nbsp;        Futures.addCallback(future, new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(@Nullable ClaimResult result) {
&nbsp;                HttpStatus status;
<b class="nc">&nbsp;                if (result != null) {</b>
<b class="nc">&nbsp;                    if (result.getResponse().equals(ClaimResponse.SUCCESS)) {</b>
<b class="nc">&nbsp;                        status = HttpStatus.OK;</b>
<b class="nc">&nbsp;                        deferredResult.setResult(new ResponseEntity&lt;&gt;(result, status));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        status = HttpStatus.BAD_REQUEST;</b>
<b class="nc">&nbsp;                        deferredResult.setResult(new ResponseEntity&lt;&gt;(result.getResponse(), status));</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    deferredResult.setResult(new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST));</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                deferredResult.setErrorResult(t);</b>
&nbsp;            }
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;        return deferredResult;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Reclaim device (reClaimDevice)&quot;,
&nbsp;            notes = &quot;Reclaiming means the device will be unassigned from the customer and the device will be available for claiming again.&quot;
&nbsp;                    + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/customer/device/{deviceName}/claim&quot;, method = RequestMethod.DELETE)
&nbsp;    @ResponseStatus(value = HttpStatus.OK)
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; reClaimDevice(@Parameter(description = &quot;Unique name of the device which is going to be reclaimed&quot;)
&nbsp;                                                        @PathVariable(DEVICE_NAME) String deviceName) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(DEVICE_NAME, deviceName);</b>
<b class="nc">&nbsp;        final DeferredResult&lt;ResponseEntity&gt; deferredResult = new DeferredResult&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        TenantId tenantId = user.getTenantId();</b>
&nbsp;
<b class="nc">&nbsp;        Device device = checkNotNull(deviceService.findDeviceByTenantIdAndName(tenantId, deviceName));</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(user, Resource.DEVICE, Operation.CLAIM_DEVICES,</b>
<b class="nc">&nbsp;                device.getId(), device);</b>
&nbsp;
<b class="nc">&nbsp;        ListenableFuture&lt;ReclaimResult&gt; result = tbDeviceService.reclaimDevice(tenantId, device, user);</b>
<b class="nc">&nbsp;        Futures.addCallback(result, new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(ReclaimResult reclaimResult) {
<b class="nc">&nbsp;                deferredResult.setResult(new ResponseEntity(HttpStatus.OK));</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                deferredResult.setErrorResult(t);</b>
&nbsp;            }
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;        return deferredResult;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getSecretKey(ClaimRequest claimRequest) {
<b class="nc">&nbsp;        String secretKey = claimRequest.getSecretKey();</b>
<b class="nc">&nbsp;        if (secretKey != null) {</b>
<b class="nc">&nbsp;            return secretKey;</b>
&nbsp;        }
<b class="nc">&nbsp;        return DataConstants.DEFAULT_SECRET_KEY;</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Assign device to tenant (assignDeviceToTenant)&quot;,
&nbsp;            notes = &quot;Creates assignment of the device to tenant. Thereafter tenant will be able to reassign the device to a customer.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/tenant/{tenantId}/device/{deviceId}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device assignDeviceToTenant(@Parameter(description = TENANT_ID_PARAM_DESCRIPTION)
&nbsp;                                       @PathVariable(TENANT_ID) String strTenantId,
&nbsp;                                       @Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                       @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(TENANT_ID, strTenantId);</b>
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceId, Operation.ASSIGN_TO_TENANT);</b>
&nbsp;
<b class="nc">&nbsp;        TenantId newTenantId = TenantId.fromUUID(toUUID(strTenantId));</b>
<b class="nc">&nbsp;        Tenant newTenant = tenantService.findTenantById(newTenantId);</b>
<b class="nc">&nbsp;        if (newTenant == null) {</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Could not find the specified Tenant!&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS);</b>
&nbsp;        }
<b class="nc">&nbsp;        return tbDeviceService.assignDeviceToTenant(device, newTenant, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Assign device to edge (assignDeviceToEdge)&quot;,
&nbsp;            notes = &quot;Creates assignment of an existing device to an instance of The Edge. &quot; +
&nbsp;                    EDGE_ASSIGN_ASYNC_FIRST_STEP_DESCRIPTION +
&nbsp;                    &quot;Second, remote edge service will receive a copy of assignment device &quot; +
&nbsp;                    EDGE_ASSIGN_RECEIVE_STEP_DESCRIPTION +
&nbsp;                    &quot;Third, once device will be delivered to edge service, it&#39;s going to be available for usage on remote edge instance.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/edge/{edgeId}/device/{deviceId}&quot;, method = RequestMethod.POST)
&nbsp;    @ResponseBody
&nbsp;    public Device assignDeviceToEdge(@Parameter(description = EDGE_ID_PARAM_DESCRIPTION)
&nbsp;                                     @PathVariable(EDGE_ID) String strEdgeId,
&nbsp;                                     @Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                     @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(EDGE_ID, strEdgeId);</b>
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        EdgeId edgeId = new EdgeId(toUUID(strEdgeId));</b>
<b class="nc">&nbsp;        Edge edge = checkEdgeId(edgeId, Operation.READ);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        checkDeviceId(deviceId, Operation.READ);</b>
&nbsp;
<b class="nc">&nbsp;        return tbDeviceService.assignDeviceToEdge(getTenantId(), deviceId, edge, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Unassign device from edge (unassignDeviceFromEdge)&quot;,
&nbsp;            notes = &quot;Clears assignment of the device to the edge. &quot; +
&nbsp;                    EDGE_UNASSIGN_ASYNC_FIRST_STEP_DESCRIPTION +
&nbsp;                    &quot;Second, remote edge service will receive an &#39;unassign&#39; command to remove device &quot; +
&nbsp;                    EDGE_UNASSIGN_RECEIVE_STEP_DESCRIPTION +
&nbsp;                    &quot;Third, once &#39;unassign&#39; command will be delivered to edge service, it&#39;s going to remove device locally.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/edge/{edgeId}/device/{deviceId}&quot;, method = RequestMethod.DELETE)
&nbsp;    @ResponseBody
&nbsp;    public Device unassignDeviceFromEdge(@Parameter(description = EDGE_ID_PARAM_DESCRIPTION)
&nbsp;                                         @PathVariable(EDGE_ID) String strEdgeId,
&nbsp;                                         @Parameter(description = DEVICE_ID_PARAM_DESCRIPTION)
&nbsp;                                         @PathVariable(DEVICE_ID) String strDeviceId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(EDGE_ID, strEdgeId);</b>
<b class="nc">&nbsp;        checkParameter(DEVICE_ID, strDeviceId);</b>
<b class="nc">&nbsp;        EdgeId edgeId = new EdgeId(toUUID(strEdgeId));</b>
<b class="nc">&nbsp;        Edge edge = checkEdgeId(edgeId, Operation.READ);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(toUUID(strDeviceId));</b>
<b class="nc">&nbsp;        Device device = checkDeviceId(deviceId, Operation.READ);</b>
<b class="nc">&nbsp;        return tbDeviceService.unassignDeviceFromEdge(device, edge, getCurrentUser());</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Get devices assigned to edge (getEdgeDevices)&quot;,
&nbsp;            notes = &quot;Returns a page of devices assigned to edge. &quot; +
&nbsp;                    PAGE_DATA_PARAMETERS + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/edge/{edgeId}/devices&quot;, params = {&quot;pageSize&quot;, &quot;page&quot;}, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public PageData&lt;DeviceInfo&gt; getEdgeDevices(
&nbsp;            @Parameter(description = EDGE_ID_PARAM_DESCRIPTION, required = true)
&nbsp;            @PathVariable(EDGE_ID) String strEdgeId,
&nbsp;            @Parameter(description = PAGE_SIZE_DESCRIPTION, required = true)
&nbsp;            @RequestParam int pageSize,
&nbsp;            @Parameter(description = PAGE_NUMBER_DESCRIPTION, required = true)
&nbsp;            @RequestParam int page,
&nbsp;            @Parameter(description = DEVICE_TYPE_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String type,
&nbsp;            @Parameter(description = DEVICE_PROFILE_ID_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String deviceProfileId,
&nbsp;            @Parameter(description = DEVICE_ACTIVE_PARAM_DESCRIPTION)
&nbsp;            @RequestParam(required = false) Boolean active,
&nbsp;            @Parameter(description = DEVICE_TEXT_SEARCH_DESCRIPTION)
&nbsp;            @RequestParam(required = false) String textSearch,
&nbsp;            @Parameter(description = SORT_PROPERTY_DESCRIPTION, schema = @Schema(allowableValues = {&quot;createdTime&quot;, &quot;name&quot;, &quot;deviceProfileName&quot;, &quot;label&quot;, &quot;customerTitle&quot;}))
&nbsp;            @RequestParam(required = false) String sortProperty,
&nbsp;            @Parameter(description = SORT_ORDER_DESCRIPTION, schema = @Schema(allowableValues = {&quot;ASC&quot;, &quot;DESC&quot;}))
&nbsp;            @RequestParam(required = false) String sortOrder,
&nbsp;            @Parameter(description = &quot;Timestamp. Devices with creation time before it won&#39;t be queried&quot;)
&nbsp;            @RequestParam(required = false) Long startTime,
&nbsp;            @Parameter(description = &quot;Timestamp. Devices with creation time after it won&#39;t be queried&quot;)
&nbsp;            @RequestParam(required = false) Long endTime) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(EDGE_ID, strEdgeId);</b>
<b class="nc">&nbsp;        TenantId tenantId = getCurrentUser().getTenantId();</b>
<b class="nc">&nbsp;        EdgeId edgeId = new EdgeId(toUUID(strEdgeId));</b>
<b class="nc">&nbsp;        checkEdgeId(edgeId, Operation.READ);</b>
<b class="nc">&nbsp;        TimePageLink pageLink = createTimePageLink(pageSize, page, textSearch, sortProperty, sortOrder, startTime, endTime);</b>
<b class="nc">&nbsp;        DeviceInfoFilter.DeviceInfoFilterBuilder filter = DeviceInfoFilter.builder();</b>
<b class="nc">&nbsp;        filter.tenantId(tenantId);</b>
<b class="nc">&nbsp;        filter.edgeId(edgeId);</b>
<b class="nc">&nbsp;        filter.active(active);</b>
<b class="nc">&nbsp;        if (type != null &amp;&amp; type.trim().length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.type(type);</b>
<b class="nc">&nbsp;        } else if (deviceProfileId != null &amp;&amp; deviceProfileId.length() &gt; 0) {</b>
<b class="nc">&nbsp;            filter.deviceProfileId(new DeviceProfileId(toUUID(deviceProfileId)));</b>
&nbsp;        }
<b class="nc">&nbsp;        return checkNotNull(deviceService.findDeviceInfosByFilter(filter.build(), pageLink));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Count devices by device profile  (countByDeviceProfileAndEmptyOtaPackage)&quot;,
&nbsp;            notes = &quot;The platform gives an ability to load OTA (over-the-air) packages to devices. &quot; +
&nbsp;                    &quot;It can be done in two different ways: device scope or device profile scope.&quot; +
&nbsp;                    &quot;In the response you will find the number of devices with specified device profile, but without previously defined device scope OTA package. &quot; +
&nbsp;                    &quot;It can be useful when you want to define number of devices that will be affected with future OTA package&quot; + TENANT_OR_CUSTOMER_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;, &#39;CUSTOMER_USER&#39;)&quot;)
&nbsp;    @RequestMapping(value = &quot;/devices/count/{otaPackageType}/{deviceProfileId}&quot;, method = RequestMethod.GET)
&nbsp;    @ResponseBody
&nbsp;    public Long countByDeviceProfileAndEmptyOtaPackage(
&nbsp;            @Parameter(description = &quot;OTA package type&quot;, schema = @Schema(allowableValues = {&quot;FIRMWARE&quot;, &quot;SOFTWARE&quot;}))
&nbsp;            @PathVariable(&quot;otaPackageType&quot;) String otaPackageType,
&nbsp;            @Parameter(description = &quot;Device Profile Id. I.g. &#39;784f394c-42b6-435a-983c-b7beff2784f9&#39;&quot;)
&nbsp;            @PathVariable(&quot;deviceProfileId&quot;) String deviceProfileId) throws ThingsboardException {
<b class="nc">&nbsp;        checkParameter(&quot;OtaPackageType&quot;, otaPackageType);</b>
<b class="nc">&nbsp;        checkParameter(&quot;DeviceProfileId&quot;, deviceProfileId);</b>
<b class="nc">&nbsp;        return deviceService.countDevicesByTenantIdAndDeviceProfileIdAndEmptyOtaPackage(</b>
<b class="nc">&nbsp;                getTenantId(),</b>
<b class="nc">&nbsp;                new DeviceProfileId(UUID.fromString(deviceProfileId)),</b>
<b class="nc">&nbsp;                OtaPackageType.valueOf(otaPackageType));</b>
&nbsp;    }
&nbsp;
&nbsp;    @ApiOperation(value = &quot;Import the bulk of devices (processDevicesBulkImport)&quot;,
&nbsp;            notes = &quot;There&#39;s an ability to import the bulk of devices using the only .csv file.&quot; + TENANT_AUTHORITY_PARAGRAPH)
&nbsp;    @PreAuthorize(&quot;hasAnyAuthority(&#39;TENANT_ADMIN&#39;)&quot;)
&nbsp;    @PostMapping(&quot;/device/bulk_import&quot;)
&nbsp;    public BulkImportResult&lt;Device&gt; processDevicesBulkImport(@RequestBody BulkImportRequest request) throws
&nbsp;            Exception {
<b class="nc">&nbsp;        SecurityUser user = getCurrentUser();</b>
<b class="nc">&nbsp;        return deviceBulkImportService.processBulkImport(request, user);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

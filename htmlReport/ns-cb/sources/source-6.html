<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SwaggerConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.config</a>
</div>

<h1>Coverage Summary for Class: SwaggerConfiguration (org.thingsboard.server.config)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SwaggerConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/246)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.config;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JavaType;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import io.swagger.v3.core.converter.AnnotatedType;
&nbsp;import io.swagger.v3.core.converter.ModelConverter;
&nbsp;import io.swagger.v3.core.converter.ModelConverters;
&nbsp;import io.swagger.v3.core.util.Json;
&nbsp;import io.swagger.v3.oas.models.Components;
&nbsp;import io.swagger.v3.oas.models.OpenAPI;
&nbsp;import io.swagger.v3.oas.models.Operation;
&nbsp;import io.swagger.v3.oas.models.PathItem;
&nbsp;import io.swagger.v3.oas.models.Paths;
&nbsp;import io.swagger.v3.oas.models.examples.Example;
&nbsp;import io.swagger.v3.oas.models.info.Contact;
&nbsp;import io.swagger.v3.oas.models.info.Info;
&nbsp;import io.swagger.v3.oas.models.info.License;
&nbsp;import io.swagger.v3.oas.models.media.Content;
&nbsp;import io.swagger.v3.oas.models.media.MediaType;
&nbsp;import io.swagger.v3.oas.models.media.Schema;
&nbsp;import io.swagger.v3.oas.models.parameters.RequestBody;
&nbsp;import io.swagger.v3.oas.models.responses.ApiResponse;
&nbsp;import io.swagger.v3.oas.models.responses.ApiResponses;
&nbsp;import io.swagger.v3.oas.models.security.SecurityRequirement;
&nbsp;import io.swagger.v3.oas.models.security.SecurityScheme;
&nbsp;import io.swagger.v3.oas.models.tags.Tag;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springdoc.core.customizers.OpenApiCustomizer;
&nbsp;import org.springdoc.core.customizers.OperationCustomizer;
&nbsp;import org.springdoc.core.customizers.RouterOperationCustomizer;
&nbsp;import org.springdoc.core.discoverer.SpringDocParameterNameDiscoverer;
&nbsp;import org.springdoc.core.models.GroupedOpenApi;
&nbsp;import org.springdoc.core.properties.SpringDocConfigProperties;
&nbsp;import org.springdoc.core.properties.SwaggerUiConfigProperties;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.context.annotation.Lazy;
&nbsp;import org.springframework.context.annotation.Primary;
&nbsp;import org.springframework.context.annotation.Profile;
&nbsp;import org.springframework.core.MethodParameter;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.web.bind.annotation.RequestParam;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.security.Authority;
&nbsp;import org.thingsboard.server.exception.ThingsboardCredentialsExpiredResponse;
&nbsp;import org.thingsboard.server.exception.ThingsboardErrorResponse;
&nbsp;import org.thingsboard.server.service.security.auth.rest.LoginRequest;
&nbsp;import org.thingsboard.server.service.security.auth.rest.LoginResponse;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.TreeMap;
&nbsp;
&nbsp;import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Configuration
&nbsp;@ConditionalOnExpression(&quot;(&#39;${service.type:null}&#39;==&#39;monolith&#39; || &#39;${service.type:null}&#39;==&#39;tb-core&#39;) &amp;&amp; &#39;${springdoc.api-docs.enabled:true}&#39;==&#39;true&#39;&quot;)
&nbsp;@Profile(&quot;!test&quot;)
<b class="nc">&nbsp;public class SwaggerConfiguration {</b>
&nbsp;
&nbsp;    public static final String LOGIN_ENDPOINT = &quot;/api/auth/login&quot;;
&nbsp;    public static final String REFRESH_TOKEN_ENDPOINT = &quot;/api/auth/token&quot;;
&nbsp;
&nbsp;    private static final String LOGIN_PASSWORD_SCHEME = &quot;HTTP login form&quot;;
&nbsp;    private static final String API_KEY_SCHEME = &quot;API key form&quot;;
&nbsp;
<b class="nc">&nbsp;    private static final ApiResponses loginResponses = loginResponses();</b>
<b class="nc">&nbsp;    private static final ApiResponses defaultErrorResponses = defaultErrorResponses(false);</b>
<b class="nc">&nbsp;    private static final ApiResponses defaultPostErrorResponses = defaultErrorResponses(true);</b>
&nbsp;
&nbsp;    @Value(&quot;${swagger.api_path:/api/**}&quot;)
&nbsp;    private String apiPath;
&nbsp;    @Value(&quot;${swagger.security_path_regex}&quot;)
&nbsp;    private String securityPathRegex;
&nbsp;    @Value(&quot;${swagger.non_security_path_regex}&quot;)
&nbsp;    private String nonSecurityPathRegex;
&nbsp;    @Value(&quot;${swagger.title}&quot;)
&nbsp;    private String title;
&nbsp;    @Value(&quot;${swagger.description}&quot;)
&nbsp;    private String description;
&nbsp;    @Value(&quot;${swagger.contact.name}&quot;)
&nbsp;    private String contactName;
&nbsp;    @Value(&quot;${swagger.contact.url}&quot;)
&nbsp;    private String contactUrl;
&nbsp;    @Value(&quot;${swagger.contact.email}&quot;)
&nbsp;    private String contactEmail;
&nbsp;    @Value(&quot;${swagger.license.title}&quot;)
&nbsp;    private String licenseTitle;
&nbsp;    @Value(&quot;${swagger.license.url}&quot;)
&nbsp;    private String licenseUrl;
&nbsp;    @Value(&quot;${swagger.version}&quot;)
&nbsp;    private String version;
&nbsp;    @Value(&quot;${app.version:unknown}&quot;)
&nbsp;    private String appVersion;
&nbsp;    @Value(&quot;${swagger.group_name:thingsboard}&quot;)
&nbsp;    private String groupName;
&nbsp;    @Value(&quot;${swagger.doc_expansion:list}&quot;)
&nbsp;    private String docExpansion;
&nbsp;
&nbsp;    @Bean
&nbsp;    public OpenAPI thingsboardApi() {
<b class="nc">&nbsp;        Contact contact = new Contact()</b>
<b class="nc">&nbsp;                .name(contactName)</b>
<b class="nc">&nbsp;                .url(contactUrl)</b>
<b class="nc">&nbsp;                .email(contactEmail);</b>
&nbsp;
<b class="nc">&nbsp;        License license = new License()</b>
<b class="nc">&nbsp;                .name(licenseTitle)</b>
<b class="nc">&nbsp;                .url(licenseUrl);</b>
&nbsp;
<b class="nc">&nbsp;        String apiVersion = version;</b>
<b class="nc">&nbsp;        if (StringUtils.isEmpty(apiVersion)) {</b>
<b class="nc">&nbsp;            apiVersion = appVersion;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Info info = new Info()</b>
<b class="nc">&nbsp;                .title(title)</b>
<b class="nc">&nbsp;                .description(description)</b>
<b class="nc">&nbsp;                .contact(contact)</b>
<b class="nc">&nbsp;                .license(license)</b>
<b class="nc">&nbsp;                .version(apiVersion);</b>
&nbsp;
<b class="nc">&nbsp;        SecurityScheme loginPasswordScheme = new SecurityScheme()</b>
<b class="nc">&nbsp;                .type(SecurityScheme.Type.HTTP)</b>
<b class="nc">&nbsp;                .description(&quot;Enter Username / Password&quot;)</b>
<b class="nc">&nbsp;                .scheme(&quot;loginPassword&quot;)</b>
<b class="nc">&nbsp;                .bearerFormat(&quot;/api/auth/login|X-Authorization&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        SecurityScheme apiKeyScheme = new SecurityScheme()</b>
<b class="nc">&nbsp;                .type(SecurityScheme.Type.APIKEY)</b>
<b class="nc">&nbsp;                .name(&quot;X-Authorization&quot;)</b>
<b class="nc">&nbsp;                .in(SecurityScheme.In.HEADER)</b>
<b class="nc">&nbsp;                .description(&quot;&quot;&quot;</b>
&nbsp;                        Enter the API key value with &#39;ApiKey&#39; prefix in format: **ApiKey &lt;your_api_key_value&gt;**
&nbsp;                        
&nbsp;                        Example: **ApiKey tb_5te51SkLRYpjGrujUGwqkjFvooWBlQpVe2An2Dr3w13wjfxDW**
&nbsp;                        
&nbsp;                        &lt;br&gt;**NOTE**: Use only ONE authentication method at a time. If both are authorized, JWT auth takes the priority.&lt;br&gt;
&nbsp;                        &quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        var openApi = new OpenAPI()</b>
<b class="nc">&nbsp;                .components(new Components()</b>
<b class="nc">&nbsp;                        .addSecuritySchemes(LOGIN_PASSWORD_SCHEME, loginPasswordScheme)</b>
<b class="nc">&nbsp;                        .addSecuritySchemes(API_KEY_SCHEME, apiKeyScheme))</b>
<b class="nc">&nbsp;                .info(info);</b>
<b class="nc">&nbsp;        addDefaultSchemas(openApi);</b>
<b class="nc">&nbsp;        addLoginOperation(openApi);</b>
<b class="nc">&nbsp;        addRefreshTokenOperation(openApi);</b>
<b class="nc">&nbsp;        return openApi;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Bean
&nbsp;    @Primary
&nbsp;    public SpringDocConfigProperties springDocConfig(SpringDocConfigProperties springDocProperties) {
<b class="nc">&nbsp;        springDocProperties.getApiDocs().setVersion(SpringDocConfigProperties.ApiDocs.OpenApiVersion.OPENAPI_3_1);</b>
<b class="nc">&nbsp;        springDocProperties.setRemoveBrokenReferenceDefinitions(false);</b>
<b class="nc">&nbsp;        return springDocProperties;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Bean
&nbsp;    @Primary
&nbsp;    public SwaggerUiConfigProperties swaggerUiConfig(SwaggerUiConfigProperties uiProperties) {
<b class="nc">&nbsp;        uiProperties.setDeepLinking(true);</b>
<b class="nc">&nbsp;        uiProperties.setDisplayOperationId(false);</b>
<b class="nc">&nbsp;        uiProperties.setDefaultModelsExpandDepth(1);</b>
<b class="nc">&nbsp;        uiProperties.setDefaultModelExpandDepth(1);</b>
<b class="nc">&nbsp;        uiProperties.setDefaultModelRendering(&quot;example&quot;);</b>
<b class="nc">&nbsp;        uiProperties.setDisplayRequestDuration(false);</b>
<b class="nc">&nbsp;        uiProperties.setDocExpansion(docExpansion);</b>
<b class="nc">&nbsp;        uiProperties.setFilter(&quot;false&quot;);</b>
<b class="nc">&nbsp;        uiProperties.setMaxDisplayedTags(null);</b>
<b class="nc">&nbsp;        uiProperties.setOperationsSorter(&quot;alpha&quot;);</b>
<b class="nc">&nbsp;        uiProperties.setTagsSorter(&quot;alpha&quot;);</b>
<b class="nc">&nbsp;        uiProperties.setShowExtensions(false);</b>
<b class="nc">&nbsp;        uiProperties.setShowCommonExtensions(false);</b>
<b class="nc">&nbsp;        uiProperties.setSupportedSubmitMethods(List.of(&quot;get&quot;, &quot;put&quot;, &quot;post&quot;, &quot;delete&quot;, &quot;options&quot;, &quot;head&quot;, &quot;patch&quot;, &quot;trace&quot;));</b>
<b class="nc">&nbsp;        uiProperties.setValidatorUrl(null);</b>
<b class="nc">&nbsp;        uiProperties.setPersistAuthorization(true);</b>
&nbsp;
<b class="nc">&nbsp;        var syntaxHighLight = new SwaggerUiConfigProperties.SyntaxHighlight();</b>
<b class="nc">&nbsp;        syntaxHighLight.setActivated(true);</b>
<b class="nc">&nbsp;        syntaxHighLight.setTheme(&quot;agate&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        uiProperties.setSyntaxHighlight(syntaxHighLight);</b>
<b class="nc">&nbsp;        return uiProperties;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addLoginOperation(OpenAPI openAPI) {
<b class="nc">&nbsp;        var operation = new Operation();</b>
<b class="nc">&nbsp;        operation.summary(&quot;Login method to get user JWT token data&quot;);</b>
<b class="nc">&nbsp;        operation.description(&quot;&quot;&quot;</b>
&nbsp;                Login method used to authenticate user and get JWT token data.
&nbsp;                
&nbsp;                Value of the response **token** field can be used as **X-Authorization** header value:
&nbsp;                
&nbsp;                `X-Authorization: Bearer $JWT_TOKEN_VALUE`.&quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        var requestBody = new RequestBody().description(&quot;Login request&quot;)</b>
<b class="nc">&nbsp;                .content(new Content().addMediaType(APPLICATION_JSON_VALUE,</b>
<b class="nc">&nbsp;                        new MediaType().schema(new Schema&lt;LoginRequest&gt;().$ref(&quot;#/components/schemas/LoginRequest&quot;))));</b>
<b class="nc">&nbsp;        operation.requestBody(requestBody);</b>
&nbsp;
<b class="nc">&nbsp;        operation.responses(loginResponses);</b>
&nbsp;
<b class="nc">&nbsp;        operation.addTagsItem(&quot;login-endpoint&quot;);</b>
<b class="nc">&nbsp;        var pathItem = new PathItem().post(operation);</b>
<b class="nc">&nbsp;        openAPI.path(LOGIN_ENDPOINT, pathItem);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addRefreshTokenOperation(OpenAPI openAPI) {
<b class="nc">&nbsp;        var operation = new Operation();</b>
<b class="nc">&nbsp;        operation.summary(&quot;Refresh user JWT token data&quot;);</b>
<b class="nc">&nbsp;        operation.description(&quot;&quot;&quot;</b>
&nbsp;                Method to refresh JWT token. Provide a valid refresh token to get a new JWT token.
&nbsp;                
&nbsp;                The response contains a new token that can be used for authorization.
&nbsp;                
&nbsp;                `X-Authorization: Bearer $JWT_TOKEN_VALUE`&quot;&quot;&quot;);
&nbsp;
<b class="nc">&nbsp;        var requestBody = new RequestBody().description(&quot;Refresh token request&quot;)</b>
<b class="nc">&nbsp;                .content(new Content().addMediaType(APPLICATION_JSON_VALUE,</b>
<b class="nc">&nbsp;                        new MediaType().schema(new Schema&lt;JsonNode&gt;().addProperty(&quot;refreshToken&quot;, new Schema&lt;&gt;().type(&quot;string&quot;)))));</b>
&nbsp;
<b class="nc">&nbsp;        operation.requestBody(requestBody);</b>
&nbsp;
<b class="nc">&nbsp;        operation.responses(loginResponses);</b>
&nbsp;
<b class="nc">&nbsp;        operation.addTagsItem(&quot;login-endpoint&quot;);</b>
<b class="nc">&nbsp;        var pathItem = new PathItem().post(operation);</b>
<b class="nc">&nbsp;        openAPI.path(REFRESH_TOKEN_ENDPOINT, pathItem);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Bean
&nbsp;    public GroupedOpenApi groupedApi(SpringDocParameterNameDiscoverer localSpringDocParameterNameDiscoverer) {
<b class="nc">&nbsp;        return GroupedOpenApi.builder()</b>
<b class="nc">&nbsp;                .group(groupName)</b>
<b class="nc">&nbsp;                .pathsToMatch(apiPath)</b>
<b class="nc">&nbsp;                .addRouterOperationCustomizer(routerOperationCustomizer(localSpringDocParameterNameDiscoverer))</b>
<b class="nc">&nbsp;                .addOperationCustomizer(operationCustomizer())</b>
<b class="nc">&nbsp;                .addOpenApiCustomizer(customOpenApiCustomizer())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Bean
&nbsp;    @Lazy(false)
&nbsp;    ModelConverter mapAwareConverter() {
<b class="nc">&nbsp;        return (type, context, chain) -&gt; {</b>
<b class="nc">&nbsp;            if (chain.hasNext()) {</b>
<b class="nc">&nbsp;                Schema schema = chain.next().resolve(type, context, chain);</b>
<b class="nc">&nbsp;                JavaType javaType = Json.mapper().constructType(type.getType());</b>
<b class="nc">&nbsp;                if (javaType != null) {</b>
<b class="nc">&nbsp;                    Class&lt;?&gt; cls = javaType.getRawClass();</b>
<b class="nc">&nbsp;                    if (Map.class.isAssignableFrom(cls)) {</b>
<b class="nc">&nbsp;                        if (schema != null &amp;&amp; schema.getProperties() != null) {</b>
<b class="nc">&nbsp;                            schema.getProperties().remove(&quot;empty&quot;);</b>
<b class="nc">&nbsp;                            if (schema.getProperties().isEmpty()) {</b>
<b class="nc">&nbsp;                                schema.setProperties(null);</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                return schema;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private void addDefaultSchemas(OpenAPI openAPI) {
<b class="nc">&nbsp;        var jsonNodeSchema = ModelConverters.getInstance().readAllAsResolvedSchema(new AnnotatedType().type(JsonNode.class)).schema;</b>
<b class="nc">&nbsp;        jsonNodeSchema.setType(&quot;any&quot;);</b>
&nbsp;        //noinspection unchecked
<b class="nc">&nbsp;        jsonNodeSchema.setExamples(List.of(JacksonUtil.newObjectNode()));</b>
<b class="nc">&nbsp;        jsonNodeSchema.setDescription(&quot;A value representing the any type (object or primitive)&quot;);</b>
<b class="nc">&nbsp;        openAPI.getComponents()</b>
<b class="nc">&nbsp;                .addSchemas(&quot;JsonNode&quot;, jsonNodeSchema)</b>
<b class="nc">&nbsp;                .addSchemas(&quot;LoginRequest&quot;, ModelConverters.getInstance().readAllAsResolvedSchema(new AnnotatedType().type(LoginRequest.class)).schema)</b>
<b class="nc">&nbsp;                .addSchemas(&quot;LoginResponse&quot;, ModelConverters.getInstance().readAllAsResolvedSchema(new AnnotatedType().type(LoginResponse.class)).schema)</b>
<b class="nc">&nbsp;                .addSchemas(&quot;ThingsboardErrorResponse&quot;, ModelConverters.getInstance().readAllAsResolvedSchema(new AnnotatedType().type(ThingsboardErrorResponse.class)).schema)</b>
<b class="nc">&nbsp;                .addSchemas(&quot;ThingsboardCredentialsExpiredResponse&quot;, ModelConverters.getInstance().readAllAsResolvedSchema(new AnnotatedType().type(ThingsboardCredentialsExpiredResponse.class)).schema);</b>
&nbsp;    }
&nbsp;
&nbsp;    private RouterOperationCustomizer routerOperationCustomizer(SpringDocParameterNameDiscoverer localSpringDocParameterNameDiscoverer) {
<b class="nc">&nbsp;        return (routerOperation, handlerMethod) -&gt; {</b>
<b class="nc">&nbsp;            String[] pNames = localSpringDocParameterNameDiscoverer.getParameterNames(handlerMethod.getMethod());</b>
<b class="nc">&nbsp;            String[] reflectionParametersNames = Arrays.stream(handlerMethod.getMethod().getParameters()).map(java.lang.reflect.Parameter::getName).toArray(String[]::new);</b>
<b class="nc">&nbsp;            if (pNames == null || Arrays.stream(pNames).anyMatch(Objects::isNull)) {</b>
<b class="nc">&nbsp;                pNames = reflectionParametersNames;</b>
&nbsp;            }
<b class="nc">&nbsp;            MethodParameter[] parameters = handlerMethod.getMethodParameters();</b>
<b class="nc">&nbsp;            List&lt;String&gt; requestParams = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (var i = 0; i &lt; parameters.length; i++) {</b>
<b class="nc">&nbsp;                var methodParameter = parameters[i];</b>
<b class="nc">&nbsp;                RequestParam requestParam = methodParameter.getParameterAnnotation(RequestParam.class);</b>
<b class="nc">&nbsp;                if (requestParam != null) {</b>
<b class="nc">&nbsp;                    String pName = StringUtils.isNotBlank(requestParam.value()) ? requestParam.value() :</b>
<b class="nc">&nbsp;                            pNames[i];</b>
<b class="nc">&nbsp;                    if (StringUtils.isNotBlank(pName)) {</b>
<b class="nc">&nbsp;                        requestParams.add(pName);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (!requestParams.isEmpty()) {</b>
<b class="nc">&nbsp;                var path = routerOperation.getPath() + &quot;{?&quot; + String.join(&quot;,&quot;, requestParams) + &quot;}&quot;;</b>
<b class="nc">&nbsp;                routerOperation.setPath(path);</b>
&nbsp;            }
<b class="nc">&nbsp;            return routerOperation;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private OperationCustomizer operationCustomizer() {
<b class="nc">&nbsp;        return (operation, handlerMethod) -&gt; {</b>
<b class="nc">&nbsp;            if (StringUtils.isBlank(operation.getSummary())) {</b>
<b class="nc">&nbsp;                operation.setSummary(operation.getOperationId());</b>
&nbsp;            }
<b class="nc">&nbsp;            return operation;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private OpenApiCustomizer customOpenApiCustomizer() {
<b class="nc">&nbsp;        var loginRequirement = createSecurityRequirement(LOGIN_PASSWORD_SCHEME);</b>
<b class="nc">&nbsp;        var apiKeyRequirement = createSecurityRequirement(API_KEY_SCHEME);</b>
&nbsp;
<b class="nc">&nbsp;        return openAPI -&gt; {</b>
<b class="nc">&nbsp;            var paths = openAPI.getPaths();</b>
<b class="nc">&nbsp;            paths.entrySet().stream()</b>
<b class="nc">&nbsp;                    .peek(entry -&gt; {</b>
<b class="nc">&nbsp;                        securityCustomization(entry, loginRequirement, apiKeyRequirement);</b>
<b class="nc">&nbsp;                        if (!entry.getKey().equals(LOGIN_ENDPOINT)) {</b>
<b class="nc">&nbsp;                            defaultErrorResponsesCustomization(entry.getValue());</b>
&nbsp;                        }
&nbsp;                    })
<b class="nc">&nbsp;                    .map(this::extractTagFromPath).filter(Objects::nonNull).distinct().sorted(Comparator.comparing(Tag::getName)).forEach(openAPI::addTagsItem);</b>
&nbsp;
<b class="nc">&nbsp;            var pathItemsByTags = new TreeMap&lt;String, Map&lt;String, PathItem&gt;&gt;();</b>
<b class="nc">&nbsp;            paths.forEach((k, v) -&gt; {</b>
<b class="nc">&nbsp;                var tagItem = tagItemFromPathItem(v);</b>
<b class="nc">&nbsp;                if (tagItem != null) {</b>
<b class="nc">&nbsp;                    pathItemsByTags.computeIfAbsent(tagItem, k1 -&gt; new TreeMap&lt;&gt;()).put(k, v);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;            var sortedPaths = new Paths();</b>
<b class="nc">&nbsp;            pathItemsByTags.forEach((tagItem, pathItemMap) -&gt; {</b>
<b class="nc">&nbsp;                pathItemMap.forEach(sortedPaths::addPathItem);</b>
&nbsp;            });
<b class="nc">&nbsp;            sortedPaths.setExtensions(paths.getExtensions());</b>
<b class="nc">&nbsp;            openAPI.setPaths(sortedPaths);</b>
<b class="nc">&nbsp;            var sortedSchemas = new TreeMap&lt;&gt;(openAPI.getComponents().getSchemas());</b>
<b class="nc">&nbsp;            openAPI.getComponents().setSchemas(new LinkedHashMap&lt;&gt;(sortedSchemas));</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private SecurityRequirement createSecurityRequirement(String schemeName) {
<b class="nc">&nbsp;        return new SecurityRequirement().addList(schemeName, Arrays.asList(</b>
<b class="nc">&nbsp;                Authority.SYS_ADMIN.name(),</b>
<b class="nc">&nbsp;                Authority.TENANT_ADMIN.name(),</b>
<b class="nc">&nbsp;                Authority.CUSTOMER_USER.name()</b>
&nbsp;        ));
&nbsp;    }
&nbsp;
&nbsp;    private Tag extractTagFromPath(Map.Entry&lt;String, PathItem&gt; entry) {
<b class="nc">&nbsp;        var tagName = tagItemFromPathItem(entry.getValue());</b>
<b class="nc">&nbsp;        return tagName != null ? tagFromTagItem(tagName) : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String tagItemFromPathItem(PathItem item) {
<b class="nc">&nbsp;        var operations = item.readOperationsMap().values();</b>
<b class="nc">&nbsp;        var operation = operations.stream().findAny();</b>
<b class="nc">&nbsp;        if (operation.isPresent()) {</b>
<b class="nc">&nbsp;            var tags = operation.get().getTags();</b>
<b class="nc">&nbsp;            if (tags != null &amp;&amp; !tags.isEmpty()) {</b>
<b class="nc">&nbsp;                return tags.get(0);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Tag tagFromTagItem(String tagItem) {
<b class="nc">&nbsp;        String[] words = tagItem.split(&quot;-&quot;);</b>
<b class="nc">&nbsp;        StringBuilder sb = new StringBuilder();</b>
&nbsp;
<b class="nc">&nbsp;        for (String word : words) {</b>
<b class="nc">&nbsp;            if (!word.isEmpty()) {</b>
<b class="nc">&nbsp;                sb.append(word.substring(0, 1).toUpperCase());</b>
<b class="nc">&nbsp;                sb.append(word.substring(1).toLowerCase());</b>
<b class="nc">&nbsp;                sb.append(&quot; &quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return new Tag().name(tagItem).description(sb.toString().trim());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void defaultErrorResponsesCustomization(PathItem pathItem) {
<b class="nc">&nbsp;        pathItem.readOperationsMap().forEach((httpMethod, operation) -&gt; {</b>
<b class="nc">&nbsp;            var errorResponses = httpMethod.equals(PathItem.HttpMethod.POST) ? defaultPostErrorResponses : defaultErrorResponses;</b>
&nbsp;
<b class="nc">&nbsp;            var responses = operation.getResponses();</b>
<b class="nc">&nbsp;            if (responses == null) {</b>
<b class="nc">&nbsp;                responses = errorResponses;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ApiResponses updated = responses;</b>
<b class="nc">&nbsp;                errorResponses.forEach((key, apiResponse) -&gt; {</b>
<b class="nc">&nbsp;                    if (!updated.containsKey(key)) {</b>
<b class="nc">&nbsp;                        updated.put(key, apiResponse);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;            }
<b class="nc">&nbsp;            operation.setResponses(responses);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private void securityCustomization(Map.Entry&lt;String, PathItem&gt; entry, SecurityRequirement jwtBearerRequirement, SecurityRequirement apiKeyRequirement) {
<b class="nc">&nbsp;        var path = entry.getKey();</b>
<b class="nc">&nbsp;        if (path.matches(securityPathRegex) &amp;&amp; !path.matches(nonSecurityPathRegex) &amp;&amp; !path.equals(LOGIN_ENDPOINT) &amp;&amp; !path.equals(REFRESH_TOKEN_ENDPOINT)) {</b>
<b class="nc">&nbsp;            entry.getValue()</b>
<b class="nc">&nbsp;                    .readOperationsMap()</b>
<b class="nc">&nbsp;                    .values()</b>
<b class="nc">&nbsp;                    .forEach(operation -&gt; {</b>
<b class="nc">&nbsp;                        operation.addSecurityItem(jwtBearerRequirement);</b>
<b class="nc">&nbsp;                        operation.addSecurityItem(apiKeyRequirement);</b>
&nbsp;                    });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponses loginResponses() {
<b class="nc">&nbsp;        ApiResponses apiResponses = new ApiResponses();</b>
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;200&quot;, new ApiResponse().description(&quot;OK&quot;)</b>
<b class="nc">&nbsp;                .content(new Content().addMediaType(APPLICATION_JSON_VALUE,</b>
<b class="nc">&nbsp;                        new MediaType().schema(new Schema&lt;LoginResponse&gt;().$ref(&quot;#/components/schemas/LoginResponse&quot;)))));</b>
<b class="nc">&nbsp;        apiResponses.putAll(loginErrorResponses());</b>
<b class="nc">&nbsp;        return apiResponses;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponses defaultErrorResponses(boolean isPost) {
<b class="nc">&nbsp;        ApiResponses apiResponses = new ApiResponses();</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;400&quot;, errorResponse(&quot;400&quot;, &quot;Bad Request&quot;,</b>
<b class="nc">&nbsp;                ThingsboardErrorResponse.of(isPost ? &quot;Invalid request body&quot; : &quot;Invalid UUID string: 123&quot;, ThingsboardErrorCode.BAD_REQUEST_PARAMS, HttpStatus.BAD_REQUEST)));</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;401&quot;, errorResponse(&quot;401&quot;, &quot;Unauthorized&quot;,</b>
<b class="nc">&nbsp;                ThingsboardErrorResponse.of(&quot;Authentication failed&quot;, ThingsboardErrorCode.AUTHENTICATION, HttpStatus.UNAUTHORIZED)));</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;403&quot;, errorResponse(&quot;403&quot;, &quot;Forbidden&quot;,</b>
<b class="nc">&nbsp;                ThingsboardErrorResponse.of(&quot;You don&#39;t have permission to perform this operation!&quot;, ThingsboardErrorCode.PERMISSION_DENIED, HttpStatus.FORBIDDEN)));</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;404&quot;, errorResponse(&quot;404&quot;, &quot;Not Found&quot;,</b>
<b class="nc">&nbsp;                ThingsboardErrorResponse.of(&quot;Requested item wasn&#39;t found!&quot;, ThingsboardErrorCode.ITEM_NOT_FOUND, HttpStatus.NOT_FOUND)));</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;429&quot;, errorResponse(&quot;429&quot;, &quot;Too Many Requests&quot;,</b>
<b class="nc">&nbsp;                ThingsboardErrorResponse.of(&quot;Too many requests for current tenant!&quot;, ThingsboardErrorCode.TOO_MANY_REQUESTS, HttpStatus.TOO_MANY_REQUESTS)));</b>
&nbsp;
<b class="nc">&nbsp;        return apiResponses;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponses loginErrorResponses() {
<b class="nc">&nbsp;        ApiResponses apiResponses = new ApiResponses();</b>
&nbsp;
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;401&quot;, errorResponse(&quot;Unauthorized&quot;,</b>
<b class="nc">&nbsp;                Map.of(</b>
<b class="nc">&nbsp;                        &quot;bad-credentials&quot;, errorExample(&quot;Bad credentials&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardErrorResponse.of(&quot;Invalid username or password&quot;, ThingsboardErrorCode.AUTHENTICATION, HttpStatus.UNAUTHORIZED)),</b>
<b class="nc">&nbsp;                        &quot;token-expired&quot;, errorExample(&quot;JWT token expired&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardErrorResponse.of(&quot;Token has expired&quot;, ThingsboardErrorCode.JWT_TOKEN_EXPIRED, HttpStatus.UNAUTHORIZED)),</b>
<b class="nc">&nbsp;                        &quot;account-disabled&quot;, errorExample(&quot;Disabled account&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardErrorResponse.of(&quot;User account is not active&quot;, ThingsboardErrorCode.AUTHENTICATION, HttpStatus.UNAUTHORIZED)),</b>
<b class="nc">&nbsp;                        &quot;account-locked&quot;, errorExample(&quot;Locked account&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardErrorResponse.of(&quot;User account is locked due to security policy&quot;, ThingsboardErrorCode.AUTHENTICATION, HttpStatus.UNAUTHORIZED)),</b>
<b class="nc">&nbsp;                        &quot;authentication-failed&quot;, errorExample(&quot;General authentication error&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardErrorResponse.of(&quot;Authentication failed&quot;, ThingsboardErrorCode.AUTHENTICATION, HttpStatus.UNAUTHORIZED))</b>
&nbsp;                )
&nbsp;        ));
<b class="nc">&nbsp;        var credentialsExpiredSchema = new Schema&lt;ThingsboardCredentialsExpiredResponse&gt;().$ref(&quot;#/components/schemas/ThingsboardCredentialsExpiredResponse&quot;);</b>
<b class="nc">&nbsp;        apiResponses.addApiResponse(&quot;401 &quot;, errorResponse(&quot;Unauthorized (**Expired credentials**)&quot;,</b>
<b class="nc">&nbsp;                Map.of(</b>
<b class="nc">&nbsp;                        &quot;credentials-expired&quot;, errorExample(&quot;Expired credentials&quot;,</b>
<b class="nc">&nbsp;                                ThingsboardCredentialsExpiredResponse.of(&quot;User password expired!&quot;, StringUtils.randomAlphanumeric(30)))</b>
&nbsp;                ),
&nbsp;                credentialsExpiredSchema
&nbsp;        ));
<b class="nc">&nbsp;        return apiResponses;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponse errorResponse(String code, String description, ThingsboardErrorResponse example) {
<b class="nc">&nbsp;        return errorResponse(description, Map.of(&quot;error-code-&quot; + code, errorExample(description, example)));</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponse errorResponse(String description, Map&lt;String, Example&gt; examples) {
<b class="nc">&nbsp;        var schema = new Schema&lt;ThingsboardErrorResponse&gt;().$ref(&quot;#/components/schemas/ThingsboardErrorResponse&quot;);</b>
<b class="nc">&nbsp;        return errorResponse(description, examples, schema);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ApiResponse errorResponse(String description, Map&lt;String, Example&gt; examples, Schema&lt;? extends ThingsboardErrorResponse&gt; errorResponseSchema) {
<b class="nc">&nbsp;        MediaType mediaType = new MediaType().schema(errorResponseSchema).examples(examples);</b>
<b class="nc">&nbsp;        Content content = new Content().addMediaType(org.springframework.http.MediaType.APPLICATION_JSON_VALUE, mediaType);</b>
<b class="nc">&nbsp;        return new ApiResponse().description(description).content(content);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Example errorExample(String summary, ThingsboardErrorResponse example) {
<b class="nc">&nbsp;        return new Example()</b>
<b class="nc">&nbsp;                .summary(summary)</b>
<b class="nc">&nbsp;                .value(example);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

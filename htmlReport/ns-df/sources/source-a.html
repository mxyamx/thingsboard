<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeviceServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.device</a>
</div>

<h1>Coverage Summary for Class: DeviceServiceImpl (org.thingsboard.server.dao.device)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeviceServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/107)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/303)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DeviceServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DeviceServiceImpl$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DeviceServiceImpl$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/65)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/107)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/311)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.device;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.cache.device.DeviceCacheEvictEvent;
&nbsp;import org.thingsboard.server.cache.device.DeviceCacheKey;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceIdInfo;
&nbsp;import org.thingsboard.server.common.data.DeviceInfo;
&nbsp;import org.thingsboard.server.common.data.DeviceInfoFilter;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileType;
&nbsp;import org.thingsboard.server.common.data.DeviceTransportType;
&nbsp;import org.thingsboard.server.common.data.EntitySubtype;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.NameConflictPolicy;
&nbsp;import org.thingsboard.server.common.data.NameConflictStrategy;
&nbsp;import org.thingsboard.server.common.data.ProfileEntityIdInfo;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.device.DeviceSearchQuery;
&nbsp;import org.thingsboard.server.common.data.device.credentials.BasicMqttCredentials;
&nbsp;import org.thingsboard.server.common.data.device.data.CoapDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.DefaultDeviceConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.DefaultDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.DeviceData;
&nbsp;import org.thingsboard.server.common.data.device.data.Lwm2mDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.MqttDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.SnmpDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.ota.OtaPackageType;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.EntitySearchDirection;
&nbsp;import org.thingsboard.server.common.data.relation.RelationTypeGroup;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentialsType;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionFailedException;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionRequest;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;
&nbsp;import org.thingsboard.server.dao.entity.CachedVersionedEntityService;
&nbsp;import org.thingsboard.server.dao.entity.EntityCountService;
&nbsp;import org.thingsboard.server.dao.event.EventService;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.exception.IncorrectParameterException;
&nbsp;import org.thingsboard.server.dao.service.PaginatedRemover;
&nbsp;import org.thingsboard.server.dao.service.validator.DeviceDataValidator;
&nbsp;import org.thingsboard.server.dao.sql.JpaExecutorService;
&nbsp;import org.thingsboard.server.dao.tenant.TenantService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.thingsboard.server.dao.DaoUtil.toUUIDs;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateIds;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validatePageLink;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateString;
&nbsp;
&nbsp;@Service(&quot;DeviceDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class DeviceServiceImpl extends CachedVersionedEntityService&lt;DeviceCacheKey, Device, DeviceCacheEvictEvent&gt; implements DeviceService {
&nbsp;
&nbsp;    public static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;    public static final String INCORRECT_DEVICE_PROFILE_ID = &quot;Incorrect deviceProfileId &quot;;
&nbsp;    public static final String INCORRECT_CUSTOMER_ID = &quot;Incorrect customerId &quot;;
&nbsp;    public static final String INCORRECT_DEVICE_ID = &quot;Incorrect deviceId &quot;;
&nbsp;    public static final String INCORRECT_EDGE_ID = &quot;Incorrect edgeId &quot;;
&nbsp;
&nbsp;    private final DeviceDao deviceDao;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final DeviceProfileService deviceProfileService;
&nbsp;    private final EventService eventService;
&nbsp;    private final TenantService tenantService;
&nbsp;    private final DeviceDataValidator deviceValidator;
&nbsp;    private final EntityCountService countService;
&nbsp;    private final JpaExecutorService executor;
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceInfo findDeviceInfoById(TenantId tenantId, DeviceId deviceId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceInfoById [{}]&quot;, deviceId);</b>
<b class="nc">&nbsp;        validateId(deviceId, id -&gt; INCORRECT_DEVICE_ID + id);</b>
<b class="nc">&nbsp;        return deviceDao.findDeviceInfoById(tenantId, deviceId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device findDeviceById(TenantId tenantId, DeviceId deviceId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceById [{}]&quot;, deviceId);</b>
<b class="nc">&nbsp;        validateId(deviceId, id -&gt; INCORRECT_DEVICE_ID + id);</b>
<b class="nc">&nbsp;        return findDeviceByIdInternal(tenantId, deviceId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Device&gt; findDeviceByIdAsync(TenantId tenantId, DeviceId deviceId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceByIdAsync [{}]&quot;, deviceId);</b>
<b class="nc">&nbsp;        validateId(deviceId, id -&gt; INCORRECT_DEVICE_ID + id);</b>
<b class="nc">&nbsp;        return executor.submit(() -&gt; findDeviceByIdInternal(tenantId, deviceId));</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device findDeviceByIdInternal(TenantId tenantId, DeviceId deviceId) {
<b class="nc">&nbsp;        if (TenantId.SYS_TENANT_ID.equals(tenantId)) {</b>
<b class="nc">&nbsp;            return cache.get(new DeviceCacheKey(deviceId), () -&gt; deviceDao.findById(tenantId, deviceId.getId()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return cache.get(new DeviceCacheKey(tenantId, deviceId), () -&gt; deviceDao.findDeviceByTenantIdAndId(tenantId, deviceId.getId()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device findDeviceByTenantIdAndName(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceByTenantIdAndName [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(new DeviceCacheKey(tenantId, name),</b>
<b class="nc">&nbsp;                () -&gt; deviceDao.findDeviceByTenantIdAndName(tenantId.getId(), name).orElse(null), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Device&gt; findDeviceByTenantIdAndNameAsync(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceByTenantIdAndNameAsync [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return executor.submit(() -&gt; findDeviceByTenantIdAndName(tenantId, name));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithAccessToken(Device device, String accessToken) {
<b class="nc">&nbsp;        return doSaveDevice(device, accessToken, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithAccessToken(Device device, String accessToken, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        return doSaveDevice(device, accessToken, true, nameConflictStrategy);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device saveDevice(Device device, boolean doValidate) {
<b class="nc">&nbsp;        return doSaveDevice(device, null, doValidate);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device saveDevice(Device device) {
<b class="nc">&nbsp;        return doSaveDevice(device, null, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithCredentials(Device device, DeviceCredentials deviceCredentials) {
<b class="nc">&nbsp;        return saveDeviceWithCredentials(device, deviceCredentials, NameConflictStrategy.DEFAULT);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithCredentials(Device device, DeviceCredentials deviceCredentials, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        return saveEntity(device, () -&gt; doSaveWithCredentials(device, deviceCredentials, nameConflictStrategy));</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device doSaveWithCredentials(Device device, DeviceCredentials deviceCredentials, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        Device savedDevice = doSaveDeviceWithoutCredentials(device, true, nameConflictStrategy);</b>
<b class="nc">&nbsp;        deviceCredentials.setDeviceId(savedDevice.getId());</b>
<b class="nc">&nbsp;        if (device.getId() == null) {</b>
<b class="nc">&nbsp;            deviceCredentialsService.createDeviceCredentials(savedDevice.getTenantId(), deviceCredentials);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            DeviceCredentials foundDeviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), savedDevice.getId());</b>
<b class="nc">&nbsp;            if (foundDeviceCredentials == null) {</b>
<b class="nc">&nbsp;                deviceCredentialsService.createDeviceCredentials(savedDevice.getTenantId(), deviceCredentials);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                deviceCredentials.setId(foundDeviceCredentials.getId());</b>
<b class="nc">&nbsp;                deviceCredentialsService.updateDeviceCredentials(device.getTenantId(), deviceCredentials);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return savedDevice;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device doSaveDevice(Device device, String accessToken, boolean doValidate) {
<b class="nc">&nbsp;        return doSaveDevice(device, accessToken, doValidate, NameConflictStrategy.DEFAULT);</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device doSaveDevice(Device device, String accessToken, boolean doValidate, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        return saveEntity(device, () -&gt; saveWithoutCredentials(device, accessToken, doValidate, nameConflictStrategy));</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device saveWithoutCredentials(Device device, String accessToken, boolean doValidate, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        Device savedDevice = doSaveDeviceWithoutCredentials(device, doValidate, nameConflictStrategy);</b>
<b class="nc">&nbsp;        if (device.getId() == null) {</b>
<b class="nc">&nbsp;            DeviceCredentials deviceCredentials = new DeviceCredentials();</b>
<b class="nc">&nbsp;            deviceCredentials.setDeviceId(new DeviceId(savedDevice.getUuidId()));</b>
<b class="nc">&nbsp;            deviceCredentials.setCredentialsType(DeviceCredentialsType.ACCESS_TOKEN);</b>
<b class="nc">&nbsp;            deviceCredentials.setCredentialsId(!StringUtils.isEmpty(accessToken) ? accessToken : StringUtils.randomAlphanumeric(20));</b>
<b class="nc">&nbsp;            deviceCredentialsService.createDeviceCredentials(savedDevice.getTenantId(), deviceCredentials);</b>
&nbsp;        }
<b class="nc">&nbsp;        return savedDevice;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device doSaveDeviceWithoutCredentials(Device device, boolean doValidate, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        log.trace(&quot;Executing saveDevice [{}]&quot;, device);</b>
<b class="nc">&nbsp;        Device oldDevice = (device.getId() != null) ? deviceDao.findById(device.getTenantId(), device.getId().getId()) : null;</b>
<b class="nc">&nbsp;        if (nameConflictStrategy.policy() == NameConflictPolicy.UNIQUIFY &amp;&amp; (oldDevice == null || !oldDevice.getName().equals(device.getName()))) {</b>
<b class="nc">&nbsp;            uniquifyEntityName(device, oldDevice, device::setName, EntityType.DEVICE, nameConflictStrategy);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (doValidate) {</b>
<b class="nc">&nbsp;            deviceValidator.validate(device, Device::getTenantId);</b>
&nbsp;        }
<b class="nc">&nbsp;        DeviceCacheEvictEvent deviceCacheEvictEvent = new DeviceCacheEvictEvent(device.getTenantId(), device.getId(), device.getName(), oldDevice != null ? oldDevice.getName() : null);</b>
&nbsp;        try {
&nbsp;            DeviceProfile deviceProfile;
<b class="nc">&nbsp;            if (device.getDeviceProfileId() == null) {</b>
<b class="nc">&nbsp;                if (!StringUtils.isEmpty(device.getType())) {</b>
<b class="nc">&nbsp;                    deviceProfile = this.deviceProfileService.findOrCreateDeviceProfile(device.getTenantId(), device.getType());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    deviceProfile = this.deviceProfileService.findDefaultDeviceProfile(device.getTenantId());</b>
&nbsp;                }
<b class="nc">&nbsp;                device.setDeviceProfileId(new DeviceProfileId(deviceProfile.getId().getId()));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                deviceProfile = this.deviceProfileService.findDeviceProfileById(device.getTenantId(), device.getDeviceProfileId(), false);</b>
<b class="nc">&nbsp;                if (deviceProfile == null) {</b>
<b class="nc">&nbsp;                    throw new DataValidationException(&quot;Device is referencing non existing device profile!&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!deviceProfile.getTenantId().equals(device.getTenantId())) {</b>
<b class="nc">&nbsp;                    throw new DataValidationException(&quot;Device can`t be referencing to device profile from different tenant!&quot;);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            device.setType(deviceProfile.getName());</b>
<b class="nc">&nbsp;            device.setDeviceData(syncDeviceData(deviceProfile, device.getDeviceData()));</b>
<b class="nc">&nbsp;            Device savedDevice = deviceDao.saveAndFlush(device.getTenantId(), device);</b>
<b class="nc">&nbsp;            deviceCacheEvictEvent.setSavedDevice(savedDevice);</b>
<b class="nc">&nbsp;            publishEvictEvent(deviceCacheEvictEvent);</b>
<b class="nc">&nbsp;            if (device.getId() == null) {</b>
<b class="nc">&nbsp;                countService.publishCountEntityEvictEvent(savedDevice.getTenantId(), EntityType.DEVICE);</b>
&nbsp;            }
<b class="nc">&nbsp;            eventPublisher.publishEvent(SaveEntityEvent.builder().tenantId(savedDevice.getTenantId()).entityId(savedDevice.getId())</b>
<b class="nc">&nbsp;                    .entity(savedDevice).oldEntity(oldDevice).created(device.getId() == null).build());</b>
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception t) {
<b class="nc">&nbsp;            handleEvictEvent(deviceCacheEvictEvent);</b>
<b class="nc">&nbsp;            checkConstraintViolation(t,</b>
&nbsp;                    &quot;device_name_unq_key&quot;, &quot;Device with such name already exists!&quot;,
&nbsp;                    &quot;device_external_id_unq_key&quot;, &quot;Device with such external id already exists!&quot;);
&nbsp;            throw t;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @TransactionalEventListener
&nbsp;    public void handleEvictEvent(DeviceCacheEvictEvent event) {
<b class="nc">&nbsp;        List&lt;DeviceCacheKey&gt; toEvict = new ArrayList&lt;&gt;(3);</b>
<b class="nc">&nbsp;        toEvict.add(new DeviceCacheKey(event.getTenantId(), event.getNewName()));</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.getOldName()) &amp;&amp; !event.getOldName().equals(event.getNewName())) {</b>
<b class="nc">&nbsp;            toEvict.add(new DeviceCacheKey(event.getTenantId(), event.getOldName()));</b>
&nbsp;        }
<b class="nc">&nbsp;        Device savedDevice = event.getSavedDevice();</b>
<b class="nc">&nbsp;        if (savedDevice != null) {</b>
<b class="nc">&nbsp;            cache.put(new DeviceCacheKey(event.getDeviceId()), savedDevice);</b>
<b class="nc">&nbsp;            cache.put(new DeviceCacheKey(event.getTenantId(), event.getDeviceId()), savedDevice);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            toEvict.add(new DeviceCacheKey(event.getDeviceId()));</b>
<b class="nc">&nbsp;            toEvict.add(new DeviceCacheKey(event.getTenantId(), event.getDeviceId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        cache.evict(toEvict);</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceData syncDeviceData(DeviceProfile deviceProfile, DeviceData deviceData) {
<b class="nc">&nbsp;        if (deviceData == null) {</b>
<b class="nc">&nbsp;            deviceData = new DeviceData();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (deviceData.getConfiguration() == null || !deviceProfile.getType().equals(deviceData.getConfiguration().getType())) {</b>
<b class="nc">&nbsp;            if (deviceProfile.getType() == DeviceProfileType.DEFAULT) {</b>
<b class="nc">&nbsp;                deviceData.setConfiguration(new DefaultDeviceConfiguration());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (deviceData.getTransportConfiguration() == null || !deviceProfile.getTransportType().equals(deviceData.getTransportConfiguration().getType())) {</b>
<b class="nc">&nbsp;            switch (deviceProfile.getTransportType()) {</b>
&nbsp;                case DEFAULT:
<b class="nc">&nbsp;                    deviceData.setTransportConfiguration(new DefaultDeviceTransportConfiguration());</b>
&nbsp;                    break;
&nbsp;                case MQTT:
<b class="nc">&nbsp;                    deviceData.setTransportConfiguration(new MqttDeviceTransportConfiguration());</b>
&nbsp;                    break;
&nbsp;                case COAP:
<b class="nc">&nbsp;                    deviceData.setTransportConfiguration(new CoapDeviceTransportConfiguration());</b>
&nbsp;                    break;
&nbsp;                case LWM2M:
<b class="nc">&nbsp;                    deviceData.setTransportConfiguration(new Lwm2mDeviceTransportConfiguration());</b>
&nbsp;                    break;
&nbsp;                case SNMP:
<b class="nc">&nbsp;                    deviceData.setTransportConfiguration(new SnmpDeviceTransportConfiguration());</b>
&nbsp;                    break;
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return deviceData;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device assignDeviceToCustomer(TenantId tenantId, DeviceId deviceId, CustomerId customerId) {
<b class="nc">&nbsp;        Device device = findDeviceById(tenantId, deviceId);</b>
<b class="nc">&nbsp;        if (customerId.equals(device.getCustomerId())) {</b>
<b class="nc">&nbsp;            return device;</b>
&nbsp;        }
<b class="nc">&nbsp;        device.setCustomerId(customerId);</b>
<b class="nc">&nbsp;        return saveDevice(device);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device unassignDeviceFromCustomer(TenantId tenantId, DeviceId deviceId) {
<b class="nc">&nbsp;        Device device = findDeviceById(tenantId, deviceId);</b>
<b class="nc">&nbsp;        if (device.getCustomerId() == null) {</b>
<b class="nc">&nbsp;            return device;</b>
&nbsp;        }
<b class="nc">&nbsp;        device.setCustomerId(null);</b>
<b class="nc">&nbsp;        return saveDevice(device);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public void deleteDevice(final TenantId tenantId, final DeviceId deviceId) {
<b class="nc">&nbsp;        validateId(deviceId, id -&gt; INCORRECT_DEVICE_ID + id);</b>
<b class="nc">&nbsp;        deleteEntity(tenantId, deviceId, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEntity(TenantId tenantId, EntityId id, boolean force) {
<b class="nc">&nbsp;        if (!force &amp;&amp; (entityViewService.existsByTenantIdAndEntityId(tenantId, id) || calculatedFieldService.referencedInAnyCalculatedField(tenantId, id))) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t delete device that has entity views or is referenced in calculated fields!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Device device = deviceDao.findById(tenantId, id.getId());</b>
<b class="nc">&nbsp;        if (device == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        deleteDevice(tenantId, device);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void deleteDevice(TenantId tenantId, Device device) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteDevice [{}]&quot;, device.getId());</b>
<b class="nc">&nbsp;        deviceCredentialsService.deleteDeviceCredentialsByDeviceId(tenantId, device.getId());</b>
<b class="nc">&nbsp;        deviceDao.removeById(tenantId, device.getUuidId());</b>
&nbsp;
<b class="nc">&nbsp;        DeviceCacheEvictEvent deviceCacheEvictEvent = new DeviceCacheEvictEvent(device.getTenantId(), device.getId(), device.getName(), null);</b>
<b class="nc">&nbsp;        publishEvictEvent(deviceCacheEvictEvent);</b>
<b class="nc">&nbsp;        countService.publishCountEntityEvictEvent(tenantId, EntityType.DEVICE);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(DeleteEntityEvent.builder().tenantId(tenantId).entityId(device.getId()).entity(device).build());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;DeviceInfo&gt; findDeviceInfosByFilter(DeviceInfoFilter filter, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceInfosByFilter, filter [{}], pageLink [{}]&quot;, filter, pageLink);</b>
<b class="nc">&nbsp;        if (filter == null) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;Filter is empty!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        validateId(filter.getTenantId(), id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDeviceInfosByFilter(filter, pageLink);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;DeviceIdInfo&gt; findDeviceIdInfos(PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findTenantDeviceIdPairs, pageLink [{}]&quot;, pageLink);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDeviceIdInfos(pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;ProfileEntityIdInfo&gt; findProfileEntityIdInfos(PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findProfileEntityIdInfos, pageLink [{}]&quot;, pageLink);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findProfileEntityIdInfos(pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;ProfileEntityIdInfo&gt; findProfileEntityIdInfosByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findProfileEntityIdInfosByTenantId, tenantId[{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findProfileEntityIdInfosByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndType(TenantId tenantId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndType, tenantId [{}], type [{}], pageLink [{}]&quot;, tenantId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndType(tenantId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;DeviceId&gt; findDeviceIdsByTenantIdAndDeviceProfileId(TenantId tenantId, DeviceProfileId deviceProfileId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceIdsByTenantIdAndType, tenantId [{}], deviceProfileId [{}], pageLink [{}]&quot;, tenantId, deviceProfileId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDeviceIdsByTenantIdAndDeviceProfileId(tenantId.getId(), deviceProfileId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndTypeAndEmptyOtaPackage(TenantId tenantId,
&nbsp;                                                                           DeviceProfileId deviceProfileId,
&nbsp;                                                                           OtaPackageType type,
&nbsp;                                                                           PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndTypeAndEmptyOtaPackage, tenantId [{}], deviceProfileId [{}], type [{}], pageLink [{}]&quot;,</b>
&nbsp;                tenantId, deviceProfileId, type, pageLink);
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndTypeAndEmptyOtaPackage(tenantId.getId(), deviceProfileId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countDevicesByTenantIdAndDeviceProfileIdAndEmptyOtaPackage(TenantId tenantId, DeviceProfileId deviceProfileId, OtaPackageType type) {
<b class="nc">&nbsp;        log.trace(&quot;Executing countDevicesByTenantIdAndDeviceProfileIdAndEmptyOtaPackage, tenantId [{}], deviceProfileId [{}], type [{}]&quot;, tenantId, deviceProfileId, type);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        return deviceDao.countDevicesByTenantIdAndDeviceProfileIdAndEmptyOtaPackage(tenantId.getId(), deviceProfileId.getId(), type);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Device&gt;&gt; findDevicesByTenantIdAndIdsAsync(TenantId tenantId, List&lt;DeviceId&gt; deviceIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndIdsAsync, tenantId [{}], deviceIds [{}]&quot;, tenantId, deviceIds);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateIds(deviceIds, ids -&gt; &quot;Incorrect deviceIds &quot; + ids);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndIdsAsync(tenantId.getId(), toUUIDs(deviceIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Device&gt; findDevicesByIds(List&lt;DeviceId&gt; deviceIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByIdsAsync, deviceIds [{}]&quot;, deviceIds);</b>
<b class="nc">&nbsp;        validateIds(deviceIds, ids -&gt; &quot;Incorrect deviceIds &quot; + ids);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByIds(toUUIDs(deviceIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Device&gt;&gt; findDevicesByIdsAsync(List&lt;DeviceId&gt; deviceIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByIdsAsync, deviceIds [{}]&quot;, deviceIds);</b>
<b class="nc">&nbsp;        validateIds(deviceIds, ids -&gt; &quot;Incorrect deviceIds &quot; + ids);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByIdsAsync(toUUIDs(deviceIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public void deleteDevicesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteDevicesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        tenantDevicesRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public void deleteByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        deleteDevicesByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndCustomerId(TenantId tenantId, CustomerId customerId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndCustomerId, tenantId [{}], customerId [{}], pageLink [{}]&quot;, tenantId, customerId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndCustomerId(tenantId.getId(), customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndCustomerIdAndType(TenantId tenantId, CustomerId customerId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndCustomerIdAndType, tenantId [{}], customerId [{}], type [{}], pageLink [{}]&quot;, tenantId, customerId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndCustomerIdAndType(tenantId.getId(), customerId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Device&gt;&gt; findDevicesByTenantIdCustomerIdAndIdsAsync(TenantId tenantId, CustomerId customerId, List&lt;DeviceId&gt; deviceIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdCustomerIdAndIdsAsync, tenantId [{}], customerId [{}], deviceIds [{}]&quot;, tenantId, customerId, deviceIds);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validateIds(deviceIds, ids -&gt; &quot;Incorrect deviceIds &quot; + ids);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdCustomerIdAndIdsAsync(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), toUUIDs(deviceIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unassignCustomerDevices(TenantId tenantId, CustomerId customerId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing unassignCustomerDevices, tenantId [{}], customerId [{}]&quot;, tenantId, customerId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        customerDevicesRemover.removeEntities(tenantId, customerId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Device&gt;&gt; findDevicesByQuery(TenantId tenantId, DeviceSearchQuery query) {
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntityRelation&gt;&gt; relations = relationService.findByQuery(tenantId, query.toEntitySearchQuery());</b>
<b class="nc">&nbsp;        return Futures.transform(relations, r -&gt; {</b>
<b class="nc">&nbsp;            EntitySearchDirection direction = query.toEntitySearchQuery().getParameters().getDirection();</b>
<b class="nc">&nbsp;            List&lt;Device&gt; devices = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EntityRelation relation : r) {</b>
<b class="nc">&nbsp;                EntityId entityId = direction == EntitySearchDirection.FROM ? relation.getTo() : relation.getFrom();</b>
<b class="nc">&nbsp;                if (entityId.getEntityType() == EntityType.DEVICE) {</b>
<b class="nc">&nbsp;                    Device device = findDeviceById(tenantId, new DeviceId(entityId.getId()));</b>
<b class="nc">&nbsp;                    if (query.getDeviceTypes().contains(device.getType())) {</b>
<b class="nc">&nbsp;                        devices.add(device);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return devices;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; findDeviceTypesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceTypesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return deviceDao.findTenantDeviceTypesAsync(tenantId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public Device assignDeviceToTenant(TenantId tenantId, Device device) {
<b class="nc">&nbsp;        log.trace(&quot;Executing assignDeviceToTenant [{}][{}]&quot;, tenantId, device);</b>
<b class="nc">&nbsp;        TenantId oldTenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        Tenant oldTenant = tenantService.findTenantById(oldTenantId);</b>
<b class="nc">&nbsp;        List&lt;EntityView&gt; entityViews = entityViewService.findEntityViewsByTenantIdAndEntityId(oldTenantId, device.getId());</b>
<b class="nc">&nbsp;        if (!CollectionUtils.isEmpty(entityViews)) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign device that has entity views to another tenant!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        eventService.removeEvents(oldTenantId, device.getId());</b>
&nbsp;
<b class="nc">&nbsp;        relationService.removeRelations(oldTenantId, device.getId());</b>
&nbsp;
<b class="nc">&nbsp;        device.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        device.setCustomerId(null);</b>
<b class="nc">&nbsp;        device.setDeviceProfileId(null);</b>
<b class="nc">&nbsp;        Device savedDevice = doSaveDevice(device, null, true);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceCacheEvictEvent oldTenantEvent = new DeviceCacheEvictEvent(oldTenantId, device.getId(), device.getName(), null);</b>
<b class="nc">&nbsp;        DeviceCacheEvictEvent newTenantEvent = new DeviceCacheEvictEvent(savedDevice.getTenantId(), device.getId(), device.getName(), null);</b>
&nbsp;
&nbsp;        // explicitly remove device with previous tenant id from cache
&nbsp;        // result device object will have different tenant id and will not remove entity from cache
<b class="nc">&nbsp;        publishEvictEvent(oldTenantEvent);</b>
<b class="nc">&nbsp;        publishEvictEvent(newTenantEvent);</b>
&nbsp;
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).entity(savedDevice)</b>
<b class="nc">&nbsp;                .entityId(savedDevice.getId()).body(JacksonUtil.toString(oldTenant)).actionType(ActionType.ASSIGNED_TO_TENANT).build());</b>
&nbsp;
<b class="nc">&nbsp;        return savedDevice;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public Device saveDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {
<b class="nc">&nbsp;        Device device = new Device();</b>
<b class="nc">&nbsp;        device.setName(provisionRequest.getDeviceName());</b>
<b class="nc">&nbsp;        device.setType(profile.getName());</b>
<b class="nc">&nbsp;        device.setTenantId(profile.getTenantId());</b>
<b class="nc">&nbsp;        if (provisionRequest.getGateway() != null &amp;&amp; provisionRequest.getGateway()) {</b>
<b class="nc">&nbsp;            ObjectNode additionalInfoNode = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;            additionalInfoNode.put(DataConstants.GATEWAY_PARAMETER, true);</b>
<b class="nc">&nbsp;            device.setAdditionalInfo(additionalInfoNode);</b>
&nbsp;        }
<b class="nc">&nbsp;        Device savedDevice = saveDevice(device);</b>
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(provisionRequest.getCredentialsData().getToken()) ||</b>
<b class="nc">&nbsp;                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getX509CertHash()) ||</b>
<b class="nc">&nbsp;                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getUsername()) ||</b>
<b class="nc">&nbsp;                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getPassword()) ||</b>
<b class="nc">&nbsp;                !StringUtils.isEmpty(provisionRequest.getCredentialsData().getClientId())) {</b>
<b class="nc">&nbsp;            DeviceCredentials deviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(savedDevice.getTenantId(), savedDevice.getId());</b>
<b class="nc">&nbsp;            if (deviceCredentials == null) {</b>
<b class="nc">&nbsp;                deviceCredentials = new DeviceCredentials();</b>
&nbsp;            }
<b class="nc">&nbsp;            deviceCredentials.setDeviceId(savedDevice.getId());</b>
<b class="nc">&nbsp;            deviceCredentials.setCredentialsType(provisionRequest.getCredentialsType());</b>
<b class="nc">&nbsp;            switch (provisionRequest.getCredentialsType()) {</b>
&nbsp;                case ACCESS_TOKEN:
<b class="nc">&nbsp;                    deviceCredentials.setCredentialsId(provisionRequest.getCredentialsData().getToken());</b>
&nbsp;                    break;
&nbsp;                case MQTT_BASIC:
<b class="nc">&nbsp;                    BasicMqttCredentials mqttCredentials = new BasicMqttCredentials();</b>
<b class="nc">&nbsp;                    mqttCredentials.setClientId(provisionRequest.getCredentialsData().getClientId());</b>
<b class="nc">&nbsp;                    mqttCredentials.setUserName(provisionRequest.getCredentialsData().getUsername());</b>
<b class="nc">&nbsp;                    mqttCredentials.setPassword(provisionRequest.getCredentialsData().getPassword());</b>
<b class="nc">&nbsp;                    deviceCredentials.setCredentialsValue(JacksonUtil.toString(mqttCredentials));</b>
&nbsp;                    break;
&nbsp;                case X509_CERTIFICATE:
<b class="nc">&nbsp;                    deviceCredentials.setCredentialsValue(provisionRequest.getCredentialsData().getX509CertHash());</b>
&nbsp;                    break;
&nbsp;                case LWM2M_CREDENTIALS:
&nbsp;                    break;
&nbsp;            }
&nbsp;            try {
<b class="nc">&nbsp;                deviceCredentialsService.updateDeviceCredentials(savedDevice.getTenantId(), deviceCredentials);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        publishEvictEvent(new DeviceCacheEvictEvent(savedDevice.getTenantId(), savedDevice.getId(), provisionRequest.getDeviceName(), null));</b>
<b class="nc">&nbsp;        countService.publishCountEntityEvictEvent(savedDevice.getTenantId(), EntityType.DEVICE);</b>
<b class="nc">&nbsp;        return savedDevice;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;UUID&gt; findDevicesIdsByDeviceProfileTransportType(DeviceTransportType transportType, PageLink pageLink) {
<b class="nc">&nbsp;        return deviceDao.findDevicesIdsByDeviceProfileTransportType(transportType, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device assignDeviceToEdge(TenantId tenantId, DeviceId deviceId, EdgeId edgeId) {
<b class="nc">&nbsp;        Device device = findDeviceById(tenantId, deviceId);</b>
<b class="nc">&nbsp;        Edge edge = edgeService.findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        if (edge == null) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign device to non-existent edge!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!edge.getTenantId().getId().equals(device.getTenantId().getId())) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign device to edge from different tenant!&quot;);</b>
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            createRelation(tenantId, new EntityRelation(edgeId, deviceId, EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to create device relation. Edge Id: [{}]&quot;, deviceId, edgeId);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).edgeId(edgeId).entityId(deviceId)</b>
<b class="nc">&nbsp;                .actionType(ActionType.ASSIGNED_TO_EDGE).build());</b>
<b class="nc">&nbsp;        return device;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device unassignDeviceFromEdge(TenantId tenantId, DeviceId deviceId, EdgeId edgeId) {
<b class="nc">&nbsp;        Device device = findDeviceById(tenantId, deviceId);</b>
<b class="nc">&nbsp;        Edge edge = edgeService.findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        if (edge == null) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t unassign device from non-existent edge!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        checkAssignedEntityViewsToEdge(tenantId, deviceId, edgeId);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            deleteRelation(tenantId, new EntityRelation(edgeId, deviceId, EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to delete device relation. Edge Id: [{}]&quot;, deviceId, edgeId);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).edgeId(edgeId).entityId(deviceId)</b>
<b class="nc">&nbsp;                .actionType(ActionType.UNASSIGNED_FROM_EDGE).build());</b>
<b class="nc">&nbsp;        return device;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndEdgeId(TenantId tenantId, EdgeId edgeId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndEdgeId, tenantId [{}], edgeId [{}], pageLink [{}]&quot;, tenantId, edgeId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndEdgeId(tenantId.getId(), edgeId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Device&gt; findDevicesByTenantIdAndEdgeIdAndType(TenantId tenantId, EdgeId edgeId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicesByTenantIdAndEdgeIdAndType, tenantId [{}], edgeId [{}], type [{}] pageLink [{}]&quot;, tenantId, edgeId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceDao.findDevicesByTenantIdAndEdgeIdAndType(tenantId.getId(), edgeId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        return deviceDao.countByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;TenantId, Device&gt; tenantDevicesRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        protected PageData&lt;Device&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;            return deviceDao.findDevicesByTenantId(id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, Device device) {
<b class="nc">&nbsp;            deleteDevice(tenantId, device);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;CustomerId, Device&gt; customerDevicesRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        protected PageData&lt;Device&gt; findEntities(TenantId tenantId, CustomerId id, PageLink pageLink) {
<b class="nc">&nbsp;            return deviceDao.findDevicesByTenantIdAndCustomerId(tenantId.getId(), id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, Device entity) {
<b class="nc">&nbsp;            unassignDeviceFromCustomer(tenantId, new DeviceId(entity.getUuidId()));</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HasId&lt;?&gt;&gt; findEntity(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return Optional.ofNullable(findDeviceById(tenantId, new DeviceId(entityId.getId())));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public FluentFuture&lt;Optional&lt;HasId&lt;?&gt;&gt;&gt; findEntityAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return FluentFuture.from(findDeviceByIdAsync(tenantId, new DeviceId(entityId.getId())))</b>
<b class="nc">&nbsp;                .transform(Optional::ofNullable, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return EntityType.DEVICE;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

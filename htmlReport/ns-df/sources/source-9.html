<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeviceProfileServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.device</a>
</div>

<h1>Coverage Summary for Class: DeviceProfileServiceImpl (org.thingsboard.server.dao.device)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeviceProfileServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/181)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DeviceProfileServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/184)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.device;
&nbsp;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileInfo;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileProvisionType;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileType;
&nbsp;import org.thingsboard.server.common.data.DeviceTransportType;
&nbsp;import org.thingsboard.server.common.data.EntityInfo;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.device.profile.DefaultDeviceProfileConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.DefaultDeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.DeviceProfileData;
&nbsp;import org.thingsboard.server.common.data.device.profile.DisabledDeviceProfileProvisionConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.X509CertificateChainProvisionConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.msg.EncryptionUtil;
&nbsp;import org.thingsboard.server.dao.entity.CachedVersionedEntityService;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.dao.resource.ImageService;
&nbsp;import org.thingsboard.server.dao.service.PaginatedRemover;
&nbsp;import org.thingsboard.server.dao.service.Validator;
&nbsp;import org.thingsboard.server.dao.service.validator.DeviceProfileDataValidator;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.security.cert.Certificate;
&nbsp;import java.security.cert.CertificateException;
&nbsp;import java.security.cert.CertificateFactory;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.thingsboard.server.dao.DaoUtil.toUUIDs;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateString;
&nbsp;
&nbsp;@Service(&quot;DeviceProfileDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class DeviceProfileServiceImpl extends CachedVersionedEntityService&lt;DeviceProfileCacheKey, DeviceProfile, DeviceProfileEvictEvent&gt; implements DeviceProfileService {
&nbsp;
&nbsp;    private static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;    private static final String INCORRECT_DEVICE_PROFILE_ID = &quot;Incorrect deviceProfileId &quot;;
&nbsp;    private static final String INCORRECT_DEVICE_PROFILE_NAME = &quot;Incorrect deviceProfileName &quot;;
&nbsp;    private static final String INCORRECT_PROVISION_DEVICE_KEY = &quot;Incorrect provisionDeviceKey &quot;;
&nbsp;    private static final String DEVICE_PROFILE_WITH_SUCH_NAME_ALREADY_EXISTS = &quot;Device profile with such name already exists!&quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DeviceProfileDao deviceProfileDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DeviceDao deviceDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DeviceService deviceService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DeviceProfileDataValidator deviceProfileValidator;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ImageService imageService;
&nbsp;
&nbsp;    @TransactionalEventListener(classes = DeviceProfileEvictEvent.class)
&nbsp;    @Override
&nbsp;    public void handleEvictEvent(DeviceProfileEvictEvent event) {
<b class="nc">&nbsp;        List&lt;DeviceProfileCacheKey&gt; toEvict = new ArrayList&lt;&gt;(2);</b>
<b class="nc">&nbsp;        toEvict.add(DeviceProfileCacheKey.forName(event.getTenantId(), event.getNewName()));</b>
<b class="nc">&nbsp;        if (event.getSavedDeviceProfile() != null) {</b>
<b class="nc">&nbsp;            cache.put(DeviceProfileCacheKey.forId(event.getSavedDeviceProfile().getId()), event.getSavedDeviceProfile());</b>
<b class="nc">&nbsp;        } else if (event.getDeviceProfileId() != null) {</b>
<b class="nc">&nbsp;            toEvict.add(DeviceProfileCacheKey.forId(event.getDeviceProfileId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (event.isDefaultProfile()) {</b>
<b class="nc">&nbsp;            toEvict.add(DeviceProfileCacheKey.forDefaultProfile(event.getTenantId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.getOldName()) &amp;&amp; !event.getOldName().equals(event.getNewName())) {</b>
<b class="nc">&nbsp;            toEvict.add(DeviceProfileCacheKey.forName(event.getTenantId(), event.getOldName()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.getProvisionDeviceKey())) {</b>
<b class="nc">&nbsp;            toEvict.add(DeviceProfileCacheKey.forProvisionKey(event.getProvisionDeviceKey()));</b>
&nbsp;        }
<b class="nc">&nbsp;        cache.evict(toEvict);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDeviceProfileById(TenantId tenantId, DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        return findDeviceProfileById(tenantId, deviceProfileId, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDeviceProfileById(TenantId tenantId, DeviceProfileId deviceProfileId, boolean putInCache) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileById [{}]&quot;, deviceProfileId);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        return cache.get(DeviceProfileCacheKey.forId(deviceProfileId),</b>
<b class="nc">&nbsp;                () -&gt; deviceProfileDao.findById(tenantId, deviceProfileId.getId()), putInCache);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDeviceProfileByName(TenantId tenantId, String profileName) {
<b class="nc">&nbsp;        return findDeviceProfileByName(tenantId, profileName, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDeviceProfileByName(TenantId tenantId, String profileName, boolean putInCache) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileByName [{}][{}]&quot;, tenantId, profileName);</b>
<b class="nc">&nbsp;        validateString(profileName, pn -&gt; INCORRECT_DEVICE_PROFILE_NAME + pn);</b>
<b class="nc">&nbsp;        return cache.getOrFetchFromDB(DeviceProfileCacheKey.forName(tenantId, profileName),</b>
<b class="nc">&nbsp;                () -&gt; deviceProfileDao.findByName(tenantId, profileName), true, putInCache);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDeviceProfileByProvisionDeviceKey(String provisionDeviceKey) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileByProvisionDeviceKey provisionKey [{}]&quot;, provisionDeviceKey);</b>
<b class="nc">&nbsp;        validateString(provisionDeviceKey, dk -&gt; INCORRECT_PROVISION_DEVICE_KEY + dk);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(DeviceProfileCacheKey.forProvisionKey(provisionDeviceKey),</b>
<b class="nc">&nbsp;                () -&gt; deviceProfileDao.findByProvisionDeviceKey(provisionDeviceKey), false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfileInfo findDeviceProfileInfoById(TenantId tenantId, DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileById [{}]&quot;, deviceProfileId);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        return toDeviceProfileInfo(findDeviceProfileById(tenantId, deviceProfileId));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile saveDeviceProfile(DeviceProfile deviceProfile) {
<b class="nc">&nbsp;        return saveDeviceProfile(deviceProfile, true, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile saveDeviceProfile(DeviceProfile deviceProfile, boolean doValidate, boolean publishSaveEvent) {
<b class="nc">&nbsp;        log.trace(&quot;Executing saveDeviceProfile [{}]&quot;, deviceProfile);</b>
<b class="nc">&nbsp;        if (deviceProfile.getProfileData() != null &amp;&amp; deviceProfile.getProfileData().getProvisionConfiguration() instanceof X509CertificateChainProvisionConfiguration) {</b>
<b class="nc">&nbsp;            X509CertificateChainProvisionConfiguration x509Configuration = (X509CertificateChainProvisionConfiguration) deviceProfile.getProfileData().getProvisionConfiguration();</b>
<b class="nc">&nbsp;            if (x509Configuration.getProvisionDeviceSecret() != null) {</b>
<b class="nc">&nbsp;                formatDeviceProfileCertificate(deviceProfile, x509Configuration);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        DeviceProfile oldDeviceProfile = null;</b>
<b class="nc">&nbsp;        if (doValidate) {</b>
<b class="nc">&nbsp;            oldDeviceProfile = deviceProfileValidator.validate(deviceProfile, DeviceProfile::getTenantId);</b>
<b class="nc">&nbsp;        } else if (deviceProfile.getId() != null) {</b>
<b class="nc">&nbsp;            oldDeviceProfile = findDeviceProfileById(deviceProfile.getTenantId(), deviceProfile.getId(), false);</b>
&nbsp;        }
&nbsp;        DeviceProfile savedDeviceProfile;
&nbsp;        try {
<b class="nc">&nbsp;            imageService.replaceBase64WithImageUrl(deviceProfile, &quot;device profile&quot;);</b>
<b class="nc">&nbsp;            savedDeviceProfile = deviceProfileDao.saveAndFlush(deviceProfile.getTenantId(), deviceProfile);</b>
&nbsp;
<b class="nc">&nbsp;            publishEvictEvent(new DeviceProfileEvictEvent(savedDeviceProfile.getTenantId(), savedDeviceProfile.getName(),</b>
<b class="nc">&nbsp;                    oldDeviceProfile != null ? oldDeviceProfile.getName() : null, savedDeviceProfile.getId(), savedDeviceProfile.isDefault(),</b>
<b class="nc">&nbsp;                    oldDeviceProfile != null ? oldDeviceProfile.getProvisionDeviceKey() : null, savedDeviceProfile));</b>
<b class="nc">&nbsp;            eventPublisher.publishEvent(SaveEntityEvent.builder().tenantId(savedDeviceProfile.getTenantId()).entityId(savedDeviceProfile.getId())</b>
<b class="nc">&nbsp;                    .entity(savedDeviceProfile).oldEntity(oldDeviceProfile).created(oldDeviceProfile == null).broadcastEvent(publishSaveEvent).build());</b>
&nbsp;        } catch (Exception t) {
<b class="nc">&nbsp;            handleEvictEvent(new DeviceProfileEvictEvent(deviceProfile.getTenantId(), deviceProfile.getName(),</b>
<b class="nc">&nbsp;                    oldDeviceProfile != null ? oldDeviceProfile.getName() : null, null, deviceProfile.isDefault(),</b>
<b class="nc">&nbsp;                    oldDeviceProfile != null ? oldDeviceProfile.getProvisionDeviceKey() : null));</b>
<b class="nc">&nbsp;            String unqProvisionKeyErrorMsg = DeviceProfileProvisionType.X509_CERTIFICATE_CHAIN.equals(deviceProfile.getProvisionType())</b>
<b class="nc">&nbsp;                    ? &quot;Device profile with such certificate already exists!&quot;</b>
<b class="nc">&nbsp;                    : &quot;Device profile with such provision device key already exists!&quot;;</b>
<b class="nc">&nbsp;            checkConstraintViolation(t,</b>
<b class="nc">&nbsp;                    Map.of(&quot;device_profile_name_unq_key&quot;, DEVICE_PROFILE_WITH_SUCH_NAME_ALREADY_EXISTS,</b>
&nbsp;                            &quot;device_provision_key_unq_key&quot;, unqProvisionKeyErrorMsg,
&nbsp;                            &quot;device_profile_external_id_unq_key&quot;, &quot;Device profile with such external id already exists!&quot;));
&nbsp;            throw t;
&nbsp;        }
<b class="nc">&nbsp;        if (oldDeviceProfile != null &amp;&amp; !oldDeviceProfile.getName().equals(deviceProfile.getName())) {</b>
<b class="nc">&nbsp;            PageLink pageLink = new PageLink(100);</b>
&nbsp;            PageData&lt;Device&gt; pageData;
&nbsp;            do {
<b class="nc">&nbsp;                pageData = deviceDao.findDevicesByTenantIdAndProfileId(deviceProfile.getTenantId().getId(), deviceProfile.getUuidId(), pageLink);</b>
<b class="nc">&nbsp;                for (Device device : pageData.getData()) {</b>
<b class="nc">&nbsp;                    device.setType(deviceProfile.getName());</b>
<b class="nc">&nbsp;                    deviceService.saveDevice(device);</b>
&nbsp;                }
<b class="nc">&nbsp;                pageLink = pageLink.nextPageLink();</b>
<b class="nc">&nbsp;            } while (pageData.hasNext());</b>
&nbsp;        }
<b class="nc">&nbsp;        return savedDeviceProfile;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteDeviceProfile(TenantId tenantId, DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteDeviceProfile [{}]&quot;, deviceProfileId);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        deleteEntity(tenantId, deviceProfileId, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEntity(TenantId tenantId, EntityId id, boolean force) {
<b class="nc">&nbsp;        DeviceProfile deviceProfile = deviceProfileDao.findById(tenantId, id.getId());</b>
<b class="nc">&nbsp;        if (deviceProfile == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (!force &amp;&amp; deviceProfile.isDefault()) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Deletion of Default Device Profile is prohibited!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        removeDeviceProfile(tenantId, deviceProfile);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void removeDeviceProfile(TenantId tenantId, DeviceProfile deviceProfile) {
<b class="nc">&nbsp;        DeviceProfileId deviceProfileId = deviceProfile.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            deviceProfileDao.removeById(tenantId, deviceProfileId.getId());</b>
<b class="nc">&nbsp;            publishEvictEvent(new DeviceProfileEvictEvent(deviceProfile.getTenantId(), deviceProfile.getName(),</b>
<b class="nc">&nbsp;                    null, deviceProfile.getId(), deviceProfile.isDefault(),</b>
<b class="nc">&nbsp;                    deviceProfile.getProvisionDeviceKey()));</b>
<b class="nc">&nbsp;            eventPublisher.publishEvent(DeleteEntityEvent.builder().tenantId(tenantId).entityId(deviceProfileId).entity(deviceProfile).build());</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            checkConstraintViolation(e, &quot;fk_device_profile&quot;, &quot;The device profile referenced by the devices cannot be deleted!&quot;);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;DeviceProfile&gt; findDeviceProfiles(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfiles tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        Validator.validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceProfileDao.findDeviceProfiles(tenantId, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;DeviceProfileInfo&gt; findDeviceProfileInfos(TenantId tenantId, PageLink pageLink, String transportType) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileInfos tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        Validator.validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return deviceProfileDao.findDeviceProfileInfos(tenantId, pageLink, transportType);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findOrCreateDeviceProfile(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findOrCreateDefaultDeviceProfile&quot;);</b>
<b class="nc">&nbsp;        DeviceProfile deviceProfile = findDeviceProfileByName(tenantId, name, false);</b>
<b class="nc">&nbsp;        if (deviceProfile == null) {</b>
<b class="nc">&nbsp;            boolean isDefault = &quot;default&quot;.equals(name) &amp;&amp; findDefaultDeviceProfile(tenantId) == null;</b>
&nbsp;            try {
<b class="nc">&nbsp;                deviceProfile = this.doCreateDeviceProfile(tenantId, name, isDefault, true);</b>
&nbsp;            } catch (DataValidationException e) {
<b class="nc">&nbsp;                if (DEVICE_PROFILE_WITH_SUCH_NAME_ALREADY_EXISTS.equals(e.getMessage())) {</b>
<b class="nc">&nbsp;                    deviceProfile = findDeviceProfileByName(tenantId, name, false);</b>
&nbsp;                } else {
&nbsp;                    throw e;
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return deviceProfile;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile createDefaultDeviceProfile(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing createDefaultDeviceProfile tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        return doCreateDeviceProfile(tenantId, &quot;default&quot;, true, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceProfile doCreateDeviceProfile(TenantId tenantId, String profileName, boolean defaultProfile, boolean publishSaveEvent) {
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        DeviceProfile deviceProfile = new DeviceProfile();</b>
<b class="nc">&nbsp;        deviceProfile.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        deviceProfile.setDefault(defaultProfile);</b>
<b class="nc">&nbsp;        deviceProfile.setName(profileName);</b>
<b class="nc">&nbsp;        deviceProfile.setType(DeviceProfileType.DEFAULT);</b>
<b class="nc">&nbsp;        deviceProfile.setTransportType(DeviceTransportType.DEFAULT);</b>
<b class="nc">&nbsp;        deviceProfile.setProvisionType(DeviceProfileProvisionType.DISABLED);</b>
<b class="nc">&nbsp;        deviceProfile.setDescription(&quot;Default device profile&quot;);</b>
<b class="nc">&nbsp;        DeviceProfileData deviceProfileData = new DeviceProfileData();</b>
<b class="nc">&nbsp;        DefaultDeviceProfileConfiguration configuration = new DefaultDeviceProfileConfiguration();</b>
<b class="nc">&nbsp;        DefaultDeviceProfileTransportConfiguration transportConfiguration = new DefaultDeviceProfileTransportConfiguration();</b>
<b class="nc">&nbsp;        DisabledDeviceProfileProvisionConfiguration provisionConfiguration = new DisabledDeviceProfileProvisionConfiguration(null);</b>
<b class="nc">&nbsp;        deviceProfileData.setConfiguration(configuration);</b>
<b class="nc">&nbsp;        deviceProfileData.setTransportConfiguration(transportConfiguration);</b>
<b class="nc">&nbsp;        deviceProfileData.setProvisionConfiguration(provisionConfiguration);</b>
<b class="nc">&nbsp;        deviceProfile.setProfileData(deviceProfileData);</b>
<b class="nc">&nbsp;        return saveDeviceProfile(deviceProfile, true, publishSaveEvent);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfile findDefaultDeviceProfile(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDefaultDeviceProfile tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(DeviceProfileCacheKey.forDefaultProfile(tenantId),</b>
<b class="nc">&nbsp;                () -&gt; deviceProfileDao.findDefaultDeviceProfile(tenantId), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceProfileInfo findDefaultDeviceProfileInfo(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDefaultDeviceProfileInfo tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return toDeviceProfileInfo(findDefaultDeviceProfile(tenantId));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean setDefaultDeviceProfile(TenantId tenantId, DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing setDefaultDeviceProfile [{}]&quot;, deviceProfileId);</b>
<b class="nc">&nbsp;        validateId(deviceProfileId, id -&gt; INCORRECT_DEVICE_PROFILE_ID + id);</b>
<b class="nc">&nbsp;        DeviceProfile deviceProfile = deviceProfileDao.findById(tenantId, deviceProfileId.getId());</b>
<b class="nc">&nbsp;        if (!deviceProfile.isDefault()) {</b>
<b class="nc">&nbsp;            deviceProfile.setDefault(true);</b>
<b class="nc">&nbsp;            DeviceProfile previousDefaultDeviceProfile = findDefaultDeviceProfile(tenantId);</b>
<b class="nc">&nbsp;            boolean changed = false;</b>
<b class="nc">&nbsp;            if (previousDefaultDeviceProfile == null) {</b>
<b class="nc">&nbsp;                deviceProfileDao.save(tenantId, deviceProfile);</b>
<b class="nc">&nbsp;                publishEvictEvent(new DeviceProfileEvictEvent(deviceProfile.getTenantId(), deviceProfile.getName(), null, deviceProfile.getId(), true, deviceProfile.getProvisionDeviceKey()));</b>
<b class="nc">&nbsp;                changed = true;</b>
<b class="nc">&nbsp;            } else if (!previousDefaultDeviceProfile.getId().equals(deviceProfile.getId())) {</b>
<b class="nc">&nbsp;                previousDefaultDeviceProfile.setDefault(false);</b>
<b class="nc">&nbsp;                deviceProfileDao.save(tenantId, previousDefaultDeviceProfile);</b>
<b class="nc">&nbsp;                deviceProfileDao.save(tenantId, deviceProfile);</b>
<b class="nc">&nbsp;                publishEvictEvent(new DeviceProfileEvictEvent(previousDefaultDeviceProfile.getTenantId(), previousDefaultDeviceProfile.getName(), null, previousDefaultDeviceProfile.getId(), false, deviceProfile.getProvisionDeviceKey()));</b>
<b class="nc">&nbsp;                publishEvictEvent(new DeviceProfileEvictEvent(deviceProfile.getTenantId(), deviceProfile.getName(), null, deviceProfile.getId(), true, deviceProfile.getProvisionDeviceKey()));</b>
<b class="nc">&nbsp;                changed = true;</b>
&nbsp;            }
<b class="nc">&nbsp;            return changed;</b>
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteDeviceProfilesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteDeviceProfilesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        tenantDeviceProfilesRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        deleteDeviceProfilesByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HasId&lt;?&gt;&gt; findEntity(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return Optional.ofNullable(findDeviceProfileById(tenantId, new DeviceProfileId(entityId.getId())));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public FluentFuture&lt;Optional&lt;HasId&lt;?&gt;&gt;&gt; findEntityAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return FluentFuture.from(deviceProfileDao.findByIdAsync(tenantId, entityId.getId()))</b>
<b class="nc">&nbsp;                .transform(Optional::ofNullable, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return EntityType.DEVICE_PROFILE;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;EntityInfo&gt; findDeviceProfileNamesByTenantId(TenantId tenantId, boolean activeOnly) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfileNamesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return deviceProfileDao.findTenantDeviceProfileNames(tenantId.getId(), activeOnly)</b>
<b class="nc">&nbsp;                .stream().sorted(Comparator.comparing(EntityInfo::getName))</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;DeviceProfileInfo&gt; findDeviceProfilesByIds(TenantId tenantId, List&lt;DeviceProfileId&gt; deviceProfileIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findDeviceProfilesByIds, tenantId [{}], deviceProfileIds [{}]&quot;, tenantId, deviceProfileIds);</b>
<b class="nc">&nbsp;        return deviceProfileDao.findDeviceProfilesByTenantIdAndIds(tenantId.getId(), toUUIDs(deviceProfileIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    private final PaginatedRemover&lt;TenantId, DeviceProfile&gt; tenantDeviceProfilesRemover =
<b class="nc">&nbsp;            new PaginatedRemover&lt;&gt;() {</b>
&nbsp;
&nbsp;                @Override
&nbsp;                protected PageData&lt;DeviceProfile&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;                    return deviceProfileDao.findDeviceProfiles(id, pageLink);</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                protected void removeEntity(TenantId tenantId, DeviceProfile entity) {
<b class="nc">&nbsp;                    removeDeviceProfile(tenantId, entity);</b>
&nbsp;                }
&nbsp;            };
&nbsp;
&nbsp;    private DeviceProfileInfo toDeviceProfileInfo(DeviceProfile profile) {
<b class="nc">&nbsp;        return profile == null ? null : new DeviceProfileInfo(profile.getId(), profile.getTenantId(), profile.getName(), profile.getImage(),</b>
<b class="nc">&nbsp;                profile.getDefaultDashboardId(), profile.getType(), profile.getTransportType());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void formatDeviceProfileCertificate(DeviceProfile deviceProfile, X509CertificateChainProvisionConfiguration x509Configuration) {
<b class="nc">&nbsp;        String formattedCertificateValue = formatCertificateValue(x509Configuration.getProvisionDeviceSecret());</b>
<b class="nc">&nbsp;        String cert = fetchLeafCertificateFromChain(formattedCertificateValue);</b>
<b class="nc">&nbsp;        String sha3Hash = EncryptionUtil.getSha3Hash(cert);</b>
<b class="nc">&nbsp;        DeviceProfileData deviceProfileData = deviceProfile.getProfileData();</b>
<b class="nc">&nbsp;        x509Configuration.setProvisionDeviceSecret(formattedCertificateValue);</b>
<b class="nc">&nbsp;        deviceProfileData.setProvisionConfiguration(x509Configuration);</b>
<b class="nc">&nbsp;        deviceProfile.setProfileData(deviceProfileData);</b>
<b class="nc">&nbsp;        deviceProfile.setProvisionDeviceKey(sha3Hash);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String fetchLeafCertificateFromChain(String value) {
<b class="nc">&nbsp;        String regex = &quot;-----BEGIN CERTIFICATE-----\\s*.*?\\s*-----END CERTIFICATE-----&quot;;</b>
<b class="nc">&nbsp;        Pattern pattern = Pattern.compile(regex);</b>
<b class="nc">&nbsp;        Matcher matcher = pattern.matcher(value);</b>
<b class="nc">&nbsp;        if (matcher.find()) {</b>
&nbsp;            // if the method receives a chain it fetches the leaf (end-entity) certificate, else if it gets a single certificate, it returns the single certificate
<b class="nc">&nbsp;            return matcher.group(0);</b>
&nbsp;        }
<b class="nc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String formatCertificateValue(String certificateValue) {
&nbsp;        try {
<b class="nc">&nbsp;            CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);</b>
<b class="nc">&nbsp;            ByteArrayInputStream inputStream = new ByteArrayInputStream(certificateValue.getBytes());</b>
<b class="nc">&nbsp;            Certificate[] certificates = cf.generateCertificates(inputStream).toArray(new Certificate[0]);</b>
<b class="nc">&nbsp;            if (certificates.length &gt; 1) {</b>
<b class="nc">&nbsp;                return EncryptionUtil.certTrimNewLinesForChainInDeviceProfile(certificateValue);</b>
&nbsp;            }
&nbsp;        } catch (CertificateException ignored) {}
<b class="nc">&nbsp;        return EncryptionUtil.certTrimNewLines(certificateValue);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeviceConnectivityServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.device</a>
</div>

<h1>Coverage Summary for Class: DeviceConnectivityServiceImpl (org.thingsboard.server.dao.device)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeviceConnectivityServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/152)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DeviceConnectivityServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/153)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.device;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ArrayNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.bouncycastle.cert.X509CertificateHolder;
&nbsp;import org.bouncycastle.openssl.PEMParser;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.core.io.ByteArrayResource;
&nbsp;import org.springframework.core.io.Resource;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.AdminSettings;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceTransportType;
&nbsp;import org.thingsboard.server.common.data.ResourceUtils;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.device.profile.MqttDeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentialsType;
&nbsp;import org.thingsboard.server.dao.settings.AdminSettingsService;
&nbsp;import org.thingsboard.server.dao.util.DeviceConnectivityUtil;
&nbsp;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.net.URISyntaxException;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Base64;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.CHECK_DOCUMENTATION;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.COAP;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.COAPS;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.DOCKER;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.HTTP;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.HTTPS;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.MQTT;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.MQTTS;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.getHost;
&nbsp;import static org.thingsboard.server.dao.util.DeviceConnectivityUtil.getPort;
&nbsp;
&nbsp;@Service(&quot;DeviceConnectivityDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class DeviceConnectivityServiceImpl implements DeviceConnectivityService {
&nbsp;
&nbsp;    public static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;    public static final String INCORRECT_DEVICE_ID = &quot;Incorrect deviceId &quot;;
&nbsp;    public static final String DEFAULT_DEVICE_TELEMETRY_TOPIC = &quot;v1/devices/me/telemetry&quot;;
&nbsp;    public static final String HTTP_DEFAULT_PORT = &quot;80&quot;;
&nbsp;    public static final String HTTPS_DEFAULT_PORT = &quot;443&quot;;
&nbsp;
&nbsp;    private final Map&lt;String, Resource&gt; certs = new ConcurrentHashMap&lt;&gt;();
&nbsp;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final DeviceProfileService deviceProfileService;
&nbsp;    private final AdminSettingsService adminSettingsService;
&nbsp;
&nbsp;    @Value(&quot;${device.connectivity.mqtts.pem_cert_file:}&quot;)
&nbsp;    private String mqttsPemCertFile;
&nbsp;    @Value(&quot;${device.connectivity.coaps.pem_cert_file:}&quot;)
&nbsp;    private String coapsPemCertFile;
&nbsp;    @Value(&quot;${device.connectivity.gateway.image_version:3.8-stable}&quot;)
&nbsp;    private String gatewayImageVersion;
&nbsp;
&nbsp;    @Override
&nbsp;    public JsonNode findDevicePublishTelemetryCommands(String baseUrl, Device device) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
<b class="nc">&nbsp;        log.trace(&quot;Executing findDevicePublishTelemetryCommands [{}]&quot;, deviceId);</b>
<b class="nc">&nbsp;        validateId(deviceId, id -&gt; INCORRECT_DEVICE_ID + id);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceCredentials creds = deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), deviceId);</b>
<b class="nc">&nbsp;        DeviceProfile deviceProfile = deviceProfileService.findDeviceProfileById(device.getTenantId(), device.getDeviceProfileId());</b>
<b class="nc">&nbsp;        DeviceTransportType transportType = deviceProfile.getTransportType();</b>
&nbsp;
<b class="nc">&nbsp;        ObjectNode commands = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        switch (transportType) {</b>
&nbsp;            case DEFAULT:
<b class="nc">&nbsp;                Optional.ofNullable(getHttpTransportPublishCommands(baseUrl, creds))</b>
<b class="nc">&nbsp;                        .ifPresent(v -&gt; commands.set(HTTP, v));</b>
<b class="nc">&nbsp;                Optional.ofNullable(getMqttTransportPublishCommands(baseUrl, creds))</b>
<b class="nc">&nbsp;                        .ifPresent(v -&gt; commands.set(MQTT, v));</b>
<b class="nc">&nbsp;                Optional.ofNullable(getCoapTransportPublishCommands(baseUrl, creds))</b>
<b class="nc">&nbsp;                        .ifPresent(v -&gt; commands.set(COAP, v));</b>
&nbsp;                break;
&nbsp;            case MQTT:
<b class="nc">&nbsp;                MqttDeviceProfileTransportConfiguration transportConfiguration =</b>
<b class="nc">&nbsp;                        (MqttDeviceProfileTransportConfiguration) deviceProfile.getProfileData().getTransportConfiguration();</b>
&nbsp;                //TODO: add sparkplug command with emulator (check SSL)
<b class="nc">&nbsp;                if (transportConfiguration.isSparkplug()) {</b>
<b class="nc">&nbsp;                    ObjectNode sparkplug = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;                    sparkplug.put(&quot;sparkplug&quot;, CHECK_DOCUMENTATION);</b>
<b class="nc">&nbsp;                    commands.set(MQTT, sparkplug);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    String topicName = transportConfiguration.getDeviceTelemetryTopic();</b>
&nbsp;
<b class="nc">&nbsp;                    Optional.ofNullable(getMqttTransportPublishCommands(baseUrl, topicName, creds))</b>
<b class="nc">&nbsp;                            .ifPresent(v -&gt; commands.set(MQTT, v));</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case COAP:
<b class="nc">&nbsp;                Optional.ofNullable(getCoapTransportPublishCommands(baseUrl, creds))</b>
<b class="nc">&nbsp;                        .ifPresent(v -&gt; commands.set(COAP, v));</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                commands.put(transportType.name(), CHECK_DOCUMENTATION);</b>
&nbsp;        }
<b class="nc">&nbsp;        return commands;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Resource getPemCertFile(String protocol) {
<b class="nc">&nbsp;        return certs.computeIfAbsent(protocol, key -&gt; {</b>
<b class="nc">&nbsp;            DeviceConnectivityInfo connectivity = getConnectivity(protocol);</b>
<b class="nc">&nbsp;            if (connectivity == null) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Unknown connectivity protocol: {}&quot;, protocol);</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            return switch (protocol) {</b>
<b class="nc">&nbsp;                case COAPS -&gt; getCert(coapsPemCertFile);</b>
<b class="nc">&nbsp;                case MQTTS -&gt; getCert(mqttsPemCertFile);</b>
&nbsp;                default -&gt; {
<b class="nc">&nbsp;                    log.warn(&quot;Unsupported secure protocol: {}&quot;, protocol);</b>
<b class="nc">&nbsp;                    yield null;</b>
&nbsp;                }
&nbsp;            };
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Resource createGatewayDockerComposeFile(String baseUrl, Device device) throws URISyntaxException {
<b class="nc">&nbsp;        String mqttType = isEnabled(MQTTS) ? MQTTS : MQTT;</b>
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(mqttType);</b>
<b class="nc">&nbsp;        DeviceCredentials creds = deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId());</b>
<b class="nc">&nbsp;        String host = getHost(baseUrl, properties, mqttType);</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getGatewayDockerComposeFile(host, gatewayImageVersion, creds);</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceConnectivityInfo getConnectivity(String protocol) {
<b class="nc">&nbsp;        AdminSettings connectivitySettings = adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, &quot;connectivity&quot;);</b>
&nbsp;        JsonNode connectivity;
<b class="nc">&nbsp;        if (connectivitySettings != null &amp;&amp; (connectivity = connectivitySettings.getJsonValue()) != null) {</b>
<b class="nc">&nbsp;            return JacksonUtil.convertValue(connectivity.get(protocol), DeviceConnectivityInfo.class);</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isEnabled(String protocol) {
<b class="nc">&nbsp;        var info = getConnectivity(protocol);</b>
<b class="nc">&nbsp;        return info != null &amp;&amp; info.isEnabled();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Resource getCert(String path) {
<b class="nc">&nbsp;        if (StringUtils.isBlank(path) || !ResourceUtils.resourceExists(this, path)) {</b>
<b class="nc">&nbsp;           return null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        StringBuilder pemContentBuilder = new StringBuilder();</b>
&nbsp;
<b class="nc">&nbsp;        try (InputStream inStream = ResourceUtils.getInputStream(this, path);</b>
<b class="nc">&nbsp;             PEMParser pemParser = new PEMParser(new InputStreamReader(inStream))) {</b>
&nbsp;
&nbsp;            Object object;
&nbsp;
<b class="nc">&nbsp;            while ((object = pemParser.readObject()) != null) {</b>
<b class="nc">&nbsp;                if (object instanceof X509CertificateHolder) {</b>
<b class="nc">&nbsp;                    var certHolder = (X509CertificateHolder) object;</b>
<b class="nc">&nbsp;                    String certBase64 = Base64.getEncoder().encodeToString(certHolder.getEncoded());</b>
&nbsp;
<b class="nc">&nbsp;                    pemContentBuilder.append(&quot;-----BEGIN CERTIFICATE-----\n&quot;);</b>
<b class="nc">&nbsp;                    int index = 0;</b>
<b class="nc">&nbsp;                    while (index &lt; certBase64.length()) {</b>
<b class="nc">&nbsp;                        pemContentBuilder.append(certBase64, index, Math.min(index + 64, certBase64.length()));</b>
<b class="nc">&nbsp;                        pemContentBuilder.append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;                        index += 64;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    pemContentBuilder.append(&quot;-----END CERTIFICATE-----\n&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            String msg = String.format(&quot;Failed to read %s server certificate!&quot;, path);</b>
<b class="nc">&nbsp;            log.warn(msg);</b>
<b class="nc">&nbsp;            throw new RuntimeException(msg, e);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return new ByteArrayResource(pemContentBuilder.toString().getBytes(StandardCharsets.UTF_8));</b>
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode getHttpTransportPublishCommands(String defaultHostname, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        ObjectNode httpCommands = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        Optional.ofNullable(getHttpPublishCommand(HTTP, defaultHostname, deviceCredentials))</b>
<b class="nc">&nbsp;                .ifPresent(v -&gt; httpCommands.put(HTTP, v));</b>
<b class="nc">&nbsp;        Optional.ofNullable(getHttpPublishCommand(HTTPS, defaultHostname, deviceCredentials))</b>
<b class="nc">&nbsp;                .ifPresent(v -&gt; httpCommands.put(HTTPS, v));</b>
<b class="nc">&nbsp;        return httpCommands.isEmpty() ? null : httpCommands;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getHttpPublishCommand(String protocol, String baseUrl, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(protocol);</b>
<b class="nc">&nbsp;        if (properties == null || !properties.isEnabled() ||</b>
<b class="nc">&nbsp;                deviceCredentials.getCredentialsType() != DeviceCredentialsType.ACCESS_TOKEN) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        String hostName = getHost(baseUrl, properties, protocol);</b>
<b class="nc">&nbsp;        String propertiesPort = getPort(properties);</b>
<b class="nc">&nbsp;        String port = (propertiesPort.isEmpty() || HTTP_DEFAULT_PORT.equals(propertiesPort) || HTTPS_DEFAULT_PORT.equals(propertiesPort))</b>
<b class="nc">&nbsp;                ? &quot;&quot; : &quot;:&quot; + propertiesPort;</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getHttpPublishCommand(protocol, hostName, port, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode getMqttTransportPublishCommands(String baseUrl, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        return getMqttTransportPublishCommands(baseUrl, DEFAULT_DEVICE_TELEMETRY_TOPIC, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode getMqttTransportPublishCommands(String baseUrl, String topic, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        ObjectNode mqttCommands = JacksonUtil.newObjectNode();</b>
&nbsp;
<b class="nc">&nbsp;        if (deviceCredentials.getCredentialsType() == DeviceCredentialsType.X509_CERTIFICATE) {</b>
<b class="nc">&nbsp;            mqttCommands.put(MQTTS, CHECK_DOCUMENTATION);</b>
<b class="nc">&nbsp;            return mqttCommands;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ObjectNode dockerMqttCommands = JacksonUtil.newObjectNode();</b>
&nbsp;
<b class="nc">&nbsp;        if (isEnabled(MQTT)) {</b>
<b class="nc">&nbsp;            Optional.ofNullable(getMqttPublishCommand(baseUrl, topic, deviceCredentials)).</b>
<b class="nc">&nbsp;                    ifPresent(v -&gt; mqttCommands.put(MQTT, v));</b>
&nbsp;
<b class="nc">&nbsp;            Optional.ofNullable(getDockerMqttPublishCommand(MQTT, baseUrl, topic, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(v -&gt; dockerMqttCommands.put(MQTT, v));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isEnabled(MQTTS)) {</b>
<b class="nc">&nbsp;            List&lt;String&gt; mqttsPublishCommand = getMqttsPublishCommand(baseUrl, topic, deviceCredentials);</b>
<b class="nc">&nbsp;            if (mqttsPublishCommand != null) {</b>
<b class="nc">&nbsp;                ArrayNode arrayNode = mqttCommands.putArray(MQTTS);</b>
<b class="nc">&nbsp;                mqttsPublishCommand.forEach(arrayNode::add);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Optional.ofNullable(getDockerMqttPublishCommand(MQTTS, baseUrl, topic, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(v -&gt; dockerMqttCommands.put(MQTTS, v));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!dockerMqttCommands.isEmpty()) {</b>
<b class="nc">&nbsp;            mqttCommands.set(DOCKER, dockerMqttCommands);</b>
&nbsp;        }
<b class="nc">&nbsp;        return mqttCommands.isEmpty() ? null : mqttCommands;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getMqttPublishCommand(String baseUrl, String deviceTelemetryTopic, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(MQTT);</b>
<b class="nc">&nbsp;        String mqttHost = getHost(baseUrl, properties, MQTT);</b>
<b class="nc">&nbsp;        String mqttPort = getPort(properties);</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getMqttPublishCommand(MQTT, mqttHost, mqttPort, deviceTelemetryTopic, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;String&gt; getMqttsPublishCommand(String baseUrl, String deviceTelemetryTopic, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(MQTTS);</b>
<b class="nc">&nbsp;        String mqttHost = getHost(baseUrl, properties, MQTTS);</b>
<b class="nc">&nbsp;        String mqttPort = getPort(properties);</b>
<b class="nc">&nbsp;        String pubCommand = DeviceConnectivityUtil.getMqttPublishCommand(MQTTS, mqttHost, mqttPort, deviceTelemetryTopic, deviceCredentials);</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;String&gt; commands = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (pubCommand != null) {</b>
<b class="nc">&nbsp;            commands.add(DeviceConnectivityUtil.getCurlPemCertCommand(baseUrl, MQTTS));</b>
<b class="nc">&nbsp;            commands.add(pubCommand);</b>
<b class="nc">&nbsp;            return commands;</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getDockerMqttPublishCommand(String protocol, String baseUrl, String deviceTelemetryTopic, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(protocol);</b>
<b class="nc">&nbsp;        String mqttHost = getHost(baseUrl, properties, protocol);</b>
<b class="nc">&nbsp;        String mqttPort = getPort(properties);</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getDockerMqttPublishCommand(protocol, baseUrl, mqttHost, mqttPort, deviceTelemetryTopic, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode getCoapTransportPublishCommands(String baseUrl, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        ObjectNode coapCommands = JacksonUtil.newObjectNode();</b>
&nbsp;
<b class="nc">&nbsp;        if (deviceCredentials.getCredentialsType() == DeviceCredentialsType.X509_CERTIFICATE) {</b>
<b class="nc">&nbsp;            coapCommands.put(COAPS, CHECK_DOCUMENTATION);</b>
<b class="nc">&nbsp;            return coapCommands;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ObjectNode dockerCoapCommands = JacksonUtil.newObjectNode();</b>
&nbsp;
<b class="nc">&nbsp;        if (isEnabled(COAP)) {</b>
<b class="nc">&nbsp;            Optional.ofNullable(getCoapPublishCommand(COAP, baseUrl, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(v -&gt; coapCommands.put(COAP, v));</b>
&nbsp;
<b class="nc">&nbsp;            Optional.ofNullable(getDockerCoapPublishCommand(COAP, baseUrl, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(v -&gt; dockerCoapCommands.put(COAP, v));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isEnabled(COAPS)) {</b>
<b class="nc">&nbsp;            ArrayNode coapsCommands = coapCommands.putArray(COAPS);</b>
<b class="nc">&nbsp;            Optional.ofNullable(DeviceConnectivityUtil.getCurlPemCertCommand(baseUrl, COAPS))</b>
<b class="nc">&nbsp;                    .ifPresent(coapsCommands::add);</b>
<b class="nc">&nbsp;            Optional.ofNullable(getCoapPublishCommand(COAPS, baseUrl, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(coapsCommands::add);</b>
&nbsp;
<b class="nc">&nbsp;            Optional.ofNullable(getDockerCoapPublishCommand(COAPS, baseUrl, deviceCredentials))</b>
<b class="nc">&nbsp;                    .ifPresent(v -&gt; dockerCoapCommands.put(COAPS, v));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!dockerCoapCommands.isEmpty()) {</b>
<b class="nc">&nbsp;            coapCommands.set(DOCKER, dockerCoapCommands);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return coapCommands.isEmpty() ? null : coapCommands;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getCoapPublishCommand(String protocol, String baseUrl, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(protocol);</b>
<b class="nc">&nbsp;        String hostName = getHost(baseUrl, properties, protocol);</b>
<b class="nc">&nbsp;        String port = StringUtils.isBlank(properties.getPort()) ? &quot;&quot; : &quot;:&quot; + properties.getPort();</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getCoapPublishCommand(protocol, hostName, port, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getDockerCoapPublishCommand(String protocol, String baseUrl, DeviceCredentials deviceCredentials) throws URISyntaxException {
<b class="nc">&nbsp;        DeviceConnectivityInfo properties = getConnectivity(protocol);</b>
<b class="nc">&nbsp;        String host = getHost(baseUrl, properties, protocol);</b>
<b class="nc">&nbsp;        String port = StringUtils.isBlank(properties.getPort()) ? &quot;&quot; : &quot;:&quot; + properties.getPort();</b>
<b class="nc">&nbsp;        return DeviceConnectivityUtil.getDockerCoapPublishCommand(protocol, baseUrl, host, port, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TenantActor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.actors.tenant</a>
</div>

<h1>Coverage Summary for Class: TenantActor (org.thingsboard.server.actors.tenant)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TenantActor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/110)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/147)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TenantActor$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TenantActor$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TenantActor$ActorCreator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/112)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/154)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.actors.tenant;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.actors.ActorSystemContext;
&nbsp;import org.thingsboard.server.actors.ProcessFailureStrategy;
&nbsp;import org.thingsboard.server.actors.TbActor;
&nbsp;import org.thingsboard.server.actors.TbActorCtx;
&nbsp;import org.thingsboard.server.actors.TbActorException;
&nbsp;import org.thingsboard.server.actors.TbActorId;
&nbsp;import org.thingsboard.server.actors.TbActorNotRegisteredException;
&nbsp;import org.thingsboard.server.actors.TbActorRef;
&nbsp;import org.thingsboard.server.actors.TbEntityActorId;
&nbsp;import org.thingsboard.server.actors.TbEntityTypeActorIdPredicate;
&nbsp;import org.thingsboard.server.actors.TbStringActorId;
&nbsp;import org.thingsboard.server.actors.calculatedField.CalculatedFieldManagerActorCreator;
&nbsp;import org.thingsboard.server.actors.calculatedField.CalculatedFieldStateRestoreMsg;
&nbsp;import org.thingsboard.server.actors.device.DeviceActorCreator;
&nbsp;import org.thingsboard.server.actors.ruleChain.RuleChainManagerActor;
&nbsp;import org.thingsboard.server.actors.service.ContextBasedCreator;
&nbsp;import org.thingsboard.server.actors.service.DefaultActorService;
&nbsp;import org.thingsboard.server.common.data.ApiUsageState;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentLifecycleEvent;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChain;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainType;
&nbsp;import org.thingsboard.server.common.msg.TbActorMsg;
&nbsp;import org.thingsboard.server.common.msg.TbActorStopReason;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.ToCalculatedFieldSystemMsg;
&nbsp;import org.thingsboard.server.common.msg.aware.DeviceAwareMsg;
&nbsp;import org.thingsboard.server.common.msg.aware.RuleChainAwareMsg;
&nbsp;import org.thingsboard.server.common.msg.aware.TenantAwareMsg;
&nbsp;import org.thingsboard.server.common.msg.cf.CalculatedFieldCacheInitMsg;
&nbsp;import org.thingsboard.server.common.msg.cf.CalculatedFieldEntityLifecycleMsg;
&nbsp;import org.thingsboard.server.common.msg.plugin.ComponentLifecycleMsg;
&nbsp;import org.thingsboard.server.common.msg.queue.PartitionChangeMsg;
&nbsp;import org.thingsboard.server.common.msg.queue.QueueToRuleEngineMsg;
&nbsp;import org.thingsboard.server.common.msg.queue.RuleEngineException;
&nbsp;import org.thingsboard.server.common.msg.queue.ServiceType;
&nbsp;import org.thingsboard.server.common.msg.rule.engine.DeviceDeleteMsg;
&nbsp;import org.thingsboard.server.service.transport.msg.TransportToDeviceActorMsgWrapper;
&nbsp;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class TenantActor extends RuleChainManagerActor {
&nbsp;
&nbsp;    private boolean isRuleEngine;
&nbsp;    private boolean isCore;
&nbsp;    private ApiUsageState apiUsageState;
&nbsp;    private Set&lt;DeviceId&gt; deletedDevices;
&nbsp;    private TbActorRef cfActor;
&nbsp;
&nbsp;    private TenantActor(ActorSystemContext systemContext, TenantId tenantId) {
<b class="nc">&nbsp;        super(systemContext, tenantId);</b>
<b class="nc">&nbsp;        this.deletedDevices = new HashSet&lt;&gt;();</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    boolean cantFindTenant = false;</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbActorCtx ctx) throws TbActorException {
<b class="nc">&nbsp;        super.init(ctx);</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] Starting tenant actor.&quot;, tenantId);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Tenant tenant = systemContext.getTenantService().findTenantById(tenantId);</b>
<b class="nc">&nbsp;            if (tenant == null) {</b>
<b class="nc">&nbsp;                cantFindTenant = true;</b>
<b class="nc">&nbsp;                log.info(&quot;[{}] Started tenant actor for missing tenant.&quot;, tenantId);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                isCore = systemContext.getServiceInfoProvider().isService(ServiceType.TB_CORE);</b>
<b class="nc">&nbsp;                isRuleEngine = systemContext.getServiceInfoProvider().isService(ServiceType.TB_RULE_ENGINE);</b>
<b class="nc">&nbsp;                if (isRuleEngine) {</b>
<b class="nc">&nbsp;                    if (systemContext.getPartitionService().isManagedByCurrentService(tenantId)) {</b>
&nbsp;                        try {
&nbsp;                            //TODO: IM - extend API usage to have CF Exec Enabled? Not in 4.0;
<b class="nc">&nbsp;                            cfActor = ctx.getOrCreateChildActor(new TbStringActorId(&quot;CFM|&quot; + tenantId),</b>
<b class="nc">&nbsp;                                    () -&gt; DefaultActorService.CF_MANAGER_DISPATCHER_NAME,</b>
<b class="nc">&nbsp;                                    () -&gt; new CalculatedFieldManagerActorCreator(systemContext, tenantId),</b>
<b class="nc">&nbsp;                                    () -&gt; true);</b>
<b class="nc">&nbsp;                            cfActor.tellWithHighPriority(new CalculatedFieldCacheInitMsg(tenantId));</b>
&nbsp;                        } catch (Exception e) {
<b class="nc">&nbsp;                            log.info(&quot;[{}] Failed to init CF Actor.&quot;, tenantId, e);</b>
&nbsp;                        }
&nbsp;                        try {
<b class="nc">&nbsp;                            if (getApiUsageState().isReExecEnabled()) {</b>
<b class="nc">&nbsp;                                log.debug(&quot;[{}] Going to init rule chains&quot;, tenantId);</b>
<b class="nc">&nbsp;                                initRuleChains();</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                log.info(&quot;[{}] Skip init of the rule chains due to API limits&quot;, tenantId);</b>
&nbsp;                            }
&nbsp;                        } catch (Exception e) {
<b class="nc">&nbsp;                            log.info(&quot;Failed to check ApiUsage \&quot;ReExecEnabled\&quot;!!!&quot;, e);</b>
<b class="nc">&nbsp;                            cantFindTenant = true;</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        log.info(&quot;Tenant {} is not managed by current service, skipping rule chains and cf actor init&quot;, tenantId);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                log.debug(&quot;[{}] Tenant actor started.&quot;, tenantId);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Unknown failure&quot;, tenantId, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy(TbActorStopReason stopReason, Throwable cause) {
<b class="nc">&nbsp;        log.info(&quot;[{}] Stopping tenant actor.&quot;, tenantId);</b>
<b class="nc">&nbsp;        if (cfActor != null) {</b>
<b class="nc">&nbsp;            ctx.stop(cfActor.getActorId());</b>
<b class="nc">&nbsp;            cfActor = null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected boolean doProcess(TbActorMsg msg) {
<b class="nc">&nbsp;        if (cantFindTenant) {</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Processing message for non-existing tenant: {}&quot;, tenantId, msg);</b>
<b class="nc">&nbsp;            switch (msg.getMsgType()) {</b>
&nbsp;                case QUEUE_TO_RULE_ENGINE_MSG -&gt; {
<b class="nc">&nbsp;                    ((QueueToRuleEngineMsg) msg).getMsg().getCallback().onSuccess();</b>
&nbsp;                }
&nbsp;                case TRANSPORT_TO_DEVICE_ACTOR_MSG -&gt; {
<b class="nc">&nbsp;                    ((TransportToDeviceActorMsgWrapper) msg).getCallback().onSuccess();</b>
&nbsp;                }
&nbsp;                case CF_STATE_RESTORE_MSG -&gt; {
<b class="nc">&nbsp;                    ((CalculatedFieldStateRestoreMsg) msg).getCallback().onSuccess();</b>
&nbsp;                }
&nbsp;                default -&gt; {
<b class="nc">&nbsp;                    if (!log.isDebugEnabled()) {</b>
<b class="nc">&nbsp;                        log.info(&quot;[{}] Processing message for non-existing tenant: {}&quot;, tenantId, msg);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        switch (msg.getMsgType()) {</b>
&nbsp;            case PARTITION_CHANGE_MSG:
<b class="nc">&nbsp;                onPartitionChangeMsg((PartitionChangeMsg) msg);</b>
&nbsp;                break;
&nbsp;            case COMPONENT_LIFE_CYCLE_MSG:
<b class="nc">&nbsp;                onComponentLifecycleMsg((ComponentLifecycleMsg) msg);</b>
&nbsp;                break;
&nbsp;            case CF_ENTITY_ACTION_EVENT_MSG:
<b class="nc">&nbsp;                forwardToCfActor((TenantAwareMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case QUEUE_TO_RULE_ENGINE_MSG:
<b class="nc">&nbsp;                onQueueToRuleEngineMsg((QueueToRuleEngineMsg) msg);</b>
&nbsp;                break;
&nbsp;            case TRANSPORT_TO_DEVICE_ACTOR_MSG:
<b class="nc">&nbsp;                onToDeviceActorMsg((DeviceAwareMsg) msg, false);</b>
&nbsp;                break;
&nbsp;            case DEVICE_ATTRIBUTES_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_CREDENTIALS_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_NAME_OR_TYPE_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_EDGE_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_RPC_REQUEST_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_RPC_RESPONSE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case SERVER_RPC_RESPONSE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case REMOVE_RPC_TO_DEVICE_ACTOR_MSG:
<b class="nc">&nbsp;                onToDeviceActorMsg((DeviceAwareMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case SESSION_TIMEOUT_MSG:
<b class="nc">&nbsp;                ctx.broadcastToChildrenByType(msg, EntityType.DEVICE);</b>
&nbsp;                break;
&nbsp;            case RULE_CHAIN_INPUT_MSG:
&nbsp;            case RULE_CHAIN_OUTPUT_MSG:
&nbsp;            case RULE_CHAIN_TO_RULE_CHAIN_MSG:
<b class="nc">&nbsp;                onRuleChainMsg((RuleChainAwareMsg) msg);</b>
&nbsp;                break;
&nbsp;            case CF_CACHE_INIT_MSG:
&nbsp;            case CF_STATE_RESTORE_MSG:
&nbsp;            case CF_PARTITIONS_CHANGE_MSG:
&nbsp;            case CF_STATE_PARTITION_RESTORE_MSG:
<b class="nc">&nbsp;                forwardToCfActor((ToCalculatedFieldSystemMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case CF_TELEMETRY_MSG:
&nbsp;            case CF_LINKED_TELEMETRY_MSG:
<b class="nc">&nbsp;                forwardToCfActor((ToCalculatedFieldSystemMsg) msg, false);</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void forwardToCfActor(TenantAwareMsg msg, boolean priority) {
<b class="nc">&nbsp;        if (cfActor == null) {</b>
<b class="nc">&nbsp;            if (msg instanceof CalculatedFieldStateRestoreMsg) {</b>
<b class="nc">&nbsp;                log.warn(&quot;[{}] CF Actor is not initialized. ToCalculatedFieldSystemMsg: [{}]&quot;, tenantId, msg);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                log.debug(&quot;[{}] CF Actor is not initialized. ToCalculatedFieldSystemMsg: [{}]&quot;, tenantId, msg);</b>
&nbsp;            }
<b class="nc">&nbsp;            msg.getCallback().onSuccess();</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (priority) {</b>
<b class="nc">&nbsp;            cfActor.tellWithHighPriority(msg);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            cfActor.tell(msg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean isMyPartition(EntityId entityId) {
<b class="nc">&nbsp;        return systemContext.resolve(ServiceType.TB_CORE, tenantId, entityId).isMyPartition();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onQueueToRuleEngineMsg(QueueToRuleEngineMsg msg) {
<b class="nc">&nbsp;        if (!isRuleEngine) {</b>
<b class="nc">&nbsp;            log.warn(&quot;RECEIVED INVALID MESSAGE: {}&quot;, msg);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        TbMsg tbMsg = msg.getMsg();</b>
<b class="nc">&nbsp;        if (getApiUsageState().isReExecEnabled()) {</b>
<b class="nc">&nbsp;            if (tbMsg.getRuleChainId() == null) {</b>
<b class="nc">&nbsp;                if (getRootChainActor() != null) {</b>
<b class="nc">&nbsp;                    getRootChainActor().tell(msg);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    tbMsg.getCallback().onFailure(new RuleEngineException(&quot;No Root Rule Chain available!&quot;));</b>
<b class="nc">&nbsp;                    log.info(&quot;[{}] No Root Chain: {}&quot;, tenantId, msg);</b>
&nbsp;                }
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    ctx.tell(new TbEntityActorId(tbMsg.getRuleChainId()), msg);</b>
&nbsp;                } catch (TbActorNotRegisteredException ex) {
<b class="nc">&nbsp;                    log.trace(&quot;Received message for non-existing rule chain: [{}]&quot;, tbMsg.getRuleChainId());</b>
&nbsp;                    //TODO: 3.1 Log it to dead letters queue;
<b class="nc">&nbsp;                    tbMsg.getCallback().onSuccess();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            log.trace(&quot;[{}] Ack message because Rule Engine is disabled&quot;, tenantId);</b>
<b class="nc">&nbsp;            tbMsg.getCallback().onSuccess();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onRuleChainMsg(RuleChainAwareMsg msg) {
<b class="nc">&nbsp;        if (getApiUsageState().isReExecEnabled()) {</b>
<b class="nc">&nbsp;            getOrCreateActor(msg.getRuleChainId()).tell(msg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onToDeviceActorMsg(DeviceAwareMsg msg, boolean priority) {
<b class="nc">&nbsp;        if (!isCore) {</b>
<b class="nc">&nbsp;            log.warn(&quot;RECEIVED INVALID MESSAGE: {}&quot;, msg);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (deletedDevices.contains(msg.getDeviceId())) {</b>
<b class="nc">&nbsp;            log.debug(&quot;RECEIVED MESSAGE FOR DELETED DEVICE: {}&quot;, msg);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        TbActorRef deviceActor = getOrCreateDeviceActor(msg.getDeviceId());</b>
<b class="nc">&nbsp;        if (priority) {</b>
<b class="nc">&nbsp;            deviceActor.tellWithHighPriority(msg);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            deviceActor.tell(msg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onPartitionChangeMsg(PartitionChangeMsg msg) {
<b class="nc">&nbsp;        ServiceType serviceType = msg.getServiceType();</b>
<b class="nc">&nbsp;        if (ServiceType.TB_RULE_ENGINE.equals(serviceType)) {</b>
<b class="nc">&nbsp;            if (systemContext.getPartitionService().isManagedByCurrentService(tenantId)) {</b>
<b class="nc">&nbsp;                if (cfActor == null) {</b>
&nbsp;                    try {
&nbsp;                        //TODO: IM - extend API usage to have CF Exec Enabled? Not in 4.0;
<b class="nc">&nbsp;                        cfActor = ctx.getOrCreateChildActor(new TbStringActorId(&quot;CFM|&quot; + tenantId),</b>
<b class="nc">&nbsp;                                () -&gt; DefaultActorService.CF_MANAGER_DISPATCHER_NAME,</b>
<b class="nc">&nbsp;                                () -&gt; new CalculatedFieldManagerActorCreator(systemContext, tenantId),</b>
<b class="nc">&nbsp;                                () -&gt; true);</b>
<b class="nc">&nbsp;                        cfActor.tellWithHighPriority(new CalculatedFieldCacheInitMsg(tenantId));</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        log.info(&quot;[{}] Failed to init CF Actor.&quot;, tenantId, e);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (!ruleChainsInitialized) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Tenant {} is now managed by this service, initializing rule chains&quot;, tenantId);</b>
<b class="nc">&nbsp;                    initRuleChains();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                if (cfActor != null) {</b>
<b class="nc">&nbsp;                    ctx.stop(cfActor.getActorId());</b>
<b class="nc">&nbsp;                    cfActor = null;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (ruleChainsInitialized) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Tenant {} is no longer managed by this service, stopping rule chains&quot;, tenantId);</b>
<b class="nc">&nbsp;                    destroyRuleChains();</b>
&nbsp;                }
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            //To Rule Chain Actors
<b class="nc">&nbsp;            broadcast(msg);</b>
<b class="nc">&nbsp;        } else if (ServiceType.TB_CORE.equals(serviceType)) {</b>
<b class="nc">&nbsp;            List&lt;TbActorId&gt; deviceActorIds = ctx.filterChildren(new TbEntityTypeActorIdPredicate(EntityType.DEVICE) {</b>
&nbsp;                @Override
&nbsp;                protected boolean testEntityId(EntityId entityId) {
<b class="nc">&nbsp;                    return super.testEntityId(entityId) &amp;&amp; !isMyPartition(entityId);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;            deviceActorIds.forEach(id -&gt; ctx.stop(id));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onComponentLifecycleMsg(ComponentLifecycleMsg msg) {
<b class="nc">&nbsp;        if (msg.getEntityId().getEntityType().equals(EntityType.API_USAGE_STATE)) {</b>
<b class="nc">&nbsp;            ApiUsageState old = getApiUsageState();</b>
<b class="nc">&nbsp;            apiUsageState = new ApiUsageState(systemContext.getApiUsageStateService().getApiUsageState(tenantId));</b>
<b class="nc">&nbsp;            if (old.isReExecEnabled() &amp;&amp; !apiUsageState.isReExecEnabled()) {</b>
<b class="nc">&nbsp;                log.info(&quot;[{}] Received API state update. Going to DISABLE Rule Engine execution.&quot;, tenantId);</b>
<b class="nc">&nbsp;                destroyRuleChains();</b>
<b class="nc">&nbsp;            } else if (!old.isReExecEnabled() &amp;&amp; apiUsageState.isReExecEnabled()) {</b>
<b class="nc">&nbsp;                log.info(&quot;[{}] Received API state update. Going to ENABLE Rule Engine execution.&quot;, tenantId);</b>
<b class="nc">&nbsp;                initRuleChains();</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (msg.getEntityId().getEntityType() == EntityType.DEVICE &amp;&amp; ComponentLifecycleEvent.DELETED == msg.getEvent() &amp;&amp; isMyPartition(msg.getEntityId())) {</b>
<b class="nc">&nbsp;            DeviceId deviceId = (DeviceId) msg.getEntityId();</b>
<b class="nc">&nbsp;            onToDeviceActorMsg(new DeviceDeleteMsg(tenantId, deviceId), true);</b>
<b class="nc">&nbsp;            deletedDevices.add(deviceId);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isRuleEngine) {</b>
<b class="nc">&nbsp;            if (ruleChainsInitialized) {</b>
<b class="nc">&nbsp;                TbActorRef target = getEntityActorRef(msg.getEntityId());</b>
<b class="nc">&nbsp;                if (target != null) {</b>
<b class="nc">&nbsp;                    if (msg.getEntityId().getEntityType() == EntityType.RULE_CHAIN) {</b>
<b class="nc">&nbsp;                        RuleChain ruleChain = systemContext.getRuleChainService().</b>
<b class="nc">&nbsp;                                findRuleChainById(tenantId, new RuleChainId(msg.getEntityId().getId()));</b>
<b class="nc">&nbsp;                        if (ruleChain != null &amp;&amp; RuleChainType.CORE.equals(ruleChain.getType())) {</b>
<b class="nc">&nbsp;                            visit(ruleChain, target);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    target.tellWithHighPriority(msg);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Invalid component lifecycle msg: {}&quot;, tenantId, msg);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (cfActor != null) {</b>
<b class="nc">&nbsp;                if (msg.getEntityId().getEntityType().isOneOf(EntityType.CALCULATED_FIELD, EntityType.DEVICE, EntityType.ASSET, EntityType.CUSTOMER, EntityType.TENANT_PROFILE)) {</b>
<b class="nc">&nbsp;                    cfActor.tellWithHighPriority(new CalculatedFieldEntityLifecycleMsg(tenantId, msg));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TbActorRef getOrCreateDeviceActor(DeviceId deviceId) {
<b class="nc">&nbsp;        return ctx.getOrCreateChildActor(new TbEntityActorId(deviceId),</b>
<b class="nc">&nbsp;                () -&gt; DefaultActorService.DEVICE_DISPATCHER_NAME,</b>
<b class="nc">&nbsp;                () -&gt; new DeviceActorCreator(systemContext, tenantId, deviceId),</b>
<b class="nc">&nbsp;                () -&gt; true);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ApiUsageState getApiUsageState() {
<b class="nc">&nbsp;        if (apiUsageState == null) {</b>
<b class="nc">&nbsp;            apiUsageState = new ApiUsageState(systemContext.getApiUsageStateService().getApiUsageState(tenantId));</b>
&nbsp;        }
<b class="nc">&nbsp;        return apiUsageState;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProcessFailureStrategy onProcessFailure(TbActorMsg msg, Throwable t) {
<b class="nc">&nbsp;        log.error(&quot;[{}] Failed to process msg: {}&quot;, tenantId, msg, t);</b>
<b class="nc">&nbsp;        return doProcessFailure(t);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static class ActorCreator extends ContextBasedCreator {
&nbsp;
&nbsp;        private final TenantId tenantId;
&nbsp;
&nbsp;        public ActorCreator(ActorSystemContext context, TenantId tenantId) {
<b class="nc">&nbsp;            super(context);</b>
<b class="nc">&nbsp;            this.tenantId = tenantId;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbActorId createActorId() {
<b class="nc">&nbsp;            return new TbEntityActorId(tenantId);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbActor createActor() {
<b class="nc">&nbsp;            return new TenantActor(context, tenantId);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

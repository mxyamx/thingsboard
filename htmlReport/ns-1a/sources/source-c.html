<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbCreateRelationNode</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.action</a>
</div>

<h1>Coverage Summary for Class: TbCreateRelationNode (org.thingsboard.rule.engine.action)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbCreateRelationNode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.action;
&nbsp;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import org.thingsboard.rule.engine.api.RuleNode;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeConfiguration;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeException;
&nbsp;import org.thingsboard.rule.engine.api.util.TbNodeUtils;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentType;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.EntitySearchDirection;
&nbsp;import org.thingsboard.server.common.data.relation.RelationTypeGroup;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;
&nbsp;import static org.thingsboard.common.util.DonAsynchron.withCallback;
&nbsp;
&nbsp;@RuleNode(
&nbsp;        type = ComponentType.ACTION,
&nbsp;        name = &quot;create relation&quot;,
&nbsp;        configClazz = TbCreateRelationNodeConfiguration.class,
&nbsp;        nodeDescription = &quot;Finds target entity specified in the configuration and creates a relation with the &quot; +
&nbsp;                &quot;incoming message originator based on the configured direction and type.&quot;,
&nbsp;        nodeDetails = &quot;Useful when you need to create relations between entities dynamically depending on &quot; +
&nbsp;                &quot;incoming message payload, message originator type, name, etc.&lt;br&gt;&lt;br&gt;&quot; +
&nbsp;                &quot;Target entity configuration: &quot; +
&nbsp;                &quot;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Device&lt;/strong&gt; - use a device with the specified name as the target entity to create a relation with. &quot; +
&nbsp;                &quot;When selected, rule node allows us to use advanced mode to enable device creation if it doesn&#39;t exist. &quot; +
&nbsp;                &quot;In advanced mode, device profile name should be specified.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Asset&lt;/strong&gt; - use an asset with the specified name as the target entity to create a relation with. &quot; +
&nbsp;                &quot;When selected, rule node allows us to use advanced mode to enable device creation if it doesn&#39;t exist. &quot; +
&nbsp;                &quot;In advanced mode, asset profile name should be specified.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Entity View&lt;/strong&gt; - use entity view with the specified name as the target entity to create a relation with.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Tenant&lt;/strong&gt; - use current tenant as target entity to create a relation with.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Customer&lt;/strong&gt; - use customer with the specified title as the target entity to create a relation with. &quot; +
&nbsp;                &quot;When selected, rule node allows us to use advanced mode to enable customer creation if it doesn&#39;t exist.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Dashboard&lt;/strong&gt; - use a dashboard with the specified title as the target entity to create a relation with.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;User&lt;/strong&gt; - use a user with the specified email as the target entity to create a relation with.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Edge&lt;/strong&gt; - use an edge with the specified name as the target entity to create a relation with.&lt;/li&gt;&lt;/ul&gt;&quot; +
&nbsp;                &quot;Advanced settings: &quot; +
&nbsp;                &quot;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;Remove current relations&lt;/strong&gt; - removes current relations with originator of the incoming message based on direction and type. &quot; +
&nbsp;                &quot;Useful in GPS tracking use cases where relation acts as a temporary indicator of a tracker presence in specific geofence.&lt;/li&gt;&quot; +
&nbsp;                &quot;&lt;li&gt;&lt;strong&gt;Change originator to target entity&lt;/strong&gt; - useful when you need to process submitted message as a message from target entity.&lt;/li&gt;&lt;/ul&gt;&quot; +
&nbsp;                &quot;Output connections: &lt;code&gt;Success&lt;/code&gt; - if the relation already exists or successfully created, otherwise &lt;code&gt;Failure&lt;/code&gt;.&quot;,
&nbsp;        configDirective = &quot;tbActionNodeCreateRelationConfig&quot;,
&nbsp;        icon = &quot;add_circle&quot;,
&nbsp;        version = 1,
&nbsp;        docUrl = &quot;https://thingsboard.io/docs/user-guide/rule-engine-2-0/nodes/action/create-relation/&quot;
&nbsp;)
<b class="nc">&nbsp;public class TbCreateRelationNode extends TbAbstractRelationActionNode&lt;TbCreateRelationNodeConfiguration&gt; {</b>
&nbsp;
&nbsp;    @Override
&nbsp;    protected TbCreateRelationNodeConfiguration loadEntityNodeActionConfig(TbNodeConfiguration configuration) throws TbNodeException {
<b class="nc">&nbsp;        var createRelationNodeConfiguration = TbNodeUtils.convert(configuration, TbCreateRelationNodeConfiguration.class);</b>
<b class="nc">&nbsp;        checkIfConfigEntityTypeIsSupported(createRelationNodeConfiguration.getEntityType());</b>
<b class="nc">&nbsp;        return createRelationNodeConfiguration;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected boolean createEntityIfNotExists() {
<b class="nc">&nbsp;        return config.isCreateEntityIfNotExists();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onMsg(TbContext ctx, TbMsg msg) {
<b class="nc">&nbsp;        var targetEntityIdFuture = getTargetEntityId(ctx, msg);</b>
<b class="nc">&nbsp;        var createRelationResultFuture = Futures.transformAsync(targetEntityIdFuture, targetEntityId -&gt; {</b>
<b class="nc">&nbsp;            var originator = msg.getOriginator();</b>
<b class="nc">&nbsp;            var relationType = processPattern(msg, config.getRelationType());</b>
<b class="nc">&nbsp;            if (config.isRemoveCurrentRelations()) {</b>
<b class="nc">&nbsp;                var removalOfCurrentRelationsFuture = deleteRelationsByTypeAndDirection(ctx, msg, relationType, MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;                return Futures.transformAsync(removalOfCurrentRelationsFuture, __ -&gt;</b>
<b class="nc">&nbsp;                        checkRelationAndCreateIfAbsent(ctx, originator, targetEntityId, relationType), MoreExecutors.directExecutor());</b>
&nbsp;            }
<b class="nc">&nbsp;            return checkRelationAndCreateIfAbsent(ctx, originator, targetEntityId, relationType);</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;        if (!config.isChangeOriginatorToRelatedEntity()) {</b>
<b class="nc">&nbsp;            withCallback(createRelationResultFuture,</b>
&nbsp;                    relationCreated -&gt; {
<b class="nc">&nbsp;                        if (relationCreated) {</b>
<b class="nc">&nbsp;                            ctx.tellSuccess(msg);</b>
&nbsp;                            return;
&nbsp;                        }
<b class="nc">&nbsp;                        ctx.tellFailure(msg, new RuntimeException(&quot;Failed to create originator relation with target entity!&quot;));</b>
&nbsp;                    },
<b class="nc">&nbsp;                    t -&gt; ctx.tellFailure(msg, t), MoreExecutors.directExecutor());</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        withCallback(Futures.allAsList(targetEntityIdFuture, createRelationResultFuture), result -&gt; {</b>
<b class="nc">&nbsp;            var targetEntityId = (EntityId) result.get(0);</b>
<b class="nc">&nbsp;            var relationCreated = (Boolean) result.get(1);</b>
<b class="nc">&nbsp;            if (relationCreated) {</b>
<b class="nc">&nbsp;                var transformedMsg = ctx.transformMsgOriginator(msg, targetEntityId);</b>
<b class="nc">&nbsp;                ctx.tellSuccess(transformedMsg);</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            ctx.tellFailure(msg, new RuntimeException(&quot;Failed to create originator relation with target entity!&quot;));</b>
<b class="nc">&nbsp;        }, t -&gt; ctx.tellFailure(msg, t), MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Boolean&gt; checkRelationAndCreateIfAbsent(TbContext ctx, EntityId originator, EntityId targetEntityId, String relationType) {
&nbsp;        EntityId fromId;
&nbsp;        EntityId toId;
<b class="nc">&nbsp;        if (EntitySearchDirection.FROM.equals(config.getDirection())) {</b>
<b class="nc">&nbsp;            fromId = originator;</b>
<b class="nc">&nbsp;            toId = targetEntityId;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            toId = originator;</b>
<b class="nc">&nbsp;            fromId = targetEntityId;</b>
&nbsp;        }
<b class="nc">&nbsp;        var checkRelationFuture = ctx.getRelationService().checkRelationAsync(ctx.getTenantId(), fromId, toId, relationType, RelationTypeGroup.COMMON);</b>
<b class="nc">&nbsp;        return Futures.transformAsync(checkRelationFuture, relationExists -&gt;</b>
<b class="nc">&nbsp;                        relationExists ?</b>
<b class="nc">&nbsp;                                Futures.immediateFuture(true) :</b>
<b class="nc">&nbsp;                                ctx.getRelationService().</b>
<b class="nc">&nbsp;                                        saveRelationAsync(ctx.getTenantId(), new EntityRelation(fromId, toId, relationType, RelationTypeGroup.COMMON)),</b>
<b class="nc">&nbsp;                MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

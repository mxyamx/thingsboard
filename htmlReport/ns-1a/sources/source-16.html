<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbSaveToCustomCassandraTableNode</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.action</a>
</div>

<h1>Coverage Summary for Class: TbSaveToCustomCassandraTableNode (org.thingsboard.rule.engine.action)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbSaveToCustomCassandraTableNode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/89)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.action;
&nbsp;
&nbsp;import com.datastax.oss.driver.api.core.ConsistencyLevel;
&nbsp;import com.datastax.oss.driver.api.core.cql.BoundStatement;
&nbsp;import com.datastax.oss.driver.api.core.cql.BoundStatementBuilder;
&nbsp;import com.datastax.oss.driver.api.core.cql.PreparedStatement;
&nbsp;import com.datastax.oss.driver.api.core.cql.Statement;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.gson.JsonElement;
&nbsp;import com.google.gson.JsonObject;
&nbsp;import com.google.gson.JsonParser;
&nbsp;import com.google.gson.JsonPrimitive;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.rule.engine.api.RuleNode;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.api.TbNode;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeConfiguration;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeException;
&nbsp;import org.thingsboard.rule.engine.api.util.TbNodeUtils;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentType;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainType;
&nbsp;import org.thingsboard.server.common.data.util.TbPair;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.dao.cassandra.CassandraCluster;
&nbsp;import org.thingsboard.server.dao.cassandra.guava.GuavaSession;
&nbsp;import org.thingsboard.server.dao.nosql.CassandraStatementTask;
&nbsp;import org.thingsboard.server.dao.nosql.TbResultSetFuture;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;
&nbsp;import static org.thingsboard.common.util.DonAsynchron.withCallback;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RuleNode(
&nbsp;        type = ComponentType.ACTION,
&nbsp;        name = &quot;save to custom table&quot;,
&nbsp;        configClazz = TbSaveToCustomCassandraTableNodeConfiguration.class,
&nbsp;        version = 1,
&nbsp;        nodeDescription = &quot;Node stores data from incoming Message payload to the Cassandra database into the predefined custom table&quot; +
&nbsp;                &quot; that should have &lt;b&gt;cs_tb_&lt;/b&gt; prefix, to avoid the data insertion to the common TB tables.&lt;br&gt;&quot; +
&nbsp;                &quot;&lt;b&gt;Note:&lt;/b&gt; rule node can be used only for Cassandra DB.&quot;,
&nbsp;        nodeDetails = &quot;Administrator should set the custom table name without prefix: &lt;b&gt;cs_tb_&lt;/b&gt;. &lt;br&gt;&quot; +
&nbsp;                &quot;Administrator can configure the mapping between the Message field names and Table columns name.&lt;br&gt;&quot; +
&nbsp;                &quot;&lt;b&gt;Note:&lt;/b&gt;If the mapping key is &lt;b&gt;$entity_id&lt;/b&gt;, that is identified by the Message Originator, then to the appropriate column name(mapping value) will be write the message originator id.&lt;br&gt;&lt;br&gt;&quot; +
&nbsp;                &quot;If specified message field does not exist or is not a JSON Primitive, the outbound message will be routed via &lt;b&gt;failure&lt;/b&gt; chain,&quot; +
&nbsp;                &quot; otherwise, the message will be routed via &lt;b&gt;success&lt;/b&gt; chain.&quot;,
&nbsp;        configDirective = &quot;tbActionNodeCustomTableConfig&quot;,
&nbsp;        icon = &quot;file_upload&quot;,
&nbsp;        ruleChainTypes = RuleChainType.CORE,
&nbsp;        docUrl = &quot;https://thingsboard.io/docs/user-guide/rule-engine-2-0/nodes/action/save-to-custom-table/&quot;
&nbsp;)
<b class="nc">&nbsp;public class TbSaveToCustomCassandraTableNode implements TbNode {</b>
&nbsp;
&nbsp;    private static final String TABLE_PREFIX = &quot;cs_tb_&quot;;
&nbsp;    private static final String ENTITY_ID = &quot;$entityId&quot;;
&nbsp;
&nbsp;    private TbSaveToCustomCassandraTableNodeConfiguration config;
&nbsp;    private GuavaSession session;
&nbsp;    private CassandraCluster cassandraCluster;
&nbsp;    private ConsistencyLevel defaultWriteLevel;
&nbsp;    private PreparedStatement saveStmt;
&nbsp;    private Map&lt;String, String&gt; fieldsMap;
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbContext ctx, TbNodeConfiguration configuration) throws TbNodeException {
<b class="nc">&nbsp;        config = TbNodeUtils.convert(configuration, TbSaveToCustomCassandraTableNodeConfiguration.class);</b>
<b class="nc">&nbsp;        cassandraCluster = ctx.getCassandraCluster();</b>
<b class="nc">&nbsp;        if (cassandraCluster == null) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;Unable to connect to Cassandra database&quot;, true);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!isTableExists()) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;Table &#39;&quot; + TABLE_PREFIX + config.getTableName() + &quot;&#39; does not exist in Cassandra cluster.&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        saveStmt = getSaveStmt();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onMsg(TbContext ctx, TbMsg msg) {
<b class="nc">&nbsp;        withCallback(save(msg, ctx), success -&gt; ctx.tellSuccess(msg), e -&gt; ctx.tellFailure(msg, e), ctx.getDbCallbackExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        saveStmt = null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isTableExists() {
<b class="nc">&nbsp;        var keyspaceMdOpt = getSession().getMetadata().getKeyspace(cassandraCluster.getKeyspaceName());</b>
<b class="nc">&nbsp;        return keyspaceMdOpt.map(keyspaceMetadata -&gt;</b>
<b class="nc">&nbsp;                keyspaceMetadata.getTable(TABLE_PREFIX + config.getTableName()).isPresent()).orElse(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private PreparedStatement prepare(String query) {
<b class="nc">&nbsp;        return getSession().prepare(query);</b>
&nbsp;    }
&nbsp;
&nbsp;    private GuavaSession getSession() {
<b class="nc">&nbsp;        if (session == null) {</b>
<b class="nc">&nbsp;            session = cassandraCluster.getSession();</b>
<b class="nc">&nbsp;            defaultWriteLevel = cassandraCluster.getDefaultWriteConsistencyLevel();</b>
&nbsp;        }
<b class="nc">&nbsp;        return session;</b>
&nbsp;    }
&nbsp;
&nbsp;    private PreparedStatement getSaveStmt() throws TbNodeException {
<b class="nc">&nbsp;        fieldsMap = config.getFieldsMapping();</b>
<b class="nc">&nbsp;        if (fieldsMap.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;Fields(key,value) map is empty!&quot;, true);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return prepareStatement(new ArrayList&lt;&gt;(fieldsMap.values()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private PreparedStatement prepareStatement(List&lt;String&gt; fieldsList) {
<b class="nc">&nbsp;        return prepare(createQuery(fieldsList));</b>
&nbsp;    }
&nbsp;
&nbsp;    private String createQuery(List&lt;String&gt; fieldsList) {
<b class="nc">&nbsp;        int size = fieldsList.size();</b>
<b class="nc">&nbsp;        StringBuilder query = new StringBuilder();</b>
<b class="nc">&nbsp;        query.append(&quot;INSERT INTO &quot;)</b>
<b class="nc">&nbsp;                .append(TABLE_PREFIX)</b>
<b class="nc">&nbsp;                .append(config.getTableName())</b>
<b class="nc">&nbsp;                .append(&quot;(&quot;);</b>
<b class="nc">&nbsp;        for (String field : fieldsList) {</b>
<b class="nc">&nbsp;            query.append(field);</b>
<b class="nc">&nbsp;            if (fieldsList.get(size - 1).equals(field)) {</b>
<b class="nc">&nbsp;                query.append(&quot;)&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                query.append(&quot;,&quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        query.append(&quot; VALUES(&quot;);</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; size; i++) {</b>
<b class="nc">&nbsp;            if (i == size - 1) {</b>
<b class="nc">&nbsp;                query.append(&quot;?)&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                query.append(&quot;?, &quot;);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (config.getDefaultTtl() &gt; 0) {</b>
<b class="nc">&nbsp;            query.append(&quot; USING TTL ?&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return query.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbResultSetFuture save(TbMsg msg, TbContext ctx) {
<b class="nc">&nbsp;        JsonElement data = JsonParser.parseString(msg.getData());</b>
<b class="nc">&nbsp;        if (!data.isJsonObject()) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Invalid message structure, it is not a JSON Object: &quot; + data);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            JsonObject dataAsObject = data.getAsJsonObject();</b>
<b class="nc">&nbsp;            BoundStatementBuilder stmtBuilder = getStmtBuilder();</b>
<b class="nc">&nbsp;            AtomicInteger i = new AtomicInteger(0);</b>
<b class="nc">&nbsp;            fieldsMap.forEach((key, value) -&gt; {</b>
<b class="nc">&nbsp;                if (key.equals(ENTITY_ID)) {</b>
<b class="nc">&nbsp;                    stmtBuilder.setUuid(i.get(), msg.getOriginator().getId());</b>
<b class="nc">&nbsp;                } else if (dataAsObject.has(key)) {</b>
<b class="nc">&nbsp;                    JsonElement dataKeyElement = dataAsObject.get(key);</b>
<b class="nc">&nbsp;                    if (dataKeyElement.isJsonPrimitive()) {</b>
<b class="nc">&nbsp;                        JsonPrimitive primitive = dataKeyElement.getAsJsonPrimitive();</b>
<b class="nc">&nbsp;                        if (primitive.isNumber()) {</b>
<b class="nc">&nbsp;                            if (primitive.getAsString().contains(&quot;.&quot;)) {</b>
<b class="nc">&nbsp;                                stmtBuilder.setDouble(i.get(), primitive.getAsDouble());</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                stmtBuilder.setLong(i.get(), primitive.getAsLong());</b>
&nbsp;                            }
<b class="nc">&nbsp;                        } else if (primitive.isBoolean()) {</b>
<b class="nc">&nbsp;                            stmtBuilder.setBoolean(i.get(), primitive.getAsBoolean());</b>
<b class="nc">&nbsp;                        } else if (primitive.isString()) {</b>
<b class="nc">&nbsp;                            stmtBuilder.setString(i.get(), primitive.getAsString());</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            stmtBuilder.setToNull(i.get());</b>
&nbsp;                        }
<b class="nc">&nbsp;                    } else if (dataKeyElement.isJsonObject()) {</b>
<b class="nc">&nbsp;                        stmtBuilder.setString(i.get(), dataKeyElement.getAsJsonObject().toString());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        throw new IllegalStateException(&quot;Message data key: &#39;&quot; + key + &quot;&#39; with value: &#39;&quot; + dataKeyElement + &quot;&#39; is not a JSON Object or JSON Primitive!&quot;);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    throw new RuntimeException(&quot;Message data doesn&#39;t contain key: &quot; + &quot;&#39;&quot; + key + &quot;&#39;!&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                i.getAndIncrement();</b>
&nbsp;            });
<b class="nc">&nbsp;            if (config.getDefaultTtl() &gt; 0) {</b>
<b class="nc">&nbsp;                stmtBuilder.setInt(i.get(), config.getDefaultTtl());</b>
&nbsp;            }
<b class="nc">&nbsp;            return executeAsyncWrite(ctx, stmtBuilder.build());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    BoundStatementBuilder getStmtBuilder() {
<b class="nc">&nbsp;        return new BoundStatementBuilder(saveStmt.bind());</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbResultSetFuture executeAsyncWrite(TbContext ctx, Statement statement) {
<b class="nc">&nbsp;        return executeAsync(ctx, statement, defaultWriteLevel);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbResultSetFuture executeAsync(TbContext ctx, Statement statement, ConsistencyLevel level) {
<b class="nc">&nbsp;        if (log.isDebugEnabled()) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Execute cassandra async statement {}&quot;, statementToString(statement));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (statement.getConsistencyLevel() == null) {</b>
<b class="nc">&nbsp;            statement.setConsistencyLevel(level);</b>
&nbsp;        }
<b class="nc">&nbsp;        return ctx.submitCassandraWriteTask(new CassandraStatementTask(ctx.getTenantId(), getSession(), statement));</b>
&nbsp;    }
&nbsp;
&nbsp;    private static String statementToString(Statement statement) {
<b class="nc">&nbsp;        if (statement instanceof BoundStatement) {</b>
<b class="nc">&nbsp;            return ((BoundStatement) statement).getPreparedStatement().getQuery();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return statement.toString();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbPair&lt;Boolean, JsonNode&gt; upgrade(int fromVersion, JsonNode oldConfiguration) throws TbNodeException {
<b class="nc">&nbsp;        boolean hasChanges = false;</b>
<b class="nc">&nbsp;        switch (fromVersion) {</b>
&nbsp;            case 0:
<b class="nc">&nbsp;                if (!oldConfiguration.has(&quot;defaultTtl&quot;)) {</b>
<b class="nc">&nbsp;                    hasChanges = true;</b>
<b class="nc">&nbsp;                    ((ObjectNode) oldConfiguration).put(&quot;defaultTtl&quot;, 0);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            default:
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return new TbPair&lt;&gt;(hasChanges, oldConfiguration);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

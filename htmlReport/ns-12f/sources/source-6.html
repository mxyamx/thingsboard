<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ImageUtils</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.util</a>
</div>

<h1>Coverage Summary for Class: ImageUtils (org.thingsboard.server.dao.util)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ImageUtils</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/201)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ImageUtils$ProcessedImage</td>
  </tr>
  <tr>
    <td class="name">ImageUtils$ScadaSymbolMetadataInfo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/90)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/220)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.util;
&nbsp;
&nbsp;import com.drew.imaging.ImageMetadataReader;
&nbsp;import com.drew.metadata.Directory;
&nbsp;import com.drew.metadata.Metadata;
&nbsp;import com.drew.metadata.Tag;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ArrayNode;
&nbsp;import com.github.weisj.jsvg.SVGDocument;
&nbsp;import com.github.weisj.jsvg.SVGRenderingHints;
&nbsp;import com.github.weisj.jsvg.attributes.ViewBox;
&nbsp;import com.github.weisj.jsvg.geometry.size.FloatSize;
&nbsp;import com.github.weisj.jsvg.parser.DefaultParserProvider;
&nbsp;import com.github.weisj.jsvg.parser.LoaderContext;
&nbsp;import com.github.weisj.jsvg.parser.SVGLoader;
&nbsp;import lombok.AccessLevel;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.Data;
&nbsp;import lombok.NoArgsConstructor;
&nbsp;import lombok.With;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.exception.ExceptionUtils;
&nbsp;import org.springframework.util.MimeType;
&nbsp;import org.springframework.util.MimeTypeUtils;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;
&nbsp;import javax.imageio.IIOImage;
&nbsp;import javax.imageio.ImageIO;
&nbsp;import javax.imageio.ImageTypeSpecifier;
&nbsp;import javax.imageio.ImageWriteParam;
&nbsp;import javax.imageio.ImageWriter;
&nbsp;import java.awt.*;
&nbsp;import java.awt.image.BufferedImage;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.io.ByteArrayOutputStream;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.Base64;
&nbsp;import java.util.Map;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;@NoArgsConstructor(access = AccessLevel.PRIVATE)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class ImageUtils {
&nbsp;
<b class="nc">&nbsp;    private static final Map&lt;String, String&gt; mediaTypeMappings = Map.of(</b>
&nbsp;            &quot;jpeg&quot;, &quot;jpg&quot;,
&nbsp;            &quot;svg+xml&quot;, &quot;svg&quot;,
&nbsp;            &quot;x-icon&quot;, &quot;ico&quot;
&nbsp;    );
&nbsp;
&nbsp;    public static String mediaTypeToFileExtension(String mimeType) {
<b class="nc">&nbsp;        String subtype = MimeTypeUtils.parseMimeType(mimeType).getSubtype();</b>
<b class="nc">&nbsp;        return mediaTypeMappings.getOrDefault(subtype, subtype);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String fileExtensionToMediaType(String extension) {
<b class="nc">&nbsp;        String subtype = mediaTypeMappings.entrySet().stream()</b>
<b class="nc">&nbsp;                .filter(mapping -&gt; mapping.getValue().equals(extension))</b>
<b class="nc">&nbsp;                .map(Map.Entry::getKey).findFirst().orElse(extension);</b>
<b class="nc">&nbsp;        return new MimeType(&quot;image&quot;, subtype).toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ProcessedImage processImage(byte[] data, String mediaType, int thumbnailMaxDimension) throws Exception {
<b class="nc">&nbsp;        if (mediaTypeToFileExtension(mediaType).equals(&quot;svg&quot;)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                return processSvgImage(data, mediaType, thumbnailMaxDimension);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                if (log.isDebugEnabled()) { // printing stacktrace</b>
<b class="nc">&nbsp;                    log.warn(&quot;Couldn&#39;t process SVG image, leaving preview as original image&quot;, e);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.warn(&quot;Couldn&#39;t process SVG image, leaving preview as original image: {}&quot;, ExceptionUtils.getMessage(e));</b>
&nbsp;                }
<b class="nc">&nbsp;                return previewAsOriginalImage(data, mediaType);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        BufferedImage bufferedImage = null;</b>
&nbsp;        try {
<b class="nc">&nbsp;            bufferedImage = ImageIO.read(new ByteArrayInputStream(data));</b>
&nbsp;        } catch (Exception ignored) {
&nbsp;        }
<b class="nc">&nbsp;        if (bufferedImage == null) { // means that media type is not supported by ImageIO; extracting width and height from metadata and leaving preview as original image</b>
<b class="nc">&nbsp;            Metadata metadata = ImageMetadataReader.readMetadata(new ByteArrayInputStream(data));</b>
<b class="nc">&nbsp;            ProcessedImage image = previewAsOriginalImage(data, mediaType);</b>
<b class="nc">&nbsp;            String dirName = &quot;Unknown&quot;;</b>
<b class="nc">&nbsp;            for (Directory dir : metadata.getDirectories()) {</b>
<b class="nc">&nbsp;                Tag widthTag = dir.getTags().stream()</b>
<b class="nc">&nbsp;                        .filter(tag -&gt; tag.getTagName().toLowerCase().contains(&quot;width&quot;))</b>
<b class="nc">&nbsp;                        .findFirst().orElse(null);</b>
<b class="nc">&nbsp;                Tag heightTag = dir.getTags().stream()</b>
<b class="nc">&nbsp;                        .filter(tag -&gt; tag.getTagName().toLowerCase().contains(&quot;height&quot;))</b>
<b class="nc">&nbsp;                        .findFirst().orElse(null);</b>
<b class="nc">&nbsp;                if (widthTag == null || heightTag == null) {</b>
&nbsp;                    continue;
&nbsp;                }
<b class="nc">&nbsp;                int width = Integer.parseInt(dir.getObject(widthTag.getTagType()).toString());</b>
<b class="nc">&nbsp;                int height = Integer.parseInt(dir.getObject(heightTag.getTagType()).toString());</b>
<b class="nc">&nbsp;                image.setWidth(width);</b>
<b class="nc">&nbsp;                image.setHeight(height);</b>
<b class="nc">&nbsp;                image.getPreview().setWidth(width);</b>
<b class="nc">&nbsp;                image.getPreview().setHeight(height);</b>
<b class="nc">&nbsp;                dirName = dir.getName();</b>
&nbsp;                break;
&nbsp;            }
<b class="nc">&nbsp;            log.warn(&quot;Couldn&#39;t process {} ({}) with ImageIO, leaving preview as original image&quot;, mediaType, dirName);</b>
<b class="nc">&nbsp;            return image;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ProcessedImage image = new ProcessedImage();</b>
<b class="nc">&nbsp;        image.setMediaType(mediaType);</b>
<b class="nc">&nbsp;        image.setData(data);</b>
<b class="nc">&nbsp;        image.setSize(data.length);</b>
<b class="nc">&nbsp;        image.setWidth(bufferedImage.getWidth());</b>
<b class="nc">&nbsp;        image.setHeight(bufferedImage.getHeight());</b>
&nbsp;
<b class="nc">&nbsp;        ProcessedImage preview = new ProcessedImage();</b>
<b class="nc">&nbsp;        int[] thumbnailDimensions = getThumbnailDimensions(image.getWidth(), image.getHeight(), thumbnailMaxDimension, true);</b>
<b class="nc">&nbsp;        preview.setWidth(thumbnailDimensions[0]);</b>
<b class="nc">&nbsp;        preview.setHeight(thumbnailDimensions[1]);</b>
&nbsp;
<b class="nc">&nbsp;        if (preview.getWidth() == image.getWidth() &amp;&amp; preview.getHeight() == image.getHeight()) {</b>
<b class="nc">&nbsp;            if (mediaType.equals(&quot;image/png&quot;)) {</b>
<b class="nc">&nbsp;                preview.setMediaType(mediaType);</b>
<b class="nc">&nbsp;                preview.setData(null);</b>
<b class="nc">&nbsp;                preview.setSize(data.length);</b>
<b class="nc">&nbsp;                image.setPreview(preview);</b>
<b class="nc">&nbsp;                return image;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        BufferedImage thumbnail = new BufferedImage(preview.getWidth(), preview.getHeight(), BufferedImage.TYPE_INT_ARGB);</b>
<b class="nc">&nbsp;        thumbnail.getGraphics().drawImage(bufferedImage, 0, 0, preview.getWidth(), preview.getHeight(), null);</b>
&nbsp;
<b class="nc">&nbsp;        byte[] pngThumbnail = toCompressedPngData(thumbnail);</b>
&nbsp;
<b class="nc">&nbsp;        preview.setMediaType(&quot;image/png&quot;);</b>
<b class="nc">&nbsp;        preview.setData(pngThumbnail);</b>
<b class="nc">&nbsp;        preview.setSize(pngThumbnail.length);</b>
<b class="nc">&nbsp;        image.setPreview(preview);</b>
<b class="nc">&nbsp;        return image;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ProcessedImage processSvgImage(byte[] data, String mediaType, int thumbnailMaxDimension) throws Exception {
<b class="nc">&nbsp;        var imageData = removeScadaSymbolMetadata(data);</b>
&nbsp;
<b class="nc">&nbsp;        SVGLoader loader = new SVGLoader();</b>
<b class="nc">&nbsp;        SVGDocument svgDocument = loader.load(new ByteArrayInputStream(imageData), null, LoaderContext.builder()</b>
<b class="nc">&nbsp;                .parserProvider(new DefaultParserProvider())</b>
<b class="nc">&nbsp;                .build());</b>
&nbsp;
<b class="nc">&nbsp;        Integer width = null;</b>
<b class="nc">&nbsp;        Integer height = null;</b>
<b class="nc">&nbsp;        if (svgDocument != null) {</b>
<b class="nc">&nbsp;            FloatSize imageSize = svgDocument.size();</b>
<b class="nc">&nbsp;            width = (int) imageSize.width;</b>
<b class="nc">&nbsp;            height = (int) imageSize.height;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ProcessedImage image = new ProcessedImage();</b>
<b class="nc">&nbsp;        image.setMediaType(mediaType);</b>
<b class="nc">&nbsp;        image.setWidth(width == null ? 0 : width);</b>
<b class="nc">&nbsp;        image.setHeight(height == null ? 0 : height);</b>
<b class="nc">&nbsp;        image.setData(data);</b>
<b class="nc">&nbsp;        image.setSize(data.length);</b>
&nbsp;
<b class="nc">&nbsp;        if (imageData.length &lt; 10240 || svgDocument == null) { // if SVG is smaller than 10kB (average 250x250 PNG preview size)</b>
<b class="nc">&nbsp;            return withPreviewAsOriginalImage(image, imageData);</b>
<b class="nc">&nbsp;        } else if (image.getSize() &gt; 102400 &amp;&amp; image.getWidth() != 0) { // considering SVG image detailed after 100kB</b>
<b class="nc">&nbsp;            thumbnailMaxDimension = 512;</b>
&nbsp;        }
<b class="nc">&nbsp;        ProcessedImage preview = new ProcessedImage();</b>
<b class="nc">&nbsp;        int[] thumbnailDimensions = getThumbnailDimensions(image.getWidth(), image.getHeight(), thumbnailMaxDimension, false);</b>
<b class="nc">&nbsp;        preview.setWidth(thumbnailDimensions[0]);</b>
<b class="nc">&nbsp;        preview.setHeight(thumbnailDimensions[1]);</b>
&nbsp;
<b class="nc">&nbsp;        BufferedImage thumbnail = new BufferedImage(preview.getWidth(), preview.getHeight(), BufferedImage.TYPE_INT_ARGB);</b>
<b class="nc">&nbsp;        Graphics2D graphics = thumbnail.createGraphics();</b>
<b class="nc">&nbsp;        graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</b>
<b class="nc">&nbsp;        graphics.setRenderingHint(RenderingHints.KEY_STROKE_CONTROL, RenderingHints.VALUE_STROKE_PURE);</b>
<b class="nc">&nbsp;        graphics.setRenderingHint(SVGRenderingHints.KEY_IMAGE_ANTIALIASING, SVGRenderingHints.VALUE_IMAGE_ANTIALIASING_ON);</b>
<b class="nc">&nbsp;        graphics.setRenderingHint(SVGRenderingHints.KEY_SOFT_CLIPPING, SVGRenderingHints.VALUE_SOFT_CLIPPING_ON);</b>
<b class="nc">&nbsp;        svgDocument.render((Component)null,graphics, new ViewBox(0, 0, preview.getWidth(), preview.getHeight()));</b>
<b class="nc">&nbsp;        graphics.dispose();</b>
&nbsp;
<b class="nc">&nbsp;        byte[] pngThumbnail = toCompressedPngData(thumbnail);</b>
&nbsp;
<b class="nc">&nbsp;        if (imageData.length &lt; pngThumbnail.length) { // set preview as original SVG if PNG thumbnail size is greater</b>
<b class="nc">&nbsp;            return withPreviewAsOriginalImage(image, imageData);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        preview.setMediaType(&quot;image/png&quot;);</b>
<b class="nc">&nbsp;        preview.setData(pngThumbnail);</b>
<b class="nc">&nbsp;        preview.setSize(pngThumbnail.length);</b>
<b class="nc">&nbsp;        image.setPreview(preview);</b>
<b class="nc">&nbsp;        return image;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static byte[] toCompressedPngData(BufferedImage image) throws Exception {
<b class="nc">&nbsp;        ByteArrayOutputStream out = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;        ImageTypeSpecifier type = ImageTypeSpecifier.createFromRenderedImage(image);</b>
<b class="nc">&nbsp;        ImageWriter writer = ImageIO.getImageWriters(type, &quot;png&quot;).next();</b>
<b class="nc">&nbsp;        ImageWriteParam param = writer.getDefaultWriteParam();</b>
<b class="nc">&nbsp;        if (param.canWriteCompressed()) {</b>
<b class="nc">&nbsp;            param.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);</b>
<b class="nc">&nbsp;            param.setCompressionQuality(0.0f);</b>
&nbsp;        }
<b class="nc">&nbsp;        var output = ImageIO.createImageOutputStream(out);</b>
<b class="nc">&nbsp;        writer.setOutput(output);</b>
&nbsp;        try {
<b class="nc">&nbsp;            writer.write(null, new IIOImage(image, null, null), param);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            writer.dispose();</b>
<b class="nc">&nbsp;            output.flush();</b>
&nbsp;        }
<b class="nc">&nbsp;        return out.toByteArray();</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private static ProcessedImage previewAsOriginalImage(byte[] data, String mediaType) {
<b class="nc">&nbsp;        ProcessedImage image = new ProcessedImage();</b>
<b class="nc">&nbsp;        image.setMediaType(mediaType);</b>
<b class="nc">&nbsp;        image.setData(data);</b>
<b class="nc">&nbsp;        image.setSize(data.length);</b>
<b class="nc">&nbsp;        image.setWidth(0);</b>
<b class="nc">&nbsp;        image.setHeight(0);</b>
<b class="nc">&nbsp;        return withPreviewAsOriginalImage(image);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ProcessedImage withPreviewAsOriginalImage(ProcessedImage originalImage) {
<b class="nc">&nbsp;        return withPreviewAsOriginalImage(originalImage, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ProcessedImage withPreviewAsOriginalImage(ProcessedImage originalImage, byte[] previewData) {
<b class="nc">&nbsp;        originalImage.setPreview(originalImage.withData(previewData));</b>
<b class="nc">&nbsp;        if (previewData != null) {</b>
<b class="nc">&nbsp;            originalImage.getPreview().setSize(previewData.length);</b>
&nbsp;        }
<b class="nc">&nbsp;        return originalImage;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ScadaSymbolMetadataInfo processScadaSymbolMetadata(String fileName, byte[] data) throws Exception {
<b class="nc">&nbsp;        JsonNode metaData = null;</b>
<b class="nc">&nbsp;        String contents = new String(data, StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;        var matcher = Pattern.compile(&quot;(?s)&lt;tb:metadata[^&gt;]*&gt;&lt;!\\[CDATA\\[(.*)]]&gt;&lt;\\/tb:metadata&gt;&quot;).matcher(contents);</b>
<b class="nc">&nbsp;        if (matcher.find()) {</b>
<b class="nc">&nbsp;            var metadataContent = matcher.group(1);</b>
<b class="nc">&nbsp;            metaData = JacksonUtil.toJsonNode(metadataContent);</b>
&nbsp;        }
<b class="nc">&nbsp;        return new ScadaSymbolMetadataInfo(fileName, metaData);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static byte[] removeScadaSymbolMetadata(byte[] data) {
<b class="nc">&nbsp;        String contents = new String(data, StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;        contents = contents.replaceFirst(&quot;(?s)&lt;tb:metadata[^&gt;]*&gt;.*&lt;\\/tb:metadata&gt;&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        return contents.getBytes(StandardCharsets.UTF_8);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static int[] getThumbnailDimensions(int originalWidth, int originalHeight, int maxDimension, boolean originalIfSmaller) {
<b class="nc">&nbsp;        if (originalWidth &lt;= maxDimension &amp;&amp; originalHeight &lt;= maxDimension &amp;&amp; originalIfSmaller) {</b>
<b class="nc">&nbsp;            return new int[]{originalWidth, originalHeight};</b>
&nbsp;        }
&nbsp;        int thumbnailWidth;
&nbsp;        int thumbnailHeight;
<b class="nc">&nbsp;        double aspectRatio = (double) originalWidth / originalHeight;</b>
<b class="nc">&nbsp;        if (originalWidth &gt; originalHeight) {</b>
<b class="nc">&nbsp;            thumbnailWidth = maxDimension;</b>
<b class="nc">&nbsp;            thumbnailHeight = (int) (maxDimension / aspectRatio);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            thumbnailWidth = (int) (maxDimension * aspectRatio);</b>
<b class="nc">&nbsp;            thumbnailHeight = maxDimension;</b>
&nbsp;        }
<b class="nc">&nbsp;        return new int[]{thumbnailWidth, thumbnailHeight};</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String getEmbeddedBase64EncodedImg(String colorStr) {
&nbsp;        try {
<b class="nc">&nbsp;            Color color = parseColor(colorStr); // Support for hex, rgb, hsla</b>
<b class="nc">&nbsp;            BufferedImage image = new BufferedImage(1, 1, BufferedImage.TYPE_INT_RGB);</b>
<b class="nc">&nbsp;            image.setRGB(0, 0, color.getRGB());</b>
&nbsp;
<b class="nc">&nbsp;            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;            ImageIO.write(image, &quot;png&quot;, outputStream);</b>
<b class="nc">&nbsp;            byte[] imageBytes = outputStream.toByteArray();</b>
<b class="nc">&nbsp;            String base64String = Base64.getEncoder().encodeToString(imageBytes);</b>
&nbsp;
<b class="nc">&nbsp;            return &quot;data:image/png;base64,&quot; + base64String;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;Failed to generate embedded image for color: {}&quot;, colorStr, e);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static Color parseColor(String colorStr) {
<b class="nc">&nbsp;        if (colorStr.startsWith(&quot;#&quot;)) {</b>
<b class="nc">&nbsp;            return Color.decode(colorStr);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (colorStr.startsWith(&quot;rgb&quot;)) {</b>
<b class="nc">&nbsp;            return parseRgbColor(colorStr);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (colorStr.startsWith(&quot;hsl&quot;)) {</b>
<b class="nc">&nbsp;            return parseHslaColor(colorStr);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        throw new IllegalArgumentException(&quot;Unsupported color format: &quot; + colorStr);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Color parseRgbColor(String rgb) {
<b class="nc">&nbsp;        String[] rgbValues = rgb.replaceAll(&quot;[^0-9,]&quot;, &quot;&quot;).split(&quot;,&quot;);</b>
<b class="nc">&nbsp;        int r = Integer.parseInt(rgbValues[0]);</b>
<b class="nc">&nbsp;        int g = Integer.parseInt(rgbValues[1]);</b>
<b class="nc">&nbsp;        int b = Integer.parseInt(rgbValues[2]);</b>
<b class="nc">&nbsp;        return new Color(r, g, b);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Color parseHslaColor(String hsla) {
<b class="nc">&nbsp;        String[] hslaValues = hsla.replaceAll(&quot;[^0-9.,]&quot;, &quot;&quot;).split(&quot;,&quot;);</b>
<b class="nc">&nbsp;        float h = Float.parseFloat(hslaValues[0]);</b>
<b class="nc">&nbsp;        float s = Float.parseFloat(hslaValues[1]) / 100;</b>
<b class="nc">&nbsp;        float l = Float.parseFloat(hslaValues[2]) / 100;</b>
<b class="nc">&nbsp;        float a = hslaValues.length &gt; 3 ? Float.parseFloat(hslaValues[3]) : 1.0f;</b>
<b class="nc">&nbsp;        return hslaToColor(h, s, l, a);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Color hslaToColor(float h, float s, float l, float alpha) {
<b class="nc">&nbsp;        float c = (1 - Math.abs(2 * l - 1)) * s;</b>
<b class="nc">&nbsp;        float x = c * (1 - Math.abs((h / 60) % 2 - 1));</b>
<b class="nc">&nbsp;        float m = l - c / 2;</b>
&nbsp;
<b class="nc">&nbsp;        float r = 0, g = 0, b = 0;</b>
<b class="nc">&nbsp;        if (h &lt; 60) {</b>
<b class="nc">&nbsp;            r = c;</b>
<b class="nc">&nbsp;            g = x;</b>
<b class="nc">&nbsp;        } else if (h &lt; 120) {</b>
<b class="nc">&nbsp;            r = x;</b>
<b class="nc">&nbsp;            g = c;</b>
<b class="nc">&nbsp;        } else if (h &lt; 180) {</b>
<b class="nc">&nbsp;            g = c;</b>
<b class="nc">&nbsp;            b = x;</b>
<b class="nc">&nbsp;        } else if (h &lt; 240) {</b>
<b class="nc">&nbsp;            g = x;</b>
<b class="nc">&nbsp;            b = c;</b>
<b class="nc">&nbsp;        } else if (h &lt; 300) {</b>
<b class="nc">&nbsp;            r = x;</b>
<b class="nc">&nbsp;            b = c;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            r = c;</b>
<b class="nc">&nbsp;            b = x;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        r += m;</b>
<b class="nc">&nbsp;        g += m;</b>
<b class="nc">&nbsp;        b += m;</b>
&nbsp;
<b class="nc">&nbsp;        return new Color(clamp(r), clamp(g), clamp(b), clamp(alpha));</b>
&nbsp;    }
&nbsp;
&nbsp;    private static float clamp(float value) {
<b class="nc">&nbsp;        return Math.max(0, Math.min(1, value));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Data
&nbsp;    @AllArgsConstructor
&nbsp;    @NoArgsConstructor
&nbsp;    public static class ProcessedImage {
&nbsp;        private String mediaType;
&nbsp;        private int width;
&nbsp;        private int height;
&nbsp;        @With
&nbsp;        private byte[] data;
&nbsp;        private long size;
&nbsp;        private ProcessedImage preview;
&nbsp;    }
&nbsp;
&nbsp;    @Data
&nbsp;    public static class ScadaSymbolMetadataInfo {
&nbsp;        private String title;
&nbsp;        private String description;
&nbsp;        private String[] searchTags;
&nbsp;        private int widgetSizeX;
&nbsp;        private int widgetSizeY;
&nbsp;
<b class="nc">&nbsp;        public ScadaSymbolMetadataInfo(String fileName, JsonNode metaData) {</b>
<b class="nc">&nbsp;            if (metaData != null &amp;&amp; metaData.has(&quot;title&quot;)) {</b>
<b class="nc">&nbsp;                title = metaData.get(&quot;title&quot;).asText();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                title = fileName;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (metaData != null &amp;&amp; metaData.has(&quot;description&quot;)) {</b>
<b class="nc">&nbsp;                description = metaData.get(&quot;description&quot;).asText();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                description = &quot;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (metaData != null &amp;&amp; metaData.has(&quot;searchTags&quot;) &amp;&amp; metaData.get(&quot;searchTags&quot;).isArray()) {</b>
<b class="nc">&nbsp;                var tagsNode = (ArrayNode) metaData.get(&quot;searchTags&quot;);</b>
<b class="nc">&nbsp;                searchTags = new String[tagsNode.size()];</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt; tagsNode.size(); i++) {</b>
<b class="nc">&nbsp;                    searchTags[i] = tagsNode.get(i).asText();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                searchTags = new String[0];</b>
&nbsp;            }
<b class="nc">&nbsp;            if (metaData != null &amp;&amp; metaData.has(&quot;widgetSizeX&quot;)) {</b>
<b class="nc">&nbsp;                widgetSizeX = metaData.get(&quot;widgetSizeX&quot;).asInt();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                widgetSizeX = 3;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (metaData != null &amp;&amp; metaData.has(&quot;widgetSizeY&quot;)) {</b>
<b class="nc">&nbsp;                widgetSizeY = metaData.get(&quot;widgetSizeY&quot;).asInt();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                widgetSizeY = 3;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

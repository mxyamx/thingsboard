<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AccessValidator</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.security</a>
</div>

<h1>Coverage Summary for Class: AccessValidator (org.thingsboard.server.service.security)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AccessValidator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/37)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/87)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/169)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AccessValidator$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccessValidator$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccessValidator$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AccessValidator$ThreeConsumer</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/87)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/177)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.security;
&nbsp;
&nbsp;import com.google.common.base.Function;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.springframework.web.context.request.async.DeferredResult;
&nbsp;import org.thingsboard.common.util.ThingsBoardThreadFactory;
&nbsp;import org.thingsboard.server.common.data.ApiUsageState;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.OtaPackageInfo;
&nbsp;import org.thingsboard.server.common.data.TbResourceInfo;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.asset.Asset;
&nbsp;import org.thingsboard.server.common.data.asset.AssetProfile;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.ApiUsageStateId;
&nbsp;import org.thingsboard.server.common.data.id.AssetId;
&nbsp;import org.thingsboard.server.common.data.id.AssetProfileId;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.id.EntityViewId;
&nbsp;import org.thingsboard.server.common.data.id.OtaPackageId;
&nbsp;import org.thingsboard.server.common.data.id.RpcId;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.RuleNodeId;
&nbsp;import org.thingsboard.server.common.data.id.TbResourceId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.rpc.Rpc;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChain;
&nbsp;import org.thingsboard.server.common.data.rule.RuleNode;
&nbsp;import org.thingsboard.server.controller.HttpValidationCallback;
&nbsp;import org.thingsboard.server.dao.alarm.AlarmService;
&nbsp;import org.thingsboard.server.dao.asset.AssetProfileService;
&nbsp;import org.thingsboard.server.dao.asset.AssetService;
&nbsp;import org.thingsboard.server.dao.customer.CustomerService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProfileService;
&nbsp;import org.thingsboard.server.dao.device.DeviceService;
&nbsp;import org.thingsboard.server.dao.edge.EdgeService;
&nbsp;import org.thingsboard.server.dao.entityview.EntityViewService;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.exception.IncorrectParameterException;
&nbsp;import org.thingsboard.server.dao.ota.OtaPackageService;
&nbsp;import org.thingsboard.server.dao.resource.ResourceService;
&nbsp;import org.thingsboard.server.dao.rpc.RpcService;
&nbsp;import org.thingsboard.server.dao.rule.RuleChainService;
&nbsp;import org.thingsboard.server.dao.tenant.TenantService;
&nbsp;import org.thingsboard.server.dao.usagerecord.ApiUsageStateService;
&nbsp;import org.thingsboard.server.dao.user.UserService;
&nbsp;import org.thingsboard.server.exception.ToErrorResponseEntity;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.permission.AccessControlService;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;import org.thingsboard.server.service.security.permission.Resource;
&nbsp;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.function.BiConsumer;
&nbsp;
&nbsp;/**
&nbsp; * Created by ashvayka on 27.03.18.
&nbsp; */
&nbsp;@Component
<b class="nc">&nbsp;public class AccessValidator {</b>
&nbsp;
&nbsp;    public static final String ONLY_SYSTEM_ADMINISTRATOR_IS_ALLOWED_TO_PERFORM_THIS_OPERATION = &quot;Only system administrator is allowed to perform this operation!&quot;;
&nbsp;    public static final String CUSTOMER_USER_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION = &quot;Customer user is not allowed to perform this operation!&quot;;
&nbsp;    public static final String SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION = &quot;System administrator is not allowed to perform this operation!&quot;;
&nbsp;    public static final String DEVICE_WITH_REQUESTED_ID_NOT_FOUND = &quot;Device with requested id wasn&#39;t found!&quot;;
&nbsp;    public static final String EDGE_WITH_REQUESTED_ID_NOT_FOUND = &quot;Edge with requested id wasn&#39;t found!&quot;;
&nbsp;    public static final String ENTITY_VIEW_WITH_REQUESTED_ID_NOT_FOUND = &quot;Entity-view with requested id wasn&#39;t found!&quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected TenantService tenantService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected CustomerService customerService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected UserService userService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected DeviceService deviceService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected DeviceProfileService deviceProfileService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected AssetProfileService assetProfileService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected AssetService assetService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected AlarmService alarmService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected RuleChainService ruleChainService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected EntityViewService entityViewService;
&nbsp;
&nbsp;    @Autowired(required = false)
&nbsp;    protected EdgeService edgeService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected AccessControlService accessControlService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected ApiUsageStateService apiUsageStateService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected ResourceService resourceService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected OtaPackageService otaPackageService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected RpcService rpcService;
&nbsp;
&nbsp;    private ExecutorService executor;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void initExecutor() {
<b class="nc">&nbsp;        executor = Executors.newSingleThreadExecutor(ThingsBoardThreadFactory.forName(&quot;access-validator&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    public void shutdownExecutor() {
<b class="nc">&nbsp;        if (executor != null) {</b>
<b class="nc">&nbsp;            executor.shutdownNow();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; validateEntityAndCallback(SecurityUser currentUser, Operation operation, String entityType, String entityIdStr,
&nbsp;                                                                    ThreeConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, TenantId, EntityId&gt; onSuccess) throws ThingsboardException {
<b class="nc">&nbsp;        return validateEntityAndCallback(currentUser, operation, entityType, entityIdStr, onSuccess, (result, t) -&gt; handleError(t, result, HttpStatus.INTERNAL_SERVER_ERROR));</b>
&nbsp;    }
&nbsp;
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; validateEntityAndCallback(SecurityUser currentUser, Operation operation, String entityType, String entityIdStr,
&nbsp;                                                                    ThreeConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, TenantId, EntityId&gt; onSuccess,
&nbsp;                                                                    BiConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, Throwable&gt; onFailure) throws ThingsboardException {
<b class="nc">&nbsp;        return validateEntityAndCallback(currentUser, operation, EntityIdFactory.getByTypeAndId(entityType, entityIdStr),</b>
&nbsp;                onSuccess, onFailure);
&nbsp;    }
&nbsp;
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; validateEntityAndCallback(SecurityUser currentUser, Operation operation, EntityId entityId,
&nbsp;                                                                    ThreeConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, TenantId, EntityId&gt; onSuccess) throws ThingsboardException {
<b class="nc">&nbsp;        return validateEntityAndCallback(currentUser, operation, entityId, onSuccess, (result, t) -&gt; handleError(t, result, HttpStatus.INTERNAL_SERVER_ERROR));</b>
&nbsp;    }
&nbsp;
&nbsp;    public DeferredResult&lt;ResponseEntity&gt; validateEntityAndCallback(SecurityUser currentUser, Operation operation, EntityId entityId,
&nbsp;                                                                    ThreeConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, TenantId, EntityId&gt; onSuccess,
&nbsp;                                                                    BiConsumer&lt;DeferredResult&lt;ResponseEntity&gt;, Throwable&gt; onFailure) throws ThingsboardException {
&nbsp;
<b class="nc">&nbsp;        final DeferredResult&lt;ResponseEntity&gt; response = new DeferredResult&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        validate(currentUser, operation, entityId, new HttpValidationCallback(response,</b>
<b class="nc">&nbsp;                new FutureCallback&lt;DeferredResult&lt;ResponseEntity&gt;&gt;() {</b>
&nbsp;                    @Override
&nbsp;                    public void onSuccess(@Nullable DeferredResult&lt;ResponseEntity&gt; result) {
&nbsp;                        try {
<b class="nc">&nbsp;                            onSuccess.accept(response, currentUser.getTenantId(), entityId);</b>
&nbsp;                        } catch (Exception e) {
<b class="nc">&nbsp;                            onFailure(e);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void onFailure(Throwable t) {
<b class="nc">&nbsp;                        onFailure.accept(response, t);</b>
&nbsp;                    }
&nbsp;                }));
&nbsp;
<b class="nc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void validate(SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        switch (entityId.getEntityType()) {</b>
<b class="nc">&nbsp;            case DEVICE -&gt; validateDevice(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case DEVICE_PROFILE -&gt; validateDeviceProfile(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case ASSET -&gt; validateAsset(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case ASSET_PROFILE -&gt; validateAssetProfile(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case RULE_CHAIN -&gt; validateRuleChain(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case CUSTOMER -&gt; validateCustomer(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case TENANT -&gt; validateTenant(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case TENANT_PROFILE -&gt; validateTenantProfile(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case USER -&gt; validateUser(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case ENTITY_VIEW -&gt; validateEntityView(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case EDGE -&gt; validateEdge(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case API_USAGE_STATE -&gt; validateApiUsageState(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case TB_RESOURCE -&gt; validateResource(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case OTA_PACKAGE -&gt; validateOtaPackage(currentUser, operation, entityId, callback);</b>
<b class="nc">&nbsp;            case RPC -&gt; validateRpc(currentUser, operation, entityId, callback);</b>
&nbsp;            default -&gt;
&nbsp;                //TODO: add support of other entities
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;Not Implemented!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateDevice(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Futures.addCallback(Futures.immediateFuture(deviceService.findDeviceById(currentUser.getTenantId(), new DeviceId(entityId.getId()))), getCallback(callback, device -&gt; {</b>
<b class="nc">&nbsp;                if (device == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(DEVICE_WITH_REQUESTED_ID_NOT_FOUND);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.DEVICE, operation, entityId, device);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(device);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateRpc(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        ListenableFuture&lt;Rpc&gt; rpcFurure = rpcService.findRpcByIdAsync(currentUser.getTenantId(), new RpcId(entityId.getId()));</b>
<b class="nc">&nbsp;        Futures.addCallback(rpcFurure, getCallback(callback, rpc -&gt; {</b>
<b class="nc">&nbsp;            if (rpc == null) {</b>
<b class="nc">&nbsp;                return ValidationResult.entityNotFound(&quot;Rpc with requested id wasn&#39;t found!&quot;);</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.RPC, operation, entityId, rpc);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                }
<b class="nc">&nbsp;                return ValidationResult.ok(rpc);</b>
&nbsp;            }
&nbsp;        }), executor);
&nbsp;    }
&nbsp;
&nbsp;    private void validateDeviceProfile(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            DeviceProfile deviceProfile = deviceProfileService.findDeviceProfileById(currentUser.getTenantId(), new DeviceProfileId(entityId.getId()));</b>
<b class="nc">&nbsp;            if (deviceProfile == null) {</b>
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.entityNotFound(&quot;Device profile with requested id wasn&#39;t found!&quot;));</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.DEVICE_PROFILE, operation, entityId, deviceProfile);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    callback.onSuccess(ValidationResult.accessDenied(e.getMessage()));</b>
&nbsp;                }
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.ok(deviceProfile));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateAssetProfile(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            AssetProfile assetProfile = assetProfileService.findAssetProfileById(currentUser.getTenantId(), new AssetProfileId(entityId.getId()));</b>
<b class="nc">&nbsp;            if (assetProfile == null) {</b>
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.entityNotFound(&quot;Asset profile with requested id wasn&#39;t found!&quot;));</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.ASSET_PROFILE, operation, entityId, assetProfile);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    callback.onSuccess(ValidationResult.accessDenied(e.getMessage()));</b>
&nbsp;                }
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.ok(assetProfile));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateApiUsageState(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            if (!operation.equals(Operation.READ_TELEMETRY)) {</b>
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.accessDenied(&quot;Allowed only READ_TELEMETRY operation!&quot;));</b>
&nbsp;            }
<b class="nc">&nbsp;            ApiUsageState apiUsageState = apiUsageStateService.findApiUsageStateById(currentUser.getTenantId(), new ApiUsageStateId(entityId.getId()));</b>
<b class="nc">&nbsp;            if (apiUsageState == null) {</b>
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.entityNotFound(&quot;Api Usage State with requested id wasn&#39;t found!&quot;));</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.API_USAGE_STATE, operation, entityId, apiUsageState);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    callback.onSuccess(ValidationResult.accessDenied(e.getMessage()));</b>
&nbsp;                }
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.ok(apiUsageState));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateOtaPackage(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            OtaPackageInfo otaPackage = otaPackageService.findOtaPackageInfoById(currentUser.getTenantId(), new OtaPackageId(entityId.getId()));</b>
<b class="nc">&nbsp;            if (otaPackage == null) {</b>
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.entityNotFound(&quot;OtaPackage with requested id wasn&#39;t found!&quot;));</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.OTA_PACKAGE, operation, entityId, otaPackage);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    callback.onSuccess(ValidationResult.accessDenied(e.getMessage()));</b>
&nbsp;                }
<b class="nc">&nbsp;                callback.onSuccess(ValidationResult.ok(otaPackage));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateResource(SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        ListenableFuture&lt;TbResourceInfo&gt; resourceFuture = resourceService.findResourceInfoByIdAsync(currentUser.getTenantId(), new TbResourceId(entityId.getId()));</b>
<b class="nc">&nbsp;        Futures.addCallback(resourceFuture, getCallback(callback, resource -&gt; {</b>
<b class="nc">&nbsp;            if (resource == null) {</b>
<b class="nc">&nbsp;                return ValidationResult.entityNotFound(&quot;Resource with requested id wasn&#39;t found!&quot;);</b>
&nbsp;            } else {
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.TB_RESOURCE, operation, entityId, resource);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                }
<b class="nc">&nbsp;                return ValidationResult.ok(resource);</b>
&nbsp;            }
&nbsp;        }), executor);
&nbsp;    }
&nbsp;
&nbsp;    private void validateAsset(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;Asset&gt; assetFuture = assetService.findAssetByIdAsync(currentUser.getTenantId(), new AssetId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(assetFuture, getCallback(callback, asset -&gt; {</b>
<b class="nc">&nbsp;                if (asset == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Asset with requested id wasn&#39;t found!&quot;);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.ASSET, operation, entityId, asset);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(asset);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateRuleChain(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isCustomerUser()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(CUSTOMER_USER_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;RuleChain&gt; ruleChainFuture = ruleChainService.findRuleChainByIdAsync(currentUser.getTenantId(), new RuleChainId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(ruleChainFuture, getCallback(callback, ruleChain -&gt; {</b>
<b class="nc">&nbsp;                if (ruleChain == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Rule chain with requested id wasn&#39;t found!&quot;);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.RULE_CHAIN, operation, entityId, ruleChain);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(ruleChain);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateRule(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isCustomerUser()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(CUSTOMER_USER_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;RuleNode&gt; ruleNodeFuture = ruleChainService.findRuleNodeByIdAsync(currentUser.getTenantId(), new RuleNodeId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(ruleNodeFuture, getCallback(callback, ruleNodeTmp -&gt; {</b>
<b class="nc">&nbsp;                RuleNode ruleNode = ruleNodeTmp;</b>
<b class="nc">&nbsp;                if (ruleNode == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Rule node with requested id wasn&#39;t found!&quot;);</b>
<b class="nc">&nbsp;                } else if (ruleNode.getRuleChainId() == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Rule chain with requested node id wasn&#39;t found!&quot;);</b>
&nbsp;                } else {
&nbsp;                    //TODO: make async
<b class="nc">&nbsp;                    RuleChain ruleChain = ruleChainService.findRuleChainById(currentUser.getTenantId(), ruleNode.getRuleChainId());</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.RULE_CHAIN, operation, ruleNode.getRuleChainId(), ruleChain);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(ruleNode);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateCustomer(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;Customer&gt; customerFuture = customerService.findCustomerByIdAsync(currentUser.getTenantId(), new CustomerId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(customerFuture, getCallback(callback, customer -&gt; {</b>
<b class="nc">&nbsp;                if (customer == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Customer with requested id wasn&#39;t found!&quot;);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.CUSTOMER, operation, entityId, customer);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(customer);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateTenant(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isCustomerUser()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(CUSTOMER_USER_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
<b class="nc">&nbsp;        } else if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.ok(null));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;Tenant&gt; tenantFuture = tenantService.findTenantByIdAsync(currentUser.getTenantId(), TenantId.fromUUID(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(tenantFuture, getCallback(callback, tenant -&gt; {</b>
<b class="nc">&nbsp;                if (tenant == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(&quot;Tenant with requested id wasn&#39;t found!&quot;);</b>
&nbsp;                }
&nbsp;                try {
<b class="nc">&nbsp;                    accessControlService.checkPermission(currentUser, Resource.TENANT, operation, entityId, tenant);</b>
&nbsp;                } catch (ThingsboardException e) {
<b class="nc">&nbsp;                    return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                }
<b class="nc">&nbsp;                return ValidationResult.ok(tenant);</b>
&nbsp;
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateTenantProfile(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.ok(null));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(ONLY_SYSTEM_ADMINISTRATOR_IS_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateUser(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        ListenableFuture&lt;User&gt; userFuture = userService.findUserByIdAsync(currentUser.getTenantId(), new UserId(entityId.getId()));</b>
<b class="nc">&nbsp;        Futures.addCallback(userFuture, getCallback(callback, user -&gt; {</b>
<b class="nc">&nbsp;            if (user == null) {</b>
<b class="nc">&nbsp;                return ValidationResult.entityNotFound(&quot;User with requested id wasn&#39;t found!&quot;);</b>
&nbsp;            }
&nbsp;            try {
<b class="nc">&nbsp;                accessControlService.checkPermission(currentUser, Resource.USER, operation, entityId, user);</b>
&nbsp;            } catch (ThingsboardException e) {
<b class="nc">&nbsp;                return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;            }
<b class="nc">&nbsp;            return ValidationResult.ok(user);</b>
&nbsp;
&nbsp;        }), executor);
&nbsp;    }
&nbsp;
&nbsp;    private void validateEntityView(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;EntityView&gt; entityViewFuture = entityViewService.findEntityViewByIdAsync(currentUser.getTenantId(), new EntityViewId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(entityViewFuture, getCallback(callback, entityView -&gt; {</b>
<b class="nc">&nbsp;                if (entityView == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(ENTITY_VIEW_WITH_REQUESTED_ID_NOT_FOUND);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.ENTITY_VIEW, operation, entityId, entityView);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(entityView);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void validateEdge(final SecurityUser currentUser, Operation operation, EntityId entityId, FutureCallback&lt;ValidationResult&gt; callback) {
<b class="nc">&nbsp;        if (currentUser.isSystemAdmin()) {</b>
<b class="nc">&nbsp;            callback.onSuccess(ValidationResult.accessDenied(SYSTEM_ADMINISTRATOR_IS_NOT_ALLOWED_TO_PERFORM_THIS_OPERATION));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;Edge&gt; edgeFuture = edgeService.findEdgeByIdAsync(currentUser.getTenantId(), new EdgeId(entityId.getId()));</b>
<b class="nc">&nbsp;            Futures.addCallback(edgeFuture, getCallback(callback, edge -&gt; {</b>
<b class="nc">&nbsp;                if (edge == null) {</b>
<b class="nc">&nbsp;                    return ValidationResult.entityNotFound(EDGE_WITH_REQUESTED_ID_NOT_FOUND);</b>
&nbsp;                } else {
&nbsp;                    try {
<b class="nc">&nbsp;                        accessControlService.checkPermission(currentUser, Resource.EDGE, operation, entityId, edge);</b>
&nbsp;                    } catch (ThingsboardException e) {
<b class="nc">&nbsp;                        return ValidationResult.accessDenied(e.getMessage());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ValidationResult.ok(edge);</b>
&nbsp;                }
&nbsp;            }), executor);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private &lt;T, V&gt; FutureCallback&lt;T&gt; getCallback(FutureCallback&lt;ValidationResult&gt; callback, Function&lt;T, ValidationResult&lt;V&gt;&gt; transformer) {
<b class="nc">&nbsp;        return new FutureCallback&lt;T&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(@Nullable T result) {
<b class="nc">&nbsp;                callback.onSuccess(transformer.apply(result));</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                callback.onFailure(t);</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static void handleError(Throwable e, final DeferredResult&lt;ResponseEntity&gt; response, HttpStatus defaultErrorStatus) {
&nbsp;        ResponseEntity responseEntity;
<b class="nc">&nbsp;        if (e instanceof ToErrorResponseEntity) {</b>
<b class="nc">&nbsp;            responseEntity = ((ToErrorResponseEntity) e).toErrorResponseEntity();</b>
<b class="nc">&nbsp;        } else if (e instanceof IllegalArgumentException || e instanceof IncorrectParameterException || e instanceof DataValidationException) {</b>
<b class="nc">&nbsp;            responseEntity = new ResponseEntity&lt;&gt;(e.getMessage(), HttpStatus.BAD_REQUEST);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            responseEntity = new ResponseEntity&lt;&gt;(defaultErrorStatus);</b>
&nbsp;        }
<b class="nc">&nbsp;        response.setResult(responseEntity);</b>
&nbsp;    }
&nbsp;
&nbsp;    public interface ThreeConsumer&lt;A, B, C&gt; {
&nbsp;        void accept(A a, B b, C c);
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

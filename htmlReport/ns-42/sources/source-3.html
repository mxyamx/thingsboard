<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultTbActorSystem</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.actors</a>
</div>

<h1>Coverage Summary for Class: DefaultTbActorSystem (org.thingsboard.server.actors)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultTbActorSystem</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/83)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.actors;
&nbsp;
&nbsp;import lombok.Data;
&nbsp;import lombok.Getter;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.server.common.msg.TbActorMsg;
&nbsp;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.ScheduledExecutorService;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.locks.Lock;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;import java.util.function.Predicate;
&nbsp;import java.util.stream.Collectors;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Data
&nbsp;public class DefaultTbActorSystem implements TbActorSystem {
&nbsp;
<b class="nc">&nbsp;    private final ConcurrentMap&lt;String, Dispatcher&gt; dispatchers = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ConcurrentMap&lt;TbActorId, TbActorMailbox&gt; actors = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ConcurrentMap&lt;TbActorId, ReentrantLock&gt; actorCreationLocks = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ConcurrentMap&lt;TbActorId, Set&lt;TbActorId&gt;&gt; parentChildMap = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    @Getter
&nbsp;    private final TbActorSystemSettings settings;
&nbsp;    @Getter
&nbsp;    private final ScheduledExecutorService scheduler;
&nbsp;
<b class="nc">&nbsp;    public DefaultTbActorSystem(TbActorSystemSettings settings) {</b>
<b class="nc">&nbsp;        this.settings = settings;</b>
<b class="nc">&nbsp;        this.scheduler = ThingsBoardExecutors.newScheduledThreadPool(settings.getSchedulerPoolSize(), &quot;actor-system-scheduler&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createDispatcher(String dispatcherId, ExecutorService executor) {
<b class="nc">&nbsp;        Dispatcher current = dispatchers.putIfAbsent(dispatcherId, new Dispatcher(dispatcherId, executor));</b>
<b class="nc">&nbsp;        if (current != null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Dispatcher with id [&quot; + dispatcherId + &quot;] is already registered!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroyDispatcher(String dispatcherId) {
<b class="nc">&nbsp;        Dispatcher dispatcher = dispatchers.remove(dispatcherId);</b>
<b class="nc">&nbsp;        if (dispatcher != null) {</b>
<b class="nc">&nbsp;            dispatcher.getExecutor().shutdownNow();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Dispatcher with id [&quot; + dispatcherId + &quot;] is not registered!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbActorRef getActor(TbActorId actorId) {
<b class="nc">&nbsp;        return actors.get(actorId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbActorRef createRootActor(String dispatcherId, TbActorCreator creator) {
<b class="nc">&nbsp;        return createActor(dispatcherId, creator, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbActorRef createChildActor(String dispatcherId, TbActorCreator creator, TbActorId parent) {
<b class="nc">&nbsp;        return createActor(dispatcherId, creator, parent);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbActorRef createActor(String dispatcherId, TbActorCreator creator, TbActorId parent) {
<b class="nc">&nbsp;        Dispatcher dispatcher = dispatchers.get(dispatcherId);</b>
<b class="nc">&nbsp;        if (dispatcher == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Dispatcher with id [{}] is not registered!&quot;, dispatcherId);</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Dispatcher with id [&quot; + dispatcherId + &quot;] is not registered!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        TbActorId actorId = creator.createActorId();</b>
<b class="nc">&nbsp;        TbActorMailbox actorMailbox = actors.get(actorId);</b>
<b class="nc">&nbsp;        if (actorMailbox != null) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Actor with id [{}] is already registered!&quot;, actorId);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Lock actorCreationLock = actorCreationLocks.computeIfAbsent(actorId, id -&gt; new ReentrantLock());</b>
<b class="nc">&nbsp;            actorCreationLock.lock();</b>
&nbsp;            try {
<b class="nc">&nbsp;                actorMailbox = actors.get(actorId);</b>
<b class="nc">&nbsp;                if (actorMailbox == null) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;Creating actor with id [{}]!&quot;, actorId);</b>
<b class="nc">&nbsp;                    TbActor actor = creator.createActor();</b>
<b class="nc">&nbsp;                    TbActorRef parentRef = null;</b>
<b class="nc">&nbsp;                    if (parent != null) {</b>
<b class="nc">&nbsp;                        parentRef = getActor(parent);</b>
<b class="nc">&nbsp;                        if (parentRef == null) {</b>
<b class="nc">&nbsp;                            throw new TbActorNotRegisteredException(parent, &quot;Parent Actor with id [&quot; + parent + &quot;] is not registered!&quot;);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    TbActorMailbox mailbox = new TbActorMailbox(this, settings, actorId, parentRef, actor, dispatcher);</b>
<b class="nc">&nbsp;                    actors.put(actorId, mailbox);</b>
<b class="nc">&nbsp;                    mailbox.initActor();</b>
<b class="nc">&nbsp;                    actorMailbox = mailbox;</b>
<b class="nc">&nbsp;                    if (parent != null) {</b>
<b class="nc">&nbsp;                        parentChildMap.computeIfAbsent(parent, id -&gt; ConcurrentHashMap.newKeySet()).add(actorId);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    log.debug(&quot;Actor with id [{}] is already registered!&quot;, actorId);</b>
&nbsp;                }
&nbsp;            } finally {
<b class="nc">&nbsp;                actorCreationLock.unlock();</b>
<b class="nc">&nbsp;                actorCreationLocks.remove(actorId);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return actorMailbox;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void tellWithHighPriority(TbActorId target, TbActorMsg actorMsg) {
<b class="nc">&nbsp;        tell(target, actorMsg, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void tell(TbActorId target, TbActorMsg actorMsg) {
<b class="nc">&nbsp;        tell(target, actorMsg, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void tell(TbActorId target, TbActorMsg actorMsg, boolean highPriority) {
<b class="nc">&nbsp;        TbActorMailbox mailbox = actors.get(target);</b>
<b class="nc">&nbsp;        if (mailbox == null) {</b>
<b class="nc">&nbsp;            throw new TbActorNotRegisteredException(target, &quot;Actor with id [&quot; + target + &quot;] is not registered!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (highPriority) {</b>
<b class="nc">&nbsp;            mailbox.tellWithHighPriority(actorMsg);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            mailbox.tell(actorMsg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public void broadcastToChildren(TbActorId parent, TbActorMsg msg) {
<b class="nc">&nbsp;        broadcastToChildren(parent, msg, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void broadcastToChildren(TbActorId parent, TbActorMsg msg, boolean highPriority) {
<b class="nc">&nbsp;        broadcastToChildren(parent, id -&gt; true, msg, highPriority);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void broadcastToChildren(TbActorId parent, Predicate&lt;TbActorId&gt; childFilter, TbActorMsg msg) {
<b class="nc">&nbsp;        broadcastToChildren(parent, childFilter, msg, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void broadcastToChildren(TbActorId parent, Predicate&lt;TbActorId&gt; childFilter, TbActorMsg msg, boolean highPriority) {
<b class="nc">&nbsp;        Set&lt;TbActorId&gt; children = parentChildMap.get(parent);</b>
<b class="nc">&nbsp;        if (children != null) {</b>
<b class="nc">&nbsp;            children.stream().filter(childFilter).forEach(id -&gt; {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    tell(id, msg, highPriority);</b>
&nbsp;                } catch (TbActorNotRegisteredException e) {
<b class="nc">&nbsp;                    log.warn(&quot;Actor is missing for {}&quot;, id);</b>
&nbsp;                }
&nbsp;            });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;TbActorId&gt; filterChildren(TbActorId parent, Predicate&lt;TbActorId&gt; childFilter) {
<b class="nc">&nbsp;        Set&lt;TbActorId&gt; children = parentChildMap.get(parent);</b>
<b class="nc">&nbsp;        if (children != null) {</b>
<b class="nc">&nbsp;            return children.stream().filter(childFilter).collect(Collectors.toList());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void stop(TbActorRef actorRef) {
<b class="nc">&nbsp;        stop(actorRef.getActorId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void stop(TbActorId actorId) {
<b class="nc">&nbsp;        Set&lt;TbActorId&gt; children = parentChildMap.remove(actorId);</b>
<b class="nc">&nbsp;        if (children != null) {</b>
<b class="nc">&nbsp;            for (TbActorId child : children) {</b>
<b class="nc">&nbsp;                stop(child);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        parentChildMap.values().forEach(parentChildren -&gt; parentChildren.remove(actorId));</b>
&nbsp;
<b class="nc">&nbsp;        TbActorMailbox mailbox = actors.remove(actorId);</b>
<b class="nc">&nbsp;        if (mailbox != null) {</b>
<b class="nc">&nbsp;            mailbox.destroy(null);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void stop() {
<b class="nc">&nbsp;        dispatchers.values().forEach(dispatcher -&gt; {</b>
<b class="nc">&nbsp;            dispatcher.getExecutor().shutdown();</b>
&nbsp;            try {
<b class="nc">&nbsp;                dispatcher.getExecutor().awaitTermination(3, TimeUnit.SECONDS);</b>
&nbsp;            } catch (InterruptedException e) {
<b class="nc">&nbsp;                log.warn(&quot;[{}] Failed to stop dispatcher&quot;, dispatcher.getDispatcherId(), e);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        if (scheduler != null) {</b>
<b class="nc">&nbsp;            scheduler.shutdownNow();</b>
&nbsp;        }
<b class="nc">&nbsp;        actors.clear();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

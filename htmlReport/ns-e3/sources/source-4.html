<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EdgeServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.edge</a>
</div>

<h1>Coverage Summary for Class: EdgeServiceImpl (org.thingsboard.server.dao.edge)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EdgeServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/81)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/251)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EdgeServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeServiceImpl$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeServiceImpl$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/81)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/258)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.edge;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.node.ArrayNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import lombok.Getter;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.hibernate.exception.ConstraintViolationException;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.annotation.Lazy;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.cache.edge.EdgeCacheEvictEvent;
&nbsp;import org.thingsboard.server.cache.edge.EdgeCacheKey;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.EntitySubtype;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeInfo;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeSearchQuery;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.IdBased;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.TenantProfileId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.kv.KvEntry;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterable;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterableByTenantIdEntityId;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.EntitySearchDirection;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChain;
&nbsp;import org.thingsboard.server.common.data.rule.RuleNode;
&nbsp;import org.thingsboard.server.dao.attributes.AttributesService;
&nbsp;import org.thingsboard.server.dao.entity.AbstractCachedEntityService;
&nbsp;import org.thingsboard.server.dao.entity.EntityCountService;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.relation.RelationService;
&nbsp;import org.thingsboard.server.dao.rule.RuleChainService;
&nbsp;import org.thingsboard.server.dao.service.DataValidator;
&nbsp;import org.thingsboard.server.dao.service.PaginatedRemover;
&nbsp;import org.thingsboard.server.dao.service.Validator;
&nbsp;import org.thingsboard.server.dao.sql.JpaExecutorService;
&nbsp;import org.thingsboard.server.dao.timeseries.TimeseriesService;
&nbsp;import org.thingsboard.server.dao.user.UserService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.UUID;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.thingsboard.server.dao.DaoUtil.toUUIDs;
&nbsp;import static org.thingsboard.server.dao.edge.BaseRelatedEdgesService.RELATED_EDGES_CACHE_ITEMS;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateIds;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validatePageLink;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateString;
&nbsp;
&nbsp;@Service(&quot;EdgeDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class EdgeServiceImpl extends AbstractCachedEntityService&lt;EdgeCacheKey, Edge, EdgeCacheEvictEvent&gt; implements EdgeService {</b>
&nbsp;
&nbsp;    public static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;    public static final String INCORRECT_CUSTOMER_ID = &quot;Incorrect customerId &quot;;
&nbsp;    public static final String INCORRECT_EDGE_ID = &quot;Incorrect edgeId &quot;;
&nbsp;    public static final String EDGE_IS_ROOT_BODY_KEY = &quot;isRoot&quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EdgeDao edgeDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private UserService userService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private RuleChainService ruleChainService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private RelationService relationService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    @Lazy
&nbsp;    private TimeseriesService timeseriesService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private AttributesService attributesService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DataValidator&lt;Edge&gt; edgeValidator;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private JpaExecutorService executor;
&nbsp;
&nbsp;    @Autowired
&nbsp;    @Lazy
&nbsp;    private RelatedEdgesService relatedEdgesService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EntityCountService countService;
&nbsp;
&nbsp;    @Value(&quot;${edges.enabled}&quot;)
&nbsp;    @Getter
&nbsp;    private boolean edgesEnabled;
&nbsp;    @Value(&quot;${edges.state.persistToTelemetry:false}&quot;)
&nbsp;    private boolean persistToTelemetry;
&nbsp;
&nbsp;    @Override
&nbsp;    @TransactionalEventListener
&nbsp;    public void handleEvictEvent(EdgeCacheEvictEvent event) {
<b class="nc">&nbsp;        List&lt;EdgeCacheKey&gt; keys = new ArrayList&lt;&gt;(2);</b>
<b class="nc">&nbsp;        keys.add(new EdgeCacheKey(event.getTenantId(), event.getNewName()));</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.getOldName()) &amp;&amp; !event.getOldName().equals(event.getNewName())) {</b>
<b class="nc">&nbsp;            keys.add(new EdgeCacheKey(event.getTenantId(), event.getOldName()));</b>
&nbsp;        }
<b class="nc">&nbsp;        cache.evict(keys);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge findEdgeById(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeById [{}]&quot;, edgeId);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        return edgeDao.findById(tenantId, edgeId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EdgeInfo findEdgeInfoById(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeInfoById [{}]&quot;, edgeId);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeInfoById(tenantId, edgeId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Edge&gt; findEdgeByIdAsync(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeByIdAsync [{}]&quot;, edgeId);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        return edgeDao.findByIdAsync(tenantId, edgeId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge findEdgeByTenantIdAndName(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeByTenantIdAndName [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(new EdgeCacheKey(tenantId, name),</b>
<b class="nc">&nbsp;                () -&gt; edgeDao.findEdgeByTenantIdAndName(tenantId.getId(), name)</b>
<b class="nc">&nbsp;                        .orElse(null), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Edge&gt; findEdgeByTenantIdAndNameAsync(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeByTenantIdAndNameAsync [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return executor.submit(() -&gt; findEdgeByTenantIdAndName(tenantId, name));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;Edge&gt; findEdgeByRoutingKey(TenantId tenantId, String routingKey) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeByRoutingKey [{}]&quot;, routingKey);</b>
<b class="nc">&nbsp;        Validator.validateString(routingKey, &quot;Incorrect edge routingKey for search request.&quot;);</b>
<b class="nc">&nbsp;        return edgeDao.findByRoutingKey(tenantId.getId(), routingKey);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findActiveEdges(PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findActiveEdges [{}]&quot;, pageLink);</b>
<b class="nc">&nbsp;        Validator.validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findActiveEdges(pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge saveEdge(Edge edge) {
<b class="nc">&nbsp;        return saveEntity(edge, () -&gt; doSaveEdge(edge));</b>
&nbsp;    }
&nbsp;
&nbsp;    private Edge doSaveEdge(Edge edge) {
<b class="nc">&nbsp;        log.trace(&quot;Executing saveEdge [{}]&quot;, edge);</b>
<b class="nc">&nbsp;        Edge oldEdge = edgeValidator.validate(edge, Edge::getTenantId);</b>
<b class="nc">&nbsp;        EdgeCacheEvictEvent evictEvent = new EdgeCacheEvictEvent(edge.getTenantId(), edge.getName(), oldEdge != null ? oldEdge.getName() : null);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Edge savedEdge = edgeDao.save(edge.getTenantId(), edge);</b>
<b class="nc">&nbsp;            publishEvictEvent(evictEvent);</b>
<b class="nc">&nbsp;            eventPublisher.publishEvent(SaveEntityEvent.builder().tenantId(savedEdge.getTenantId())</b>
<b class="nc">&nbsp;                    .entityId(savedEdge.getId()).entity(savedEdge).created(edge.getId() == null).build());</b>
<b class="nc">&nbsp;            if (edge.getId() == null) {</b>
<b class="nc">&nbsp;                countService.publishCountEntityEvictEvent(savedEdge.getTenantId(), EntityType.EDGE);</b>
&nbsp;            }
<b class="nc">&nbsp;            return savedEdge;</b>
&nbsp;        } catch (Exception t) {
<b class="nc">&nbsp;            handleEvictEvent(evictEvent);</b>
<b class="nc">&nbsp;            ConstraintViolationException e = extractConstraintViolationException(t).orElse(null);</b>
<b class="nc">&nbsp;            if (e != null &amp;&amp; e.getConstraintName() != null</b>
<b class="nc">&nbsp;                    &amp;&amp; e.getConstraintName().equalsIgnoreCase(&quot;edge_name_unq_key&quot;)) {</b>
<b class="nc">&nbsp;                throw new DataValidationException(&quot;Edge with such name already exists!&quot;);</b>
&nbsp;            } else {
&nbsp;                throw t;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge assignEdgeToCustomer(TenantId tenantId, EdgeId edgeId, CustomerId customerId) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing assignEdgeToCustomer [{}][{}]&quot;, tenantId, edgeId, customerId);</b>
<b class="nc">&nbsp;        Edge edge = findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        if (customerId.equals(edge.getCustomerId())) {</b>
<b class="nc">&nbsp;            return edge;</b>
&nbsp;        }
<b class="nc">&nbsp;        edge.setCustomerId(customerId);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).entityId(edgeId)</b>
<b class="nc">&nbsp;                .body(JacksonUtil.toString(customerId)).actionType(ActionType.ASSIGNED_TO_CUSTOMER).build());</b>
<b class="nc">&nbsp;        return saveEdge(edge);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge unassignEdgeFromCustomer(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing unassignEdgeFromCustomer [{}]&quot;, tenantId, edgeId);</b>
<b class="nc">&nbsp;        Edge edge = findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        CustomerId customerId = edge.getCustomerId();</b>
<b class="nc">&nbsp;        if (customerId == null) {</b>
<b class="nc">&nbsp;            return edge;</b>
&nbsp;        }
<b class="nc">&nbsp;        edge.setCustomerId(null);</b>
<b class="nc">&nbsp;        Edge result = saveEdge(edge);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).entityId(edgeId)</b>
<b class="nc">&nbsp;                .body(JacksonUtil.toString(customerId)).actionType(ActionType.UNASSIGNED_FROM_CUSTOMER).build());</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEdge(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteEdge [{}]&quot;, edgeId);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
&nbsp;
<b class="nc">&nbsp;        Edge edge = edgeDao.findById(tenantId, edgeId.getId());</b>
<b class="nc">&nbsp;        if (edge == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        edgeDao.removeById(tenantId, edgeId.getId());</b>
&nbsp;
<b class="nc">&nbsp;        publishEvictEvent(new EdgeCacheEvictEvent(edge.getTenantId(), edge.getName(), null));</b>
<b class="nc">&nbsp;        countService.publishCountEntityEvictEvent(tenantId, EntityType.EDGE);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(DeleteEntityEvent.builder().tenantId(tenantId).entityId(edgeId).build());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEntity(TenantId tenantId, EntityId id, boolean force) {
<b class="nc">&nbsp;        deleteEdge(tenantId, (EdgeId) id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeId&gt; findEdgeIdsByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeIdsByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeIdsByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantIdAndType(TenantId tenantId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdAndType, tenantId [{}], type [{}], pageLink [{}]&quot;, tenantId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdAndType(tenantId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeInfo&gt; findEdgeInfosByTenantIdAndType(TenantId tenantId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeInfosByTenantIdAndType, tenantId [{}], type [{}], pageLink [{}]&quot;, tenantId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeInfosByTenantIdAndType(tenantId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeInfo&gt; findEdgeInfosByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeInfosByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeInfosByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Edge&gt;&gt; findEdgesByTenantIdAndIdsAsync(TenantId tenantId, List&lt;EdgeId&gt; edgeIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdAndIdsAsync, tenantId [{}], edgeIds [{}]&quot;, tenantId, edgeIds);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateIds(edgeIds, ids -&gt; &quot;Incorrect edgeIds &quot; + ids);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdAndIdsAsync(tenantId.getId(), toUUIDs(edgeIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteEdgesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteEdgesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        tenantEdgesRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        deleteEdgesByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantIdAndCustomerId(TenantId tenantId, CustomerId customerId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdAndCustomerId, tenantId [{}], customerId [{}], pageLink [{}]&quot;, tenantId, customerId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdAndCustomerId(tenantId.getId(), customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantIdAndCustomerIdAndType(TenantId tenantId, CustomerId customerId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdAndCustomerIdAndType, tenantId [{}], customerId [{}], type [{}], pageLink [{}]&quot;, tenantId, customerId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdAndCustomerIdAndType(tenantId.getId(), customerId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeInfo&gt; findEdgeInfosByTenantIdAndCustomerId(TenantId tenantId, CustomerId customerId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeInfosByTenantIdAndCustomerId, tenantId [{}], customerId [{}], pageLink [{}]&quot;, tenantId, customerId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeInfosByTenantIdAndCustomerId(tenantId.getId(), customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeInfo&gt; findEdgeInfosByTenantIdAndCustomerIdAndType(TenantId tenantId, CustomerId customerId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeInfosByTenantIdAndCustomerIdAndType, tenantId [{}], customerId [{}], type [{}], pageLink [{}]&quot;, tenantId, customerId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeInfosByTenantIdAndCustomerIdAndType(tenantId.getId(), customerId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Edge&gt;&gt; findEdgesByTenantIdCustomerIdAndIdsAsync(TenantId tenantId, CustomerId customerId, List&lt;EdgeId&gt; edgeIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdCustomerIdAndIdsAsync, tenantId [{}], customerId [{}], edgeIds [{}]&quot;, tenantId, customerId, edgeIds);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validateIds(edgeIds, ids -&gt; &quot;Incorrect edgeIds &quot; + ids);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdCustomerIdAndIdsAsync(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), toUUIDs(edgeIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unassignCustomerEdges(TenantId tenantId, CustomerId customerId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing unassignCustomerEdges, tenantId [{}], customerId [{}]&quot;, tenantId, customerId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        customerEdgeRemover.removeEntities(tenantId, customerId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;Edge&gt;&gt; findEdgesByQuery(TenantId tenantId, EdgeSearchQuery query) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing findEdgesByQuery [{}]&quot;, tenantId, query);</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntityRelation&gt;&gt; relations = relationService.findByQuery(tenantId, query.toEntitySearchQuery());</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;Edge&gt;&gt; edges = Futures.transformAsync(relations, r -&gt; {</b>
<b class="nc">&nbsp;            EntitySearchDirection direction = query.toEntitySearchQuery().getParameters().getDirection();</b>
<b class="nc">&nbsp;            List&lt;ListenableFuture&lt;Edge&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EntityRelation relation : r) {</b>
<b class="nc">&nbsp;                EntityId entityId = direction == EntitySearchDirection.FROM ? relation.getTo() : relation.getFrom();</b>
<b class="nc">&nbsp;                if (entityId.getEntityType() == EntityType.EDGE) {</b>
<b class="nc">&nbsp;                    futures.add(findEdgeByIdAsync(tenantId, new EdgeId(entityId.getId())));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return Futures.successfulAsList(futures);</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;
<b class="nc">&nbsp;        edges = Futures.transform(edges, edgeList -&gt; edgeList == null ?</b>
<b class="nc">&nbsp;                Collections.emptyList() :</b>
<b class="nc">&nbsp;                edgeList.stream().filter(edge -&gt; query.getEdgeTypes().contains(edge.getType())).collect(Collectors.toList()), MoreExecutors.directExecutor());</b>
<b class="nc">&nbsp;        return edges;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; findEdgeTypesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeTypesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; tenantEdgeTypes = edgeDao.findTenantEdgeTypesAsync(tenantId.getId());</b>
<b class="nc">&nbsp;        return Futures.transform(tenantEdgeTypes,</b>
&nbsp;                edgeTypes -&gt; {
<b class="nc">&nbsp;                    edgeTypes.sort(Comparator.comparing(EntitySubtype::getType));</b>
<b class="nc">&nbsp;                    return edgeTypes;</b>
<b class="nc">&nbsp;                }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void assignDefaultRuleChainsToEdge(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing assignDefaultRuleChainsToEdge, tenantId [{}], edgeId [{}]&quot;, tenantId, edgeId);</b>
<b class="nc">&nbsp;        PageDataIterable&lt;RuleChain&gt; ruleChains = new PageDataIterable&lt;&gt;(</b>
<b class="nc">&nbsp;                link -&gt; ruleChainService.findAutoAssignToEdgeRuleChainsByTenantId(tenantId, link), 1024);</b>
<b class="nc">&nbsp;        for (RuleChain ruleChain : ruleChains) {</b>
<b class="nc">&nbsp;            ruleChainService.assignRuleChainToEdge(tenantId, ruleChain.getId(), edgeId);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantIdAndEntityId(TenantId tenantId, EntityId entityId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantIdAndEntityId, tenantId [{}], entityId [{}], pageLink [{}]&quot;, tenantId, entityId, pageLink);</b>
<b class="nc">&nbsp;        Validator.validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantIdAndEntityId(tenantId.getId(), entityId.getId(), entityId.getEntityType(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeId&gt; findEdgeIdsByTenantIdAndEntityId(TenantId tenantId, EntityId entityId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgeIdsByTenantIdAndEntityId, tenantId [{}], entityId [{}], pageLink [{}]&quot;, tenantId, entityId, pageLink);</b>
<b class="nc">&nbsp;        Validator.validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgeIdsByTenantIdAndEntityId(tenantId.getId(), entityId.getId(), entityId.getEntityType(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;Edge&gt; findEdgesByTenantProfileId(TenantProfileId tenantProfileId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEdgesByTenantProfileId, tenantProfileId [{}], pageLink [{}]&quot;, tenantProfileId, pageLink);</b>
<b class="nc">&nbsp;        Validator.validateId(tenantProfileId, id -&gt; &quot;Incorrect tenantProfileId &quot; + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return edgeDao.findEdgesByTenantProfileId(tenantProfileId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;TenantId, Edge&gt; tenantEdgesRemover =</b>
<b class="nc">&nbsp;            new PaginatedRemover&lt;&gt;() {</b>
&nbsp;
&nbsp;                @Override
&nbsp;                protected PageData&lt;Edge&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;                    return edgeDao.findEdgesByTenantId(id.getId(), pageLink);</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                protected void removeEntity(TenantId tenantId, Edge entity) {
<b class="nc">&nbsp;                    deleteEdge(tenantId, new EdgeId(entity.getUuidId()));</b>
&nbsp;                }
&nbsp;            };
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;CustomerId, Edge&gt; customerEdgeRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;
&nbsp;        @Override
&nbsp;        protected PageData&lt;Edge&gt; findEntities(TenantId tenantId, CustomerId id, PageLink pageLink) {
<b class="nc">&nbsp;            return edgeDao.findEdgesByTenantIdAndCustomerId(tenantId.getId(), id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, Edge entity) {
<b class="nc">&nbsp;            unassignEdgeFromCustomer(tenantId, new EdgeId(entity.getUuidId()));</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;EdgeId&gt; findAllRelatedEdgeIds(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        if (!edgesEnabled) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (EntityType.EDGE.equals(entityId.getEntityType())) {</b>
<b class="nc">&nbsp;            return Collections.singletonList(new EdgeId(entityId.getId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        PageDataIterableByTenantIdEntityId&lt;EdgeId&gt; relatedEdgeIdsIterator =</b>
&nbsp;                new PageDataIterableByTenantIdEntityId&lt;&gt;(this::findRelatedEdgeIdsByEntityId, tenantId, entityId, RELATED_EDGES_CACHE_ITEMS);
<b class="nc">&nbsp;        List&lt;EdgeId&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (EdgeId edgeId : relatedEdgeIdsIterator) {</b>
<b class="nc">&nbsp;            result.add(edgeId);</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EdgeId&gt; findRelatedEdgeIdsByEntityId(TenantId tenantId, EntityId entityId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing findRelatedEdgeIdsByEntityId [{}] [{}]&quot;, tenantId, entityId, pageLink);</b>
<b class="nc">&nbsp;        switch (entityId.getEntityType()) {</b>
&nbsp;            case TENANT:
&nbsp;            case DEVICE_PROFILE:
&nbsp;            case ASSET_PROFILE:
&nbsp;            case OTA_PACKAGE:
<b class="nc">&nbsp;                return convertToEdgeIds(findEdgesByTenantId(tenantId, pageLink));</b>
&nbsp;            case CUSTOMER:
<b class="nc">&nbsp;                return convertToEdgeIds(findEdgesByTenantIdAndCustomerId(tenantId, new CustomerId(entityId.getId()), pageLink));</b>
&nbsp;            case EDGE:
<b class="nc">&nbsp;                return new PageData&lt;&gt;(List.of(new EdgeId(entityId.getId())), 1, 1, false);</b>
&nbsp;            case DEVICE:
&nbsp;            case ASSET:
&nbsp;            case ENTITY_VIEW:
&nbsp;            case DASHBOARD:
&nbsp;            case RULE_CHAIN:
<b class="nc">&nbsp;                return relatedEdgesService.findEdgeIdsByEntityId(tenantId, entityId, pageLink);</b>
&nbsp;            case USER:
<b class="nc">&nbsp;                User userById = userService.findUserById(tenantId, new UserId(entityId.getId()));</b>
<b class="nc">&nbsp;                if (userById == null) {</b>
<b class="nc">&nbsp;                    return PageData.emptyPageData();</b>
&nbsp;                }
<b class="nc">&nbsp;                if (userById.getCustomerId() == null || userById.getCustomerId().isNullUid()) {</b>
<b class="nc">&nbsp;                    return convertToEdgeIds(findEdgesByTenantId(tenantId, pageLink));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return convertToEdgeIds(findEdgesByTenantIdAndCustomerId(tenantId, userById.getCustomerId(), pageLink));</b>
&nbsp;                }
&nbsp;            case TENANT_PROFILE:
<b class="nc">&nbsp;                return convertToEdgeIds(findEdgesByTenantProfileId(new TenantProfileId(entityId.getId()), pageLink));</b>
&nbsp;            default:
<b class="nc">&nbsp;                log.warn(&quot;[{}] Unsupported entity type {}&quot;, tenantId, entityId.getEntityType());</b>
<b class="nc">&nbsp;                return PageData.emptyPageData();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private PageData&lt;EdgeId&gt; convertToEdgeIds(PageData&lt;Edge&gt; pageData) {
<b class="nc">&nbsp;        if (pageData == null) {</b>
<b class="nc">&nbsp;            return PageData.emptyPageData();</b>
&nbsp;        }
<b class="nc">&nbsp;        List&lt;EdgeId&gt; edgeIds = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (pageData.getData() != null &amp;&amp; !pageData.getData().isEmpty()) {</b>
<b class="nc">&nbsp;            edgeIds = pageData.getData().stream().map(IdBased::getId).collect(Collectors.toList());</b>
&nbsp;        }
<b class="nc">&nbsp;        return new PageData&lt;&gt;(edgeIds, pageData.getTotalPages(), pageData.getTotalElements(), pageData.hasNext());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String findMissingToRelatedRuleChains(TenantId tenantId, EdgeId edgeId, String tbRuleChainInputNodeClassName) {
<b class="nc">&nbsp;        List&lt;RuleChain&gt; edgeRuleChains = findEdgeRuleChains(tenantId, edgeId);</b>
<b class="nc">&nbsp;        List&lt;RuleChainId&gt; edgeRuleChainIds = edgeRuleChains.stream().map(IdBased::getId).toList();</b>
<b class="nc">&nbsp;        ObjectNode result = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        for (RuleChain edgeRuleChain : edgeRuleChains) {</b>
<b class="nc">&nbsp;            List&lt;RuleNode&gt; ruleNodes =</b>
<b class="nc">&nbsp;                    ruleChainService.loadRuleChainMetaData(edgeRuleChain.getTenantId(), edgeRuleChain.getId()).getNodes();</b>
<b class="nc">&nbsp;            if (ruleNodes != null &amp;&amp; !ruleNodes.isEmpty()) {</b>
<b class="nc">&nbsp;                List&lt;RuleChainId&gt; connectedRuleChains =</b>
<b class="nc">&nbsp;                        ruleNodes.stream()</b>
<b class="nc">&nbsp;                                .filter(rn -&gt; rn.getType().equals(tbRuleChainInputNodeClassName))</b>
<b class="nc">&nbsp;                                .map(rn -&gt; new RuleChainId(UUID.fromString(rn.getConfiguration().get(&quot;ruleChainId&quot;).asText()))).toList();</b>
<b class="nc">&nbsp;                List&lt;String&gt; missingRuleChains = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                for (RuleChainId connectedRuleChain : connectedRuleChains) {</b>
<b class="nc">&nbsp;                    if (!edgeRuleChainIds.contains(connectedRuleChain)) {</b>
<b class="nc">&nbsp;                        RuleChain ruleChainById = ruleChainService.findRuleChainById(tenantId, connectedRuleChain);</b>
<b class="nc">&nbsp;                        missingRuleChains.add(ruleChainById.getName());</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (!missingRuleChains.isEmpty()) {</b>
<b class="nc">&nbsp;                    ArrayNode array = JacksonUtil.newArrayNode();</b>
<b class="nc">&nbsp;                    for (String missingRuleChain : missingRuleChains) {</b>
<b class="nc">&nbsp;                        array.add(missingRuleChain);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    result.set(edgeRuleChain.getName(), array);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return result.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Edge setEdgeRootRuleChain(TenantId tenantId, Edge edge, RuleChainId ruleChainId) {
<b class="nc">&nbsp;        edge.setRootRuleChainId(ruleChainId);</b>
<b class="nc">&nbsp;        Edge savedEdge = saveEdge(edge);</b>
<b class="nc">&nbsp;        ObjectNode isRootBody = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        isRootBody.put(EDGE_IS_ROOT_BODY_KEY, Boolean.TRUE);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).edgeId(edge.getId()).entityId(ruleChainId)</b>
<b class="nc">&nbsp;                .body(JacksonUtil.toString(isRootBody)).actionType(ActionType.UPDATED).build());</b>
<b class="nc">&nbsp;        return savedEdge;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Boolean&gt; isEdgeActiveAsync(TenantId tenantId, EdgeId edgeId, String key) {
&nbsp;        ListenableFuture&lt;? extends Optional&lt;? extends KvEntry&gt;&gt; futureKvEntry;
<b class="nc">&nbsp;        if (persistToTelemetry) {</b>
<b class="nc">&nbsp;            futureKvEntry = timeseriesService.findLatest(tenantId, edgeId, key);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            futureKvEntry = attributesService.find(tenantId, edgeId, AttributeScope.SERVER_SCOPE, key);</b>
&nbsp;        }
<b class="nc">&nbsp;        return Futures.transformAsync(futureKvEntry, kvEntryOpt -&gt;</b>
<b class="nc">&nbsp;                Futures.immediateFuture(kvEntryOpt.flatMap(KvEntry::getBooleanValue).orElse(false)), MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;RuleChain&gt; findEdgeRuleChains(TenantId tenantId, EdgeId edgeId) {
<b class="nc">&nbsp;        List&lt;RuleChain&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        PageDataIterable&lt;RuleChain&gt; ruleChains = new PageDataIterable&lt;&gt;(</b>
<b class="nc">&nbsp;                link -&gt; ruleChainService.findRuleChainsByTenantIdAndEdgeId(tenantId, edgeId, link), 1024);</b>
<b class="nc">&nbsp;        for (RuleChain ruleChain : ruleChains) {</b>
<b class="nc">&nbsp;            result.add(ruleChain);</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        return edgeDao.countByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HasId&lt;?&gt;&gt; findEntity(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return Optional.ofNullable(findEdgeById(tenantId, new EdgeId(entityId.getId())));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public FluentFuture&lt;Optional&lt;HasId&lt;?&gt;&gt;&gt; findEntityAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return FluentFuture.from(findEdgeByIdAsync(tenantId, new EdgeId(entityId.getId())))</b>
<b class="nc">&nbsp;                .transform(Optional::ofNullable, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return EntityType.EDGE;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbMsgDelayNode</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.delay</a>
</div>

<h1>Coverage Summary for Class: TbMsgDelayNode (org.thingsboard.rule.engine.delay)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbMsgDelayNode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.delay;
&nbsp;
&nbsp;import org.apache.commons.lang3.math.NumberUtils;
&nbsp;import org.thingsboard.rule.engine.api.RuleNode;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.api.TbNode;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeConfiguration;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeException;
&nbsp;import org.thingsboard.rule.engine.api.util.TbNodeUtils;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.data.msg.TbNodeConnectionType;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentType;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;@RuleNode(
&nbsp;        type = ComponentType.ACTION,
&nbsp;        name = &quot;delay (deprecated)&quot;,
&nbsp;        configClazz = TbMsgDelayNodeConfiguration.class,
&nbsp;        nodeDescription = &quot;Delays incoming message (deprecated)&quot;,
&nbsp;        nodeDetails = &quot;Delays messages for a configurable period. &quot; +
&nbsp;                &quot;Please note, this node acknowledges the message from the current queue (message will be removed from queue). &quot; +
&nbsp;                &quot;Deprecated because the acknowledged message still stays in memory (to be delayed) and this &quot; +
&nbsp;                &quot;does not guarantee that message will be processed even if the \&quot;retry failures and timeouts\&quot; processing strategy will be chosen.&quot;,
&nbsp;        icon = &quot;pause&quot;,
&nbsp;        configDirective = &quot;tbActionNodeMsgDelayConfig&quot;,
&nbsp;        docUrl = &quot;https://thingsboard.io/docs/user-guide/rule-engine-2-0/nodes/action/delay/&quot;
&nbsp;)
<b class="nc">&nbsp;public class TbMsgDelayNode implements TbNode {</b>
&nbsp;
&nbsp;    private TbMsgDelayNodeConfiguration config;
&nbsp;    private Map&lt;UUID, TbMsg&gt; pendingMsgs;
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbContext ctx, TbNodeConfiguration configuration) throws TbNodeException {
<b class="nc">&nbsp;        this.config = TbNodeUtils.convert(configuration, TbMsgDelayNodeConfiguration.class);</b>
<b class="nc">&nbsp;        this.pendingMsgs = new HashMap&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onMsg(TbContext ctx, TbMsg msg) {
<b class="nc">&nbsp;        if (msg.isTypeOf(TbMsgType.DELAY_TIMEOUT_SELF_MSG)) {</b>
<b class="nc">&nbsp;            TbMsg pendingMsg = pendingMsgs.remove(UUID.fromString(msg.getData()));</b>
<b class="nc">&nbsp;            if (pendingMsg != null) {</b>
<b class="nc">&nbsp;                ctx.enqueueForTellNext(</b>
<b class="nc">&nbsp;                        TbMsg.newMsg()</b>
<b class="nc">&nbsp;                                .queueName(pendingMsg.getQueueName())</b>
<b class="nc">&nbsp;                                .type(pendingMsg.getType())</b>
<b class="nc">&nbsp;                                .originator(pendingMsg.getOriginator())</b>
<b class="nc">&nbsp;                                .customerId(pendingMsg.getCustomerId())</b>
<b class="nc">&nbsp;                                .copyMetaData(pendingMsg.getMetaData())</b>
<b class="nc">&nbsp;                                .data(pendingMsg.getData())</b>
<b class="nc">&nbsp;                                .build(),</b>
&nbsp;                        TbNodeConnectionType.SUCCESS
&nbsp;                );
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (pendingMsgs.size() &lt; config.getMaxPendingMsgs()) {</b>
<b class="nc">&nbsp;                pendingMsgs.put(msg.getId(), msg);</b>
<b class="nc">&nbsp;                TbMsg tickMsg = ctx.newMsg(null, TbMsgType.DELAY_TIMEOUT_SELF_MSG, ctx.getSelfId(), msg.getCustomerId(), TbMsgMetaData.EMPTY, msg.getId().toString());</b>
<b class="nc">&nbsp;                ctx.tellSelf(tickMsg, getDelay(msg));</b>
<b class="nc">&nbsp;                ctx.ack(msg);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ctx.tellFailure(msg, new RuntimeException(&quot;Max limit of pending messages reached!&quot;));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private long getDelay(TbMsg msg) {
&nbsp;        int periodInSeconds;
<b class="nc">&nbsp;        if (config.isUseMetadataPeriodInSecondsPatterns()) {</b>
<b class="nc">&nbsp;            if (isParsable(msg, config.getPeriodInSecondsPattern())) {</b>
<b class="nc">&nbsp;                periodInSeconds = Integer.parseInt(TbNodeUtils.processPattern(config.getPeriodInSecondsPattern(), msg));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new RuntimeException(&quot;Can&#39;t parse period in seconds from metadata using pattern: &quot; + config.getPeriodInSecondsPattern());</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            periodInSeconds = config.getPeriodInSeconds();</b>
&nbsp;        }
<b class="nc">&nbsp;        return TimeUnit.SECONDS.toMillis(periodInSeconds);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isParsable(TbMsg msg, String pattern) {
<b class="nc">&nbsp;        return NumberUtils.isParsable(TbNodeUtils.processPattern(pattern, msg));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        pendingMsgs.clear();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

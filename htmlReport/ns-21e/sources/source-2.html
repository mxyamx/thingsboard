<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CalculatedFieldUtils</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.utils</a>
</div>

<h1>Coverage Summary for Class: CalculatedFieldUtils (org.thingsboard.server.utils)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CalculatedFieldUtils</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/49)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/162)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CalculatedFieldUtils$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/49)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/164)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.utils;
&nbsp;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmSeverity;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedFieldType;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.geofencing.GeofencingPresenceStatus;
&nbsp;import org.thingsboard.server.common.data.id.CalculatedFieldId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.kv.BasicKvEntry;
&nbsp;import org.thingsboard.server.common.util.KvProtoUtil;
&nbsp;import org.thingsboard.server.common.util.ProtoUtils;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.AlarmRuleStateProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.AlarmStateProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ArgumentIntervalProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.CalculatedFieldEntityCtxIdProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.CalculatedFieldIdProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.CalculatedFieldStateProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.EntityIdProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GeofencingArgumentProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.GeofencingZoneProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.SingleValueArgumentProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TsDoubleValProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TsRollingArgumentProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TsValueProto;
&nbsp;import org.thingsboard.server.service.cf.ctx.CalculatedFieldEntityCtxId;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.ArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.CalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.ScriptCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.SimpleCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.SingleValueArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.TsRollingArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.RelatedEntitiesAggregationCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.RelatedEntitiesArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.single.AggIntervalEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.single.AggIntervalEntryStatus;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.single.EntityAggregationArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.single.EntityAggregationCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.alarm.AlarmCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.alarm.AlarmRuleState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.geofencing.GeofencingArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.geofencing.GeofencingCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.geofencing.GeofencingZoneState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.propagation.PropagationArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.propagation.PropagationCalculatedFieldState;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.TreeMap;
&nbsp;import java.util.UUID;
&nbsp;import java.util.function.Function;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.common.data.cf.configuration.PropagationCalculatedFieldConfiguration.PROPAGATION_CONFIG_ARGUMENT;
&nbsp;
<b class="nc">&nbsp;public class CalculatedFieldUtils {</b>
&nbsp;
&nbsp;    public static CalculatedFieldIdProto toProto(CalculatedFieldId cfId) {
<b class="nc">&nbsp;        return CalculatedFieldIdProto.newBuilder()</b>
<b class="nc">&nbsp;                .setCalculatedFieldIdMSB(cfId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setCalculatedFieldIdLSB(cfId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldEntityCtxIdProto toProto(CalculatedFieldEntityCtxId ctxId) {
<b class="nc">&nbsp;        return CalculatedFieldEntityCtxIdProto.newBuilder()</b>
<b class="nc">&nbsp;                .setTenantIdMSB(ctxId.tenantId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdLSB(ctxId.tenantId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setCalculatedFieldIdMSB(ctxId.cfId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setCalculatedFieldIdLSB(ctxId.cfId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setEntityType(ctxId.entityId().getEntityType().name())</b>
<b class="nc">&nbsp;                .setEntityIdMSB(ctxId.entityId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setEntityIdLSB(ctxId.entityId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldEntityCtxId fromProto(CalculatedFieldEntityCtxIdProto ctxIdProto) {
<b class="nc">&nbsp;        TenantId tenantId = TenantId.fromUUID(new UUID(ctxIdProto.getTenantIdMSB(), ctxIdProto.getTenantIdLSB()));</b>
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(ctxIdProto.getEntityType(), new UUID(ctxIdProto.getEntityIdMSB(), ctxIdProto.getEntityIdLSB()));</b>
<b class="nc">&nbsp;        CalculatedFieldId calculatedFieldId = new CalculatedFieldId(new UUID(ctxIdProto.getCalculatedFieldIdMSB(), ctxIdProto.getCalculatedFieldIdLSB()));</b>
<b class="nc">&nbsp;        return new CalculatedFieldEntityCtxId(tenantId, calculatedFieldId, entityId);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldStateProto toProto(CalculatedFieldEntityCtxId stateId, CalculatedFieldState state) {
<b class="nc">&nbsp;        CalculatedFieldStateProto.Builder builder = CalculatedFieldStateProto.newBuilder()</b>
<b class="nc">&nbsp;                .setId(toProto(stateId))</b>
<b class="nc">&nbsp;                .setType(state.getType().name());</b>
&nbsp;
<b class="nc">&nbsp;        state.getArguments().forEach((argName, argEntry) -&gt; {</b>
<b class="nc">&nbsp;            switch (argEntry.getType()) {</b>
<b class="nc">&nbsp;                case SINGLE_VALUE -&gt; builder.addSingleValueArguments(toSingleValueArgumentProto(argName, (SingleValueArgumentEntry) argEntry));</b>
<b class="nc">&nbsp;                case TS_ROLLING -&gt; builder.addRollingValueArguments(toRollingArgumentProto(argName, (TsRollingArgumentEntry) argEntry));</b>
<b class="nc">&nbsp;                case GEOFENCING -&gt; builder.addGeofencingArguments(toGeofencingArgumentProto(argName, (GeofencingArgumentEntry) argEntry));</b>
<b class="nc">&nbsp;                case PROPAGATION -&gt; builder.addAllPropagationEntityIds(toPropagationEntityIdsProto((PropagationArgumentEntry) argEntry));</b>
&nbsp;                case RELATED_ENTITIES -&gt; {
<b class="nc">&nbsp;                    RelatedEntitiesArgumentEntry relatedEntitiesArgumentEntry = (RelatedEntitiesArgumentEntry) argEntry;</b>
<b class="nc">&nbsp;                    Map&lt;EntityId, ArgumentEntry&gt; entityInputs = relatedEntitiesArgumentEntry.getEntityInputs();</b>
<b class="nc">&nbsp;                    if (entityInputs.isEmpty()) {</b>
<b class="nc">&nbsp;                        builder.addSingleValueArguments(SingleValueArgumentProto.newBuilder().setArgName(argName).build());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        entityInputs.forEach((entityId, entry) -&gt; builder.addSingleValueArguments(toSingleValueArgumentProto(argName, (SingleValueArgumentEntry) entry)));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                case ENTITY_AGGREGATION -&gt; {
<b class="nc">&nbsp;                    EntityAggregationArgumentEntry entityAggregationArgumentEntry = (EntityAggregationArgumentEntry) argEntry;</b>
<b class="nc">&nbsp;                    entityAggregationArgumentEntry.getAggIntervals().forEach((interval, argumentStatus) -&gt; builder.addAggregationArguments(toArgumentIntervalProto(argName, interval, argumentStatus)));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        if (state instanceof AlarmCalculatedFieldState alarmState) {</b>
<b class="nc">&nbsp;            AlarmStateProto.Builder alarmStateProto = AlarmStateProto.newBuilder();</b>
<b class="nc">&nbsp;            alarmState.getCreateRuleStates().forEach((severity, ruleState) -&gt; {</b>
<b class="nc">&nbsp;                alarmStateProto.addCreateRuleStates(toAlarmRuleStateProto(ruleState));</b>
&nbsp;            });
<b class="nc">&nbsp;            if (alarmState.getClearRuleState() != null) {</b>
<b class="nc">&nbsp;                alarmStateProto.setClearRuleState(toAlarmRuleStateProto(alarmState.getClearRuleState()));</b>
&nbsp;            }
<b class="nc">&nbsp;            builder.setAlarmState(alarmStateProto);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (state instanceof RelatedEntitiesAggregationCalculatedFieldState aggState) {</b>
<b class="nc">&nbsp;            builder.setLastArgsUpdateTs(aggState.getLastArgsRefreshTs());</b>
<b class="nc">&nbsp;            builder.setLastMetricsEvalTs(aggState.getLastMetricsEvalTs());</b>
&nbsp;        }
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static List&lt;EntityIdProto&gt; toPropagationEntityIdsProto(PropagationArgumentEntry argEntry) {
<b class="nc">&nbsp;        return argEntry.getEntityIds().stream().map(ProtoUtils::toProto).collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    private static AlarmRuleStateProto toAlarmRuleStateProto(AlarmRuleState ruleState) {
<b class="nc">&nbsp;        return AlarmRuleStateProto.newBuilder()</b>
<b class="nc">&nbsp;                .setSeverity(Optional.ofNullable(ruleState.getSeverity()).map(Enum::name).orElse(&quot;&quot;))</b>
<b class="nc">&nbsp;                .setEventCount(ruleState.getEventCount())</b>
<b class="nc">&nbsp;                .setFirstEventTs(ruleState.getFirstEventTs())</b>
<b class="nc">&nbsp;                .setLastCheckTs(ruleState.getLastCheckTs())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static AlarmRuleState fromAlarmRuleStateProto(AlarmRuleStateProto proto, AlarmCalculatedFieldState state) {
<b class="nc">&nbsp;        AlarmSeverity severity = StringUtils.isNotEmpty(proto.getSeverity()) ? AlarmSeverity.valueOf(proto.getSeverity()) : null;</b>
<b class="nc">&nbsp;        AlarmRuleState ruleState = new AlarmRuleState(severity, null, state);</b>
<b class="nc">&nbsp;        ruleState.setEventCount(proto.getEventCount());</b>
<b class="nc">&nbsp;        ruleState.setFirstEventTs(proto.getFirstEventTs());</b>
<b class="nc">&nbsp;        ruleState.setLastCheckTs(proto.getLastCheckTs());</b>
<b class="nc">&nbsp;        return ruleState;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static SingleValueArgumentProto toSingleValueArgumentProto(String argName, SingleValueArgumentEntry entry) {
<b class="nc">&nbsp;        SingleValueArgumentProto.Builder builder = SingleValueArgumentProto.newBuilder()</b>
<b class="nc">&nbsp;                .setArgName(argName);</b>
&nbsp;
<b class="nc">&nbsp;        if (entry.getKvEntryValue() != null) {</b>
<b class="nc">&nbsp;            builder.setValue(KvProtoUtil.toTsValueProto(entry.getTs(), entry.getKvEntryValue()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Optional.ofNullable(entry.getVersion()).ifPresent(builder::setVersion);</b>
&nbsp;
<b class="nc">&nbsp;        if (entry.getEntityId() != null) {</b>
<b class="nc">&nbsp;            builder.setEntityId(ProtoUtils.toProto(entry.getEntityId()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ArgumentIntervalProto toArgumentIntervalProto(String argName, AggIntervalEntry intervalEntry, AggIntervalEntryStatus argumentStatus) {
<b class="nc">&nbsp;        return ArgumentIntervalProto.newBuilder()</b>
<b class="nc">&nbsp;                .setArgName(argName)</b>
<b class="nc">&nbsp;                .setStartTs(intervalEntry.getStartTs())</b>
<b class="nc">&nbsp;                .setEndTs(intervalEntry.getEndTs())</b>
<b class="nc">&nbsp;                .setLastArgsRefreshTs(argumentStatus.getLastArgsRefreshTs())</b>
<b class="nc">&nbsp;                .setLastMetricsEvalTs(argumentStatus.getLastMetricsEvalTs())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TsRollingArgumentProto toRollingArgumentProto(String argName, TsRollingArgumentEntry entry) {
<b class="nc">&nbsp;        TsRollingArgumentProto.Builder builder = TsRollingArgumentProto.newBuilder()</b>
<b class="nc">&nbsp;                .setKey(argName)</b>
<b class="nc">&nbsp;                .setLimit(entry.getLimit())</b>
<b class="nc">&nbsp;                .setTimeWindow(entry.getTimeWindow());</b>
&nbsp;
<b class="nc">&nbsp;        entry.getTsRecords().forEach((ts, value) -&gt; builder.addTsValue(TsDoubleValProto.newBuilder().setTs(ts).setValue(value).build()));</b>
&nbsp;
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static GeofencingArgumentProto toGeofencingArgumentProto(String argName, GeofencingArgumentEntry geofencingArgumentEntry) {
<b class="nc">&nbsp;        Map&lt;EntityId, GeofencingZoneState&gt; zoneStates = geofencingArgumentEntry.getZoneStates();</b>
<b class="nc">&nbsp;        GeofencingArgumentProto.Builder builder = GeofencingArgumentProto.newBuilder()</b>
<b class="nc">&nbsp;                .setArgName(argName);</b>
<b class="nc">&nbsp;        zoneStates.forEach((entityId, zoneState) -&gt;</b>
<b class="nc">&nbsp;                builder.addZones(toGeofencingZoneProto(entityId, zoneState)));</b>
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static GeofencingZoneProto toGeofencingZoneProto(EntityId entityId, GeofencingZoneState zoneState) {
<b class="nc">&nbsp;        GeofencingZoneProto.Builder builder = GeofencingZoneProto.newBuilder()</b>
<b class="nc">&nbsp;                .setZoneId(ProtoUtils.toProto(entityId))</b>
<b class="nc">&nbsp;                .setTs(zoneState.getTs())</b>
<b class="nc">&nbsp;                .setVersion(zoneState.getVersion())</b>
<b class="nc">&nbsp;                .setPerimeterDefinition(JacksonUtil.toString(zoneState.getPerimeterDefinition()));</b>
<b class="nc">&nbsp;        if (zoneState.getLastPresence() != null) {</b>
<b class="nc">&nbsp;            builder.setInside(zoneState.getLastPresence().equals(GeofencingPresenceStatus.INSIDE));</b>
&nbsp;        }
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldState fromProto(CalculatedFieldEntityCtxId id, CalculatedFieldStateProto proto) {
<b class="nc">&nbsp;        if (StringUtils.isEmpty(proto.getType())) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        CalculatedFieldType type = CalculatedFieldType.valueOf(proto.getType());</b>
&nbsp;
<b class="nc">&nbsp;        CalculatedFieldState state = switch (type) {</b>
<b class="nc">&nbsp;            case SIMPLE -&gt; new SimpleCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case SCRIPT -&gt; new ScriptCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case GEOFENCING -&gt; new GeofencingCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case ALARM -&gt; new AlarmCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case PROPAGATION -&gt; new PropagationCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case RELATED_ENTITIES_AGGREGATION -&gt; new RelatedEntitiesAggregationCalculatedFieldState(id.entityId());</b>
<b class="nc">&nbsp;            case ENTITY_AGGREGATION -&gt; new EntityAggregationCalculatedFieldState(id.entityId());</b>
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        if (state instanceof RelatedEntitiesAggregationCalculatedFieldState relatedEntitiesAggState) {</b>
<b class="nc">&nbsp;            Map&lt;String, Map&lt;EntityId, ArgumentEntry&gt;&gt; arguments = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            proto.getSingleValueArgumentsList().forEach(argProto -&gt; {</b>
<b class="nc">&nbsp;                SingleValueArgumentEntry entry = fromSingleValueArgumentProto(argProto);</b>
<b class="nc">&nbsp;                Map&lt;EntityId, ArgumentEntry&gt; entityInputs = arguments.computeIfAbsent(argProto.getArgName(), name -&gt; new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;                if (entry.getEntityId() != null) {</b>
<b class="nc">&nbsp;                    entityInputs.put(entry.getEntityId(), entry);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;            arguments.forEach((argName, entityInputs) -&gt; {</b>
<b class="nc">&nbsp;                relatedEntitiesAggState.getArguments().put(argName, new RelatedEntitiesArgumentEntry(entityInputs, false));</b>
&nbsp;            });
<b class="nc">&nbsp;            relatedEntitiesAggState.setLastArgsRefreshTs(proto.getLastArgsUpdateTs());</b>
<b class="nc">&nbsp;            relatedEntitiesAggState.setLastMetricsEvalTs(proto.getLastMetricsEvalTs());</b>
&nbsp;
<b class="nc">&nbsp;            return relatedEntitiesAggState;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (state instanceof EntityAggregationCalculatedFieldState entityAggregationState) {</b>
<b class="nc">&nbsp;            Map&lt;String, EntityAggregationArgumentEntry&gt; arguments = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;            proto.getAggregationArgumentsList().forEach(argProto -&gt; {</b>
<b class="nc">&nbsp;                AggIntervalEntry intervalEntry = new AggIntervalEntry(argProto.getStartTs(), argProto.getEndTs());</b>
<b class="nc">&nbsp;                AggIntervalEntryStatus intervalStatus = new AggIntervalEntryStatus(argProto.getLastArgsRefreshTs(), argProto.getLastMetricsEvalTs());</b>
<b class="nc">&nbsp;                EntityAggregationArgumentEntry argEntry = arguments.computeIfAbsent(argProto.getArgName(), name -&gt; new EntityAggregationArgumentEntry(new HashMap&lt;&gt;()));</b>
<b class="nc">&nbsp;                argEntry.getAggIntervals().put(intervalEntry, intervalStatus);</b>
&nbsp;            });
&nbsp;
<b class="nc">&nbsp;            entityAggregationState.getArguments().putAll(arguments);</b>
&nbsp;
<b class="nc">&nbsp;            return entityAggregationState;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        proto.getSingleValueArgumentsList().forEach(argProto -&gt;</b>
<b class="nc">&nbsp;                state.getArguments().put(argProto.getArgName(), fromSingleValueArgumentProto(argProto)));</b>
&nbsp;
<b class="nc">&nbsp;        switch (type) {</b>
<b class="nc">&nbsp;            case SCRIPT -&gt; proto.getRollingValueArgumentsList().forEach(argProto -&gt;</b>
<b class="nc">&nbsp;                    state.getArguments().put(argProto.getKey(), fromRollingArgumentProto(argProto)));</b>
<b class="nc">&nbsp;            case GEOFENCING -&gt; proto.getGeofencingArgumentsList().forEach(argProto -&gt;</b>
<b class="nc">&nbsp;                    state.getArguments().put(argProto.getArgName(), fromGeofencingArgumentProto(argProto)));</b>
&nbsp;            case PROPAGATION -&gt; {
<b class="nc">&nbsp;                List&lt;EntityId&gt; propagationEntityIds = proto.getPropagationEntityIdsList().stream().map(ProtoUtils::fromProto).toList();</b>
<b class="nc">&nbsp;                state.getArguments().put(PROPAGATION_CONFIG_ARGUMENT, new PropagationArgumentEntry(propagationEntityIds));</b>
&nbsp;            }
&nbsp;            case ALARM -&gt; {
<b class="nc">&nbsp;                AlarmCalculatedFieldState alarmState = (AlarmCalculatedFieldState) state;</b>
<b class="nc">&nbsp;                AlarmStateProto alarmStateProto = proto.getAlarmState();</b>
<b class="nc">&nbsp;                for (AlarmRuleStateProto ruleStateProto : alarmStateProto.getCreateRuleStatesList()) {</b>
<b class="nc">&nbsp;                    AlarmRuleState ruleState = fromAlarmRuleStateProto(ruleStateProto, alarmState);</b>
<b class="nc">&nbsp;                    alarmState.getCreateRuleStates().put(ruleState.getSeverity(), ruleState);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (alarmStateProto.hasClearRuleState()) {</b>
<b class="nc">&nbsp;                    alarmState.setClearRuleState(fromAlarmRuleStateProto(alarmStateProto.getClearRuleState(), alarmState));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return state;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static SingleValueArgumentEntry fromSingleValueArgumentProto(SingleValueArgumentProto proto) {
<b class="nc">&nbsp;        if (!proto.hasValue()) {</b>
<b class="nc">&nbsp;            return new SingleValueArgumentEntry();</b>
&nbsp;        }
<b class="nc">&nbsp;        TsValueProto tsValueProto = proto.getValue();</b>
<b class="nc">&nbsp;        BasicKvEntry kvEntry = (BasicKvEntry) KvProtoUtil.fromTsValueProto(proto.getArgName(), tsValueProto);</b>
<b class="nc">&nbsp;        long ts = tsValueProto.getTs();</b>
<b class="nc">&nbsp;        long version = proto.getVersion();</b>
<b class="nc">&nbsp;        if (proto.hasEntityId()) {</b>
<b class="nc">&nbsp;            EntityId entityId = ProtoUtils.fromProto(proto.getEntityId());</b>
<b class="nc">&nbsp;            return new SingleValueArgumentEntry(entityId, ts, kvEntry, version);</b>
&nbsp;        }
<b class="nc">&nbsp;        return new SingleValueArgumentEntry(ts, kvEntry, version);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TsRollingArgumentEntry fromRollingArgumentProto(TsRollingArgumentProto proto) {
<b class="nc">&nbsp;        TreeMap&lt;Long, Double&gt; tsRecords = new TreeMap&lt;&gt;();</b>
<b class="nc">&nbsp;        proto.getTsValueList().forEach(tsValueProto -&gt; tsRecords.put(tsValueProto.getTs(), tsValueProto.getValue()));</b>
<b class="nc">&nbsp;        return new TsRollingArgumentEntry(tsRecords, proto.getLimit(), proto.getTimeWindow());</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private static ArgumentEntry fromGeofencingArgumentProto(GeofencingArgumentProto proto) {
<b class="nc">&nbsp;        Map&lt;EntityId, GeofencingZoneState&gt; zoneStates = proto.getZonesList()</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .map(GeofencingZoneState::new)</b>
<b class="nc">&nbsp;                .collect(Collectors.toMap(GeofencingZoneState::getZoneId, Function.identity()));</b>
<b class="nc">&nbsp;        GeofencingArgumentEntry geofencingArgumentEntry = new GeofencingArgumentEntry();</b>
<b class="nc">&nbsp;        geofencingArgumentEntry.setZoneStates(zoneStates);</b>
<b class="nc">&nbsp;        return geofencingArgumentEntry;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

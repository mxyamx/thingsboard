<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AlarmCalculatedFieldState</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.cf.ctx.state.alarm</a>
</div>

<h1>Coverage Summary for Class: AlarmCalculatedFieldState (org.thingsboard.server.service.cf.ctx.state.alarm)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AlarmCalculatedFieldState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/200)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/295)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AlarmCalculatedFieldState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/200)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/301)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.cf.ctx.state.alarm;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import lombok.EqualsAndHashCode;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import lombok.SneakyThrows;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.common.util.KvUtil;
&nbsp;import org.thingsboard.rule.engine.action.TbAlarmResult;
&nbsp;import org.thingsboard.server.actors.TbActorRef;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.alarm.Alarm;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmApiCallResult;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmCreateOrUpdateActiveRequest;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmSeverity;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmUpdateRequest;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.AlarmRule;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.AlarmCondition;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.AlarmConditionType;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.AlarmConditionValue;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.AlarmConditionExpression;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.AlarmConditionFilter;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.ComplexOperation;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.SimpleAlarmConditionExpression;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.TbelAlarmConditionExpression;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.BooleanFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.ComplexFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.KeyFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.NoDataFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.NumericFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.StringFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedFieldType;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.AlarmCalculatedFieldConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.DashboardId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.kv.KvEntry;
&nbsp;import org.thingsboard.server.service.cf.AlarmCalculatedFieldResult;
&nbsp;import org.thingsboard.server.service.cf.CalculatedFieldResult;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.ArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.BaseCalculatedFieldState;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.CalculatedFieldCtx;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.SingleValueArgumentEntry;
&nbsp;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.Map;
&nbsp;import java.util.TreeMap;
&nbsp;import java.util.concurrent.ScheduledFuture;
&nbsp;import java.util.concurrent.atomic.AtomicBoolean;
&nbsp;import java.util.function.Function;
&nbsp;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.equalsAny;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.splitByCommaWithoutQuotes;
&nbsp;import static org.thingsboard.server.service.cf.ctx.state.alarm.AlarmEvalResult.Cause.NEW_EVENT;
&nbsp;import static org.thingsboard.server.service.cf.ctx.state.alarm.AlarmEvalResult.Cause.SCHEDULED_REEVALUATION;
&nbsp;import static org.thingsboard.server.service.cf.ctx.state.alarm.AlarmEvalResult.Status.FALSE;
&nbsp;import static org.thingsboard.server.service.cf.ctx.state.alarm.AlarmEvalResult.Status.NOT_YET_TRUE;
&nbsp;import static org.thingsboard.server.service.cf.ctx.state.alarm.AlarmEvalResult.Status.TRUE;
&nbsp;
&nbsp;@EqualsAndHashCode(callSuper = true)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class AlarmCalculatedFieldState extends BaseCalculatedFieldState {
&nbsp;
&nbsp;    private AlarmCalculatedFieldConfiguration configuration;
&nbsp;    private String alarmType;
&nbsp;
<b class="nc">&nbsp;    @Getter</b>
<b class="nc">&nbsp;    private final Map&lt;AlarmSeverity, AlarmRuleState&gt; createRuleStates = new TreeMap&lt;&gt;(Comparator.comparing(Enum::ordinal));</b>
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private AlarmRuleState clearRuleState;
&nbsp;
&nbsp;    @Getter
&nbsp;    private Alarm currentAlarm;
&nbsp;    private boolean initialFetchDone;
&nbsp;
&nbsp;    public AlarmCalculatedFieldState(EntityId entityId) {
<b class="nc">&nbsp;        super(entityId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void setCtx(CalculatedFieldCtx ctx, TbActorRef actorCtx) {
<b class="nc">&nbsp;        super.setCtx(ctx, actorCtx);</b>
<b class="nc">&nbsp;        this.configuration = getConfiguration(ctx);</b>
<b class="nc">&nbsp;        this.alarmType = ctx.getCalculatedField().getName();</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;AlarmSeverity, AlarmRule&gt; createRules = configuration.getCreateRules();</b>
<b class="nc">&nbsp;        createRules.forEach((severity, rule) -&gt; {</b>
<b class="nc">&nbsp;            AlarmRuleState ruleState = createRuleStates.get(severity);</b>
<b class="nc">&nbsp;            if (ruleState != null) {</b>
<b class="nc">&nbsp;                ruleState.setAlarmRule(rule);</b>
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        AlarmRule clearRule = configuration.getClearRule();</b>
<b class="nc">&nbsp;        if (clearRule != null &amp;&amp; clearRuleState != null) {</b>
<b class="nc">&nbsp;            clearRuleState.setAlarmRule(clearRule);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (currentAlarm != null &amp;&amp; !currentAlarm.getType().equals(alarmType)) {</b>
<b class="nc">&nbsp;            currentAlarm = null;</b>
<b class="nc">&nbsp;            initialFetchDone = false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(boolean restored) {
<b class="nc">&nbsp;        super.init(restored);</b>
<b class="nc">&nbsp;        AtomicBoolean reevalNeeded = new AtomicBoolean(false);</b>
<b class="nc">&nbsp;        Map&lt;AlarmSeverity, AlarmRule&gt; createRules = configuration.getCreateRules();</b>
<b class="nc">&nbsp;        for (AlarmSeverity severity : AlarmSeverity.values()) {</b>
<b class="nc">&nbsp;            AlarmRule rule = createRules.get(severity);</b>
<b class="nc">&nbsp;            if (rule != null) {</b>
<b class="nc">&nbsp;                createRuleStates.compute(severity, (__, ruleState) -&gt; {</b>
<b class="nc">&nbsp;                    return initRuleState(severity, rule, ruleState, reevalNeeded);</b>
&nbsp;                });
&nbsp;            } else {
<b class="nc">&nbsp;                AlarmRuleState state = createRuleStates.remove(severity);</b>
<b class="nc">&nbsp;                if (state != null) {</b>
<b class="nc">&nbsp;                    clearState(state);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        AlarmRule clearRule = configuration.getClearRule();</b>
<b class="nc">&nbsp;        if (clearRule != null) {</b>
<b class="nc">&nbsp;            clearRuleState = initRuleState(null, clearRule, clearRuleState, reevalNeeded);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            if (clearRuleState != null) {</b>
<b class="nc">&nbsp;                clearState(clearRuleState);</b>
<b class="nc">&nbsp;                clearRuleState = null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        log.debug(&quot;Initialized create rule states {} and clear rule state {} for {}. Restored: {}, reeval needed: {}&quot;,</b>
<b class="nc">&nbsp;                createRuleStates, clearRuleState, configuration, restored, reevalNeeded);</b>
&nbsp;
<b class="nc">&nbsp;        if (reevalNeeded.get()) {</b>
<b class="nc">&nbsp;            initCurrentAlarm(ctx);</b>
<b class="nc">&nbsp;            createOrClearAlarms(state -&gt; {</b>
<b class="nc">&nbsp;                if (state.getCondition().getType() == AlarmConditionType.DURATION) {</b>
<b class="nc">&nbsp;                    AlarmEvalResult evalResult = state.reeval(System.currentTimeMillis(), ctx);</b>
<b class="nc">&nbsp;                    if (evalResult.getStatus() == TRUE || evalResult.getStatus() == NOT_YET_TRUE) {</b>
<b class="nc">&nbsp;                        ScheduledFuture&lt;?&gt; future = ctx.scheduleReevaluation(evalResult.getLeftDuration(), actorCtx);</b>
<b class="nc">&nbsp;                        if (future != null) {</b>
<b class="nc">&nbsp;                            state.setDurationCheckFuture(future);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                return AlarmEvalResult.NOT_YET_TRUE;</b>
&nbsp;            }, ctx);
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private AlarmRuleState initRuleState(AlarmSeverity severity, AlarmRule rule, AlarmRuleState ruleState, AtomicBoolean reevalNeeded) {
<b class="nc">&nbsp;        if (ruleState == null) {</b>
<b class="nc">&nbsp;            ruleState = new AlarmRuleState(severity, rule, this);</b>
&nbsp;        } else {
&nbsp;            // when restored
<b class="nc">&nbsp;            ruleState.setAlarmRule(rule);</b>
<b class="nc">&nbsp;            ruleState.setActive(null);</b>
<b class="nc">&nbsp;            AlarmCondition condition = rule.getCondition();</b>
<b class="nc">&nbsp;            if (condition.hasSchedule() || (condition.getType() == AlarmConditionType.DURATION &amp;&amp; !ruleState.isEmpty())) {</b>
<b class="nc">&nbsp;                reevalNeeded.set(true);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return ruleState;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void reset() {
<b class="nc">&nbsp;        super.reset();</b>
<b class="nc">&nbsp;        configuration = null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void close() {
<b class="nc">&nbsp;        super.close();</b>
<b class="nc">&nbsp;        for (AlarmRuleState state : createRuleStates.values()) {</b>
<b class="nc">&nbsp;            clearState(state);</b>
&nbsp;        }
<b class="nc">&nbsp;        clearState(clearRuleState);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;CalculatedFieldResult&gt; performCalculation(Map&lt;String, ArgumentEntry&gt; updatedArgs, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        initCurrentAlarm(ctx);</b>
<b class="nc">&nbsp;        TbAlarmResult result = createOrClearAlarms(state -&gt; {</b>
<b class="nc">&nbsp;            if (updatedArgs != null) {</b>
<b class="nc">&nbsp;                boolean newEvent = !updatedArgs.isEmpty();</b>
<b class="nc">&nbsp;                AlarmEvalResult evalResult = state.eval(newEvent, ctx);</b>
<b class="nc">&nbsp;                if (evalResult.getStatus() == NOT_YET_TRUE &amp;&amp; evalResult.getLeftDuration() &gt; 0) {</b>
<b class="nc">&nbsp;                    long leftDuration = evalResult.getLeftDuration();</b>
<b class="nc">&nbsp;                    ScheduledFuture&lt;?&gt; future = ctx.scheduleReevaluation(leftDuration, actorCtx);</b>
<b class="nc">&nbsp;                    if (future != null) {</b>
<b class="nc">&nbsp;                        state.setDurationCheckFuture(future);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                return evalResult.withCause(NEW_EVENT);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return state.reeval(System.currentTimeMillis(), ctx).withCause(SCHEDULED_REEVALUATION);</b>
&nbsp;            }
&nbsp;        }, ctx);
<b class="nc">&nbsp;        return Futures.immediateFuture(AlarmCalculatedFieldResult.builder()</b>
<b class="nc">&nbsp;                .alarmResult(result)</b>
<b class="nc">&nbsp;                .build());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected boolean updateEntry(ArgumentEntry existingArgumentEntry, ArgumentEntry newArgumentEntry, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        if (!(existingArgumentEntry instanceof SingleValueArgumentEntry existingEntry) ||</b>
<b class="nc">&nbsp;            !(newArgumentEntry instanceof SingleValueArgumentEntry newEntry)) {</b>
<b class="nc">&nbsp;            return super.updateEntry(existingArgumentEntry, newArgumentEntry, ctx);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (newEntry.getTs() &lt; existingEntry.getTs()) {</b>
<b class="nc">&nbsp;            if (existingEntry.isDefaultValue()) {</b>
<b class="nc">&nbsp;                existingEntry.setTs(newEntry.getTs());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return super.updateEntry(existingEntry, newEntry, ctx);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void processAlarmAction(Alarm alarm, ActionType action) {
<b class="nc">&nbsp;        switch (action) {</b>
<b class="nc">&nbsp;            case ALARM_ACK -&gt; processAlarmAck(alarm);</b>
<b class="nc">&nbsp;            case ALARM_CLEAR -&gt; processAlarmClear(alarm);</b>
<b class="nc">&nbsp;            case ALARM_DELETE -&gt; processAlarmDelete(alarm);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void processAlarmClear(Alarm alarm) {
<b class="nc">&nbsp;        currentAlarm = null;</b>
<b class="nc">&nbsp;        createRuleStates.values().forEach(this::clearState);</b>
<b class="nc">&nbsp;        clearState(clearRuleState);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void processAlarmAck(Alarm alarm) {
<b class="nc">&nbsp;        currentAlarm.setAcknowledged(alarm.isAcknowledged());</b>
<b class="nc">&nbsp;        currentAlarm.setAckTs(alarm.getAckTs());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void processAlarmDelete(Alarm alarm) {
<b class="nc">&nbsp;        processAlarmClear(alarm);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbAlarmResult createOrClearAlarms(Function&lt;AlarmRuleState, AlarmEvalResult&gt; evalFunction,
&nbsp;                                              CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        AlarmEvalResult evalResult = null;</b>
<b class="nc">&nbsp;        AlarmRuleState resultState = null;</b>
<b class="nc">&nbsp;        AlarmRuleState.StateInfo resultStateInfo = null;</b>
&nbsp;
<b class="nc">&nbsp;        for (AlarmRuleState state : createRuleStates.values()) {</b>
<b class="nc">&nbsp;            evalResult = evalFunction.apply(state);</b>
<b class="nc">&nbsp;            log.debug(&quot;Evaluated create rule {} with args {}. Result: {}&quot;, state, arguments, evalResult);</b>
<b class="nc">&nbsp;            if (evalResult.getStatus() == TRUE) {</b>
<b class="nc">&nbsp;                resultState = state;</b>
&nbsp;                break;
<b class="nc">&nbsp;            } else if (evalResult.getStatus() == FALSE) {</b>
<b class="nc">&nbsp;                clearState(state);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        TbAlarmResult result = null;</b>
<b class="nc">&nbsp;        if (resultState != null) {</b>
<b class="nc">&nbsp;            result = calculateAlarmResult(resultState, evalResult, ctx);</b>
<b class="nc">&nbsp;            resultStateInfo = resultState.getStateInfo();</b>
<b class="nc">&nbsp;            log.debug(&quot;Alarm result for state {}: {}&quot;, resultState, result);</b>
<b class="nc">&nbsp;            clearState(clearRuleState);</b>
<b class="nc">&nbsp;        } else if (currentAlarm != null &amp;&amp; clearRuleState != null) {</b>
<b class="nc">&nbsp;            evalResult = evalFunction.apply(clearRuleState);</b>
<b class="nc">&nbsp;            log.debug(&quot;Evaluated clear rule {} with args {}. Result: {}&quot;, clearRuleState, arguments, evalResult);</b>
<b class="nc">&nbsp;            if (evalResult.getStatus() == TRUE) {</b>
<b class="nc">&nbsp;                resultStateInfo = clearRuleState.getStateInfo();</b>
<b class="nc">&nbsp;                clearState(clearRuleState);</b>
<b class="nc">&nbsp;                for (AlarmRuleState state : createRuleStates.values()) {</b>
<b class="nc">&nbsp;                    clearState(state);</b>
&nbsp;                }
<b class="nc">&nbsp;                AlarmApiCallResult clearResult = ctx.getAlarmService().clearAlarm(</b>
<b class="nc">&nbsp;                        ctx.getTenantId(), currentAlarm.getId(), System.currentTimeMillis(), createDetails(clearRuleState), false</b>
&nbsp;                );
<b class="nc">&nbsp;                if (clearResult.isCleared()) {</b>
<b class="nc">&nbsp;                    result = TbAlarmResult.builder()</b>
<b class="nc">&nbsp;                            .isCleared(true)</b>
<b class="nc">&nbsp;                            .alarm(clearResult.getAlarm())</b>
<b class="nc">&nbsp;                            .build();</b>
<b class="nc">&nbsp;                    resultState = clearRuleState;</b>
&nbsp;                }
<b class="nc">&nbsp;                currentAlarm = null;</b>
<b class="nc">&nbsp;            } else if (evalResult.getStatus() == FALSE) {</b>
<b class="nc">&nbsp;                clearState(clearRuleState);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (result != null &amp;&amp; resultState != null) {</b>
<b class="nc">&nbsp;            result.setConditionRepeats(resultStateInfo.eventCount());</b>
<b class="nc">&nbsp;            result.setConditionDuration(resultStateInfo.duration());</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void clearState(AlarmRuleState state) {
<b class="nc">&nbsp;        if (state != null) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Clearing rule state {}&quot;, state);</b>
<b class="nc">&nbsp;            state.clear();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void initCurrentAlarm(CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        if (!initialFetchDone) {</b>
<b class="nc">&nbsp;            Alarm alarm = ctx.getAlarmService().findLatestActiveByOriginatorAndType(ctx.getTenantId(), entityId, alarmType);</b>
<b class="nc">&nbsp;            if (alarm != null &amp;&amp; !alarm.getStatus().isCleared()) {</b>
<b class="nc">&nbsp;                currentAlarm = alarm;</b>
&nbsp;            }
<b class="nc">&nbsp;            initialFetchDone = true;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TbAlarmResult calculateAlarmResult(AlarmRuleState ruleState, AlarmEvalResult evalResult, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        AlarmSeverity severity = ruleState.getSeverity();</b>
<b class="nc">&nbsp;        if (currentAlarm != null) {</b>
<b class="nc">&nbsp;            AlarmSeverity oldSeverity = currentAlarm.getSeverity();</b>
<b class="nc">&nbsp;            if (severity.ordinal() &gt; oldSeverity.ordinal()) {</b>
<b class="nc">&nbsp;                log.trace(&quot;Skipping alarm update for result state {} for eval result {} because severity is decreased&quot;, ruleState, evalResult);</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (severity.ordinal() == oldSeverity.ordinal() &amp;&amp; evalResult.getCause() == SCHEDULED_REEVALUATION) {</b>
<b class="nc">&nbsp;                log.trace(&quot;Skipping alarm update for result state {} for eval result {}&quot;, ruleState, evalResult);</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            currentAlarm.setEndTs(System.currentTimeMillis());</b>
<b class="nc">&nbsp;            currentAlarm.setDetails(createDetails(ruleState));</b>
<b class="nc">&nbsp;            currentAlarm.setSeverity(severity);</b>
<b class="nc">&nbsp;            AlarmApiCallResult result = ctx.getAlarmService().updateAlarm(AlarmUpdateRequest.fromAlarm(currentAlarm));</b>
<b class="nc">&nbsp;            currentAlarm = result.getAlarm();</b>
<b class="nc">&nbsp;            return TbAlarmResult.fromAlarmResult(result);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            var newAlarm = new Alarm();</b>
<b class="nc">&nbsp;            newAlarm.setType(alarmType);</b>
<b class="nc">&nbsp;            newAlarm.setAcknowledged(false);</b>
<b class="nc">&nbsp;            newAlarm.setCleared(false);</b>
<b class="nc">&nbsp;            newAlarm.setSeverity(severity);</b>
<b class="nc">&nbsp;            long startTs = getLatestTimestamp();</b>
<b class="nc">&nbsp;            long currentTime = System.currentTimeMillis();</b>
<b class="nc">&nbsp;            if (startTs &lt;= 0L || startTs &gt; currentTime) {</b>
<b class="nc">&nbsp;                startTs = currentTime;</b>
&nbsp;            }
<b class="nc">&nbsp;            newAlarm.setStartTs(startTs);</b>
<b class="nc">&nbsp;            newAlarm.setEndTs(startTs);</b>
<b class="nc">&nbsp;            newAlarm.setDetails(createDetails(ruleState));</b>
<b class="nc">&nbsp;            newAlarm.setOriginator(entityId);</b>
<b class="nc">&nbsp;            newAlarm.setTenantId(ctx.getTenantId());</b>
<b class="nc">&nbsp;            newAlarm.setPropagate(configuration.isPropagate());</b>
<b class="nc">&nbsp;            newAlarm.setPropagateToOwner(configuration.isPropagateToOwner());</b>
<b class="nc">&nbsp;            newAlarm.setPropagateToTenant(configuration.isPropagateToTenant());</b>
<b class="nc">&nbsp;            if (configuration.getPropagateRelationTypes() != null) {</b>
<b class="nc">&nbsp;                newAlarm.setPropagateRelationTypes(configuration.getPropagateRelationTypes());</b>
&nbsp;            }
<b class="nc">&nbsp;            AlarmApiCallResult result = ctx.getAlarmService().createAlarm(AlarmCreateOrUpdateActiveRequest.fromAlarm(newAlarm));</b>
<b class="nc">&nbsp;            currentAlarm = result.getAlarm();</b>
<b class="nc">&nbsp;            return TbAlarmResult.fromAlarmResult(result);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode createDetails(AlarmRuleState ruleState) {
&nbsp;        JsonNode alarmDetails;
<b class="nc">&nbsp;        String alarmDetailsStr = ruleState.getAlarmRule().getAlarmDetails();</b>
<b class="nc">&nbsp;        DashboardId dashboardId = ruleState.getAlarmRule().getDashboardId();</b>
&nbsp;
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(alarmDetailsStr) || dashboardId != null) {</b>
<b class="nc">&nbsp;            ObjectNode newDetails = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;            if (StringUtils.isNotEmpty(alarmDetailsStr)) {</b>
<b class="nc">&nbsp;                for (Map.Entry&lt;String, ArgumentEntry&gt; entry : arguments.entrySet()) {</b>
<b class="nc">&nbsp;                    String key = entry.getKey();</b>
<b class="nc">&nbsp;                    ArgumentEntry value = entry.getValue();</b>
<b class="nc">&nbsp;                    alarmDetailsStr = alarmDetailsStr.replaceAll(String.format(&quot;\\$\\{%s}&quot;, key), String.valueOf(value.getValue()));</b>
&nbsp;                }
<b class="nc">&nbsp;                newDetails.put(&quot;data&quot;, alarmDetailsStr);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (dashboardId != null) {</b>
<b class="nc">&nbsp;                newDetails.put(&quot;dashboardId&quot;, dashboardId.getId().toString());</b>
&nbsp;            }
<b class="nc">&nbsp;            alarmDetails = newDetails;</b>
<b class="nc">&nbsp;        } else if (currentAlarm != null) {</b>
<b class="nc">&nbsp;            alarmDetails = currentAlarm.getDetails();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            alarmDetails = JacksonUtil.newObjectNode();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return alarmDetails;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public boolean eval(AlarmConditionExpression expression, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        if (expression instanceof TbelAlarmConditionExpression tbelExpression) {</b>
<b class="nc">&nbsp;            Object result = ctx.evaluateTbelExpression(tbelExpression.getExpression(), this).get();</b>
<b class="nc">&nbsp;            if (result instanceof Boolean booleanResult) {</b>
<b class="nc">&nbsp;                return booleanResult;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;Condition expression returned non-boolean value: &#39;&quot; + result + &quot;&#39;&quot;);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            SimpleAlarmConditionExpression simpleExpression = (SimpleAlarmConditionExpression) expression;</b>
<b class="nc">&nbsp;            ComplexOperation operation = simpleExpression.getOperation();</b>
<b class="nc">&nbsp;            if (operation == null) {</b>
<b class="nc">&nbsp;                operation = ComplexOperation.AND;</b>
&nbsp;            }
<b class="nc">&nbsp;            return switch (operation) {</b>
<b class="nc">&nbsp;                case AND -&gt; simpleExpression.getFilters().stream()</b>
<b class="nc">&nbsp;                        .allMatch(filter -&gt; eval(getArgument(filter.getArgument()), filter));</b>
<b class="nc">&nbsp;                case OR -&gt; simpleExpression.getFilters().stream()</b>
<b class="nc">&nbsp;                        .anyMatch(filter -&gt; eval(getArgument(filter.getArgument()), filter));</b>
&nbsp;            };
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean eval(SingleValueArgumentEntry argument, AlarmConditionFilter filter) {
<b class="nc">&nbsp;        ComplexOperation operation = filter.getOperation();</b>
<b class="nc">&nbsp;        if (operation == null) {</b>
<b class="nc">&nbsp;            operation = ComplexOperation.AND;</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (operation) {</b>
<b class="nc">&nbsp;            case AND -&gt; filter.getPredicates().stream()</b>
<b class="nc">&nbsp;                    .allMatch(predicate -&gt; eval(argument, predicate));</b>
<b class="nc">&nbsp;            case OR -&gt; filter.getPredicates().stream()</b>
<b class="nc">&nbsp;                    .anyMatch(predicate -&gt; eval(argument, predicate));</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean eval(SingleValueArgumentEntry argument, KeyFilterPredicate predicate) {
<b class="nc">&nbsp;        return switch (predicate.getType()) {</b>
<b class="nc">&nbsp;            case STRING -&gt; evalStrPredicate(argument, (StringFilterPredicate) predicate);</b>
<b class="nc">&nbsp;            case NUMERIC -&gt; evalNumPredicate(argument, (NumericFilterPredicate) predicate);</b>
<b class="nc">&nbsp;            case BOOLEAN -&gt; evalBooleanPredicate(argument, (BooleanFilterPredicate) predicate);</b>
<b class="nc">&nbsp;            case NO_DATA -&gt; evalNoDataPredicate(argument, (NoDataFilterPredicate) predicate);</b>
<b class="nc">&nbsp;            case COMPLEX -&gt; evalComplexPredicate(argument, (ComplexFilterPredicate) predicate);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean evalComplexPredicate(SingleValueArgumentEntry argument, ComplexFilterPredicate complexPredicate) {
<b class="nc">&nbsp;        return switch (complexPredicate.getOperation()) {</b>
&nbsp;            case OR -&gt; {
<b class="nc">&nbsp;                for (KeyFilterPredicate predicate : complexPredicate.getPredicates()) {</b>
<b class="nc">&nbsp;                    if (eval(argument, predicate)) {</b>
<b class="nc">&nbsp;                        yield true;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                yield false;</b>
&nbsp;            }
&nbsp;            case AND -&gt; {
<b class="nc">&nbsp;                for (KeyFilterPredicate predicate : complexPredicate.getPredicates()) {</b>
<b class="nc">&nbsp;                    if (!eval(argument, predicate)) {</b>
<b class="nc">&nbsp;                        yield false;</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                yield true;</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean evalBooleanPredicate(SingleValueArgumentEntry argument, BooleanFilterPredicate predicate) {
<b class="nc">&nbsp;        Boolean value = KvUtil.getBoolValue(argument.getKvEntryValue());</b>
<b class="nc">&nbsp;        if (value == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        Boolean predicateValue = resolveValue(predicate.getValue(), KvUtil::getBoolValue);</b>
<b class="nc">&nbsp;        if (predicateValue == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean evalNumPredicate(SingleValueArgumentEntry argument, NumericFilterPredicate predicate) {
<b class="nc">&nbsp;        Double value = KvUtil.getDoubleValue(argument.getKvEntryValue());</b>
<b class="nc">&nbsp;        if (value == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        Double predicateValue = resolveValue(predicate.getValue(), KvUtil::getDoubleValue);</b>
<b class="nc">&nbsp;        if (predicateValue == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case GREATER -&gt; value &gt; predicateValue;</b>
<b class="nc">&nbsp;            case GREATER_OR_EQUAL -&gt; value &gt;= predicateValue;</b>
<b class="nc">&nbsp;            case LESS -&gt; value &lt; predicateValue;</b>
<b class="nc">&nbsp;            case LESS_OR_EQUAL -&gt; value &lt;= predicateValue;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean evalStrPredicate(SingleValueArgumentEntry argument, StringFilterPredicate predicate) {
<b class="nc">&nbsp;        String value = KvUtil.getStringValue(argument.getKvEntryValue());</b>
<b class="nc">&nbsp;        if (value == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        String predicateValue = resolveValue(predicate.getValue(), KvUtil::getStringValue);</b>
<b class="nc">&nbsp;        if (predicateValue == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (predicate.isIgnoreCase()) {</b>
<b class="nc">&nbsp;            value = value.toLowerCase();</b>
<b class="nc">&nbsp;            predicateValue = predicateValue.toLowerCase();</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case CONTAINS -&gt; value.contains(predicateValue);</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case STARTS_WITH -&gt; value.startsWith(predicateValue);</b>
<b class="nc">&nbsp;            case ENDS_WITH -&gt; value.endsWith(predicateValue);</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case NOT_CONTAINS -&gt; !value.contains(predicateValue);</b>
<b class="nc">&nbsp;            case IN -&gt; equalsAny(value, splitByCommaWithoutQuotes(predicateValue));</b>
<b class="nc">&nbsp;            case NOT_IN -&gt; !equalsAny(value, splitByCommaWithoutQuotes(predicateValue));</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private boolean evalNoDataPredicate(SingleValueArgumentEntry argument, NoDataFilterPredicate predicate) {
<b class="nc">&nbsp;        long passedMs = System.currentTimeMillis() - argument.getTs();</b>
<b class="nc">&nbsp;        long duration = resolveValue(predicate.getDuration(), KvUtil::getLongValue);</b>
<b class="nc">&nbsp;        if (duration &gt; 0) {</b>
<b class="nc">&nbsp;            long requiredDuration = predicate.getUnit().toMillis(duration);</b>
<b class="nc">&nbsp;            log.trace(&quot;[{}] No data for argument {} during {} ms, required duration: {} ms&quot;, ctx, argument, passedMs, requiredDuration);</b>
<b class="nc">&nbsp;            return passedMs &gt;= requiredDuration;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected &lt;T&gt; T resolveValue(AlarmConditionValue&lt;T&gt; conditionValue, Function&lt;KvEntry, T&gt; mapper) {
<b class="nc">&nbsp;        T value = conditionValue.getStaticValue();</b>
<b class="nc">&nbsp;        if (value == null) {</b>
<b class="nc">&nbsp;            String argument = conditionValue.getDynamicValueArgument();</b>
<b class="nc">&nbsp;            SingleValueArgumentEntry entry = getArgument(argument);</b>
<b class="nc">&nbsp;            value = mapper.apply(entry.getKvEntryValue());</b>
<b class="nc">&nbsp;            if (value == null) {</b>
<b class="nc">&nbsp;                throw new IllegalArgumentException(&quot;No proper value found for argument &quot; + argument);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected SingleValueArgumentEntry getArgument(String key) {
<b class="nc">&nbsp;        SingleValueArgumentEntry entry = (SingleValueArgumentEntry) arguments.get(key);</b>
<b class="nc">&nbsp;        if (entry == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Argument &#39;&quot; + key + &quot;&#39; is missing&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return entry;</b>
&nbsp;    }
&nbsp;
&nbsp;    private AlarmCalculatedFieldConfiguration getConfiguration(CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        return (AlarmCalculatedFieldConfiguration) ctx.getCalculatedField().getConfiguration();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void validateNewEntry(String key, ArgumentEntry newEntry) {
<b class="nc">&nbsp;        if (!(newEntry instanceof SingleValueArgumentEntry)) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Only single value arguments supported&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public CalculatedFieldType getType() {
<b class="nc">&nbsp;        return CalculatedFieldType.ALARM;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

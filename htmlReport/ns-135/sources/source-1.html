<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EdqsProcessor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.edqs.processor</a>
</div>

<h1>Coverage Summary for Class: EdqsProcessor (org.thingsboard.server.edqs.processor)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EdqsProcessor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/114)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.edqs.processor;
&nbsp;
&nbsp;import com.google.common.collect.Sets;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.ListeningExecutorService;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import lombok.Getter;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.context.ConfigurableApplicationContext;
&nbsp;import org.springframework.context.event.EventListener;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.ExceptionUtil;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.common.util.ThingsBoardThreadFactory;
&nbsp;import org.thingsboard.server.common.data.ObjectType;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsEvent;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsEventType;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsObject;
&nbsp;import org.thingsboard.server.common.data.edqs.query.EdqsRequest;
&nbsp;import org.thingsboard.server.common.data.edqs.query.EdqsResponse;
&nbsp;import org.thingsboard.server.common.data.edqs.query.QueryResult;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.util.CollectionsUtil;
&nbsp;import org.thingsboard.server.common.msg.queue.ServiceType;
&nbsp;import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;
&nbsp;import org.thingsboard.server.edqs.repo.EdqsRepository;
&nbsp;import org.thingsboard.server.edqs.state.EdqsPartitionService;
&nbsp;import org.thingsboard.server.edqs.state.EdqsStateService;
&nbsp;import org.thingsboard.server.edqs.util.EdqsMapper;
&nbsp;import org.thingsboard.server.edqs.util.VersionsStore;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.EdqsEventMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.FromEdqsMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ToEdqsMsg;
&nbsp;import org.thingsboard.server.queue.TbQueueHandler;
&nbsp;import org.thingsboard.server.queue.common.PartitionedQueueResponseTemplate;
&nbsp;import org.thingsboard.server.queue.common.TbProtoQueueMsg;
&nbsp;import org.thingsboard.server.queue.common.consumer.PartitionedQueueConsumerManager;
&nbsp;import org.thingsboard.server.queue.discovery.DiscoveryService;
&nbsp;import org.thingsboard.server.queue.discovery.QueueKey;
&nbsp;import org.thingsboard.server.queue.discovery.TopicService;
&nbsp;import org.thingsboard.server.queue.discovery.event.PartitionChangeEvent;
&nbsp;import org.thingsboard.server.queue.edqs.EdqsComponent;
&nbsp;import org.thingsboard.server.queue.edqs.EdqsConfig;
&nbsp;import org.thingsboard.server.queue.edqs.EdqsConfig.EdqsPartitioningStrategy;
&nbsp;import org.thingsboard.server.queue.edqs.EdqsExecutors;
&nbsp;import org.thingsboard.server.queue.edqs.EdqsQueueFactory;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;import java.util.function.Consumer;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.common.msg.queue.TopicPartitionInfo.withTopic;
&nbsp;
&nbsp;@EdqsComponent
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class EdqsProcessor implements TbQueueHandler&lt;TbProtoQueueMsg&lt;ToEdqsMsg&gt;, TbProtoQueueMsg&lt;FromEdqsMsg&gt;&gt; {
&nbsp;
&nbsp;    private final EdqsQueueFactory queueFactory;
&nbsp;    private final EdqsMapper mapper;
&nbsp;    private final EdqsRepository repository;
&nbsp;    private final EdqsConfig config;
&nbsp;    private final EdqsExecutors edqsExecutors;
&nbsp;    private final EdqsPartitionService partitionService;
&nbsp;    private final DiscoveryService discoveryService;
&nbsp;    private final TopicService topicService;
&nbsp;    private final ConfigurableApplicationContext applicationContext;
&nbsp;    private final EdqsStateService stateService;
&nbsp;
&nbsp;    private PartitionedQueueConsumerManager&lt;TbProtoQueueMsg&lt;ToEdqsMsg&gt;&gt; eventConsumer;
&nbsp;    private PartitionedQueueResponseTemplate&lt;TbProtoQueueMsg&lt;ToEdqsMsg&gt;, TbProtoQueueMsg&lt;FromEdqsMsg&gt;&gt; responseTemplate;
&nbsp;    private ListeningExecutorService requestExecutor;
&nbsp;    private VersionsStore versionsStore;
&nbsp;    private final AtomicInteger counter = new AtomicInteger();
&nbsp;
&nbsp;    @Getter
&nbsp;    private Consumer&lt;Throwable&gt; errorHandler;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    private void init() {
<b class="nc">&nbsp;        errorHandler = error -&gt; {</b>
<b class="nc">&nbsp;            if (error instanceof OutOfMemoryError) {</b>
<b class="nc">&nbsp;                log.error(&quot;OOM detected, shutting down&quot;);</b>
<b class="nc">&nbsp;                repository.clear();</b>
<b class="nc">&nbsp;                discoveryService.setReady(false);</b>
<b class="nc">&nbsp;                Executors.newSingleThreadExecutor(ThingsBoardThreadFactory.forName(&quot;edqs-shutdown&quot;))</b>
<b class="nc">&nbsp;                        .execute(applicationContext::close);</b>
&nbsp;            }
&nbsp;        };
<b class="nc">&nbsp;        requestExecutor = edqsExecutors.getRequestExecutor();</b>
<b class="nc">&nbsp;        versionsStore = new VersionsStore(config.getVersionsCacheTtl());</b>
&nbsp;
<b class="nc">&nbsp;        eventConsumer = PartitionedQueueConsumerManager.&lt;TbProtoQueueMsg&lt;ToEdqsMsg&gt;&gt;create()</b>
<b class="nc">&nbsp;                .queueKey(new QueueKey(ServiceType.EDQS, config.getEventsTopic()))</b>
<b class="nc">&nbsp;                .topic(topicService.buildTopicName(config.getEventsTopic()))</b>
<b class="nc">&nbsp;                .pollInterval(config.getPollInterval())</b>
<b class="nc">&nbsp;                .msgPackProcessor((msgs, consumer, consumerKey, config) -&gt; {</b>
<b class="nc">&nbsp;                    for (TbProtoQueueMsg&lt;ToEdqsMsg&gt; queueMsg : msgs) {</b>
<b class="nc">&nbsp;                        if (consumer.isStopped()) {</b>
&nbsp;                            return;
&nbsp;                        }
&nbsp;                        try {
<b class="nc">&nbsp;                            ToEdqsMsg msg = queueMsg.getValue();</b>
<b class="nc">&nbsp;                            process(msg, true);</b>
&nbsp;                        } catch (Exception t) {
<b class="nc">&nbsp;                            log.error(&quot;Failed to process message: {}&quot;, queueMsg, t);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    consumer.commit();</b>
&nbsp;                })
<b class="nc">&nbsp;                .consumerCreator((config, tpi) -&gt; queueFactory.createEdqsEventsConsumer())</b>
<b class="nc">&nbsp;                .queueAdmin(queueFactory.getEdqsQueueAdmin())</b>
<b class="nc">&nbsp;                .consumerExecutor(edqsExecutors.getConsumersExecutor())</b>
<b class="nc">&nbsp;                .taskExecutor(edqsExecutors.getConsumerTaskExecutor())</b>
<b class="nc">&nbsp;                .scheduler(edqsExecutors.getScheduler())</b>
<b class="nc">&nbsp;                .uncaughtErrorHandler(errorHandler)</b>
<b class="nc">&nbsp;                .build();</b>
<b class="nc">&nbsp;        responseTemplate = queueFactory.createEdqsResponseTemplate(this);</b>
&nbsp;
<b class="nc">&nbsp;        stateService.init(eventConsumer, List.of(responseTemplate.getRequestConsumer()));</b>
&nbsp;    }
&nbsp;
&nbsp;    @EventListener
&nbsp;    public void onPartitionsChange(PartitionChangeEvent event) {
<b class="nc">&nbsp;        if (event.getServiceType() != ServiceType.EDQS) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            Set&lt;TopicPartitionInfo&gt; newPartitions = event.getNewPartitions().get(new QueueKey(ServiceType.EDQS));</b>
<b class="nc">&nbsp;            stateService.process(withTopic(newPartitions, topicService.buildTopicName(config.getStateTopic())));</b>
&nbsp;            // partitions for event and request consumers are updated by stateService
&nbsp;
<b class="nc">&nbsp;            Set&lt;TopicPartitionInfo&gt; oldPartitions = event.getOldPartitions().get(new QueueKey(ServiceType.EDQS));</b>
<b class="nc">&nbsp;            if (CollectionsUtil.isNotEmpty(oldPartitions)) {</b>
<b class="nc">&nbsp;                Set&lt;Integer&gt; removedPartitions = Sets.difference(oldPartitions, newPartitions).stream()</b>
<b class="nc">&nbsp;                        .map(tpi -&gt; tpi.getPartition().orElse(-1)).collect(Collectors.toSet());</b>
<b class="nc">&nbsp;                if (removedPartitions.isEmpty()) {</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (config.getPartitioningStrategy() == EdqsPartitioningStrategy.TENANT) {</b>
<b class="nc">&nbsp;                    repository.clearIf(tenantId -&gt; {</b>
<b class="nc">&nbsp;                        Integer partition = partitionService.resolvePartition(tenantId, null);</b>
<b class="nc">&nbsp;                        return removedPartitions.contains(partition);</b>
&nbsp;                    });
&nbsp;                } else {
<b class="nc">&nbsp;                    log.warn(&quot;Partitions {} were removed but shouldn&#39;t be (due to NONE partitioning strategy)&quot;, removedPartitions);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (Throwable t) {
<b class="nc">&nbsp;            log.error(&quot;Failed to handle partition change event {}&quot;, event, t);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;TbProtoQueueMsg&lt;FromEdqsMsg&gt;&gt; handle(TbProtoQueueMsg&lt;ToEdqsMsg&gt; queueMsg) {
<b class="nc">&nbsp;        ToEdqsMsg toEdqsMsg = queueMsg.getValue();</b>
<b class="nc">&nbsp;        return requestExecutor.submit(() -&gt; {</b>
&nbsp;            EdqsRequest request;
&nbsp;            TenantId tenantId;
&nbsp;            CustomerId customerId;
&nbsp;            try {
<b class="nc">&nbsp;                request = Objects.requireNonNull(JacksonUtil.fromString(toEdqsMsg.getRequestMsg().getValue(), EdqsRequest.class));</b>
<b class="nc">&nbsp;                tenantId = getTenantId(toEdqsMsg);</b>
<b class="nc">&nbsp;                customerId = getCustomerId(toEdqsMsg);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Failed to parse request msg: {}&quot;, toEdqsMsg, e);</b>
&nbsp;                throw e;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            EdqsResponse response = processRequest(tenantId, customerId, request);</b>
<b class="nc">&nbsp;            return new TbProtoQueueMsg&lt;&gt;(queueMsg.getKey(), FromEdqsMsg.newBuilder()</b>
<b class="nc">&nbsp;                    .setResponseMsg(TransportProtos.EdqsResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                            .setValue(JacksonUtil.toString(response))</b>
<b class="nc">&nbsp;                            .build())</b>
<b class="nc">&nbsp;                    .build(), queueMsg.getHeaders());</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbProtoQueueMsg&lt;FromEdqsMsg&gt; constructErrorResponseMsg(TbProtoQueueMsg&lt;ToEdqsMsg&gt; request, Throwable e) {
<b class="nc">&nbsp;        EdqsResponse response = new EdqsResponse();</b>
&nbsp;        String errorMessage;
<b class="nc">&nbsp;        if (e instanceof org.apache.kafka.common.errors.RecordTooLargeException) {</b>
<b class="nc">&nbsp;            errorMessage = &quot;Result set is too large&quot;;</b>
<b class="nc">&nbsp;        } else if (e instanceof IllegalArgumentException || e instanceof NullPointerException) {</b>
<b class="nc">&nbsp;            errorMessage = &quot;Invalid request format or missing data: &quot; + ExceptionUtil.getMessage(e);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            errorMessage = ExceptionUtil.getMessage(e);</b>
&nbsp;        }
<b class="nc">&nbsp;        response.setError(errorMessage);</b>
<b class="nc">&nbsp;        return new TbProtoQueueMsg&lt;&gt;(request.getKey(), FromEdqsMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setResponseMsg(TransportProtos.EdqsResponseMsg.newBuilder()</b>
<b class="nc">&nbsp;                        .setValue(JacksonUtil.toString(response))</b>
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .build(), request.getHeaders());</b>
&nbsp;    }
&nbsp;
&nbsp;    private EdqsResponse processRequest(TenantId tenantId, CustomerId customerId, EdqsRequest request) {
<b class="nc">&nbsp;        EdqsResponse response = new EdqsResponse();</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (request.getEntityDataQuery() != null) {</b>
<b class="nc">&nbsp;                PageData&lt;QueryResult&gt; result = repository.findEntityDataByQuery(tenantId, customerId,</b>
<b class="nc">&nbsp;                        request.getEntityDataQuery(), false);</b>
<b class="nc">&nbsp;                response.setEntityDataQueryResult(result.mapData(QueryResult::toOldEntityData));</b>
<b class="nc">&nbsp;            } else if (request.getEntityCountQuery() != null) {</b>
<b class="nc">&nbsp;                long result = repository.countEntitiesByQuery(tenantId, customerId, request.getEntityCountQuery(), tenantId.isSysTenantId());</b>
<b class="nc">&nbsp;                response.setEntityCountQueryResult(result);</b>
&nbsp;            }
<b class="nc">&nbsp;            log.trace(&quot;[{}] Request: {}, response: {}&quot;, tenantId, request, response);</b>
&nbsp;        } catch (Throwable e) {
<b class="nc">&nbsp;            log.error(&quot;[{}] Failed to process request: {}&quot;, tenantId, request, e);</b>
<b class="nc">&nbsp;            response.setError(ExceptionUtil.getMessage(e));</b>
&nbsp;        }
<b class="nc">&nbsp;        return response;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void process(ToEdqsMsg edqsMsg, boolean backup) {
<b class="nc">&nbsp;        log.trace(&quot;Processing message: {}&quot;, edqsMsg);</b>
<b class="nc">&nbsp;        if (edqsMsg.hasEventMsg()) {</b>
<b class="nc">&nbsp;            EdqsEventMsg eventMsg = edqsMsg.getEventMsg();</b>
<b class="nc">&nbsp;            TenantId tenantId = getTenantId(edqsMsg);</b>
<b class="nc">&nbsp;            ObjectType objectType = ObjectType.valueOf(eventMsg.getObjectType());</b>
<b class="nc">&nbsp;            EdqsEventType eventType = EdqsEventType.valueOf(eventMsg.getEventType());</b>
<b class="nc">&nbsp;            Long version = eventMsg.hasVersion() ? eventMsg.getVersion() : null;</b>
<b class="nc">&nbsp;            EdqsObject object = mapper.deserialize(objectType, eventMsg.getData().toByteArray(), false);</b>
&nbsp;
<b class="nc">&nbsp;            if (version != null) {</b>
<b class="nc">&nbsp;                if (!versionsStore.isNew(mapper.getKey(object), version)) {</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;            } else if (!ObjectType.unversionedTypes.contains(objectType)) {</b>
<b class="nc">&nbsp;                log.warn(&quot;[{}] {} doesn&#39;t have version: {}&quot;, tenantId, objectType, object);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (backup) {</b>
<b class="nc">&nbsp;                stateService.save(tenantId, objectType, object.stringKey(), eventType, edqsMsg);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            int count = counter.incrementAndGet();</b>
<b class="nc">&nbsp;            if (count % 100000 == 0) {</b>
<b class="nc">&nbsp;                log.info(&quot;Processed {} events&quot;, count);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            EdqsEvent event = EdqsEvent.builder()</b>
<b class="nc">&nbsp;                    .tenantId(tenantId)</b>
<b class="nc">&nbsp;                    .objectType(objectType)</b>
<b class="nc">&nbsp;                    .eventType(eventType)</b>
<b class="nc">&nbsp;                    .object(object)</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            log.debug(&quot;Processing event: {}&quot;, event);</b>
<b class="nc">&nbsp;            repository.processEvent(event);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TenantId getTenantId(ToEdqsMsg edqsMsg) {
<b class="nc">&nbsp;        return TenantId.fromUUID(new UUID(edqsMsg.getTenantIdMSB(), edqsMsg.getTenantIdLSB()));</b>
&nbsp;    }
&nbsp;
&nbsp;    private CustomerId getCustomerId(ToEdqsMsg edqsMsg) {
<b class="nc">&nbsp;        if (edqsMsg.getCustomerIdMSB() != 0 &amp;&amp; edqsMsg.getCustomerIdLSB() != 0) {</b>
<b class="nc">&nbsp;            return new CustomerId(new UUID(edqsMsg.getCustomerIdMSB(), edqsMsg.getCustomerIdLSB()));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    public void destroy() throws InterruptedException {
<b class="nc">&nbsp;        eventConsumer.stop();</b>
<b class="nc">&nbsp;        eventConsumer.awaitStop();</b>
<b class="nc">&nbsp;        responseTemplate.stop();</b>
<b class="nc">&nbsp;        stateService.stop();</b>
<b class="nc">&nbsp;        versionsStore.shutdown();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AppActor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.actors.app</a>
</div>

<h1>Coverage Summary for Class: AppActor (org.thingsboard.server.actors.app)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AppActor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AppActor$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AppActor$ActorCreator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.actors.app;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.actors.ActorSystemContext;
&nbsp;import org.thingsboard.server.actors.ProcessFailureStrategy;
&nbsp;import org.thingsboard.server.actors.TbActor;
&nbsp;import org.thingsboard.server.actors.TbActorCtx;
&nbsp;import org.thingsboard.server.actors.TbActorException;
&nbsp;import org.thingsboard.server.actors.TbActorId;
&nbsp;import org.thingsboard.server.actors.TbActorRef;
&nbsp;import org.thingsboard.server.actors.TbEntityActorId;
&nbsp;import org.thingsboard.server.actors.device.SessionTimeoutCheckMsg;
&nbsp;import org.thingsboard.server.actors.service.ContextAwareActor;
&nbsp;import org.thingsboard.server.actors.service.ContextBasedCreator;
&nbsp;import org.thingsboard.server.actors.service.DefaultActorService;
&nbsp;import org.thingsboard.server.actors.tenant.TenantActor;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.TenantProfileId;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterable;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentLifecycleEvent;
&nbsp;import org.thingsboard.server.common.msg.MsgType;
&nbsp;import org.thingsboard.server.common.msg.TbActorMsg;
&nbsp;import org.thingsboard.server.common.msg.ToCalculatedFieldSystemMsg;
&nbsp;import org.thingsboard.server.common.msg.aware.TenantAwareMsg;
&nbsp;import org.thingsboard.server.common.msg.plugin.ComponentLifecycleMsg;
&nbsp;import org.thingsboard.server.common.msg.queue.QueueToRuleEngineMsg;
&nbsp;import org.thingsboard.server.common.msg.queue.RuleEngineException;
&nbsp;import org.thingsboard.server.common.msg.queue.ServiceType;
&nbsp;import org.thingsboard.server.dao.tenant.TenantService;
&nbsp;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class AppActor extends ContextAwareActor {
&nbsp;
&nbsp;    private final TenantService tenantService;
&nbsp;    private final Set&lt;TenantId&gt; deletedTenants;
&nbsp;    private volatile boolean ruleChainsInitialized;
&nbsp;
&nbsp;    private AppActor(ActorSystemContext systemContext) {
<b class="nc">&nbsp;        super(systemContext);</b>
<b class="nc">&nbsp;        this.tenantService = systemContext.getTenantService();</b>
<b class="nc">&nbsp;        this.deletedTenants = new HashSet&lt;&gt;();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbActorCtx ctx) throws TbActorException {
<b class="nc">&nbsp;        super.init(ctx);</b>
<b class="nc">&nbsp;        if (systemContext.getServiceInfoProvider().isService(ServiceType.TB_CORE)) {</b>
<b class="nc">&nbsp;            systemContext.schedulePeriodicMsgWithDelay(ctx, SessionTimeoutCheckMsg.instance(),</b>
<b class="nc">&nbsp;                    systemContext.getSessionReportTimeout(), systemContext.getSessionReportTimeout());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected boolean doProcess(TbActorMsg msg) {
<b class="nc">&nbsp;        if (!ruleChainsInitialized) {</b>
<b class="nc">&nbsp;            if (MsgType.APP_INIT_MSG.equals(msg.getMsgType())) {</b>
<b class="nc">&nbsp;                initTenantActors();</b>
<b class="nc">&nbsp;                ruleChainsInitialized = true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (!msg.getMsgType().isIgnoreOnStart()) {</b>
<b class="nc">&nbsp;                    log.warn(&quot;Attempt to initialize Rule Chains by unexpected message: {}&quot;, msg);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        switch (msg.getMsgType()) {</b>
&nbsp;            case APP_INIT_MSG:
&nbsp;                break;
&nbsp;            case PARTITION_CHANGE_MSG:
&nbsp;            case CF_PARTITIONS_CHANGE_MSG:
&nbsp;            case CF_STATE_PARTITION_RESTORE_MSG:
<b class="nc">&nbsp;                ctx.broadcastToChildren(msg, true);</b>
&nbsp;                break;
&nbsp;            case COMPONENT_LIFE_CYCLE_MSG:
<b class="nc">&nbsp;                onComponentLifecycleMsg((ComponentLifecycleMsg) msg);</b>
&nbsp;                break;
&nbsp;            case CF_ENTITY_ACTION_EVENT_MSG:
<b class="nc">&nbsp;                forwardToTenantActor((TenantAwareMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case QUEUE_TO_RULE_ENGINE_MSG:
<b class="nc">&nbsp;                onQueueToRuleEngineMsg((QueueToRuleEngineMsg) msg);</b>
&nbsp;                break;
&nbsp;            case TRANSPORT_TO_DEVICE_ACTOR_MSG:
<b class="nc">&nbsp;                forwardToTenantActor((TenantAwareMsg) msg, false);</b>
&nbsp;                break;
&nbsp;            case DEVICE_ATTRIBUTES_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_CREDENTIALS_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_NAME_OR_TYPE_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_EDGE_UPDATE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_RPC_REQUEST_TO_DEVICE_ACTOR_MSG:
&nbsp;            case DEVICE_RPC_RESPONSE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case SERVER_RPC_RESPONSE_TO_DEVICE_ACTOR_MSG:
&nbsp;            case REMOVE_RPC_TO_DEVICE_ACTOR_MSG:
<b class="nc">&nbsp;                forwardToTenantActor((TenantAwareMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case SESSION_TIMEOUT_MSG:
<b class="nc">&nbsp;                ctx.broadcastToChildrenByType(msg, EntityType.TENANT);</b>
&nbsp;                break;
&nbsp;            case CF_CACHE_INIT_MSG:
&nbsp;            case CF_STATE_RESTORE_MSG:
&nbsp;                //TODO: use priority from the message body. For example, messages about CF lifecycle are important and Device lifecycle are not.
&nbsp;                //      same for the Linked telemetry.
<b class="nc">&nbsp;                forwardToTenantActor((ToCalculatedFieldSystemMsg) msg, true);</b>
&nbsp;                break;
&nbsp;            case CF_TELEMETRY_MSG:
&nbsp;            case CF_LINKED_TELEMETRY_MSG:
<b class="nc">&nbsp;                forwardToTenantActor((ToCalculatedFieldSystemMsg) msg, false);</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void initTenantActors() {
<b class="nc">&nbsp;        log.info(&quot;Starting main system actor.&quot;);</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (systemContext.isTenantComponentsInitEnabled()) {</b>
<b class="nc">&nbsp;                PageDataIterable&lt;Tenant&gt; tenantIterator = new PageDataIterable&lt;&gt;(tenantService::findTenants, ENTITY_PACK_LIMIT);</b>
<b class="nc">&nbsp;                for (Tenant tenant : tenantIterator) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Creating tenant actor&quot;, tenant.getId());</b>
<b class="nc">&nbsp;                    getOrCreateTenantActor(tenant.getId()).ifPresentOrElse(tenantActor -&gt; {</b>
<b class="nc">&nbsp;                        log.debug(&quot;[{}] Tenant actor created.&quot;, tenant.getId());</b>
&nbsp;                    }, () -&gt; {
<b class="nc">&nbsp;                        log.debug(&quot;[{}] Skipped actor creation&quot;, tenant.getId());</b>
&nbsp;                    });
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            log.info(&quot;Main system actor started.&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;Unknown failure&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onQueueToRuleEngineMsg(QueueToRuleEngineMsg msg) {
<b class="nc">&nbsp;        if (TenantId.SYS_TENANT_ID.equals(msg.getTenantId())) {</b>
<b class="nc">&nbsp;            msg.getMsg().getCallback().onFailure(new RuleEngineException(&quot;Message has system tenant id!&quot;));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            getOrCreateTenantActor(msg.getTenantId()).ifPresentOrElse(actor -&gt; {</b>
<b class="nc">&nbsp;                actor.tell(msg);</b>
<b class="nc">&nbsp;            }, () -&gt; msg.getMsg().getCallback().onSuccess());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onComponentLifecycleMsg(ComponentLifecycleMsg msg) {
<b class="nc">&nbsp;        TbActorRef target = null;</b>
<b class="nc">&nbsp;        if (TenantId.SYS_TENANT_ID.equals(msg.getTenantId())) {</b>
<b class="nc">&nbsp;            if (systemContext.isTenantComponentsInitEnabled()) {</b>
<b class="nc">&nbsp;                if (msg.getEntityId() instanceof TenantProfileId tenantProfileId) {</b>
<b class="nc">&nbsp;                    tenantService.findTenantIdsByTenantProfileId(tenantProfileId).forEach(tenantId -&gt; {</b>
<b class="nc">&nbsp;                        getOrCreateTenantActor(tenantId).ifPresentOrElse(tenantActor -&gt; {</b>
<b class="nc">&nbsp;                            log.debug(&quot;[{}] Sending component lifecycle msg for tenant.&quot;, tenantId);</b>
<b class="nc">&nbsp;                            tenantActor.tellWithHighPriority(msg);</b>
&nbsp;                        }, () -&gt; {
<b class="nc">&nbsp;                            log.debug(&quot;Ignoring component lifecycle msg for tenant {} because it is not managed by this service&quot;, tenantId);</b>
&nbsp;                        });
&nbsp;                    });
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (!msg.getEntityId().getEntityType().isOneOf(EntityType.TENANT_PROFILE, EntityType.TB_RESOURCE, EntityType.USER)) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Message has system tenant id: {}&quot;, msg);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (EntityType.TENANT.equals(msg.getEntityId().getEntityType())) {</b>
<b class="nc">&nbsp;                TenantId tenantId = TenantId.fromUUID(msg.getEntityId().getId());</b>
<b class="nc">&nbsp;                if (msg.getEvent() == ComponentLifecycleEvent.DELETED) {</b>
<b class="nc">&nbsp;                    log.info(&quot;[{}] Handling tenant deleted notification: {}&quot;, msg.getTenantId(), msg);</b>
<b class="nc">&nbsp;                    deletedTenants.add(tenantId);</b>
<b class="nc">&nbsp;                    ctx.stop(new TbEntityActorId(tenantId));</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            target = getOrCreateTenantActor(msg.getTenantId()).orElseGet(() -&gt; {</b>
<b class="nc">&nbsp;                log.debug(&quot;Ignoring component lifecycle msg for tenant {} because it is not managed by this service&quot;, msg.getTenantId());</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            });
&nbsp;        }
<b class="nc">&nbsp;        if (target != null) {</b>
<b class="nc">&nbsp;            target.tellWithHighPriority(msg);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.debug(&quot;[{}] Invalid component lifecycle msg: {}&quot;, msg.getTenantId(), msg);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void forwardToTenantActor(TenantAwareMsg msg, boolean priority) {
<b class="nc">&nbsp;        getOrCreateTenantActor(msg.getTenantId()).ifPresentOrElse(tenantActor -&gt; {</b>
<b class="nc">&nbsp;            if (priority) {</b>
<b class="nc">&nbsp;                tenantActor.tellWithHighPriority(msg);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                tenantActor.tell(msg);</b>
&nbsp;            }
&nbsp;        }, () -&gt; {
<b class="nc">&nbsp;            msg.getCallback().onSuccess();</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private Optional&lt;TbActorRef&gt; getOrCreateTenantActor(TenantId tenantId) {
<b class="nc">&nbsp;        if (deletedTenants.contains(tenantId)) {</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
<b class="nc">&nbsp;        return Optional.ofNullable(ctx.getOrCreateChildActor(new TbEntityActorId(tenantId),</b>
<b class="nc">&nbsp;                () -&gt; DefaultActorService.TENANT_DISPATCHER_NAME,</b>
<b class="nc">&nbsp;                () -&gt; new TenantActor.ActorCreator(systemContext, tenantId),</b>
<b class="nc">&nbsp;                () -&gt; true));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProcessFailureStrategy onProcessFailure(TbActorMsg msg, Throwable t) {
<b class="nc">&nbsp;        log.error(&quot;Failed to process msg: {}&quot;, msg, t);</b>
<b class="nc">&nbsp;        return doProcessFailure(t);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static class ActorCreator extends ContextBasedCreator {
&nbsp;
&nbsp;        public ActorCreator(ActorSystemContext context) {
<b class="nc">&nbsp;            super(context);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbActorId createActorId() {
<b class="nc">&nbsp;            return new TbEntityActorId(TenantId.SYS_TENANT_ID);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbActor createActor() {
<b class="nc">&nbsp;            return new AppActor(context);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

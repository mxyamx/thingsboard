<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PduService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.transport.snmp.service</a>
</div>

<h1>Coverage Summary for Class: PduService (org.thingsboard.server.transport.snmp.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PduService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/64)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PduService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.transport.snmp.service;
&nbsp;
&nbsp;import com.google.common.collect.Lists;
&nbsp;import com.google.gson.JsonObject;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.snmp4j.PDU;
&nbsp;import org.snmp4j.ScopedPDU;
&nbsp;import org.snmp4j.smi.Integer32;
&nbsp;import org.snmp4j.smi.Null;
&nbsp;import org.snmp4j.smi.OID;
&nbsp;import org.snmp4j.smi.OctetString;
&nbsp;import org.snmp4j.smi.Variable;
&nbsp;import org.snmp4j.smi.VariableBinding;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.device.data.SnmpDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.kv.DataType;
&nbsp;import org.thingsboard.server.common.data.transport.snmp.SnmpMapping;
&nbsp;import org.thingsboard.server.common.data.transport.snmp.SnmpMethod;
&nbsp;import org.thingsboard.server.common.data.transport.snmp.SnmpProtocolVersion;
&nbsp;import org.thingsboard.server.common.data.transport.snmp.config.SnmpCommunicationConfig;
&nbsp;import org.thingsboard.server.common.data.util.TypeCastUtil;
&nbsp;import org.thingsboard.server.queue.util.TbSnmpTransportComponent;
&nbsp;import org.thingsboard.server.transport.snmp.session.DeviceSessionContext;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@TbSnmpTransportComponent
&nbsp;@Service
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class PduService {
&nbsp;
&nbsp;    @Value(&quot;${transport.snmp.max_request_oids:100}&quot;)
&nbsp;    private int maxRequestOids;
&nbsp;
&nbsp;    @Value(&quot;${transport.snmp.response.ignore_type_cast_errors:false}&quot;)
&nbsp;    private boolean ignoreTypeCastErrors;
&nbsp;
&nbsp;    public List&lt;PDU&gt; createPdus(DeviceSessionContext sessionContext, SnmpCommunicationConfig communicationConfig, Map&lt;String, String&gt; values) {
<b class="nc">&nbsp;        List&lt;PDU&gt; pdus = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;SnmpMapping&gt; allMappings = communicationConfig.getAllMappings();</b>
&nbsp;
<b class="nc">&nbsp;        for (List&lt;SnmpMapping&gt; mappings : Lists.partition(allMappings, maxRequestOids)) {</b>
<b class="nc">&nbsp;            PDU pdu = setUpPdu(sessionContext);</b>
<b class="nc">&nbsp;            pdu.setType(communicationConfig.getMethod().getCode());</b>
<b class="nc">&nbsp;            pdu.addAll(mappings.stream()</b>
<b class="nc">&nbsp;                    .filter(mapping -&gt; values.isEmpty() || values.containsKey(mapping.getKey()))</b>
<b class="nc">&nbsp;                    .map(mapping -&gt; Optional.ofNullable(values.get(mapping.getKey()))</b>
<b class="nc">&nbsp;                            .map(value -&gt; {</b>
<b class="nc">&nbsp;                                Variable variable = toSnmpVariable(value, mapping.getDataType());</b>
<b class="nc">&nbsp;                                return new VariableBinding(new OID(mapping.getOid()), variable);</b>
&nbsp;                            })
<b class="nc">&nbsp;                            .orElseGet(() -&gt; new VariableBinding(new OID(mapping.getOid()))))</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList()));</b>
<b class="nc">&nbsp;            if (pdu.size() &gt; 0) {</b>
<b class="nc">&nbsp;                pdus.add(pdu);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return pdus;</b>
&nbsp;    }
&nbsp;
&nbsp;    public PDU createSingleVariablePdu(DeviceSessionContext sessionContext, SnmpMethod snmpMethod, String oid, String value, DataType dataType) {
<b class="nc">&nbsp;        PDU pdu = setUpPdu(sessionContext);</b>
<b class="nc">&nbsp;        pdu.setType(snmpMethod.getCode());</b>
&nbsp;
<b class="nc">&nbsp;        Variable variable = value == null ? Null.instance : toSnmpVariable(value, dataType);</b>
<b class="nc">&nbsp;        pdu.add(new VariableBinding(new OID(oid), variable));</b>
&nbsp;
<b class="nc">&nbsp;        return pdu;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Variable toSnmpVariable(String value, DataType dataType) {
<b class="nc">&nbsp;        dataType = dataType == null ? DataType.STRING : dataType;</b>
&nbsp;        Variable variable;
<b class="nc">&nbsp;        switch (dataType) {</b>
&nbsp;            case LONG:
&nbsp;                try {
<b class="nc">&nbsp;                    variable = new Integer32(Integer.parseInt(value));</b>
&nbsp;                    break;
&nbsp;                } catch (NumberFormatException ignored) {
&nbsp;                }
&nbsp;            case DOUBLE:
&nbsp;            case BOOLEAN:
&nbsp;            case STRING:
&nbsp;            case JSON:
&nbsp;            default:
<b class="nc">&nbsp;                variable = new OctetString(value);</b>
&nbsp;        }
<b class="nc">&nbsp;        return variable;</b>
&nbsp;    }
&nbsp;
&nbsp;    private PDU setUpPdu(DeviceSessionContext sessionContext) {
&nbsp;        PDU pdu;
<b class="nc">&nbsp;        SnmpDeviceTransportConfiguration deviceTransportConfiguration = sessionContext.getDeviceTransportConfiguration();</b>
<b class="nc">&nbsp;        SnmpProtocolVersion snmpVersion = deviceTransportConfiguration.getProtocolVersion();</b>
<b class="nc">&nbsp;        switch (snmpVersion) {</b>
&nbsp;            case V1:
&nbsp;            case V2C:
<b class="nc">&nbsp;                pdu = new PDU();</b>
&nbsp;                break;
&nbsp;            case V3:
<b class="nc">&nbsp;                ScopedPDU scopedPdu = new ScopedPDU();</b>
<b class="nc">&nbsp;                scopedPdu.setContextName(new OctetString(deviceTransportConfiguration.getContextName()));</b>
<b class="nc">&nbsp;                scopedPdu.setContextEngineID(new OctetString(deviceTransportConfiguration.getEngineId()));</b>
<b class="nc">&nbsp;                pdu = scopedPdu;</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                throw new UnsupportedOperationException(&quot;SNMP version &quot; + snmpVersion + &quot; is not supported&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return pdu;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public JsonObject processPdus(List&lt;PDU&gt; pdus, List&lt;SnmpMapping&gt; responseMappings) {
<b class="nc">&nbsp;        Map&lt;OID, String&gt; values = processPdus(pdus);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;OID, SnmpMapping&gt; mappings = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        if (responseMappings != null) {</b>
<b class="nc">&nbsp;            for (SnmpMapping mapping : responseMappings) {</b>
<b class="nc">&nbsp;                OID oid = new OID(mapping.getOid());</b>
<b class="nc">&nbsp;                mappings.put(oid, mapping);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        JsonObject data = new JsonObject();</b>
<b class="nc">&nbsp;        values.forEach((oid, value) -&gt; {</b>
<b class="nc">&nbsp;            log.trace(&quot;Processing variable binding: {} - {}&quot;, oid, value);</b>
&nbsp;
<b class="nc">&nbsp;            SnmpMapping mapping = mappings.get(oid);</b>
<b class="nc">&nbsp;            if (mapping == null) {</b>
<b class="nc">&nbsp;                log.debug(&quot;No SNMP mapping for oid {}&quot;, oid);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            processValue(mapping.getKey(), mapping.getDataType(), value, data);</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        return data;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;OID, String&gt; processPdus(List&lt;PDU&gt; pdus) {
<b class="nc">&nbsp;        return pdus.stream()</b>
<b class="nc">&nbsp;                .flatMap(pdu -&gt; pdu.getVariableBindings().stream())</b>
<b class="nc">&nbsp;                .filter(Objects::nonNull)</b>
<b class="nc">&nbsp;                .filter(variableBinding -&gt; !(variableBinding.getVariable() instanceof Null))</b>
<b class="nc">&nbsp;                .collect(Collectors.toMap(VariableBinding::getOid, VariableBinding::toValueString));</b>
&nbsp;    }
&nbsp;
&nbsp;    public void processValue(String key, DataType dataType, String value, JsonObject result) {
&nbsp;        try {
<b class="nc">&nbsp;            switch (dataType) {</b>
&nbsp;                case STRING:
&nbsp;                case JSON:
<b class="nc">&nbsp;                    result.addProperty(key, value);</b>
&nbsp;                    break;
&nbsp;                case LONG:
&nbsp;                case DOUBLE:
<b class="nc">&nbsp;                    result.addProperty(key, TypeCastUtil.castToNumber(value).getValue());</b>
&nbsp;                    break;
&nbsp;                case BOOLEAN:
<b class="nc">&nbsp;                    if (StringUtils.equalsAnyIgnoreCase(value, &quot;true&quot;, &quot;false&quot;)) {</b>
<b class="nc">&nbsp;                        result.addProperty(key, Boolean.parseBoolean(value));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        throw new IllegalArgumentException(&quot;Can&#39;t parse &#39;&quot; + value + &quot;&#39; as boolean&quot;);</b>
&nbsp;                    }
&nbsp;                    break;
&nbsp;            }
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            if (ignoreTypeCastErrors) {</b>
<b class="nc">&nbsp;                log.debug(&quot;Ignoring value &#39;{}&#39; for key &#39;{}&#39; because of data type mismatch ({} required)&quot;, value, key, dataType);</b>
&nbsp;            } else {
&nbsp;                throw e;
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultGitSyncService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.sync</a>
</div>

<h1>Coverage Summary for Class: DefaultGitSyncService (org.thingsboard.server.service.sync)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultGitSyncService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/56)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.sync;
&nbsp;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.server.common.data.sync.vc.RepositorySettings;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.sync.vc.GitRepository;
&nbsp;import org.thingsboard.server.service.sync.vc.GitRepository.FileType;
&nbsp;import org.thingsboard.server.service.sync.vc.GitRepository.RepoFile;
&nbsp;
&nbsp;import java.net.URI;
&nbsp;import java.nio.file.Path;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ScheduledExecutorService;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;@TbCoreComponent
&nbsp;@Service
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class DefaultGitSyncService implements GitSyncService {</b>
&nbsp;
&nbsp;    @Value(&quot;${vc.git.repositories-folder:${java.io.tmpdir}/repositories}&quot;)
&nbsp;    private String repositoriesFolder;
&nbsp;
<b class="nc">&nbsp;    private final ScheduledExecutorService executor = ThingsBoardExecutors.newSingleThreadScheduledExecutor(&quot;git-sync&quot;);</b>
<b class="nc">&nbsp;    private final Map&lt;String, GitRepository&gt; repositories = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final Map&lt;String, Runnable&gt; updateListeners = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void registerSync(String key, String repoUri, String branch, long fetchFrequencyMs, Runnable onUpdate) {
<b class="nc">&nbsp;        RepositorySettings settings = new RepositorySettings();</b>
<b class="nc">&nbsp;        settings.setRepositoryUri(repoUri);</b>
<b class="nc">&nbsp;        settings.setDefaultBranch(branch);</b>
<b class="nc">&nbsp;        if (onUpdate != null) {</b>
<b class="nc">&nbsp;            updateListeners.put(key, onUpdate);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        executor.execute(() -&gt; {</b>
<b class="nc">&nbsp;            initRepository(key, settings);</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        executor.scheduleWithFixedDelay(() -&gt; {</b>
<b class="nc">&nbsp;            GitRepository repository = repositories.get(key);</b>
<b class="nc">&nbsp;            if (repository == null || !GitRepository.exists(repository.getDirectory())) {</b>
<b class="nc">&nbsp;                initRepository(key, settings);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            try {
<b class="nc">&nbsp;                log.debug(&quot;[{}] Fetching repository&quot;, key);</b>
<b class="nc">&nbsp;                boolean updated = repository.fetch();</b>
<b class="nc">&nbsp;                if (updated) {</b>
<b class="nc">&nbsp;                    onUpdate(key);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.debug(&quot;[{}] No changes in the repository&quot;, key);</b>
&nbsp;                }
&nbsp;            } catch (Throwable e) {
<b class="nc">&nbsp;                log.error(&quot;[{}] Failed to fetch repository&quot;, key, e);</b>
&nbsp;            }
&nbsp;        }, fetchFrequencyMs, fetchFrequencyMs, TimeUnit.MILLISECONDS);
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;RepoFile&gt; listFiles(String key, String path, int depth, FileType type) {
<b class="nc">&nbsp;        GitRepository repository = getRepository(key);</b>
<b class="nc">&nbsp;        return repository.listFilesAtCommit(getBranchRef(repository), path, depth).stream()</b>
<b class="nc">&nbsp;                .filter(file -&gt; type == null || file.type() == type)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public byte[] getFileContent(String key, String path) {
<b class="nc">&nbsp;        GitRepository repository = getRepository(key);</b>
<b class="nc">&nbsp;        return repository.getFileContentAtCommit(path, getBranchRef(repository));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getGithubRawContentUrl(String key, String path) {
<b class="nc">&nbsp;        if (path == null) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        RepositorySettings settings = getRepository(key).getSettings();</b>
<b class="nc">&nbsp;        return StringUtils.removeEnd(settings.getRepositoryUri(), &quot;.git&quot;) + &quot;/blob/&quot; + settings.getDefaultBranch() + &quot;/&quot; + path + &quot;?raw=true&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    private GitRepository getRepository(String key) {
<b class="nc">&nbsp;        GitRepository repository = repositories.get(key);</b>
<b class="nc">&nbsp;        if (repository != null) {</b>
<b class="nc">&nbsp;            if (!GitRepository.exists(repository.getDirectory())) {</b>
&nbsp;                // reinitializing the repository because folder was deleted
<b class="nc">&nbsp;                initRepository(key, repository.getSettings());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        repository = repositories.get(key);</b>
<b class="nc">&nbsp;        if (repository == null) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(key + &quot; repository is not initialized&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return repository;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void initRepository(String key, RepositorySettings settings) {
&nbsp;        try {
<b class="nc">&nbsp;            repositories.remove(key);</b>
<b class="nc">&nbsp;            Path directory = getRepoDirectory(settings);</b>
&nbsp;
<b class="nc">&nbsp;            GitRepository repository = GitRepository.openOrClone(directory, settings, true);</b>
<b class="nc">&nbsp;            repositories.put(key, repository);</b>
<b class="nc">&nbsp;            log.info(&quot;[{}] Initialized repository&quot;, key);</b>
&nbsp;
<b class="nc">&nbsp;            onUpdate(key);</b>
&nbsp;        } catch (Throwable e) {
<b class="nc">&nbsp;            log.error(&quot;[{}] Failed to initialize repository with settings {}&quot;, key, settings, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onUpdate(String key) {
<b class="nc">&nbsp;        Runnable listener = updateListeners.get(key);</b>
<b class="nc">&nbsp;        if (listener != null) {</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Handling repository update&quot;, key);</b>
&nbsp;            try {
<b class="nc">&nbsp;                listener.run();</b>
&nbsp;            } catch (Throwable e) {
<b class="nc">&nbsp;                log.error(&quot;[{}] Failed to handle repository update&quot;, key, e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private Path getRepoDirectory(RepositorySettings settings) {
&nbsp;        // using uri to define folder name in case repo url is changed
<b class="nc">&nbsp;        String name = URI.create(settings.getRepositoryUri()).getPath().replaceAll(&quot;[^a-zA-Z]&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        return Path.of(repositoriesFolder, name);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getBranchRef(GitRepository repository) {
<b class="nc">&nbsp;        return &quot;refs/remotes/origin/&quot; + repository.getSettings().getDefaultBranch();</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    private void preDestroy() {
<b class="nc">&nbsp;        executor.shutdownNow();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

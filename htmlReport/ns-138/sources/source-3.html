<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TenantRepo</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.edqs.repo</a>
</div>

<h1>Coverage Summary for Class: TenantRepo (org.thingsboard.server.edqs.repo)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TenantRepo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/109)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/186)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TenantRepo$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/109)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/187)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.edqs.repo;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.ObjectType;
&nbsp;import org.thingsboard.server.common.data.edqs.AttributeKv;
&nbsp;import org.thingsboard.server.common.data.edqs.DataPoint;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsEvent;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsEventType;
&nbsp;import org.thingsboard.server.common.data.edqs.EdqsObject;
&nbsp;import org.thingsboard.server.common.data.edqs.Entity;
&nbsp;import org.thingsboard.server.common.data.edqs.LatestTsKv;
&nbsp;import org.thingsboard.server.common.data.edqs.fields.EntityFields;
&nbsp;import org.thingsboard.server.common.data.edqs.query.QueryResult;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.permission.QueryContext;
&nbsp;import org.thingsboard.server.common.data.query.EntityCountQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataSortOrder;
&nbsp;import org.thingsboard.server.common.data.query.EntityFilter;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyType;
&nbsp;import org.thingsboard.server.common.data.query.TsValue;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.RelationTypeGroup;
&nbsp;import org.thingsboard.server.common.stats.EdqsStatsService;
&nbsp;import org.thingsboard.server.edqs.data.ApiUsageStateData;
&nbsp;import org.thingsboard.server.edqs.data.AssetData;
&nbsp;import org.thingsboard.server.edqs.data.CustomerData;
&nbsp;import org.thingsboard.server.edqs.data.DeviceData;
&nbsp;import org.thingsboard.server.edqs.data.EntityData;
&nbsp;import org.thingsboard.server.edqs.data.EntityProfileData;
&nbsp;import org.thingsboard.server.edqs.data.GenericData;
&nbsp;import org.thingsboard.server.edqs.data.RelationsRepo;
&nbsp;import org.thingsboard.server.edqs.data.TenantData;
&nbsp;import org.thingsboard.server.edqs.query.EdqsDataQuery;
&nbsp;import org.thingsboard.server.edqs.query.EdqsQuery;
&nbsp;import org.thingsboard.server.edqs.query.SortableEntityData;
&nbsp;import org.thingsboard.server.edqs.query.processor.EntityQueryProcessor;
&nbsp;import org.thingsboard.server.edqs.query.processor.EntityQueryProcessorFactory;
&nbsp;import org.thingsboard.server.edqs.util.RepositoryUtils;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.TreeSet;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.ConcurrentSkipListSet;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.locks.Lock;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.edqs.util.RepositoryUtils.SORT_ASC;
&nbsp;import static org.thingsboard.server.edqs.util.RepositoryUtils.SORT_DESC;
&nbsp;import static org.thingsboard.server.edqs.util.RepositoryUtils.resolveEntityType;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class TenantRepo {
&nbsp;
<b class="nc">&nbsp;    public static final Comparator&lt;EntityData&lt;?&gt;&gt; CREATED_TIME_COMPARATOR = Comparator.comparingLong(ed -&gt; ed.getFields().getCreatedTime());</b>
<b class="nc">&nbsp;    public static final Comparator&lt;EntityData&lt;?&gt;&gt; CREATED_TIME_AND_ID_COMPARATOR = CREATED_TIME_COMPARATOR</b>
<b class="nc">&nbsp;            .thenComparing(EntityData::getId);</b>
<b class="nc">&nbsp;    public static final Comparator&lt;EntityData&lt;?&gt;&gt; CREATED_TIME_AND_ID_DESC_COMPARATOR = CREATED_TIME_AND_ID_COMPARATOR.reversed();</b>
&nbsp;
<b class="nc">&nbsp;    private final ConcurrentMap&lt;EntityType, Set&lt;EntityData&lt;?&gt;&gt;&gt; entitySetByType = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ConcurrentMap&lt;EntityType, ConcurrentMap&lt;UUID, EntityData&lt;?&gt;&gt;&gt; entityMapByType = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private final ConcurrentMap&lt;RelationTypeGroup, RelationsRepo&gt; relations = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    private final Lock entityUpdateLock = new ReentrantLock();</b>
&nbsp;
&nbsp;    private final TenantId tenantId;
&nbsp;    private final EdqsStatsService edqsStatsService;
&nbsp;
<b class="nc">&nbsp;    public TenantRepo(TenantId tenantId, EdqsStatsService edqsStatsService) {</b>
<b class="nc">&nbsp;        this.tenantId = tenantId;</b>
<b class="nc">&nbsp;        this.edqsStatsService = edqsStatsService;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void processEvent(EdqsEvent event) {
<b class="nc">&nbsp;        EdqsObject edqsObject = event.getObject();</b>
<b class="nc">&nbsp;        log.trace(&quot;[{}] Processing event: {}&quot;, tenantId, event);</b>
<b class="nc">&nbsp;        if (event.getEventType() == EdqsEventType.UPDATED) {</b>
<b class="nc">&nbsp;            addOrUpdate(edqsObject);</b>
<b class="nc">&nbsp;        } else if (event.getEventType() == EdqsEventType.DELETED) {</b>
<b class="nc">&nbsp;            remove(edqsObject);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void addOrUpdate(EdqsObject object) {
<b class="nc">&nbsp;        if (object instanceof EntityRelation relation) {</b>
<b class="nc">&nbsp;            addOrUpdateRelation(relation);</b>
<b class="nc">&nbsp;        } else if (object instanceof AttributeKv attributeKv) {</b>
<b class="nc">&nbsp;            addOrUpdateAttribute(attributeKv);</b>
<b class="nc">&nbsp;        } else if (object instanceof LatestTsKv latestTsKv) {</b>
<b class="nc">&nbsp;            addOrUpdateLatestKv(latestTsKv);</b>
<b class="nc">&nbsp;        } else if (object instanceof Entity entity) {</b>
<b class="nc">&nbsp;            addOrUpdateEntity(entity);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void remove(EdqsObject object) {
<b class="nc">&nbsp;        if (object instanceof EntityRelation relation) {</b>
<b class="nc">&nbsp;            removeRelation(relation);</b>
<b class="nc">&nbsp;        } else if (object instanceof AttributeKv attributeKv) {</b>
<b class="nc">&nbsp;            removeAttribute(attributeKv);</b>
<b class="nc">&nbsp;        } else if (object instanceof LatestTsKv latestTsKv) {</b>
<b class="nc">&nbsp;            removeLatestKv(latestTsKv);</b>
<b class="nc">&nbsp;        } else if (object instanceof Entity entity) {</b>
<b class="nc">&nbsp;            removeEntity(entity);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void addOrUpdateRelation(EntityRelation entity) {
<b class="nc">&nbsp;        entityUpdateLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (RelationTypeGroup.COMMON.equals(entity.getTypeGroup())) {</b>
<b class="nc">&nbsp;                RelationsRepo repo = relations.computeIfAbsent(entity.getTypeGroup(), tg -&gt; new RelationsRepo());</b>
<b class="nc">&nbsp;                EntityData&lt;?&gt; from = getOrCreate(entity.getFrom());</b>
<b class="nc">&nbsp;                EntityData&lt;?&gt; to = getOrCreate(entity.getTo());</b>
<b class="nc">&nbsp;                boolean added = repo.add(from, to, entity.getType());</b>
<b class="nc">&nbsp;                if (added) {</b>
<b class="nc">&nbsp;                    edqsStatsService.reportAdded(ObjectType.RELATION);</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (RelationTypeGroup.DASHBOARD.equals(entity.getTypeGroup())) {</b>
<b class="nc">&nbsp;                if (EntityRelation.CONTAINS_TYPE.equals(entity.getType()) &amp;&amp; entity.getFrom().getEntityType() == EntityType.CUSTOMER) {</b>
<b class="nc">&nbsp;                    CustomerData customerData = (CustomerData) getOrCreate(entity.getFrom());</b>
<b class="nc">&nbsp;                    EntityData&lt;?&gt; dashboardData = getOrCreate(entity.getTo());</b>
<b class="nc">&nbsp;                    customerData.addOrUpdate(dashboardData);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } finally {
<b class="nc">&nbsp;            entityUpdateLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void removeRelation(EntityRelation entityRelation) {
<b class="nc">&nbsp;        if (RelationTypeGroup.COMMON.equals(entityRelation.getTypeGroup())) {</b>
<b class="nc">&nbsp;            RelationsRepo relationsRepo = relations.get(entityRelation.getTypeGroup());</b>
<b class="nc">&nbsp;            if (relationsRepo != null) {</b>
<b class="nc">&nbsp;                boolean removed = relationsRepo.remove(entityRelation.getFrom().getId(), entityRelation.getTo().getId(), entityRelation.getType());</b>
<b class="nc">&nbsp;                if (removed) {</b>
<b class="nc">&nbsp;                    edqsStatsService.reportRemoved(ObjectType.RELATION);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (RelationTypeGroup.DASHBOARD.equals(entityRelation.getTypeGroup())) {</b>
<b class="nc">&nbsp;            if (EntityRelation.CONTAINS_TYPE.equals(entityRelation.getType()) &amp;&amp; entityRelation.getFrom().getEntityType() == EntityType.CUSTOMER) {</b>
<b class="nc">&nbsp;                CustomerData customerData = (CustomerData) get(entityRelation.getFrom());</b>
<b class="nc">&nbsp;                if (customerData != null) {</b>
<b class="nc">&nbsp;                    customerData.remove(EntityType.DASHBOARD, entityRelation.getTo().getId());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void addOrUpdateEntity(Entity entity) {
<b class="nc">&nbsp;        entityUpdateLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            log.trace(&quot;[{}] addOrUpdateEntity: {}&quot;, tenantId, entity);</b>
<b class="nc">&nbsp;            EntityFields fields = entity.getFields();</b>
<b class="nc">&nbsp;            UUID entityId = fields.getId();</b>
<b class="nc">&nbsp;            EntityType entityType = entity.getType();</b>
&nbsp;
<b class="nc">&nbsp;            EntityData entityData = getOrCreate(entityType, entityId);</b>
<b class="nc">&nbsp;            EntityFields oldFields = entityData.getFields();</b>
<b class="nc">&nbsp;            entityData.setFields(fields);</b>
<b class="nc">&nbsp;            if (oldFields == null) {</b>
<b class="nc">&nbsp;                getEntitySet(entityType).add(entityData);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            UUID newCustomerId = fields.getCustomerId();</b>
<b class="nc">&nbsp;            UUID oldCustomerId = entityData.getCustomerId();</b>
<b class="nc">&nbsp;            entityData.setCustomerId(newCustomerId);</b>
<b class="nc">&nbsp;            if (entityIdMismatch(oldCustomerId, newCustomerId)) {</b>
<b class="nc">&nbsp;                if (oldCustomerId != null) {</b>
<b class="nc">&nbsp;                    CustomerData old = (CustomerData) get(EntityType.CUSTOMER, oldCustomerId);</b>
<b class="nc">&nbsp;                    if (old != null) {</b>
<b class="nc">&nbsp;                        old.remove(entityType, entityId);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (newCustomerId != null) {</b>
<b class="nc">&nbsp;                    CustomerData newData = (CustomerData) getOrCreate(EntityType.CUSTOMER, newCustomerId);</b>
<b class="nc">&nbsp;                    newData.addOrUpdate(entityData);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } finally {
<b class="nc">&nbsp;            entityUpdateLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void removeEntity(Entity entity) {
<b class="nc">&nbsp;        entityUpdateLock.lock();</b>
&nbsp;        try {
<b class="nc">&nbsp;            UUID entityId = entity.getFields().getId();</b>
<b class="nc">&nbsp;            EntityType entityType = entity.getType();</b>
<b class="nc">&nbsp;            EntityData&lt;?&gt; removed = getEntityMap(entityType).remove(entityId);</b>
<b class="nc">&nbsp;            if (removed != null) {</b>
<b class="nc">&nbsp;                if (removed.getFields() != null) {</b>
<b class="nc">&nbsp;                    getEntitySet(entityType).remove(removed);</b>
&nbsp;                }
<b class="nc">&nbsp;                edqsStatsService.reportRemoved(entity.type());</b>
&nbsp;
<b class="nc">&nbsp;                UUID customerId = removed.getCustomerId();</b>
<b class="nc">&nbsp;                if (customerId != null) {</b>
<b class="nc">&nbsp;                    CustomerData customerData = (CustomerData) get(EntityType.CUSTOMER, customerId);</b>
<b class="nc">&nbsp;                    if (customerData != null) {</b>
<b class="nc">&nbsp;                        customerData.remove(entityType, entityId);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        } finally {
<b class="nc">&nbsp;            entityUpdateLock.unlock();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void addOrUpdateAttribute(AttributeKv attributeKv) {
<b class="nc">&nbsp;        var entityData = getOrCreate(attributeKv.getEntityId());</b>
<b class="nc">&nbsp;        if (entityData != null) {</b>
<b class="nc">&nbsp;            Integer keyId = KeyDictionary.get(attributeKv.getKey());</b>
<b class="nc">&nbsp;            boolean added = entityData.putAttr(keyId, attributeKv.getScope(), attributeKv.getDataPoint());</b>
<b class="nc">&nbsp;            if (added) {</b>
<b class="nc">&nbsp;                edqsStatsService.reportAdded(ObjectType.ATTRIBUTE_KV);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void removeAttribute(AttributeKv attributeKv) {
<b class="nc">&nbsp;        var entityData = get(attributeKv.getEntityId());</b>
<b class="nc">&nbsp;        if (entityData != null) {</b>
<b class="nc">&nbsp;            boolean removed = entityData.removeAttr(KeyDictionary.get(attributeKv.getKey()), attributeKv.getScope());</b>
<b class="nc">&nbsp;            if (removed) {</b>
<b class="nc">&nbsp;                edqsStatsService.reportRemoved(ObjectType.ATTRIBUTE_KV);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void addOrUpdateLatestKv(LatestTsKv latestTsKv) {
<b class="nc">&nbsp;        var entityData = getOrCreate(latestTsKv.getEntityId());</b>
<b class="nc">&nbsp;        if (entityData != null) {</b>
<b class="nc">&nbsp;            Integer keyId = KeyDictionary.get(latestTsKv.getKey());</b>
<b class="nc">&nbsp;            boolean added = entityData.putTs(keyId, latestTsKv.getDataPoint());</b>
<b class="nc">&nbsp;            if (added) {</b>
<b class="nc">&nbsp;                edqsStatsService.reportAdded(ObjectType.LATEST_TS_KV);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void removeLatestKv(LatestTsKv latestTsKv) {
<b class="nc">&nbsp;        var entityData = get(latestTsKv.getEntityId());</b>
<b class="nc">&nbsp;        if (entityData != null) {</b>
<b class="nc">&nbsp;            boolean removed = entityData.removeTs(KeyDictionary.get(latestTsKv.getKey()));</b>
<b class="nc">&nbsp;            if (removed) {</b>
<b class="nc">&nbsp;                edqsStatsService.reportRemoved(ObjectType.LATEST_TS_KV);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ConcurrentMap&lt;UUID, EntityData&lt;?&gt;&gt; getEntityMap(EntityType entityType) {
<b class="nc">&nbsp;        return entityMapByType.computeIfAbsent(entityType, et -&gt; new ConcurrentHashMap&lt;&gt;());</b>
&nbsp;    }
&nbsp;
&nbsp;    //TODO: automatically remove entities that has nothing except the ID.
&nbsp;    private EntityData&lt;?&gt; getOrCreate(EntityId entityId) {
<b class="nc">&nbsp;        return getOrCreate(entityId.getEntityType(), entityId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityData&lt;?&gt; getOrCreate(EntityType entityType, UUID entityId) {
<b class="nc">&nbsp;        return getEntityMap(entityType).computeIfAbsent(entityId, id -&gt; {</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Adding {} {}&quot;, tenantId, entityType, id);</b>
<b class="nc">&nbsp;            EntityData&lt;?&gt; entityData = constructEntityData(entityType, entityId);</b>
<b class="nc">&nbsp;            edqsStatsService.reportAdded(ObjectType.fromEntityType(entityType));</b>
<b class="nc">&nbsp;            return entityData;</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private EntityData&lt;?&gt; get(EntityId entityId) {
<b class="nc">&nbsp;        return get(entityId.getEntityType(), entityId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityData&lt;?&gt; get(EntityType entityType, UUID entityId) {
<b class="nc">&nbsp;        return getEntityMap(entityType).get(entityId);</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityData&lt;?&gt; constructEntityData(EntityType entityType, UUID id) {
<b class="nc">&nbsp;        EntityData&lt;?&gt; entityData = switch (entityType) {</b>
<b class="nc">&nbsp;            case DEVICE -&gt; new DeviceData(id);</b>
<b class="nc">&nbsp;            case ASSET -&gt; new AssetData(id);</b>
<b class="nc">&nbsp;            case DEVICE_PROFILE, ASSET_PROFILE -&gt; new EntityProfileData(id, entityType);</b>
<b class="nc">&nbsp;            case CUSTOMER -&gt; new CustomerData(id);</b>
<b class="nc">&nbsp;            case TENANT -&gt; new TenantData(id);</b>
<b class="nc">&nbsp;            case API_USAGE_STATE -&gt; new ApiUsageStateData(id);</b>
<b class="nc">&nbsp;            default -&gt; new GenericData(entityType, id);</b>
&nbsp;        };
<b class="nc">&nbsp;        entityData.setRepo(this);</b>
<b class="nc">&nbsp;        return entityData;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean entityIdMismatch(UUID oldOrNull, UUID newOrNull) {
<b class="nc">&nbsp;        if (oldOrNull == null) {</b>
<b class="nc">&nbsp;            return newOrNull != null;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return !oldOrNull.equals(newOrNull);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;EntityData&lt;?&gt;&gt; getEntitySet(EntityType entityType) {
<b class="nc">&nbsp;        return entitySetByType.computeIfAbsent(entityType, et -&gt; new ConcurrentSkipListSet&lt;&gt;(CREATED_TIME_AND_ID_DESC_COMPARATOR));</b>
&nbsp;    }
&nbsp;
&nbsp;    public PageData&lt;QueryResult&gt; findEntityDataByQuery(CustomerId customerId, EntityDataQuery oldQuery, boolean ignorePermissionCheck) {
<b class="nc">&nbsp;        EdqsDataQuery query = RepositoryUtils.toNewQuery(oldQuery);</b>
<b class="nc">&nbsp;        QueryContext ctx = buildContext(customerId, query.getEntityFilter(), ignorePermissionCheck);</b>
<b class="nc">&nbsp;        EntityQueryProcessor queryProcessor = EntityQueryProcessorFactory.create(this, ctx, query);</b>
<b class="nc">&nbsp;        return sortAndConvert(query, queryProcessor.processQuery(), ctx);</b>
&nbsp;    }
&nbsp;
&nbsp;    public long countEntitiesByQuery(CustomerId customerId, EntityCountQuery oldQuery, boolean ignorePermissionCheck) {
<b class="nc">&nbsp;        EdqsQuery query = RepositoryUtils.toNewQuery(oldQuery);</b>
<b class="nc">&nbsp;        QueryContext ctx = buildContext(customerId, query.getEntityFilter(), ignorePermissionCheck);</b>
<b class="nc">&nbsp;        EntityQueryProcessor queryProcessor = EntityQueryProcessorFactory.create(this, ctx, query);</b>
<b class="nc">&nbsp;        return queryProcessor.count();</b>
&nbsp;    }
&nbsp;
&nbsp;    private PageData&lt;QueryResult&gt; sortAndConvert(EdqsDataQuery query, List&lt;SortableEntityData&gt; data, QueryContext ctx) {
<b class="nc">&nbsp;        int totalSize = data.size();</b>
<b class="nc">&nbsp;        int totalPages = (int) Math.ceil((float) totalSize / query.getPageSize());</b>
<b class="nc">&nbsp;        int offset = query.getPage() * query.getPageSize();</b>
<b class="nc">&nbsp;        if (offset &gt; totalSize) {</b>
<b class="nc">&nbsp;            return new PageData&lt;&gt;(Collections.emptyList(), totalPages, totalSize, false);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Comparator&lt;SortableEntityData&gt; comparator = EntityDataSortOrder.Direction.ASC.equals(query.getSortDirection()) ? SORT_ASC : SORT_DESC;</b>
<b class="nc">&nbsp;            long startTs = System.nanoTime();</b>
&nbsp;//          IMPLEMENTATION THAT IS BASED ON PRIORITY_QUEUE
&nbsp;//            var requiredSize = Math.min(offset + query.getPageSize(), totalSize);
&nbsp;//            PriorityQueue&lt;SortableEntityData&gt; topN = new PriorityQueue&lt;&gt;(requiredSize, comparator.reversed());
&nbsp;//            for (SortableEntityData item : data) {
&nbsp;//                topN.add(item);
&nbsp;//                if (topN.size() &gt; requiredSize) {
&nbsp;//                    topN.poll();
&nbsp;//                }
&nbsp;//            }
&nbsp;//            List&lt;SortableEntityData&gt; result = new ArrayList&lt;&gt;(topN);
&nbsp;//            Collections.reverse(result);
&nbsp;//            result = result.subList(offset, requiredSize);
&nbsp;//          IMPLEMENTATION THAT IS BASED ON TREE SET  (For offset + query.getPageSize() &lt;&lt; totalSize)
<b class="nc">&nbsp;            var requiredSize = Math.min(offset + query.getPageSize(), totalSize);</b>
<b class="nc">&nbsp;            TreeSet&lt;SortableEntityData&gt; topNSet = new TreeSet&lt;&gt;(comparator);</b>
<b class="nc">&nbsp;            for (SortableEntityData sp : data) {</b>
<b class="nc">&nbsp;                topNSet.add(sp);</b>
<b class="nc">&nbsp;                if (topNSet.size() &gt; requiredSize) {</b>
<b class="nc">&nbsp;                    topNSet.pollLast();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            var result = topNSet.stream().skip(offset).limit(query.getPageSize()).collect(Collectors.toList());</b>
&nbsp;//          IMPLEMENTATION THAT IS BASED ON TIM SORT (For offset + query.getPageSize() &gt; totalSize / 2)
&nbsp;//            data.sort(comparator);
&nbsp;//            var result = data.subList(offset, endIndex);
<b class="nc">&nbsp;            log.trace(&quot;EDQ Sorted in {}&quot;, TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTs));</b>
<b class="nc">&nbsp;            return new PageData&lt;&gt;(toQueryResult(result, query, ctx), totalPages, totalSize, totalSize &gt; requiredSize);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;QueryResult&gt; toQueryResult(List&lt;SortableEntityData&gt; data, EdqsDataQuery query, QueryContext ctx) {
<b class="nc">&nbsp;        long ts = System.currentTimeMillis();</b>
<b class="nc">&nbsp;        List&lt;QueryResult&gt; results = new ArrayList&lt;&gt;(data.size());</b>
<b class="nc">&nbsp;        for (SortableEntityData entityData : data) {</b>
<b class="nc">&nbsp;            Map&lt;EntityKeyType, Map&lt;String, TsValue&gt;&gt; latest = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            for (var key : query.getEntityFields()) {</b>
<b class="nc">&nbsp;                DataPoint dp = entityData.getEntityData().getDataPoint(key, ctx);</b>
<b class="nc">&nbsp;                TsValue v = RepositoryUtils.toTsValue(ts, dp);</b>
<b class="nc">&nbsp;                latest.computeIfAbsent(EntityKeyType.ENTITY_FIELD, t -&gt; new HashMap&lt;&gt;()).put(key.key(), v);</b>
&nbsp;            }
<b class="nc">&nbsp;            for (var key : query.getLatestValues()) {</b>
<b class="nc">&nbsp;                DataPoint dp = entityData.getEntityData().getDataPoint(key, ctx);</b>
<b class="nc">&nbsp;                TsValue v = RepositoryUtils.toTsValue(ts, dp);</b>
<b class="nc">&nbsp;                latest.computeIfAbsent(key.type(), t -&gt; new HashMap&lt;&gt;()).put(KeyDictionary.get(key.keyId()), v);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            results.add(new QueryResult(entityData.getEntityId(), latest));</b>
&nbsp;        }
<b class="nc">&nbsp;        return results;</b>
&nbsp;    }
&nbsp;
&nbsp;    private QueryContext buildContext(CustomerId customerId, EntityFilter filter, boolean ignorePermissionCheck) {
<b class="nc">&nbsp;        return new QueryContext(tenantId, customerId, resolveEntityType(filter), ignorePermissionCheck);</b>
&nbsp;    }
&nbsp;
&nbsp;    public TenantId getTenantId() {
<b class="nc">&nbsp;        return tenantId;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public RelationsRepo getRelations(RelationTypeGroup relationTypeGroup) {
<b class="nc">&nbsp;        return relations.computeIfAbsent(relationTypeGroup, type -&gt; new RelationsRepo());</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getOwnerEntityName(EntityId entityId) {
<b class="nc">&nbsp;        EntityType entityType = entityId.getEntityType();</b>
<b class="nc">&nbsp;        return switch (entityType) {</b>
&nbsp;            case CUSTOMER, TENANT -&gt; {
<b class="nc">&nbsp;                EntityFields fields = get(entityId).getFields();</b>
<b class="nc">&nbsp;                yield fields != null ? fields.getName() : &quot;&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(&quot;Unsupported entity type: &quot; + entityType);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

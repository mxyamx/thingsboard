<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EventInsertRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.sql.event</a>
</div>

<h1>Coverage Summary for Class: EventInsertRepository (org.thingsboard.server.dao.sql.event)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EventInsertRepository</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/37)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EventInsertRepository$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EventInsertRepository$8</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/92)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.sql.event;
&nbsp;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.jdbc.core.BatchPreparedStatementSetter;
&nbsp;import org.springframework.jdbc.core.JdbcTemplate;
&nbsp;import org.springframework.stereotype.Repository;
&nbsp;import org.springframework.transaction.TransactionStatus;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.support.TransactionCallbackWithoutResult;
&nbsp;import org.springframework.transaction.support.TransactionTemplate;
&nbsp;import org.thingsboard.server.common.data.event.CalculatedFieldDebugEvent;
&nbsp;import org.thingsboard.server.common.data.event.ErrorEvent;
&nbsp;import org.thingsboard.server.common.data.event.Event;
&nbsp;import org.thingsboard.server.common.data.event.EventType;
&nbsp;import org.thingsboard.server.common.data.event.LifecycleEvent;
&nbsp;import org.thingsboard.server.common.data.event.RuleChainDebugEvent;
&nbsp;import org.thingsboard.server.common.data.event.RuleNodeDebugEvent;
&nbsp;import org.thingsboard.server.common.data.event.StatisticsEvent;
&nbsp;import org.thingsboard.server.dao.config.DefaultDataSource;
&nbsp;import org.thingsboard.server.dao.util.SqlDao;
&nbsp;
&nbsp;import java.sql.PreparedStatement;
&nbsp;import java.sql.SQLException;
&nbsp;import java.sql.Types;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@DefaultDataSource
&nbsp;@Repository
&nbsp;@Transactional
&nbsp;@SqlDao
&nbsp;@RequiredArgsConstructor
&nbsp;public class EventInsertRepository {
&nbsp;
<b class="nc">&nbsp;    private static final ThreadLocal&lt;Pattern&gt; PATTERN_THREAD_LOCAL = ThreadLocal.withInitial(() -&gt; Pattern.compile(String.valueOf(Character.MIN_VALUE)));</b>
&nbsp;
&nbsp;    private static final String EMPTY_STR = &quot;&quot;;
&nbsp;
&nbsp;    private final Map&lt;EventType, String&gt; insertStmtMap = new ConcurrentHashMap&lt;&gt;();
&nbsp;
&nbsp;    private final JdbcTemplate jdbcTemplate;
&nbsp;    private final TransactionTemplate transactionTemplate;
&nbsp;
&nbsp;    @Value(&quot;${sql.remove_null_chars:true}&quot;)
&nbsp;    private boolean removeNullChars;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void init() {
<b class="nc">&nbsp;        insertStmtMap.put(EventType.ERROR, &quot;INSERT INTO &quot; + EventType.ERROR.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, e_method, e_error) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
<b class="nc">&nbsp;        insertStmtMap.put(EventType.LC_EVENT, &quot;INSERT INTO &quot; + EventType.LC_EVENT.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, e_type, e_success, e_error) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
<b class="nc">&nbsp;        insertStmtMap.put(EventType.STATS, &quot;INSERT INTO &quot; + EventType.STATS.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, e_messages_processed, e_errors_occurred) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
<b class="nc">&nbsp;        insertStmtMap.put(EventType.DEBUG_RULE_NODE, &quot;INSERT INTO &quot; + EventType.DEBUG_RULE_NODE.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, e_type, e_entity_id, e_entity_type, e_msg_id, e_msg_type, e_data_type, e_relation_type, e_data, e_metadata, e_error) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
<b class="nc">&nbsp;        insertStmtMap.put(EventType.DEBUG_RULE_CHAIN, &quot;INSERT INTO &quot; + EventType.DEBUG_RULE_CHAIN.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, e_message, e_error) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
<b class="nc">&nbsp;        insertStmtMap.put(EventType.DEBUG_CALCULATED_FIELD, &quot;INSERT INTO &quot; + EventType.DEBUG_CALCULATED_FIELD.getTable() +</b>
&nbsp;                &quot; (id, tenant_id, ts, entity_id, service_id, cf_id, e_entity_id, e_entity_type, e_msg_id, e_msg_type, e_args, e_result, e_error) &quot; +
&nbsp;                &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;&quot;);
&nbsp;    }
&nbsp;
&nbsp;    public void save(List&lt;Event&gt; entities) {
<b class="nc">&nbsp;        Map&lt;EventType, List&lt;Event&gt;&gt; eventsByType = entities.stream().collect(Collectors.groupingBy(Event::getType, Collectors.toList()));</b>
<b class="nc">&nbsp;        transactionTemplate.execute(new TransactionCallbackWithoutResult() {</b>
&nbsp;            @Override
&nbsp;            protected void doInTransactionWithoutResult(TransactionStatus status) {
<b class="nc">&nbsp;                for (var entry : eventsByType.entrySet()) {</b>
<b class="nc">&nbsp;                    jdbcTemplate.batchUpdate(insertStmtMap.get(entry.getKey()), getStatementSetter(entry.getKey(), entry.getValue()));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getStatementSetter(EventType eventType, List&lt;Event&gt; events) {
<b class="nc">&nbsp;        switch (eventType) {</b>
&nbsp;            case ERROR:
<b class="nc">&nbsp;                return getErrorEventSetter(events);</b>
&nbsp;            case LC_EVENT:
<b class="nc">&nbsp;                return getLcEventSetter(events);</b>
&nbsp;            case STATS:
<b class="nc">&nbsp;                return getStatsEventSetter(events);</b>
&nbsp;            case DEBUG_RULE_NODE:
<b class="nc">&nbsp;                return getRuleNodeEventSetter(events);</b>
&nbsp;            case DEBUG_RULE_CHAIN:
<b class="nc">&nbsp;                return getRuleChainEventSetter(events);</b>
&nbsp;            case DEBUG_CALCULATED_FIELD:
<b class="nc">&nbsp;                return getCalculatedFieldEventSetter(events);</b>
&nbsp;            default:
<b class="nc">&nbsp;                throw new RuntimeException(eventType + &quot; support is not implemented!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getErrorEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                ErrorEvent event = (ErrorEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                safePutString(ps, 6, event.getMethod());</b>
<b class="nc">&nbsp;                safePutString(ps, 7, event.getError());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getLcEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                LifecycleEvent event = (LifecycleEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                safePutString(ps, 6, event.getLcEventType());</b>
<b class="nc">&nbsp;                ps.setBoolean(7, event.isSuccess());</b>
<b class="nc">&nbsp;                safePutString(ps, 8, event.getError());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getStatsEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                StatisticsEvent event = (StatisticsEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                ps.setLong(6, event.getMessagesProcessed());</b>
<b class="nc">&nbsp;                ps.setLong(7, event.getErrorsOccurred());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getRuleNodeEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                RuleNodeDebugEvent event = (RuleNodeDebugEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                safePutString(ps, 6, event.getEventType());</b>
<b class="nc">&nbsp;                safePutUUID(ps, 7, event.getEventEntity() != null ? event.getEventEntity().getId() : null);</b>
<b class="nc">&nbsp;                safePutString(ps, 8, event.getEventEntity() != null ? event.getEventEntity().getEntityType().name() : null);</b>
<b class="nc">&nbsp;                safePutUUID(ps, 9, event.getMsgId());</b>
<b class="nc">&nbsp;                safePutString(ps, 10, event.getMsgType());</b>
<b class="nc">&nbsp;                safePutString(ps, 11, event.getDataType());</b>
<b class="nc">&nbsp;                safePutString(ps, 12, event.getRelationType());</b>
<b class="nc">&nbsp;                safePutString(ps, 13, event.getData());</b>
<b class="nc">&nbsp;                safePutString(ps, 14, event.getMetadata());</b>
<b class="nc">&nbsp;                safePutString(ps, 15, event.getError());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getRuleChainEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                RuleChainDebugEvent event = (RuleChainDebugEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                safePutString(ps, 6, event.getMessage());</b>
<b class="nc">&nbsp;                safePutString(ps, 7, event.getError());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private BatchPreparedStatementSetter getCalculatedFieldEventSetter(List&lt;Event&gt; events) {
<b class="nc">&nbsp;        return new BatchPreparedStatementSetter() {</b>
&nbsp;            @Override
&nbsp;            public void setValues(PreparedStatement ps, int i) throws SQLException {
<b class="nc">&nbsp;                CalculatedFieldDebugEvent event = (CalculatedFieldDebugEvent) events.get(i);</b>
<b class="nc">&nbsp;                setCommonEventFields(ps, event);</b>
<b class="nc">&nbsp;                safePutUUID(ps, 6, event.getCalculatedFieldId().getId());</b>
<b class="nc">&nbsp;                safePutUUID(ps, 7, event.getEventEntity() != null ? event.getEventEntity().getId() : null);</b>
<b class="nc">&nbsp;                safePutString(ps, 8, event.getEventEntity() != null ? event.getEventEntity().getEntityType().name() : null);</b>
<b class="nc">&nbsp;                safePutUUID(ps, 9, event.getMsgId());</b>
<b class="nc">&nbsp;                safePutString(ps, 10, event.getMsgType());</b>
<b class="nc">&nbsp;                safePutString(ps, 11, event.getArguments());</b>
<b class="nc">&nbsp;                safePutString(ps, 12, event.getResult());</b>
<b class="nc">&nbsp;                safePutString(ps, 13, event.getError());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public int getBatchSize() {
<b class="nc">&nbsp;                return events.size();</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    void safePutString(PreparedStatement ps, int parameterIdx, String value) throws SQLException {
<b class="nc">&nbsp;        if (value != null) {</b>
<b class="nc">&nbsp;            ps.setString(parameterIdx, replaceNullChars(value));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ps.setNull(parameterIdx, Types.VARCHAR);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void safePutUUID(PreparedStatement ps, int parameterIdx, UUID value) throws SQLException {
<b class="nc">&nbsp;        if (value != null) {</b>
<b class="nc">&nbsp;            ps.setObject(parameterIdx, value);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ps.setNull(parameterIdx, Types.OTHER);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void setCommonEventFields(PreparedStatement ps, Event event) throws SQLException {
<b class="nc">&nbsp;        ps.setObject(1, event.getId().getId());</b>
<b class="nc">&nbsp;        ps.setObject(2, event.getTenantId().getId());</b>
<b class="nc">&nbsp;        ps.setLong(3, event.getCreatedTime());</b>
<b class="nc">&nbsp;        ps.setObject(4, event.getEntityId());</b>
<b class="nc">&nbsp;        ps.setString(5, event.getServiceId());</b>
&nbsp;    }
&nbsp;
&nbsp;    private String replaceNullChars(String strValue) {
<b class="nc">&nbsp;        if (removeNullChars &amp;&amp; strValue != null) {</b>
<b class="nc">&nbsp;            return PATTERN_THREAD_LOCAL.get().matcher(strValue).replaceAll(EMPTY_STR);</b>
&nbsp;        }
<b class="nc">&nbsp;        return strValue;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AlarmState</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.profile</a>
</div>

<h1>Coverage Summary for Class: AlarmState (org.thingsboard.rule.engine.profile)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AlarmState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/103)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/169)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AlarmState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/103)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/170)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.profile;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import lombok.Data;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.rule.engine.action.TbAlarmResult;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.profile.state.PersistedAlarmRuleState;
&nbsp;import org.thingsboard.rule.engine.profile.state.PersistedAlarmState;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.alarm.Alarm;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmApiCallResult;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmCreateOrUpdateActiveRequest;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmSeverity;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmUpdateRequest;
&nbsp;import org.thingsboard.server.common.data.device.profile.AlarmConditionKeyType;
&nbsp;import org.thingsboard.server.common.data.device.profile.AlarmConditionSpecType;
&nbsp;import org.thingsboard.server.common.data.device.profile.DeviceProfileAlarm;
&nbsp;import org.thingsboard.server.common.data.id.DashboardId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.function.BiFunction;
&nbsp;
&nbsp;@Data
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Deprecated
&nbsp;class AlarmState {
&nbsp;
&nbsp;    public static final String ERROR_MSG = &quot;Failed to process alarm rule for Device [%s]: %s&quot;;
&nbsp;    private final ProfileState deviceProfile;
&nbsp;    private final EntityId originator;
&nbsp;    private DeviceProfileAlarm alarmDefinition;
&nbsp;    private volatile List&lt;AlarmRuleState&gt; createRulesSortedBySeverityDesc;
&nbsp;    private volatile AlarmRuleState clearState;
&nbsp;    private volatile Alarm currentAlarm;
&nbsp;    private volatile boolean initialFetchDone;
&nbsp;    private volatile TbMsgMetaData lastMsgMetaData;
&nbsp;    private volatile String lastMsgQueueName;
&nbsp;    private volatile DataSnapshot dataSnapshot;
&nbsp;    private final DynamicPredicateValueCtx dynamicPredicateValueCtx;
&nbsp;
<b class="nc">&nbsp;    AlarmState(ProfileState deviceProfile, EntityId originator, DeviceProfileAlarm alarmDefinition, PersistedAlarmState alarmState, DynamicPredicateValueCtx dynamicPredicateValueCtx) {</b>
<b class="nc">&nbsp;        this.deviceProfile = deviceProfile;</b>
<b class="nc">&nbsp;        this.originator = originator;</b>
<b class="nc">&nbsp;        this.dynamicPredicateValueCtx = dynamicPredicateValueCtx;</b>
<b class="nc">&nbsp;        this.updateState(alarmDefinition, alarmState);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean process(TbContext ctx, TbMsg msg, DataSnapshot data, SnapshotUpdate update) throws ExecutionException, InterruptedException {
<b class="nc">&nbsp;        initCurrentAlarm(ctx);</b>
<b class="nc">&nbsp;        lastMsgMetaData = msg.getMetaData();</b>
<b class="nc">&nbsp;        lastMsgQueueName = msg.getQueueName();</b>
<b class="nc">&nbsp;        this.dataSnapshot = data;</b>
&nbsp;        try {
<b class="nc">&nbsp;            return createOrClearAlarms(ctx, msg, data, update, AlarmRuleState::eval);</b>
&nbsp;        } catch (NumericParseException e) {
<b class="nc">&nbsp;            throw new RuntimeException(String.format(ERROR_MSG, originator.getId().toString(), e.getMessage()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public boolean process(TbContext ctx, long ts) throws ExecutionException, InterruptedException {
<b class="nc">&nbsp;        initCurrentAlarm(ctx);</b>
&nbsp;        try {
<b class="nc">&nbsp;            return createOrClearAlarms(ctx, null, ts, null, (alarmState, tsParam) -&gt; alarmState.eval(tsParam, dataSnapshot));</b>
&nbsp;        } catch (NumericParseException e) {
<b class="nc">&nbsp;            throw new RuntimeException(String.format(ERROR_MSG, originator.getId().toString(), e.getMessage()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public &lt;T&gt; boolean createOrClearAlarms(TbContext ctx, TbMsg msg, T data, SnapshotUpdate update, BiFunction&lt;AlarmRuleState, T, AlarmEvalResult&gt; evalFunction) {
<b class="nc">&nbsp;        boolean stateUpdate = false;</b>
<b class="nc">&nbsp;        AlarmRuleState resultState = null;</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] processing update: {}&quot;, alarmDefinition.getId(), data);</b>
<b class="nc">&nbsp;        for (AlarmRuleState state : createRulesSortedBySeverityDesc) {</b>
<b class="nc">&nbsp;            if (!validateUpdate(update, state)) {</b>
<b class="nc">&nbsp;                log.debug(&quot;[{}][{}] Update is not valid for current rule state&quot;, alarmDefinition.getId(), state.getSeverity());</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            AlarmEvalResult evalResult = evalFunction.apply(state, data);</b>
<b class="nc">&nbsp;            stateUpdate |= state.checkUpdate();</b>
<b class="nc">&nbsp;            if (AlarmEvalResult.TRUE.equals(evalResult)) {</b>
<b class="nc">&nbsp;                resultState = state;</b>
&nbsp;                break;
<b class="nc">&nbsp;            } else if (AlarmEvalResult.FALSE.equals(evalResult)) {</b>
<b class="nc">&nbsp;                stateUpdate = clearAlarmState(stateUpdate, state);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (resultState != null) {</b>
<b class="nc">&nbsp;            TbAlarmResult result = calculateAlarmResult(ctx, resultState);</b>
<b class="nc">&nbsp;            if (result != null) {</b>
<b class="nc">&nbsp;                pushMsg(ctx, msg, result, resultState);</b>
&nbsp;            }
<b class="nc">&nbsp;            stateUpdate = clearAlarmState(stateUpdate, clearState);</b>
<b class="nc">&nbsp;        } else if (currentAlarm != null &amp;&amp; clearState != null) {</b>
<b class="nc">&nbsp;            if (!validateUpdate(update, clearState)) {</b>
<b class="nc">&nbsp;                log.debug(&quot;[{}] Update is not valid for current clear state&quot;, alarmDefinition.getId());</b>
<b class="nc">&nbsp;                return stateUpdate;</b>
&nbsp;            }
<b class="nc">&nbsp;            AlarmEvalResult evalResult = evalFunction.apply(clearState, data);</b>
<b class="nc">&nbsp;            if (AlarmEvalResult.TRUE.equals(evalResult)) {</b>
<b class="nc">&nbsp;                stateUpdate = clearAlarmState(stateUpdate, clearState);</b>
<b class="nc">&nbsp;                for (AlarmRuleState state : createRulesSortedBySeverityDesc) {</b>
<b class="nc">&nbsp;                    stateUpdate = clearAlarmState(stateUpdate, state);</b>
&nbsp;                }
<b class="nc">&nbsp;                AlarmApiCallResult result = ctx.getAlarmService().clearAlarm(</b>
<b class="nc">&nbsp;                        ctx.getTenantId(), currentAlarm.getId(), System.currentTimeMillis(), createDetails(clearState)</b>
&nbsp;                );
<b class="nc">&nbsp;                if (result.isCleared()) {</b>
<b class="nc">&nbsp;                    pushMsg(ctx, msg, new TbAlarmResult(false, false, true, result.getAlarm()), clearState);</b>
&nbsp;                }
<b class="nc">&nbsp;                currentAlarm = null;</b>
<b class="nc">&nbsp;            } else if (AlarmEvalResult.FALSE.equals(evalResult)) {</b>
<b class="nc">&nbsp;                stateUpdate = clearAlarmState(stateUpdate, clearState);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return stateUpdate;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean clearAlarmState(boolean stateUpdate, AlarmRuleState state) {
<b class="nc">&nbsp;        if (state != null) {</b>
<b class="nc">&nbsp;            state.clear();</b>
<b class="nc">&nbsp;            stateUpdate |= state.checkUpdate();</b>
&nbsp;        }
<b class="nc">&nbsp;        return stateUpdate;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean validateUpdate(SnapshotUpdate update, AlarmRuleState state) {
<b class="nc">&nbsp;        if (update != null) {</b>
&nbsp;            //Check that the update type and that keys match.
<b class="nc">&nbsp;            if (update.getType().equals(AlarmConditionKeyType.TIME_SERIES)) {</b>
<b class="nc">&nbsp;                return state.validateTsUpdate(update.getKeys());</b>
<b class="nc">&nbsp;            } else if (update.getType().equals(AlarmConditionKeyType.ATTRIBUTE)) {</b>
<b class="nc">&nbsp;                return state.validateAttrUpdate(update.getKeys());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void initCurrentAlarm(TbContext ctx) {
<b class="nc">&nbsp;        if (!initialFetchDone) {</b>
<b class="nc">&nbsp;            Alarm alarm = ctx.getAlarmService().findLatestActiveByOriginatorAndType(ctx.getTenantId(), originator, alarmDefinition.getAlarmType());</b>
<b class="nc">&nbsp;            if (alarm != null &amp;&amp; !alarm.getStatus().isCleared()) {</b>
<b class="nc">&nbsp;                currentAlarm = alarm;</b>
&nbsp;            }
<b class="nc">&nbsp;            initialFetchDone = true;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void pushMsg(TbContext ctx, TbMsg msg, TbAlarmResult alarmResult, AlarmRuleState ruleState) {
<b class="nc">&nbsp;        JsonNode jsonNodes = JacksonUtil.valueToTree(alarmResult.getAlarm());</b>
<b class="nc">&nbsp;        String data = jsonNodes.toString();</b>
<b class="nc">&nbsp;        TbMsgMetaData metaData = lastMsgMetaData != null ? lastMsgMetaData.copy() : new TbMsgMetaData();</b>
&nbsp;        String relationType;
<b class="nc">&nbsp;        if (alarmResult.isCreated()) {</b>
<b class="nc">&nbsp;            relationType = &quot;Alarm Created&quot;;</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.IS_NEW_ALARM, Boolean.TRUE.toString());</b>
<b class="nc">&nbsp;        } else if (alarmResult.isUpdated()) {</b>
<b class="nc">&nbsp;            relationType = &quot;Alarm Updated&quot;;</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.IS_EXISTING_ALARM, Boolean.TRUE.toString());</b>
<b class="nc">&nbsp;        } else if (alarmResult.isSeverityUpdated()) {</b>
<b class="nc">&nbsp;            relationType = &quot;Alarm Severity Updated&quot;;</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.IS_EXISTING_ALARM, Boolean.TRUE.toString());</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.IS_SEVERITY_UPDATED_ALARM, Boolean.TRUE.toString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            relationType = &quot;Alarm Cleared&quot;;</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.IS_CLEARED_ALARM, Boolean.TRUE.toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        setAlarmConditionMetadata(ruleState, metaData);</b>
<b class="nc">&nbsp;        TbMsg newMsg = ctx.newMsg(lastMsgQueueName != null ? lastMsgQueueName : null, TbMsgType.ALARM,</b>
<b class="nc">&nbsp;                originator, msg != null ? msg.getCustomerId() : null, metaData, data);</b>
<b class="nc">&nbsp;        ctx.enqueueForTellNext(newMsg, relationType);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void setAlarmConditionMetadata(AlarmRuleState ruleState, TbMsgMetaData metaData) {
<b class="nc">&nbsp;        if (ruleState.getSpec().getType() == AlarmConditionSpecType.REPEATING) {</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.ALARM_CONDITION_REPEATS, String.valueOf(ruleState.getState().getEventCount()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (ruleState.getSpec().getType() == AlarmConditionSpecType.DURATION) {</b>
<b class="nc">&nbsp;            metaData.putValue(DataConstants.ALARM_CONDITION_DURATION, String.valueOf(ruleState.getState().getDuration()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public void updateState(DeviceProfileAlarm alarm, PersistedAlarmState alarmState) {
<b class="nc">&nbsp;        this.alarmDefinition = alarm;</b>
<b class="nc">&nbsp;        this.createRulesSortedBySeverityDesc = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        alarmDefinition.getCreateRules().forEach((severity, rule) -&gt; {</b>
<b class="nc">&nbsp;            PersistedAlarmRuleState ruleState = null;</b>
<b class="nc">&nbsp;            if (alarmState != null) {</b>
<b class="nc">&nbsp;                ruleState = alarmState.getCreateRuleStates().get(severity);</b>
<b class="nc">&nbsp;                if (ruleState == null) {</b>
<b class="nc">&nbsp;                    ruleState = new PersistedAlarmRuleState();</b>
<b class="nc">&nbsp;                    alarmState.getCreateRuleStates().put(severity, ruleState);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            createRulesSortedBySeverityDesc.add(new AlarmRuleState(severity, rule,</b>
<b class="nc">&nbsp;                    deviceProfile.getCreateAlarmKeys(alarm.getId(), severity), ruleState, dynamicPredicateValueCtx));</b>
&nbsp;        });
<b class="nc">&nbsp;        createRulesSortedBySeverityDesc.sort(Comparator.comparingInt(state -&gt; state.getSeverity().ordinal()));</b>
<b class="nc">&nbsp;        PersistedAlarmRuleState ruleState = alarmState == null ? null : alarmState.getClearRuleState();</b>
<b class="nc">&nbsp;        if (alarmDefinition.getClearRule() != null) {</b>
<b class="nc">&nbsp;            clearState = new AlarmRuleState(null, alarmDefinition.getClearRule(), deviceProfile.getClearAlarmKeys(alarm.getId()), ruleState, dynamicPredicateValueCtx);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TbAlarmResult calculateAlarmResult(TbContext ctx, AlarmRuleState ruleState) {
<b class="nc">&nbsp;        AlarmSeverity severity = ruleState.getSeverity();</b>
<b class="nc">&nbsp;        if (currentAlarm != null) {</b>
&nbsp;            // TODO: In some extremely rare cases, we might miss the event of alarm clear (If one use in-mem queue and restarted the server) or (if one manipulated the rule chain).
&nbsp;            // Maybe we should fetch alarm every time?
<b class="nc">&nbsp;            currentAlarm.setEndTs(System.currentTimeMillis());</b>
<b class="nc">&nbsp;            AlarmSeverity oldSeverity = currentAlarm.getSeverity();</b>
&nbsp;            // Skip update if severity is decreased.
<b class="nc">&nbsp;            if (severity.ordinal() &lt;= oldSeverity.ordinal()) {</b>
<b class="nc">&nbsp;                currentAlarm.setDetails(createDetails(ruleState));</b>
<b class="nc">&nbsp;                currentAlarm.setSeverity(severity);</b>
<b class="nc">&nbsp;                AlarmApiCallResult result = ctx.getAlarmService().updateAlarm(AlarmUpdateRequest.fromAlarm(currentAlarm));</b>
<b class="nc">&nbsp;                currentAlarm = result.getAlarm();</b>
<b class="nc">&nbsp;                return TbAlarmResult.fromAlarmResult(result);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            var newAlarm = new Alarm();</b>
<b class="nc">&nbsp;            newAlarm.setType(alarmDefinition.getAlarmType());</b>
<b class="nc">&nbsp;            newAlarm.setAcknowledged(false);</b>
<b class="nc">&nbsp;            newAlarm.setCleared(false);</b>
<b class="nc">&nbsp;            newAlarm.setSeverity(severity);</b>
<b class="nc">&nbsp;            long startTs = dataSnapshot.getTs();</b>
<b class="nc">&nbsp;            long currentTime = System.currentTimeMillis();</b>
<b class="nc">&nbsp;            if (startTs == 0L || startTs &gt; currentTime) {</b>
<b class="nc">&nbsp;                startTs = currentTime;</b>
&nbsp;            }
<b class="nc">&nbsp;            newAlarm.setStartTs(startTs);</b>
<b class="nc">&nbsp;            newAlarm.setEndTs(startTs);</b>
<b class="nc">&nbsp;            newAlarm.setDetails(createDetails(ruleState));</b>
<b class="nc">&nbsp;            newAlarm.setOriginator(originator);</b>
<b class="nc">&nbsp;            newAlarm.setTenantId(ctx.getTenantId());</b>
<b class="nc">&nbsp;            newAlarm.setPropagate(alarmDefinition.isPropagate());</b>
<b class="nc">&nbsp;            newAlarm.setPropagateToOwner(alarmDefinition.isPropagateToOwner());</b>
<b class="nc">&nbsp;            newAlarm.setPropagateToTenant(alarmDefinition.isPropagateToTenant());</b>
<b class="nc">&nbsp;            if (alarmDefinition.getPropagateRelationTypes() != null) {</b>
<b class="nc">&nbsp;                newAlarm.setPropagateRelationTypes(alarmDefinition.getPropagateRelationTypes());</b>
&nbsp;            }
<b class="nc">&nbsp;            AlarmApiCallResult result = ctx.getAlarmService().createAlarm(AlarmCreateOrUpdateActiveRequest.fromAlarm(newAlarm));</b>
<b class="nc">&nbsp;            currentAlarm = result.getAlarm();</b>
<b class="nc">&nbsp;            return TbAlarmResult.fromAlarmResult(result);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private JsonNode createDetails(AlarmRuleState ruleState) {
&nbsp;        JsonNode alarmDetails;
<b class="nc">&nbsp;        String alarmDetailsStr = ruleState.getAlarmRule().getAlarmDetails();</b>
<b class="nc">&nbsp;        DashboardId dashboardId = ruleState.getAlarmRule().getDashboardId();</b>
&nbsp;
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(alarmDetailsStr) || dashboardId != null) {</b>
<b class="nc">&nbsp;            ObjectNode newDetails = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;            if (StringUtils.isNotEmpty(alarmDetailsStr)) {</b>
<b class="nc">&nbsp;                for (var keyFilter : ruleState.getAlarmRule().getCondition().getCondition()) {</b>
<b class="nc">&nbsp;                    EntityKeyValue entityKeyValue = dataSnapshot.getValue(keyFilter.getKey());</b>
<b class="nc">&nbsp;                    if (entityKeyValue != null) {</b>
<b class="nc">&nbsp;                        alarmDetailsStr = alarmDetailsStr.replaceAll(String.format(&quot;\\$\\{%s}&quot;, keyFilter.getKey().getKey()), getValueAsString(entityKeyValue));</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                newDetails.put(&quot;data&quot;, alarmDetailsStr);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (dashboardId != null) {</b>
<b class="nc">&nbsp;                newDetails.put(&quot;dashboardId&quot;, dashboardId.getId().toString());</b>
&nbsp;            }
<b class="nc">&nbsp;            alarmDetails = newDetails;</b>
<b class="nc">&nbsp;        } else if (currentAlarm != null) {</b>
<b class="nc">&nbsp;            alarmDetails = currentAlarm.getDetails();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            alarmDetails = JacksonUtil.newObjectNode();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return alarmDetails;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static String getValueAsString(EntityKeyValue entityKeyValue) {
<b class="nc">&nbsp;        Object result = null;</b>
<b class="nc">&nbsp;        switch (entityKeyValue.getDataType()) {</b>
&nbsp;            case STRING:
<b class="nc">&nbsp;                result = entityKeyValue.getStrValue();</b>
&nbsp;                break;
&nbsp;            case JSON:
<b class="nc">&nbsp;                result = entityKeyValue.getJsonValue();</b>
&nbsp;                break;
&nbsp;            case LONG:
<b class="nc">&nbsp;                result = entityKeyValue.getLngValue();</b>
&nbsp;                break;
&nbsp;            case DOUBLE:
<b class="nc">&nbsp;                result = entityKeyValue.getDblValue();</b>
&nbsp;                break;
&nbsp;            case BOOLEAN:
<b class="nc">&nbsp;                result = entityKeyValue.getBoolValue();</b>
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return String.valueOf(result);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean processAlarmClear(TbContext ctx, Alarm alarmNf) {
<b class="nc">&nbsp;        boolean updated = false;</b>
<b class="nc">&nbsp;        if (currentAlarm != null &amp;&amp; currentAlarm.getId().equals(alarmNf.getId())) {</b>
<b class="nc">&nbsp;            currentAlarm = null;</b>
<b class="nc">&nbsp;            for (AlarmRuleState state : createRulesSortedBySeverityDesc) {</b>
<b class="nc">&nbsp;                updated = clearAlarmState(updated, state);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return updated;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void processAckAlarm(Alarm alarm) {
<b class="nc">&nbsp;        if (currentAlarm != null &amp;&amp; currentAlarm.getId().equals(alarm.getId())) {</b>
<b class="nc">&nbsp;            currentAlarm.setAcknowledged(alarm.isAcknowledged());</b>
<b class="nc">&nbsp;            currentAlarm.setAckTs(alarm.getAckTs());</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeviceProvisionServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.device</a>
</div>

<h1>Coverage Summary for Class: DeviceProvisionServiceImpl (org.thingsboard.server.service.device)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeviceProvisionServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/138)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DeviceProvisionServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/139)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.device;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.JsonProcessingException;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileProvisionType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.device.profile.X509CertificateChainProvisionConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.kv.AttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.AttributesSaveResult;
&nbsp;import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.StringDataEntry;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentialsType;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;import org.thingsboard.server.common.msg.queue.ServiceType;
&nbsp;import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;
&nbsp;import org.thingsboard.server.common.transport.util.SslUtil;
&nbsp;import org.thingsboard.server.dao.attributes.AttributesService;
&nbsp;import org.thingsboard.server.dao.audit.AuditLogService;
&nbsp;import org.thingsboard.server.dao.device.DeviceCredentialsService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProfileService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProvisionService;
&nbsp;import org.thingsboard.server.dao.device.DeviceService;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionFailedException;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionRequest;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionResponse;
&nbsp;import org.thingsboard.server.dao.device.provision.ProvisionResponseStatus;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ToRuleEngineMsg;
&nbsp;import org.thingsboard.server.queue.TbQueueCallback;
&nbsp;import org.thingsboard.server.queue.TbQueueProducer;
&nbsp;import org.thingsboard.server.queue.common.TbProtoQueueMsg;
&nbsp;import org.thingsboard.server.queue.discovery.PartitionService;
&nbsp;import org.thingsboard.server.queue.provider.TbQueueProducerProvider;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ExecutionException;
&nbsp;import java.util.regex.Matcher;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;
&nbsp;@Service
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@TbCoreComponent
&nbsp;public class DeviceProvisionServiceImpl implements DeviceProvisionService {
&nbsp;
&nbsp;    protected TbQueueProducer&lt;TbProtoQueueMsg&lt;ToRuleEngineMsg&gt;&gt; ruleEngineMsgProducer;
&nbsp;
&nbsp;    private static final String DEVICE_PROVISION_STATE = &quot;provisionState&quot;;
&nbsp;    private static final String PROVISIONED_STATE = &quot;provisioned&quot;;
&nbsp;
&nbsp;    private final DeviceProfileService deviceProfileService;
&nbsp;    private final DeviceService deviceService;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final AttributesService attributesService;
&nbsp;    private final AuditLogService auditLogService;
&nbsp;    private final PartitionService partitionService;
&nbsp;
<b class="nc">&nbsp;    public DeviceProvisionServiceImpl(TbQueueProducerProvider producerProvider, DeviceProfileService deviceProfileService, DeviceService deviceService, DeviceCredentialsService deviceCredentialsService, AttributesService attributesService, AuditLogService auditLogService, PartitionService partitionService) {</b>
<b class="nc">&nbsp;        ruleEngineMsgProducer = producerProvider.getRuleEngineMsgProducer();</b>
<b class="nc">&nbsp;        this.deviceProfileService = deviceProfileService;</b>
<b class="nc">&nbsp;        this.deviceService = deviceService;</b>
<b class="nc">&nbsp;        this.deviceCredentialsService = deviceCredentialsService;</b>
<b class="nc">&nbsp;        this.attributesService = attributesService;</b>
<b class="nc">&nbsp;        this.auditLogService = auditLogService;</b>
<b class="nc">&nbsp;        this.partitionService = partitionService;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProvisionResponse provisionDeviceViaX509Chain(DeviceProfile targetProfile, ProvisionRequest provisionRequest) throws ProvisionFailedException {
<b class="nc">&nbsp;        if (targetProfile == null) {</b>
<b class="nc">&nbsp;            throw new ProvisionFailedException(&quot;Device profile is not specified!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!DeviceProfileProvisionType.X509_CERTIFICATE_CHAIN.equals(targetProfile.getProfileData().getProvisionConfiguration().getType())) {</b>
<b class="nc">&nbsp;            throw new ProvisionFailedException(&quot;Device profile provision strategy is not X509_CERTIFICATE_CHAIN!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        X509CertificateChainProvisionConfiguration configuration = (X509CertificateChainProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration();</b>
<b class="nc">&nbsp;        String certificateValue = provisionRequest.getCredentialsData().getX509CertHash();</b>
<b class="nc">&nbsp;        String certificateRegEx = configuration.getCertificateRegExPattern();</b>
<b class="nc">&nbsp;        String commonName = getCNFromX509Certificate(targetProfile, certificateValue);</b>
<b class="nc">&nbsp;        String deviceName = extractDeviceNameFromCNByRegEx(targetProfile, commonName, certificateRegEx);</b>
<b class="nc">&nbsp;        provisionRequest.setDeviceName(deviceName);</b>
<b class="nc">&nbsp;        Device targetDevice = deviceService.findDeviceByTenantIdAndName(targetProfile.getTenantId(), provisionRequest.getDeviceName());</b>
<b class="nc">&nbsp;        X509CertificateChainProvisionConfiguration x509Configuration = (X509CertificateChainProvisionConfiguration) targetProfile.getProfileData().getProvisionConfiguration();</b>
<b class="nc">&nbsp;        if (targetDevice != null &amp;&amp; targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {</b>
<b class="nc">&nbsp;            DeviceCredentials deviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(targetDevice.getTenantId(), targetDevice.getId());</b>
<b class="nc">&nbsp;            if (DeviceCredentialsType.X509_CERTIFICATE.equals(deviceCredentials.getCredentialsType())) {</b>
<b class="nc">&nbsp;                String updatedDeviceCertificateValue = provisionRequest.getCredentialsData().getX509CertHash();</b>
<b class="nc">&nbsp;                deviceCredentials = updateDeviceCredentials(targetDevice.getTenantId(), deviceCredentials,</b>
&nbsp;                        updatedDeviceCertificateValue, DeviceCredentialsType.X509_CERTIFICATE);
&nbsp;            }
<b class="nc">&nbsp;            return new ProvisionResponse(deviceCredentials, ProvisionResponseStatus.SUCCESS);</b>
<b class="nc">&nbsp;        } else if (x509Configuration.isAllowCreateNewDevicesByX509Certificate()) {</b>
<b class="nc">&nbsp;            return createDevice(provisionRequest, targetProfile);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;[{}][{}] Device with name {} doesn&#39;t exist and cannot be created due incorrect configuration for X509CertificateChainProvisionConfiguration&quot;,</b>
<b class="nc">&nbsp;                    targetProfile.getTenantId(), targetProfile.getId(), provisionRequest.getDeviceName());</b>
<b class="nc">&nbsp;            throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProvisionResponse provisionDevice(ProvisionRequest provisionRequest) {
<b class="nc">&nbsp;        String provisionRequestKey = provisionRequest.getCredentials().getProvisionDeviceKey();</b>
<b class="nc">&nbsp;        String provisionRequestSecret = provisionRequest.getCredentials().getProvisionDeviceSecret();</b>
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(provisionRequest.getDeviceName())) {</b>
<b class="nc">&nbsp;            provisionRequest.setDeviceName(provisionRequest.getDeviceName().trim());</b>
<b class="nc">&nbsp;            if (StringUtils.isEmpty(provisionRequest.getDeviceName())) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Provision request contains empty device name!&quot;);</b>
<b class="nc">&nbsp;                throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (StringUtils.isEmpty(provisionRequestKey) || StringUtils.isEmpty(provisionRequestSecret)) {</b>
<b class="nc">&nbsp;            throw new ProvisionFailedException(ProvisionResponseStatus.NOT_FOUND.name());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        DeviceProfile targetProfile = deviceProfileService.findDeviceProfileByProvisionDeviceKey(provisionRequestKey);</b>
&nbsp;
<b class="nc">&nbsp;        if (targetProfile == null || targetProfile.getProfileData().getProvisionConfiguration() == null ||</b>
<b class="nc">&nbsp;                targetProfile.getProfileData().getProvisionConfiguration().getProvisionDeviceSecret() == null) {</b>
<b class="nc">&nbsp;            throw new ProvisionFailedException(ProvisionResponseStatus.NOT_FOUND.name());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Device targetDevice = deviceService.findDeviceByTenantIdAndName(targetProfile.getTenantId(), provisionRequest.getDeviceName());</b>
&nbsp;
<b class="nc">&nbsp;        switch (targetProfile.getProvisionType()) {</b>
&nbsp;            case ALLOW_CREATE_NEW_DEVICES:
<b class="nc">&nbsp;                if (targetProfile.getProfileData().getProvisionConfiguration().getProvisionDeviceSecret().equals(provisionRequestSecret)) {</b>
<b class="nc">&nbsp;                    if (targetDevice != null) {</b>
<b class="nc">&nbsp;                        log.warn(&quot;[{}] The device is present and could not be provisioned once more!&quot;, targetDevice.getName());</b>
<b class="nc">&nbsp;                        notify(targetDevice, provisionRequest, TbMsgType.PROVISION_FAILURE, false);</b>
<b class="nc">&nbsp;                        throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        return createDevice(provisionRequest, targetProfile);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                break;
&nbsp;            case CHECK_PRE_PROVISIONED_DEVICES:
<b class="nc">&nbsp;                if (targetProfile.getProfileData().getProvisionConfiguration().getProvisionDeviceSecret().equals(provisionRequestSecret)) {</b>
<b class="nc">&nbsp;                    if (targetDevice != null &amp;&amp; targetDevice.getDeviceProfileId().equals(targetProfile.getId())) {</b>
<b class="nc">&nbsp;                        return processProvision(targetDevice, provisionRequest);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        log.warn(&quot;[{}] Failed to find pre provisioned device!&quot;, provisionRequest.getDeviceName());</b>
<b class="nc">&nbsp;                        throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                break;
&nbsp;            case X509_CERTIFICATE_CHAIN:
<b class="nc">&nbsp;                throw new ProvisionFailedException(&quot;Invalid provision strategy type!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        throw new ProvisionFailedException(ProvisionResponseStatus.NOT_FOUND.name());</b>
&nbsp;    }
&nbsp;
&nbsp;    private ProvisionResponse processProvision(Device device, ProvisionRequest provisionRequest) {
&nbsp;        try {
<b class="nc">&nbsp;            Optional&lt;AttributeKvEntry&gt; provisionState = attributesService.find(device.getTenantId(), device.getId(),</b>
<b class="nc">&nbsp;                    AttributeScope.SERVER_SCOPE, DEVICE_PROVISION_STATE).get();</b>
<b class="nc">&nbsp;            if (provisionState != null &amp;&amp; provisionState.isPresent()) {</b>
<b class="nc">&nbsp;                if (provisionState.get().getValueAsString().equals(PROVISIONED_STATE)) {</b>
<b class="nc">&nbsp;                    notify(device, provisionRequest, TbMsgType.PROVISION_FAILURE, false);</b>
<b class="nc">&nbsp;                    throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.error(&quot;[{}][{}] Unknown provision state: {}!&quot;, device.getName(), DEVICE_PROVISION_STATE, provisionState.get().getValueAsString());</b>
<b class="nc">&nbsp;                    throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                saveProvisionStateAttribute(device).get();</b>
<b class="nc">&nbsp;                notify(device, provisionRequest, TbMsgType.PROVISION_SUCCESS, true);</b>
&nbsp;            }
&nbsp;        } catch (InterruptedException | ExecutionException e) {
<b class="nc">&nbsp;            throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;        }
<b class="nc">&nbsp;        return new ProvisionResponse(deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId()), ProvisionResponseStatus.SUCCESS);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ProvisionResponse createDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {
<b class="nc">&nbsp;        return processCreateDevice(provisionRequest, profile);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void notify(Device device, ProvisionRequest provisionRequest, TbMsgType type, boolean success) {
<b class="nc">&nbsp;        pushProvisionEventToRuleEngine(provisionRequest, device, type);</b>
<b class="nc">&nbsp;        logAction(device.getTenantId(), device.getCustomerId(), device, success, provisionRequest);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ProvisionResponse processCreateDevice(ProvisionRequest provisionRequest, DeviceProfile profile) {
&nbsp;        try {
<b class="nc">&nbsp;            if (StringUtils.isEmpty(provisionRequest.getDeviceName())) {</b>
<b class="nc">&nbsp;                String newDeviceName = StringUtils.randomAlphanumeric(20);</b>
<b class="nc">&nbsp;                log.info(&quot;Device name not found in provision request. Generated name is: {}&quot;, newDeviceName);</b>
<b class="nc">&nbsp;                provisionRequest.setDeviceName(newDeviceName);</b>
&nbsp;            }
<b class="nc">&nbsp;            Device savedDevice = deviceService.saveDevice(provisionRequest, profile);</b>
<b class="nc">&nbsp;            saveProvisionStateAttribute(savedDevice).get();</b>
<b class="nc">&nbsp;            pushDeviceCreatedEventToRuleEngine(savedDevice);</b>
<b class="nc">&nbsp;            notify(savedDevice, provisionRequest, TbMsgType.PROVISION_SUCCESS, true);</b>
&nbsp;
<b class="nc">&nbsp;            return new ProvisionResponse(getDeviceCredentials(savedDevice), ProvisionResponseStatus.SUCCESS);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Error during device creation from provision request: [{}]&quot;, provisionRequest.getDeviceName(), provisionRequest, e);</b>
<b class="nc">&nbsp;            Device device = deviceService.findDeviceByTenantIdAndName(profile.getTenantId(), provisionRequest.getDeviceName());</b>
<b class="nc">&nbsp;            if (device != null) {</b>
<b class="nc">&nbsp;                notify(device, provisionRequest, TbMsgType.PROVISION_FAILURE, false);</b>
&nbsp;            }
<b class="nc">&nbsp;            throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private DeviceCredentials updateDeviceCredentials(TenantId tenantId, DeviceCredentials deviceCredentials, String certificateValue,
&nbsp;                                                      DeviceCredentialsType credentialsType) {
<b class="nc">&nbsp;        log.trace(&quot;Updating device credentials [{}] with certificate value [{}]&quot;, deviceCredentials, certificateValue);</b>
<b class="nc">&nbsp;        deviceCredentials.setCredentialsValue(certificateValue);</b>
<b class="nc">&nbsp;        deviceCredentials.setCredentialsType(credentialsType);</b>
<b class="nc">&nbsp;        return deviceCredentialsService.updateDeviceCredentials(tenantId, deviceCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;AttributesSaveResult&gt; saveProvisionStateAttribute(Device device) {
<b class="nc">&nbsp;        return attributesService.save(</b>
<b class="nc">&nbsp;                device.getTenantId(), device.getId(), AttributeScope.SERVER_SCOPE,</b>
<b class="nc">&nbsp;                new BaseAttributeKvEntry(new StringDataEntry(DEVICE_PROVISION_STATE, PROVISIONED_STATE), System.currentTimeMillis())</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    private DeviceCredentials getDeviceCredentials(Device device) {
<b class="nc">&nbsp;        return deviceCredentialsService.findDeviceCredentialsByDeviceId(device.getTenantId(), device.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void pushProvisionEventToRuleEngine(ProvisionRequest request, Device device, TbMsgType type) {
&nbsp;        try {
<b class="nc">&nbsp;            JsonNode entityNode = JacksonUtil.valueToTree(request);</b>
<b class="nc">&nbsp;            TbMsg msg = TbMsg.newMsg()</b>
<b class="nc">&nbsp;                    .type(type)</b>
<b class="nc">&nbsp;                    .originator(device.getId())</b>
<b class="nc">&nbsp;                    .customerId(device.getCustomerId())</b>
<b class="nc">&nbsp;                    .copyMetaData(createTbMsgMetaData(device))</b>
<b class="nc">&nbsp;                    .data(JacksonUtil.toString(entityNode))</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            sendToRuleEngine(device.getTenantId(), msg, null);</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to push device action to rule engine: {}&quot;, device.getId(), type, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void pushDeviceCreatedEventToRuleEngine(Device device) {
&nbsp;        try {
<b class="nc">&nbsp;            ObjectNode entityNode = JacksonUtil.OBJECT_MAPPER.valueToTree(device);</b>
<b class="nc">&nbsp;            TbMsg msg = TbMsg.newMsg()</b>
<b class="nc">&nbsp;                    .type(TbMsgType.ENTITY_CREATED)</b>
<b class="nc">&nbsp;                    .originator(device.getId())</b>
<b class="nc">&nbsp;                    .customerId(device.getCustomerId())</b>
<b class="nc">&nbsp;                    .copyMetaData(createTbMsgMetaData(device))</b>
<b class="nc">&nbsp;                    .data(JacksonUtil.OBJECT_MAPPER.writeValueAsString(entityNode))</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            sendToRuleEngine(device.getTenantId(), msg, null);</b>
&nbsp;        } catch (JsonProcessingException | IllegalArgumentException e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to push device action to rule engine: {}&quot;, device.getId(), TbMsgType.ENTITY_CREATED.name(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected void sendToRuleEngine(TenantId tenantId, TbMsg tbMsg, TbQueueCallback callback) {
<b class="nc">&nbsp;        TopicPartitionInfo tpi = partitionService.resolve(ServiceType.TB_RULE_ENGINE, tenantId, tbMsg.getOriginator());</b>
<b class="nc">&nbsp;        TransportProtos.ToRuleEngineMsg msg = TransportProtos.ToRuleEngineMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setTbMsgProto(TbMsg.toProto(tbMsg))</b>
<b class="nc">&nbsp;                .setTenantIdMSB(tenantId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdLSB(tenantId.getId().getLeastSignificantBits()).build();</b>
<b class="nc">&nbsp;        ruleEngineMsgProducer.send(tpi, new TbProtoQueueMsg&lt;&gt;(tbMsg.getId(), msg), callback);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbMsgMetaData createTbMsgMetaData(Device device) {
<b class="nc">&nbsp;        TbMsgMetaData metaData = new TbMsgMetaData();</b>
<b class="nc">&nbsp;        metaData.putValue(&quot;tenantId&quot;, device.getTenantId().toString());</b>
<b class="nc">&nbsp;        return metaData;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void logAction(TenantId tenantId, CustomerId customerId, Device device, boolean success, ProvisionRequest provisionRequest) {
<b class="nc">&nbsp;        ActionType actionType = success ? ActionType.PROVISION_SUCCESS : ActionType.PROVISION_FAILURE;</b>
<b class="nc">&nbsp;        auditLogService.logEntityAction(tenantId, customerId, new UserId(UserId.NULL_UUID), device.getName(), device.getId(), device, actionType, null, provisionRequest);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getCNFromX509Certificate(DeviceProfile profile, String x509Value) {
&nbsp;        try {
<b class="nc">&nbsp;            return SslUtil.parseCommonName(SslUtil.readCertFile(x509Value));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.trace(&quot;[{}][{}] Failed to parse CN from X509 certificate {}&quot;, profile.getTenantId(), profile.getId(), x509Value);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String extractDeviceNameFromCNByRegEx(DeviceProfile profile, String commonName, String regex) throws ProvisionFailedException {
&nbsp;        try {
<b class="nc">&nbsp;            log.trace(&quot;Extract device name from CN [{}] by regex pattern [{}]&quot;, commonName, regex);</b>
<b class="nc">&nbsp;            Pattern pattern = Pattern.compile(regex);</b>
<b class="nc">&nbsp;            Matcher matcher = pattern.matcher(commonName);</b>
<b class="nc">&nbsp;            if (matcher.find()) {</b>
<b class="nc">&nbsp;                return matcher.group(1);</b>
&nbsp;            }
&nbsp;        } catch (Exception ignored) {}
<b class="nc">&nbsp;        log.trace(&quot;[{}][{}] Failed to match device name using [{}] from CN: [{}]&quot;, profile.getTenantId(), profile.getId(), regex, commonName);</b>
<b class="nc">&nbsp;        throw new ProvisionFailedException(ProvisionResponseStatus.FAILURE.name());</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SparkplugMetricUtil</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.transport.mqtt.util.sparkplug</a>
</div>

<h1>Coverage Summary for Class: SparkplugMetricUtil (org.thingsboard.server.transport.mqtt.util.sparkplug)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SparkplugMetricUtil</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/124)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/169)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SparkplugMetricUtil$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SparkplugMetricUtil$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SparkplugMetricUtil$File</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/126)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/191)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.transport.mqtt.util.sparkplug;
&nbsp;
&nbsp;import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
&nbsp;import com.fasterxml.jackson.core.type.TypeReference;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.annotation.JsonSerialize;
&nbsp;import com.fasterxml.jackson.databind.node.ArrayNode;
&nbsp;import com.fasterxml.jackson.databind.ser.std.FileSerializer;
&nbsp;import com.google.protobuf.ByteString;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.mqtt.SparkplugBProto;
&nbsp;import org.thingsboard.server.gen.transport.mqtt.SparkplugBProto.Payload.Metric;
&nbsp;import org.thingsboard.server.gen.transport.mqtt.SparkplugBProto.Payload.Metric.Builder;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.nio.ByteBuffer;
&nbsp;import java.text.NumberFormat;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;import static org.thingsboard.common.util.JacksonUtil.newArrayNode;
&nbsp;
&nbsp;/**
&nbsp; * Provides utility methods for SparkplugB MQTT Payload Metric.
&nbsp; */
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class SparkplugMetricUtil {</b>
&nbsp;
&nbsp;    public static final String SPARKPLUG_SEQUENCE_NUMBER_KEY = &quot;seq&quot;;
&nbsp;    public static final String SPARKPLUG_BD_SEQUENCE_NUMBER_KEY = &quot;bdSeq&quot;;
&nbsp;
&nbsp;    public static Optional&lt;TransportProtos.KeyValueProto&gt; fromSparkplugBMetricToKeyValueProto(String key, SparkplugBProto.Payload.Metric protoMetric) throws ThingsboardException {
&nbsp;        // Check if the null flag has been set indicating that the value is null
<b class="nc">&nbsp;        if (protoMetric.getIsNull()) {</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;        // Otherwise convert the value based on the type
<b class="nc">&nbsp;        int metricType = protoMetric.getDatatype();</b>
<b class="nc">&nbsp;        TransportProtos.KeyValueProto.Builder builderProto = TransportProtos.KeyValueProto.newBuilder();</b>
<b class="nc">&nbsp;        ArrayNode nodeArray = newArrayNode();</b>
<b class="nc">&nbsp;        MetricDataType metricDataType = MetricDataType.fromInteger(metricType);</b>
&nbsp;        try {
<b class="nc">&nbsp;            switch (metricDataType) {</b>
&nbsp;                case Boolean:
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.BOOLEAN_V)</b>
<b class="nc">&nbsp;                            .setBoolV(protoMetric.getBooleanValue()).build());</b>
&nbsp;                case DateTime:
&nbsp;                case Int64:
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.LONG_V)</b>
<b class="nc">&nbsp;                            .setLongV(protoMetric.getLongValue()).build());</b>
&nbsp;                case Float:
<b class="nc">&nbsp;                    var f = new BigDecimal(String.valueOf(protoMetric.getFloatValue()));</b>
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.DOUBLE_V)</b>
<b class="nc">&nbsp;                            .setDoubleV(f.doubleValue()).build());</b>
&nbsp;                case Double:
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.LONG_V)</b>
<b class="nc">&nbsp;                            .setLongV(Double.valueOf(protoMetric.getDoubleValue()).longValue()).build());</b>
&nbsp;                case Int8:
&nbsp;                case UInt8:
&nbsp;                case Int16:
&nbsp;                case Int32:
&nbsp;                case UInt16:
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.LONG_V)</b>
<b class="nc">&nbsp;                            .setLongV(protoMetric.getIntValue()).build());</b>
&nbsp;                case UInt32:
&nbsp;                case UInt64:
<b class="nc">&nbsp;                    if (protoMetric.hasIntValue()) {</b>
<b class="nc">&nbsp;                        return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.LONG_V)</b>
<b class="nc">&nbsp;                                .setLongV(protoMetric.getIntValue()).build());</b>
<b class="nc">&nbsp;                    } else if (protoMetric.hasLongValue()) {</b>
<b class="nc">&nbsp;                        return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.LONG_V)</b>
<b class="nc">&nbsp;                                .setLongV(protoMetric.getLongValue()).build());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        log.error(&quot;Invalid value for UInt32 datatype&quot;);</b>
<b class="nc">&nbsp;                        throw new ThingsboardException(&quot;Invalid value for &quot; + MetricDataType.fromInteger(metricType).name() + &quot; datatype &quot; + metricType, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;                    }
&nbsp;                case String:
&nbsp;                case Text:
&nbsp;                case UUID:
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.STRING_V)</b>
<b class="nc">&nbsp;                            .setStringV(protoMetric.getStringValue()).build());</b>
&nbsp;                // byte[]
&nbsp;                case Bytes:
<b class="nc">&nbsp;                    ByteBuffer byteBuffer = ByteBuffer.wrap(protoMetric.getBytesValue().toByteArray());</b>
<b class="nc">&nbsp;                    while (byteBuffer.hasRemaining()) {</b>
<b class="nc">&nbsp;                        nodeArray.add(byteBuffer.get());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.JSON_V)</b>
<b class="nc">&nbsp;                            .setJsonV(nodeArray.toString()).build());</b>
&nbsp;                case DataSet:
&nbsp;                case Template:
&nbsp;                case File:
&nbsp;                    //TODO
&nbsp;                    // Build the and create the DataSet
&nbsp;                    /**
&nbsp;                     SparkplugBProto.Payload.DataSet protoDataSet = protoMetric.getDatasetValue();
&nbsp;                     return new SparkplugBProto.Payload.DataSet.Builder(protoDataSet.getNumOfColumns()).addColumnNames(protoDataSet.getColumnsList())
&nbsp;                     .addTypes(convertDataSetDataTypes(protoDataSet.getTypesList()))
&nbsp;                     .addRows(convertDataSetRows(protoDataSet.getRowsList(), protoDataSet.getTypesList()))
&nbsp;                     .createDataSet();
&nbsp;                     return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.STRING_V)
&nbsp;                     .setStringV(protoDataSet.toString()).build());
&nbsp;                     **/
&nbsp;                    //TODO
&nbsp;                    // Build the and create the Template
&nbsp;                    /**
&nbsp;                     SparkplugBProto.Payload.Template protoTemplate = protoMetric.getTemplateValue();
&nbsp;                     return Optional.of(builderProto.setKey(key).setType(TransportProtos.KeyValueType.STRING_V)
&nbsp;                     .setStringV( protoTemplate.toString()).build());
&nbsp;                     **/
&nbsp;                    //TODO
&nbsp;                    // Build the and create the File
&nbsp;                    /**
&nbsp;                     String filename = protoMetric.getMetadata().getFileName();
&nbsp;                     return Optional.of(builderPrbyteValueoto.setKey(key + &quot;_&quot; + filename).setType(TransportProtos.KeyValueType.STRING_V)
&nbsp;                     .setStringV(Hex.encodeHexString((protoMetric.getBytesValue().toByteArray()))).build());
&nbsp;                     **/
<b class="nc">&nbsp;                    return Optional.empty();</b>
&nbsp;                case Unknown:
&nbsp;                default:
<b class="nc">&nbsp;                    throw new ThingsboardException(&quot;Failed to decode: Unknown MetricDataType &quot; + metricType, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;&quot;, e);</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    public static SparkplugBProto.Payload.Metric createMetric(Object value, long ts, String key, MetricDataType metricDataType, Long alias) throws ThingsboardException {
<b class="nc">&nbsp;        Builder metric = Metric.newBuilder();</b>
<b class="nc">&nbsp;        metric.setTimestamp(ts)</b>
<b class="nc">&nbsp;                .setDatatype(metricDataType.toIntValue());</b>
<b class="nc">&nbsp;        if (alias &gt;= 0) {</b>
<b class="nc">&nbsp;            metric.setAlias(alias);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (StringUtils.isNotBlank(key)) {</b>
<b class="nc">&nbsp;            metric.setName(key);</b>
&nbsp;        }
<b class="nc">&nbsp;        return addToMetricValue(value, metric.build(), metricDataType);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static SparkplugBProto.Payload.Metric addToMetricValue(Object value, SparkplugBProto.Payload.Metric metric, MetricDataType metricDataType) throws ThingsboardException {
<b class="nc">&nbsp;        switch (metricDataType) {</b>
&nbsp;            case Int8:      //  (byte)
<b class="nc">&nbsp;                return metric.toBuilder().setIntValue(((Byte) value).intValue()).build();</b>
&nbsp;            case Int16:     // (short)
&nbsp;            case UInt8:
<b class="nc">&nbsp;                return metric.toBuilder().setIntValue(((Short) value).intValue()).build();</b>
&nbsp;            case UInt16:     //  (int)
&nbsp;            case Int32:
<b class="nc">&nbsp;                return metric.toBuilder().setIntValue(((Integer) value).intValue()).build();</b>
&nbsp;            case UInt32:     // (long)
&nbsp;            case Int64:
&nbsp;            case UInt64:
&nbsp;            case DateTime:
<b class="nc">&nbsp;                return metric.toBuilder().setLongValue(((Long) value).longValue()).build();</b>
&nbsp;            case Float:     // (float)
<b class="nc">&nbsp;                return metric.toBuilder().setFloatValue(((Float) value).floatValue()).build();</b>
&nbsp;            case Double:     // (double)
<b class="nc">&nbsp;                return metric.toBuilder().setDoubleValue(((Double) value).doubleValue()).build();</b>
&nbsp;            case Boolean:      // (boolean)
<b class="nc">&nbsp;                return metric.toBuilder().setBooleanValue(((Boolean) value).booleanValue()).build();</b>
&nbsp;            case String:        // String)
&nbsp;            case Text:
&nbsp;            case UUID:
<b class="nc">&nbsp;                return metric.toBuilder().setStringValue((String) value).build();</b>
&nbsp;            case Bytes:
<b class="nc">&nbsp;                ByteString byteString = ByteString.copyFrom((byte[]) value);</b>
<b class="nc">&nbsp;                return metric.toBuilder().setBytesValue(byteString).build();</b>
&nbsp;            case DataSet:
<b class="nc">&nbsp;                return metric.toBuilder().setDatasetValue((SparkplugBProto.Payload.DataSet) value).build();</b>
&nbsp;            case File:
<b class="nc">&nbsp;                SparkplugMetricUtil.File file = (SparkplugMetricUtil.File) value;</b>
<b class="nc">&nbsp;                ByteString byteFileString = ByteString.copyFrom(file.getBytes());</b>
<b class="nc">&nbsp;                return metric.toBuilder().setBytesValue(byteFileString).build();</b>
&nbsp;            case Template:
<b class="nc">&nbsp;                return metric.toBuilder().setTemplateValue((SparkplugBProto.Payload.Template) value).build();</b>
&nbsp;            case Unknown:
<b class="nc">&nbsp;                throw new ThingsboardException(&quot;Invalid value for MetricDataType &quot; + metricDataType.name(), ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;        }
<b class="nc">&nbsp;        return metric;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TransportProtos.TsKvProto getTsKvProtoFromJsonNode(JsonNode kvProto, long ts) throws ThingsboardException {
<b class="nc">&nbsp;        String kvProtoKey = kvProto.fieldNames().next();</b>
<b class="nc">&nbsp;        String kvProtoValue = kvProto.get(kvProtoKey).asText();</b>
<b class="nc">&nbsp;        return getTsKvProto(kvProtoKey, kvProtoValue, ts);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TransportProtos.TsKvProto getTsKvProto(String key, Object value, long ts) throws ThingsboardException {
&nbsp;        try {
<b class="nc">&nbsp;            TransportProtos.TsKvProto.Builder tsKvProtoBuilder = TransportProtos.TsKvProto.newBuilder();</b>
<b class="nc">&nbsp;            TransportProtos.KeyValueProto.Builder keyValueProtoBuilder = TransportProtos.KeyValueProto.newBuilder();</b>
<b class="nc">&nbsp;            keyValueProtoBuilder.setKey(key);</b>
<b class="nc">&nbsp;            if (value instanceof String) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.STRING_V);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setStringV((String) value);</b>
<b class="nc">&nbsp;            } else if (value instanceof Integer) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.LONG_V);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setLongV((Integer) value);</b>
<b class="nc">&nbsp;            } else if (value instanceof Long) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.LONG_V);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setLongV((Long) value);</b>
<b class="nc">&nbsp;            } else if (value instanceof Boolean) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.BOOLEAN_V);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setBoolV((Boolean) value);</b>
<b class="nc">&nbsp;            } else if (value instanceof Double) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.DOUBLE_V);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setDoubleV((Double) value);</b>
<b class="nc">&nbsp;            } else if (value instanceof List) {</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setType(TransportProtos.KeyValueType.JSON_V);</b>
<b class="nc">&nbsp;                ArrayNode arrayNodeBytes = JacksonUtil.convertValue(value, ArrayNode.class);</b>
<b class="nc">&nbsp;                keyValueProtoBuilder.setJsonV(arrayNodeBytes.toString());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                throw new ThingsboardException(&quot;Failed to convert device/node RPC command to TsKvProto for Sparkplug MQT msg: value [&quot; + value + &quot;]&quot;, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;            }
<b class="nc">&nbsp;            tsKvProtoBuilder.setKv(keyValueProtoBuilder.build());</b>
<b class="nc">&nbsp;            tsKvProtoBuilder.setTs(ts);</b>
<b class="nc">&nbsp;            return tsKvProtoBuilder.build();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Failed to convert device/node RPC command to TsKvProto for Sparkplug MQT msg: value [&quot; + value + &quot;]&quot;, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static Optional&lt;Object&gt; validatedValueByTypeMetric(TransportProtos.KeyValueProto kv, MetricDataType metricDataType) throws ThingsboardException {
<b class="nc">&nbsp;        if (kv.getTypeValue() &lt;= 3) {</b>
<b class="nc">&nbsp;            return validatedValuePrimitiveByTypeMetric(kv, metricDataType);</b>
<b class="nc">&nbsp;        } else if (kv.getTypeValue() == 4) {</b>
<b class="nc">&nbsp;            JsonNode arrayNode = JacksonUtil.fromString(kv.getJsonV(), JsonNode.class);</b>
<b class="nc">&nbsp;            if (arrayNode.isArray()) {</b>
<b class="nc">&nbsp;                return validatedValueJsonByTypeMetric(kv.getJsonV(), metricDataType);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Invalid type KeyValueProto &quot; + kv.toString() + &quot; for MetricDataType &quot; + metricDataType.name(), ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;        }
<b class="nc">&nbsp;        return Optional.empty();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static Optional&lt;Object&gt; validatedValuePrimitiveByTypeMetric(TransportProtos.KeyValueProto kv, MetricDataType metricDataType) throws ThingsboardException {
<b class="nc">&nbsp;        Optional&lt;String&gt; valueOpt = getValueKvProtoPrimitive(kv);</b>
<b class="nc">&nbsp;        if (valueOpt.isPresent()) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                switch (metricDataType) {</b>
&nbsp;                    // int
&nbsp;                    case Int8:
&nbsp;                    case Int16:
&nbsp;                    case UInt8:
&nbsp;                    case UInt16:
&nbsp;                    case Int32:
<b class="nc">&nbsp;                        Optional&lt;Integer&gt; boolInt8 = booleanStringToInt(valueOpt.get());</b>
<b class="nc">&nbsp;                        if (boolInt8.isPresent()) {</b>
<b class="nc">&nbsp;                            return Optional.of(boolInt8.get());</b>
&nbsp;                        }
&nbsp;                        try {
<b class="nc">&nbsp;                            return Optional.of(Integer.valueOf(valueOpt.get()));</b>
&nbsp;                        } catch (NumberFormatException eInt) {
<b class="nc">&nbsp;                            var i = new BigDecimal(valueOpt.get());</b>
<b class="nc">&nbsp;                            if (i.longValue() &lt;= Integer.MAX_VALUE) {</b>
<b class="nc">&nbsp;                                return Optional.of(i.intValue());</b>
&nbsp;                            }
<b class="nc">&nbsp;                            throw new ThingsboardException(&quot;Invalid type value &quot; + kv.toString() + &quot; for MetricDataType &quot;</b>
<b class="nc">&nbsp;                                    + metricDataType.name(), eInt, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;                        }
&nbsp;                        // long
&nbsp;                    case UInt32:
&nbsp;                    case Int64:
&nbsp;                    case UInt64:
&nbsp;                    case DateTime:
<b class="nc">&nbsp;                        Optional&lt;Integer&gt; boolInt64 = booleanStringToInt(valueOpt.get());</b>
<b class="nc">&nbsp;                        if (boolInt64.isPresent()) {</b>
<b class="nc">&nbsp;                            return Optional.of(Long.valueOf(boolInt64.get()));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        var l = new BigDecimal(valueOpt.get());</b>
<b class="nc">&nbsp;                        return Optional.of(l.longValue());</b>
&nbsp;                    // float
&nbsp;                    case Float:
<b class="nc">&nbsp;                        Optional&lt;Integer&gt; boolFloat = booleanStringToInt(valueOpt.get());</b>
<b class="nc">&nbsp;                        if (boolFloat.isPresent()) {</b>
<b class="nc">&nbsp;                            var fb = new BigDecimal(boolFloat.get());</b>
<b class="nc">&nbsp;                            return Optional.of(fb.floatValue());</b>
&nbsp;                        }
<b class="nc">&nbsp;                        var f = new BigDecimal(valueOpt.get());</b>
<b class="nc">&nbsp;                        return Optional.of(f.floatValue());</b>
&nbsp;                    // double
&nbsp;                    case Double:
<b class="nc">&nbsp;                        Optional&lt;Integer&gt; boolDouble = booleanStringToInt(valueOpt.get());</b>
<b class="nc">&nbsp;                        if (boolDouble.isPresent()) {</b>
<b class="nc">&nbsp;                            return Optional.of(Double.valueOf(boolDouble.get()));</b>
&nbsp;                        }
<b class="nc">&nbsp;                        var dd = new BigDecimal(valueOpt.get());</b>
<b class="nc">&nbsp;                        return Optional.of(dd.doubleValue());</b>
&nbsp;                    case Boolean:
<b class="nc">&nbsp;                        if (&quot;true&quot;.equals(valueOpt.get())) {</b>
<b class="nc">&nbsp;                            return Optional.of(true);</b>
<b class="nc">&nbsp;                        } else if (&quot;false&quot;.equals(valueOpt.get())) {</b>
<b class="nc">&nbsp;                            return Optional.of(false);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            Number number = NumberFormat.getInstance().parse(valueOpt.get());</b>
<b class="nc">&nbsp;                            if (StringUtils.isBlank(number.toString()) || &quot;0&quot;.equals(number.toString())) { // ok 0</b>
<b class="nc">&nbsp;                                return Optional.of(false);</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                return Optional.of(true);</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    case String:
&nbsp;                    case Text:
&nbsp;                    case UUID:
<b class="nc">&nbsp;                        return Optional.of(valueOpt.get());</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.trace(&quot;Invalid type value [{}] for MetricDataType [{}] [{}]&quot;, kv, metricDataType.name(), e.getMessage());</b>
<b class="nc">&nbsp;                throw new ThingsboardException(&quot;Invalid type value &quot; + kv.toString() + &quot; for MetricDataType &quot; + metricDataType.name(), e, ThingsboardErrorCode.INVALID_ARGUMENTS);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return Optional.empty();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static Optional&lt;Object&gt; validatedValueJsonByTypeMetric(String arrayNodeStr, MetricDataType metricDataType) {
&nbsp;        try {
&nbsp;            Optional&lt;Object&gt; valueOpt;
<b class="nc">&nbsp;            switch (metricDataType) {</b>
&nbsp;                // byte[]
&nbsp;                case Bytes:
<b class="nc">&nbsp;                    List&lt;Byte&gt; listBytes = JacksonUtil.fromString(arrayNodeStr, new TypeReference&lt;&gt;() {</b>
&nbsp;                    });
<b class="nc">&nbsp;                    byte[] bytes = new byte[listBytes.size()];</b>
<b class="nc">&nbsp;                    for (int i = 0; i &lt; listBytes.size(); i++) {</b>
<b class="nc">&nbsp;                        bytes[i] = listBytes.get(i).byteValue();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return Optional.of(bytes);</b>
&nbsp;                case DataSet:
&nbsp;                case File:
&nbsp;                case Template:
<b class="nc">&nbsp;                    log.error(&quot;Invalid type value [{}] for MetricDataType [{}]&quot;, arrayNodeStr, metricDataType.name());</b>
<b class="nc">&nbsp;                    return Optional.empty();</b>
&nbsp;                case Unknown:
&nbsp;                default:
<b class="nc">&nbsp;                    log.error(&quot;Invalid MetricDataType [{}] type,  value [{}]&quot;, arrayNodeStr, metricDataType.name());</b>
<b class="nc">&nbsp;                    return Optional.empty();</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Invalid type value [{}] for MetricDataType [{}] [{}]&quot;, arrayNodeStr, metricDataType.name(), e.getMessage());</b>
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static Optional&lt;String&gt; getValueKvProtoPrimitive(TransportProtos.KeyValueProto kv) {
<b class="nc">&nbsp;        if (kv.getTypeValue() == 0) {         // boolean</b>
<b class="nc">&nbsp;            return Optional.of(String.valueOf(kv.getBoolV()));</b>
<b class="nc">&nbsp;        } else if (kv.getTypeValue() == 1) {   // kvLong</b>
<b class="nc">&nbsp;            return Optional.of(String.valueOf(kv.getLongV()));</b>
<b class="nc">&nbsp;        } else if (kv.getTypeValue() == 2) {   // kvDouble/float</b>
<b class="nc">&nbsp;            return Optional.of(String.valueOf(kv.getDoubleV()));</b>
<b class="nc">&nbsp;        } else if (kv.getTypeValue() == 3) {   // kvString</b>
<b class="nc">&nbsp;            return Optional.of(kv.getStringV());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static Optional&lt;Integer&gt; booleanStringToInt(String booleanStr) {
<b class="nc">&nbsp;        if (&quot;true&quot;.equals(booleanStr)) {</b>
<b class="nc">&nbsp;            return Optional.of(1);</b>
<b class="nc">&nbsp;        } else if (&quot;false&quot;.equals(booleanStr)) {</b>
<b class="nc">&nbsp;            return Optional.of(0);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Optional.empty();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @JsonIgnoreProperties(
&nbsp;            value = {&quot;fileName&quot;})
&nbsp;    @JsonSerialize(
&nbsp;            using = FileSerializer.class)
&nbsp;    public class File {
&nbsp;
&nbsp;        private String fileName;
&nbsp;        private byte[] bytes;
&nbsp;
&nbsp;        /**
&nbsp;         * Default Constructor
&nbsp;         */
<b class="nc">&nbsp;        public File() {</b>
<b class="nc">&nbsp;            super();</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Constructor
&nbsp;         *
&nbsp;         * @param fileName the full file name path
&nbsp;         * @param bytes    the array of bytes that represent the contents of the file
&nbsp;         */
<b class="nc">&nbsp;        public File(String fileName, byte[] bytes) {</b>
<b class="nc">&nbsp;            super();</b>
<b class="nc">&nbsp;            this.fileName = fileName == null</b>
<b class="nc">&nbsp;                    ? null</b>
<b class="nc">&nbsp;                    : fileName.replace(&quot;/&quot;, System.getProperty(&quot;file.separator&quot;)).replace(&quot;\\&quot;,</b>
<b class="nc">&nbsp;                    System.getProperty(&quot;file.separator&quot;));</b>
<b class="nc">&nbsp;            this.bytes = Arrays.copyOf(bytes, bytes.length);</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Gets the full filename path
&nbsp;         *
&nbsp;         * @return the full filename path
&nbsp;         */
&nbsp;        public String getFileName() {
<b class="nc">&nbsp;            return fileName;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Sets the full filename path
&nbsp;         *
&nbsp;         * @param fileName the full filename path
&nbsp;         */
&nbsp;        public void setFileName(String fileName) {
<b class="nc">&nbsp;            this.fileName = fileName;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Gets the bytes that represent the contents of the file
&nbsp;         *
&nbsp;         * @return the bytes that represent the contents of the file
&nbsp;         */
&nbsp;        public byte[] getBytes() {
<b class="nc">&nbsp;            return bytes;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * Sets the bytes that represent the contents of the file
&nbsp;         *
&nbsp;         * @param bytes the bytes that represent the contents of the file
&nbsp;         */
&nbsp;        public void setBytes(byte[] bytes) {
<b class="nc">&nbsp;            this.bytes = bytes;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public String toString() {
<b class="nc">&nbsp;            StringBuilder builder = new StringBuilder();</b>
<b class="nc">&nbsp;            builder.append(&quot;File [fileName=&quot;);</b>
<b class="nc">&nbsp;            builder.append(fileName);</b>
<b class="nc">&nbsp;            builder.append(&quot;, bytes=&quot;);</b>
<b class="nc">&nbsp;            builder.append(Arrays.toString(bytes));</b>
<b class="nc">&nbsp;            builder.append(&quot;]&quot;);</b>
<b class="nc">&nbsp;            return builder.toString();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

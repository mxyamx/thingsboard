<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TBRedisCacheConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.cache</a>
</div>

<h1>Coverage Summary for Class: TBRedisCacheConfiguration (org.thingsboard.server.cache)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TBRedisCacheConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.cache;
&nbsp;
&nbsp;import lombok.Data;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.cache.CacheManager;
&nbsp;import org.springframework.cache.annotation.EnableCaching;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.core.convert.converter.ConverterRegistry;
&nbsp;import org.springframework.data.redis.cache.RedisCacheConfiguration;
&nbsp;import org.springframework.data.redis.cache.RedisCacheManager;
&nbsp;import org.springframework.data.redis.connection.RedisConnectionFactory;
&nbsp;import org.springframework.data.redis.connection.RedisNode;
&nbsp;import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;
&nbsp;import org.springframework.data.redis.core.RedisTemplate;
&nbsp;import org.springframework.format.support.DefaultFormattingConversionService;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.thingsboard.common.util.SslUtil;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import redis.clients.jedis.JedisPoolConfig;
&nbsp;
&nbsp;import javax.net.ssl.KeyManagerFactory;
&nbsp;import javax.net.ssl.SSLContext;
&nbsp;import javax.net.ssl.SSLSocketFactory;
&nbsp;import javax.net.ssl.TrustManagerFactory;
&nbsp;import java.io.IOException;
&nbsp;import java.security.KeyStore;
&nbsp;import java.security.KeyStoreException;
&nbsp;import java.security.NoSuchAlgorithmException;
&nbsp;import java.security.PrivateKey;
&nbsp;import java.security.cert.CertPath;
&nbsp;import java.security.cert.Certificate;
&nbsp;import java.security.cert.CertificateException;
&nbsp;import java.security.cert.CertificateFactory;
&nbsp;import java.security.cert.X509Certificate;
&nbsp;import java.time.Duration;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@Configuration
&nbsp;@ConditionalOnProperty(prefix = &quot;cache&quot;, value = &quot;type&quot;, havingValue = &quot;redis&quot;)
&nbsp;@EnableCaching
&nbsp;@Data
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public abstract class TBRedisCacheConfiguration {
&nbsp;
&nbsp;    private static final String COMMA = &quot;,&quot;;
&nbsp;    private static final String COLON = &quot;:&quot;;
&nbsp;
&nbsp;    @Value(&quot;${redis.evictTtlInMs:60000}&quot;)
&nbsp;    private int evictTtlInMs;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.maxTotal:128}&quot;)
&nbsp;    private int maxTotal;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.maxIdle:128}&quot;)
&nbsp;    private int maxIdle;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.minIdle:16}&quot;)
&nbsp;    private int minIdle;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.testOnBorrow:false}&quot;)
&nbsp;    private boolean testOnBorrow;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.testOnReturn:false}&quot;)
&nbsp;    private boolean testOnReturn;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.testWhileIdle:true}&quot;)
&nbsp;    private boolean testWhileIdle;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.minEvictableMs:60000}&quot;)
&nbsp;    private long minEvictableMs;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.evictionRunsMs:30000}&quot;)
&nbsp;    private long evictionRunsMs;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.maxWaitMills:60000}&quot;)
&nbsp;    private long maxWaitMills;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.numberTestsPerEvictionRun:3}&quot;)
&nbsp;    private int numberTestsPerEvictionRun;
&nbsp;
&nbsp;    @Value(&quot;${redis.pool_config.blockWhenExhausted:true}&quot;)
&nbsp;    private boolean blockWhenExhausted;
&nbsp;
&nbsp;    @Value(&quot;${redis.ssl.enabled:false}&quot;)
&nbsp;    private boolean sslEnabled;
&nbsp;
&nbsp;    @Bean
&nbsp;    public RedisConnectionFactory redisConnectionFactory() {
<b class="nc">&nbsp;        return loadFactory();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Autowired
&nbsp;    private RedisSslCredentials redisSslCredentials;
&nbsp;
&nbsp;    protected abstract JedisConnectionFactory loadFactory();
&nbsp;
&nbsp;    /**
&nbsp;     * Transaction aware RedisCacheManager.
&nbsp;     * Enable RedisCaches to synchronize cache put/evict operations with ongoing Spring-managed transactions.
&nbsp;     */
&nbsp;    @Bean
&nbsp;    public CacheManager cacheManager(RedisConnectionFactory cf) {
<b class="nc">&nbsp;        DefaultFormattingConversionService redisConversionService = new DefaultFormattingConversionService();</b>
<b class="nc">&nbsp;        RedisCacheConfiguration.registerDefaultConverters(redisConversionService);</b>
<b class="nc">&nbsp;        registerDefaultConverters(redisConversionService);</b>
<b class="nc">&nbsp;        RedisCacheConfiguration configuration = RedisCacheConfiguration.defaultCacheConfig().withConversionService(redisConversionService);</b>
<b class="nc">&nbsp;        return RedisCacheManager.builder(cf).cacheDefaults(configuration)</b>
<b class="nc">&nbsp;                .transactionAware()</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Bean
&nbsp;    public RedisTemplate&lt;String, Object&gt; redisTemplate() {
<b class="nc">&nbsp;        RedisTemplate&lt;String, Object&gt; template = new RedisTemplate&lt;&gt;();</b>
<b class="nc">&nbsp;        template.setConnectionFactory(redisConnectionFactory());</b>
<b class="nc">&nbsp;        return template;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void registerDefaultConverters(ConverterRegistry registry) {
<b class="nc">&nbsp;        Assert.notNull(registry, &quot;ConverterRegistry must not be null!&quot;);</b>
<b class="nc">&nbsp;        registry.addConverter(EntityId.class, String.class, EntityId::toString);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected JedisPoolConfig buildPoolConfig() {
<b class="nc">&nbsp;        final JedisPoolConfig poolConfig = new JedisPoolConfig();</b>
<b class="nc">&nbsp;        poolConfig.setMaxTotal(maxTotal);</b>
<b class="nc">&nbsp;        poolConfig.setMaxIdle(maxIdle);</b>
<b class="nc">&nbsp;        poolConfig.setMinIdle(minIdle);</b>
<b class="nc">&nbsp;        poolConfig.setTestOnBorrow(testOnBorrow);</b>
<b class="nc">&nbsp;        poolConfig.setTestOnReturn(testOnReturn);</b>
<b class="nc">&nbsp;        poolConfig.setTestWhileIdle(testWhileIdle);</b>
<b class="nc">&nbsp;        poolConfig.setSoftMinEvictableIdleTime(Duration.ofMillis(minEvictableMs));</b>
<b class="nc">&nbsp;        poolConfig.setTimeBetweenEvictionRuns(Duration.ofMillis(evictionRunsMs));</b>
<b class="nc">&nbsp;        poolConfig.setMaxWaitMillis(maxWaitMills);</b>
<b class="nc">&nbsp;        poolConfig.setNumTestsPerEvictionRun(numberTestsPerEvictionRun);</b>
<b class="nc">&nbsp;        poolConfig.setBlockWhenExhausted(blockWhenExhausted);</b>
<b class="nc">&nbsp;        return poolConfig;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected List&lt;RedisNode&gt; getNodes(String nodes) {
&nbsp;        List&lt;RedisNode&gt; result;
<b class="nc">&nbsp;        if (StringUtils.isBlank(nodes)) {</b>
<b class="nc">&nbsp;            result = Collections.emptyList();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (String hostPort : nodes.split(COMMA)) {</b>
<b class="nc">&nbsp;                String host = hostPort.split(COLON)[0];</b>
<b class="nc">&nbsp;                int port = Integer.parseInt(hostPort.split(COLON)[1]);</b>
<b class="nc">&nbsp;                result.add(new RedisNode(host, port));</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected SSLSocketFactory createSslSocketFactory() {
&nbsp;        try {
<b class="nc">&nbsp;            SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);</b>
<b class="nc">&nbsp;            KeyManagerFactory keyManagerFactory = createAndInitKeyManagerFactory();</b>
<b class="nc">&nbsp;            TrustManagerFactory trustManagerFactory = createAndInitTrustManagerFactory();</b>
<b class="nc">&nbsp;            sslContext.init(keyManagerFactory == null ? null : keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), null);</b>
<b class="nc">&nbsp;            return sslContext.getSocketFactory();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Creating TLS factory failed!&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TrustManagerFactory createAndInitTrustManagerFactory() throws Exception {
<b class="nc">&nbsp;            List&lt;X509Certificate&gt; caCerts = SslUtil.readCertFileByPath(redisSslCredentials.getCertFile());</b>
<b class="nc">&nbsp;            KeyStore caKeyStore = KeyStore.getInstance(KeyStore.getDefaultType());</b>
<b class="nc">&nbsp;            caKeyStore.load(null, null);</b>
<b class="nc">&nbsp;            for (X509Certificate caCert : caCerts) {</b>
<b class="nc">&nbsp;                caKeyStore.setCertificateEntry(&quot;redis-caCert-cert-&quot; + caCert.getSubjectX500Principal().getName(), caCert);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</b>
<b class="nc">&nbsp;            trustManagerFactory.init(caKeyStore);</b>
<b class="nc">&nbsp;            return trustManagerFactory;</b>
&nbsp;    }
&nbsp;
&nbsp;    private KeyManagerFactory createAndInitKeyManagerFactory() throws Exception {
<b class="nc">&nbsp;        KeyManagerFactory kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</b>
<b class="nc">&nbsp;        kmf.init(loadKeyStore(), null);</b>
<b class="nc">&nbsp;        return kmf;</b>
&nbsp;    }
&nbsp;
&nbsp;    private KeyStore loadKeyStore() throws KeyStoreException, IOException, NoSuchAlgorithmException, CertificateException {
<b class="nc">&nbsp;        if (redisSslCredentials.getUserCertFile().isBlank() || redisSslCredentials.getUserKeyFile().isBlank()) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        List&lt;X509Certificate&gt; certificates = SslUtil.readCertFileByPath(redisSslCredentials.getCertFile());</b>
<b class="nc">&nbsp;        PrivateKey privateKey = SslUtil.readPrivateKeyByFilePath(redisSslCredentials.getUserKeyFile(), null);</b>
&nbsp;
<b class="nc">&nbsp;        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</b>
<b class="nc">&nbsp;        keyStore.load(null);</b>
<b class="nc">&nbsp;        List&lt;X509Certificate&gt; unique = certificates.stream().distinct().toList();</b>
<b class="nc">&nbsp;        for (X509Certificate cert : unique) {</b>
<b class="nc">&nbsp;            keyStore.setCertificateEntry(&quot;redis-cert&quot; + cert.getSubjectX500Principal().getName(), cert);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (privateKey != null) {</b>
<b class="nc">&nbsp;            CertificateFactory factory = CertificateFactory.getInstance(&quot;X.509&quot;);</b>
<b class="nc">&nbsp;            CertPath certPath = factory.generateCertPath(certificates);</b>
<b class="nc">&nbsp;            List&lt;? extends Certificate&gt; path = certPath.getCertificates();</b>
<b class="nc">&nbsp;            Certificate[] x509Certificates = path.toArray(new Certificate[0]);</b>
<b class="nc">&nbsp;            keyStore.setKeyEntry(&quot;redis-private-key&quot;, privateKey, null, x509Certificates);</b>
&nbsp;        }
<b class="nc">&nbsp;        return keyStore;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

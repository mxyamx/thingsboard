<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > UserServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.user</a>
</div>

<h1>Coverage Summary for Class: UserServiceImpl (org.thingsboard.server.dao.user)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UserServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/279)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UserServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserServiceImpl$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserServiceImpl$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserServiceImpl$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UserServiceImpl$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/290)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.user;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.type.TypeReference;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.ApplicationEventPublisher;
&nbsp;import org.springframework.security.authentication.DisabledException;
&nbsp;import org.springframework.security.core.userdetails.UsernameNotFoundException;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.cache.user.UserCacheEvictEvent;
&nbsp;import org.thingsboard.server.cache.user.UserCacheKey;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.UserAuthDetails;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.TenantProfileId;
&nbsp;import org.thingsboard.server.common.data.id.UserCredentialsId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.mobile.MobileSessionInfo;
&nbsp;import org.thingsboard.server.common.data.mobile.UserMobileSessionInfo;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.CustomerUsersFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.SystemLevelUsersFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.TenantAdministratorsFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.UserListFilter;
&nbsp;import org.thingsboard.server.common.data.notification.targets.platform.UsersFilter;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.security.Authority;
&nbsp;import org.thingsboard.server.common.data.security.UserCredentials;
&nbsp;import org.thingsboard.server.common.data.security.event.UserCredentialsInvalidationEvent;
&nbsp;import org.thingsboard.server.common.data.settings.UserSettings;
&nbsp;import org.thingsboard.server.common.data.settings.UserSettingsType;
&nbsp;import org.thingsboard.server.dao.entity.AbstractCachedEntityService;
&nbsp;import org.thingsboard.server.dao.entity.EntityCountService;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionCause;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.dao.exception.IncorrectParameterException;
&nbsp;import org.thingsboard.server.dao.pat.ApiKeyService;
&nbsp;import org.thingsboard.server.dao.service.DataValidator;
&nbsp;import org.thingsboard.server.dao.service.PaginatedRemover;
&nbsp;import org.thingsboard.server.dao.settings.SecuritySettingsService;
&nbsp;import org.thingsboard.server.dao.sql.JpaExecutorService;
&nbsp;import org.thingsboard.server.dao.tenant.TbTenantProfileCache;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.generateSafeToken;
&nbsp;import static org.thingsboard.server.dao.DaoUtil.toUUIDs;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validatePageLink;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateString;
&nbsp;
&nbsp;@Service(&quot;UserDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class UserServiceImpl extends AbstractCachedEntityService&lt;UserCacheKey, User, UserCacheEvictEvent&gt; implements UserService {
&nbsp;
&nbsp;    public static final String USER_PASSWORD_HISTORY = &quot;userPasswordHistory&quot;;
&nbsp;
&nbsp;    public static final int DEFAULT_TOKEN_LENGTH = 30;
&nbsp;    public static final String INCORRECT_USER_ID = &quot;Incorrect userId &quot;;
&nbsp;    public static final String INCORRECT_USER_CREDENTIALS_ID = &quot;Incorrect userCredentialsId &quot;;
&nbsp;    public static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;
&nbsp;    @Value(&quot;${security.user_login_case_sensitive:true}&quot;)
&nbsp;    private boolean userLoginCaseSensitive;
&nbsp;
&nbsp;    private final UserDao userDao;
&nbsp;    private final UserCredentialsDao userCredentialsDao;
&nbsp;    private final UserAuthSettingsDao userAuthSettingsDao;
&nbsp;    private final UserSettingsService userSettingsService;
&nbsp;    private final UserSettingsDao userSettingsDao;
&nbsp;    private final ApiKeyService apiKeyService;
&nbsp;    private final SecuritySettingsService securitySettingsService;
&nbsp;    private final TbTenantProfileCache tenantProfileCache;
&nbsp;    private final DataValidator&lt;User&gt; userValidator;
&nbsp;    private final DataValidator&lt;UserCredentials&gt; userCredentialsValidator;
&nbsp;    private final ApplicationEventPublisher eventPublisher;
&nbsp;    private final EntityCountService countService;
&nbsp;    private final JpaExecutorService executor;
&nbsp;
&nbsp;    @Override
&nbsp;    @TransactionalEventListener
&nbsp;    public void handleEvictEvent(UserCacheEvictEvent event) {
<b class="nc">&nbsp;        List&lt;UserCacheKey&gt; keys = new ArrayList&lt;&gt;(2);</b>
<b class="nc">&nbsp;        keys.add(new UserCacheKey(event.tenantId(), event.newEmail()));</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.oldEmail()) &amp;&amp; !event.oldEmail().equals(event.newEmail())) {</b>
<b class="nc">&nbsp;            keys.add(new UserCacheKey(event.tenantId(), event.oldEmail()));</b>
&nbsp;        }
<b class="nc">&nbsp;        cache.evict(keys);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public User findUserByEmail(TenantId tenantId, String email) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserByEmail [{}]&quot;, email);</b>
<b class="nc">&nbsp;        validateString(email, e -&gt; &quot;Incorrect email &quot; + e);</b>
<b class="nc">&nbsp;        if (userLoginCaseSensitive) {</b>
<b class="nc">&nbsp;            return userDao.findByEmail(tenantId, email);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return userDao.findByEmail(tenantId, email.toLowerCase());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public User findUserByTenantIdAndEmail(TenantId tenantId, String email) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserByTenantIdAndEmail [{}][{}]&quot;, tenantId, email);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateString(email, e -&gt; &quot;Incorrect email &quot; + e);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(new UserCacheKey(tenantId, email),</b>
<b class="nc">&nbsp;                () -&gt; userDao.findByTenantIdAndEmail(tenantId, email), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;User&gt; findUserByTenantIdAndEmailAsync(TenantId tenantId, String email) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserByTenantIdAndEmailAsync [{}][{}]&quot;, tenantId, email);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateString(email, e -&gt; &quot;Incorrect email &quot; + e);</b>
<b class="nc">&nbsp;        return executor.submit(() -&gt; findUserByTenantIdAndEmail(tenantId, email));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public User findUserById(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserById [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        return userDao.findById(tenantId, userId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;User&gt; findUserByIdAsync(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserByIdAsync [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        return userDao.findByIdAsync(tenantId, userId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public User saveUser(TenantId tenantId, User user) {
<b class="nc">&nbsp;        return saveUser(tenantId, user, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public User saveUser(TenantId tenantId, User user, boolean doValidate) {
<b class="nc">&nbsp;        return saveEntity(user, () -&gt; doSaveUser(tenantId, user, doValidate));</b>
&nbsp;    }
&nbsp;
&nbsp;    private User doSaveUser(TenantId tenantId, User user, boolean doValidate) {
<b class="nc">&nbsp;        log.trace(&quot;Executing saveUser [{}]&quot;, user);</b>
<b class="nc">&nbsp;        User oldUser = null;</b>
<b class="nc">&nbsp;        if (doValidate) {</b>
<b class="nc">&nbsp;            oldUser = userValidator.validate(user, User::getTenantId);</b>
<b class="nc">&nbsp;        } else if (user.getId() != null) {</b>
<b class="nc">&nbsp;            oldUser = findUserById(user.getTenantId(), user.getId());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!userLoginCaseSensitive) {</b>
<b class="nc">&nbsp;            user.setEmail(user.getEmail().toLowerCase());</b>
&nbsp;        }
<b class="nc">&nbsp;        var evictEvent = new UserCacheEvictEvent(user.getTenantId(), user.getEmail(), oldUser != null ? oldUser.getEmail() : null);</b>
&nbsp;        User savedUser;
&nbsp;        try {
<b class="nc">&nbsp;            savedUser = userDao.saveAndFlush(user.getTenantId(), user);</b>
<b class="nc">&nbsp;            publishEvictEvent(evictEvent);</b>
<b class="nc">&nbsp;            if (user.getId() == null) {</b>
<b class="nc">&nbsp;                countService.publishCountEntityEvictEvent(savedUser.getTenantId(), EntityType.USER);</b>
<b class="nc">&nbsp;                UserCredentials userCredentials = new UserCredentials();</b>
<b class="nc">&nbsp;                userCredentials.setEnabled(false);</b>
<b class="nc">&nbsp;                userCredentials.setUserId(new UserId(savedUser.getUuidId()));</b>
<b class="nc">&nbsp;                userCredentials.setAdditionalInfo(JacksonUtil.newObjectNode());</b>
<b class="nc">&nbsp;                userCredentials = generateUserActivationToken(userCredentials);</b>
<b class="nc">&nbsp;                userCredentialsDao.save(user.getTenantId(), userCredentials);</b>
&nbsp;            }
<b class="nc">&nbsp;            eventPublisher.publishEvent(SaveEntityEvent.builder()</b>
<b class="nc">&nbsp;                    .tenantId(savedUser.getTenantId())</b>
<b class="nc">&nbsp;                    .entity(savedUser)</b>
<b class="nc">&nbsp;                    .oldEntity(oldUser)</b>
<b class="nc">&nbsp;                    .entityId(savedUser.getId())</b>
<b class="nc">&nbsp;                    .created(user.getId() == null).build());</b>
&nbsp;        } catch (Exception t) {
<b class="nc">&nbsp;            handleEvictEvent(evictEvent);</b>
<b class="nc">&nbsp;            checkConstraintViolation(t, &quot;tb_user_email_key&quot;, &quot;User with email &#39;&quot; + user.getEmail() + &quot;&#39; already present in database!&quot;);</b>
&nbsp;            throw t;
&nbsp;        }
<b class="nc">&nbsp;        return savedUser;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials findUserCredentialsByUserId(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserCredentialsByUserId [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        return userCredentialsDao.findByUserId(tenantId, userId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials findUserCredentialsByActivateToken(TenantId tenantId, String activateToken) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserCredentialsByActivateToken [{}]&quot;, activateToken);</b>
<b class="nc">&nbsp;        validateString(activateToken, t -&gt; &quot;Incorrect activateToken &quot; + t);</b>
<b class="nc">&nbsp;        return userCredentialsDao.findByActivateToken(tenantId, activateToken);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials findUserCredentialsByResetToken(TenantId tenantId, String resetToken) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserCredentialsByResetToken [{}]&quot;, resetToken);</b>
<b class="nc">&nbsp;        validateString(resetToken, t -&gt; &quot;Incorrect resetToken &quot; + t);</b>
<b class="nc">&nbsp;        return userCredentialsDao.findByResetToken(tenantId, resetToken);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials saveUserCredentials(TenantId tenantId, UserCredentials userCredentials) {
<b class="nc">&nbsp;        return saveUserCredentials(tenantId, userCredentials, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials saveUserCredentials(TenantId tenantId, UserCredentials userCredentials, boolean doValidate) {
<b class="nc">&nbsp;        log.trace(&quot;Executing saveUserCredentials [{}]&quot;, userCredentials);</b>
<b class="nc">&nbsp;        if (doValidate) {</b>
<b class="nc">&nbsp;            userCredentialsValidator.validate(userCredentials, data -&gt; tenantId);</b>
&nbsp;        }
<b class="nc">&nbsp;        UserCredentials result = userCredentialsDao.save(tenantId, userCredentials);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder()</b>
<b class="nc">&nbsp;                .tenantId(tenantId)</b>
<b class="nc">&nbsp;                .entityId(userCredentials.getUserId())</b>
<b class="nc">&nbsp;                .actionType(ActionType.CREDENTIALS_UPDATED).build());</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials activateUserCredentials(TenantId tenantId, String activateToken, String password) {
<b class="nc">&nbsp;        log.trace(&quot;Executing activateUserCredentials activateToken [{}], password [{}]&quot;, activateToken, password);</b>
<b class="nc">&nbsp;        validateString(activateToken, t -&gt; &quot;Incorrect activateToken &quot; + t);</b>
<b class="nc">&nbsp;        validateString(password, p -&gt; &quot;Incorrect password &quot; + p);</b>
<b class="nc">&nbsp;        UserCredentials userCredentials = userCredentialsDao.findByActivateToken(tenantId, activateToken);</b>
<b class="nc">&nbsp;        if (userCredentials == null) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(String.format(&quot;Unable to find user credentials by activateToken [%s]&quot;, activateToken));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (userCredentials.isEnabled()) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;User credentials already activated&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (userCredentials.isActivationTokenExpired()) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;Activation token expired&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        userCredentials.setEnabled(true);</b>
<b class="nc">&nbsp;        userCredentials.setActivateToken(null);</b>
<b class="nc">&nbsp;        userCredentials.setActivateTokenExpTime(null);</b>
<b class="nc">&nbsp;        userCredentials.setPassword(password);</b>
<b class="nc">&nbsp;        if (userCredentials.getPassword() != null) {</b>
<b class="nc">&nbsp;            updatePasswordHistory(userCredentials);</b>
&nbsp;        }
<b class="nc">&nbsp;        return saveUserCredentials(tenantId, userCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials requestPasswordReset(TenantId tenantId, String email) {
<b class="nc">&nbsp;        log.trace(&quot;Executing requestPasswordReset email [{}]&quot;, email);</b>
<b class="nc">&nbsp;        DataValidator.validateEmail(email);</b>
<b class="nc">&nbsp;        User user = findUserByEmail(tenantId, email);</b>
<b class="nc">&nbsp;        if (user == null) {</b>
<b class="nc">&nbsp;            throw new UsernameNotFoundException(String.format(&quot;Unable to find user by email [%s]&quot;, email));</b>
&nbsp;        }
<b class="nc">&nbsp;        UserCredentials userCredentials = userCredentialsDao.findByUserId(tenantId, user.getUuidId());</b>
<b class="nc">&nbsp;        if (!userCredentials.isEnabled()) {</b>
<b class="nc">&nbsp;            throw new DisabledException(String.format(&quot;User credentials not enabled [%s]&quot;, email));</b>
&nbsp;        }
<b class="nc">&nbsp;        userCredentials = generatePasswordResetToken(userCredentials);</b>
<b class="nc">&nbsp;        return saveUserCredentials(tenantId, userCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials requestExpiredPasswordReset(TenantId tenantId, UserCredentialsId userCredentialsId) {
<b class="nc">&nbsp;        UserCredentials userCredentials = userCredentialsDao.findById(tenantId, userCredentialsId.getId());</b>
<b class="nc">&nbsp;        if (!userCredentials.isEnabled()) {</b>
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;Unable to reset password for inactive user&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        userCredentials = generatePasswordResetToken(userCredentials);</b>
<b class="nc">&nbsp;        return saveUserCredentials(tenantId, userCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials generatePasswordResetToken(UserCredentials userCredentials) {
<b class="nc">&nbsp;        userCredentials.setResetToken(generateSafeToken(DEFAULT_TOKEN_LENGTH));</b>
<b class="nc">&nbsp;        int ttlHours = securitySettingsService.getSecuritySettings().getPasswordResetTokenTtl();</b>
<b class="nc">&nbsp;        userCredentials.setResetTokenExpTime(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(ttlHours));</b>
<b class="nc">&nbsp;        return userCredentials;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials generateUserActivationToken(UserCredentials userCredentials) {
<b class="nc">&nbsp;        userCredentials.setActivateToken(generateSafeToken(DEFAULT_TOKEN_LENGTH));</b>
<b class="nc">&nbsp;        int ttlHours = securitySettingsService.getSecuritySettings().getUserActivationTokenTtl();</b>
<b class="nc">&nbsp;        userCredentials.setActivateTokenExpTime(System.currentTimeMillis() + TimeUnit.HOURS.toMillis(ttlHours));</b>
<b class="nc">&nbsp;        return userCredentials;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials checkUserActivationToken(TenantId tenantId, UserCredentials userCredentials) {
<b class="nc">&nbsp;        if (userCredentials.getActivationTokenTtl() &lt; TimeUnit.MINUTES.toMillis(15)) { // renew a link if less than 15 minutes before expiration</b>
<b class="nc">&nbsp;            userCredentials = generateUserActivationToken(userCredentials);</b>
<b class="nc">&nbsp;            userCredentials = saveUserCredentials(tenantId, userCredentials);</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}][{}] Regenerated expired user activation token&quot;, tenantId, userCredentials.getUserId());</b>
&nbsp;        }
<b class="nc">&nbsp;        return userCredentials;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserCredentials replaceUserCredentials(TenantId tenantId, UserCredentials userCredentials) {
<b class="nc">&nbsp;        log.trace(&quot;Executing replaceUserCredentials [{}]&quot;, userCredentials);</b>
<b class="nc">&nbsp;        userCredentialsValidator.validate(userCredentials, data -&gt; tenantId);</b>
<b class="nc">&nbsp;        userCredentialsDao.removeById(tenantId, userCredentials.getUuidId());</b>
<b class="nc">&nbsp;        userCredentials.setId(null);</b>
<b class="nc">&nbsp;        if (userCredentials.getPassword() != null) {</b>
<b class="nc">&nbsp;            updatePasswordHistory(userCredentials);</b>
&nbsp;        }
<b class="nc">&nbsp;        UserCredentials result = userCredentialsDao.save(tenantId, userCredentials);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder()</b>
<b class="nc">&nbsp;                .tenantId(tenantId)</b>
<b class="nc">&nbsp;                .entityId(userCredentials.getUserId())</b>
<b class="nc">&nbsp;                .actionType(ActionType.CREDENTIALS_UPDATED).build());</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteUserCredentials(TenantId tenantId, UserCredentials userCredentials) {
<b class="nc">&nbsp;        Objects.requireNonNull(userCredentials, &quot;UserCredentials is null&quot;);</b>
<b class="nc">&nbsp;        UserCredentialsId userCredentialsId = userCredentials.getId();</b>
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing deleteUserCredentials [{}]&quot;, tenantId, userCredentialsId);</b>
<b class="nc">&nbsp;        validateId(userCredentialsId, id -&gt; INCORRECT_USER_CREDENTIALS_ID + id);</b>
<b class="nc">&nbsp;        userCredentialsDao.removeById(tenantId, userCredentialsId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteUser(TenantId tenantId, User user) {
<b class="nc">&nbsp;        deleteUser(tenantId, user, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void deleteUser(TenantId tenantId, User user, ActionCause cause) {
<b class="nc">&nbsp;        Objects.requireNonNull(user, &quot;User is null&quot;);</b>
<b class="nc">&nbsp;        UserId userId = user.getId();</b>
<b class="nc">&nbsp;        log.trace(&quot;[{}] Executing deleteUser [{}]&quot;, tenantId, userId);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        userCredentialsDao.removeByUserId(tenantId, userId);</b>
<b class="nc">&nbsp;        userAuthSettingsDao.removeByUserId(userId);</b>
<b class="nc">&nbsp;        apiKeyService.deleteByUserId(tenantId, userId);</b>
<b class="nc">&nbsp;        publishEvictEvent(new UserCacheEvictEvent(user.getTenantId(), user.getEmail(), null));</b>
<b class="nc">&nbsp;        userSettingsDao.removeByUserId(tenantId, userId);</b>
<b class="nc">&nbsp;        userDao.removeById(tenantId, userId.getId());</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(new UserCredentialsInvalidationEvent(userId));</b>
<b class="nc">&nbsp;        countService.publishCountEntityEvictEvent(tenantId, EntityType.USER);</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(DeleteEntityEvent.builder()</b>
<b class="nc">&nbsp;                .tenantId(user.getTenantId())</b>
<b class="nc">&nbsp;                .entityId(userId)</b>
<b class="nc">&nbsp;                .entity(user)</b>
<b class="nc">&nbsp;                .cause(cause)</b>
<b class="nc">&nbsp;                .build());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findUsersByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUsersByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return userDao.findByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findTenantAdmins(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findTenantAdmins, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return userDao.findTenantAdmins(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findSysAdmins(PageLink pageLink) {
<b class="nc">&nbsp;        return userDao.findAllByAuthority(Authority.SYS_ADMIN, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findAllTenantAdmins(PageLink pageLink) {
<b class="nc">&nbsp;        return userDao.findAllByAuthority(Authority.TENANT_ADMIN, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findTenantAdminsByTenantsIds(List&lt;TenantId&gt; tenantsIds, PageLink pageLink) {
<b class="nc">&nbsp;        return userDao.findByAuthorityAndTenantsIds(Authority.TENANT_ADMIN, tenantsIds, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findTenantAdminsByTenantProfilesIds(List&lt;TenantProfileId&gt; tenantProfilesIds, PageLink pageLink) {
<b class="nc">&nbsp;        return userDao.findByAuthorityAndTenantProfilesIds(Authority.TENANT_ADMIN, tenantProfilesIds, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findAllUsers(PageLink pageLink) {
<b class="nc">&nbsp;        return userDao.findAll(pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteTenantAdmins(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteTenantAdmins, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        tenantAdminsRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteAllByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        usersRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        deleteAllByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findCustomerUsers(TenantId tenantId, CustomerId customerId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findCustomerUsers, tenantId [{}], customerId [{}], pageLink [{}]&quot;, tenantId, customerId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; &quot;Incorrect customerId &quot; + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return userDao.findCustomerUsers(tenantId.getId(), customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findUsersByCustomerIds(TenantId tenantId, List&lt;CustomerId&gt; customerIds, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findTenantAndCustomerUsers, tenantId [{}], customerIds [{}], pageLink [{}]&quot;, tenantId, customerIds, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        customerIds.forEach(customerId -&gt; validateId(customerId, id -&gt; &quot;Incorrect customerId &quot; + id));</b>
<b class="nc">&nbsp;        return userDao.findUsersByCustomerIds(tenantId.getId(), customerIds, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteCustomerUsers(TenantId tenantId, CustomerId customerId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteCustomerUsers, customerId [{}]&quot;, customerId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; &quot;Incorrect customerId &quot; + id);</b>
<b class="nc">&nbsp;        customerUsersRemover.removeEntities(tenantId, customerId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional
&nbsp;    @Override
&nbsp;    public void setUserCredentialsEnabled(TenantId tenantId, UserId userId, boolean enabled) {
<b class="nc">&nbsp;        log.trace(&quot;Executing setUserCredentialsEnabled [{}], [{}]&quot;, userId, enabled);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        UserCredentials userCredentials = userCredentialsDao.findByUserId(tenantId, userId.getId());</b>
<b class="nc">&nbsp;        userCredentials.setEnabled(enabled);</b>
<b class="nc">&nbsp;        if (enabled) {</b>
<b class="nc">&nbsp;            userCredentials.setFailedLoginAttempts(0);</b>
&nbsp;        }
<b class="nc">&nbsp;        saveUserCredentials(tenantId, userCredentials);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void resetFailedLoginAttempts(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing resetFailedLoginAttempts [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        userCredentialsDao.setFailedLoginAttempts(tenantId, userId, 0);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateLastLoginTs(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        userCredentialsDao.setLastLoginTs(tenantId, userId, System.currentTimeMillis());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void saveMobileSession(TenantId tenantId, UserId userId, String mobileToken, MobileSessionInfo sessionInfo) {
<b class="nc">&nbsp;        removeMobileSession(tenantId, mobileToken); // unassigning fcm token from other users, in case we didn&#39;t clean up it on log out or mobile app uninstall</b>
&nbsp;
<b class="nc">&nbsp;        UserMobileSessionInfo mobileInfo = findMobileSessionInfo(tenantId, userId).orElseGet(() -&gt; {</b>
<b class="nc">&nbsp;            UserMobileSessionInfo newMobileInfo = new UserMobileSessionInfo();</b>
<b class="nc">&nbsp;            newMobileInfo.setSessions(new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;            return newMobileInfo;</b>
&nbsp;        });
<b class="nc">&nbsp;        mobileInfo.getSessions().put(mobileToken, sessionInfo);</b>
<b class="nc">&nbsp;        userSettingsService.updateUserSettings(tenantId, userId, UserSettingsType.MOBILE, JacksonUtil.valueToTree(mobileInfo));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;String, MobileSessionInfo&gt; findMobileSessions(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        return findMobileSessionInfo(tenantId, userId).map(UserMobileSessionInfo::getSessions).orElse(Collections.emptyMap());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public MobileSessionInfo findMobileSession(TenantId tenantId, UserId userId, String mobileToken) {
<b class="nc">&nbsp;        return findMobileSessionInfo(tenantId, userId).map(mobileInfo -&gt; mobileInfo.getSessions().get(mobileToken)).orElse(null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void removeMobileSession(TenantId tenantId, String mobileToken) {
<b class="nc">&nbsp;        for (UserSettings userSettings : userSettingsDao.findByTypeAndPath(tenantId, UserSettingsType.MOBILE, &quot;sessions&quot;, mobileToken)) {</b>
<b class="nc">&nbsp;            ((ObjectNode) userSettings.getSettings().get(&quot;sessions&quot;)).remove(mobileToken);</b>
<b class="nc">&nbsp;            userSettingsService.saveUserSettings(tenantId, userSettings);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int countTenantAdmins(TenantId tenantId) {
<b class="nc">&nbsp;        return userDao.countTenantAdmins(tenantId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public UserAuthDetails findUserAuthDetailsByUserId(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUserAuthDetailsByUserId [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        validateId(userId, id -&gt; INCORRECT_USER_ID + id);</b>
<b class="nc">&nbsp;        return userDao.findUserAuthDetailsByUserId(tenantId.getId(), userId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;User&gt; findUsersByTenantIdAndIds(TenantId tenantId, List&lt;UserId&gt; userIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findUsersByTenantIdAndIds, tenantId [{}], userIds [{}]&quot;, tenantId, userIds);</b>
<b class="nc">&nbsp;        return userDao.findUsersByTenantIdAndIds(tenantId.getId(), toUUIDs(userIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    private Optional&lt;UserMobileSessionInfo&gt; findMobileSessionInfo(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        return Optional.ofNullable(userSettingsService.findUserSettings(tenantId, userId, UserSettingsType.MOBILE))</b>
<b class="nc">&nbsp;                .map(UserSettings::getSettings).map(settings -&gt; JacksonUtil.treeToValue(settings, UserMobileSessionInfo.class));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int increaseFailedLoginAttempts(TenantId tenantId, UserId userId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing increaseFailedLoginAttempts [{}]&quot;, userId);</b>
<b class="nc">&nbsp;        return userCredentialsDao.incrementFailedLoginAttempts(tenantId, userId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;User&gt; findUsersByFilter(TenantId tenantId, UsersFilter filter, PageLink pageLink) {
<b class="nc">&nbsp;        switch (filter.getType()) {</b>
&nbsp;            case USER_LIST -&gt; {
<b class="nc">&nbsp;                List&lt;User&gt; users = ((UserListFilter) filter).getUsersIds().stream()</b>
<b class="nc">&nbsp;                        .limit(pageLink.getPageSize())</b>
<b class="nc">&nbsp;                        .map(UserId::new).map(userId -&gt; findUserById(tenantId, userId))</b>
<b class="nc">&nbsp;                        .filter(Objects::nonNull).collect(Collectors.toList());</b>
<b class="nc">&nbsp;                return new PageData&lt;&gt;(users, 1, users.size(), false);</b>
&nbsp;            }
&nbsp;            case CUSTOMER_USERS -&gt; {
<b class="nc">&nbsp;                if (tenantId.equals(TenantId.SYS_TENANT_ID)) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(&quot;Customer users target is not supported for system administrator&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                CustomerUsersFilter customerUsersFilter = (CustomerUsersFilter) filter;</b>
<b class="nc">&nbsp;                return findCustomerUsers(tenantId, new CustomerId(customerUsersFilter.getCustomerId()), pageLink);</b>
&nbsp;            }
&nbsp;            case TENANT_ADMINISTRATORS -&gt; {
<b class="nc">&nbsp;                TenantAdministratorsFilter tenantAdministratorsFilter = (TenantAdministratorsFilter) filter;</b>
<b class="nc">&nbsp;                if (!tenantId.equals(TenantId.SYS_TENANT_ID)) {</b>
<b class="nc">&nbsp;                    return findTenantAdmins(tenantId, pageLink);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    if (isNotEmpty(tenantAdministratorsFilter.getTenantsIds())) {</b>
<b class="nc">&nbsp;                        return findTenantAdminsByTenantsIds(tenantAdministratorsFilter.getTenantsIds().stream()</b>
<b class="nc">&nbsp;                                .map(TenantId::fromUUID).collect(Collectors.toList()), pageLink);</b>
<b class="nc">&nbsp;                    } else if (isNotEmpty(tenantAdministratorsFilter.getTenantProfilesIds())) {</b>
<b class="nc">&nbsp;                        return findTenantAdminsByTenantProfilesIds(tenantAdministratorsFilter.getTenantProfilesIds().stream()</b>
<b class="nc">&nbsp;                                .map(TenantProfileId::new).collect(Collectors.toList()), pageLink);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        return findAllTenantAdmins(pageLink);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;            case SYSTEM_ADMINISTRATORS -&gt; {
<b class="nc">&nbsp;                return findSysAdmins(pageLink);</b>
&nbsp;            }
&nbsp;            case ALL_USERS -&gt; {
<b class="nc">&nbsp;                if (!tenantId.equals(TenantId.SYS_TENANT_ID)) {</b>
<b class="nc">&nbsp;                    return findUsersByTenantId(tenantId, pageLink);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return findAllUsers(pageLink);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; throw new IllegalArgumentException(&quot;Recipient type not supported&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean matchesFilter(TenantId tenantId, SystemLevelUsersFilter filter, User user) {
<b class="nc">&nbsp;        switch (filter.getType()) {</b>
&nbsp;            case TENANT_ADMINISTRATORS -&gt; {
<b class="nc">&nbsp;                if (user.isSystemAdmin() || user.isCustomerUser()) {</b>
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
<b class="nc">&nbsp;                TenantAdministratorsFilter tenantAdministratorsFilter = (TenantAdministratorsFilter) filter;</b>
<b class="nc">&nbsp;                if (isNotEmpty(tenantAdministratorsFilter.getTenantsIds())) {</b>
<b class="nc">&nbsp;                    return tenantAdministratorsFilter.getTenantsIds().contains(user.getTenantId().getId());</b>
<b class="nc">&nbsp;                } else if (isNotEmpty(tenantAdministratorsFilter.getTenantProfilesIds())) {</b>
<b class="nc">&nbsp;                    return tenantAdministratorsFilter.getTenantProfilesIds().contains(tenantProfileCache.get(user.getTenantId()).getUuidId());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return user.getAuthority() == Authority.TENANT_ADMIN;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            case SYSTEM_ADMINISTRATORS -&gt; {
<b class="nc">&nbsp;                return user.getAuthority() == Authority.SYS_ADMIN;</b>
&nbsp;            }
&nbsp;            case ALL_USERS -&gt; {
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
<b class="nc">&nbsp;            default -&gt; throw new IllegalArgumentException(&quot;Recipient type not supported&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void updatePasswordHistory(UserCredentials userCredentials) {
<b class="nc">&nbsp;        JsonNode additionalInfo = userCredentials.getAdditionalInfo();</b>
<b class="nc">&nbsp;        if (!(additionalInfo instanceof ObjectNode)) {</b>
<b class="nc">&nbsp;            additionalInfo = JacksonUtil.newObjectNode();</b>
&nbsp;        }
<b class="nc">&nbsp;        Map&lt;String, String&gt; userPasswordHistoryMap = null;</b>
&nbsp;        JsonNode userPasswordHistoryJson;
<b class="nc">&nbsp;        if (additionalInfo.has(USER_PASSWORD_HISTORY)) {</b>
<b class="nc">&nbsp;            userPasswordHistoryJson = additionalInfo.get(USER_PASSWORD_HISTORY);</b>
<b class="nc">&nbsp;            userPasswordHistoryMap = JacksonUtil.convertValue(userPasswordHistoryJson, new TypeReference&lt;&gt;() {</b>
&nbsp;            });
&nbsp;        }
<b class="nc">&nbsp;        if (userPasswordHistoryMap != null) {</b>
<b class="nc">&nbsp;            userPasswordHistoryMap.put(Long.toString(System.currentTimeMillis()), userCredentials.getPassword());</b>
<b class="nc">&nbsp;            userPasswordHistoryJson = JacksonUtil.valueToTree(userPasswordHistoryMap);</b>
<b class="nc">&nbsp;            ((ObjectNode) additionalInfo).replace(USER_PASSWORD_HISTORY, userPasswordHistoryJson);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            userPasswordHistoryMap = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            userPasswordHistoryMap.put(Long.toString(System.currentTimeMillis()), userCredentials.getPassword());</b>
<b class="nc">&nbsp;            userPasswordHistoryJson = JacksonUtil.valueToTree(userPasswordHistoryMap);</b>
<b class="nc">&nbsp;            ((ObjectNode) additionalInfo).set(USER_PASSWORD_HISTORY, userPasswordHistoryJson);</b>
&nbsp;        }
<b class="nc">&nbsp;        userCredentials.setAdditionalInfo(additionalInfo);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;TenantId, User&gt; tenantAdminsRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        protected PageData&lt;User&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;            return userDao.findTenantAdmins(id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, User user) {
<b class="nc">&nbsp;            deleteUser(tenantId, user);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;CustomerId, User&gt; customerUsersRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        protected PageData&lt;User&gt; findEntities(TenantId tenantId, CustomerId id, PageLink pageLink) {
<b class="nc">&nbsp;            return userDao.findCustomerUsers(tenantId.getId(), id.getId(), pageLink);</b>
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, User entity) {
<b class="nc">&nbsp;            deleteUser(tenantId, entity);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;TenantId, User&gt; usersRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        protected PageData&lt;User&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;            return findUsersByTenantId(tenantId, pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, User user) {
<b class="nc">&nbsp;            deleteUser(tenantId, user, ActionCause.TENANT_DELETION);</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HasId&lt;?&gt;&gt; findEntity(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return Optional.ofNullable(findUserById(tenantId, new UserId(entityId.getId())));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public FluentFuture&lt;Optional&lt;HasId&lt;?&gt;&gt;&gt; findEntityAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return FluentFuture.from(findUserByIdAsync(tenantId, new UserId(entityId.getId())))</b>
<b class="nc">&nbsp;                .transform(Optional::ofNullable, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        return userDao.countByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return EntityType.USER;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

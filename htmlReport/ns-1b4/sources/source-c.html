<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbRuleEngineProcessingStrategyFactory</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.queue.processing</a>
</div>

<h1>Coverage Summary for Class: TbRuleEngineProcessingStrategyFactory (org.thingsboard.server.service.queue.processing)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbRuleEngineProcessingStrategyFactory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TbRuleEngineProcessingStrategyFactory$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TbRuleEngineProcessingStrategyFactory$RetryStrategy</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TbRuleEngineProcessingStrategyFactory$SkipStrategy</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.queue.processing;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.thingsboard.server.common.data.queue.ProcessingStrategy;
&nbsp;import org.thingsboard.server.common.msg.queue.TbMsgCallback;
&nbsp;import org.thingsboard.server.common.util.ProtoUtils;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.queue.common.TbProtoQueueMsg;
&nbsp;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;@Component
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class TbRuleEngineProcessingStrategyFactory {</b>
&nbsp;
&nbsp;    public TbRuleEngineProcessingStrategy newInstance(String name, ProcessingStrategy processingStrategy) {
<b class="nc">&nbsp;        switch (processingStrategy.getType()) {</b>
&nbsp;            case SKIP_ALL_FAILURES:
<b class="nc">&nbsp;                return new SkipStrategy(name, false);</b>
&nbsp;            case SKIP_ALL_FAILURES_AND_TIMED_OUT:
<b class="nc">&nbsp;                return new SkipStrategy(name, true);</b>
&nbsp;            case RETRY_ALL:
<b class="nc">&nbsp;                return new RetryStrategy(name, true, true, true, processingStrategy);</b>
&nbsp;            case RETRY_FAILED:
<b class="nc">&nbsp;                return new RetryStrategy(name, false, true, false, processingStrategy);</b>
&nbsp;            case RETRY_TIMED_OUT:
<b class="nc">&nbsp;                return new RetryStrategy(name, false, false, true, processingStrategy);</b>
&nbsp;            case RETRY_FAILED_AND_TIMED_OUT:
<b class="nc">&nbsp;                return new RetryStrategy(name, false, true, true, processingStrategy);</b>
&nbsp;            default:
<b class="nc">&nbsp;                throw new RuntimeException(&quot;TbRuleEngineProcessingStrategy with type &quot; + processingStrategy.getType() + &quot; is not supported!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class RetryStrategy implements TbRuleEngineProcessingStrategy {
&nbsp;        private final String queueName;
&nbsp;        private final boolean retrySuccessful;
&nbsp;        private final boolean retryFailed;
&nbsp;        private final boolean retryTimeout;
&nbsp;        private final int maxRetries;
&nbsp;        private final double maxAllowedFailurePercentage;
&nbsp;        private final long maxPauseBetweenRetries;
&nbsp;
&nbsp;        private long pauseBetweenRetries;
&nbsp;
&nbsp;        private int initialTotalCount;
&nbsp;        private int retryCount;
&nbsp;
<b class="nc">&nbsp;        public RetryStrategy(String queueName, boolean retrySuccessful, boolean retryFailed, boolean retryTimeout, ProcessingStrategy processingStrategy) {</b>
<b class="nc">&nbsp;            this.queueName = queueName;</b>
<b class="nc">&nbsp;            this.retrySuccessful = retrySuccessful;</b>
<b class="nc">&nbsp;            this.retryFailed = retryFailed;</b>
<b class="nc">&nbsp;            this.retryTimeout = retryTimeout;</b>
<b class="nc">&nbsp;            this.maxRetries = processingStrategy.getRetries();</b>
<b class="nc">&nbsp;            this.maxAllowedFailurePercentage = processingStrategy.getFailurePercentage();</b>
<b class="nc">&nbsp;            this.pauseBetweenRetries = processingStrategy.getPauseBetweenRetries();</b>
<b class="nc">&nbsp;            this.maxPauseBetweenRetries = processingStrategy.getMaxPauseBetweenRetries();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean isSkipTimeoutMsgs() {
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbRuleEngineProcessingDecision analyze(TbRuleEngineProcessingResult result) {
<b class="nc">&nbsp;            if (result.isSuccess()) {</b>
<b class="nc">&nbsp;                log.trace(&quot;[{}] The result of the msg pack processing is successful, going to proceed with processing of the following msgs&quot;, queueName);</b>
<b class="nc">&nbsp;                return new TbRuleEngineProcessingDecision(true, null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (retryCount == 0) {</b>
<b class="nc">&nbsp;                    initialTotalCount = result.getPendingMap().size() + result.getFailedMap().size() + result.getSuccessMap().size();</b>
&nbsp;                }
<b class="nc">&nbsp;                retryCount++;</b>
<b class="nc">&nbsp;                double failedCount = result.getFailedMap().size() + result.getPendingMap().size();</b>
<b class="nc">&nbsp;                if (maxRetries &gt; 0 &amp;&amp; retryCount &gt; maxRetries) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Skip reprocess of the rule engine pack due to max retries&quot;, queueName);</b>
<b class="nc">&nbsp;                    return new TbRuleEngineProcessingDecision(true, null);</b>
<b class="nc">&nbsp;                } else if (maxAllowedFailurePercentage &gt; 0 &amp;&amp; (failedCount / initialTotalCount) &gt; maxAllowedFailurePercentage) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Skip reprocess of the rule engine pack due to max allowed failure percentage&quot;, queueName);</b>
<b class="nc">&nbsp;                    return new TbRuleEngineProcessingDecision(true, null);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.debug(&quot;[{}] The result of msg pack processing is unsuccessful, checking unprocessed msgs and going to reprocess them&quot;, queueName);</b>
<b class="nc">&nbsp;                    ConcurrentMap&lt;UUID, TbProtoQueueMsg&lt;TransportProtos.ToRuleEngineMsg&gt;&gt; toReprocess = new ConcurrentHashMap&lt;&gt;(initialTotalCount);</b>
<b class="nc">&nbsp;                    if (retryFailed) {</b>
<b class="nc">&nbsp;                        result.getFailedMap().forEach(toReprocess::put);</b>
<b class="nc">&nbsp;                    } else if (log.isDebugEnabled() &amp;&amp; !result.getFailedMap().isEmpty()) {</b>
<b class="nc">&nbsp;                        log.debug(&quot;[{}] Skipped {} failed messages due to the processing strategy configuration&quot;, queueName, result.getFailedMap().size());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (retryTimeout) {</b>
<b class="nc">&nbsp;                        result.getPendingMap().forEach(toReprocess::put);</b>
<b class="nc">&nbsp;                    } else if (log.isDebugEnabled() &amp;&amp; !result.getPendingMap().isEmpty()) {</b>
<b class="nc">&nbsp;                        log.debug(&quot;[{}] Skipped {} timedOut messages due to the processing strategy configuration&quot;, queueName, result.getPendingMap().size());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (retrySuccessful) {</b>
<b class="nc">&nbsp;                        result.getSuccessMap().forEach(toReprocess::put);</b>
<b class="nc">&nbsp;                    } else if (log.isTraceEnabled() &amp;&amp; !result.getSuccessMap().isEmpty()) {</b>
<b class="nc">&nbsp;                        log.trace(&quot;[{}] Skipped {} successful messages due to the processing strategy configuration&quot;, queueName, result.getSuccessMap().size());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (CollectionUtils.isEmpty(toReprocess)) {</b>
<b class="nc">&nbsp;                        if (log.isDebugEnabled()) {</b>
<b class="nc">&nbsp;                            log.debug(&quot;[{}] Stopping the reprocessing logic due to reprocessing map is empty&quot;, queueName);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        return new TbRuleEngineProcessingDecision(true, null);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Going to reprocess {} messages&quot;, queueName, toReprocess.size());</b>
<b class="nc">&nbsp;                    if (log.isTraceEnabled()) {</b>
<b class="nc">&nbsp;                        toReprocess.forEach((id, msg) -&gt; log.trace(&quot;Going to reprocess [{}]: {}&quot;, id, ProtoUtils.fromTbMsgProto(result.getQueueName(), msg.getValue(), TbMsgCallback.EMPTY)));</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (pauseBetweenRetries &gt; 0) {</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            Thread.sleep(TimeUnit.SECONDS.toMillis(pauseBetweenRetries));</b>
&nbsp;                        } catch (InterruptedException e) {
<b class="nc">&nbsp;                            throw new RuntimeException(e);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (maxPauseBetweenRetries &gt; pauseBetweenRetries) {</b>
<b class="nc">&nbsp;                            pauseBetweenRetries = Math.min(maxPauseBetweenRetries, pauseBetweenRetries * 2);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                    return new TbRuleEngineProcessingDecision(false, toReprocess);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class SkipStrategy implements TbRuleEngineProcessingStrategy {
&nbsp;
&nbsp;        private final String queueName;
&nbsp;        private final boolean skipTimeoutMsgs;
&nbsp;
<b class="nc">&nbsp;        public SkipStrategy(String name, boolean skipTimeoutMsgs) {</b>
<b class="nc">&nbsp;            this.queueName = name;</b>
<b class="nc">&nbsp;            this.skipTimeoutMsgs = skipTimeoutMsgs;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public boolean isSkipTimeoutMsgs() {
<b class="nc">&nbsp;            return skipTimeoutMsgs;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbRuleEngineProcessingDecision analyze(TbRuleEngineProcessingResult result) {
<b class="nc">&nbsp;            if (!result.isSuccess()) {</b>
<b class="nc">&nbsp;                log.debug(&quot;[{}] Reprocessing skipped for {} failed and {} timeout messages&quot;, queueName, result.getFailedMap().size(), result.getPendingMap().size());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (log.isTraceEnabled()) {</b>
<b class="nc">&nbsp;                result.getFailedMap().forEach((id, msg) -&gt; log.trace(&quot;Failed messages [{}]: {}&quot;, id, ProtoUtils.fromTbMsgProto(result.getQueueName(), msg.getValue(), TbMsgCallback.EMPTY)));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (log.isTraceEnabled()) {</b>
<b class="nc">&nbsp;                result.getPendingMap().forEach((id, msg) -&gt; log.trace(&quot;Timeout messages [{}]: {}&quot;, id, ProtoUtils.fromTbMsgProto(result.getQueueName(), msg.getValue(), TbMsgCallback.EMPTY)));</b>
&nbsp;            }
<b class="nc">&nbsp;            return new TbRuleEngineProcessingDecision(true, null);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

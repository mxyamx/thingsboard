<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultTbDeviceService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.entitiy.device</a>
</div>

<h1>Coverage Summary for Class: DefaultTbDeviceService (org.thingsboard.server.service.entitiy.device)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultTbDeviceService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/110)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.entitiy.device;
&nbsp;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.NameConflictStrategy;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.dao.device.ClaimDevicesService;
&nbsp;import org.thingsboard.server.dao.device.DeviceCredentialsService;
&nbsp;import org.thingsboard.server.dao.device.DeviceService;
&nbsp;import org.thingsboard.server.dao.device.claim.ClaimResponse;
&nbsp;import org.thingsboard.server.dao.device.claim.ClaimResult;
&nbsp;import org.thingsboard.server.dao.device.claim.ReclaimResult;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.entitiy.AbstractTbEntityService;
&nbsp;
&nbsp;@AllArgsConstructor
&nbsp;@TbCoreComponent
&nbsp;@Service
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class DefaultTbDeviceService extends AbstractTbEntityService implements TbDeviceService {
&nbsp;
&nbsp;    private final DeviceService deviceService;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final ClaimDevicesService claimDevicesService;
&nbsp;
&nbsp;    @Override
&nbsp;    public Device save(Device device, String accessToken, User user) throws Exception {
<b class="nc">&nbsp;        return save(device, accessToken, NameConflictStrategy.DEFAULT, user);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device save(Device device, String accessToken, NameConflictStrategy nameConflictStrategy, User user) throws Exception {
<b class="nc">&nbsp;        ActionType actionType = device.getId() == null ? ActionType.ADDED : ActionType.UPDATED;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.saveDeviceWithAccessToken(device, accessToken, nameConflictStrategy));</b>
<b class="nc">&nbsp;            autoCommit(user, savedDevice.getId());</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, savedDevice.getId(), savedDevice, savedDevice.getCustomerId(),</b>
&nbsp;                    actionType, user);
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), device, actionType, user, e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithCredentials(Device device, DeviceCredentials credentials, User user) throws ThingsboardException {
<b class="nc">&nbsp;        return saveDeviceWithCredentials(device, credentials, NameConflictStrategy.DEFAULT, user);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device saveDeviceWithCredentials(Device device, DeviceCredentials credentials, NameConflictStrategy nameConflictStrategy, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = device.getId() == null ? ActionType.ADDED : ActionType.UPDATED;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.saveDeviceWithCredentials(device, credentials, nameConflictStrategy));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, savedDevice.getId(), savedDevice, savedDevice.getCustomerId(),</b>
&nbsp;                    actionType, user);
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), device, actionType, user, e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void delete(Device device, User user) {
<b class="nc">&nbsp;        ActionType actionType = ActionType.DELETED;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            deviceService.deleteDevice(tenantId, deviceId);</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, device, device.getCustomerId(), actionType,</b>
<b class="nc">&nbsp;                    user, deviceId.toString());</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), actionType,</b>
<b class="nc">&nbsp;                    user, e, deviceId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device assignDeviceToCustomer(TenantId tenantId, DeviceId deviceId, Customer customer, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_CUSTOMER;</b>
<b class="nc">&nbsp;        CustomerId customerId = customer.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.assignDeviceToCustomer(tenantId, deviceId, customerId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, savedDevice, customerId, actionType, user,</b>
<b class="nc">&nbsp;                    deviceId.toString(), customerId.toString(), customer.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), actionType, user,</b>
<b class="nc">&nbsp;                    e, deviceId.toString(), customerId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device unassignDeviceFromCustomer(Device device, Customer customer, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.UNASSIGNED_FROM_CUSTOMER;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.unassignDeviceFromCustomer(tenantId, deviceId));</b>
<b class="nc">&nbsp;            CustomerId customerId = customer.getId();</b>
&nbsp;
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, savedDevice, customerId, actionType, user,</b>
<b class="nc">&nbsp;                    deviceId.toString(), customerId.toString(), customer.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), actionType,</b>
<b class="nc">&nbsp;                    user, e, deviceId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device assignDeviceToPublicCustomer(TenantId tenantId, DeviceId deviceId, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_CUSTOMER;</b>
<b class="nc">&nbsp;        Customer publicCustomer = customerService.findOrCreatePublicCustomer(tenantId);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.assignDeviceToCustomer(tenantId, deviceId, publicCustomer.getId()));</b>
&nbsp;
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, savedDevice, savedDevice.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, deviceId.toString(), publicCustomer.getId().toString(), publicCustomer.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE), actionType,</b>
<b class="nc">&nbsp;                    user, e, deviceId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceCredentials getDeviceCredentialsByDeviceId(Device device, User user) throws ThingsboardException {
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            DeviceCredentials deviceCredentials = checkNotNull(deviceCredentialsService.findDeviceCredentialsByDeviceId(tenantId, deviceId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, device, device.getCustomerId(),</b>
<b class="nc">&nbsp;                    ActionType.CREDENTIALS_READ, user, deviceId.toString());</b>
<b class="nc">&nbsp;            return deviceCredentials;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE),</b>
<b class="nc">&nbsp;                    ActionType.CREDENTIALS_READ, user, e, deviceId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DeviceCredentials updateDeviceCredentials(Device device, DeviceCredentials deviceCredentials, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.CREDENTIALS_UPDATED;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            DeviceCredentials result = checkNotNull(deviceCredentialsService.updateDeviceCredentials(tenantId, deviceCredentials));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, device, device.getCustomerId(),</b>
&nbsp;                    actionType, user, result);
<b class="nc">&nbsp;            return result;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE),</b>
&nbsp;                    actionType, user, e, deviceCredentials);
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;ClaimResult&gt; claimDevice(TenantId tenantId, Device device, CustomerId customerId, String secretKey, User user) {
<b class="nc">&nbsp;        ListenableFuture&lt;ClaimResult&gt; future = claimDevicesService.claimDevice(device, customerId, secretKey);</b>
&nbsp;
<b class="nc">&nbsp;        return Futures.transform(future, result -&gt; {</b>
<b class="nc">&nbsp;            if (result != null &amp;&amp; result.getResponse().equals(ClaimResponse.SUCCESS)) {</b>
<b class="nc">&nbsp;                logEntityActionService.logEntityAction(tenantId, device.getId(), result.getDevice(), customerId,</b>
<b class="nc">&nbsp;                        ActionType.ASSIGNED_TO_CUSTOMER, user, device.getId().toString(), customerId.toString(),</b>
<b class="nc">&nbsp;                        customerService.findCustomerById(tenantId, customerId).getName());</b>
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;ReclaimResult&gt; reclaimDevice(TenantId tenantId, Device device, User user) {
<b class="nc">&nbsp;        ListenableFuture&lt;ReclaimResult&gt; future = claimDevicesService.reClaimDevice(tenantId, device);</b>
&nbsp;
<b class="nc">&nbsp;        return Futures.transform(future, result -&gt; {</b>
<b class="nc">&nbsp;            Customer unassignedCustomer = result.getUnassignedCustomer();</b>
<b class="nc">&nbsp;            if (unassignedCustomer != null) {</b>
<b class="nc">&nbsp;                logEntityActionService.logEntityAction(tenantId, device.getId(), device, device.getCustomerId(),</b>
<b class="nc">&nbsp;                        ActionType.UNASSIGNED_FROM_CUSTOMER, user, device.getId().toString(),</b>
<b class="nc">&nbsp;                        unassignedCustomer.getId().toString(), unassignedCustomer.getName());</b>
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device assignDeviceToTenant(Device device, Tenant newTenant, User user) {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_TENANT;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        TenantId newTenantId = newTenant.getId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device assignedDevice = deviceService.assignDeviceToTenant(newTenantId, device);</b>
&nbsp;
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, assignedDevice, assignedDevice.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, newTenantId.toString(), newTenant.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return assignedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE),</b>
<b class="nc">&nbsp;                    actionType, user, e, deviceId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device assignDeviceToEdge(TenantId tenantId, DeviceId deviceId, Edge edge, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.ASSIGNED_TO_EDGE;</b>
<b class="nc">&nbsp;        EdgeId edgeId = edge.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.assignDeviceToEdge(tenantId, deviceId, edgeId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, savedDevice, savedDevice.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, deviceId.toString(), edgeId.toString(), edge.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE),</b>
<b class="nc">&nbsp;                    actionType, user, e, deviceId.toString(), edgeId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Device unassignDeviceFromEdge(Device device, Edge edge, User user) throws ThingsboardException {
<b class="nc">&nbsp;        ActionType actionType = ActionType.UNASSIGNED_FROM_EDGE;</b>
<b class="nc">&nbsp;        TenantId tenantId = device.getTenantId();</b>
<b class="nc">&nbsp;        DeviceId deviceId = device.getId();</b>
<b class="nc">&nbsp;        EdgeId edgeId = edge.getId();</b>
&nbsp;        try {
<b class="nc">&nbsp;            Device savedDevice = checkNotNull(deviceService.unassignDeviceFromEdge(tenantId, deviceId, edgeId));</b>
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, deviceId, savedDevice, savedDevice.getCustomerId(),</b>
<b class="nc">&nbsp;                    actionType, user, deviceId.toString(), edgeId.toString(), edge.getName());</b>
&nbsp;
<b class="nc">&nbsp;            return savedDevice;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            logEntityActionService.logEntityAction(tenantId, emptyId(EntityType.DEVICE),</b>
<b class="nc">&nbsp;                    actionType, user, e, deviceId.toString(), edgeId.toString());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

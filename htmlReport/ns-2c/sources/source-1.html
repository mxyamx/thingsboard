<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbKafkaNode</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.kafka</a>
</div>

<h1>Coverage Summary for Class: TbKafkaNode (org.thingsboard.rule.engine.kafka)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbKafkaNode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/80)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.kafka;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.BooleanUtils;
&nbsp;import org.apache.kafka.clients.producer.KafkaProducer;
&nbsp;import org.apache.kafka.clients.producer.Producer;
&nbsp;import org.apache.kafka.clients.producer.ProducerConfig;
&nbsp;import org.apache.kafka.clients.producer.ProducerRecord;
&nbsp;import org.apache.kafka.clients.producer.RecordMetadata;
&nbsp;import org.apache.kafka.common.config.SslConfigs;
&nbsp;import org.apache.kafka.common.header.Headers;
&nbsp;import org.apache.kafka.common.header.internals.RecordHeader;
&nbsp;import org.apache.kafka.common.header.internals.RecordHeaders;
&nbsp;import org.apache.kafka.common.serialization.StringSerializer;
&nbsp;import org.springframework.util.ReflectionUtils;
&nbsp;import org.thingsboard.rule.engine.api.RuleNode;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeConfiguration;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeException;
&nbsp;import org.thingsboard.rule.engine.api.util.TbNodeUtils;
&nbsp;import org.thingsboard.rule.engine.external.TbAbstractExternalNode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardKafkaClientError;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentType;
&nbsp;import org.thingsboard.server.common.data.util.TbPair;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;
&nbsp;import java.lang.reflect.Field;
&nbsp;import java.nio.charset.Charset;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.Properties;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RuleNode(
&nbsp;        type = ComponentType.EXTERNAL,
&nbsp;        name = &quot;kafka&quot;,
&nbsp;        configClazz = TbKafkaNodeConfiguration.class,
&nbsp;        version = 1,
&nbsp;        nodeDescription = &quot;Publish messages to Kafka server&quot;,
&nbsp;        nodeDetails = &quot;Will send record via Kafka producer to Kafka server. &quot; +
&nbsp;                &quot;Outbound message will contain response fields (&lt;code&gt;offset&lt;/code&gt;, &lt;code&gt;partition&lt;/code&gt;, &lt;code&gt;topic&lt;/code&gt;)&quot; +
&nbsp;                &quot; from the Kafka in the Message Metadata. For example &lt;b&gt;partition&lt;/b&gt; field can be accessed with &lt;code&gt;metadata.partition&lt;/code&gt;.&quot;,
&nbsp;        configDirective = &quot;tbExternalNodeKafkaConfig&quot;,
&nbsp;        iconUrl = &quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUzOCIgaGVpZ2h0PSIyNTAwIiB2aWV3Qm94PSIwIDAgMjU2IDQxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWlkWU1pZCI+PHBhdGggZD0iTTIwMS44MTYgMjMwLjIxNmMtMTYuMTg2IDAtMzAuNjk3IDcuMTcxLTQwLjYzNCAxOC40NjFsLTI1LjQ2My0xOC4wMjZjMi43MDMtNy40NDIgNC4yNTUtMTUuNDMzIDQuMjU1LTIzLjc5NyAwLTguMjE5LTEuNDk4LTE2LjA3Ni00LjExMi0yMy40MDhsMjUuNDA2LTE3LjgzNWM5LjkzNiAxMS4yMzMgMjQuNDA5IDE4LjM2NSA0MC41NDggMTguMzY1IDI5Ljg3NSAwIDU0LjE4NC0yNC4zMDUgNTQuMTg0LTU0LjE4NCAwLTI5Ljg3OS0yNC4zMDktNTQuMTg0LTU0LjE4NC01NC4xODQtMjkuODc1IDAtNTQuMTg0IDI0LjMwNS01NC4xODQgNTQuMTg0IDAgNS4zNDguODA4IDEwLjUwNSAyLjI1OCAxNS4zODlsLTI1LjQyMyAxNy44NDRjLTEwLjYyLTEzLjE3NS0yNS45MTEtMjIuMzc0LTQzLjMzMy0yNS4xODJ2LTMwLjY0YzI0LjU0NC01LjE1NSA0My4wMzctMjYuOTYyIDQzLjAzNy01My4wMTlDMTI0LjE3MSAyNC4zMDUgOTkuODYyIDAgNjkuOTg3IDAgNDAuMTEyIDAgMTUuODAzIDI0LjMwNSAxNS44MDMgNTQuMTg0YzAgMjUuNzA4IDE4LjAxNCA0Ny4yNDYgNDIuMDY3IDUyLjc2OXYzMS4wMzhDMjUuMDQ0IDE0My43NTMgMCAxNzIuNDAxIDAgMjA2Ljg1NGMwIDM0LjYyMSAyNS4yOTIgNjMuMzc0IDU4LjM1NSA2OC45NHYzMi43NzRjLTI0LjI5OSA1LjM0MS00Mi41NTIgMjcuMDExLTQyLjU1MiA1Mi44OTQgMCAyOS44NzkgMjQuMzA5IDU0LjE4NCA1NC4xODQgNTQuMTg0IDI5Ljg3NSAwIDU0LjE4NC0yNC4zMDUgNTQuMTg0LTU0LjE4NCAwLTI1Ljg4My0xOC4yNTMtNDcuNTUzLTQyLjU1Mi01Mi44OTR2LTMyLjc3NWE2OS45NjUgNjkuOTY1IDAgMCAwIDQyLjYtMjQuNzc2bDI1LjYzMyAxOC4xNDNjLTEuNDIzIDQuODQtMi4yMiA5Ljk0Ni0yLjIyIDE1LjI0IDAgMjkuODc5IDI0LjMwOSA1NC4xODQgNTQuMTg0IDU0LjE4NCAyOS44NzUgMCA1NC4xODQtMjQuMzA1IDU0LjE4NC01NC4xODQgMC0yOS44NzktMjQuMzA5LTU0LjE4NC01NC4xODQtNTQuMTg0em0wLTEyNi42OTVjMTQuNDg3IDAgMjYuMjcgMTEuNzg4IDI2LjI3IDI2LjI3MXMtMTEuNzgzIDI2LjI3LTI2LjI3IDI2LjI3LTI2LjI3LTExLjc4Ny0yNi4yNy0yNi4yN2MwLTE0LjQ4MyAxMS43ODMtMjYuMjcxIDI2LjI3LTI2LjI3MXptLTE1OC4xLTQ5LjMzN2MwLTE0LjQ4MyAxMS43ODQtMjYuMjcgMjYuMjcxLTI2LjI3czI2LjI3IDExLjc4NyAyNi4yNyAyNi4yN2MwIDE0LjQ4My0xMS43ODMgMjYuMjctMjYuMjcgMjYuMjdzLTI2LjI3MS0xMS43ODctMjYuMjcxLTI2LjI3em01Mi41NDEgMzA3LjI3OGMwIDE0LjQ4My0xMS43ODMgMjYuMjctMjYuMjcgMjYuMjdzLTI2LjI3MS0xMS43ODctMjYuMjcxLTI2LjI3YzAtMTQuNDgzIDExLjc4NC0yNi4yNyAyNi4yNzEtMjYuMjdzMjYuMjcgMTEuNzg3IDI2LjI3IDI2LjI3em0tMjYuMjcyLTExNy45N2MtMjAuMjA1IDAtMzYuNjQyLTE2LjQzNC0zNi42NDItMzYuNjM4IDAtMjAuMjA1IDE2LjQzNy0zNi42NDIgMzYuNjQyLTM2LjY0MiAyMC4yMDQgMCAzNi42NDEgMTYuNDM3IDM2LjY0MSAzNi42NDIgMCAyMC4yMDQtMTYuNDM3IDM2LjYzOC0zNi42NDEgMzYuNjM4em0xMzEuODMxIDY3LjE3OWMtMTQuNDg3IDAtMjYuMjctMTEuNzg4LTI2LjI3LTI2LjI3MXMxMS43ODMtMjYuMjcgMjYuMjctMjYuMjcgMjYuMjcgMTEuNzg3IDI2LjI3IDI2LjI3YzAgMTQuNDgzLTExLjc4MyAyNi4yNzEtMjYuMjcgMjYuMjcxeiIvPjwvc3ZnPg==&quot;,
&nbsp;        docUrl = &quot;https://thingsboard.io/docs/user-guide/rule-engine-2-0/nodes/external/kafka/&quot;
&nbsp;)
<b class="nc">&nbsp;public class TbKafkaNode extends TbAbstractExternalNode {</b>
&nbsp;
&nbsp;    private static final String OFFSET = &quot;offset&quot;;
&nbsp;    private static final String PARTITION = &quot;partition&quot;;
&nbsp;    private static final String TOPIC = &quot;topic&quot;;
&nbsp;    private static final String ERROR = &quot;error&quot;;
&nbsp;    public static final String TB_MSG_MD_PREFIX = &quot;tb_msg_md_&quot;;
<b class="nc">&nbsp;    private static final Field IO_THREAD_FIELD = ReflectionUtils.findField(KafkaProducer.class, &quot;ioThread&quot;);</b>
&nbsp;
&nbsp;    static {
<b class="nc">&nbsp;        IO_THREAD_FIELD.setAccessible(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbKafkaNodeConfiguration config;
&nbsp;    private boolean addMetadataKeyValuesAsKafkaHeaders;
&nbsp;    private Charset toBytesCharset;
&nbsp;
&nbsp;    private Producer&lt;String, String&gt; producer;
&nbsp;    private Throwable initError;
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbContext ctx, TbNodeConfiguration configuration) throws TbNodeException {
<b class="nc">&nbsp;        super.init(ctx);</b>
<b class="nc">&nbsp;        this.config = TbNodeUtils.convert(configuration, TbKafkaNodeConfiguration.class);</b>
<b class="nc">&nbsp;        this.initError = null;</b>
<b class="nc">&nbsp;        Properties properties = new Properties();</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.CLIENT_ID_CONFIG, &quot;producer-tb-kafka-node-&quot; + ctx.getSelfId().getId().toString() + &quot;-&quot; + ctx.getServiceId());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, config.getBootstrapServers());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.ACKS_CONFIG, config.getAcks());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.RETRIES_CONFIG, config.getRetries());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.BATCH_SIZE_CONFIG, config.getBatchSize());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.LINGER_MS_CONFIG, config.getLinger());</b>
<b class="nc">&nbsp;        properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG, config.getBufferMemory());</b>
<b class="nc">&nbsp;        if (config.getOtherProperties() != null) {</b>
<b class="nc">&nbsp;            config.getOtherProperties().forEach((k, v) -&gt; {</b>
<b class="nc">&nbsp;                if (SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG.equals(k)</b>
<b class="nc">&nbsp;                        || SslConfigs.SSL_KEYSTORE_KEY_CONFIG.equals(k)</b>
<b class="nc">&nbsp;                        || SslConfigs.SSL_TRUSTSTORE_CERTIFICATES_CONFIG.equals(k)) {</b>
<b class="nc">&nbsp;                    v = v.replace(&quot;\\n&quot;, &quot;\n&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                properties.put(k, v);</b>
&nbsp;            });
&nbsp;        }
<b class="nc">&nbsp;        addMetadataKeyValuesAsKafkaHeaders = BooleanUtils.toBooleanDefaultIfNull(config.isAddMetadataKeyValuesAsKafkaHeaders(), false);</b>
<b class="nc">&nbsp;        toBytesCharset = config.getKafkaHeadersCharset() != null ? Charset.forName(config.getKafkaHeadersCharset()) : StandardCharsets.UTF_8;</b>
&nbsp;        try {
<b class="nc">&nbsp;            this.producer = getKafkaProducer(properties);</b>
<b class="nc">&nbsp;            Thread ioThread = (Thread) ReflectionUtils.getField(IO_THREAD_FIELD, producer);</b>
<b class="nc">&nbsp;            ioThread.setUncaughtExceptionHandler((thread, throwable) -&gt; {</b>
<b class="nc">&nbsp;                if (throwable instanceof ThingsboardKafkaClientError) {</b>
<b class="nc">&nbsp;                    initError = throwable;</b>
<b class="nc">&nbsp;                    destroy();</b>
&nbsp;                }
&nbsp;            });
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            throw new TbNodeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    KafkaProducer&lt;String, String&gt; getKafkaProducer(Properties properties) {
<b class="nc">&nbsp;        return new KafkaProducer&lt;&gt;(properties);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onMsg(TbContext ctx, TbMsg msg) {
<b class="nc">&nbsp;        String topic = TbNodeUtils.processPattern(config.getTopicPattern(), msg);</b>
<b class="nc">&nbsp;        String keyPattern = config.getKeyPattern();</b>
<b class="nc">&nbsp;        var tbMsg = ackIfNeeded(ctx, msg);</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (initError != null) {</b>
<b class="nc">&nbsp;                ctx.tellFailure(tbMsg, new RuntimeException(&quot;Failed to initialize Kafka rule node producer: &quot; + initError.getMessage()));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ctx.getExternalCallExecutor().executeAsync(() -&gt; {</b>
<b class="nc">&nbsp;                    publish(</b>
&nbsp;                            ctx,
&nbsp;                            tbMsg,
&nbsp;                            topic,
<b class="nc">&nbsp;                            keyPattern == null || keyPattern.isEmpty()</b>
<b class="nc">&nbsp;                                    ? null</b>
<b class="nc">&nbsp;                                    : TbNodeUtils.processPattern(config.getKeyPattern(), tbMsg)</b>
&nbsp;                    );
<b class="nc">&nbsp;                    return null;</b>
&nbsp;                });
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            ctx.tellFailure(tbMsg, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected void publish(TbContext ctx, TbMsg msg, String topic, String key) {
&nbsp;        try {
<b class="nc">&nbsp;            if (!addMetadataKeyValuesAsKafkaHeaders) {</b>
&nbsp;                //TODO: external system executor
<b class="nc">&nbsp;                producer.send(new ProducerRecord&lt;&gt;(topic, key, msg.getData()),</b>
<b class="nc">&nbsp;                        (metadata, e) -&gt; processRecord(ctx, msg, metadata, e));</b>
&nbsp;            } else {
<b class="nc">&nbsp;                Headers headers = new RecordHeaders();</b>
<b class="nc">&nbsp;                msg.getMetaData().values().forEach((k, v) -&gt; headers.add(new RecordHeader(TB_MSG_MD_PREFIX + k, v.getBytes(toBytesCharset))));</b>
<b class="nc">&nbsp;                producer.send(new ProducerRecord&lt;&gt;(topic, null, null, key, msg.getData(), headers),</b>
<b class="nc">&nbsp;                        (metadata, e) -&gt; processRecord(ctx, msg, metadata, e));</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.debug(&quot;[{}] Failed to process message: {}&quot;, ctx.getSelfId(), msg, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        if (this.producer != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                this.producer.close();</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Failed to close producer during destroy()&quot;, e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void processRecord(TbContext ctx, TbMsg msg, RecordMetadata metadata, Exception e) {
<b class="nc">&nbsp;        if (e == null) {</b>
<b class="nc">&nbsp;            tellSuccess(ctx, processResponse(msg, metadata));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            tellFailure(ctx, processException(msg, e), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private TbMsg processResponse(TbMsg origMsg, RecordMetadata recordMetadata) {
<b class="nc">&nbsp;        TbMsgMetaData metaData = origMsg.getMetaData().copy();</b>
<b class="nc">&nbsp;        metaData.putValue(OFFSET, String.valueOf(recordMetadata.offset()));</b>
<b class="nc">&nbsp;        metaData.putValue(PARTITION, String.valueOf(recordMetadata.partition()));</b>
<b class="nc">&nbsp;        metaData.putValue(TOPIC, recordMetadata.topic());</b>
<b class="nc">&nbsp;        return origMsg.transform()</b>
<b class="nc">&nbsp;                .metaData(metaData)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbMsg processException(TbMsg origMsg, Exception e) {
<b class="nc">&nbsp;        TbMsgMetaData metaData = origMsg.getMetaData().copy();</b>
<b class="nc">&nbsp;        metaData.putValue(ERROR, e.getClass() + &quot;: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;        return origMsg.transform()</b>
<b class="nc">&nbsp;                .metaData(metaData)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public TbPair&lt;Boolean, JsonNode&gt; upgrade(int fromVersion, JsonNode oldConfiguration) throws TbNodeException {
<b class="nc">&nbsp;        boolean hasChanges = false;</b>
<b class="nc">&nbsp;        switch (fromVersion) {</b>
&nbsp;            case 0 -&gt; {
<b class="nc">&nbsp;                if (oldConfiguration.has(&quot;keySerializer&quot;) || oldConfiguration.has(&quot;valueSerializer&quot;)) {</b>
<b class="nc">&nbsp;                    ObjectNode objectConfiguration = (ObjectNode) oldConfiguration;</b>
<b class="nc">&nbsp;                    objectConfiguration.remove(&quot;keySerializer&quot;);</b>
<b class="nc">&nbsp;                    objectConfiguration.remove(&quot;valueSerializer&quot;);</b>
<b class="nc">&nbsp;                    hasChanges = true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;            default -&gt; {
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return new TbPair&lt;&gt;(hasChanges, oldConfiguration);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

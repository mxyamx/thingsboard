<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbMsg</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.common.msg</a>
</div>

<h1>Coverage Summary for Class: TbMsg (org.thingsboard.server.common.msg)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbMsg</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TbMsg$TbMsgBuilder</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TbMsg$TbMsgTransformer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.common.msg;
&nbsp;
&nbsp;import com.fasterxml.jackson.annotation.JsonIgnore;
&nbsp;import com.google.protobuf.ByteString;
&nbsp;import com.google.protobuf.InvalidProtocolBufferException;
&nbsp;import lombok.AccessLevel;
&nbsp;import lombok.Data;
&nbsp;import lombok.Getter;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.id.CalculatedFieldId;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.RuleNodeId;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.msg.gen.MsgProtos;
&nbsp;import org.thingsboard.server.common.msg.gen.MsgProtos.TbMsgProto;
&nbsp;import org.thingsboard.server.common.msg.queue.TbMsgCallback;
&nbsp;
&nbsp;import java.io.Serializable;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.CopyOnWriteArrayList;
&nbsp;
&nbsp;@Data
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public final class TbMsg implements Serializable {
&nbsp;
&nbsp;    public static final String EMPTY_JSON_OBJECT = &quot;{}&quot;;
&nbsp;    public static final String EMPTY_JSON_ARRAY = &quot;[]&quot;;
&nbsp;    public static final String EMPTY_STRING = &quot;&quot;;
&nbsp;
&nbsp;    private final String queueName;
&nbsp;    private final UUID id;
&nbsp;    private final long ts;
&nbsp;    private final String type;
&nbsp;    private final TbMsgType internalType;
&nbsp;    private final EntityId originator;
&nbsp;    private final CustomerId customerId;
&nbsp;    private final TbMsgMetaData metaData;
&nbsp;    private final TbMsgDataType dataType;
&nbsp;    private final String data;
&nbsp;    private final RuleChainId ruleChainId;
&nbsp;    private final RuleNodeId ruleNodeId;
&nbsp;
&nbsp;    private final UUID correlationId;
&nbsp;    private final Integer partition;
&nbsp;
&nbsp;    private final List&lt;CalculatedFieldId&gt; previousCalculatedFieldIds;
&nbsp;
&nbsp;    @Getter(value = AccessLevel.NONE)
&nbsp;    @JsonIgnore
&nbsp;    //This field is not serialized because we use queues and there is no need to do it
&nbsp;    private final TbMsgProcessingCtx ctx;
&nbsp;
&nbsp;    //This field is not serialized because we use queues and there is no need to do it
&nbsp;    @JsonIgnore
&nbsp;    transient private final TbMsgCallback callback;
&nbsp;
&nbsp;    public static TbMsgBuilder newMsg() {
<b class="nc">&nbsp;        return new TbMsgBuilder();</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsgBuilder transform() {
<b class="nc">&nbsp;        return new TbMsgTransformer(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsgBuilder copy() {
<b class="nc">&nbsp;        return new TbMsgBuilder(this);</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsg transform(String queueName) {
<b class="nc">&nbsp;        return transform()</b>
<b class="nc">&nbsp;                .queueName(queueName)</b>
<b class="nc">&nbsp;                .resetRuleNodeId()</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    // used for enqueueForTellNext
&nbsp;    public static TbMsg newMsg(TbMsg tbMsg, String queueName, RuleChainId ruleChainId, RuleNodeId ruleNodeId) {
<b class="nc">&nbsp;        return tbMsg.transform()</b>
<b class="nc">&nbsp;                .id(UUID.randomUUID())</b>
<b class="nc">&nbsp;                .queueName(queueName)</b>
<b class="nc">&nbsp;                .metaData(tbMsg.getMetaData())</b>
<b class="nc">&nbsp;                .ruleChainId(ruleChainId)</b>
<b class="nc">&nbsp;                .ruleNodeId(ruleNodeId)</b>
<b class="nc">&nbsp;                .callback(TbMsgCallback.EMPTY)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsg copyWithNewCtx() {
<b class="nc">&nbsp;        return copy()</b>
<b class="nc">&nbsp;                .ctx(ctx.copy())</b>
<b class="nc">&nbsp;                .callback(TbMsgCallback.EMPTY)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbMsg(String queueName, UUID id, long ts, TbMsgType internalType, String type, EntityId originator, CustomerId customerId, TbMsgMetaData metaData, TbMsgDataType dataType, String data,
<b class="nc">&nbsp;                  RuleChainId ruleChainId, RuleNodeId ruleNodeId, UUID correlationId, Integer partition, List&lt;CalculatedFieldId&gt; previousCalculatedFieldIds, TbMsgProcessingCtx ctx, TbMsgCallback callback) {</b>
<b class="nc">&nbsp;        this.id = id != null ? id : UUID.randomUUID();</b>
<b class="nc">&nbsp;        this.queueName = queueName;</b>
<b class="nc">&nbsp;        if (ts &gt; 0) {</b>
<b class="nc">&nbsp;            this.ts = ts;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            this.ts = System.currentTimeMillis();</b>
&nbsp;        }
<b class="nc">&nbsp;        this.internalType = internalType != null ? internalType : getInternalType(type);</b>
<b class="nc">&nbsp;        this.type = type != null ? type : this.internalType.name();</b>
<b class="nc">&nbsp;        this.originator = originator;</b>
<b class="nc">&nbsp;        if (customerId == null || customerId.isNullUid()) {</b>
<b class="nc">&nbsp;            if (originator != null &amp;&amp; originator.getEntityType() == EntityType.CUSTOMER) {</b>
<b class="nc">&nbsp;                this.customerId = new CustomerId(originator.getId());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                this.customerId = null;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            this.customerId = customerId;</b>
&nbsp;        }
<b class="nc">&nbsp;        this.metaData = metaData;</b>
<b class="nc">&nbsp;        this.dataType = dataType != null ? dataType : TbMsgDataType.JSON;</b>
<b class="nc">&nbsp;        this.data = data;</b>
<b class="nc">&nbsp;        this.ruleChainId = ruleChainId;</b>
<b class="nc">&nbsp;        this.ruleNodeId = ruleNodeId;</b>
<b class="nc">&nbsp;        this.correlationId = correlationId;</b>
<b class="nc">&nbsp;        this.partition = partition;</b>
<b class="nc">&nbsp;        this.previousCalculatedFieldIds = previousCalculatedFieldIds != null</b>
<b class="nc">&nbsp;                ? new CopyOnWriteArrayList&lt;&gt;(previousCalculatedFieldIds)</b>
<b class="nc">&nbsp;                : new CopyOnWriteArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        this.ctx = ctx != null ? ctx : new TbMsgProcessingCtx();</b>
<b class="nc">&nbsp;        this.callback = Objects.requireNonNullElse(callback, TbMsgCallback.EMPTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TbMsgProto toProto(TbMsg msg) {
<b class="nc">&nbsp;        TbMsgProto.Builder builder = TbMsgProto.newBuilder();</b>
<b class="nc">&nbsp;        builder.setId(msg.getId().toString());</b>
<b class="nc">&nbsp;        builder.setTs(msg.getTs());</b>
<b class="nc">&nbsp;        builder.setType(msg.getType());</b>
<b class="nc">&nbsp;        builder.setEntityType(msg.getOriginator().getEntityType().name());</b>
<b class="nc">&nbsp;        builder.setEntityIdMSB(msg.getOriginator().getId().getMostSignificantBits());</b>
<b class="nc">&nbsp;        builder.setEntityIdLSB(msg.getOriginator().getId().getLeastSignificantBits());</b>
&nbsp;
<b class="nc">&nbsp;        if (msg.getCustomerId() != null) {</b>
<b class="nc">&nbsp;            builder.setCustomerIdMSB(msg.getCustomerId().getId().getMostSignificantBits());</b>
<b class="nc">&nbsp;            builder.setCustomerIdLSB(msg.getCustomerId().getId().getLeastSignificantBits());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (msg.getRuleChainId() != null) {</b>
<b class="nc">&nbsp;            builder.setRuleChainIdMSB(msg.getRuleChainId().getId().getMostSignificantBits());</b>
<b class="nc">&nbsp;            builder.setRuleChainIdLSB(msg.getRuleChainId().getId().getLeastSignificantBits());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (msg.getRuleNodeId() != null) {</b>
<b class="nc">&nbsp;            builder.setRuleNodeIdMSB(msg.getRuleNodeId().getId().getMostSignificantBits());</b>
<b class="nc">&nbsp;            builder.setRuleNodeIdLSB(msg.getRuleNodeId().getId().getLeastSignificantBits());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (msg.getMetaData() != null) {</b>
<b class="nc">&nbsp;            builder.setMetaData(MsgProtos.TbMsgMetaDataProto.newBuilder().putAllData(msg.getMetaData().getData()).build());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        builder.setDataType(msg.getDataType().ordinal());</b>
<b class="nc">&nbsp;        builder.setData(msg.getData());</b>
&nbsp;
<b class="nc">&nbsp;        if (msg.getCorrelationId() != null) {</b>
<b class="nc">&nbsp;            builder.setCorrelationIdMSB(msg.getCorrelationId().getMostSignificantBits());</b>
<b class="nc">&nbsp;            builder.setCorrelationIdLSB(msg.getCorrelationId().getLeastSignificantBits());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (msg.getPartition() != null) {</b>
<b class="nc">&nbsp;            builder.setPartition(msg.getPartition());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (msg.getPreviousCalculatedFieldIds() != null) {</b>
<b class="nc">&nbsp;            for (CalculatedFieldId calculatedFieldId : msg.getPreviousCalculatedFieldIds()) {</b>
<b class="nc">&nbsp;                MsgProtos.CalculatedFieldIdProto calculatedFieldIdProto = MsgProtos.CalculatedFieldIdProto.newBuilder()</b>
<b class="nc">&nbsp;                        .setCalculatedFieldIdMSB(calculatedFieldId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                        .setCalculatedFieldIdLSB(calculatedFieldId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                        .build();</b>
<b class="nc">&nbsp;                builder.addCalculatedFields(calculatedFieldIdProto);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        builder.setCtx(msg.ctx.toProto());</b>
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Deprecated(forRemoval = true, since = &quot;4.1&quot;) // to be removed in 4.2
&nbsp;    public static TbMsg fromProto(String queueName, TbMsgProto proto, ByteString data, TbMsgCallback callback) {
&nbsp;        try {
<b class="nc">&nbsp;            if (!data.isEmpty()) {</b>
<b class="nc">&nbsp;                proto = TbMsgProto.parseFrom(data);</b>
&nbsp;            }
&nbsp;        } catch (InvalidProtocolBufferException e) {
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Could not parse protobuf for TbMsg&quot;, e);</b>
&nbsp;        }
<b class="nc">&nbsp;        return fromProto(queueName, proto, callback);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TbMsg fromProto(String queueName, TbMsgProto proto, TbMsgCallback callback) {
<b class="nc">&nbsp;        TbMsgMetaData metaData = new TbMsgMetaData(proto.getMetaData().getDataMap());</b>
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(proto.getEntityType(), new UUID(proto.getEntityIdMSB(), proto.getEntityIdLSB()));</b>
<b class="nc">&nbsp;        CustomerId customerId = null;</b>
<b class="nc">&nbsp;        RuleChainId ruleChainId = null;</b>
<b class="nc">&nbsp;        RuleNodeId ruleNodeId = null;</b>
<b class="nc">&nbsp;        UUID correlationId = null;</b>
<b class="nc">&nbsp;        Integer partition = null;</b>
<b class="nc">&nbsp;        List&lt;CalculatedFieldId&gt; calculatedFieldIds = new CopyOnWriteArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (proto.getCustomerIdMSB() != 0L &amp;&amp; proto.getCustomerIdLSB() != 0L) {</b>
<b class="nc">&nbsp;            customerId = new CustomerId(new UUID(proto.getCustomerIdMSB(), proto.getCustomerIdLSB()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (proto.getRuleChainIdMSB() != 0L &amp;&amp; proto.getRuleChainIdLSB() != 0L) {</b>
<b class="nc">&nbsp;            ruleChainId = new RuleChainId(new UUID(proto.getRuleChainIdMSB(), proto.getRuleChainIdLSB()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (proto.getRuleNodeIdMSB() != 0L &amp;&amp; proto.getRuleNodeIdLSB() != 0L) {</b>
<b class="nc">&nbsp;            ruleNodeId = new RuleNodeId(new UUID(proto.getRuleNodeIdMSB(), proto.getRuleNodeIdLSB()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (proto.getCorrelationIdMSB() != 0L &amp;&amp; proto.getCorrelationIdLSB() != 0L) {</b>
<b class="nc">&nbsp;            correlationId = new UUID(proto.getCorrelationIdMSB(), proto.getCorrelationIdLSB());</b>
<b class="nc">&nbsp;            partition = proto.getPartition();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        for (MsgProtos.CalculatedFieldIdProto cfIdProto : proto.getCalculatedFieldsList()) {</b>
<b class="nc">&nbsp;            CalculatedFieldId calculatedFieldId = new CalculatedFieldId(new UUID(</b>
<b class="nc">&nbsp;                    cfIdProto.getCalculatedFieldIdMSB(),</b>
<b class="nc">&nbsp;                    cfIdProto.getCalculatedFieldIdLSB()</b>
&nbsp;            ));
<b class="nc">&nbsp;            calculatedFieldIds.add(calculatedFieldId);</b>
&nbsp;        }
<b class="nc">&nbsp;        TbMsgProcessingCtx ctx = TbMsgProcessingCtx.fromProto(proto.getCtx());</b>
<b class="nc">&nbsp;        TbMsgDataType dataType = TbMsgDataType.values()[proto.getDataType()];</b>
<b class="nc">&nbsp;        return new TbMsg(queueName, UUID.fromString(proto.getId()), proto.getTs(), null, proto.getType(), entityId, customerId,</b>
<b class="nc">&nbsp;                metaData, dataType, proto.getData(), ruleChainId, ruleNodeId, correlationId, partition, calculatedFieldIds, ctx, callback);</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getAndIncrementRuleNodeCounter() {
<b class="nc">&nbsp;        return ctx.getAndIncrementRuleNodeCounter();</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsgCallback getCallback() {
&nbsp;        // May be null in case of deserialization;
<b class="nc">&nbsp;        return Objects.requireNonNullElse(callback, TbMsgCallback.EMPTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void pushToStack(RuleChainId ruleChainId, RuleNodeId ruleNodeId) {
<b class="nc">&nbsp;        ctx.push(ruleChainId, ruleNodeId);</b>
&nbsp;    }
&nbsp;
&nbsp;    public TbMsgProcessingStackItem popFormStack() {
<b class="nc">&nbsp;        return ctx.pop();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks if the message is still valid for processing. May be invalid if the message pack is timed-out or canceled.
&nbsp;     *
&nbsp;     * @return &#39;true&#39; if message is valid for processing, &#39;false&#39; otherwise.
&nbsp;     */
&nbsp;    public boolean isValid() {
<b class="nc">&nbsp;        return getCallback().isMsgValid();</b>
&nbsp;    }
&nbsp;
&nbsp;    public long getMetaDataTs() {
<b class="nc">&nbsp;        String tsStr = metaData.getValue(&quot;ts&quot;);</b>
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(tsStr)) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                return Long.parseLong(tsStr);</b>
&nbsp;            } catch (NumberFormatException ignored) {
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return ts;</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbMsgType getInternalType(String type) {
<b class="nc">&nbsp;        if (type != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                return TbMsgType.valueOf(type);</b>
&nbsp;            } catch (IllegalArgumentException ignored) {
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return TbMsgType.NA;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isTypeOf(TbMsgType tbMsgType) {
<b class="nc">&nbsp;        return internalType.equals(tbMsgType);</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isTypeOneOf(TbMsgType... types) {
<b class="nc">&nbsp;        for (TbMsgType type : types) {</b>
<b class="nc">&nbsp;            if (isTypeOf(type)) {</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static class TbMsgTransformer extends TbMsgBuilder {
&nbsp;
&nbsp;        TbMsgTransformer(TbMsg tbMsg) {
<b class="nc">&nbsp;            super(tbMsg);</b>
&nbsp;        }
&nbsp;
&nbsp;        /*
&nbsp;         * metadata is only copied if specified explicitly during transform
&nbsp;         * */
&nbsp;        @Override
&nbsp;        public TbMsgTransformer metaData(TbMsgMetaData metaData) {
<b class="nc">&nbsp;            this.metaData = metaData.copy();</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /*
&nbsp;         * setting ruleNodeId to null when updating ruleChainId
&nbsp;         * */
&nbsp;        @Override
&nbsp;        public TbMsgBuilder ruleChainId(RuleChainId ruleChainId) {
<b class="nc">&nbsp;            this.ruleChainId = ruleChainId;</b>
<b class="nc">&nbsp;            this.ruleNodeId = null;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public TbMsg build() {
&nbsp;            /*
&nbsp;             * always copying ctx when transforming
&nbsp;             * */
<b class="nc">&nbsp;            if (this.ctx != null) {</b>
<b class="nc">&nbsp;                this.ctx = this.ctx.copy();</b>
&nbsp;            }
<b class="nc">&nbsp;            return super.build();</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public static class TbMsgBuilder {
&nbsp;
&nbsp;        protected String queueName;
&nbsp;        protected UUID id;
&nbsp;        protected long ts;
&nbsp;        protected String type;
&nbsp;        protected TbMsgType internalType;
&nbsp;        protected EntityId originator;
&nbsp;        protected CustomerId customerId;
&nbsp;        protected TbMsgMetaData metaData;
&nbsp;        protected TbMsgDataType dataType;
&nbsp;        protected String data;
&nbsp;        protected RuleChainId ruleChainId;
&nbsp;        protected RuleNodeId ruleNodeId;
&nbsp;        protected UUID correlationId;
&nbsp;        protected Integer partition;
&nbsp;        protected List&lt;CalculatedFieldId&gt; previousCalculatedFieldIds;
&nbsp;        protected TbMsgProcessingCtx ctx;
&nbsp;        protected TbMsgCallback callback;
&nbsp;
<b class="nc">&nbsp;        TbMsgBuilder() {}</b>
&nbsp;
<b class="nc">&nbsp;        TbMsgBuilder(TbMsg tbMsg) {</b>
<b class="nc">&nbsp;            this.queueName = tbMsg.queueName;</b>
<b class="nc">&nbsp;            this.id = tbMsg.id;</b>
<b class="nc">&nbsp;            this.ts = tbMsg.ts;</b>
<b class="nc">&nbsp;            this.type = tbMsg.type;</b>
<b class="nc">&nbsp;            this.internalType = tbMsg.internalType;</b>
<b class="nc">&nbsp;            this.originator = tbMsg.originator;</b>
<b class="nc">&nbsp;            this.customerId = tbMsg.customerId;</b>
<b class="nc">&nbsp;            this.metaData = tbMsg.metaData;</b>
<b class="nc">&nbsp;            this.dataType = tbMsg.dataType;</b>
<b class="nc">&nbsp;            this.data = tbMsg.data;</b>
<b class="nc">&nbsp;            this.ruleChainId = tbMsg.ruleChainId;</b>
<b class="nc">&nbsp;            this.ruleNodeId = tbMsg.ruleNodeId;</b>
<b class="nc">&nbsp;            this.correlationId = tbMsg.correlationId;</b>
<b class="nc">&nbsp;            this.partition = tbMsg.partition;</b>
<b class="nc">&nbsp;            this.previousCalculatedFieldIds = tbMsg.previousCalculatedFieldIds;</b>
<b class="nc">&nbsp;            this.ctx = tbMsg.ctx;</b>
<b class="nc">&nbsp;            this.callback = tbMsg.callback;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder queueName(String queueName) {
<b class="nc">&nbsp;            this.queueName = queueName;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder id(UUID id) {
<b class="nc">&nbsp;            this.id = id;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder ts(long ts) {
<b class="nc">&nbsp;            this.ts = ts;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        /**
&nbsp;         * &lt;p&gt;&lt;strong&gt;Deprecated:&lt;/strong&gt; This should only be used when you need to specify a custom message type that doesn&#39;t exist in the {@link TbMsgType} enum.
&nbsp;         * Prefer using {@link #type(TbMsgType)} instead.
&nbsp;         */
&nbsp;        @Deprecated
&nbsp;        public TbMsgBuilder type(String type) {
<b class="nc">&nbsp;            this.type = type;</b>
<b class="nc">&nbsp;            this.internalType = null;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder type(TbMsgType internalType) {
<b class="nc">&nbsp;            this.internalType = internalType;</b>
<b class="nc">&nbsp;            this.type = internalType.name();</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder originator(EntityId originator) {
<b class="nc">&nbsp;            this.originator = originator;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder customerId(CustomerId customerId) {
<b class="nc">&nbsp;            this.customerId = customerId;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder metaData(TbMsgMetaData metaData) {
<b class="nc">&nbsp;            this.metaData = metaData;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder copyMetaData(TbMsgMetaData metaData) {
<b class="nc">&nbsp;            this.metaData = metaData.copy();</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder dataType(TbMsgDataType dataType) {
<b class="nc">&nbsp;            this.dataType = dataType;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder data(String data) {
<b class="nc">&nbsp;            this.data = data;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder ruleChainId(RuleChainId ruleChainId) {
<b class="nc">&nbsp;            this.ruleChainId = ruleChainId;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder ruleNodeId(RuleNodeId ruleNodeId) {
<b class="nc">&nbsp;            this.ruleNodeId = ruleNodeId;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder resetRuleNodeId() {
<b class="nc">&nbsp;            return ruleNodeId(null);</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder correlationId(UUID correlationId) {
<b class="nc">&nbsp;            this.correlationId = correlationId;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder partition(Integer partition) {
<b class="nc">&nbsp;            this.partition = partition;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder previousCalculatedFieldIds(List&lt;CalculatedFieldId&gt; previousCalculatedFieldIds) {
<b class="nc">&nbsp;            this.previousCalculatedFieldIds = new CopyOnWriteArrayList&lt;&gt;(previousCalculatedFieldIds);</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder ctx(TbMsgProcessingCtx ctx) {
<b class="nc">&nbsp;            this.ctx = ctx;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsgBuilder callback(TbMsgCallback callback) {
<b class="nc">&nbsp;            this.callback = callback;</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        public TbMsg build() {
<b class="nc">&nbsp;            return new TbMsg(queueName, id, ts, internalType, type, originator, customerId, metaData, dataType, data, ruleChainId, ruleNodeId, correlationId, partition, previousCalculatedFieldIds, ctx, callback);</b>
&nbsp;        }
&nbsp;
&nbsp;        public String toString() {
<b class="nc">&nbsp;            return &quot;TbMsg.TbMsgBuilder(queueName=&quot; + this.queueName + &quot;, id=&quot; + this.id + &quot;, ts=&quot; + this.ts +</b>
&nbsp;                    &quot;, type=&quot; + this.type + &quot;, internalType=&quot; + this.internalType + &quot;, originator=&quot; + this.originator +
&nbsp;                    &quot;, customerId=&quot; + this.customerId + &quot;, metaData=&quot; + this.metaData + &quot;, dataType=&quot; + this.dataType +
&nbsp;                    &quot;, data=&quot; + this.data + &quot;, ruleChainId=&quot; + this.ruleChainId + &quot;, ruleNodeId=&quot; + this.ruleNodeId +
&nbsp;                    &quot;, correlationId=&quot; + this.correlationId + &quot;, partition=&quot; + this.partition + &quot;, previousCalculatedFields=&quot; + this.previousCalculatedFieldIds +
&nbsp;                    &quot;, ctx=&quot; + this.ctx + &quot;, callback=&quot; + this.callback + &quot;)&quot;;
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

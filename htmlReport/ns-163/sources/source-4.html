<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EdgeMsgConstructorUtils</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.edge</a>
</div>

<h1>Coverage Summary for Class: EdgeMsgConstructorUtils (org.thingsboard.server.service.edge)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EdgeMsgConstructorUtils</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/114)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/391)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EdgeMsgConstructorUtils$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeMsgConstructorUtils$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeMsgConstructorUtils$AttrsTs</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeMsgConstructorUtils$AttrUpdateMsg</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EdgeMsgConstructorUtils$EventKey</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/75)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/114)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/396)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.edge;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.gson.Gson;
&nbsp;import com.google.gson.JsonArray;
&nbsp;import com.google.gson.JsonElement;
&nbsp;import com.google.gson.JsonObject;
&nbsp;import com.google.gson.JsonParser;
&nbsp;import com.google.gson.JsonPrimitive;
&nbsp;import com.google.gson.reflect.TypeToken;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.edge.rpc.EdgeVersionComparator;
&nbsp;import org.thingsboard.rule.engine.action.TbSaveToCustomCassandraTableNode;
&nbsp;import org.thingsboard.rule.engine.ai.TbAiNode;
&nbsp;import org.thingsboard.rule.engine.aws.lambda.TbAwsLambdaNode;
&nbsp;import org.thingsboard.rule.engine.rest.TbSendRestApiCallReplyNode;
&nbsp;import org.thingsboard.rule.engine.telemetry.TbCalculatedFieldsNode;
&nbsp;import org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode;
&nbsp;import org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode;
&nbsp;import org.thingsboard.server.common.adaptor.JsonConverter;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.Dashboard;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.OtaPackage;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.TbResource;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.TenantProfile;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.ai.AiModel;
&nbsp;import org.thingsboard.server.common.data.alarm.Alarm;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmComment;
&nbsp;import org.thingsboard.server.common.data.asset.Asset;
&nbsp;import org.thingsboard.server.common.data.asset.AssetProfile;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedField;
&nbsp;import org.thingsboard.server.common.data.device.profile.DeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.Lwm2mDeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.domain.DomainInfo;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEvent;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEventActionType;
&nbsp;import org.thingsboard.server.common.data.id.AiModelId;
&nbsp;import org.thingsboard.server.common.data.id.AssetId;
&nbsp;import org.thingsboard.server.common.data.id.AssetProfileId;
&nbsp;import org.thingsboard.server.common.data.id.CalculatedFieldId;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DashboardId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.DomainId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityViewId;
&nbsp;import org.thingsboard.server.common.data.id.NotificationRuleId;
&nbsp;import org.thingsboard.server.common.data.id.NotificationTargetId;
&nbsp;import org.thingsboard.server.common.data.id.NotificationTemplateId;
&nbsp;import org.thingsboard.server.common.data.id.OAuth2ClientId;
&nbsp;import org.thingsboard.server.common.data.id.OtaPackageId;
&nbsp;import org.thingsboard.server.common.data.id.QueueId;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.TbResourceId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.id.WidgetTypeId;
&nbsp;import org.thingsboard.server.common.data.id.WidgetsBundleId;
&nbsp;import org.thingsboard.server.common.data.kv.AttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.notification.rule.NotificationRule;
&nbsp;import org.thingsboard.server.common.data.notification.targets.NotificationTarget;
&nbsp;import org.thingsboard.server.common.data.notification.template.NotificationTemplate;
&nbsp;import org.thingsboard.server.common.data.oauth2.OAuth2Client;
&nbsp;import org.thingsboard.server.common.data.queue.Queue;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChain;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainMetaData;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.UserCredentials;
&nbsp;import org.thingsboard.server.common.data.widget.WidgetTypeDetails;
&nbsp;import org.thingsboard.server.common.data.widget.WidgetsBundle;
&nbsp;import org.thingsboard.server.common.transport.util.JsonUtils;
&nbsp;import org.thingsboard.server.gen.edge.v1.AiModelUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.AlarmCommentUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.AlarmUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.AssetProfileUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.AssetUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.AttributeDeleteMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.CalculatedFieldUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.CustomerUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DashboardUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DeviceCredentialsUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DeviceProfileUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DeviceRpcCallMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DeviceUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.EdgeConfiguration;
&nbsp;import org.thingsboard.server.gen.edge.v1.EdgeVersion;
&nbsp;import org.thingsboard.server.gen.edge.v1.EntityDataProto;
&nbsp;import org.thingsboard.server.gen.edge.v1.EntityViewUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.NotificationRuleUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.NotificationTargetUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.NotificationTemplateUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.OAuth2ClientUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.OAuth2DomainUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.OtaPackageUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.QueueUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RelationUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.ResourceUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RpcRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RpcResponseMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RuleChainMetadataUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RuleChainUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.TenantProfileUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.TenantUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.UpdateMsgType;
&nbsp;import org.thingsboard.server.gen.edge.v1.UserCredentialsUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.UserUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.WidgetTypeUpdateMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.WidgetsBundleUpdateMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;import java.util.stream.Collectors;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class EdgeMsgConstructorUtils {</b>
<b class="nc">&nbsp;    public static final Map&lt;EdgeVersion, Map&lt;String, String&gt;&gt; IGNORED_PARAMS_BY_EDGE_VERSION = Map.of(</b>
&nbsp;            EdgeVersion.V_3_9_0,
<b class="nc">&nbsp;            Map.of(</b>
<b class="nc">&nbsp;                    TbMsgTimeseriesNode.class.getName(), &quot;processingSettings&quot;,</b>
<b class="nc">&nbsp;                    TbMsgAttributesNode.class.getName(), &quot;processingSettings&quot;</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_3_8_0,
<b class="nc">&nbsp;            Map.of(</b>
<b class="nc">&nbsp;                    TbMsgTimeseriesNode.class.getName(), &quot;processingSettings&quot;,</b>
<b class="nc">&nbsp;                    TbMsgAttributesNode.class.getName(), &quot;processingSettings&quot;,</b>
<b class="nc">&nbsp;                    TbSaveToCustomCassandraTableNode.class.getName(), &quot;defaultTtl&quot;</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_3_7_0,
<b class="nc">&nbsp;            Map.of(</b>
<b class="nc">&nbsp;                    TbMsgTimeseriesNode.class.getName(), &quot;processingSettings&quot;,</b>
<b class="nc">&nbsp;                    TbMsgAttributesNode.class.getName(), &quot;processingSettings&quot;,</b>
<b class="nc">&nbsp;                    TbSaveToCustomCassandraTableNode.class.getName(), &quot;defaultTtl&quot;</b>
&nbsp;            )
&nbsp;    );
&nbsp;
<b class="nc">&nbsp;    public static final Map&lt;EdgeVersion, Set&lt;String&gt;&gt; EXCLUDED_NODES_BY_EDGE_VERSION = Map.of(</b>
&nbsp;            EdgeVersion.V_4_1_0,
<b class="nc">&nbsp;            Set.of(</b>
<b class="nc">&nbsp;                    TbAiNode.class.getName()</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_4_0_0,
<b class="nc">&nbsp;            Set.of(</b>
<b class="nc">&nbsp;                    TbAiNode.class.getName()</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_3_9_0,
<b class="nc">&nbsp;            Set.of(</b>
<b class="nc">&nbsp;                    TbCalculatedFieldsNode.class.getName()</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_3_8_0,
<b class="nc">&nbsp;            Set.of(</b>
<b class="nc">&nbsp;                    TbCalculatedFieldsNode.class.getName()</b>
&nbsp;            ),
&nbsp;            EdgeVersion.V_3_7_0,
<b class="nc">&nbsp;            Set.of(</b>
<b class="nc">&nbsp;                    TbCalculatedFieldsNode.class.getName(),</b>
<b class="nc">&nbsp;                    TbSendRestApiCallReplyNode.class.getName(),</b>
<b class="nc">&nbsp;                    TbAwsLambdaNode.class.getName()</b>
&nbsp;            )
&nbsp;    );
&nbsp;
&nbsp;    public static AlarmUpdateMsg constructAlarmUpdatedMsg(UpdateMsgType msgType, Alarm alarm) {
<b class="nc">&nbsp;        return AlarmUpdateMsg.newBuilder().setMsgType(msgType)</b>
<b class="nc">&nbsp;                .setEntity(JacksonUtil.toString(alarm))</b>
<b class="nc">&nbsp;                .setIdMSB(alarm.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(alarm.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AlarmCommentUpdateMsg constructAlarmCommentUpdatedMsg(UpdateMsgType msgType, AlarmComment alarmComment) {
<b class="nc">&nbsp;        return AlarmCommentUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(alarmComment)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AssetUpdateMsg constructAssetUpdatedMsg(UpdateMsgType msgType, Asset asset) {
<b class="nc">&nbsp;        return AssetUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(asset))</b>
<b class="nc">&nbsp;                .setIdMSB(asset.getUuidId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(asset.getUuidId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AssetUpdateMsg constructAssetDeleteMsg(AssetId assetId) {
<b class="nc">&nbsp;        return AssetUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(assetId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(assetId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AssetProfileUpdateMsg constructAssetProfileUpdatedMsg(UpdateMsgType msgType, AssetProfile assetProfile) {
<b class="nc">&nbsp;        return AssetProfileUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(assetProfile))</b>
<b class="nc">&nbsp;                .setIdMSB(assetProfile.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(assetProfile.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AssetProfileUpdateMsg constructAssetProfileDeleteMsg(AssetProfileId assetProfileId) {
<b class="nc">&nbsp;        return AssetProfileUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(assetProfileId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(assetProfileId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CustomerUpdateMsg constructCustomerUpdatedMsg(UpdateMsgType msgType, Customer customer) {
<b class="nc">&nbsp;        return CustomerUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(customer))</b>
<b class="nc">&nbsp;                .setIdMSB(customer.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(customer.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CustomerUpdateMsg constructCustomerDeleteMsg(CustomerId customerId) {
<b class="nc">&nbsp;        return CustomerUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(customerId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(customerId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DashboardUpdateMsg constructDashboardUpdatedMsg(UpdateMsgType msgType, Dashboard dashboard) {
<b class="nc">&nbsp;        return DashboardUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(dashboard))</b>
<b class="nc">&nbsp;                .setIdMSB(dashboard.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(dashboard.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DashboardUpdateMsg constructDashboardDeleteMsg(DashboardId dashboardId) {
<b class="nc">&nbsp;        return DashboardUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(dashboardId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(dashboardId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceUpdateMsg constructDeviceUpdatedMsg(UpdateMsgType msgType, Device device) {
<b class="nc">&nbsp;        return DeviceUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(device))</b>
<b class="nc">&nbsp;                .setIdMSB(device.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(device.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceUpdateMsg constructDeviceDeleteMsg(DeviceId deviceId) {
<b class="nc">&nbsp;        return DeviceUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(deviceId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(deviceId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceCredentialsUpdateMsg constructDeviceCredentialsUpdatedMsg(DeviceCredentials deviceCredentials) {
<b class="nc">&nbsp;        return DeviceCredentialsUpdateMsg.newBuilder().setEntity(JacksonUtil.toString(deviceCredentials)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceProfileUpdateMsg constructDeviceProfileUpdatedMsg(UpdateMsgType msgType, DeviceProfile deviceProfile, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        String entity = getEntityAndFixLwm2mBootstrapShortServerId(deviceProfile, edgeVersion);</b>
<b class="nc">&nbsp;        return DeviceProfileUpdateMsg.newBuilder().setMsgType(msgType).setEntity(entity)</b>
<b class="nc">&nbsp;                .setIdMSB(deviceProfile.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(deviceProfile.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String getEntityAndFixLwm2mBootstrapShortServerId(DeviceProfile deviceProfile, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        DeviceProfileTransportConfiguration transportConfiguration = deviceProfile.getProfileData().getTransportConfiguration();</b>
<b class="nc">&nbsp;        if (!(transportConfiguration instanceof Lwm2mDeviceProfileTransportConfiguration) || EdgeVersionComparator.INSTANCE.compare(edgeVersion, EdgeVersion.V_4_3_0) &gt;= 0) {</b>
<b class="nc">&nbsp;            return JacksonUtil.toString(deviceProfile);</b>
&nbsp;        }
<b class="nc">&nbsp;        JsonNode jsonNode = JacksonUtil.valueToTree(deviceProfile);</b>
<b class="nc">&nbsp;        JsonNode profileDataNode = jsonNode.get(&quot;profileData&quot;);</b>
<b class="nc">&nbsp;        if (profileDataNode != null &amp;&amp; profileDataNode.has(&quot;transportConfiguration&quot;)) {</b>
<b class="nc">&nbsp;            JsonNode transportConfigNode = profileDataNode.get(&quot;transportConfiguration&quot;);</b>
<b class="nc">&nbsp;            JsonNode bootstrapNode = transportConfigNode.get(&quot;bootstrap&quot;);</b>
<b class="nc">&nbsp;            if (bootstrapNode != null &amp;&amp; bootstrapNode.isArray()) {</b>
<b class="nc">&nbsp;                for (JsonNode bootstrapServerNode : bootstrapNode) {</b>
<b class="nc">&nbsp;                    if (bootstrapServerNode.isObject()) {</b>
<b class="nc">&nbsp;                        ObjectNode serverObjectNode = (ObjectNode) bootstrapServerNode;</b>
<b class="nc">&nbsp;                        JsonNode isBootstrapNode = serverObjectNode.get(&quot;bootstrapServerIs&quot;);</b>
<b class="nc">&nbsp;                        boolean isBootstrapServer = isBootstrapNode != null &amp;&amp; isBootstrapNode.asBoolean(false);</b>
<b class="nc">&nbsp;                        JsonNode shortServerIdNode = serverObjectNode.get(&quot;shortServerId&quot;);</b>
<b class="nc">&nbsp;                        if (isBootstrapServer &amp;&amp; (shortServerIdNode == null || shortServerIdNode.isNull())) {</b>
<b class="nc">&nbsp;                            serverObjectNode.put(&quot;shortServerId&quot;, 0);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return JacksonUtil.toString(jsonNode);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceProfileUpdateMsg constructDeviceProfileDeleteMsg(DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        return DeviceProfileUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(deviceProfileId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(deviceProfileId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static DeviceRpcCallMsg constructDeviceRpcCallMsg(UUID deviceId, JsonNode body) {
<b class="nc">&nbsp;        DeviceRpcCallMsg.Builder builder = constructDeviceRpcMsg(deviceId, body);</b>
<b class="nc">&nbsp;        if (body.has(&quot;error&quot;) || body.has(&quot;response&quot;)) {</b>
<b class="nc">&nbsp;            RpcResponseMsg.Builder responseBuilder = RpcResponseMsg.newBuilder();</b>
<b class="nc">&nbsp;            if (body.has(&quot;error&quot;)) {</b>
<b class="nc">&nbsp;                responseBuilder.setError(body.get(&quot;error&quot;).asText());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                responseBuilder.setResponse(body.get(&quot;response&quot;).asText());</b>
&nbsp;            }
<b class="nc">&nbsp;            builder.setResponseMsg(responseBuilder.build());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            RpcRequestMsg.Builder requestBuilder = RpcRequestMsg.newBuilder();</b>
<b class="nc">&nbsp;            requestBuilder.setMethod(body.get(&quot;method&quot;).asText());</b>
<b class="nc">&nbsp;            requestBuilder.setParams(body.get(&quot;params&quot;).asText());</b>
<b class="nc">&nbsp;            builder.setRequestMsg(requestBuilder.build());</b>
&nbsp;        }
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static DeviceRpcCallMsg.Builder constructDeviceRpcMsg(UUID deviceId, JsonNode body) {
<b class="nc">&nbsp;        DeviceRpcCallMsg.Builder builder = DeviceRpcCallMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setDeviceIdMSB(deviceId.getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceIdLSB(deviceId.getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setRequestId(body.get(&quot;requestId&quot;).asInt());</b>
<b class="nc">&nbsp;        if (body.get(&quot;oneway&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setOneway(body.get(&quot;oneway&quot;).asBoolean());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;requestUUID&quot;) != null) {</b>
<b class="nc">&nbsp;            UUID requestUUID = UUID.fromString(body.get(&quot;requestUUID&quot;).asText());</b>
<b class="nc">&nbsp;            builder.setRequestUuidMSB(requestUUID.getMostSignificantBits())</b>
<b class="nc">&nbsp;                    .setRequestUuidLSB(requestUUID.getLeastSignificantBits());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;expirationTime&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setExpirationTime(body.get(&quot;expirationTime&quot;).asLong());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;persisted&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setPersisted(body.get(&quot;persisted&quot;).asBoolean());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;retries&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setRetries(body.get(&quot;retries&quot;).asInt());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;additionalInfo&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setAdditionalInfo(JacksonUtil.toString(body.get(&quot;additionalInfo&quot;)));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;serviceId&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setServiceId(body.get(&quot;serviceId&quot;).asText());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (body.get(&quot;sessionId&quot;) != null) {</b>
<b class="nc">&nbsp;            builder.setSessionId(body.get(&quot;sessionId&quot;).asText());</b>
&nbsp;        }
<b class="nc">&nbsp;        return builder;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static EdgeConfiguration constructEdgeConfiguration(Edge edge) {
<b class="nc">&nbsp;        EdgeConfiguration.Builder builder = EdgeConfiguration.newBuilder()</b>
<b class="nc">&nbsp;                .setEdgeIdMSB(edge.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setEdgeIdLSB(edge.getId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdMSB(edge.getTenantId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdLSB(edge.getTenantId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setName(edge.getName())</b>
<b class="nc">&nbsp;                .setType(edge.getType())</b>
<b class="nc">&nbsp;                .setRoutingKey(edge.getRoutingKey())</b>
<b class="nc">&nbsp;                .setSecret(edge.getSecret())</b>
<b class="nc">&nbsp;                .setAdditionalInfo(JacksonUtil.toString(edge.getAdditionalInfo()))</b>
<b class="nc">&nbsp;                .setCloudType(&quot;CE&quot;);</b>
<b class="nc">&nbsp;        if (edge.getCustomerId() != null) {</b>
<b class="nc">&nbsp;            builder.setCustomerIdMSB(edge.getCustomerId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                    .setCustomerIdLSB(edge.getCustomerId().getId().getLeastSignificantBits());</b>
&nbsp;        }
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static EntityViewUpdateMsg constructEntityViewUpdatedMsg(UpdateMsgType msgType, EntityView entityView) {
<b class="nc">&nbsp;        return EntityViewUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(entityView))</b>
<b class="nc">&nbsp;                .setIdMSB(entityView.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(entityView.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static EntityViewUpdateMsg constructEntityViewDeleteMsg(EntityViewId entityViewId) {
<b class="nc">&nbsp;        return EntityViewUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(entityViewId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(entityViewId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationRuleUpdateMsg constructNotificationRuleUpdateMsg(UpdateMsgType msgType, NotificationRule notificationRule) {
<b class="nc">&nbsp;        return NotificationRuleUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(notificationRule)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationRuleUpdateMsg constructNotificationRuleDeleteMsg(NotificationRuleId notificationRuleId) {
<b class="nc">&nbsp;        return NotificationRuleUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(notificationRuleId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(notificationRuleId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationTargetUpdateMsg constructNotificationTargetUpdateMsg(UpdateMsgType msgType, NotificationTarget notificationTarget) {
<b class="nc">&nbsp;        return NotificationTargetUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(notificationTarget)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationTargetUpdateMsg constructNotificationTargetDeleteMsg(NotificationTargetId notificationTargetId) {
<b class="nc">&nbsp;        return NotificationTargetUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(notificationTargetId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(notificationTargetId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationTemplateUpdateMsg constructNotificationTemplateUpdateMsg(UpdateMsgType msgType, NotificationTemplate notificationTemplate) {
<b class="nc">&nbsp;        return NotificationTemplateUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(notificationTemplate)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static NotificationTemplateUpdateMsg constructNotificationTemplateDeleteMsg(NotificationTemplateId notificationTemplateId) {
<b class="nc">&nbsp;        return NotificationTemplateUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(notificationTemplateId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(notificationTemplateId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OAuth2ClientUpdateMsg constructOAuth2ClientUpdateMsg(UpdateMsgType msgType, OAuth2Client oAuth2Client) {
<b class="nc">&nbsp;        return OAuth2ClientUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(oAuth2Client))</b>
<b class="nc">&nbsp;                .setIdMSB(oAuth2Client.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(oAuth2Client.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OAuth2ClientUpdateMsg constructOAuth2ClientDeleteMsg(OAuth2ClientId oAuth2ClientId) {
<b class="nc">&nbsp;        return OAuth2ClientUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(oAuth2ClientId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(oAuth2ClientId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OAuth2DomainUpdateMsg constructOAuth2DomainUpdateMsg(UpdateMsgType msgType, DomainInfo domainInfo) {
<b class="nc">&nbsp;        return OAuth2DomainUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(domainInfo))</b>
<b class="nc">&nbsp;                .setIdMSB(domainInfo.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(domainInfo.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OAuth2DomainUpdateMsg constructOAuth2DomainDeleteMsg(DomainId domainId) {
<b class="nc">&nbsp;        return OAuth2DomainUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(domainId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(domainId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OtaPackageUpdateMsg constructOtaPackageUpdatedMsg(UpdateMsgType msgType, OtaPackage otaPackage) {
<b class="nc">&nbsp;        return OtaPackageUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(otaPackage))</b>
<b class="nc">&nbsp;                .setIdMSB(otaPackage.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(otaPackage.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static OtaPackageUpdateMsg constructOtaPackageDeleteMsg(OtaPackageId otaPackageId) {
<b class="nc">&nbsp;        return OtaPackageUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(otaPackageId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(otaPackageId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static QueueUpdateMsg constructQueueUpdatedMsg(UpdateMsgType msgType, Queue queue) {
<b class="nc">&nbsp;        return QueueUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(queue))</b>
<b class="nc">&nbsp;                .setIdMSB(queue.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(queue.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static QueueUpdateMsg constructQueueDeleteMsg(QueueId queueId) {
<b class="nc">&nbsp;        return QueueUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(queueId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(queueId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static RelationUpdateMsg constructRelationUpdatedMsg(UpdateMsgType msgType, EntityRelation entityRelation) {
<b class="nc">&nbsp;        return RelationUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(entityRelation)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ResourceUpdateMsg constructResourceUpdatedMsg(UpdateMsgType msgType, TbResource tbResource) {
<b class="nc">&nbsp;        return ResourceUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(tbResource))</b>
<b class="nc">&nbsp;                .setIdMSB(tbResource.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(tbResource.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static ResourceUpdateMsg constructResourceDeleteMsg(TbResourceId tbResourceId) {
<b class="nc">&nbsp;        return ResourceUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(tbResourceId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(tbResourceId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static RuleChainUpdateMsg constructRuleChainUpdatedMsg(UpdateMsgType msgType, RuleChain ruleChain, boolean isRoot) {
<b class="nc">&nbsp;        boolean isTemplateRoot = ruleChain.isRoot();</b>
<b class="nc">&nbsp;        ruleChain.setRoot(isRoot);</b>
<b class="nc">&nbsp;        RuleChainUpdateMsg result = RuleChainUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(ruleChain))</b>
<b class="nc">&nbsp;                .setIdMSB(ruleChain.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(ruleChain.getId().getId().getLeastSignificantBits()).build();</b>
<b class="nc">&nbsp;        ruleChain.setRoot(isTemplateRoot);</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static RuleChainUpdateMsg constructRuleChainDeleteMsg(RuleChainId ruleChainId) {
<b class="nc">&nbsp;        return RuleChainUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(ruleChainId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(ruleChainId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static RuleChainMetadataUpdateMsg constructRuleChainMetadataUpdatedMsg(UpdateMsgType msgType, RuleChainMetaData ruleChainMetaData, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        String metaData = sanitizeMetadataForLegacyEdgeVersion(ruleChainMetaData, edgeVersion);</b>
&nbsp;
<b class="nc">&nbsp;        return RuleChainMetadataUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(msgType)</b>
<b class="nc">&nbsp;                .setEntity(metaData)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static String sanitizeMetadataForLegacyEdgeVersion(RuleChainMetaData ruleChainMetaData, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        JsonNode jsonNode = JacksonUtil.valueToTree(ruleChainMetaData);</b>
<b class="nc">&nbsp;        JsonNode nodes = jsonNode.get(&quot;nodes&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        updateNodeConfigurationsForLegacyEdge(nodes, edgeVersion);</b>
<b class="nc">&nbsp;        removeExcludedNodesForLegacyEdge(nodes, edgeVersion);</b>
&nbsp;
<b class="nc">&nbsp;        return JacksonUtil.toString(jsonNode);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static void updateNodeConfigurationsForLegacyEdge(JsonNode nodes, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        nodes.forEach(node -&gt; {</b>
<b class="nc">&nbsp;            if (node.isObject() &amp;&amp; node.has(&quot;configuration&quot;)) {</b>
<b class="nc">&nbsp;                String nodeType = node.get(&quot;type&quot;).asText();</b>
<b class="nc">&nbsp;                Map&lt;String, String&gt; ignoredParams = IGNORED_PARAMS_BY_EDGE_VERSION.get(edgeVersion);</b>
&nbsp;
<b class="nc">&nbsp;                if (ignoredParams != null &amp;&amp; ignoredParams.containsKey(nodeType)) {</b>
<b class="nc">&nbsp;                    ((ObjectNode) node.get(&quot;configuration&quot;)).remove(ignoredParams.get(nodeType));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private static void removeExcludedNodesForLegacyEdge(JsonNode nodes, EdgeVersion edgeVersion) {
<b class="nc">&nbsp;        Iterator&lt;JsonNode&gt; iterator = nodes.iterator();</b>
&nbsp;
<b class="nc">&nbsp;        while (iterator.hasNext()) {</b>
<b class="nc">&nbsp;            JsonNode node = iterator.next();</b>
<b class="nc">&nbsp;            String type = node.get(&quot;type&quot;).asText();</b>
<b class="nc">&nbsp;            Set&lt;String&gt; missNodes = EXCLUDED_NODES_BY_EDGE_VERSION.get(edgeVersion);</b>
&nbsp;
<b class="nc">&nbsp;            if (missNodes != null &amp;&amp; missNodes.contains(type)) {</b>
<b class="nc">&nbsp;                iterator.remove();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static EntityDataProto constructEntityDataMsg(TenantId tenantId, EntityId entityId, EdgeEventActionType actionType, JsonElement entityData) {
<b class="nc">&nbsp;        EntityDataProto.Builder builder = EntityDataProto.newBuilder()</b>
<b class="nc">&nbsp;                .setEntityIdMSB(entityId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setEntityIdLSB(entityId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setEntityType(entityId.getEntityType().name());</b>
<b class="nc">&nbsp;        long ts = extractTs(entityData.getAsJsonObject());</b>
<b class="nc">&nbsp;        switch (actionType) {</b>
&nbsp;            case TIMESERIES_UPDATED:
&nbsp;                try {
<b class="nc">&nbsp;                    JsonObject data = entityData.getAsJsonObject();</b>
<b class="nc">&nbsp;                    builder.setPostTelemetryMsg(JsonConverter.convertToTelemetryProto(data.getAsJsonObject(&quot;data&quot;), ts));</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.trace(&quot;[{}][{}] Can&#39;t convert to telemetry proto, entityData [{}]&quot;, tenantId, entityId, entityData, e);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case ATTRIBUTES_UPDATED:
&nbsp;                try {
<b class="nc">&nbsp;                    JsonObject data = entityData.getAsJsonObject();</b>
<b class="nc">&nbsp;                    TransportProtos.PostAttributeMsg attributesUpdatedMsg = JsonConverter.convertToAttributesProto(data.getAsJsonObject(&quot;kv&quot;));</b>
<b class="nc">&nbsp;                    if (data.has(&quot;isPostAttributes&quot;) &amp;&amp; data.getAsJsonPrimitive(&quot;isPostAttributes&quot;).getAsBoolean()) {</b>
<b class="nc">&nbsp;                        builder.setPostAttributesMsg(attributesUpdatedMsg);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        builder.setAttributesUpdatedMsg(attributesUpdatedMsg);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    builder.setPostAttributeScope(getScopeOfDefault(data));</b>
<b class="nc">&nbsp;                    builder.setAttributeTs(ts);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.trace(&quot;[{}][{}] Can&#39;t convert to AttributesUpdatedMsg proto, entityData [{}]&quot;, tenantId, entityId, entityData, e);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case POST_ATTRIBUTES:
&nbsp;                try {
<b class="nc">&nbsp;                    JsonObject data = entityData.getAsJsonObject();</b>
<b class="nc">&nbsp;                    TransportProtos.PostAttributeMsg postAttributesMsg = JsonConverter.convertToAttributesProto(data.getAsJsonObject(&quot;kv&quot;));</b>
<b class="nc">&nbsp;                    builder.setPostAttributesMsg(postAttributesMsg);</b>
<b class="nc">&nbsp;                    builder.setPostAttributeScope(getScopeOfDefault(data));</b>
<b class="nc">&nbsp;                    builder.setAttributeTs(ts);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.trace(&quot;[{}][{}] Can&#39;t convert to PostAttributesMsg, entityData [{}]&quot;, tenantId, entityId, entityData, e);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case ATTRIBUTES_DELETED:
&nbsp;                try {
<b class="nc">&nbsp;                    AttributeDeleteMsg.Builder attributeDeleteMsg = AttributeDeleteMsg.newBuilder();</b>
<b class="nc">&nbsp;                    attributeDeleteMsg.setScope(entityData.getAsJsonObject().getAsJsonPrimitive(&quot;scope&quot;).getAsString());</b>
<b class="nc">&nbsp;                    JsonArray jsonArray = entityData.getAsJsonObject().getAsJsonArray(&quot;keys&quot;);</b>
<b class="nc">&nbsp;                    List&lt;String&gt; keys = new Gson().fromJson(jsonArray.toString(), new TypeToken&lt;&gt;() {}.getType());</b>
<b class="nc">&nbsp;                    attributeDeleteMsg.addAllAttributeNames(keys);</b>
<b class="nc">&nbsp;                    attributeDeleteMsg.build();</b>
<b class="nc">&nbsp;                    builder.setAttributeDeleteMsg(attributeDeleteMsg);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.trace(&quot;[{}][{}] Can&#39;t convert to AttributeDeleteMsg proto, entityData [{}]&quot;, tenantId, entityId, entityData, e);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static long extractTs(JsonObject data) {
<b class="nc">&nbsp;        if (data.has(&quot;ts&quot;) &amp;&amp; data.get(&quot;ts&quot;).isJsonPrimitive()) {</b>
<b class="nc">&nbsp;            return data.getAsJsonPrimitive(&quot;ts&quot;).getAsLong();</b>
&nbsp;        }
<b class="nc">&nbsp;        return System.currentTimeMillis();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static String getScopeOfDefault(JsonObject data) {
<b class="nc">&nbsp;        JsonPrimitive scope = data.getAsJsonPrimitive(&quot;scope&quot;);</b>
<b class="nc">&nbsp;        String result = DataConstants.SERVER_SCOPE;</b>
<b class="nc">&nbsp;        if (scope != null &amp;&amp; StringUtils.isNotBlank(scope.getAsString())) {</b>
<b class="nc">&nbsp;            result = scope.getAsString();</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TenantUpdateMsg constructTenantUpdateMsg(UpdateMsgType msgType, Tenant tenant) {
<b class="nc">&nbsp;        return TenantUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(tenant)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static TenantProfileUpdateMsg constructTenantProfileUpdateMsg(UpdateMsgType msgType, TenantProfile tenantProfile) {
<b class="nc">&nbsp;        return TenantProfileUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(tenantProfile)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static UserUpdateMsg constructUserUpdatedMsg(UpdateMsgType msgType, User user) {
<b class="nc">&nbsp;        return UserUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(user))</b>
<b class="nc">&nbsp;                .setIdMSB(user.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(user.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static UserUpdateMsg constructUserDeleteMsg(UserId userId) {
<b class="nc">&nbsp;        return UserUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(userId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(userId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static UserCredentialsUpdateMsg constructUserCredentialsUpdatedMsg(UserCredentials userCredentials) {
<b class="nc">&nbsp;        return UserCredentialsUpdateMsg.newBuilder().setEntity(JacksonUtil.toString(userCredentials)).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static WidgetsBundleUpdateMsg constructWidgetsBundleUpdateMsg(UpdateMsgType msgType, WidgetsBundle widgetsBundle, List&lt;String&gt; widgets) {
<b class="nc">&nbsp;        return WidgetsBundleUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(widgetsBundle))</b>
<b class="nc">&nbsp;                .setWidgets(JacksonUtil.toString(widgets))</b>
<b class="nc">&nbsp;                .setIdMSB(widgetsBundle.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(widgetsBundle.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static WidgetsBundleUpdateMsg constructWidgetsBundleDeleteMsg(WidgetsBundleId widgetsBundleId) {
<b class="nc">&nbsp;        return WidgetsBundleUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(widgetsBundleId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(widgetsBundleId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static WidgetTypeUpdateMsg constructWidgetTypeUpdateMsg(UpdateMsgType msgType, WidgetTypeDetails widgetTypeDetails) {
<b class="nc">&nbsp;        return WidgetTypeUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(widgetTypeDetails))</b>
<b class="nc">&nbsp;                .setIdMSB(widgetTypeDetails.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(widgetTypeDetails.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static WidgetTypeUpdateMsg constructWidgetTypeDeleteMsg(WidgetTypeId widgetTypeId) {
<b class="nc">&nbsp;        return WidgetTypeUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(widgetTypeId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(widgetTypeId.getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldUpdateMsg constructCalculatedFieldUpdatedMsg(UpdateMsgType msgType, CalculatedField calculatedField) {
<b class="nc">&nbsp;        return CalculatedFieldUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(calculatedField))</b>
<b class="nc">&nbsp;                .setIdMSB(calculatedField.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(calculatedField.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static CalculatedFieldUpdateMsg constructCalculatedFieldDeleteMsg(CalculatedFieldId calculatedFieldId) {
<b class="nc">&nbsp;        return CalculatedFieldUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(calculatedFieldId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(calculatedFieldId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AiModelUpdateMsg constructAiModelUpdatedMsg(UpdateMsgType msgType, AiModel aiModel) {
<b class="nc">&nbsp;        return AiModelUpdateMsg.newBuilder().setMsgType(msgType).setEntity(JacksonUtil.toString(aiModel))</b>
<b class="nc">&nbsp;                .setIdMSB(aiModel.getId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(aiModel.getId().getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static AiModelUpdateMsg constructAiModelDeleteMsg(AiModelId aiModelId) {
<b class="nc">&nbsp;        return AiModelUpdateMsg.newBuilder()</b>
<b class="nc">&nbsp;                .setMsgType(UpdateMsgType.ENTITY_DELETED_RPC_MESSAGE)</b>
<b class="nc">&nbsp;                .setIdMSB(aiModelId.getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setIdLSB(aiModelId.getId().getLeastSignificantBits()).build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static List&lt;EdgeEvent&gt; mergeAndFilterDownlinkDuplicates(List&lt;EdgeEvent&gt; edgeEvents) {
&nbsp;        try {
<b class="nc">&nbsp;            edgeEvents = removeDownlinkDuplicates(edgeEvents);</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;AttrUpdateMsg&gt; attrUpdateMsgs = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EdgeEvent edgeEvent : edgeEvents) {</b>
<b class="nc">&nbsp;                if (EdgeEventActionType.ATTRIBUTES_UPDATED.equals(edgeEvent.getAction())) {</b>
<b class="nc">&nbsp;                    attrUpdateMsgs.add(new AttrUpdateMsg(edgeEvent.getEntityId(), edgeEvent.getBody()));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            Map&lt;UUID, Map&lt;String, Long&gt;&gt; latestTsByEntityAndKey = computeLatestTsByEntityAndKey(attrUpdateMsgs);</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;EdgeEvent&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EdgeEvent edgeEvent : edgeEvents) {</b>
<b class="nc">&nbsp;                if (!EdgeEventActionType.ATTRIBUTES_UPDATED.equals(edgeEvent.getAction())) {</b>
<b class="nc">&nbsp;                    result.add(edgeEvent);</b>
&nbsp;                    continue;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Map&lt;String, Long&gt; latestByKey = latestTsByEntityAndKey.get(edgeEvent.getEntityId());</b>
<b class="nc">&nbsp;                JsonNode filteredBody = filterAttributesBody(edgeEvent.getBody(), latestByKey);</b>
<b class="nc">&nbsp;                if (filteredBody == null) {</b>
&nbsp;                    continue;
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                result.add(createFilteredEdgeEvent(edgeEvent, filteredBody));</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            result.sort(Comparator.comparingLong(EdgeEvent::getSeqId));</b>
<b class="nc">&nbsp;            return result;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.info(&quot;Can&#39;t merge downlink duplicates. Sending downlinks without merge. Original edgeEvents [{}]&quot;, edgeEvents, e);</b>
<b class="nc">&nbsp;            return edgeEvents;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static AttrsTs extractAttributes(JsonNode body) {
<b class="nc">&nbsp;        if (body == null) {</b>
<b class="nc">&nbsp;            return new AttrsTs(0L, List.of());</b>
&nbsp;        }
<b class="nc">&nbsp;        String bodyStr = JacksonUtil.toString(body);</b>
<b class="nc">&nbsp;        var jsonObject = JsonParser.parseString(bodyStr).getAsJsonObject();</b>
<b class="nc">&nbsp;        if (!jsonObject.has(&quot;ts&quot;)) {</b>
<b class="nc">&nbsp;            return new AttrsTs(0L, List.of());</b>
&nbsp;        }
<b class="nc">&nbsp;        long ts = jsonObject.get(&quot;ts&quot;).getAsLong();</b>
<b class="nc">&nbsp;        var kv = jsonObject.getAsJsonObject(&quot;kv&quot;);</b>
<b class="nc">&nbsp;        List&lt;AttributeKvEntry&gt; attrs = JsonConverter.convertToAttributes(</b>
<b class="nc">&nbsp;                JsonUtils.getJsonObject(</b>
<b class="nc">&nbsp;                        JsonConverter.convertToAttributesProto(kv).getKvList()</b>
&nbsp;                ), ts);
<b class="nc">&nbsp;        return new AttrsTs(ts, attrs);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static JsonNode filterAttributesBody(JsonNode body, Map&lt;String, Long&gt; latestByKey) {
<b class="nc">&nbsp;        if (body == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        String bodyStr = JacksonUtil.toString(body);</b>
<b class="nc">&nbsp;        JsonObject jsonObject = JsonParser.parseString(bodyStr).getAsJsonObject();</b>
<b class="nc">&nbsp;        if (jsonObject.has(&quot;ts&quot;) &amp;&amp; latestByKey != null &amp;&amp; !latestByKey.isEmpty()) {</b>
<b class="nc">&nbsp;            long ts = jsonObject.get(&quot;ts&quot;).getAsLong();</b>
<b class="nc">&nbsp;            JsonObject kv = jsonObject.getAsJsonObject(&quot;kv&quot;);</b>
<b class="nc">&nbsp;            for (Iterator&lt;Map.Entry&lt;String, JsonElement&gt;&gt; it = kv.entrySet().iterator(); it.hasNext(); ) {</b>
<b class="nc">&nbsp;                Map.Entry&lt;String, JsonElement&gt; e = it.next();</b>
<b class="nc">&nbsp;                Long latestTs = latestByKey.get(e.getKey());</b>
<b class="nc">&nbsp;                if (latestTs == null || !latestTs.equals(ts)) {</b>
<b class="nc">&nbsp;                    it.remove();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (kv.isEmpty()) {</b>
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return JacksonUtil.toJsonNode(jsonObject.toString());</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Map&lt;UUID, Map&lt;String, Long&gt;&gt; computeLatestTsByEntityAndKey(List&lt;AttrUpdateMsg&gt; attrUpdateMsgs) {
<b class="nc">&nbsp;        Map&lt;UUID, Map&lt;String, Long&gt;&gt; latestTsByEntityAndKey = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (AttrUpdateMsg attrUpdateMsg : attrUpdateMsgs) {</b>
<b class="nc">&nbsp;            UUID entityId = attrUpdateMsg.entityId();</b>
<b class="nc">&nbsp;            AttrsTs attrsTs = extractAttributes(attrUpdateMsg.body());</b>
<b class="nc">&nbsp;            Map&lt;String, Long&gt; map = latestTsByEntityAndKey.computeIfAbsent(entityId, id -&gt; new HashMap&lt;&gt;());</b>
<b class="nc">&nbsp;            long ts = attrsTs.ts();</b>
<b class="nc">&nbsp;            for (AttributeKvEntry attr : attrsTs.attrs()) {</b>
<b class="nc">&nbsp;                map.merge(attr.getKey(), ts, Math::max);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return latestTsByEntityAndKey;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static EdgeEvent createFilteredEdgeEvent(EdgeEvent edgeEvent, JsonNode filteredBody) {
<b class="nc">&nbsp;        EdgeEvent filtered = new EdgeEvent();</b>
<b class="nc">&nbsp;        filtered.setSeqId(edgeEvent.getSeqId());</b>
<b class="nc">&nbsp;        filtered.setTenantId(edgeEvent.getTenantId());</b>
<b class="nc">&nbsp;        filtered.setEdgeId(edgeEvent.getEdgeId());</b>
<b class="nc">&nbsp;        filtered.setAction(edgeEvent.getAction());</b>
<b class="nc">&nbsp;        filtered.setEntityId(edgeEvent.getEntityId());</b>
<b class="nc">&nbsp;        filtered.setUid(edgeEvent.getUid());</b>
<b class="nc">&nbsp;        filtered.setType(edgeEvent.getType());</b>
<b class="nc">&nbsp;        filtered.setBody(filteredBody);</b>
<b class="nc">&nbsp;        return filtered;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static List&lt;EdgeEvent&gt; removeDownlinkDuplicates(List&lt;EdgeEvent&gt; edgeEvents) {
<b class="nc">&nbsp;        Set&lt;EventKey&gt; seen = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        return edgeEvents.stream()</b>
<b class="nc">&nbsp;                .filter(e -&gt; seen.add(new EventKey(</b>
<b class="nc">&nbsp;                        e.getTenantId(),</b>
<b class="nc">&nbsp;                        e.getAction(),</b>
<b class="nc">&nbsp;                        e.getEntityId(),</b>
<b class="nc">&nbsp;                        e.getType().name(),</b>
<b class="nc">&nbsp;                        (e.getBody() != null ? e.getBody().toString() : &quot;null&quot;))))</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private record EventKey(TenantId tenantId,</b>
&nbsp;                            EdgeEventActionType action,
&nbsp;                            UUID entityId,
&nbsp;                            String type,
&nbsp;                            String body) {
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private record AttrsTs(long ts, List&lt;AttributeKvEntry&gt; attrs) {</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private record AttrUpdateMsg(UUID entityId, JsonNode body) {</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

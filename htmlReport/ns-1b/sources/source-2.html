<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbAiNode</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.rule.engine.ai</a>
</div>

<h1>Coverage Summary for Class: TbAiNode (org.thingsboard.rule.engine.ai)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbAiNode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/109)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TbAiNode$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TbAiNode$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/120)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.rule.engine.ai;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import dev.langchain4j.data.message.ChatMessage;
&nbsp;import dev.langchain4j.data.message.Content;
&nbsp;import dev.langchain4j.data.message.ImageContent;
&nbsp;import dev.langchain4j.data.message.PdfFileContent;
&nbsp;import dev.langchain4j.data.message.SystemMessage;
&nbsp;import dev.langchain4j.data.message.TextContent;
&nbsp;import dev.langchain4j.data.message.UserMessage;
&nbsp;import dev.langchain4j.model.chat.request.ChatRequest;
&nbsp;import dev.langchain4j.model.chat.request.ResponseFormat;
&nbsp;import dev.langchain4j.model.chat.response.ChatResponse;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.checkerframework.checker.nullness.qual.NonNull;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.rule.engine.api.RuleNode;
&nbsp;import org.thingsboard.rule.engine.api.TbContext;
&nbsp;import org.thingsboard.rule.engine.api.TbNode;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeConfiguration;
&nbsp;import org.thingsboard.rule.engine.api.TbNodeException;
&nbsp;import org.thingsboard.rule.engine.api.util.TbNodeUtils;
&nbsp;import org.thingsboard.rule.engine.external.TbAbstractExternalNode;
&nbsp;import org.thingsboard.server.common.data.GeneralFileDescriptor;
&nbsp;import org.thingsboard.server.common.data.ResourceType;
&nbsp;import org.thingsboard.server.common.data.TbResourceDataInfo;
&nbsp;import org.thingsboard.server.common.data.TbResourceInfo;
&nbsp;import org.thingsboard.server.common.data.ai.AiModel;
&nbsp;import org.thingsboard.server.common.data.ai.model.AiModelType;
&nbsp;import org.thingsboard.server.common.data.ai.model.chat.AiChatModelConfig;
&nbsp;import org.thingsboard.server.common.data.id.AiModelId;
&nbsp;import org.thingsboard.server.common.data.id.TbResourceId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentType;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainType;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.resource.TbResourceDataCache;
&nbsp;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Base64;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.NoSuchElementException;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.thingsboard.rule.engine.ai.TbResponseFormat.TbResponseFormatType;
&nbsp;import static org.thingsboard.server.dao.service.ConstraintValidator.validateFields;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RuleNode(
&nbsp;        type = ComponentType.EXTERNAL,
&nbsp;        name = &quot;AI request&quot;,
&nbsp;        nodeDescription = &quot;Sends a request to an AI model using system and user prompts. Supports JSON mode.&quot;,
&nbsp;        nodeDetails = &quot;&quot;&quot;
&nbsp;                Interact with large language models (LLMs) by sending dynamic requests from your rule chain.
&nbsp;                You can select a specific &lt;strong&gt;AI model&lt;/strong&gt; and define its behavior using a &lt;strong&gt;system prompt&lt;/strong&gt; (optional context or role) and a &lt;strong&gt;user prompt&lt;/strong&gt; (the main task).
&nbsp;                Both prompts can be populated with data and metadata from the incoming message using patterns.
&nbsp;                For example, the &lt;code&gt;$[*]&lt;/code&gt; and &lt;code&gt;${*}&lt;/code&gt; patterns allow you to access the all message body and all metadata, respectively.
&nbsp;                &lt;br&gt;&lt;br&gt;
&nbsp;                After sending the request, the node waits for a response within a configured &lt;strong&gt;timeout&lt;/strong&gt;.
&nbsp;                You can specify the desired &lt;strong&gt;response format&lt;/strong&gt; as &lt;strong&gt;Text&lt;/strong&gt;, &lt;strong&gt;JSON&lt;/strong&gt;, or provide a specific &lt;strong&gt;JSON Schema&lt;/strong&gt; to structure the output.
&nbsp;                The AI-generated content is forwarded as the body of the outgoing message; the originator, message type, and metadata from the incoming message remain unchanged.
&nbsp;                &lt;br&gt;&lt;br&gt;
&nbsp;                Output connections: &lt;code&gt;Success&lt;/code&gt;, &lt;code&gt;Failure&lt;/code&gt;.
&nbsp;                &quot;&quot;&quot;,
&nbsp;        configClazz = TbAiNodeConfiguration.class,
&nbsp;        configDirective = &quot;tbExternalNodeAiConfig&quot;,
&nbsp;        iconUrl = &quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDkiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OSA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0zOC42MzExIDE3LjA3OTVDNDAuMTcwNSAxNy4wNzk2IDQxLjY1MTggMTcuNjg3MiA0Mi43NDc4IDE4Ljc3NjNDNDMuODQ0OCAxOS44NjYzIDQ0LjQ2NTkgMjEuMzUwMSA0NC40NjU5IDIyLjkwMjlWMzUuNDY1MkM0NC40NjU5IDM2LjM1MDkgNDQuMzU2NyAzNy4wNzY5IDQ0LjA5NzMgMzcuNzUxN0M0My44NDE0IDM4LjQxNjcgNDMuNDY1MSAzOC45NjE0IDQzLjA0NDggMzkuNTAyOEM0Mi40NjY3IDQwLjI0NzIgNDEuNjU2MyA0MC42ODU5IDQwLjg5MTkgNDAuOTM4OEM0MC4xMjExIDQxLjE5MzcgMzkuMzE0MyA0MS4yODg1IDM4LjYzMTEgNDEuMjg4NUgzMS4wMjU5TDIzLjM4MTIgNDUuODQ2NEMyMy4wNDMxIDQ2LjA0NzggMjIuNjI0MSA0Ni4wNTA3IDIyLjI4MzkgNDUuODUyOUMyMS45NDM3IDQ1LjY1NDcgMjEuNzMzOCA0NS4yODU5IDIxLjczMzcgNDQuODg3MlY0MS4yODg1SDE5LjY2NjNDMTguMTI2OSA0MS4yODg0IDE2LjY0NTUgNDAuNjgwOSAxNS41NDk2IDM5LjU5MThDMTQuNDUyNyAzOC41MDE5IDEzLjgzMTUgMzcuMDE3OSAxMy44MzE1IDM1LjQ2NTJWMjIuOTAyOUMxMy44MzE1IDIyLjMyMDIgMTMuOTE4NSAyMS43NDY4IDE0LjA4NTggMjEuMjAwN0wxNi4yODg5IDIxLjgxMDFMMTcuMjA5OSAyNS4yNTAyQzE3Ljk0MTYgMjcuOTg0NSAyMS43NTYyIDI3Ljk4NDQgMjIuNDg4IDI1LjI1MDJMMjMuNDA3OSAyMS44MTAxTDI2Ljc5MTcgMjAuODc0OUMyOC41NzkxIDIwLjM4MDUgMjkuMTc3IDE4LjUwMjYgMjguNTg4OCAxNy4wNzk1SDM4LjYzMTFaTTIyLjU4NDIgMzEuNTM5NUMyMS45OCAzMS41Mzk3IDIxLjQ5MDEgMzIuMDM3NiAyMS40OTAxIDMyLjY1MTlDMjEuNDkwMiAzMy4yNjYgMjEuOTgwMSAzMy43NjQgMjIuNTg0MiAzMy43NjQySDM0LjYxOTFDMzUuMjIzMyAzMy43NjQyIDM1LjcxMzEgMzMuMjY2MSAzNS43MTMyIDMyLjY1MTlDMzUuNzEzMiAzMi4wMzc1IDM1LjIyMzQgMzEuNTM5NSAzNC42MTkxIDMxLjUzOTVIMjIuNTg0MlpNMjQuNzcyMyAyNC44NjU3QzI0LjE2ODIgMjQuODY1OCAyMy42NzgzIDI1LjM2MzggMjMuNjc4MyAyNS45NzhDMjMuNjc4NCAyNi41OTIyIDI0LjE2ODMgMjcuMDkwMiAyNC43NzIzIDI3LjA5MDNIMzcuOTAxNEMzOC41MDU1IDI3LjA5MDMgMzguOTk1MyAyNi41OTIyIDM4Ljk5NTQgMjUuOTc4QzM4Ljk5NTQgMjUuMzYzNyAzOC41MDU2IDI0Ljg2NTcgMzcuOTAxNCAyNC44NjU3SDI0Ljc3MjNaIiBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIwLjc2Ii8+CjxwYXRoIGQ9Ik0xOC43ODkxIDExLjI5NzVDMTkuMDY5MSAxMC4xODA4IDIwLjYyOTkgMTAuMTgwOCAyMC45MDk5IDExLjI5NzVMMjEuOTE0MyAxNS4zMDM2QzIyLjAxMTYgMTUuNjkxOCAyMi4zMDY1IDE1Ljk5NzggMjIuNjg2NyAxNi4xMDNMMjYuMzYxMSAxNy4xMTg3QzI3LjQzNyAxNy40MTYyIDI3LjQzNyAxOC45Njc2IDI2LjM2MTEgMTkuMjY1MUwyMi42NzYxIDIwLjI4NEMyMi4zMDE4IDIwLjM4NzQgMjIuMDA4NyAyMC42ODQ1IDIxLjkwNjggMjEuMDY1TDIwLjkwNDYgMjQuODEyNUMyMC42MTE3IDI1LjkwNTggMTkuMDg2MSAyNS45MDU5IDE4Ljc5MzMgMjQuODEyNUwxNy43OTExIDIxLjA2NUMxNy42ODkzIDIwLjY4NDcgMTcuMzk3IDIwLjM4NzUgMTcuMDIyOSAyMC4yODRMMTMuMzM2OCAxOS4yNjUxQzEyLjI2MTQgMTguOTY3MyAxMi4yNjE1IDE3LjQxNjUgMTMuMzM2OCAxNy4xMTg3TDE3LjAxMTIgMTYuMTAzQzE3LjM5MTYgMTUuOTk3OCAxNy42ODc0IDE1LjY5MTkgMTcuNzg0NyAxNS4zMDM2TDE4Ljc4OTEgMTEuMjk3NVoiIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjAuNzYiLz4KPHBhdGggZD0iTTEwLjAzNDMgNy4wMjQyNUMxMC4zMDY4IDUuODk0NDQgMTEuODg2OCA1Ljg5NDQ0IDEyLjE1OTQgNy4wMjQyNUwxMi42OTg5IDkuMjYyOThDMTIuNzkyNyA5LjY1MTc0IDEzLjA4NTEgOS45NTg4NyAxMy40NjQgMTAuMDY3OUwxNS41NzczIDEwLjY3NTFDMTYuNjM5MyAxMC45ODAzIDE2LjYzOTMgMTIuNTEwOSAxNS41NzczIDEyLjgxNjFMMTMuNDUzMyAxMy40MjY1QzEzLjA4MDIgMTMuNTMzOCAxMi43OTA4IDEzLjgzMzkgMTIuNjkyNSAxNC4yMTUxTDEyLjE1NTEgMTYuMzA0QzExLjg3IDE3LjQxMTYgMTAuMzIzNiAxNy40MTE2IDEwLjAzODUgMTYuMzA0TDkuNTAwMDMgMTQuMjE1MUM5LjQwMTczIDEzLjgzMzkgOS4xMTIzNSAxMy41MzM3IDguNzM5MyAxMy40MjY1TDYuNjE1MjQgMTIuODE2MUM1LjU1Mzc4IDEyLjUxMDYgNS41NTM2NCAxMC45ODA0IDYuNjE1MjQgMTAuNjc1MUw4LjcyODYyIDEwLjA2NzlDOS4xMDc2IDkuOTU4OTggOS4zOTk3OCA5LjY1MTg0IDkuNDkzNjIgOS4yNjI5OEwxMC4wMzQzIDcuMDI0MjVaIiBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIwLjc2Ii8+CjxwYXRoIGQ9Ik0yNS45MDI4IDYuNzMzMTNDMjYuMTg3OCA1LjYyNTQxIDI3LjczNDMgNS42MjU0MSAyOC4wMTkzIDYuNzMzMTNMMjguMjAzMSA3LjQ0Njc5QzI4LjMwMyA3LjgzNDMxIDI4LjYwMDEgOC4xMzcwNSAyOC45ODA5IDguMjM5NzVMMjkuNTM0NCA4LjM4OTY1QzMwLjYxOTIgOC42ODIxMiAzMC42MTkzIDEwLjI0NjkgMjkuNTM0NCAxMC41MzkzTDI4Ljk2OTIgMTAuNjkxNEMyOC41OTQ0IDEwLjc5MjUgMjguMjk5OSAxMS4wODgzIDI4LjE5NTYgMTEuNDY4TDI4LjAxNTEgMTIuMTI4NUMyNy43MTc0IDEzLjIxMjggMjYuMjA0NyAxMy4yMTI4IDI1LjkwNyAxMi4xMjg1TDI1LjcyNTQgMTEuNDY4QzI1LjYyMTEgMTEuMDg4MiAyNS4zMjY4IDEwLjc5MjQgMjQuOTUxOCAxMC42OTE0TDI0LjM4NzcgMTAuNTM5M0MyMy4zMDI2IDEwLjI0NyAyMy4zMDI2IDguNjgxOTggMjQuMzg3NyA4LjM4OTY1TDI0Ljk0MDEgOC4yMzk3NUMyNS4zMjExIDguMTM3MDkgMjUuNjE5MSA3LjgzNDQ2IDI1LjcxOSA3LjQ0Njc5TDI1LjkwMjggNi43MzMxM1oiIGZpbGw9ImJsYWNrIiBmaWxsLW9wYWNpdHk9IjAuNzYiLz4KPC9zdmc+Cg==&quot;,
&nbsp;        docUrl = &quot;https://thingsboard.io/docs/user-guide/rule-engine-2-0/nodes/external/ai-request/&quot;
&nbsp;)
<b class="nc">&nbsp;public final class TbAiNode extends TbAbstractExternalNode implements TbNode {</b>
&nbsp;
&nbsp;    private String systemPrompt;
&nbsp;    private String userPrompt;
&nbsp;    private Set&lt;TbResourceId&gt; resourceIds;
&nbsp;    private ResponseFormat responseFormat;
&nbsp;    private int timeoutSeconds;
&nbsp;    private AiModelId modelId;
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(TbContext ctx, TbNodeConfiguration configuration) throws TbNodeException {
<b class="nc">&nbsp;        super.init(ctx);</b>
&nbsp;
<b class="nc">&nbsp;        var config = TbNodeUtils.convert(configuration, TbAiNodeConfiguration.class);</b>
<b class="nc">&nbsp;        String errorPrefix = &quot;&#39;&quot; + ctx.getSelf().getName() + &quot;&#39; node configuration is invalid: &quot;;</b>
&nbsp;        try {
<b class="nc">&nbsp;            validateFields(config, errorPrefix);</b>
&nbsp;        } catch (DataValidationException e) {
<b class="nc">&nbsp;            throw new TbNodeException(e, true);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        modelId = config.getModelId();</b>
<b class="nc">&nbsp;        Optional&lt;AiModel&gt; modelOpt = ctx.getAiModelService().findAiModelByTenantIdAndId(ctx.getTenantId(), modelId);</b>
<b class="nc">&nbsp;        if (modelOpt.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;[&quot; + ctx.getTenantId() + &quot;] AI model with ID: [&quot; + modelId + &quot;] was not found&quot;, true);</b>
&nbsp;        }
<b class="nc">&nbsp;        AiModel model = modelOpt.get();</b>
<b class="nc">&nbsp;        AiModelType modelType = model.getConfiguration().modelType();</b>
<b class="nc">&nbsp;        if (modelType != AiModelType.CHAT) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;[&quot; + ctx.getTenantId() + &quot;] AI model with ID: [&quot; + modelId + &quot;] must be of type CHAT, but was &quot; + modelType, true);</b>
&nbsp;        }
<b class="nc">&nbsp;        AiChatModelConfig&lt;?&gt; chatModelConfig = (AiChatModelConfig&lt;?&gt;) model.getConfiguration();</b>
<b class="nc">&nbsp;        if (isJsonModeConfigured(config)) {</b>
<b class="nc">&nbsp;            if (!chatModelConfig.supportsJsonMode()) {</b>
<b class="nc">&nbsp;                throw new TbNodeException(&quot;[&quot; + ctx.getTenantId() + &quot;] AI model with ID: [&quot; + modelId + &quot;] does not support &#39;&quot; + config.getResponseFormat().type() + &quot;&#39; response format&quot;, true);</b>
&nbsp;            }
&nbsp;            // LangChain4j AnthropicChatModel rejects requests with non-null ResponseFormat even if ResponseFormatType is TEXT
<b class="nc">&nbsp;            responseFormat = config.getResponseFormat().toLangChainResponseFormat();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (config.getResourceIds() != null &amp;&amp; !config.getResourceIds().isEmpty()) {</b>
<b class="nc">&nbsp;            resourceIds = new HashSet&lt;&gt;(config.getResourceIds().size());</b>
<b class="nc">&nbsp;            for (UUID resourceId : config.getResourceIds()) {</b>
<b class="nc">&nbsp;                TbResourceId tbResourceId = new TbResourceId(resourceId);</b>
<b class="nc">&nbsp;                validateResource(ctx, tbResourceId);</b>
<b class="nc">&nbsp;                resourceIds.add(tbResourceId);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        systemPrompt = config.getSystemPrompt();</b>
<b class="nc">&nbsp;        userPrompt = config.getUserPrompt();</b>
<b class="nc">&nbsp;        timeoutSeconds = config.getTimeoutSeconds();</b>
<b class="nc">&nbsp;        super.forceAck = config.isForceAck() || super.forceAck; // force ack if node config says so, or if env variable (super.forceAck) says so</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean isJsonModeConfigured(TbAiNodeConfiguration config) {
<b class="nc">&nbsp;        var responseFormatType = config.getResponseFormat().type();</b>
<b class="nc">&nbsp;        return responseFormatType == TbResponseFormatType.JSON || responseFormatType == TbResponseFormatType.JSON_SCHEMA;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onMsg(TbContext ctx, TbMsg msg) {
<b class="nc">&nbsp;        var ackedMsg = ackIfNeeded(ctx, msg);</b>
<b class="nc">&nbsp;        final String processedUserPrompt = TbNodeUtils.processPattern(this.userPrompt, ackedMsg);</b>
&nbsp;
&nbsp;        final ListenableFuture&lt;UserMessage&gt; userMessageFuture =
<b class="nc">&nbsp;                resourceIds == null</b>
<b class="nc">&nbsp;                        ? Futures.immediateFuture(UserMessage.from(processedUserPrompt))</b>
<b class="nc">&nbsp;                        : Futures.transform(</b>
<b class="nc">&nbsp;                        loadResources(ctx),</b>
<b class="nc">&nbsp;                        resources -&gt; UserMessage.from(buildContents(processedUserPrompt, resources)),</b>
<b class="nc">&nbsp;                        ctx.getDbCallbackExecutor()</b>
&nbsp;                );
&nbsp;
<b class="nc">&nbsp;        Futures.addCallback(</b>
&nbsp;                userMessageFuture,
<b class="nc">&nbsp;                new FutureCallback&lt;&gt;() {</b>
&nbsp;                    @Override
&nbsp;                    public void onSuccess(UserMessage userMessage) {
<b class="nc">&nbsp;                        buildAndSendRequest(ctx, ackedMsg, userMessage);</b>
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void onFailure(Throwable t) {
<b class="nc">&nbsp;                        tellFailure(ctx, ackedMsg, t);</b>
&nbsp;                    }
&nbsp;                },
<b class="nc">&nbsp;                MoreExecutors.directExecutor()</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    private void buildAndSendRequest(TbContext ctx, TbMsg ackedMsg, UserMessage userMessage) {
<b class="nc">&nbsp;        List&lt;ChatMessage&gt; chatMessages = new ArrayList&lt;&gt;(2);</b>
&nbsp;
<b class="nc">&nbsp;        if (systemPrompt != null &amp;&amp; !systemPrompt.isBlank()) {</b>
<b class="nc">&nbsp;            chatMessages.add(SystemMessage.from(TbNodeUtils.processPattern(systemPrompt, ackedMsg)));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        chatMessages.add(userMessage);</b>
&nbsp;
<b class="nc">&nbsp;        var chatRequest = ChatRequest.builder()</b>
<b class="nc">&nbsp;                .messages(chatMessages)</b>
<b class="nc">&nbsp;                .responseFormat(responseFormat)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        sendChatRequestAsync(ctx, chatRequest).addCallback(new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(ChatResponse chatResponse) {
<b class="nc">&nbsp;                String response = chatResponse.aiMessage().text();</b>
<b class="nc">&nbsp;                if (!isValidJsonObject(response)) {</b>
<b class="nc">&nbsp;                    response = wrapInJsonObject(response);</b>
&nbsp;                }
<b class="nc">&nbsp;                tellSuccess(ctx, ackedMsg.transform()</b>
<b class="nc">&nbsp;                        .data(response)</b>
<b class="nc">&nbsp;                        .build());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(@NonNull Throwable t) {
<b class="nc">&nbsp;                tellFailure(ctx, ackedMsg, t);</b>
&nbsp;            }
<b class="nc">&nbsp;        }, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;C extends AiChatModelConfig&lt;C&gt;&gt; FluentFuture&lt;ChatResponse&gt; sendChatRequestAsync(TbContext ctx, ChatRequest chatRequest) {
<b class="nc">&nbsp;        return ctx.getAiModelService().findAiModelByTenantIdAndIdAsync(ctx.getTenantId(), modelId).transformAsync(modelOpt -&gt; {</b>
<b class="nc">&nbsp;            if (modelOpt.isEmpty()) {</b>
<b class="nc">&nbsp;                throw new NoSuchElementException(&quot;[&quot; + ctx.getTenantId() + &quot;] AI model with ID: [&quot; + modelId + &quot;] was not found&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            AiModel model = modelOpt.get();</b>
<b class="nc">&nbsp;            AiModelType modelType = model.getConfiguration().modelType();</b>
<b class="nc">&nbsp;            if (modelType != AiModelType.CHAT) {</b>
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;[&quot; + ctx.getTenantId() + &quot;] AI model with ID: [&quot; + modelId + &quot;] must be of type CHAT, but was &quot; + modelType);</b>
&nbsp;            }
&nbsp;
&nbsp;            @SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;            AiChatModelConfig&lt;C&gt; chatModelConfig = (AiChatModelConfig&lt;C&gt;) model.getConfiguration();</b>
&nbsp;
<b class="nc">&nbsp;            chatModelConfig = chatModelConfig</b>
<b class="nc">&nbsp;                    .withTimeoutSeconds(timeoutSeconds)</b>
<b class="nc">&nbsp;                    .withMaxRetries(0); // disable retries to respect timeout set in rule node config</b>
&nbsp;
<b class="nc">&nbsp;            return ctx.getAiChatModelService().sendChatRequestAsync(chatModelConfig, chatRequest);</b>
<b class="nc">&nbsp;        }, ctx.getDbCallbackExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean isValidJsonObject(String jsonString) {
&nbsp;        try {
<b class="nc">&nbsp;            JsonNode result = JacksonUtil.toJsonNode(jsonString);</b>
<b class="nc">&nbsp;            return result != null &amp;&amp; result.isObject();</b>
&nbsp;        } catch (IllegalArgumentException e) {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static String wrapInJsonObject(String response) {
<b class="nc">&nbsp;        return JacksonUtil.newObjectNode().put(&quot;response&quot;, response).toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void validateResource(TbContext ctx, TbResourceId tbResourceId) throws TbNodeException {
<b class="nc">&nbsp;        TbResourceInfo resource = ctx.getResourceService().findResourceInfoById(ctx.getTenantId(), tbResourceId);</b>
<b class="nc">&nbsp;        if (resource == null) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;[&quot; + ctx.getTenantId() + &quot;] Resource with ID: [&quot; + tbResourceId + &quot;] was not found&quot;, true);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!ResourceType.GENERAL.equals(resource.getResourceType())) {</b>
<b class="nc">&nbsp;            throw new TbNodeException(&quot;[&quot; + ctx.getTenantId() + &quot;] Resource with ID: [&quot; + tbResourceId + &quot;] has unsupported resource type: &quot; + resource.getResourceType(), true);</b>
&nbsp;        }
<b class="nc">&nbsp;        ctx.checkTenantOrSystemEntity(resource);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;List&lt;TbResourceDataInfo&gt;&gt; loadResources(TbContext ctx) {
<b class="nc">&nbsp;        final TenantId tenantId = ctx.getTenantId();</b>
<b class="nc">&nbsp;        final TbResourceDataCache cache = ctx.getTbResourceDataCache();</b>
<b class="nc">&nbsp;        List&lt;? extends ListenableFuture&lt;TbResourceDataInfo&gt;&gt; futures = resourceIds.stream()</b>
<b class="nc">&nbsp;                .map(id -&gt; cache.getResourceDataInfoAsync(tenantId, id))</b>
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        return Futures.allAsList(futures);</b>
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;Content&gt; buildContents(String userPrompt, List&lt;TbResourceDataInfo&gt; resources) {
<b class="nc">&nbsp;        List&lt;Content&gt; contents = new ArrayList&lt;&gt;(1 + resources.size());</b>
<b class="nc">&nbsp;        contents.add(new TextContent(userPrompt)); // user prompt first</b>
&nbsp;
<b class="nc">&nbsp;        resources.stream()</b>
<b class="nc">&nbsp;                .filter(Objects::nonNull)</b>
<b class="nc">&nbsp;                .map(this::toContent)</b>
<b class="nc">&nbsp;                .forEach(contents::add);</b>
&nbsp;
<b class="nc">&nbsp;        return contents;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Content toContent(TbResourceDataInfo resource) {
<b class="nc">&nbsp;        if (resource.getDescriptor() == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Missing descriptor for resource&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        GeneralFileDescriptor descriptor = JacksonUtil.treeToValue(resource.getDescriptor(), GeneralFileDescriptor.class);</b>
<b class="nc">&nbsp;        String mediaType = descriptor.getMediaType();</b>
<b class="nc">&nbsp;        if (mediaType == null) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Missing mediaType in resource descriptor &quot; + resource.getDescriptor());</b>
&nbsp;        }
<b class="nc">&nbsp;        byte[] data = resource.getData();</b>
<b class="nc">&nbsp;        if (mediaType.startsWith(&quot;text/&quot;)) {</b>
<b class="nc">&nbsp;            return new TextContent(new String(data, StandardCharsets.UTF_8));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (mediaType.equals(&quot;application/pdf&quot;)) {</b>
<b class="nc">&nbsp;            return new PdfFileContent(Base64.getEncoder().encodeToString(data), mediaType);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (mediaType.startsWith(&quot;image/&quot;)) {</b>
<b class="nc">&nbsp;            return new ImageContent(Base64.getEncoder().encodeToString(data), mediaType);</b>
&nbsp;        }
<b class="nc">&nbsp;        log.debug(&quot;Trying to create text content for {}&quot;, resource.getDescriptor());</b>
<b class="nc">&nbsp;        return new TextContent(new String(data, StandardCharsets.UTF_8));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        super.destroy();</b>
<b class="nc">&nbsp;        systemPrompt = null;</b>
<b class="nc">&nbsp;        userPrompt = null;</b>
<b class="nc">&nbsp;        resourceIds = null;</b>
<b class="nc">&nbsp;        responseFormat = null;</b>
<b class="nc">&nbsp;        modelId = null;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

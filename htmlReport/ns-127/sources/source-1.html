<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > JpaSqlTimeseriesDao</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.sqlts.sql</a>
</div>

<h1>Coverage Summary for Class: JpaSqlTimeseriesDao (org.thingsboard.server.dao.sqlts.sql)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JpaSqlTimeseriesDao</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/64)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.sqlts.sql;
&nbsp;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.hibernate.exception.ConstraintViolationException;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.dao.DataIntegrityViolationException;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.kv.TsKvEntry;
&nbsp;import org.thingsboard.server.dao.dictionary.KeyDictionaryDao;
&nbsp;import org.thingsboard.server.dao.model.sqlts.ts.TsKvEntity;
&nbsp;import org.thingsboard.server.dao.sqlts.AbstractChunkedAggregationTimeseriesDao;
&nbsp;import org.thingsboard.server.dao.sqlts.insert.sql.SqlPartitioningRepository;
&nbsp;import org.thingsboard.server.dao.timeseries.SqlPartition;
&nbsp;import org.thingsboard.server.dao.timeseries.SqlTsPartitionDate;
&nbsp;import org.thingsboard.server.dao.util.SqlTsDao;
&nbsp;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.PreparedStatement;
&nbsp;import java.sql.ResultSet;
&nbsp;import java.sql.SQLException;
&nbsp;import java.time.Instant;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.time.ZoneOffset;
&nbsp;import java.time.ZonedDateTime;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;
&nbsp;@Component
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@SqlTsDao
<b class="nc">&nbsp;public class JpaSqlTimeseriesDao extends AbstractChunkedAggregationTimeseriesDao {</b>
&nbsp;
<b class="nc">&nbsp;    private final Map&lt;Long, SqlPartition&gt; partitions = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private static final ReentrantLock partitionCreationLock = new ReentrantLock();</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private SqlPartitioningRepository partitioningRepository;
&nbsp;    @Autowired
&nbsp;    private KeyDictionaryDao keyDictionaryDao;
&nbsp;
&nbsp;    private SqlTsPartitionDate tsFormat;
&nbsp;
&nbsp;    @Value(&quot;${sql.postgres.ts_key_value_partitioning:MONTHS}&quot;)
&nbsp;    private String partitioning;
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    protected void init() {
<b class="nc">&nbsp;        super.init();</b>
<b class="nc">&nbsp;        Optional&lt;SqlTsPartitionDate&gt; partition = SqlTsPartitionDate.parse(partitioning);</b>
<b class="nc">&nbsp;        if (partition.isPresent()) {</b>
<b class="nc">&nbsp;            tsFormat = partition.get();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;Incorrect configuration of partitioning {}&quot;, partitioning);</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Failed to parse partitioning property: &quot; + partitioning + &quot;!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Integer&gt; save(TenantId tenantId, EntityId entityId, TsKvEntry tsKvEntry, long ttl) {
<b class="nc">&nbsp;        int dataPointDays = getDataPointDays(tsKvEntry, computeTtl(ttl));</b>
<b class="nc">&nbsp;        savePartitionIfNotExist(tsKvEntry.getTs());</b>
<b class="nc">&nbsp;        String strKey = tsKvEntry.getKey();</b>
<b class="nc">&nbsp;        Integer keyId = keyDictionaryDao.getOrSaveKeyId(strKey);</b>
<b class="nc">&nbsp;        TsKvEntity entity = new TsKvEntity();</b>
<b class="nc">&nbsp;        entity.setEntityId(entityId.getId());</b>
<b class="nc">&nbsp;        entity.setTs(tsKvEntry.getTs());</b>
<b class="nc">&nbsp;        entity.setKey(keyId);</b>
<b class="nc">&nbsp;        entity.setStrValue(tsKvEntry.getStrValue().orElse(null));</b>
<b class="nc">&nbsp;        entity.setDoubleValue(tsKvEntry.getDoubleValue().orElse(null));</b>
<b class="nc">&nbsp;        entity.setLongValue(tsKvEntry.getLongValue().orElse(null));</b>
<b class="nc">&nbsp;        entity.setBooleanValue(tsKvEntry.getBooleanValue().orElse(null));</b>
<b class="nc">&nbsp;        entity.setJsonValue(tsKvEntry.getJsonValue().orElse(null));</b>
<b class="nc">&nbsp;        log.trace(&quot;Saving entity: {}&quot;, entity);</b>
<b class="nc">&nbsp;        return Futures.transform(tsQueue.add(entity), v -&gt; dataPointDays, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void cleanup(long systemTtl) {
<b class="nc">&nbsp;        if (systemTtl &gt; 0) {</b>
<b class="nc">&nbsp;            cleanupPartitions(systemTtl);</b>
&nbsp;        }
<b class="nc">&nbsp;        super.cleanup(systemTtl);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void cleanupPartitions(long systemTtl) {
<b class="nc">&nbsp;        log.info(&quot;Going to cleanup old timeseries data partitions using partition type: {} and ttl: {}s&quot;, partitioning, systemTtl);</b>
<b class="nc">&nbsp;        try (Connection connection = dataSource.getConnection();</b>
<b class="nc">&nbsp;             PreparedStatement stmt = connection.prepareStatement(&quot;call drop_partitions_by_system_ttl(?,?,?)&quot;)) {</b>
<b class="nc">&nbsp;            stmt.setString(1, partitioning);</b>
<b class="nc">&nbsp;            stmt.setLong(2, systemTtl);</b>
<b class="nc">&nbsp;            stmt.setLong(3, 0);</b>
<b class="nc">&nbsp;            stmt.setQueryTimeout((int) TimeUnit.HOURS.toSeconds(1));</b>
<b class="nc">&nbsp;            stmt.execute();</b>
<b class="nc">&nbsp;            printWarnings(stmt);</b>
<b class="nc">&nbsp;            try (ResultSet resultSet = stmt.getResultSet()) {</b>
<b class="nc">&nbsp;                resultSet.next();</b>
<b class="nc">&nbsp;                log.info(&quot;Total partitions removed by TTL: [{}]&quot;, resultSet.getLong(1));</b>
&nbsp;            }
&nbsp;        } catch (SQLException e) {
<b class="nc">&nbsp;            log.error(&quot;SQLException occurred during TTL task execution &quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void savePartitionIfNotExist(long ts) {
<b class="nc">&nbsp;        if (!tsFormat.equals(SqlTsPartitionDate.INDEFINITE) &amp;&amp; ts &gt;= 0) {</b>
<b class="nc">&nbsp;            LocalDateTime time = LocalDateTime.ofInstant(Instant.ofEpochMilli(ts), ZoneOffset.UTC);</b>
<b class="nc">&nbsp;            LocalDateTime localDateTimeStart = tsFormat.trancateTo(time);</b>
<b class="nc">&nbsp;            long partitionStartTs = toMills(localDateTimeStart);</b>
<b class="nc">&nbsp;            if (partitions.get(partitionStartTs) == null) {</b>
<b class="nc">&nbsp;                LocalDateTime localDateTimeEnd = tsFormat.plusTo(localDateTimeStart);</b>
<b class="nc">&nbsp;                long partitionEndTs = toMills(localDateTimeEnd);</b>
<b class="nc">&nbsp;                ZonedDateTime zonedDateTime = localDateTimeStart.atZone(ZoneOffset.UTC);</b>
<b class="nc">&nbsp;                String partitionDate = zonedDateTime.format(DateTimeFormatter.ofPattern(tsFormat.getPattern()));</b>
<b class="nc">&nbsp;                savePartition(new SqlPartition(SqlPartition.TS_KV, partitionStartTs, partitionEndTs, partitionDate));</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void savePartition(SqlPartition sqlPartition) {
<b class="nc">&nbsp;        if (!partitions.containsKey(sqlPartition.getStart())) {</b>
<b class="nc">&nbsp;            partitionCreationLock.lock();</b>
&nbsp;            try {
<b class="nc">&nbsp;                log.trace(&quot;Saving partition: {}&quot;, sqlPartition);</b>
<b class="nc">&nbsp;                partitioningRepository.save(sqlPartition);</b>
<b class="nc">&nbsp;                log.trace(&quot;Adding partition to Set: {}&quot;, sqlPartition);</b>
<b class="nc">&nbsp;                partitions.put(sqlPartition.getStart(), sqlPartition);</b>
&nbsp;            } catch (DataIntegrityViolationException ex) {
<b class="nc">&nbsp;                log.trace(&quot;Error occurred during partition save:&quot;, ex);</b>
<b class="nc">&nbsp;                if (ex.getCause() instanceof ConstraintViolationException) {</b>
<b class="nc">&nbsp;                    log.warn(&quot;Saving partition [{}] rejected. Timeseries data will save to the ts_kv_indefinite (DEFAULT) partition.&quot;, sqlPartition.getPartitionDate());</b>
<b class="nc">&nbsp;                    partitions.put(sqlPartition.getStart(), sqlPartition);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    throw new RuntimeException(ex);</b>
&nbsp;                }
&nbsp;            } finally {
<b class="nc">&nbsp;                partitionCreationLock.unlock();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static long toMills(LocalDateTime time) {
<b class="nc">&nbsp;        return time.toInstant(ZoneOffset.UTC).toEpochMilli();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

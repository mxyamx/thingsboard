<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LwM2mTransportServerHelper</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.transport.lwm2m.server</a>
</div>

<h1>Coverage Summary for Class: LwM2mTransportServerHelper (org.thingsboard.server.transport.lwm2m.server)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LwM2mTransportServerHelper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LwM2mTransportServerHelper$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/84)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.transport.lwm2m.server;
&nbsp;
&nbsp;import com.google.gson.JsonParser;
&nbsp;import jakarta.annotation.Nonnull;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.eclipse.leshan.core.model.InvalidDDFFileException;
&nbsp;import org.eclipse.leshan.core.model.ObjectModel;
&nbsp;import org.eclipse.leshan.core.model.ResourceModel;
&nbsp;import org.eclipse.leshan.core.node.codec.CodecException;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.thingsboard.server.common.data.util.TbDDFFileParser;
&nbsp;import org.thingsboard.server.common.transport.TransportServiceCallback;
&nbsp;import org.thingsboard.server.common.transport.auth.ValidateDeviceCredentialsResponse;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.PostAttributeMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.PostTelemetryMsg;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.SessionInfoProto;
&nbsp;import org.thingsboard.server.queue.util.TbLwM2mTransportComponent;
&nbsp;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.time.Instant;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Date;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.atomic.AtomicLong;
&nbsp;
&nbsp;import static org.thingsboard.server.gen.transport.TransportProtos.KeyValueType.BOOLEAN_V;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Component
&nbsp;@TbLwM2mTransportComponent
&nbsp;@RequiredArgsConstructor
&nbsp;public class LwM2mTransportServerHelper {
&nbsp;
&nbsp;    private final LwM2mTransportContext context;
&nbsp;
&nbsp;    public void sendParametersOnThingsboardAttribute(List&lt;TransportProtos.KeyValueProto&gt; result, SessionInfoProto sessionInfo) {
<b class="nc">&nbsp;        PostAttributeMsg.Builder request = PostAttributeMsg.newBuilder();</b>
<b class="nc">&nbsp;        request.addAllKv(result);</b>
<b class="nc">&nbsp;        PostAttributeMsg postAttributeMsg = request.build();</b>
<b class="nc">&nbsp;        context.getTransportService().process(sessionInfo, postAttributeMsg, TransportServiceCallback.EMPTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void sendParametersOnThingsboardTelemetry(List&lt;TransportProtos.KeyValueProto&gt; kvList, SessionInfoProto sessionInfo, @Nullable Map&lt;String, AtomicLong&gt; keyTsLatestMaps){
<b class="nc">&nbsp;        sendParametersOnThingsboardTelemetry(kvList, sessionInfo, keyTsLatestMaps, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void sendParametersOnThingsboardTelemetry(List&lt;TransportProtos.KeyValueProto&gt; kvList, SessionInfoProto sessionInfo, @Nullable Map&lt;String, AtomicLong&gt; keyTsLatestMap, @Nullable Instant ts) {
<b class="nc">&nbsp;        TransportProtos.TsKvListProto tsKvList = toTsKvList(kvList, keyTsLatestMap, ts);</b>
&nbsp;
<b class="nc">&nbsp;        PostTelemetryMsg postTelemetryMsg = PostTelemetryMsg.newBuilder()</b>
<b class="nc">&nbsp;                .addTsKvList(tsKvList)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        context.getTransportService().process(sessionInfo, postTelemetryMsg, TransportServiceCallback.EMPTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    TransportProtos.TsKvListProto toTsKvList(List&lt;TransportProtos.KeyValueProto&gt; kvList, Map&lt;String, AtomicLong&gt; keyTsLatestMap, @Nullable Instant ts) {
<b class="nc">&nbsp;        return TransportProtos.TsKvListProto.newBuilder()</b>
<b class="nc">&nbsp;                .setTs(ts == null ? getTs(kvList, keyTsLatestMap) : ts.toEpochMilli())</b>
<b class="nc">&nbsp;                .addAllKv(kvList)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    long getTs(List&lt;TransportProtos.KeyValueProto&gt; kvList, Map&lt;String, AtomicLong&gt; keyTsLatestMap) {
<b class="nc">&nbsp;        if (keyTsLatestMap == null || kvList == null || kvList.isEmpty()) {</b>
<b class="nc">&nbsp;            return getCurrentTimeMillis();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return getTsByKey(kvList.get(0).getKey(), keyTsLatestMap, getCurrentTimeMillis());</b>
&nbsp;    }
&nbsp;
&nbsp;    long getTsByKey(@Nonnull String key, @Nonnull Map&lt;String, AtomicLong&gt; keyTsLatestMap, final long tsNow) {
<b class="nc">&nbsp;        AtomicLong tsLatestAtomic = keyTsLatestMap.putIfAbsent(key, new AtomicLong(tsNow));</b>
<b class="nc">&nbsp;        if (tsLatestAtomic == null) {</b>
<b class="nc">&nbsp;            return tsNow; // it is a first known timestamp for this key. return as the latest</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return compareAndSwapOrIncrementTsAtomically(tsLatestAtomic, tsNow);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * This algorithm is sensitive to wall-clock time shift.
&nbsp;     * Once time have shifted *backward*, the latest ts never came back.
&nbsp;     * Ts latest will be incremented until current time overtake the latest ts.
&nbsp;     * In normal environment without race conditions method will return current ts (wall-clock)
&nbsp;     * */
&nbsp;    long compareAndSwapOrIncrementTsAtomically(AtomicLong tsLatestAtomic, final long tsNow) {
&nbsp;        long tsLatest;
<b class="nc">&nbsp;        while ((tsLatest = tsLatestAtomic.get()) &lt; tsNow) {</b>
<b class="nc">&nbsp;            if (tsLatestAtomic.compareAndSet(tsLatest, tsNow)) {</b>
<b class="nc">&nbsp;                return tsNow; //swap successful</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return tsLatestAtomic.incrementAndGet(); //return next ms</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * For the test ability to mock system timer
&nbsp;     * */
&nbsp;    long getCurrentTimeMillis() {
<b class="nc">&nbsp;        return System.currentTimeMillis();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return - sessionInfo after access connect client
&nbsp;     */
&nbsp;    public SessionInfoProto getValidateSessionInfo(ValidateDeviceCredentialsResponse msg, long mostSignificantBits, long leastSignificantBits) {
<b class="nc">&nbsp;        return SessionInfoProto.newBuilder()</b>
<b class="nc">&nbsp;                .setNodeId(context.getNodeId())</b>
<b class="nc">&nbsp;                .setSessionIdMSB(mostSignificantBits)</b>
<b class="nc">&nbsp;                .setSessionIdLSB(leastSignificantBits)</b>
<b class="nc">&nbsp;                .setDeviceIdMSB(msg.getDeviceInfo().getDeviceId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceIdLSB(msg.getDeviceInfo().getDeviceId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdMSB(msg.getDeviceInfo().getTenantId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdLSB(msg.getDeviceInfo().getTenantId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setCustomerIdMSB(msg.getDeviceInfo().getCustomerId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setCustomerIdLSB(msg.getDeviceInfo().getCustomerId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceName(msg.getDeviceInfo().getDeviceName())</b>
<b class="nc">&nbsp;                .setDeviceType(msg.getDeviceInfo().getDeviceType())</b>
<b class="nc">&nbsp;                .setDeviceProfileIdMSB(msg.getDeviceInfo().getDeviceProfileId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceProfileIdLSB(msg.getDeviceInfo().getDeviceProfileId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectModel parseFromXmlToObjectModel(byte[] xmlByte, String streamName) {
&nbsp;        try {
<b class="nc">&nbsp;            TbDDFFileParser ddfFileParser = new TbDDFFileParser();</b>
<b class="nc">&nbsp;            return ddfFileParser.parse(new ByteArrayInputStream(xmlByte), streamName).get(0);</b>
&nbsp;        } catch (IOException | InvalidDDFFileException e) {
<b class="nc">&nbsp;            log.error(&quot;Could not parse the XML file [{}]&quot;, streamName, e);</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param value - info about Logs
&nbsp;     * @return- KeyValueProto for telemetry (Logs)
&nbsp;     */
&nbsp;    public List&lt;TransportProtos.KeyValueProto&gt; getKvStringtoThingsboard(String key, String value) {
<b class="nc">&nbsp;        List&lt;TransportProtos.KeyValueProto&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        value = value.replaceAll(&quot;&lt;&quot;, &quot;&quot;).replaceAll(&quot;&gt;&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        result.add(TransportProtos.KeyValueProto.newBuilder()</b>
<b class="nc">&nbsp;                .setKey(key)</b>
<b class="nc">&nbsp;                .setType(TransportProtos.KeyValueType.STRING_V)</b>
<b class="nc">&nbsp;                .setStringV(value).build());</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return - KeyValueProto for attribute/telemetry (change value)
&nbsp;     * @throws CodecException -
&nbsp;     */
&nbsp;
&nbsp;    public TransportProtos.KeyValueProto getKvAttrTelemetryToThingsboard(ResourceModel.Type resourceType, String resourceName, Object value, boolean isMultiInstances) {
<b class="nc">&nbsp;        TransportProtos.KeyValueProto.Builder kvProto = TransportProtos.KeyValueProto.newBuilder().setKey(resourceName);</b>
<b class="nc">&nbsp;        if (isMultiInstances) {</b>
<b class="nc">&nbsp;            kvProto.setType(TransportProtos.KeyValueType.JSON_V)</b>
<b class="nc">&nbsp;                    .setJsonV((String) value);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            switch (resourceType) {</b>
&nbsp;                case BOOLEAN:
<b class="nc">&nbsp;                    kvProto.setType(BOOLEAN_V).setBoolV((Boolean) value).build();</b>
&nbsp;                    break;
&nbsp;                case TIME:
<b class="nc">&nbsp;                    if (value instanceof Date) {</b>
<b class="nc">&nbsp;                        kvProto.setType(TransportProtos.KeyValueType.LONG_V).setLongV(((Date) value).getTime());</b>
<b class="nc">&nbsp;                    } else if (value instanceof Integer || value instanceof Long) {</b>
<b class="nc">&nbsp;                        kvProto.setType(TransportProtos.KeyValueType.LONG_V).setLongV((long) (value));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        kvProto.setType(TransportProtos.KeyValueType.STRING_V).setStringV(value.toString());</b>
&nbsp;                    }
&nbsp;                    break;
&nbsp;                case STRING:
&nbsp;                case OPAQUE:
&nbsp;                case OBJLNK:
<b class="nc">&nbsp;                    kvProto.setType(TransportProtos.KeyValueType.STRING_V).setStringV((String) value);</b>
&nbsp;                    break;
&nbsp;                case INTEGER:
<b class="nc">&nbsp;                    kvProto.setType(TransportProtos.KeyValueType.LONG_V).setLongV((Long) value);</b>
&nbsp;                    break;
&nbsp;                case FLOAT:
<b class="nc">&nbsp;                    kvProto.setType(TransportProtos.KeyValueType.DOUBLE_V).setDoubleV((Double) value);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return kvProto.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param currentType  -
&nbsp;     * @param resourcePath -
&nbsp;     * @return
&nbsp;     */
&nbsp;    public static ResourceModel.Type getResourceModelTypeEqualsKvProtoValueType(ResourceModel.Type currentType, String resourcePath) {
<b class="nc">&nbsp;        switch (currentType) {</b>
&nbsp;            case BOOLEAN:
<b class="nc">&nbsp;                return ResourceModel.Type.BOOLEAN;</b>
&nbsp;            case STRING:
&nbsp;            case TIME:
&nbsp;            case OPAQUE:
&nbsp;            case OBJLNK:
<b class="nc">&nbsp;                return ResourceModel.Type.STRING;</b>
&nbsp;            case INTEGER:
<b class="nc">&nbsp;                return ResourceModel.Type.INTEGER;</b>
&nbsp;            case FLOAT:
<b class="nc">&nbsp;                return ResourceModel.Type.FLOAT;</b>
&nbsp;            default:
&nbsp;        }
<b class="nc">&nbsp;        throw new CodecException(&quot;Invalid ResourceModel_Type for resource %s, got %s&quot;, resourcePath, currentType);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static Object getValueFromKvProto(TransportProtos.KeyValueProto kv) {
<b class="nc">&nbsp;        switch (kv.getType()) {</b>
&nbsp;            case BOOLEAN_V:
<b class="nc">&nbsp;                return kv.getBoolV();</b>
&nbsp;            case LONG_V:
<b class="nc">&nbsp;                return kv.getLongV();</b>
&nbsp;            case DOUBLE_V:
<b class="nc">&nbsp;                return kv.getDoubleV();</b>
&nbsp;            case STRING_V:
<b class="nc">&nbsp;                return kv.getStringV();</b>
&nbsp;            case JSON_V:
&nbsp;                try {
<b class="nc">&nbsp;                    return JsonParser.parseString(kv.getJsonV());</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    return null;</b>
&nbsp;                }
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

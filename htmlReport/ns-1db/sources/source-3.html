<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultGitRepositoryService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.sync.vc</a>
</div>

<h1>Coverage Summary for Class: DefaultGitRepositoryService (org.thingsboard.server.service.sync.vc)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultGitRepositoryService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/101)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.sync.vc;
&nbsp;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import lombok.SneakyThrows;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.io.FileUtils;
&nbsp;import org.eclipse.jgit.api.errors.GitAPIException;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.sync.vc.BranchInfo;
&nbsp;import org.thingsboard.server.common.data.sync.vc.EntityVersion;
&nbsp;import org.thingsboard.server.common.data.sync.vc.RepositorySettings;
&nbsp;import org.thingsboard.server.common.data.sync.vc.VersionCreationResult;
&nbsp;import org.thingsboard.server.common.data.sync.vc.VersionedEntityInfo;
&nbsp;import org.thingsboard.server.service.sync.vc.GitRepository.Diff;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.nio.file.Path;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.stream.Collectors;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@ConditionalOnProperty(prefix = &quot;vc&quot;, value = &quot;git.service&quot;, havingValue = &quot;local&quot;, matchIfMissing = true)
&nbsp;@Service
<b class="nc">&nbsp;public class DefaultGitRepositoryService implements GitRepositoryService {</b>
&nbsp;
&nbsp;    @Value(&quot;${java.io.tmpdir}/repositories&quot;)
&nbsp;    private String defaultFolder;
&nbsp;
&nbsp;    @Value(&quot;${vc.git.repositories-folder:${java.io.tmpdir}/repositories}&quot;)
&nbsp;    private String repositoriesFolder;
&nbsp;
<b class="nc">&nbsp;    private final Map&lt;TenantId, GitRepository&gt; repositories = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void init() {
<b class="nc">&nbsp;        if (StringUtils.isEmpty(repositoriesFolder)) {</b>
<b class="nc">&nbsp;            repositoriesFolder = defaultFolder;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;TenantId&gt; getActiveRepositoryTenants() {
<b class="nc">&nbsp;        return new HashSet&lt;&gt;(repositories.keySet());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void prepareCommit(PendingCommit commit) {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(commit.getTenantId());</b>
<b class="nc">&nbsp;        String branch = commit.getBranch();</b>
&nbsp;        try {
<b class="nc">&nbsp;            List&lt;String&gt; branches = repository.listBranches().stream().map(BranchInfo::getName).toList();</b>
<b class="nc">&nbsp;            if (repository.getSettings().isLocalOnly()) {</b>
<b class="nc">&nbsp;                if (branches.contains(commit.getBranch())) {</b>
<b class="nc">&nbsp;                    repository.checkoutBranch(commit.getBranch());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    repository.createAndCheckoutOrphanBranch(commit.getBranch());</b>
&nbsp;                }
<b class="nc">&nbsp;                repository.resetAndClean();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                repository.createAndCheckoutOrphanBranch(commit.getWorkingBranch());</b>
<b class="nc">&nbsp;                repository.resetAndClean();</b>
<b class="nc">&nbsp;                if (branches.contains(branch)) {</b>
<b class="nc">&nbsp;                    repository.merge(branch);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (IOException | GitAPIException gitAPIException) {
&nbsp;            //TODO: analyze and return meaningful exceptions that we can show to the client;
<b class="nc">&nbsp;            throw new RuntimeException(gitAPIException);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteFolderContent(PendingCommit commit, String relativePath) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(commit.getTenantId());</b>
<b class="nc">&nbsp;        FileUtils.deleteDirectory(Path.of(repository.getDirectory(), relativePath).toFile());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void add(PendingCommit commit, String relativePath, String entityDataJson) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(commit.getTenantId());</b>
<b class="nc">&nbsp;        FileUtils.write(Path.of(repository.getDirectory(), relativePath).toFile(), entityDataJson, StandardCharsets.UTF_8);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public VersionCreationResult push(PendingCommit commit) {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(commit.getTenantId());</b>
&nbsp;        try {
<b class="nc">&nbsp;            repository.add(&quot;.&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            VersionCreationResult result = new VersionCreationResult();</b>
<b class="nc">&nbsp;            GitRepository.Status status = repository.status();</b>
<b class="nc">&nbsp;            result.setAdded(status.getAdded().size());</b>
<b class="nc">&nbsp;            result.setModified(status.getModified().size());</b>
<b class="nc">&nbsp;            result.setRemoved(status.getRemoved().size());</b>
&nbsp;
<b class="nc">&nbsp;            if (result.getAdded() &gt; 0 || result.getModified() &gt; 0 || result.getRemoved() &gt; 0) {</b>
<b class="nc">&nbsp;                GitRepository.Commit gitCommit = repository.commit(commit.getVersionName(), commit.getAuthorName(), commit.getAuthorEmail());</b>
<b class="nc">&nbsp;                repository.push(commit.getWorkingBranch(), commit.getBranch());</b>
<b class="nc">&nbsp;                result.setVersion(toVersion(gitCommit));</b>
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
&nbsp;        } catch (GitAPIException gitAPIException) {
&nbsp;            //TODO: analyze and return meaningful exceptions that we can show to the client;
<b class="nc">&nbsp;            throw new RuntimeException(gitAPIException);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            cleanUp(commit);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    @Override
&nbsp;    public void cleanUp(PendingCommit commit) {
<b class="nc">&nbsp;        log.debug(&quot;[{}] Cleanup tenant repository started.&quot;, commit.getTenantId());</b>
<b class="nc">&nbsp;        GitRepository repository = checkRepository(commit.getTenantId());</b>
&nbsp;        try {
<b class="nc">&nbsp;            repository.createAndCheckoutOrphanBranch(EntityId.NULL_UUID.toString());</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            if (!e.getMessage().contains(&quot;NO_CHANGE&quot;)) {</b>
&nbsp;                throw e;
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        repository.resetAndClean();</b>
<b class="nc">&nbsp;        repository.deleteLocalBranchIfExists(commit.getWorkingBranch());</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] Cleanup tenant repository completed.&quot;, commit.getTenantId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void abort(PendingCommit commit) {
<b class="nc">&nbsp;        cleanUp(commit);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void fetch(TenantId tenantId) throws GitAPIException {
<b class="nc">&nbsp;        var repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] Fetching tenant repository.&quot;, tenantId);</b>
<b class="nc">&nbsp;        repository.fetch();</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] Fetched tenant repository.&quot;, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getFileContentAtCommit(TenantId tenantId, String relativePath, String versionId) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        return new String(repository.getFileContentAtCommit(relativePath, versionId), StandardCharsets.UTF_8);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Diff&gt; getVersionsDiffList(TenantId tenantId, String path, String versionId1, String versionId2) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        return repository.getDiffList(versionId1, versionId2, path);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getContentsDiff(TenantId tenantId, String content1, String content2) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        return repository.getContentsDiff(content1, content2);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;BranchInfo&gt; listBranches(TenantId tenantId) {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
&nbsp;        try {
<b class="nc">&nbsp;            return repository.listBranches();</b>
&nbsp;        } catch (GitAPIException gitAPIException) {
&nbsp;            //TODO: analyze and return meaningful exceptions that we can show to the client;
<b class="nc">&nbsp;            throw new RuntimeException(gitAPIException);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private GitRepository checkRepository(TenantId tenantId) {
<b class="nc">&nbsp;        GitRepository gitRepository = Optional.ofNullable(repositories.get(tenantId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new IllegalStateException(&quot;Repository is not initialized&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (!GitRepository.exists(gitRepository.getDirectory())) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                return openOrCloneRepository(tenantId, gitRepository.getSettings(), false);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;Could not initialize the repository: &quot; + e.getMessage(), e);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return gitRepository;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityVersion&gt; listVersions(TenantId tenantId, String branch, String path, PageLink pageLink) throws Exception {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        return repository.listCommits(branch, path, pageLink).mapData(this::toVersion);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;VersionedEntityInfo&gt; listEntitiesAtVersion(TenantId tenantId, String versionId, String path) throws Exception {
<b class="nc">&nbsp;        GitRepository repository = checkRepository(tenantId);</b>
<b class="nc">&nbsp;        return repository.listFilesAtCommit(versionId, path).stream()</b>
<b class="nc">&nbsp;                .map(filePath -&gt; {</b>
<b class="nc">&nbsp;                    EntityId entityId = fromRelativePath(filePath);</b>
<b class="nc">&nbsp;                    VersionedEntityInfo info = new VersionedEntityInfo();</b>
<b class="nc">&nbsp;                    info.setExternalId(entityId);</b>
<b class="nc">&nbsp;                    return info;</b>
&nbsp;                })
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void testRepository(TenantId tenantId, RepositorySettings settings) throws Exception {
<b class="nc">&nbsp;        Path testDirectory = Path.of(repositoriesFolder, &quot;repo-test-&quot; + UUID.randomUUID());</b>
<b class="nc">&nbsp;        GitRepository.test(settings, testDirectory.toFile());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void initRepository(TenantId tenantId, RepositorySettings settings, boolean fetch) throws Exception {
<b class="nc">&nbsp;        if (!settings.isLocalOnly()) {</b>
<b class="nc">&nbsp;            clearRepository(tenantId);</b>
&nbsp;        }
<b class="nc">&nbsp;        openOrCloneRepository(tenantId, settings, fetch);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public RepositorySettings getRepositorySettings(TenantId tenantId) throws Exception {
<b class="nc">&nbsp;        var gitRepository = repositories.get(tenantId);</b>
<b class="nc">&nbsp;        return gitRepository != null ? gitRepository.getSettings() : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void clearRepository(TenantId tenantId) throws IOException {
<b class="nc">&nbsp;        GitRepository repository = repositories.remove(tenantId);</b>
<b class="nc">&nbsp;        if (repository != null) {</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Clear tenant repository started.&quot;, tenantId);</b>
<b class="nc">&nbsp;            FileUtils.deleteDirectory(new File(repository.getDirectory()));</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Clear tenant repository completed.&quot;, tenantId);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private EntityVersion toVersion(GitRepository.Commit commit) {
<b class="nc">&nbsp;        return new EntityVersion(commit.getTimestamp(), commit.getId(), commit.getMessage(), this.getAuthor(commit));</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getAuthor(GitRepository.Commit commit) {
<b class="nc">&nbsp;        String author = String.format(&quot;&lt;%s&gt;&quot;, commit.getAuthorEmail());</b>
<b class="nc">&nbsp;        if (StringUtils.isNotBlank(commit.getAuthorName())) {</b>
<b class="nc">&nbsp;            author = String.format(&quot;%s %s&quot;, commit.getAuthorName(), author);</b>
&nbsp;        }
<b class="nc">&nbsp;        return author;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static EntityId fromRelativePath(String path) {
<b class="nc">&nbsp;        EntityType entityType = EntityType.valueOf(StringUtils.substringBefore(path, &quot;/&quot;).toUpperCase());</b>
<b class="nc">&nbsp;        String entityId = StringUtils.substringBetween(path, &quot;/&quot;, &quot;.json&quot;);</b>
<b class="nc">&nbsp;        return EntityIdFactory.getByTypeAndUuid(entityType, entityId);</b>
&nbsp;    }
&nbsp;
&nbsp;    private GitRepository openOrCloneRepository(TenantId tenantId, RepositorySettings settings, boolean fetch) throws Exception {
<b class="nc">&nbsp;        log.debug(&quot;[{}] Init tenant repository started.&quot;, tenantId);</b>
<b class="nc">&nbsp;        Path repositoryDirectory = Path.of(repositoriesFolder, settings.isLocalOnly() ? &quot;local_&quot; + settings.getRepositoryUri() : tenantId.getId().toString());</b>
<b class="nc">&nbsp;        GitRepository repository = GitRepository.openOrClone(repositoryDirectory, settings, fetch);</b>
<b class="nc">&nbsp;        repositories.put(tenantId, repository);</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}] Init tenant repository completed.&quot;, tenantId);</b>
<b class="nc">&nbsp;        return repository;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Lwm2mClient</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.monitoring.client</a>
</div>

<h1>Coverage Summary for Class: Lwm2mClient (org.thingsboard.monitoring.client)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Lwm2mClient</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/57)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Lwm2mClient$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/75)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.monitoring.client;
&nbsp;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import lombok.SneakyThrows;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.eclipse.californium.core.config.CoapConfig;
&nbsp;import org.eclipse.californium.elements.config.Configuration;
&nbsp;import org.eclipse.californium.scandium.config.DtlsConfig;
&nbsp;import org.eclipse.leshan.client.LeshanClient;
&nbsp;import org.eclipse.leshan.client.LeshanClientBuilder;
&nbsp;import org.eclipse.leshan.client.californium.endpoint.CaliforniumClientEndpointsProvider;
&nbsp;import org.eclipse.leshan.client.californium.endpoint.ClientProtocolProvider;
&nbsp;import org.eclipse.leshan.client.californium.endpoint.coap.CoapOscoreProtocolProvider;
&nbsp;import org.eclipse.leshan.client.californium.endpoint.coaps.CoapsClientProtocolProvider;
&nbsp;import org.eclipse.leshan.client.endpoint.LwM2mClientEndpointsProvider;
&nbsp;import org.eclipse.leshan.client.engine.DefaultRegistrationEngineFactory;
&nbsp;import org.eclipse.leshan.client.object.Security;
&nbsp;import org.eclipse.leshan.client.object.Server;
&nbsp;import org.eclipse.leshan.client.observer.LwM2mClientObserver;
&nbsp;import org.eclipse.leshan.client.resource.BaseInstanceEnabler;
&nbsp;import org.eclipse.leshan.client.resource.DummyInstanceEnabler;
&nbsp;import org.eclipse.leshan.client.resource.ObjectsInitializer;
&nbsp;import org.eclipse.leshan.client.servers.LwM2mServer;
&nbsp;import org.eclipse.leshan.core.ResponseCode;
&nbsp;import org.eclipse.leshan.core.model.InvalidDDFFileException;
&nbsp;import org.eclipse.leshan.core.model.LwM2mModel;
&nbsp;import org.eclipse.leshan.core.model.ObjectLoader;
&nbsp;import org.eclipse.leshan.core.model.ObjectModel;
&nbsp;import org.eclipse.leshan.core.model.StaticModel;
&nbsp;import org.eclipse.leshan.core.node.codec.DefaultLwM2mDecoder;
&nbsp;import org.eclipse.leshan.core.node.codec.DefaultLwM2mEncoder;
&nbsp;import org.eclipse.leshan.core.request.BootstrapRequest;
&nbsp;import org.eclipse.leshan.core.request.DeregisterRequest;
&nbsp;import org.eclipse.leshan.core.request.RegisterRequest;
&nbsp;import org.eclipse.leshan.core.request.UpdateRequest;
&nbsp;import org.eclipse.leshan.core.response.ReadResponse;
&nbsp;import org.thingsboard.monitoring.util.ResourceUtils;
&nbsp;
&nbsp;import javax.security.auth.Destroyable;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;import static org.eclipse.leshan.client.object.Security.noSec;
&nbsp;import static org.eclipse.leshan.core.LwM2mId.ACCESS_CONTROL;
&nbsp;import static org.eclipse.leshan.core.LwM2mId.DEVICE;
&nbsp;import static org.eclipse.leshan.core.LwM2mId.SECURITY;
&nbsp;import static org.eclipse.leshan.core.LwM2mId.SERVER;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class Lwm2mClient extends BaseInstanceEnabler implements Destroyable {
&nbsp;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private LeshanClient leshanClient;
&nbsp;
<b class="nc">&nbsp;    private static final List&lt;Integer&gt; supportedResources = List.of(0, 16);</b>
&nbsp;
<b class="nc">&nbsp;    private String data = &quot;&quot;;</b>
&nbsp;
&nbsp;    private String serverUri;
&nbsp;    private String endpoint;
&nbsp;
<b class="nc">&nbsp;    public Lwm2mClient(String serverUri, String endpoint) {</b>
<b class="nc">&nbsp;        this.serverUri = serverUri;</b>
<b class="nc">&nbsp;        this.endpoint = endpoint;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public Lwm2mClient() {</b>
&nbsp;    }
&nbsp;
&nbsp;    public void initClient() throws InvalidDDFFileException, IOException {
<b class="nc">&nbsp;        String[] resources = new String[]{&quot;0.xml&quot;, &quot;1.xml&quot;, &quot;2.xml&quot;, &quot;test-model.xml&quot;};</b>
<b class="nc">&nbsp;        List&lt;ObjectModel&gt; models = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (String resourceName : resources) {</b>
<b class="nc">&nbsp;            models.addAll(ObjectLoader.loadDdfFile(ResourceUtils.getResourceAsStream(&quot;lwm2m/models/&quot; + resourceName), resourceName));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Security security = noSec(serverUri, 123);</b>
<b class="nc">&nbsp;        Configuration coapConfig = new Configuration();</b>
<b class="nc">&nbsp;        String portStr = StringUtils.substringAfterLast(serverUri, &quot;:&quot;);</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(portStr)) {</b>
<b class="nc">&nbsp;            coapConfig.set(CoapConfig.COAP_PORT, Integer.parseInt(portStr));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        LwM2mModel model = new StaticModel(models);</b>
<b class="nc">&nbsp;        ObjectsInitializer initializer = new ObjectsInitializer(model);</b>
<b class="nc">&nbsp;        initializer.setInstancesForObject(SECURITY, security);</b>
<b class="nc">&nbsp;        initializer.setInstancesForObject(SERVER, new Server(123, TimeUnit.MINUTES.toSeconds(5)));</b>
<b class="nc">&nbsp;        initializer.setInstancesForObject(DEVICE, this);</b>
<b class="nc">&nbsp;        initializer.setClassForObject(ACCESS_CONTROL, DummyInstanceEnabler.class);</b>
&nbsp;
&nbsp;        // Create client endpoints Provider
<b class="nc">&nbsp;        List&lt;ClientProtocolProvider&gt; protocolProvider = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        protocolProvider.add(new CoapOscoreProtocolProvider());</b>
<b class="nc">&nbsp;        protocolProvider.add(new CoapsClientProtocolProvider());</b>
<b class="nc">&nbsp;        CaliforniumClientEndpointsProvider.Builder endpointsBuilder = new CaliforniumClientEndpointsProvider.Builder(</b>
<b class="nc">&nbsp;                protocolProvider.toArray(new ClientProtocolProvider[protocolProvider.size()]));</b>
&nbsp;
&nbsp;        // Create Californium Configuration
<b class="nc">&nbsp;        Configuration clientCoapConfig = endpointsBuilder.createDefaultConfiguration();</b>
&nbsp;
&nbsp;        // Set some DTLS stuff
<b class="nc">&nbsp;        clientCoapConfig.setTransient(DtlsConfig.DTLS_RECOMMENDED_CIPHER_SUITES_ONLY);</b>
<b class="nc">&nbsp;        clientCoapConfig.set(DtlsConfig.DTLS_RECOMMENDED_CIPHER_SUITES_ONLY, true);</b>
&nbsp;
&nbsp;        // Set Californium Configuration
<b class="nc">&nbsp;        endpointsBuilder.setConfiguration(clientCoapConfig);</b>
&nbsp;
&nbsp;        // creates EndpointsProvider
<b class="nc">&nbsp;        List&lt;LwM2mClientEndpointsProvider&gt; endpointsProvider = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        endpointsProvider.add(endpointsBuilder.build());</b>
&nbsp;
&nbsp;        // Configure registration engine
<b class="nc">&nbsp;        DefaultRegistrationEngineFactory engineFactory = new DefaultRegistrationEngineFactory();</b>
<b class="nc">&nbsp;        engineFactory.setReconnectOnUpdate(false);</b>
<b class="nc">&nbsp;        engineFactory.setResumeOnConnect(true);</b>
&nbsp;
&nbsp;        // Build the client
<b class="nc">&nbsp;        LeshanClientBuilder builder = new LeshanClientBuilder(endpoint);</b>
<b class="nc">&nbsp;        builder.setObjects(initializer.createAll());</b>
<b class="nc">&nbsp;        builder.setEndpointsProviders(endpointsProvider.toArray(new LwM2mClientEndpointsProvider[endpointsProvider.size()]));</b>
<b class="nc">&nbsp;        builder.setRegistrationEngineFactory(engineFactory);</b>
<b class="nc">&nbsp;        builder.setDecoder(new DefaultLwM2mDecoder(false));</b>
<b class="nc">&nbsp;        builder.setEncoder(new DefaultLwM2mEncoder(false));</b>
<b class="nc">&nbsp;        leshanClient = builder.build();</b>
&nbsp;
&nbsp;        // Add observer
<b class="nc">&nbsp;        LwM2mClientObserver observer = new LwM2mClientObserver() {</b>
&nbsp;            @Override
&nbsp;            public void onBootstrapStarted(LwM2mServer bsserver, BootstrapRequest request) {
&nbsp;                // No implementation needed
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void onBootstrapSuccess(LwM2mServer bsserver, BootstrapRequest request) {
&nbsp;                // No implementation needed
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void onBootstrapFailure(LwM2mServer bsserver, BootstrapRequest request, ResponseCode responseCode, String errorMessage, Exception cause) {
<b class="nc">&nbsp;                log.debug(&quot;onBootstrapFailure [{}] [{}] [{}]&quot;, request.getEndpointName(), responseCode, errorMessage);</b>
&nbsp;                // No implementation needed
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onBootstrapTimeout(LwM2mServer bsserver, BootstrapRequest request) {
&nbsp;                // No implementation needed
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void onRegistrationStarted(LwM2mServer server, RegisterRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onRegistrationStarted [{}]&quot;, request.getEndpointName());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onRegistrationSuccess(LwM2mServer server, RegisterRequest request, String registrationID) {
<b class="nc">&nbsp;                log.debug(&quot;onRegistrationSuccess [{}] [{}]&quot;, request.getEndpointName(), registrationID);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onRegistrationFailure(LwM2mServer server, RegisterRequest request, ResponseCode responseCode, String errorMessage, Exception cause) {
<b class="nc">&nbsp;                log.debug(&quot;onRegistrationFailure [{}] [{}] [{}]&quot;, request.getEndpointName(), responseCode, errorMessage);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onRegistrationTimeout(LwM2mServer server, RegisterRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onRegistrationTimeout [{}]&quot;, request.getEndpointName());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onUpdateStarted(LwM2mServer server, UpdateRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onUpdateStarted [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onUpdateSuccess(LwM2mServer server, UpdateRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onUpdateSuccess [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onUpdateFailure(LwM2mServer server, UpdateRequest request, ResponseCode responseCode, String errorMessage, Exception cause) {
<b class="nc">&nbsp;                log.debug(&quot;onUpdateFailure [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onUpdateTimeout(LwM2mServer server, UpdateRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onUpdateTimeout [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onDeregistrationStarted(LwM2mServer server, DeregisterRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onDeregistrationStarted [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onDeregistrationSuccess(LwM2mServer server, DeregisterRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onDeregistrationSuccess [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onDeregistrationFailure(LwM2mServer server, DeregisterRequest request, ResponseCode responseCode, String errorMessage, Exception cause) {
<b class="nc">&nbsp;                log.debug(&quot;onDeregistrationFailure [{}] [{}] [{}]&quot;, request.getRegistrationId(), responseCode, errorMessage);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onDeregistrationTimeout(LwM2mServer server, DeregisterRequest request) {
<b class="nc">&nbsp;                log.debug(&quot;onDeregistrationTimeout [{}]&quot;, request.getRegistrationId());</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onUnexpectedError(Throwable unexpectedError) {
<b class="nc">&nbsp;                log.debug(&quot;onUnexpectedError [{}]&quot;, unexpectedError.toString());</b>
&nbsp;            }
&nbsp;        };
<b class="nc">&nbsp;        leshanClient.addObserver(observer);</b>
&nbsp;
<b class="nc">&nbsp;        setLeshanClient(leshanClient);</b>
&nbsp;
<b class="nc">&nbsp;        leshanClient.start();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Integer&gt; getAvailableResourceIds(ObjectModel model) {
<b class="nc">&nbsp;        return supportedResources;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ReadResponse read(LwM2mServer server, int resourceId) {
<b class="nc">&nbsp;        return switch (resourceId) {</b>
<b class="nc">&nbsp;            case 0 -&gt; ReadResponse.success(0, data);</b>
<b class="nc">&nbsp;            case 16 -&gt; ReadResponse.success(16, &quot;U&quot;);</b>
<b class="nc">&nbsp;            default -&gt; super.read(server, resourceId);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public void send(String data, int resource) {
<b class="nc">&nbsp;        this.data = data;</b>
<b class="nc">&nbsp;        fireResourceChange(resource);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        if (leshanClient != null) {</b>
<b class="nc">&nbsp;            leshanClient.destroy(true);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

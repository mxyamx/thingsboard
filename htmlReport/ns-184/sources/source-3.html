<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EntityStateSourcingListener</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.entitiy</a>
</div>

<h1>Coverage Summary for Class: EntityStateSourcingListener (org.thingsboard.server.service.entitiy)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EntityStateSourcingListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/112)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/159)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EntityStateSourcingListener$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EntityStateSourcingListener$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EntityStateSourcingListener$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/112)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/165)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.entitiy;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.type.TypeReference;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.rule.engine.api.JobManager;
&nbsp;import org.thingsboard.server.cluster.TbClusterService;
&nbsp;import org.thingsboard.server.common.data.ApiUsageState;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.TbResource;
&nbsp;import org.thingsboard.server.common.data.TbResourceInfo;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.TenantProfile;
&nbsp;import org.thingsboard.server.common.data.alarm.Alarm;
&nbsp;import org.thingsboard.server.common.data.asset.Asset;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedField;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedFieldType;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEvent;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.job.Job;
&nbsp;import org.thingsboard.server.common.data.msg.TbMsgType;
&nbsp;import org.thingsboard.server.common.data.notification.NotificationRequest;
&nbsp;import org.thingsboard.server.common.data.plugin.ComponentLifecycleEvent;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChain;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainType;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.msg.TbMsg;
&nbsp;import org.thingsboard.server.common.msg.TbMsgDataType;
&nbsp;import org.thingsboard.server.common.msg.TbMsgMetaData;
&nbsp;import org.thingsboard.server.common.msg.edge.EdgeEventUpdateMsg;
&nbsp;import org.thingsboard.server.common.msg.plugin.ComponentLifecycleMsg;
&nbsp;import org.thingsboard.server.common.msg.rule.engine.DeviceCredentialsUpdateNotificationMsg;
&nbsp;import org.thingsboard.server.common.util.ProtoUtils;
&nbsp;import org.thingsboard.server.dao.edge.EdgeSynchronizationManager;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.RelationActionEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.dao.tenant.TenantService;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.EntityActionEventProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.ToCalculatedFieldMsg;
&nbsp;import org.thingsboard.server.queue.TbQueueCallback;
&nbsp;import org.thingsboard.server.queue.TbQueueMsgMetadata;
&nbsp;import org.thingsboard.server.service.cf.CalculatedFieldCache;
&nbsp;
&nbsp;import java.util.Set;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Component
&nbsp;@RequiredArgsConstructor
&nbsp;public class EntityStateSourcingListener {
&nbsp;
&nbsp;    private final TenantService tenantService;
&nbsp;    private final TbClusterService tbClusterService;
&nbsp;    private final EdgeSynchronizationManager edgeSynchronizationManager;
&nbsp;    private final JobManager jobManager;
&nbsp;    private final CalculatedFieldCache calculatedFieldCache;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void init() {
<b class="nc">&nbsp;        log.debug(&quot;EntityStateSourcingListener initiated&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @TransactionalEventListener(fallbackExecution = true)
&nbsp;    public void handleEvent(SaveEntityEvent&lt;?&gt; event) {
<b class="nc">&nbsp;        if (Boolean.FALSE.equals(event.getBroadcastEvent())) {</b>
<b class="nc">&nbsp;            log.trace(&quot;Ignoring event {}&quot;, event);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        TenantId tenantId = event.getTenantId();</b>
<b class="nc">&nbsp;        EntityId entityId = event.getEntityId();</b>
<b class="nc">&nbsp;        if (entityId == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        EntityType entityType = entityId.getEntityType();</b>
<b class="nc">&nbsp;        log.debug(&quot;[{}][{}][{}] Handling entity save event: {}&quot;, tenantId, entityType, entityId, event);</b>
<b class="nc">&nbsp;        boolean isCreated = event.getCreated() != null &amp;&amp; event.getCreated();</b>
<b class="nc">&nbsp;        ComponentLifecycleEvent lifecycleEvent = isCreated ? ComponentLifecycleEvent.CREATED : ComponentLifecycleEvent.UPDATED;</b>
&nbsp;
<b class="nc">&nbsp;        switch (entityType) {</b>
&nbsp;            case ASSET -&gt; {
<b class="nc">&nbsp;                onAssetUpdate(event.getEntity(), event.getOldEntity());</b>
&nbsp;            }
&nbsp;            case ASSET_PROFILE, ENTITY_VIEW, NOTIFICATION_RULE, USER -&gt; {
<b class="nc">&nbsp;                tbClusterService.broadcastEntityStateChangeEvent(tenantId, entityId, lifecycleEvent);</b>
&nbsp;            }
&nbsp;            case RULE_CHAIN -&gt; {
<b class="nc">&nbsp;                RuleChain ruleChain = (RuleChain) event.getEntity();</b>
<b class="nc">&nbsp;                if (RuleChainType.CORE.equals(ruleChain.getType())) {</b>
<b class="nc">&nbsp;                    tbClusterService.broadcastEntityStateChangeEvent(ruleChain.getTenantId(), ruleChain.getId(), lifecycleEvent);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            case TENANT -&gt; {
<b class="nc">&nbsp;                Tenant tenant = (Tenant) event.getEntity();</b>
<b class="nc">&nbsp;                onTenantUpdate(tenant, lifecycleEvent);</b>
&nbsp;            }
&nbsp;            case TENANT_PROFILE -&gt; {
<b class="nc">&nbsp;                TenantProfile tenantProfile = (TenantProfile) event.getEntity();</b>
<b class="nc">&nbsp;                onTenantProfileUpdate(tenantProfile, lifecycleEvent);</b>
&nbsp;            }
&nbsp;            case DEVICE -&gt; {
<b class="nc">&nbsp;                onDeviceUpdate(event.getEntity(), event.getOldEntity());</b>
&nbsp;            }
&nbsp;            case DEVICE_PROFILE -&gt; {
<b class="nc">&nbsp;                DeviceProfile deviceProfile = (DeviceProfile) event.getEntity();</b>
<b class="nc">&nbsp;                onDeviceProfileUpdate(deviceProfile, event.getOldEntity(), isCreated);</b>
&nbsp;            }
&nbsp;            case EDGE -&gt; {
<b class="nc">&nbsp;                onEdgeEvent(tenantId, entityId, event.getEntity(), lifecycleEvent);</b>
&nbsp;            }
&nbsp;            case TB_RESOURCE -&gt; {
<b class="nc">&nbsp;                TbResource tbResource = (TbResource) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onResourceChange(tbResource, null);</b>
&nbsp;            }
&nbsp;            case API_USAGE_STATE -&gt; {
<b class="nc">&nbsp;                ApiUsageState apiUsageState = (ApiUsageState) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onApiStateChange(apiUsageState, null);</b>
&nbsp;            }
&nbsp;            case CALCULATED_FIELD -&gt; {
<b class="nc">&nbsp;                onCalculatedFieldUpdate(event.getEntity(), event.getOldEntity());</b>
&nbsp;            }
&nbsp;            case JOB -&gt; {
<b class="nc">&nbsp;                onJobUpdate((Job) event.getEntity());</b>
&nbsp;            }
&nbsp;            case CUSTOMER -&gt; {
<b class="nc">&nbsp;                tbClusterService.onCustomerUpdated((Customer) event.getEntity(), (Customer) event.getOldEntity());</b>
&nbsp;            }
&nbsp;            default -&gt; {
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @TransactionalEventListener(fallbackExecution = true)
&nbsp;    public void handleEvent(DeleteEntityEvent&lt;?&gt; event) {
<b class="nc">&nbsp;        TenantId tenantId = event.getTenantId();</b>
<b class="nc">&nbsp;        EntityId entityId = event.getEntityId();</b>
<b class="nc">&nbsp;        if (entityId == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        EntityType entityType = entityId.getEntityType();</b>
<b class="nc">&nbsp;        if (entityType != EntityType.TENANT &amp;&amp; !tenantExists(tenantId)) {</b>
<b class="nc">&nbsp;            log.debug(&quot;[{}] Ignoring DeleteEntityEvent because tenant does not exist: {}&quot;, tenantId, event);</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        log.debug(&quot;[{}][{}][{}] Handling entity deletion event: {}&quot;, tenantId, entityType, entityId, event);</b>
&nbsp;
<b class="nc">&nbsp;        switch (entityType) {</b>
&nbsp;            case ASSET -&gt; {
<b class="nc">&nbsp;                Asset asset = (Asset) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onAssetDeleted(tenantId, asset, null);</b>
&nbsp;            }
&nbsp;            case ASSET_PROFILE, ENTITY_VIEW, CUSTOMER, EDGE, NOTIFICATION_RULE, USER -&gt; {
<b class="nc">&nbsp;                tbClusterService.broadcastEntityStateChangeEvent(tenantId, entityId, ComponentLifecycleEvent.DELETED);</b>
&nbsp;            }
&nbsp;            case NOTIFICATION_REQUEST -&gt; {
<b class="nc">&nbsp;                NotificationRequest request = (NotificationRequest) event.getEntity();</b>
<b class="nc">&nbsp;                if (request.isScheduled()) {</b>
<b class="nc">&nbsp;                    tbClusterService.broadcastEntityStateChangeEvent(tenantId, entityId, ComponentLifecycleEvent.DELETED);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            case RULE_CHAIN -&gt; {
<b class="nc">&nbsp;                RuleChain ruleChain = (RuleChain) event.getEntity();</b>
<b class="nc">&nbsp;                if (RuleChainType.CORE.equals(ruleChain.getType())) {</b>
<b class="nc">&nbsp;                    Set&lt;RuleChainId&gt; referencingRuleChainIds = JacksonUtil.fromString(event.getBody(), new TypeReference&lt;&gt;() {</b>
&nbsp;                    });
<b class="nc">&nbsp;                    if (referencingRuleChainIds != null) {</b>
<b class="nc">&nbsp;                        referencingRuleChainIds.forEach(referencingRuleChainId -&gt;</b>
<b class="nc">&nbsp;                                tbClusterService.broadcastEntityStateChangeEvent(tenantId, referencingRuleChainId, ComponentLifecycleEvent.UPDATED));</b>
&nbsp;                    }
<b class="nc">&nbsp;                    tbClusterService.broadcastEntityStateChangeEvent(tenantId, ruleChain.getId(), ComponentLifecycleEvent.DELETED);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            case TENANT -&gt; {
<b class="nc">&nbsp;                Tenant tenant = (Tenant) event.getEntity();</b>
<b class="nc">&nbsp;                onTenantDeleted(tenant);</b>
&nbsp;            }
&nbsp;            case TENANT_PROFILE -&gt; {
<b class="nc">&nbsp;                TenantProfile tenantProfile = (TenantProfile) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onTenantProfileDelete(tenantProfile, TbQueueCallback.EMPTY);</b>
&nbsp;            }
&nbsp;            case DEVICE -&gt; {
<b class="nc">&nbsp;                Device device = (Device) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onDeviceDeleted(tenantId, device, TbQueueCallback.EMPTY);</b>
&nbsp;            }
&nbsp;            case DEVICE_PROFILE -&gt; {
<b class="nc">&nbsp;                DeviceProfile deviceProfile = (DeviceProfile) event.getEntity();</b>
<b class="nc">&nbsp;                onDeviceProfileDelete(event.getTenantId(), event.getEntityId(), deviceProfile);</b>
&nbsp;            }
&nbsp;            case TB_RESOURCE -&gt; {
<b class="nc">&nbsp;                TbResourceInfo tbResource = (TbResourceInfo) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onResourceDeleted(tbResource, TbQueueCallback.EMPTY);</b>
&nbsp;            }
&nbsp;            case CALCULATED_FIELD -&gt; {
<b class="nc">&nbsp;                CalculatedField calculatedField = (CalculatedField) event.getEntity();</b>
<b class="nc">&nbsp;                tbClusterService.onCalculatedFieldDeleted(calculatedField, TbQueueCallback.EMPTY);</b>
&nbsp;            }
&nbsp;            default -&gt; {
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @TransactionalEventListener(fallbackExecution = true)
&nbsp;    public void handleEvent(ActionEntityEvent&lt;?&gt; event) {
<b class="nc">&nbsp;        TenantId tenantId = event.getTenantId();</b>
<b class="nc">&nbsp;        log.trace(&quot;[{}] ActionEntityEvent called: {}&quot;, tenantId, event);</b>
<b class="nc">&nbsp;        switch (event.getActionType()) {</b>
&nbsp;            case CREDENTIALS_UPDATED -&gt; {
<b class="nc">&nbsp;                if (event.getEntityId().getEntityType() == EntityType.DEVICE &amp;&amp; event.getEntity() instanceof DeviceCredentials deviceCredentials) {</b>
<b class="nc">&nbsp;                    tbClusterService.pushMsgToCore(new DeviceCredentialsUpdateNotificationMsg(tenantId,</b>
<b class="nc">&nbsp;                            (DeviceId) event.getEntityId(), deviceCredentials), null);</b>
<b class="nc">&nbsp;                } else if (event.getEntityId().getEntityType() == EntityType.USER) {</b>
<b class="nc">&nbsp;                    tbClusterService.broadcastEntityStateChangeEvent(event.getTenantId(), event.getEntityId(), ComponentLifecycleEvent.UPDATED);</b>
&nbsp;
&nbsp;                }
&nbsp;            }
&nbsp;            case ASSIGNED_TO_TENANT -&gt; {
<b class="nc">&nbsp;                if (event.getEntity() instanceof Device device) {</b>
<b class="nc">&nbsp;                    Tenant tenant = JacksonUtil.fromString(event.getBody(), Tenant.class);</b>
<b class="nc">&nbsp;                    if (tenant != null) {</b>
<b class="nc">&nbsp;                        tbClusterService.onDeviceAssignedToTenant(tenant.getId(), device);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    pushAssignedFromNotification(tenant, tenantId, device);</b>
&nbsp;                }
&nbsp;            }
&nbsp;            case ALARM_ACK, ALARM_CLEAR, ALARM_DELETE -&gt; {
<b class="nc">&nbsp;                if (event.getActionType() == ActionType.ALARM_DELETE &amp;&amp; !tenantExists(tenantId)) {</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                Alarm alarm = (Alarm) event.getEntity();</b>
<b class="nc">&nbsp;                if (calculatedFieldCache.hasCalculatedFields(tenantId, alarm.getOriginator(), ctx -&gt; ctx.getCfType() == CalculatedFieldType.ALARM)) {</b>
<b class="nc">&nbsp;                    ToCalculatedFieldMsg msg = ToCalculatedFieldMsg.newBuilder()</b>
<b class="nc">&nbsp;                            .setEventMsg(toProto(event))</b>
<b class="nc">&nbsp;                            .build();</b>
<b class="nc">&nbsp;                    tbClusterService.pushMsgToCalculatedFields(tenantId, alarm.getOriginator(), msg, new TbQueueCallback() {</b>
&nbsp;                        @Override
<b class="nc">&nbsp;                        public void onSuccess(TbQueueMsgMetadata metadata) {}</b>
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void onFailure(Throwable t) {
<b class="nc">&nbsp;                            log.error(&quot;[{}] Failed to push alarm event to CF queue: {}&quot;, tenantId, event, t);</b>
&nbsp;                        }
&nbsp;                    });
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @TransactionalEventListener(fallbackExecution = true)
&nbsp;    public void handleEvent(RelationActionEvent relationEvent) {
<b class="nc">&nbsp;        EntityRelation relation = relationEvent.getRelation();</b>
<b class="nc">&nbsp;        if (CalculatedField.isSupportedRefEntity(relation.getFrom()) &amp;&amp; CalculatedField.isSupportedRefEntity(relation.getTo())) {</b>
<b class="nc">&nbsp;            if (relationEvent.getActionType() == ActionType.RELATION_ADD_OR_UPDATE) {</b>
<b class="nc">&nbsp;                tbClusterService.onRelationUpdated(relationEvent.getTenantId(), relation, TbQueueCallback.EMPTY);</b>
<b class="nc">&nbsp;            } else if (relationEvent.getActionType() == ActionType.RELATION_DELETED) {</b>
<b class="nc">&nbsp;                tbClusterService.onRelationDeleted(relationEvent.getTenantId(), relation, TbQueueCallback.EMPTY);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onTenantUpdate(Tenant tenant, ComponentLifecycleEvent lifecycleEvent) {
<b class="nc">&nbsp;        tbClusterService.onTenantChange(tenant, null);</b>
<b class="nc">&nbsp;        tbClusterService.broadcastEntityStateChangeEvent(tenant.getId(), tenant.getId(), lifecycleEvent);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onTenantDeleted(Tenant tenant) {
<b class="nc">&nbsp;        tbClusterService.onTenantDelete(tenant, null);</b>
<b class="nc">&nbsp;        tbClusterService.broadcastEntityStateChangeEvent(tenant.getId(), tenant.getId(), ComponentLifecycleEvent.DELETED);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onTenantProfileUpdate(TenantProfile tenantProfile, ComponentLifecycleEvent lifecycleEvent) {
<b class="nc">&nbsp;        tbClusterService.onTenantProfileChange(tenantProfile, null);</b>
<b class="nc">&nbsp;        tbClusterService.broadcastEntityStateChangeEvent(TenantId.SYS_TENANT_ID, tenantProfile.getId(), lifecycleEvent);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onDeviceProfileUpdate(DeviceProfile deviceProfile, Object oldEntity, boolean isCreated) {
<b class="nc">&nbsp;        DeviceProfile oldDeviceProfile = null;</b>
<b class="nc">&nbsp;        if (!isCreated) {</b>
<b class="nc">&nbsp;            oldDeviceProfile = getOldDeviceProfile(oldEntity);</b>
&nbsp;        }
<b class="nc">&nbsp;        tbClusterService.onDeviceProfileChange(deviceProfile, oldDeviceProfile, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private DeviceProfile getOldDeviceProfile(Object oldEntity) {
<b class="nc">&nbsp;        return oldEntity instanceof DeviceProfile ? (DeviceProfile) oldEntity : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onDeviceProfileDelete(TenantId tenantId, EntityId entityId, DeviceProfile deviceProfile) {
<b class="nc">&nbsp;        tbClusterService.onDeviceProfileDelete(deviceProfile, null);</b>
<b class="nc">&nbsp;        tbClusterService.broadcastEntityStateChangeEvent(tenantId, entityId, ComponentLifecycleEvent.DELETED);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onDeviceUpdate(Object entity, Object oldEntity) {
<b class="nc">&nbsp;        Device device = (Device) entity;</b>
<b class="nc">&nbsp;        Device oldDevice = null;</b>
<b class="nc">&nbsp;        if (oldEntity instanceof Device) {</b>
<b class="nc">&nbsp;            oldDevice = (Device) oldEntity;</b>
&nbsp;        }
<b class="nc">&nbsp;        tbClusterService.onDeviceUpdated(device, oldDevice);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onAssetUpdate(Object entity, Object oldEntity) {
<b class="nc">&nbsp;        Asset asset = (Asset) entity;</b>
<b class="nc">&nbsp;        Asset oldAsset = null;</b>
<b class="nc">&nbsp;        if (oldEntity instanceof Asset) {</b>
<b class="nc">&nbsp;            oldAsset = (Asset) oldEntity;</b>
&nbsp;        }
<b class="nc">&nbsp;        tbClusterService.onAssetUpdated(asset, oldAsset);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onEdgeEvent(TenantId tenantId, EntityId entityId, Object entity, ComponentLifecycleEvent lifecycleEvent) {
<b class="nc">&nbsp;        if (entity instanceof Edge) {</b>
<b class="nc">&nbsp;            if (entityId.equals(edgeSynchronizationManager.getEdgeId().get())) {</b>
&nbsp;                return;
&nbsp;            }
<b class="nc">&nbsp;            tbClusterService.onEdgeStateChangeEvent(new ComponentLifecycleMsg(tenantId, entityId, lifecycleEvent));</b>
<b class="nc">&nbsp;        } else if (entity instanceof EdgeEvent edgeEvent) {</b>
<b class="nc">&nbsp;            tbClusterService.onEdgeEventUpdate(new EdgeEventUpdateMsg(tenantId, edgeEvent.getEdgeId()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void onCalculatedFieldUpdate(Object entity, Object oldEntity) {
<b class="nc">&nbsp;        CalculatedField calculatedField = (CalculatedField) entity;</b>
<b class="nc">&nbsp;        CalculatedField oldCalculatedField = null;</b>
<b class="nc">&nbsp;        if (oldEntity instanceof CalculatedField) {</b>
<b class="nc">&nbsp;            oldCalculatedField = (CalculatedField) oldEntity;</b>
&nbsp;        }
<b class="nc">&nbsp;        tbClusterService.onCalculatedFieldUpdated(calculatedField, oldCalculatedField, TbQueueCallback.EMPTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void onJobUpdate(Job job) {
<b class="nc">&nbsp;        jobManager.onJobUpdate(job);</b>
&nbsp;
&nbsp;        ComponentLifecycleEvent event;
<b class="nc">&nbsp;        if (job.getResult().getCancellationTs() &gt; 0) {</b>
<b class="nc">&nbsp;            event = ComponentLifecycleEvent.STOPPED;</b>
<b class="nc">&nbsp;        } else if (job.getResult().getGeneralError() != null) {</b>
<b class="nc">&nbsp;            event = ComponentLifecycleEvent.FAILED;</b>
&nbsp;        } else {
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        ComponentLifecycleMsg msg = ComponentLifecycleMsg.builder()</b>
<b class="nc">&nbsp;                .tenantId(job.getTenantId())</b>
<b class="nc">&nbsp;                .entityId(job.getId())</b>
<b class="nc">&nbsp;                .event(event)</b>
<b class="nc">&nbsp;                .info(JacksonUtil.newObjectNode()</b>
<b class="nc">&nbsp;                        .put(&quot;tasksKey&quot;, job.getConfiguration().getTasksKey()))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;        // task processors will add this job to the list of discarded
<b class="nc">&nbsp;        tbClusterService.broadcast(msg);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void pushAssignedFromNotification(Tenant currentTenant, TenantId newTenantId, Device assignedDevice) {
<b class="nc">&nbsp;        String data = JacksonUtil.toString(JacksonUtil.valueToTree(assignedDevice));</b>
<b class="nc">&nbsp;        if (data != null) {</b>
<b class="nc">&nbsp;            TbMsg tbMsg = TbMsg.newMsg()</b>
<b class="nc">&nbsp;                    .type(TbMsgType.ENTITY_ASSIGNED_FROM_TENANT)</b>
<b class="nc">&nbsp;                    .originator(assignedDevice.getId())</b>
<b class="nc">&nbsp;                    .customerId(assignedDevice.getCustomerId())</b>
<b class="nc">&nbsp;                    .copyMetaData(getMetaDataForAssignedFrom(currentTenant))</b>
<b class="nc">&nbsp;                    .dataType(TbMsgDataType.JSON)</b>
<b class="nc">&nbsp;                    .data(data)</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            tbClusterService.pushMsgToRuleEngine(newTenantId, assignedDevice.getId(), tbMsg, null);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean tenantExists(TenantId tenantId) {
<b class="nc">&nbsp;        return tenantId.isSysTenantId() || tenantService.tenantExists(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TbMsgMetaData getMetaDataForAssignedFrom(Tenant tenant) {
<b class="nc">&nbsp;        TbMsgMetaData metaData = new TbMsgMetaData();</b>
<b class="nc">&nbsp;        metaData.putValue(&quot;assignedFromTenantId&quot;, tenant.getId().getId().toString());</b>
<b class="nc">&nbsp;        metaData.putValue(&quot;assignedFromTenantName&quot;, tenant.getName());</b>
<b class="nc">&nbsp;        return metaData;</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityActionEventProto toProto(ActionEntityEvent&lt;?&gt; event) {
<b class="nc">&nbsp;        return EntityActionEventProto.newBuilder()</b>
<b class="nc">&nbsp;                .setTenantId(ProtoUtils.toProto(event.getTenantId()))</b>
<b class="nc">&nbsp;                .setEntityId(ProtoUtils.toProto(event.getEntityId()))</b>
<b class="nc">&nbsp;                .setAction(event.getActionType().name())</b>
<b class="nc">&nbsp;                .setEntity(event.getEntity() != null ? JacksonUtil.toString(event.getEntity()) : &quot;&quot;)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

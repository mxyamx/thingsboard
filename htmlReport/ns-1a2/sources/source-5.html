<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CassandraTsLatestToSqlMigrateService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.install.migrate</a>
</div>

<h1>Coverage Summary for Class: CassandraTsLatestToSqlMigrateService (org.thingsboard.server.service.install.migrate)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CassandraTsLatestToSqlMigrateService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/80)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CassandraTsLatestToSqlMigrateService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/84)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.install.migrate;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.hibernate.exception.ConstraintViolationException;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.annotation.Profile;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.UUIDConverter;
&nbsp;import org.thingsboard.server.dao.cassandra.CassandraCluster;
&nbsp;import org.thingsboard.server.dao.model.sqlts.dictionary.KeyDictionaryCompositeKey;
&nbsp;import org.thingsboard.server.dao.model.sqlts.dictionary.KeyDictionaryEntry;
&nbsp;import org.thingsboard.server.dao.model.sqlts.latest.TsKvLatestEntity;
&nbsp;import org.thingsboard.server.dao.sqlts.dictionary.KeyDictionaryRepository;
&nbsp;import org.thingsboard.server.dao.sqlts.insert.latest.InsertLatestTsRepository;
&nbsp;import org.thingsboard.server.dao.util.NoSqlTsDao;
&nbsp;import org.thingsboard.server.dao.util.SqlTsLatestDao;
&nbsp;import org.thingsboard.server.service.install.InstallScripts;
&nbsp;
&nbsp;import java.nio.charset.Charset;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.Paths;
&nbsp;import java.sql.Connection;
&nbsp;import java.sql.DriverManager;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.bigintColumn;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.booleanColumn;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.doubleColumn;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.idColumn;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.jsonColumn;
&nbsp;import static org.thingsboard.server.service.install.migrate.CassandraToSqlColumn.stringColumn;
&nbsp;
&nbsp;@Service
&nbsp;@Profile(&quot;install&quot;)
&nbsp;@NoSqlTsDao
&nbsp;@SqlTsLatestDao
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class CassandraTsLatestToSqlMigrateService implements TsLatestMigrateService {</b>
&nbsp;
&nbsp;    private static final int MAX_KEY_LENGTH = 255;
&nbsp;    private static final int MAX_STR_V_LENGTH = 10000000;
&nbsp;
&nbsp;    private static final String SQL_DIR = &quot;sql&quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private InsertLatestTsRepository insertLatestTsRepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected CassandraCluster cluster;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected KeyDictionaryRepository keyDictionaryRepository;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private InstallScripts installScripts;
&nbsp;
&nbsp;    @Value(&quot;${spring.datasource.url}&quot;)
&nbsp;    protected String dbUrl;
&nbsp;
&nbsp;    @Value(&quot;${spring.datasource.username}&quot;)
&nbsp;    protected String dbUserName;
&nbsp;
&nbsp;    @Value(&quot;${spring.datasource.password}&quot;)
&nbsp;    protected String dbPassword;
&nbsp;
<b class="nc">&nbsp;    private final ConcurrentMap&lt;String, Integer&gt; tsKvDictionaryMap = new ConcurrentHashMap&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    protected static final ReentrantLock tsCreationLock = new ReentrantLock();</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void migrate() throws Exception {
<b class="nc">&nbsp;        log.info(&quot;Performing migration of latest timeseries data from cassandra to SQL database ...&quot;);</b>
<b class="nc">&nbsp;        try (Connection conn = DriverManager.getConnection(dbUrl, dbUserName, dbPassword)) {</b>
<b class="nc">&nbsp;            Path schemaUpdateFile = Paths.get(installScripts.getDataDir(), SQL_DIR, &quot;schema-ts-latest-psql.sql&quot;);</b>
<b class="nc">&nbsp;            loadSql(schemaUpdateFile, conn);</b>
<b class="nc">&nbsp;            conn.setAutoCommit(false);</b>
<b class="nc">&nbsp;            for (CassandraToSqlTable table : tables) {</b>
<b class="nc">&nbsp;                table.migrateToSql(cluster.getSession(), conn);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Unexpected error during ThingsBoard entities data migration!&quot;, e);</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private List&lt;CassandraToSqlTable&gt; tables = Arrays.asList(</b>
&nbsp;            new CassandraToSqlTable(&quot;ts_kv_latest_cf&quot;, &quot;ts_kv_latest&quot;,
<b class="nc">&nbsp;                    idColumn(&quot;entity_id&quot;),</b>
<b class="nc">&nbsp;                    stringColumn(&quot;key&quot;),</b>
<b class="nc">&nbsp;                    bigintColumn(&quot;ts&quot;),</b>
<b class="nc">&nbsp;                    booleanColumn(&quot;bool_v&quot;),</b>
<b class="nc">&nbsp;                    stringColumn(&quot;str_v&quot;),</b>
<b class="nc">&nbsp;                    bigintColumn(&quot;long_v&quot;),</b>
<b class="nc">&nbsp;                    doubleColumn(&quot;dbl_v&quot;),</b>
<b class="nc">&nbsp;                    jsonColumn(&quot;json_v&quot;)) {</b>
&nbsp;
&nbsp;                @Override
&nbsp;                protected void batchInsert(List&lt;CassandraToSqlColumnData[]&gt; batchData, Connection conn) {
<b class="nc">&nbsp;                    insertLatestTsRepository</b>
<b class="nc">&nbsp;                            .saveOrUpdate(batchData.stream().map(data -&gt; getTsKvLatestEntity(data)).collect(Collectors.toList()));</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                protected CassandraToSqlColumnData[] validateColumnData(CassandraToSqlColumnData[] data) {
<b class="nc">&nbsp;                    return data;</b>
&nbsp;                }
&nbsp;            });
&nbsp;
&nbsp;    private TsKvLatestEntity getTsKvLatestEntity(CassandraToSqlColumnData[] data) {
<b class="nc">&nbsp;        TsKvLatestEntity latestEntity = new TsKvLatestEntity();</b>
<b class="nc">&nbsp;        latestEntity.setEntityId(UUIDConverter.fromString(data[0].getValue()));</b>
<b class="nc">&nbsp;        latestEntity.setKey(getOrSaveKeyId(data[1].getValue()));</b>
<b class="nc">&nbsp;        latestEntity.setTs(Long.parseLong(data[2].getValue()));</b>
&nbsp;
<b class="nc">&nbsp;        String strV = data[4].getValue();</b>
<b class="nc">&nbsp;        if (strV != null) {</b>
<b class="nc">&nbsp;            if (strV.length() &gt; MAX_STR_V_LENGTH) {</b>
<b class="nc">&nbsp;                log.warn(&quot;[ts_kv_latest] Value size [{}] exceeds maximum size [{}] of column [str_v] and will be truncated!&quot;,</b>
<b class="nc">&nbsp;                        strV.length(), MAX_STR_V_LENGTH);</b>
<b class="nc">&nbsp;                log.warn(&quot;Affected data:\n{}&quot;, strV);</b>
<b class="nc">&nbsp;                strV = strV.substring(0, MAX_STR_V_LENGTH);</b>
&nbsp;            }
<b class="nc">&nbsp;            latestEntity.setStrValue(strV);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            Long longV = null;</b>
&nbsp;            try {
<b class="nc">&nbsp;                longV = Long.parseLong(data[5].getValue());</b>
&nbsp;            } catch (Exception e) {
&nbsp;            }
<b class="nc">&nbsp;            if (longV != null) {</b>
<b class="nc">&nbsp;                latestEntity.setLongValue(longV);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                Double doubleV = null;</b>
&nbsp;                try {
<b class="nc">&nbsp;                    doubleV = Double.parseDouble(data[6].getValue());</b>
&nbsp;                } catch (Exception e) {
&nbsp;                }
<b class="nc">&nbsp;                if (doubleV != null) {</b>
<b class="nc">&nbsp;                    latestEntity.setDoubleValue(doubleV);</b>
&nbsp;                } else {
&nbsp;
<b class="nc">&nbsp;                    String jsonV = data[7].getValue();</b>
<b class="nc">&nbsp;                    if (StringUtils.isNoneEmpty(jsonV)) {</b>
<b class="nc">&nbsp;                        latestEntity.setJsonValue(jsonV);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        Boolean boolV = null;</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            boolV = Boolean.parseBoolean(data[3].getValue());</b>
&nbsp;                        } catch (Exception e) {
&nbsp;                        }
<b class="nc">&nbsp;                        if (boolV != null) {</b>
<b class="nc">&nbsp;                            latestEntity.setBooleanValue(boolV);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            log.warn(&quot;All values in key-value row are nullable &quot;);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return latestEntity;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected Integer getOrSaveKeyId(String strKey) {
<b class="nc">&nbsp;        if (strKey.length() &gt; MAX_KEY_LENGTH) {</b>
<b class="nc">&nbsp;            log.warn(&quot;[ts_kv_latest] Value size [{}] exceeds maximum size [{}] of column [key] and will be truncated!&quot;,</b>
<b class="nc">&nbsp;                    strKey.length(), MAX_KEY_LENGTH);</b>
<b class="nc">&nbsp;            log.warn(&quot;Affected data:\n{}&quot;, strKey);</b>
<b class="nc">&nbsp;            strKey = strKey.substring(0, MAX_KEY_LENGTH);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Integer keyId = tsKvDictionaryMap.get(strKey);</b>
<b class="nc">&nbsp;        if (keyId == null) {</b>
&nbsp;            Optional&lt;KeyDictionaryEntry&gt; tsKvDictionaryOptional;
<b class="nc">&nbsp;            tsKvDictionaryOptional = keyDictionaryRepository.findById(new KeyDictionaryCompositeKey(strKey));</b>
<b class="nc">&nbsp;            if (!tsKvDictionaryOptional.isPresent()) {</b>
<b class="nc">&nbsp;                tsCreationLock.lock();</b>
&nbsp;                try {
<b class="nc">&nbsp;                    tsKvDictionaryOptional = keyDictionaryRepository.findById(new KeyDictionaryCompositeKey(strKey));</b>
<b class="nc">&nbsp;                    if (!tsKvDictionaryOptional.isPresent()) {</b>
<b class="nc">&nbsp;                        KeyDictionaryEntry keyDictionaryEntry = new KeyDictionaryEntry();</b>
<b class="nc">&nbsp;                        keyDictionaryEntry.setKey(strKey);</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            KeyDictionaryEntry saved = keyDictionaryRepository.save(keyDictionaryEntry);</b>
<b class="nc">&nbsp;                            tsKvDictionaryMap.put(saved.getKey(), saved.getKeyId());</b>
<b class="nc">&nbsp;                            keyId = saved.getKeyId();</b>
&nbsp;                        } catch (ConstraintViolationException e) {
<b class="nc">&nbsp;                            tsKvDictionaryOptional = keyDictionaryRepository.findById(new KeyDictionaryCompositeKey(strKey));</b>
<b class="nc">&nbsp;                            KeyDictionaryEntry dictionary = tsKvDictionaryOptional.orElseThrow(() -&gt; new RuntimeException(&quot;Failed to get TsKvDictionary entity from DB!&quot;));</b>
<b class="nc">&nbsp;                            tsKvDictionaryMap.put(dictionary.getKey(), dictionary.getKeyId());</b>
<b class="nc">&nbsp;                            keyId = dictionary.getKeyId();</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        keyId = tsKvDictionaryOptional.get().getKeyId();</b>
&nbsp;                    }
&nbsp;                } finally {
<b class="nc">&nbsp;                    tsCreationLock.unlock();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } else {
<b class="nc">&nbsp;                keyId = tsKvDictionaryOptional.get().getKeyId();</b>
<b class="nc">&nbsp;                tsKvDictionaryMap.put(strKey, keyId);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return keyId;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void loadSql(Path sqlFile, Connection conn) throws Exception {
<b class="nc">&nbsp;        String sql = new String(Files.readAllBytes(sqlFile), Charset.forName(&quot;UTF-8&quot;));</b>
<b class="nc">&nbsp;        conn.createStatement().execute(sql); //NOSONAR, ignoring because method used to execute thingsboard database upgrade script</b>
<b class="nc">&nbsp;        Thread.sleep(5000);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

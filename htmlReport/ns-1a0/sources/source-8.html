<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultSystemDataLoaderService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.install</a>
</div>

<h1>Coverage Summary for Class: DefaultSystemDataLoaderService (org.thingsboard.server.service.install)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultSystemDataLoaderService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/402)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultSystemDataLoaderService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultSystemDataLoaderService$TelemetrySaveCallback</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/411)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.install;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import lombok.Getter;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.SneakyThrows;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.collections4.CollectionUtils;
&nbsp;import org.apache.commons.lang3.RandomStringUtils;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Profile;
&nbsp;import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.common.util.ThingsBoardThreadFactory;
&nbsp;import org.thingsboard.server.common.data.AdminSettings;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.Customer;
&nbsp;import org.thingsboard.server.common.data.DataConstants;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileProvisionType;
&nbsp;import org.thingsboard.server.common.data.DeviceProfileType;
&nbsp;import org.thingsboard.server.common.data.DeviceTransportType;
&nbsp;import org.thingsboard.server.common.data.Tenant;
&nbsp;import org.thingsboard.server.common.data.TenantProfile;
&nbsp;import org.thingsboard.server.common.data.User;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmSeverity;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.AlarmRule;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.AlarmConditionValue;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.SimpleAlarmCondition;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.AlarmConditionFilter;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.ComplexOperation;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.SimpleAlarmConditionExpression;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.BooleanFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.alarm.rule.condition.expression.predicate.NumericFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedField;
&nbsp;import org.thingsboard.server.common.data.cf.CalculatedFieldType;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.AlarmCalculatedFieldConfiguration;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.Argument;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.ArgumentType;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.ReferencedEntityKey;
&nbsp;import org.thingsboard.server.common.data.debug.DebugSettings;
&nbsp;import org.thingsboard.server.common.data.device.profile.DefaultDeviceProfileConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.DefaultDeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.profile.DeviceProfileData;
&nbsp;import org.thingsboard.server.common.data.device.profile.DisabledDeviceProfileProvisionConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.DeviceProfileId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.kv.AttributesSaveResult;
&nbsp;import org.thingsboard.server.common.data.kv.BaseAttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.BasicTsKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.BooleanDataEntry;
&nbsp;import org.thingsboard.server.common.data.kv.DoubleDataEntry;
&nbsp;import org.thingsboard.server.common.data.kv.LongDataEntry;
&nbsp;import org.thingsboard.server.common.data.kv.TimeseriesSaveResult;
&nbsp;import org.thingsboard.server.common.data.mobile.app.MobileApp;
&nbsp;import org.thingsboard.server.common.data.page.PageDataIterable;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyValueType;
&nbsp;import org.thingsboard.server.common.data.queue.ProcessingStrategy;
&nbsp;import org.thingsboard.server.common.data.queue.ProcessingStrategyType;
&nbsp;import org.thingsboard.server.common.data.queue.Queue;
&nbsp;import org.thingsboard.server.common.data.queue.SubmitStrategy;
&nbsp;import org.thingsboard.server.common.data.queue.SubmitStrategyType;
&nbsp;import org.thingsboard.server.common.data.rule.RuleChainType;
&nbsp;import org.thingsboard.server.common.data.security.Authority;
&nbsp;import org.thingsboard.server.common.data.security.DeviceCredentials;
&nbsp;import org.thingsboard.server.common.data.security.UserCredentials;
&nbsp;import org.thingsboard.server.common.data.security.model.JwtSettings;
&nbsp;import org.thingsboard.server.common.data.tenant.profile.DefaultTenantProfileConfiguration;
&nbsp;import org.thingsboard.server.common.data.tenant.profile.TenantProfileData;
&nbsp;import org.thingsboard.server.common.data.tenant.profile.TenantProfileQueueConfiguration;
&nbsp;import org.thingsboard.server.dao.attributes.AttributesService;
&nbsp;import org.thingsboard.server.dao.cf.CalculatedFieldService;
&nbsp;import org.thingsboard.server.dao.customer.CustomerService;
&nbsp;import org.thingsboard.server.dao.device.DeviceConnectivityConfiguration;
&nbsp;import org.thingsboard.server.dao.device.DeviceCredentialsService;
&nbsp;import org.thingsboard.server.dao.device.DeviceProfileService;
&nbsp;import org.thingsboard.server.dao.device.DeviceService;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.mobile.MobileAppDao;
&nbsp;import org.thingsboard.server.dao.notification.NotificationSettingsService;
&nbsp;import org.thingsboard.server.dao.notification.NotificationTargetService;
&nbsp;import org.thingsboard.server.dao.queue.QueueService;
&nbsp;import org.thingsboard.server.dao.rule.RuleChainService;
&nbsp;import org.thingsboard.server.dao.settings.AdminSettingsService;
&nbsp;import org.thingsboard.server.dao.tenant.TenantProfileService;
&nbsp;import org.thingsboard.server.dao.tenant.TenantService;
&nbsp;import org.thingsboard.server.dao.timeseries.TimeseriesService;
&nbsp;import org.thingsboard.server.dao.user.UserService;
&nbsp;import org.thingsboard.server.service.security.auth.jwt.settings.JwtSettingsService;
&nbsp;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Base64;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;
&nbsp;import static org.thingsboard.common.util.DebugModeUtil.DEBUG_MODE_DEFAULT_DURATION_MINUTES;
&nbsp;import static org.thingsboard.server.common.data.DataConstants.DEFAULT_DEVICE_TYPE;
&nbsp;import static org.thingsboard.server.service.security.auth.jwt.settings.DefaultJwtSettingsService.isSigningKeyDefault;
&nbsp;import static org.thingsboard.server.service.security.auth.jwt.settings.DefaultJwtSettingsService.validateKeyLength;
&nbsp;
&nbsp;@Service
&nbsp;@Profile(&quot;install&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class DefaultSystemDataLoaderService implements SystemDataLoaderService {
&nbsp;
&nbsp;    public static final String CUSTOMER_CRED = &quot;customer&quot;;
&nbsp;    public static final String ACTIVITY_STATE = &quot;active&quot;;
&nbsp;
&nbsp;    private final InstallScripts installScripts;
&nbsp;    private final UserService userService;
&nbsp;    private final AdminSettingsService adminSettingsService;
&nbsp;    private final TenantService tenantService;
&nbsp;    private final TenantProfileService tenantProfileService;
&nbsp;    private final CustomerService customerService;
&nbsp;    private final DeviceService deviceService;
&nbsp;    private final DeviceProfileService deviceProfileService;
&nbsp;    private final AttributesService attributesService;
&nbsp;    private final DeviceCredentialsService deviceCredentialsService;
&nbsp;    private final RuleChainService ruleChainService;
&nbsp;    private final TimeseriesService tsService;
&nbsp;    private final DeviceConnectivityConfiguration connectivityConfiguration;
&nbsp;    private final QueueService queueService;
&nbsp;    private final JwtSettingsService jwtSettingsService;
&nbsp;    private final MobileAppDao mobileAppDao;
&nbsp;    private final NotificationSettingsService notificationSettingsService;
&nbsp;    private final NotificationTargetService notificationTargetService;
&nbsp;    private final CalculatedFieldService calculatedFieldService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private BCryptPasswordEncoder passwordEncoder;
&nbsp;
&nbsp;    @Value(&quot;${state.persistToTelemetry:false}&quot;)
&nbsp;    @Getter
&nbsp;    private boolean persistActivityToTelemetry;
&nbsp;
&nbsp;    @Value(&quot;${security.jwt.tokenExpirationTime:9000}&quot;)
&nbsp;    private Integer tokenExpirationTime;
&nbsp;    @Value(&quot;${security.jwt.refreshTokenExpTime:604800}&quot;)
&nbsp;    private Integer refreshTokenExpTime;
&nbsp;    @Value(&quot;${security.jwt.tokenIssuer:thingsboard.io}&quot;)
&nbsp;    private String tokenIssuer;
&nbsp;    @Value(&quot;${security.jwt.tokenSigningKey:thingsboardDefaultSigningKey}&quot;)
&nbsp;    private String tokenSigningKey;
&nbsp;
&nbsp;    @Bean
&nbsp;    protected BCryptPasswordEncoder passwordEncoder() {
<b class="nc">&nbsp;        return new BCryptPasswordEncoder();</b>
&nbsp;    }
&nbsp;
&nbsp;    private ExecutorService tsCallBackExecutor;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    public void initExecutor() {
<b class="nc">&nbsp;        tsCallBackExecutor = Executors.newSingleThreadExecutor(ThingsBoardThreadFactory.forName(&quot;sys-loader-ts-callback&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    public void shutdownExecutor() {
<b class="nc">&nbsp;        if (tsCallBackExecutor != null) {</b>
<b class="nc">&nbsp;            tsCallBackExecutor.shutdownNow();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createSysAdmin() {
<b class="nc">&nbsp;        createUser(Authority.SYS_ADMIN, null, null, &quot;sysadmin@thingsboard.org&quot;, &quot;sysadmin&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createDefaultTenantProfiles() throws Exception {
<b class="nc">&nbsp;        tenantProfileService.findOrCreateDefaultTenantProfile(TenantId.SYS_TENANT_ID);</b>
&nbsp;
<b class="nc">&nbsp;        TenantProfileData isolatedRuleEngineTenantProfileData = new TenantProfileData();</b>
<b class="nc">&nbsp;        DefaultTenantProfileConfiguration configuration = new DefaultTenantProfileConfiguration();</b>
<b class="nc">&nbsp;        configuration.setMaxDebugModeDurationMinutes(DEBUG_MODE_DEFAULT_DURATION_MINUTES);</b>
<b class="nc">&nbsp;        isolatedRuleEngineTenantProfileData.setConfiguration(configuration);</b>
&nbsp;
<b class="nc">&nbsp;        TenantProfileQueueConfiguration mainQueueConfiguration = new TenantProfileQueueConfiguration();</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setName(DataConstants.MAIN_QUEUE_NAME);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setTopic(DataConstants.MAIN_QUEUE_TOPIC);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setPollInterval(25);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setPartitions(10);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setConsumerPerPartition(true);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setPackProcessingTimeout(2000);</b>
<b class="nc">&nbsp;        SubmitStrategy mainQueueSubmitStrategy = new SubmitStrategy();</b>
<b class="nc">&nbsp;        mainQueueSubmitStrategy.setType(SubmitStrategyType.BURST);</b>
<b class="nc">&nbsp;        mainQueueSubmitStrategy.setBatchSize(1000);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setSubmitStrategy(mainQueueSubmitStrategy);</b>
<b class="nc">&nbsp;        ProcessingStrategy mainQueueProcessingStrategy = new ProcessingStrategy();</b>
<b class="nc">&nbsp;        mainQueueProcessingStrategy.setType(ProcessingStrategyType.SKIP_ALL_FAILURES);</b>
<b class="nc">&nbsp;        mainQueueProcessingStrategy.setRetries(3);</b>
<b class="nc">&nbsp;        mainQueueProcessingStrategy.setFailurePercentage(0);</b>
<b class="nc">&nbsp;        mainQueueProcessingStrategy.setPauseBetweenRetries(3);</b>
<b class="nc">&nbsp;        mainQueueProcessingStrategy.setMaxPauseBetweenRetries(3);</b>
<b class="nc">&nbsp;        mainQueueConfiguration.setProcessingStrategy(mainQueueProcessingStrategy);</b>
&nbsp;
<b class="nc">&nbsp;        isolatedRuleEngineTenantProfileData.setQueueConfiguration(Collections.singletonList(mainQueueConfiguration));</b>
&nbsp;
<b class="nc">&nbsp;        TenantProfile isolatedTbRuleEngineProfile = new TenantProfile();</b>
<b class="nc">&nbsp;        isolatedTbRuleEngineProfile.setDefault(false);</b>
<b class="nc">&nbsp;        isolatedTbRuleEngineProfile.setName(&quot;Isolated TB Rule Engine&quot;);</b>
<b class="nc">&nbsp;        isolatedTbRuleEngineProfile.setDescription(&quot;Isolated TB Rule Engine tenant profile&quot;);</b>
<b class="nc">&nbsp;        isolatedTbRuleEngineProfile.setIsolatedTbRuleEngine(true);</b>
<b class="nc">&nbsp;        isolatedTbRuleEngineProfile.setProfileData(isolatedRuleEngineTenantProfileData);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            tenantProfileService.saveTenantProfile(TenantId.SYS_TENANT_ID, isolatedTbRuleEngineProfile);</b>
&nbsp;        } catch (DataValidationException e) {
<b class="nc">&nbsp;            log.warn(e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createAdminSettings() throws Exception {
<b class="nc">&nbsp;        AdminSettings generalSettings = new AdminSettings();</b>
<b class="nc">&nbsp;        generalSettings.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;        generalSettings.setKey(&quot;general&quot;);</b>
<b class="nc">&nbsp;        ObjectNode node = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        node.put(&quot;baseUrl&quot;, &quot;http://localhost:8080&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;prohibitDifferentUrl&quot;, false);</b>
<b class="nc">&nbsp;        generalSettings.setJsonValue(node);</b>
<b class="nc">&nbsp;        adminSettingsService.saveAdminSettings(TenantId.SYS_TENANT_ID, generalSettings);</b>
&nbsp;
<b class="nc">&nbsp;        AdminSettings mailSettings = new AdminSettings();</b>
<b class="nc">&nbsp;        mailSettings.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;        mailSettings.setKey(&quot;mail&quot;);</b>
<b class="nc">&nbsp;        node = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        node.put(&quot;mailFrom&quot;, &quot;ThingsBoard &lt;sysadmin@localhost.localdomain&gt;&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;smtpProtocol&quot;, &quot;smtp&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;smtpHost&quot;, &quot;localhost&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;smtpPort&quot;, &quot;25&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;timeout&quot;, &quot;10000&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;enableTls&quot;, false);</b>
<b class="nc">&nbsp;        node.put(&quot;username&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;password&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;        node.put(&quot;tlsVersion&quot;, &quot;TLSv1.2&quot;);//NOSONAR, key used to identify password field (not password value itself)</b>
<b class="nc">&nbsp;        node.put(&quot;enableProxy&quot;, false);</b>
<b class="nc">&nbsp;        node.put(&quot;showChangePassword&quot;, false);</b>
<b class="nc">&nbsp;        mailSettings.setJsonValue(node);</b>
<b class="nc">&nbsp;        adminSettingsService.saveAdminSettings(TenantId.SYS_TENANT_ID, mailSettings);</b>
&nbsp;
<b class="nc">&nbsp;        AdminSettings connectivitySettings = new AdminSettings();</b>
<b class="nc">&nbsp;        connectivitySettings.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;        connectivitySettings.setKey(&quot;connectivity&quot;);</b>
<b class="nc">&nbsp;        connectivitySettings.setJsonValue(JacksonUtil.valueToTree(connectivityConfiguration.getConnectivity()));</b>
<b class="nc">&nbsp;        adminSettingsService.saveAdminSettings(TenantId.SYS_TENANT_ID, connectivitySettings);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createRandomJwtSettings() throws Exception {
<b class="nc">&nbsp;        if (jwtSettingsService.getJwtSettings() == null) {</b>
<b class="nc">&nbsp;            log.info(&quot;Creating JWT admin settings...&quot;);</b>
<b class="nc">&nbsp;            var jwtSettings = new JwtSettings(this.tokenExpirationTime, this.refreshTokenExpTime, this.tokenIssuer, this.tokenSigningKey);</b>
<b class="nc">&nbsp;            if (isSigningKeyDefault(jwtSettings) || !validateKeyLength(jwtSettings.getTokenSigningKey())) {</b>
<b class="nc">&nbsp;                jwtSettings.setTokenSigningKey(generateRandomKey());</b>
&nbsp;            }
<b class="nc">&nbsp;            jwtSettingsService.saveJwtSettings(jwtSettings);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.info(&quot;Skip creating JWT admin settings because they already exist.&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateSecuritySettings() {
<b class="nc">&nbsp;        JwtSettings jwtSettings = jwtSettingsService.getJwtSettings();</b>
<b class="nc">&nbsp;        boolean invalidSignKey = false;</b>
<b class="nc">&nbsp;        String warningMessage = null;</b>
&nbsp;
<b class="nc">&nbsp;        if (isSigningKeyDefault(jwtSettings)) {</b>
<b class="nc">&nbsp;            warningMessage = &quot;The platform is using the default JWT Signing Key, which is a security risk.&quot;;</b>
<b class="nc">&nbsp;            invalidSignKey = true;</b>
<b class="nc">&nbsp;        } else if (!validateKeyLength(jwtSettings.getTokenSigningKey())) {</b>
<b class="nc">&nbsp;            warningMessage = &quot;The JWT Signing Key is shorter than 512 bits, which is a security risk.&quot;;</b>
<b class="nc">&nbsp;            invalidSignKey = true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (invalidSignKey) {</b>
<b class="nc">&nbsp;            log.warn(&quot;WARNING: {}. A new JWT Signing Key has been added automatically. &quot; +</b>
&nbsp;                     &quot;You can change the JWT Signing Key using the Web UI: &quot; +
&nbsp;                     &quot;Navigate to \&quot;System settings -&gt; Security settings\&quot; while logged in as a System Administrator.&quot;, warningMessage);
&nbsp;
<b class="nc">&nbsp;            jwtSettings.setTokenSigningKey(generateRandomKey());</b>
<b class="nc">&nbsp;            jwtSettingsService.saveJwtSettings(jwtSettings);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;MobileApp&gt; mobiles = mobileAppDao.findByTenantId(TenantId.SYS_TENANT_ID, null, new PageLink(Integer.MAX_VALUE, 0)).getData();</b>
<b class="nc">&nbsp;        if (CollectionUtils.isNotEmpty(mobiles)) {</b>
<b class="nc">&nbsp;            mobiles.stream()</b>
<b class="nc">&nbsp;                    .filter(mobileApp -&gt; !validateKeyLength(mobileApp.getAppSecret()))</b>
<b class="nc">&nbsp;                    .forEach(mobileApp -&gt; {</b>
<b class="nc">&nbsp;                        log.warn(&quot;WARNING: The App secret is shorter than 512 bits, which is a security risk. &quot; +</b>
&nbsp;                                 &quot;A new Application Secret has been added automatically for Mobile Application [{}]. &quot; +
&nbsp;                                 &quot;You can change the Application Secret using the Web UI: &quot; +
<b class="nc">&nbsp;                                 &quot;Navigate to \&quot;Security settings -&gt; OAuth2 -&gt; Mobile applications\&quot; while logged in as a System Administrator.&quot;, mobileApp.getPkgName());</b>
<b class="nc">&nbsp;                        mobileApp.setAppSecret(generateRandomKey());</b>
<b class="nc">&nbsp;                        mobileAppDao.save(TenantId.SYS_TENANT_ID, mobileApp);</b>
&nbsp;                    });
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String generateRandomKey() {
<b class="nc">&nbsp;        return Base64.getEncoder().encodeToString(</b>
<b class="nc">&nbsp;                RandomStringUtils.randomAlphanumeric(64).getBytes(StandardCharsets.UTF_8));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createOAuth2Templates() throws Exception {
<b class="nc">&nbsp;        installScripts.createOAuth2Templates();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void loadDemoData() throws Exception {
<b class="nc">&nbsp;        Tenant demoTenant = new Tenant();</b>
<b class="nc">&nbsp;        demoTenant.setRegion(&quot;Global&quot;);</b>
<b class="nc">&nbsp;        demoTenant.setTitle(&quot;Tenant&quot;);</b>
<b class="nc">&nbsp;        demoTenant = tenantService.saveTenant(demoTenant);</b>
<b class="nc">&nbsp;        installScripts.loadDemoRuleChains(demoTenant.getId());</b>
<b class="nc">&nbsp;        createUser(Authority.TENANT_ADMIN, demoTenant.getId(), null, &quot;tenant@thingsboard.org&quot;, &quot;tenant&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        Customer customerA = new Customer();</b>
<b class="nc">&nbsp;        customerA.setTenantId(demoTenant.getId());</b>
<b class="nc">&nbsp;        customerA.setTitle(&quot;Customer A&quot;);</b>
<b class="nc">&nbsp;        customerA = customerService.saveCustomer(customerA);</b>
<b class="nc">&nbsp;        Customer customerB = new Customer();</b>
<b class="nc">&nbsp;        customerB.setTenantId(demoTenant.getId());</b>
<b class="nc">&nbsp;        customerB.setTitle(&quot;Customer B&quot;);</b>
<b class="nc">&nbsp;        customerB = customerService.saveCustomer(customerB);</b>
<b class="nc">&nbsp;        Customer customerC = new Customer();</b>
<b class="nc">&nbsp;        customerC.setTenantId(demoTenant.getId());</b>
<b class="nc">&nbsp;        customerC.setTitle(&quot;Customer C&quot;);</b>
<b class="nc">&nbsp;        customerC = customerService.saveCustomer(customerC);</b>
<b class="nc">&nbsp;        createUser(Authority.CUSTOMER_USER, demoTenant.getId(), customerA.getId(), &quot;customer@thingsboard.org&quot;, CUSTOMER_CRED);</b>
<b class="nc">&nbsp;        createUser(Authority.CUSTOMER_USER, demoTenant.getId(), customerA.getId(), &quot;customerA@thingsboard.org&quot;, CUSTOMER_CRED);</b>
<b class="nc">&nbsp;        createUser(Authority.CUSTOMER_USER, demoTenant.getId(), customerB.getId(), &quot;customerB@thingsboard.org&quot;, CUSTOMER_CRED);</b>
<b class="nc">&nbsp;        createUser(Authority.CUSTOMER_USER, demoTenant.getId(), customerC.getId(), &quot;customerC@thingsboard.org&quot;, CUSTOMER_CRED);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceProfile defaultDeviceProfile = this.deviceProfileService.findOrCreateDeviceProfile(demoTenant.getId(), DEFAULT_DEVICE_TYPE);</b>
&nbsp;
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), customerA.getId(), defaultDeviceProfile.getId(), &quot;Test Device A1&quot;, &quot;A1_TEST_TOKEN&quot;, null);</b>
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), customerA.getId(), defaultDeviceProfile.getId(), &quot;Test Device A2&quot;, &quot;A2_TEST_TOKEN&quot;, null);</b>
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), customerA.getId(), defaultDeviceProfile.getId(), &quot;Test Device A3&quot;, &quot;A3_TEST_TOKEN&quot;, null);</b>
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), customerB.getId(), defaultDeviceProfile.getId(), &quot;Test Device B1&quot;, &quot;B1_TEST_TOKEN&quot;, null);</b>
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), customerC.getId(), defaultDeviceProfile.getId(), &quot;Test Device C1&quot;, &quot;C1_TEST_TOKEN&quot;, null);</b>
&nbsp;
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), null, defaultDeviceProfile.getId(), &quot;DHT11 Demo Device&quot;, &quot;DHT11_DEMO_TOKEN&quot;,</b>
&nbsp;                &quot;Demo device that is used in sample applications that upload data from DHT11 temperature and humidity sensor&quot;);
&nbsp;
<b class="nc">&nbsp;        createDevice(demoTenant.getId(), null, defaultDeviceProfile.getId(), &quot;Raspberry Pi Demo Device&quot;, &quot;RASPBERRY_PI_DEMO_TOKEN&quot;,</b>
&nbsp;                &quot;Demo device that is used in Raspberry Pi GPIO control sample application&quot;);
&nbsp;
<b class="nc">&nbsp;        DeviceProfile thermostatDeviceProfile = new DeviceProfile();</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setTenantId(demoTenant.getId());</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setDefault(false);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setName(&quot;thermostat&quot;);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setType(DeviceProfileType.DEFAULT);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setTransportType(DeviceTransportType.DEFAULT);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setProvisionType(DeviceProfileProvisionType.DISABLED);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setDescription(&quot;Thermostat device profile&quot;);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setDefaultRuleChainId(ruleChainService.findTenantRuleChainsByType(</b>
<b class="nc">&nbsp;                demoTenant.getId(), RuleChainType.CORE, new PageLink(1, 0, &quot;Thermostat&quot;)).getData().get(0).getId());</b>
&nbsp;
<b class="nc">&nbsp;        DeviceProfileData deviceProfileData = new DeviceProfileData();</b>
<b class="nc">&nbsp;        DefaultDeviceProfileConfiguration configuration = new DefaultDeviceProfileConfiguration();</b>
<b class="nc">&nbsp;        DefaultDeviceProfileTransportConfiguration transportConfiguration = new DefaultDeviceProfileTransportConfiguration();</b>
<b class="nc">&nbsp;        DisabledDeviceProfileProvisionConfiguration provisionConfiguration = new DisabledDeviceProfileProvisionConfiguration(null);</b>
<b class="nc">&nbsp;        deviceProfileData.setConfiguration(configuration);</b>
<b class="nc">&nbsp;        deviceProfileData.setTransportConfiguration(transportConfiguration);</b>
<b class="nc">&nbsp;        deviceProfileData.setProvisionConfiguration(provisionConfiguration);</b>
<b class="nc">&nbsp;        thermostatDeviceProfile.setProfileData(deviceProfileData);</b>
&nbsp;
<b class="nc">&nbsp;        DeviceProfile savedThermostatDeviceProfile = deviceProfileService.saveDeviceProfile(thermostatDeviceProfile);</b>
<b class="nc">&nbsp;        createAlarmRules(demoTenant.getId(), savedThermostatDeviceProfile.getId());</b>
&nbsp;
<b class="nc">&nbsp;        DeviceId t1Id = createDevice(demoTenant.getId(), null, savedThermostatDeviceProfile.getId(), &quot;Thermostat T1&quot;, &quot;T1_TEST_TOKEN&quot;, &quot;Demo device for Thermostats dashboard&quot;).getId();</b>
<b class="nc">&nbsp;        DeviceId t2Id = createDevice(demoTenant.getId(), null, savedThermostatDeviceProfile.getId(), &quot;Thermostat T2&quot;, &quot;T2_TEST_TOKEN&quot;, &quot;Demo device for Thermostats dashboard&quot;).getId();</b>
&nbsp;
<b class="nc">&nbsp;        attributesService.save(demoTenant.getId(), t1Id, AttributeScope.SERVER_SCOPE,</b>
<b class="nc">&nbsp;                Arrays.asList(new BaseAttributeKvEntry(System.currentTimeMillis(), new DoubleDataEntry(&quot;latitude&quot;, 37.3948)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new DoubleDataEntry(&quot;longitude&quot;, -122.1503)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new BooleanDataEntry(&quot;temperatureAlarmFlag&quot;, true)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new BooleanDataEntry(&quot;humidityAlarmFlag&quot;, true)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new LongDataEntry(&quot;temperatureAlarmThreshold&quot;, (long) 20)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new LongDataEntry(&quot;humidityAlarmThreshold&quot;, (long) 50))));</b>
&nbsp;
<b class="nc">&nbsp;        attributesService.save(demoTenant.getId(), t2Id, AttributeScope.SERVER_SCOPE,</b>
<b class="nc">&nbsp;                Arrays.asList(new BaseAttributeKvEntry(System.currentTimeMillis(), new DoubleDataEntry(&quot;latitude&quot;, 37.493801)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new DoubleDataEntry(&quot;longitude&quot;, -121.948769)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new BooleanDataEntry(&quot;temperatureAlarmFlag&quot;, true)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new BooleanDataEntry(&quot;humidityAlarmFlag&quot;, true)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new LongDataEntry(&quot;temperatureAlarmThreshold&quot;, (long) 25)),</b>
<b class="nc">&nbsp;                        new BaseAttributeKvEntry(System.currentTimeMillis(), new LongDataEntry(&quot;humidityAlarmThreshold&quot;, (long) 30))));</b>
&nbsp;
<b class="nc">&nbsp;        installScripts.loadDashboards(demoTenant.getId(), null);</b>
<b class="nc">&nbsp;        installScripts.createDefaultTenantDashboards(demoTenant.getId(), null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void createAlarmRules(TenantId tenantId, DeviceProfileId deviceProfileId) {
<b class="nc">&nbsp;        CalculatedField highTemperature = new CalculatedField();</b>
<b class="nc">&nbsp;        highTemperature.setName(&quot;High Temperature&quot;);</b>
<b class="nc">&nbsp;        highTemperature.setType(CalculatedFieldType.ALARM);</b>
<b class="nc">&nbsp;        highTemperature.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        highTemperature.setEntityId(deviceProfileId);</b>
<b class="nc">&nbsp;        highTemperature.setDebugSettings(DebugSettings.all());</b>
<b class="nc">&nbsp;        AlarmCalculatedFieldConfiguration highTemperatureConfig = new AlarmCalculatedFieldConfiguration();</b>
<b class="nc">&nbsp;        highTemperature.setConfiguration(highTemperatureConfig);</b>
&nbsp;
<b class="nc">&nbsp;        Argument temperatureArgument = new Argument();</b>
<b class="nc">&nbsp;        temperatureArgument.setRefEntityKey(new ReferencedEntityKey(&quot;temperature&quot;, ArgumentType.TS_LATEST, null));</b>
<b class="nc">&nbsp;        Argument temperatureThresholdArgument = new Argument();</b>
<b class="nc">&nbsp;        temperatureThresholdArgument.setRefEntityKey(new ReferencedEntityKey(&quot;temperatureAlarmThreshold&quot;, ArgumentType.ATTRIBUTE, AttributeScope.SERVER_SCOPE));</b>
<b class="nc">&nbsp;        temperatureThresholdArgument.setDefaultValue(&quot;25&quot;);</b>
<b class="nc">&nbsp;        Argument temperatureAlarmFlagArgument = new Argument();</b>
<b class="nc">&nbsp;        temperatureAlarmFlagArgument.setRefEntityKey(new ReferencedEntityKey(&quot;temperatureAlarmFlag&quot;, ArgumentType.ATTRIBUTE, AttributeScope.SERVER_SCOPE));</b>
<b class="nc">&nbsp;        highTemperatureConfig.setArguments(Map.of(</b>
&nbsp;                &quot;temperature&quot;, temperatureArgument,
&nbsp;                &quot;temperatureAlarmThreshold&quot;, temperatureThresholdArgument,
&nbsp;                &quot;temperatureAlarmFlag&quot;, temperatureAlarmFlagArgument
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        AlarmRule temperatureRule = new AlarmRule();</b>
<b class="nc">&nbsp;        SimpleAlarmCondition temperatureCondition = new SimpleAlarmCondition();</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter temperatureAlarmFlagFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        temperatureAlarmFlagFilter.setArgument(&quot;temperatureAlarmFlag&quot;);</b>
<b class="nc">&nbsp;        temperatureAlarmFlagFilter.setValueType(EntityKeyValueType.BOOLEAN);</b>
<b class="nc">&nbsp;        BooleanFilterPredicate temperatureAlarmFlagAttributePredicate = new BooleanFilterPredicate();</b>
<b class="nc">&nbsp;        temperatureAlarmFlagAttributePredicate.setOperation(BooleanFilterPredicate.BooleanOperation.EQUAL);</b>
<b class="nc">&nbsp;        temperatureAlarmFlagAttributePredicate.setValue(new AlarmConditionValue&lt;&gt;(Boolean.TRUE, null));</b>
<b class="nc">&nbsp;        temperatureAlarmFlagFilter.setPredicates(List.of(temperatureAlarmFlagAttributePredicate));</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter temperatureFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        temperatureFilter.setArgument(&quot;temperature&quot;);</b>
<b class="nc">&nbsp;        temperatureFilter.setValueType(EntityKeyValueType.NUMERIC);</b>
<b class="nc">&nbsp;        NumericFilterPredicate temperatureFilterPredicate = new NumericFilterPredicate();</b>
<b class="nc">&nbsp;        temperatureFilterPredicate.setOperation(NumericFilterPredicate.NumericOperation.GREATER);</b>
<b class="nc">&nbsp;        temperatureFilterPredicate.setValue(new AlarmConditionValue&lt;&gt;(null, &quot;temperatureAlarmThreshold&quot;));</b>
<b class="nc">&nbsp;        temperatureFilter.setPredicates(List.of(temperatureFilterPredicate));</b>
<b class="nc">&nbsp;        temperatureCondition.setExpression(new SimpleAlarmConditionExpression(List.of(temperatureAlarmFlagFilter, temperatureFilter), ComplexOperation.AND));</b>
<b class="nc">&nbsp;        temperatureRule.setCondition(temperatureCondition);</b>
<b class="nc">&nbsp;        temperatureRule.setAlarmDetails(&quot;Current temperature = ${temperature}&quot;);</b>
<b class="nc">&nbsp;        highTemperatureConfig.setCreateRules(Map.of(</b>
&nbsp;                AlarmSeverity.MAJOR, temperatureRule
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        AlarmRule clearTemperatureRule = new AlarmRule();</b>
<b class="nc">&nbsp;        SimpleAlarmCondition clearTemperatureCondition = new SimpleAlarmCondition();</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter clearTemperatureFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        clearTemperatureFilter.setArgument(&quot;temperature&quot;);</b>
<b class="nc">&nbsp;        clearTemperatureFilter.setValueType(EntityKeyValueType.NUMERIC);</b>
<b class="nc">&nbsp;        NumericFilterPredicate clearTemperatureFilterPredicate = new NumericFilterPredicate();</b>
<b class="nc">&nbsp;        clearTemperatureFilterPredicate.setOperation(NumericFilterPredicate.NumericOperation.LESS_OR_EQUAL);</b>
<b class="nc">&nbsp;        clearTemperatureFilterPredicate.setValue(new AlarmConditionValue&lt;&gt;(null, &quot;temperatureAlarmThreshold&quot;));</b>
<b class="nc">&nbsp;        clearTemperatureFilter.setPredicates(List.of(clearTemperatureFilterPredicate));</b>
<b class="nc">&nbsp;        clearTemperatureCondition.setExpression(new SimpleAlarmConditionExpression(List.of(clearTemperatureFilter), ComplexOperation.AND));</b>
<b class="nc">&nbsp;        clearTemperatureRule.setCondition(clearTemperatureCondition);</b>
<b class="nc">&nbsp;        clearTemperatureRule.setAlarmDetails(&quot;Current temperature = ${temperature}&quot;);</b>
<b class="nc">&nbsp;        highTemperatureConfig.setClearRule(clearTemperatureRule);</b>
&nbsp;
<b class="nc">&nbsp;        calculatedFieldService.save(highTemperature);</b>
&nbsp;
<b class="nc">&nbsp;        CalculatedField lowHumidity = new CalculatedField();</b>
<b class="nc">&nbsp;        lowHumidity.setName(&quot;Low Humidity&quot;);</b>
<b class="nc">&nbsp;        lowHumidity.setType(CalculatedFieldType.ALARM);</b>
<b class="nc">&nbsp;        lowHumidity.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        lowHumidity.setEntityId(deviceProfileId);</b>
<b class="nc">&nbsp;        lowHumidity.setDebugSettings(DebugSettings.all());</b>
<b class="nc">&nbsp;        AlarmCalculatedFieldConfiguration lowHumidityConfig = new AlarmCalculatedFieldConfiguration();</b>
<b class="nc">&nbsp;        lowHumidity.setConfiguration(lowHumidityConfig);</b>
&nbsp;
<b class="nc">&nbsp;        Argument humidityArgument = new Argument();</b>
<b class="nc">&nbsp;        humidityArgument.setRefEntityKey(new ReferencedEntityKey(&quot;humidity&quot;, ArgumentType.TS_LATEST, null));</b>
<b class="nc">&nbsp;        Argument humidityThresholdArgument = new Argument();</b>
<b class="nc">&nbsp;        humidityThresholdArgument.setRefEntityKey(new ReferencedEntityKey(&quot;humidityAlarmThreshold&quot;, ArgumentType.ATTRIBUTE, AttributeScope.SERVER_SCOPE));</b>
<b class="nc">&nbsp;        humidityThresholdArgument.setDefaultValue(&quot;60&quot;);</b>
<b class="nc">&nbsp;        Argument humidityAlarmFlagArgument = new Argument();</b>
<b class="nc">&nbsp;        humidityAlarmFlagArgument.setRefEntityKey(new ReferencedEntityKey(&quot;humidityAlarmFlag&quot;, ArgumentType.ATTRIBUTE, AttributeScope.SERVER_SCOPE));</b>
<b class="nc">&nbsp;        lowHumidityConfig.setArguments(Map.of(</b>
&nbsp;                &quot;humidity&quot;, humidityArgument,
&nbsp;                &quot;humidityAlarmThreshold&quot;, humidityThresholdArgument,
&nbsp;                &quot;humidityAlarmFlag&quot;, humidityAlarmFlagArgument
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        AlarmRule humidityRule = new AlarmRule();</b>
<b class="nc">&nbsp;        SimpleAlarmCondition humidityCondition = new SimpleAlarmCondition();</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter humidityAlarmFlagAttributeFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        humidityAlarmFlagAttributeFilter.setArgument(&quot;humidityAlarmFlag&quot;);</b>
<b class="nc">&nbsp;        humidityAlarmFlagAttributeFilter.setValueType(EntityKeyValueType.BOOLEAN);</b>
<b class="nc">&nbsp;        BooleanFilterPredicate humidityAlarmFlagPredicate = new BooleanFilterPredicate();</b>
<b class="nc">&nbsp;        humidityAlarmFlagPredicate.setOperation(BooleanFilterPredicate.BooleanOperation.EQUAL);</b>
<b class="nc">&nbsp;        humidityAlarmFlagPredicate.setValue(new AlarmConditionValue&lt;&gt;(Boolean.TRUE, null));</b>
<b class="nc">&nbsp;        humidityAlarmFlagAttributeFilter.setPredicates(List.of(humidityAlarmFlagPredicate));</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter humidityFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        humidityFilter.setArgument(&quot;humidity&quot;);</b>
<b class="nc">&nbsp;        humidityFilter.setValueType(EntityKeyValueType.NUMERIC);</b>
<b class="nc">&nbsp;        NumericFilterPredicate humidityFilterPredicate = new NumericFilterPredicate();</b>
<b class="nc">&nbsp;        humidityFilterPredicate.setOperation(NumericFilterPredicate.NumericOperation.LESS);</b>
<b class="nc">&nbsp;        humidityFilterPredicate.setValue(new AlarmConditionValue&lt;&gt;(null, &quot;humidityAlarmThreshold&quot;));</b>
<b class="nc">&nbsp;        humidityFilter.setPredicates(List.of(humidityFilterPredicate));</b>
<b class="nc">&nbsp;        humidityCondition.setExpression(new SimpleAlarmConditionExpression(List.of(humidityAlarmFlagAttributeFilter, humidityFilter), ComplexOperation.AND));</b>
<b class="nc">&nbsp;        humidityRule.setCondition(humidityCondition);</b>
<b class="nc">&nbsp;        humidityRule.setAlarmDetails(&quot;Current humidity = ${humidity}&quot;);</b>
<b class="nc">&nbsp;        lowHumidityConfig.setCreateRules(Map.of(</b>
&nbsp;                AlarmSeverity.MINOR, humidityRule
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        AlarmRule clearHumidityRule = new AlarmRule();</b>
<b class="nc">&nbsp;        SimpleAlarmCondition clearHumidityCondition = new SimpleAlarmCondition();</b>
&nbsp;
<b class="nc">&nbsp;        AlarmConditionFilter clearHumidityFilter = new AlarmConditionFilter();</b>
<b class="nc">&nbsp;        clearHumidityFilter.setArgument(&quot;humidity&quot;);</b>
<b class="nc">&nbsp;        clearHumidityFilter.setValueType(EntityKeyValueType.NUMERIC);</b>
<b class="nc">&nbsp;        NumericFilterPredicate clearHumidityFilterPredicate = new NumericFilterPredicate();</b>
<b class="nc">&nbsp;        clearHumidityFilterPredicate.setOperation(NumericFilterPredicate.NumericOperation.GREATER_OR_EQUAL);</b>
<b class="nc">&nbsp;        clearHumidityFilterPredicate.setValue(new AlarmConditionValue&lt;&gt;(null, &quot;humidityAlarmThreshold&quot;));</b>
<b class="nc">&nbsp;        clearHumidityFilter.setPredicates(List.of(clearHumidityFilterPredicate));</b>
<b class="nc">&nbsp;        clearHumidityCondition.setExpression(new SimpleAlarmConditionExpression(List.of(clearHumidityFilter), ComplexOperation.AND));</b>
<b class="nc">&nbsp;        clearHumidityRule.setCondition(clearHumidityCondition);</b>
<b class="nc">&nbsp;        clearHumidityRule.setAlarmDetails(&quot;Current humidity = ${humidity}&quot;);</b>
<b class="nc">&nbsp;        lowHumidityConfig.setClearRule(clearHumidityRule);</b>
&nbsp;
<b class="nc">&nbsp;        calculatedFieldService.save(lowHumidity);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void loadSystemWidgets() throws Exception {
<b class="nc">&nbsp;        installScripts.loadSystemWidgets();</b>
&nbsp;    }
&nbsp;
&nbsp;    private User createUser(Authority authority,
&nbsp;                            TenantId tenantId,
&nbsp;                            CustomerId customerId,
&nbsp;                            String email,
&nbsp;                            String password) {
<b class="nc">&nbsp;        User user = new User();</b>
<b class="nc">&nbsp;        user.setAuthority(authority);</b>
<b class="nc">&nbsp;        user.setEmail(email);</b>
<b class="nc">&nbsp;        user.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        user.setCustomerId(customerId);</b>
<b class="nc">&nbsp;        user = userService.saveUser(tenantId, user);</b>
<b class="nc">&nbsp;        UserCredentials userCredentials = userService.findUserCredentialsByUserId(TenantId.SYS_TENANT_ID, user.getId());</b>
<b class="nc">&nbsp;        userCredentials.setPassword(passwordEncoder.encode(password));</b>
<b class="nc">&nbsp;        userCredentials.setEnabled(true);</b>
<b class="nc">&nbsp;        userCredentials.setActivateToken(null);</b>
<b class="nc">&nbsp;        userService.saveUserCredentials(TenantId.SYS_TENANT_ID, userCredentials);</b>
<b class="nc">&nbsp;        return user;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Device createDevice(TenantId tenantId,
&nbsp;                                CustomerId customerId,
&nbsp;                                DeviceProfileId deviceProfileId,
&nbsp;                                String name,
&nbsp;                                String accessToken,
&nbsp;                                String description) {
<b class="nc">&nbsp;        Device device = new Device();</b>
<b class="nc">&nbsp;        device.setTenantId(tenantId);</b>
<b class="nc">&nbsp;        device.setCustomerId(customerId);</b>
<b class="nc">&nbsp;        device.setDeviceProfileId(deviceProfileId);</b>
<b class="nc">&nbsp;        device.setName(name);</b>
<b class="nc">&nbsp;        if (description != null) {</b>
<b class="nc">&nbsp;            ObjectNode additionalInfo = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;            additionalInfo.put(&quot;description&quot;, description);</b>
<b class="nc">&nbsp;            device.setAdditionalInfo(additionalInfo);</b>
&nbsp;        }
<b class="nc">&nbsp;        device = deviceService.saveDevice(device);</b>
<b class="nc">&nbsp;        save(device.getId(), ACTIVITY_STATE, false);</b>
<b class="nc">&nbsp;        DeviceCredentials deviceCredentials = deviceCredentialsService.findDeviceCredentialsByDeviceId(TenantId.SYS_TENANT_ID, device.getId());</b>
<b class="nc">&nbsp;        deviceCredentials.setCredentialsId(accessToken);</b>
<b class="nc">&nbsp;        deviceCredentialsService.updateDeviceCredentials(TenantId.SYS_TENANT_ID, deviceCredentials);</b>
<b class="nc">&nbsp;        return device;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void save(DeviceId deviceId, String key, boolean value) {
<b class="nc">&nbsp;        if (persistActivityToTelemetry) {</b>
<b class="nc">&nbsp;            ListenableFuture&lt;TimeseriesSaveResult&gt; saveFuture = tsService.save(</b>
&nbsp;                    TenantId.SYS_TENANT_ID,
&nbsp;                    deviceId,
<b class="nc">&nbsp;                    Collections.singletonList(new BasicTsKvEntry(System.currentTimeMillis(), new BooleanDataEntry(key, value))), 0L);</b>
<b class="nc">&nbsp;            addTsCallback(saveFuture, new TelemetrySaveCallback&lt;&gt;(deviceId, key, value));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ListenableFuture&lt;AttributesSaveResult&gt; saveFuture = attributesService.save(</b>
<b class="nc">&nbsp;                    TenantId.SYS_TENANT_ID, deviceId, AttributeScope.SERVER_SCOPE, new BaseAttributeKvEntry(new BooleanDataEntry(key, value), System.currentTimeMillis())</b>
&nbsp;            );
<b class="nc">&nbsp;            addTsCallback(saveFuture, new TelemetrySaveCallback&lt;&gt;(deviceId, key, value));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static class TelemetrySaveCallback&lt;T&gt; implements FutureCallback&lt;T&gt; {
&nbsp;        private final DeviceId deviceId;
&nbsp;        private final String key;
&nbsp;        private final Object value;
&nbsp;
<b class="nc">&nbsp;        TelemetrySaveCallback(DeviceId deviceId, String key, Object value) {</b>
<b class="nc">&nbsp;            this.deviceId = deviceId;</b>
<b class="nc">&nbsp;            this.key = key;</b>
<b class="nc">&nbsp;            this.value = value;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void onSuccess(@Nullable T result) {
<b class="nc">&nbsp;            log.trace(&quot;[{}] Successfully updated attribute [{}] with value [{}]&quot;, deviceId, key, value);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void onFailure(Throwable t) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to update attribute [{}] with value [{}]&quot;, deviceId, key, value, t);</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private &lt;S&gt; void addTsCallback(ListenableFuture&lt;S&gt; saveFuture, final FutureCallback&lt;S&gt; callback) {
<b class="nc">&nbsp;        Futures.addCallback(saveFuture, new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(@Nullable S result) {
<b class="nc">&nbsp;                callback.onSuccess(result);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                callback.onFailure(t);</b>
&nbsp;            }
&nbsp;        }, tsCallBackExecutor);
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void createQueues() {
<b class="nc">&nbsp;        Queue mainQueue = queueService.findQueueByTenantIdAndName(TenantId.SYS_TENANT_ID, DataConstants.MAIN_QUEUE_NAME);</b>
<b class="nc">&nbsp;        if (mainQueue == null) {</b>
<b class="nc">&nbsp;            mainQueue = new Queue();</b>
<b class="nc">&nbsp;            mainQueue.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;            mainQueue.setName(DataConstants.MAIN_QUEUE_NAME);</b>
<b class="nc">&nbsp;            mainQueue.setTopic(DataConstants.MAIN_QUEUE_TOPIC);</b>
<b class="nc">&nbsp;            mainQueue.setPollInterval(25);</b>
<b class="nc">&nbsp;            mainQueue.setPartitions(10);</b>
<b class="nc">&nbsp;            mainQueue.setConsumerPerPartition(true);</b>
<b class="nc">&nbsp;            mainQueue.setPackProcessingTimeout(2000);</b>
<b class="nc">&nbsp;            SubmitStrategy mainQueueSubmitStrategy = new SubmitStrategy();</b>
<b class="nc">&nbsp;            mainQueueSubmitStrategy.setType(SubmitStrategyType.BURST);</b>
<b class="nc">&nbsp;            mainQueueSubmitStrategy.setBatchSize(1000);</b>
<b class="nc">&nbsp;            mainQueue.setSubmitStrategy(mainQueueSubmitStrategy);</b>
<b class="nc">&nbsp;            ProcessingStrategy mainQueueProcessingStrategy = new ProcessingStrategy();</b>
<b class="nc">&nbsp;            mainQueueProcessingStrategy.setType(ProcessingStrategyType.SKIP_ALL_FAILURES);</b>
<b class="nc">&nbsp;            mainQueueProcessingStrategy.setRetries(3);</b>
<b class="nc">&nbsp;            mainQueueProcessingStrategy.setFailurePercentage(0);</b>
<b class="nc">&nbsp;            mainQueueProcessingStrategy.setPauseBetweenRetries(3);</b>
<b class="nc">&nbsp;            mainQueueProcessingStrategy.setMaxPauseBetweenRetries(3);</b>
<b class="nc">&nbsp;            mainQueue.setProcessingStrategy(mainQueueProcessingStrategy);</b>
<b class="nc">&nbsp;            queueService.saveQueue(mainQueue);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Queue highPriorityQueue = queueService.findQueueByTenantIdAndName(TenantId.SYS_TENANT_ID, DataConstants.HP_QUEUE_NAME);</b>
<b class="nc">&nbsp;        if (highPriorityQueue == null) {</b>
<b class="nc">&nbsp;            highPriorityQueue = new Queue();</b>
<b class="nc">&nbsp;            highPriorityQueue.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;            highPriorityQueue.setName(DataConstants.HP_QUEUE_NAME);</b>
<b class="nc">&nbsp;            highPriorityQueue.setTopic(DataConstants.HP_QUEUE_TOPIC);</b>
<b class="nc">&nbsp;            highPriorityQueue.setPollInterval(25);</b>
<b class="nc">&nbsp;            highPriorityQueue.setPartitions(10);</b>
<b class="nc">&nbsp;            highPriorityQueue.setConsumerPerPartition(true);</b>
<b class="nc">&nbsp;            highPriorityQueue.setPackProcessingTimeout(2000);</b>
<b class="nc">&nbsp;            SubmitStrategy highPriorityQueueSubmitStrategy = new SubmitStrategy();</b>
<b class="nc">&nbsp;            highPriorityQueueSubmitStrategy.setType(SubmitStrategyType.BURST);</b>
<b class="nc">&nbsp;            highPriorityQueueSubmitStrategy.setBatchSize(100);</b>
<b class="nc">&nbsp;            highPriorityQueue.setSubmitStrategy(highPriorityQueueSubmitStrategy);</b>
<b class="nc">&nbsp;            ProcessingStrategy highPriorityQueueProcessingStrategy = new ProcessingStrategy();</b>
<b class="nc">&nbsp;            highPriorityQueueProcessingStrategy.setType(ProcessingStrategyType.RETRY_FAILED_AND_TIMED_OUT);</b>
<b class="nc">&nbsp;            highPriorityQueueProcessingStrategy.setRetries(0);</b>
<b class="nc">&nbsp;            highPriorityQueueProcessingStrategy.setFailurePercentage(0);</b>
<b class="nc">&nbsp;            highPriorityQueueProcessingStrategy.setPauseBetweenRetries(5);</b>
<b class="nc">&nbsp;            highPriorityQueueProcessingStrategy.setMaxPauseBetweenRetries(5);</b>
<b class="nc">&nbsp;            highPriorityQueue.setProcessingStrategy(highPriorityQueueProcessingStrategy);</b>
<b class="nc">&nbsp;            queueService.saveQueue(highPriorityQueue);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Queue sequentialByOriginatorQueue = queueService.findQueueByTenantIdAndName(TenantId.SYS_TENANT_ID, DataConstants.SQ_QUEUE_NAME);</b>
<b class="nc">&nbsp;        if (sequentialByOriginatorQueue == null) {</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue = new Queue();</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setTenantId(TenantId.SYS_TENANT_ID);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setName(DataConstants.SQ_QUEUE_NAME);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setTopic(DataConstants.SQ_QUEUE_TOPIC);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setPollInterval(25);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setPartitions(10);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setPackProcessingTimeout(2000);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setConsumerPerPartition(true);</b>
<b class="nc">&nbsp;            SubmitStrategy sequentialByOriginatorQueueSubmitStrategy = new SubmitStrategy();</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueSubmitStrategy.setType(SubmitStrategyType.SEQUENTIAL_BY_ORIGINATOR);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueSubmitStrategy.setBatchSize(100);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setSubmitStrategy(sequentialByOriginatorQueueSubmitStrategy);</b>
<b class="nc">&nbsp;            ProcessingStrategy sequentialByOriginatorQueueProcessingStrategy = new ProcessingStrategy();</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueProcessingStrategy.setType(ProcessingStrategyType.RETRY_FAILED_AND_TIMED_OUT);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueProcessingStrategy.setRetries(3);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueProcessingStrategy.setFailurePercentage(0);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueProcessingStrategy.setPauseBetweenRetries(5);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueueProcessingStrategy.setMaxPauseBetweenRetries(5);</b>
<b class="nc">&nbsp;            sequentialByOriginatorQueue.setProcessingStrategy(sequentialByOriginatorQueueProcessingStrategy);</b>
<b class="nc">&nbsp;            queueService.saveQueue(sequentialByOriginatorQueue);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public void createDefaultNotificationConfigs() {
<b class="nc">&nbsp;        log.info(&quot;Creating default notification configs for system admin&quot;);</b>
<b class="nc">&nbsp;        if (notificationTargetService.countNotificationTargetsByTenantId(TenantId.SYS_TENANT_ID) == 0) {</b>
<b class="nc">&nbsp;            notificationSettingsService.createDefaultNotificationConfigs(TenantId.SYS_TENANT_ID);</b>
&nbsp;        }
<b class="nc">&nbsp;        PageDataIterable&lt;TenantId&gt; tenants = new PageDataIterable&lt;&gt;(tenantService::findTenantsIds, 500);</b>
<b class="nc">&nbsp;        ExecutorService executor = Executors.newFixedThreadPool(Math.max(Runtime.getRuntime().availableProcessors(), 4));</b>
<b class="nc">&nbsp;        log.info(&quot;Creating default notification configs for all tenants&quot;);</b>
<b class="nc">&nbsp;        AtomicInteger count = new AtomicInteger();</b>
<b class="nc">&nbsp;        for (TenantId tenantId : tenants) {</b>
<b class="nc">&nbsp;            executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;                if (notificationTargetService.countNotificationTargetsByTenantId(tenantId) == 0) {</b>
<b class="nc">&nbsp;                    notificationSettingsService.createDefaultNotificationConfigs(tenantId);</b>
<b class="nc">&nbsp;                    int n = count.incrementAndGet();</b>
<b class="nc">&nbsp;                    if (n % 500 == 0) {</b>
<b class="nc">&nbsp;                        log.info(&quot;{} tenants processed&quot;, n);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            });
&nbsp;        }
<b class="nc">&nbsp;        executor.shutdown();</b>
<b class="nc">&nbsp;        executor.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    public void updateDefaultNotificationConfigs(boolean updateTenants) {
<b class="nc">&nbsp;        log.info(&quot;Updating notification configs...&quot;);</b>
<b class="nc">&nbsp;        notificationSettingsService.updateDefaultNotificationConfigs(TenantId.SYS_TENANT_ID);</b>
&nbsp;
<b class="nc">&nbsp;        if (updateTenants) {</b>
<b class="nc">&nbsp;            PageDataIterable&lt;TenantId&gt; tenants = new PageDataIterable&lt;&gt;(tenantService::findTenantsIds, 500);</b>
<b class="nc">&nbsp;            ExecutorService executor = Executors.newFixedThreadPool(Math.max(Runtime.getRuntime().availableProcessors(), 4));</b>
<b class="nc">&nbsp;            AtomicInteger count = new AtomicInteger();</b>
<b class="nc">&nbsp;            for (TenantId tenantId : tenants) {</b>
<b class="nc">&nbsp;                executor.submit(() -&gt; {</b>
<b class="nc">&nbsp;                    notificationSettingsService.updateDefaultNotificationConfigs(tenantId);</b>
<b class="nc">&nbsp;                    int n = count.incrementAndGet();</b>
<b class="nc">&nbsp;                    if (n % 500 == 0) {</b>
<b class="nc">&nbsp;                        log.info(&quot;{} tenants processed&quot;, n);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;            }
<b class="nc">&nbsp;            executor.shutdown();</b>
<b class="nc">&nbsp;            executor.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

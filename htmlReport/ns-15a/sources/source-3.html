<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > BaseCalculatedFieldState</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.cf.ctx.state</a>
</div>

<h1>Coverage Summary for Class: BaseCalculatedFieldState (org.thingsboard.server.service.cf.ctx.state)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BaseCalculatedFieldState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/75)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.cf.ctx.state;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.actors.TbActorRef;
&nbsp;import org.thingsboard.server.common.data.cf.configuration.OutputType;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.msg.queue.TopicPartitionInfo;
&nbsp;import org.thingsboard.server.service.cf.ctx.CalculatedFieldEntityCtxId;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.RelatedEntitiesArgumentEntry;
&nbsp;import org.thingsboard.server.service.cf.ctx.state.aggregation.single.EntityAggregationArgumentEntry;
&nbsp;import org.thingsboard.server.utils.CalculatedFieldUtils;
&nbsp;
&nbsp;import java.io.Closeable;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Getter
&nbsp;public abstract class BaseCalculatedFieldState implements CalculatedFieldState, Closeable {
&nbsp;
&nbsp;    public static final long DEFAULT_LAST_UPDATE_TS = -1L;
&nbsp;
&nbsp;    protected final EntityId entityId;
&nbsp;    protected CalculatedFieldCtx ctx;
&nbsp;    protected TbActorRef actorCtx;
&nbsp;    protected List&lt;String&gt; requiredArguments;
&nbsp;
<b class="nc">&nbsp;    protected Map&lt;String, ArgumentEntry&gt; arguments = new HashMap&lt;&gt;();</b>
&nbsp;    protected boolean sizeExceedsLimit;
&nbsp;    protected ReadinessStatus readinessStatus;
&nbsp;
&nbsp;    @Setter
&nbsp;    private TopicPartitionInfo partition;
&nbsp;
<b class="nc">&nbsp;    public BaseCalculatedFieldState(EntityId entityId) {</b>
<b class="nc">&nbsp;        this.entityId = entityId;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void setCtx(CalculatedFieldCtx ctx, TbActorRef actorCtx) {
<b class="nc">&nbsp;        this.ctx = ctx;</b>
<b class="nc">&nbsp;        this.actorCtx = actorCtx;</b>
<b class="nc">&nbsp;        this.requiredArguments = ctx.getArgNames();</b>
<b class="nc">&nbsp;        this.readinessStatus = checkReadiness();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void init(boolean restored) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;String, ArgumentEntry&gt; update(Map&lt;String, ArgumentEntry&gt; argumentValues, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        Map&lt;String, ArgumentEntry&gt; updatedArguments = null;</b>
&nbsp;
<b class="nc">&nbsp;        for (Map.Entry&lt;String, ArgumentEntry&gt; entry : argumentValues.entrySet()) {</b>
<b class="nc">&nbsp;            String key = entry.getKey();</b>
<b class="nc">&nbsp;            ArgumentEntry newEntry = entry.getValue();</b>
&nbsp;
<b class="nc">&nbsp;            checkArgumentSize(key, newEntry, ctx);</b>
&nbsp;
<b class="nc">&nbsp;            ArgumentEntry existingEntry = arguments.get(key);</b>
&nbsp;            boolean entryUpdated;
&nbsp;
<b class="nc">&nbsp;            if (existingEntry == null || newEntry.isForceResetPrevious()) {</b>
<b class="nc">&nbsp;                validateNewEntry(key, newEntry);</b>
<b class="nc">&nbsp;                if (existingEntry instanceof RelatedEntitiesArgumentEntry ||</b>
&nbsp;                    existingEntry instanceof EntityAggregationArgumentEntry) {
<b class="nc">&nbsp;                    updateEntry(existingEntry, newEntry, ctx);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    arguments.put(key, newEntry);</b>
&nbsp;                }
<b class="nc">&nbsp;                entryUpdated = true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entryUpdated = updateEntry(existingEntry, newEntry, ctx);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (entryUpdated) {</b>
<b class="nc">&nbsp;                if (updatedArguments == null) {</b>
<b class="nc">&nbsp;                    updatedArguments = new HashMap&lt;&gt;(argumentValues.size());</b>
&nbsp;                }
<b class="nc">&nbsp;                updatedArguments.put(key, newEntry);</b>
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (updatedArguments == null) {</b>
<b class="nc">&nbsp;            return Collections.emptyMap();</b>
&nbsp;        }
<b class="nc">&nbsp;        readinessStatus = checkReadiness();</b>
<b class="nc">&nbsp;        return updatedArguments;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected boolean updateEntry(ArgumentEntry existingEntry, ArgumentEntry newEntry, CalculatedFieldCtx ctx) {
<b class="nc">&nbsp;        return existingEntry.updateEntry(newEntry, ctx);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void reset() { // must reset everything dependent on arguments
<b class="nc">&nbsp;        requiredArguments = null;</b>
<b class="nc">&nbsp;        arguments.clear();</b>
<b class="nc">&nbsp;        sizeExceedsLimit = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isReady() {
<b class="nc">&nbsp;        return readinessStatus.ready();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void checkStateSize(CalculatedFieldEntityCtxId ctxId, long maxStateSize) {
<b class="nc">&nbsp;        if (!sizeExceedsLimit &amp;&amp; maxStateSize &gt; 0 &amp;&amp; CalculatedFieldUtils.toProto(ctxId, this).getSerializedSize() &gt; maxStateSize) {</b>
<b class="nc">&nbsp;            arguments.clear();</b>
<b class="nc">&nbsp;            sizeExceedsLimit = true;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void close() {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    protected void validateNewEntry(String key, ArgumentEntry newEntry) {
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    protected ObjectNode toResultNode(ObjectNode valuesNode) {
<b class="nc">&nbsp;        if (ctx.getOutput().getType() == OutputType.ATTRIBUTES || !ctx.isUseLatestTs()) {</b>
<b class="nc">&nbsp;            return valuesNode;</b>
&nbsp;        }
<b class="nc">&nbsp;        long latestTs = getLatestTimestamp();</b>
<b class="nc">&nbsp;        if (latestTs == DEFAULT_LAST_UPDATE_TS) {</b>
<b class="nc">&nbsp;            return valuesNode;</b>
&nbsp;        }
<b class="nc">&nbsp;        ObjectNode resultNode = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;        resultNode.put(&quot;ts&quot;, latestTs);</b>
<b class="nc">&nbsp;        resultNode.set(&quot;values&quot;, valuesNode);</b>
<b class="nc">&nbsp;        return resultNode;</b>
&nbsp;    }
&nbsp;
&nbsp;    public long getLatestTimestamp() {
<b class="nc">&nbsp;        long latestTs = DEFAULT_LAST_UPDATE_TS;</b>
&nbsp;
<b class="nc">&nbsp;        boolean allDefault = arguments.values().stream().allMatch(entry -&gt; {</b>
<b class="nc">&nbsp;            if (entry instanceof SingleValueArgumentEntry single) {</b>
<b class="nc">&nbsp;                return single.isDefaultValue();</b>
&nbsp;            }
<b class="nc">&nbsp;            return false;</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        for (ArgumentEntry entry : arguments.values()) {</b>
<b class="nc">&nbsp;            if (entry instanceof SingleValueArgumentEntry single) {</b>
<b class="nc">&nbsp;                if (allDefault) {</b>
<b class="nc">&nbsp;                    latestTs = Math.max(latestTs, single.getTs());</b>
<b class="nc">&nbsp;                } else if (!single.isDefaultValue()) {</b>
<b class="nc">&nbsp;                    latestTs = Math.max(latestTs, single.getTs());</b>
&nbsp;                }
<b class="nc">&nbsp;            } else if (entry instanceof HasLatestTs hasLatestTsEntry) {</b>
<b class="nc">&nbsp;                latestTs = Math.max(latestTs, hasLatestTsEntry.getLatestTs());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return latestTs;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected ReadinessStatus checkReadiness() {
<b class="nc">&nbsp;        if (arguments == null) {</b>
<b class="nc">&nbsp;            return ReadinessStatus.from(requiredArguments);</b>
&nbsp;        }
<b class="nc">&nbsp;        List&lt;String&gt; emptyArguments = null;</b>
<b class="nc">&nbsp;        for (String requiredArgumentKey : requiredArguments) {</b>
<b class="nc">&nbsp;            ArgumentEntry argumentEntry = arguments.get(requiredArgumentKey);</b>
<b class="nc">&nbsp;            if (argumentEntry == null || argumentEntry.isEmpty()) {</b>
<b class="nc">&nbsp;                if (emptyArguments == null) {</b>
<b class="nc">&nbsp;                    emptyArguments = new ArrayList&lt;&gt;();</b>
&nbsp;                }
<b class="nc">&nbsp;                emptyArguments.add(requiredArgumentKey);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return ReadinessStatus.from(emptyArguments);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public JsonNode getArgumentsJson() {
<b class="nc">&nbsp;        return JacksonUtil.valueToTree(arguments.entrySet().stream()</b>
<b class="nc">&nbsp;                .filter(entry -&gt; !entry.getValue().isEmpty())</b>
<b class="nc">&nbsp;                .collect(Collectors.toMap(Map.Entry::getKey, e -&gt; e.getValue().jsonValue()))</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

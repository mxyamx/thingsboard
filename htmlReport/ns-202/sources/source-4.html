<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LwM2mClient</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.transport.lwm2m.server.client</a>
</div>

<h1>Coverage Summary for Class: LwM2mClient (org.thingsboard.server.transport.lwm2m.server.client)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LwM2mClient</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/84)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/190)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.transport.lwm2m.server.client;
&nbsp;
&nbsp;import lombok.EqualsAndHashCode;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import lombok.ToString;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.eclipse.leshan.core.LwM2m;
&nbsp;import org.eclipse.leshan.core.LwM2m.Version;
&nbsp;import org.eclipse.leshan.core.link.Link;
&nbsp;import org.eclipse.leshan.core.link.attributes.Attribute;
&nbsp;import org.eclipse.leshan.core.link.lwm2m.MixedLwM2mLink;
&nbsp;import org.eclipse.leshan.core.link.lwm2m.attributes.LwM2mAttribute;
&nbsp;import org.eclipse.leshan.core.link.lwm2m.attributes.LwM2mAttributes;
&nbsp;import org.eclipse.leshan.core.model.ObjectModel;
&nbsp;import org.eclipse.leshan.core.model.ResourceModel;
&nbsp;import org.eclipse.leshan.core.node.LwM2mMultipleResource;
&nbsp;import org.eclipse.leshan.core.node.LwM2mPath;
&nbsp;import org.eclipse.leshan.core.node.LwM2mResource;
&nbsp;import org.eclipse.leshan.core.node.LwM2mSingleResource;
&nbsp;import org.eclipse.leshan.core.node.codec.LwM2mValueConverter;
&nbsp;import org.eclipse.leshan.core.request.ContentFormat;
&nbsp;import org.eclipse.leshan.core.request.WriteRequest.Mode;
&nbsp;import org.eclipse.leshan.server.model.LwM2mModelProvider;
&nbsp;import org.eclipse.leshan.server.registration.Registration;
&nbsp;import org.thingsboard.server.common.data.Device;
&nbsp;import org.thingsboard.server.common.data.DeviceProfile;
&nbsp;import org.thingsboard.server.common.data.device.data.Lwm2mDeviceTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.device.data.PowerMode;
&nbsp;import org.thingsboard.server.common.data.device.profile.Lwm2mDeviceProfileTransportConfiguration;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.transport.auth.ValidateDeviceCredentialsResponse;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.SessionInfoProto;
&nbsp;import org.thingsboard.server.gen.transport.TransportProtos.TsKvProto;
&nbsp;import org.thingsboard.server.transport.lwm2m.config.TbLwM2mVersion;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collection;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;import java.util.UUID;
&nbsp;import java.util.concurrent.ConcurrentHashMap;
&nbsp;import java.util.concurrent.ConcurrentMap;
&nbsp;import java.util.concurrent.Future;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;import java.util.concurrent.atomic.AtomicLong;
&nbsp;import java.util.concurrent.locks.Lock;
&nbsp;import java.util.concurrent.locks.ReentrantLock;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static org.thingsboard.server.common.data.lwm2m.LwM2mConstants.LWM2M_SEPARATOR_PATH;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.BOOTSTRAP_TRIGGER_PARAMS_ID;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.LWM2M_OBJECT_VERSION_DEFAULT;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.REGISTRATION_TRIGGER_PARAMS_ID;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.convertMultiResourceValuesFromRpcBody;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.equalsResourceTypeGetSimpleName;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.fromVersionedIdToObjectId;
&nbsp;import static org.thingsboard.server.transport.lwm2m.utils.LwM2MTransportUtil.getVerFromPathIdVerOrId;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@EqualsAndHashCode(of = {&quot;endpoint&quot;})
&nbsp;@ToString(of = &quot;endpoint&quot;)
&nbsp;public class LwM2mClient {
&nbsp;
&nbsp;    @Getter
&nbsp;    private final String nodeId;
&nbsp;    @Getter
&nbsp;    private final String endpoint;
&nbsp;
&nbsp;    private final Lock lock;
&nbsp;
&nbsp;    @Getter
&nbsp;    private final Map&lt;String, ResourceValue&gt; resources;
&nbsp;    @Getter
&nbsp;    private final Map&lt;String, TsKvProto&gt; sharedAttributes;
&nbsp;    @Getter
&nbsp;    private final ConcurrentMap&lt;String, AtomicLong&gt; keyTsLatestMap;
&nbsp;
&nbsp;    @Getter
&nbsp;    private TenantId tenantId;
&nbsp;    @Getter
&nbsp;    private UUID profileId;
&nbsp;    @Getter
&nbsp;    private UUID deviceId;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private LwM2MClientState state;
&nbsp;    @Getter
&nbsp;    private SessionInfoProto session;
&nbsp;    @Getter
&nbsp;    private PowerMode powerMode;
&nbsp;    @Getter
&nbsp;    private Long psmActivityTimer;
&nbsp;    @Getter
&nbsp;    private Long pagingTransmissionWindow;
&nbsp;    @Getter
&nbsp;    private Long edrxCycle;
&nbsp;    @Getter
&nbsp;    private Registration registration;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private boolean asleep;
&nbsp;    @Getter
&nbsp;    private long lastUplinkTime;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private Future&lt;Void&gt; sleepTask;
&nbsp;
<b class="nc">&nbsp;    private boolean firstEdrxDownlink = true;</b>
&nbsp;
&nbsp;    @Getter
&nbsp;    private Set&lt;ContentFormat&gt; clientSupportContentFormats;
&nbsp;    @Getter
&nbsp;    private ContentFormat defaultContentFormat;
&nbsp;    @Getter
&nbsp;    private final AtomicInteger retryAttempts;
&nbsp;
&nbsp;    @Getter
&nbsp;    @Setter
&nbsp;    private UUID lastSentRpcId;
&nbsp;
&nbsp;    @Setter
&nbsp;    private LwM2m.Version defaultObjectIDVer;
&nbsp;
&nbsp;    @Getter
&nbsp;    private Map&lt;Integer, Version&gt; supportedClientObjects;
&nbsp;
&nbsp;    public Object clone() throws CloneNotSupportedException {
<b class="nc">&nbsp;        return super.clone();</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public LwM2mClient(String nodeId, String endpoint) {</b>
<b class="nc">&nbsp;        this.nodeId = nodeId;</b>
<b class="nc">&nbsp;        this.endpoint = endpoint;</b>
<b class="nc">&nbsp;        this.sharedAttributes = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        this.resources = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        this.keyTsLatestMap = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        this.state = LwM2MClientState.CREATED;</b>
<b class="nc">&nbsp;        this.lock = new ReentrantLock();</b>
<b class="nc">&nbsp;        this.retryAttempts = new AtomicInteger(0);</b>
<b class="nc">&nbsp;        this.supportedClientObjects = null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void init(ValidateDeviceCredentialsResponse credentials, UUID sessionId) {
<b class="nc">&nbsp;        this.session = createSession(nodeId, sessionId, credentials);</b>
<b class="nc">&nbsp;        this.tenantId = TenantId.fromUUID(new UUID(session.getTenantIdMSB(), session.getTenantIdLSB()));</b>
<b class="nc">&nbsp;        this.deviceId = new UUID(session.getDeviceIdMSB(), session.getDeviceIdLSB());</b>
<b class="nc">&nbsp;        this.profileId = new UUID(session.getDeviceProfileIdMSB(), session.getDeviceProfileIdLSB());</b>
<b class="nc">&nbsp;        this.powerMode = credentials.getDeviceInfo().getPowerMode();</b>
<b class="nc">&nbsp;        this.edrxCycle = credentials.getDeviceInfo().getEdrxCycle();</b>
<b class="nc">&nbsp;        this.psmActivityTimer = credentials.getDeviceInfo().getPsmActivityTimer();</b>
<b class="nc">&nbsp;        this.pagingTransmissionWindow = credentials.getDeviceInfo().getPagingTransmissionWindow();</b>
<b class="nc">&nbsp;        this.defaultObjectIDVer = getObjectIDVerFromDeviceProfile(credentials.getDeviceProfile());</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setRegistration(Registration registration) {
<b class="nc">&nbsp;        this.registration = registration;</b>
<b class="nc">&nbsp;        this.clientSupportContentFormats = clientSupportContentFormat(registration);</b>
<b class="nc">&nbsp;        this.defaultContentFormat = calculateDefaultContentFormat(registration);</b>
<b class="nc">&nbsp;        this.setSupportedClientObjects();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void lock() {
<b class="nc">&nbsp;        lock.lock();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void unlock() {
<b class="nc">&nbsp;        lock.unlock();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void onDeviceUpdate(Device device, Optional&lt;DeviceProfile&gt; deviceProfileOpt) {
<b class="nc">&nbsp;        SessionInfoProto.Builder builder = SessionInfoProto.newBuilder().mergeFrom(session);</b>
<b class="nc">&nbsp;        this.deviceId = device.getUuidId();</b>
<b class="nc">&nbsp;        builder.setDeviceIdMSB(deviceId.getMostSignificantBits());</b>
<b class="nc">&nbsp;        builder.setDeviceIdLSB(deviceId.getLeastSignificantBits());</b>
<b class="nc">&nbsp;        builder.setDeviceName(device.getName());</b>
<b class="nc">&nbsp;        deviceProfileOpt.ifPresent(deviceProfile -&gt; updateSession(deviceProfile, builder));</b>
<b class="nc">&nbsp;        this.session = builder.build();</b>
<b class="nc">&nbsp;        Lwm2mDeviceTransportConfiguration transportConfiguration = (Lwm2mDeviceTransportConfiguration) device.getDeviceData().getTransportConfiguration();</b>
<b class="nc">&nbsp;        this.powerMode = transportConfiguration.getPowerMode();</b>
<b class="nc">&nbsp;        this.edrxCycle = transportConfiguration.getEdrxCycle();</b>
<b class="nc">&nbsp;        this.psmActivityTimer = transportConfiguration.getPsmActivityTimer();</b>
<b class="nc">&nbsp;        this.pagingTransmissionWindow = transportConfiguration.getPagingTransmissionWindow();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void onDeviceProfileUpdate(DeviceProfile deviceProfile) {
<b class="nc">&nbsp;        SessionInfoProto.Builder builder = SessionInfoProto.newBuilder().mergeFrom(session);</b>
<b class="nc">&nbsp;        updateSession(deviceProfile, builder);</b>
<b class="nc">&nbsp;        this.session = builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void updateSession(DeviceProfile deviceProfile, SessionInfoProto.Builder builder) {
<b class="nc">&nbsp;        this.profileId = deviceProfile.getUuidId();</b>
<b class="nc">&nbsp;        builder.setDeviceProfileIdMSB(profileId.getMostSignificantBits());</b>
<b class="nc">&nbsp;        builder.setDeviceProfileIdLSB(profileId.getLeastSignificantBits());</b>
<b class="nc">&nbsp;        builder.setDeviceType(deviceProfile.getName());</b>
&nbsp;    }
&nbsp;
&nbsp;    private LwM2m.Version getObjectIDVerFromDeviceProfile(DeviceProfile deviceProfile) {
<b class="nc">&nbsp;        String defaultObjectIdVer = null;</b>
<b class="nc">&nbsp;        if (deviceProfile != null) {</b>
<b class="nc">&nbsp;            defaultObjectIdVer = ((Lwm2mDeviceProfileTransportConfiguration) deviceProfile</b>
<b class="nc">&nbsp;                    .getProfileData()</b>
<b class="nc">&nbsp;                    .getTransportConfiguration())</b>
<b class="nc">&nbsp;                    .getClientLwM2mSettings()</b>
<b class="nc">&nbsp;                    .getDefaultObjectIDVer();</b>
&nbsp;        }
<b class="nc">&nbsp;        return new Version(defaultObjectIdVer == null ? LWM2M_OBJECT_VERSION_DEFAULT : defaultObjectIdVer);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void refreshSessionId(String nodeId) {
<b class="nc">&nbsp;        UUID newId = UUID.randomUUID();</b>
<b class="nc">&nbsp;        SessionInfoProto.Builder builder = SessionInfoProto.newBuilder().mergeFrom(session);</b>
<b class="nc">&nbsp;        builder.setNodeId(nodeId);</b>
<b class="nc">&nbsp;        builder.setSessionIdMSB(newId.getMostSignificantBits());</b>
<b class="nc">&nbsp;        builder.setSessionIdLSB(newId.getLeastSignificantBits());</b>
<b class="nc">&nbsp;        this.session = builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private SessionInfoProto createSession(String nodeId, UUID sessionId, ValidateDeviceCredentialsResponse msg) {
<b class="nc">&nbsp;        return SessionInfoProto.newBuilder()</b>
<b class="nc">&nbsp;                .setNodeId(nodeId)</b>
<b class="nc">&nbsp;                .setSessionIdMSB(sessionId.getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setSessionIdLSB(sessionId.getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceIdMSB(msg.getDeviceInfo().getDeviceId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceIdLSB(msg.getDeviceInfo().getDeviceId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdMSB(msg.getDeviceInfo().getTenantId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setTenantIdLSB(msg.getDeviceInfo().getTenantId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setCustomerIdMSB(msg.getDeviceInfo().getCustomerId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setCustomerIdLSB(msg.getDeviceInfo().getCustomerId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceName(msg.getDeviceInfo().getDeviceName())</b>
<b class="nc">&nbsp;                .setDeviceType(msg.getDeviceInfo().getDeviceType())</b>
<b class="nc">&nbsp;                .setDeviceProfileIdMSB(msg.getDeviceInfo().getDeviceProfileId().getId().getMostSignificantBits())</b>
<b class="nc">&nbsp;                .setDeviceProfileIdLSB(msg.getDeviceInfo().getDeviceProfileId().getId().getLeastSignificantBits())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean saveResourceValue(String pathRezIdVer, LwM2mResource resource, LwM2mModelProvider modelProvider, Mode mode) {
<b class="nc">&nbsp;        if (this.resources.get(pathRezIdVer) != null &amp;&amp; this.resources.get(pathRezIdVer).getResourceModel() != null) {</b>
<b class="nc">&nbsp;            this.resources.get(pathRezIdVer).updateLwM2mResource(resource, mode);</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            LwM2mPath pathIds = getLwM2mPathFromString(pathRezIdVer);</b>
<b class="nc">&nbsp;            ResourceModel resourceModel = modelProvider.getObjectModel(registration).getResourceModel(pathIds.getObjectId(), pathIds.getResourceId());</b>
<b class="nc">&nbsp;            if (resourceModel != null) {</b>
<b class="nc">&nbsp;                this.resources.put(pathRezIdVer, new ResourceValue(resource, resourceModel));</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public ResourceModel getResourceModel(String pathIdVer, LwM2mModelProvider modelProvider) {
<b class="nc">&nbsp;        LwM2mPath pathIds = getLwM2mPathFromString(pathIdVer);</b>
<b class="nc">&nbsp;        String verSupportedObject = String.valueOf(this.getSupportedObjectVersion(pathIds.getObjectId()));</b>
<b class="nc">&nbsp;        String verRez = getVerFromPathIdVerOrId(pathIdVer);</b>
<b class="nc">&nbsp;        return verRez != null &amp;&amp; verRez.equals(verSupportedObject) ? modelProvider.getObjectModel(registration)</b>
<b class="nc">&nbsp;                .getResourceModel(pathIds.getObjectId(), pathIds.getResourceId()) : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public ObjectModel getObjectModel(String pathIdVer, LwM2mModelProvider modelProvider) {
&nbsp;        try {
<b class="nc">&nbsp;            LwM2mPath pathIds = getLwM2mPathFromString(pathIdVer);</b>
<b class="nc">&nbsp;            String verSupportedObject = String.valueOf(this.getSupportedObjectVersion(pathIds.getObjectId()));</b>
<b class="nc">&nbsp;            String verRez = getVerFromPathIdVerOrId(pathIdVer);</b>
<b class="nc">&nbsp;            return verRez != null &amp;&amp; verRez.equals(verSupportedObject) ? modelProvider.getObjectModel(registration)</b>
<b class="nc">&nbsp;                    .getObjectModel(pathIds.getObjectId()) : null;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            if (registration == null) {</b>
<b class="nc">&nbsp;                log.error(&quot;[{}] Failed Registration is null, GetObjectModelRegistration. &quot;, this.endpoint, e);</b>
<b class="nc">&nbsp;            } else if (this.getSupportedClientObjects() == null) {</b>
<b class="nc">&nbsp;                log.error(&quot;[{}] Failed SupportedObject in Registration, GetObjectModelRegistration.&quot;, this.endpoint, e);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                log.error(&quot;[{}] Failed ModelProvider.getObjectModel [{}] in Registration. &quot;, this.endpoint, this.getSupportedClientObjects(), e);</b>
&nbsp;            }
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * The instance must have all the resources that have the property
&nbsp;     * &lt;Mandatory&gt;Mandatory&lt;/Mandatory&gt;
&nbsp;     */
&nbsp;    public Collection&lt;LwM2mResource&gt; getNewResourcesForInstance(String pathRezIdVer, Object params, LwM2mModelProvider modelProvider,
&nbsp;                                                                LwM2mValueConverter converter) {
<b class="nc">&nbsp;        LwM2mPath pathIds = getLwM2mPathFromString(pathRezIdVer);</b>
<b class="nc">&nbsp;        Collection&lt;LwM2mResource&gt; resources = ConcurrentHashMap.newKeySet();</b>
<b class="nc">&nbsp;        Map&lt;Integer, ResourceModel&gt; resourceModels = modelProvider.getObjectModel(registration)</b>
<b class="nc">&nbsp;                .getObjectModel(pathIds.getObjectId()).resources;</b>
<b class="nc">&nbsp;        if (params instanceof Map &amp;&amp; ((Map) params).size() &gt; 0) {</b>
<b class="nc">&nbsp;            Map paramsMap = (Map) params;</b>
<b class="nc">&nbsp;            resourceModels.forEach((resourceId, resourceModel) -&gt; {</b>
<b class="nc">&nbsp;                if (paramsMap.containsKey(String.valueOf(resourceId))) {</b>
<b class="nc">&nbsp;                    Object value = paramsMap.get((String.valueOf(resourceId)));</b>
&nbsp;                    LwM2mResource resource;
<b class="nc">&nbsp;                    if (resourceModel.multiple) {</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            Map&lt;Integer, Object&gt; values = convertMultiResourceValuesFromRpcBody(value, resourceModel.type, pathRezIdVer);</b>
<b class="nc">&nbsp;                            resource = LwM2mMultipleResource.newResource(resourceId, values, resourceModel.type);</b>
&nbsp;                        } catch (Exception e) {
<b class="nc">&nbsp;                            throw new IllegalArgumentException(&quot;Resource id=&quot; + resourceId + &quot;, class = &quot; +</b>
<b class="nc">&nbsp;                                    value.getClass().getSimpleName() + &quot;, value = &quot; + value + &quot; is bad. Value of Multi-Instance Resource must be in Json format!&quot;);</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        Object valueRez = value instanceof Integer ? ((Integer) value).longValue() : value;</b>
<b class="nc">&nbsp;                        resource = LwM2mSingleResource.newResource(resourceId,</b>
<b class="nc">&nbsp;                                converter.convertValue(valueRez, equalsResourceTypeGetSimpleName(value), resourceModel.type, pathIds), resourceModel.type);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (resource != null) {</b>
<b class="nc">&nbsp;                        resources.add(resource);</b>
<b class="nc">&nbsp;                    } else if (resourceModel.operations.isWritable() &amp;&amp; resourceModel.mandatory) {</b>
<b class="nc">&nbsp;                        throw new IllegalArgumentException(&quot;Resource id=&quot; + resourceId + &quot; is mandatory. The value of this resource must not be null.&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                } else if (resourceModel.operations.isWritable() &amp;&amp; resourceModel.mandatory) {</b>
<b class="nc">&nbsp;                    throw new IllegalArgumentException(&quot;Resource id=&quot; + resourceId + &quot; is mandatory. The value of this resource must not be null.&quot;);</b>
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;        } else if (params == null) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;The value of this resource must not be null.&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;The value of this resource must be in Map format and size &gt; 0&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        return resources;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String isValidObjectVersion(String path) {
<b class="nc">&nbsp;        LwM2mPath pathIds = getLwM2mPathFromString(path);</b>
<b class="nc">&nbsp;        if (pathIds.isResource() &amp;&amp; (pathIds.toString().equals(REGISTRATION_TRIGGER_PARAMS_ID ) ||</b>
<b class="nc">&nbsp;                pathIds.toString().equals(BOOTSTRAP_TRIGGER_PARAMS_ID))) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        LwM2m.Version verSupportedObject = this.getSupportedObjectVersion(pathIds.getObjectId());</b>
<b class="nc">&nbsp;        if (verSupportedObject == null) {</b>
<b class="nc">&nbsp;            return String.format(&quot;Specified object id %s absent in the list supported objects of the client or is security object!&quot;, pathIds.getObjectId());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            String verRez = getVerFromPathIdVerOrId(path);</b>
<b class="nc">&nbsp;            if (verRez == null || !verRez.equals(verSupportedObject.toString())) {</b>
<b class="nc">&nbsp;                return String.format(&quot;Specified resource id %s is not valid version! Must be version: %s&quot;, path, verSupportedObject);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return &quot;&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param pathIdVer     == &quot;3_1.0&quot;
&nbsp;     * @param modelProvider -
&nbsp;     */
&nbsp;    public void deleteResources(String pathIdVer, LwM2mModelProvider modelProvider) {
<b class="nc">&nbsp;        Set&lt;String&gt; key = getKeysEqualsIdVer(pathIdVer);</b>
<b class="nc">&nbsp;        key.forEach(pathRez -&gt; {</b>
<b class="nc">&nbsp;            LwM2mPath pathIds = getLwM2mPathFromString(pathRez);</b>
<b class="nc">&nbsp;            ResourceModel resourceModel = modelProvider.getObjectModel(registration).getResourceModel(pathIds.getObjectId(), pathIds.getResourceId());</b>
<b class="nc">&nbsp;            if (resourceModel != null) {</b>
<b class="nc">&nbsp;                this.resources.get(pathRez).setResourceModel(resourceModel);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                this.resources.remove(pathRez);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param idVer         -
&nbsp;     * @param modelProvider -
&nbsp;     */
&nbsp;    public void updateResourceModel(String idVer, LwM2mModelProvider modelProvider) {
<b class="nc">&nbsp;        Set&lt;String&gt; key = getKeysEqualsIdVer(idVer);</b>
<b class="nc">&nbsp;        key.forEach(k -&gt; this.saveResourceModel(k, modelProvider));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void saveResourceModel(String pathRez, LwM2mModelProvider modelProvider) {
<b class="nc">&nbsp;        LwM2mPath pathIds = getLwM2mPathFromString(pathRez);</b>
<b class="nc">&nbsp;        ResourceModel resourceModel = modelProvider.getObjectModel(registration).getResourceModel(pathIds.getObjectId(), pathIds.getResourceId());</b>
<b class="nc">&nbsp;        this.resources.get(pathRez).setResourceModel(resourceModel);</b>
&nbsp;    }
&nbsp;
&nbsp;    private Set&lt;String&gt; getKeysEqualsIdVer(String idVer) {
<b class="nc">&nbsp;        return this.resources.keySet()</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .filter(e -&gt; idVer.equals(e.split(LWM2M_SEPARATOR_PATH)[1]))</b>
<b class="nc">&nbsp;                .collect(Collectors.toSet());</b>
&nbsp;    }
&nbsp;
&nbsp;    private ContentFormat calculateDefaultContentFormat(Registration registration) {
<b class="nc">&nbsp;        if (registration == null) {</b>
<b class="nc">&nbsp;            return ContentFormat.DEFAULT;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return TbLwM2mVersion.fromVersion(registration.getLwM2mVersion()).getContentFormat();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static Set&lt;ContentFormat&gt; clientSupportContentFormat(Registration registration) {
<b class="nc">&nbsp;        Set&lt;ContentFormat&gt; contentFormats = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        Attribute ct = Arrays.stream(registration.getObjectLinks())</b>
<b class="nc">&nbsp;                .filter(link -&gt; link.getUriReference().equals(&quot;/&quot;))</b>
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .map(link -&gt; link.getAttributes().get(&quot;ct&quot;)).orElse(null);</b>
<b class="nc">&nbsp;        if (ct != null &amp;&amp; ct.getValue() instanceof Collection&lt;?&gt;) {</b>
<b class="nc">&nbsp;            contentFormats.addAll((Collection&lt;? extends ContentFormat&gt;) ct.getValue());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            contentFormats.add(ContentFormat.DEFAULT);</b>
&nbsp;        }
<b class="nc">&nbsp;        return contentFormats;</b>
&nbsp;    }
&nbsp;
&nbsp;    public long updateLastUplinkTime() {
<b class="nc">&nbsp;        this.lastUplinkTime = System.currentTimeMillis();</b>
<b class="nc">&nbsp;        this.firstEdrxDownlink = true;</b>
<b class="nc">&nbsp;        return lastUplinkTime;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean checkFirstDownlink() {
<b class="nc">&nbsp;        boolean result = firstEdrxDownlink;</b>
<b class="nc">&nbsp;        firstEdrxDownlink = false;</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    public LwM2mPath getLwM2mPathFromString(String path) {
<b class="nc">&nbsp;        return new LwM2mPath(fromVersionedIdToObjectId(path));</b>
&nbsp;    }
&nbsp;
&nbsp;    public LwM2m.Version getDefaultObjectIDVer() {
<b class="nc">&nbsp;        return this.defaultObjectIDVer == null ? new Version(LWM2M_OBJECT_VERSION_DEFAULT) : this.defaultObjectIDVer;</b>
&nbsp;    }
&nbsp;
&nbsp;    public LwM2m.Version getSupportedObjectVersion(Integer objectid) {
<b class="nc">&nbsp;        return this.supportedClientObjects != null ? this.supportedClientObjects.get(objectid) : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setSupportedClientObjects(){
<b class="nc">&nbsp;        if (this.registration.getSupportedObject() != null &amp;&amp; this.registration.getSupportedObject().size() &gt; 0) {</b>
<b class="nc">&nbsp;            this.supportedClientObjects = this.registration.getSupportedObject();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            this.supportedClientObjects = new ConcurrentHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            for (Link link :  this.registration.getSortedObjectLinks()) {</b>
<b class="nc">&nbsp;                if (link instanceof MixedLwM2mLink) {</b>
<b class="nc">&nbsp;                    LwM2mPath path = ((MixedLwM2mLink) link).getPath();</b>
&nbsp;                    // add supported objects
<b class="nc">&nbsp;                    if (path.isObject() || path.isObjectInstance()) {</b>
<b class="nc">&nbsp;                        int objectId = path.getObjectId();</b>
<b class="nc">&nbsp;                        LwM2mAttribute&lt;Version&gt; versionParamValue = link.getAttributes().get(LwM2mAttributes.OBJECT_VERSION);</b>
<b class="nc">&nbsp;                        if (versionParamValue != null) {</b>
&nbsp;                            // if there is a version attribute then use it as version for this object
<b class="nc">&nbsp;                            this.supportedClientObjects.put(objectId, versionParamValue.getValue());</b>
&nbsp;                        } else {
&nbsp;                            // there is no version attribute attached.
&nbsp;                            // In this case we use the DEFAULT_VERSION only if this object stored as supported object.
<b class="nc">&nbsp;                            Version currentVersion = this.supportedClientObjects.get(objectId);</b>
<b class="nc">&nbsp;                            if (currentVersion == null) {</b>
<b class="nc">&nbsp;                                this.supportedClientObjects.put(objectId, getDefaultObjectIDVer());</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

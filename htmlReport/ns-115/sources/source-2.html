<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultAlarmQueryRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.sql.query</a>
</div>

<h1>Coverage Summary for Class: DefaultAlarmQueryRepository (org.thingsboard.server.dao.sql.query)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultAlarmQueryRepository</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/120)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/236)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.sql.query;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
&nbsp;import org.springframework.stereotype.Repository;
&nbsp;import org.springframework.transaction.support.TransactionTemplate;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmSeverity;
&nbsp;import org.thingsboard.server.common.data.alarm.AlarmStatusFilter;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.permission.QueryContext;
&nbsp;import org.thingsboard.server.common.data.query.AlarmCountQuery;
&nbsp;import org.thingsboard.server.common.data.query.AlarmData;
&nbsp;import org.thingsboard.server.common.data.query.AlarmDataPageLink;
&nbsp;import org.thingsboard.server.common.data.query.AlarmDataQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataSortOrder;
&nbsp;import org.thingsboard.server.common.data.query.EntityKey;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyType;
&nbsp;import org.thingsboard.server.dao.model.ModelConstants;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Repository
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;public class DefaultAlarmQueryRepository implements AlarmQueryRepository {
&nbsp;
<b class="nc">&nbsp;    private static final Map&lt;String, String&gt; alarmFieldColumnMap = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    private static final String ASSIGNEE_EMAIL_KEY = &quot;assigneeEmail&quot;;
&nbsp;    private static final String ASSIGNEE_LAST_NAME_KEY = &quot;assigneeLastName&quot;;
&nbsp;    private static final String ASSIGNEE_FIRST_NAME_KEY = &quot;assigneeFirstName&quot;;
&nbsp;    private static final String ASSIGNEE_ID_KEY = &quot;assigneeId&quot;;
&nbsp;    private static final String ASSIGNEE_KEY = &quot;assignee&quot;;
&nbsp;
&nbsp;    static {
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;createdTime&quot;, ModelConstants.CREATED_TIME_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;ackTs&quot;, ModelConstants.ALARM_ACK_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;ackTime&quot;, ModelConstants.ALARM_ACK_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;clearTs&quot;, ModelConstants.ALARM_CLEAR_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;clearTime&quot;, ModelConstants.ALARM_CLEAR_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;assignTime&quot;, ModelConstants.ALARM_ASSIGN_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;details&quot;, ModelConstants.ADDITIONAL_INFO_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;endTs&quot;, ModelConstants.ALARM_END_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;endTime&quot;, ModelConstants.ALARM_END_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;startTs&quot;, ModelConstants.ALARM_START_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;startTime&quot;, ModelConstants.ALARM_START_TS_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;acknowledged&quot;, ModelConstants.ALARM_ACKNOWLEDGED_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;cleared&quot;, ModelConstants.ALARM_CLEARED_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;type&quot;, ModelConstants.ALARM_TYPE_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;severity&quot;, ModelConstants.ALARM_SEVERITY_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;originatorId&quot;, ModelConstants.ALARM_ORIGINATOR_ID_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;originatorType&quot;, ModelConstants.ALARM_ORIGINATOR_TYPE_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(ASSIGNEE_ID_KEY, ModelConstants.ALARM_ASSIGNEE_ID_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;originator&quot;, ModelConstants.ALARM_ORIGINATOR_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;originatorLabel&quot;, ModelConstants.ALARM_ORIGINATOR_LABEL_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(ASSIGNEE_FIRST_NAME_KEY, ModelConstants.ALARM_ASSIGNEE_FIRST_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(ASSIGNEE_LAST_NAME_KEY, ModelConstants.ALARM_ASSIGNEE_LAST_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(ASSIGNEE_EMAIL_KEY, ModelConstants.ALARM_ASSIGNEE_EMAIL_PROPERTY);</b>
<b class="nc">&nbsp;        alarmFieldColumnMap.put(&quot;originatorDisplayName&quot;, ModelConstants.ALARM_ORIGINATOR_DISPLAY_NAME_PROPERTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static final String FIELDS_SELECTION = &quot;select a.id as id,&quot; +
&nbsp;            &quot; a.created_time as created_time,&quot; +
&nbsp;            &quot; a.ack_ts as ack_ts,&quot; +
&nbsp;            &quot; a.clear_ts as clear_ts,&quot; +
&nbsp;            &quot; a.assign_ts as assign_ts,&quot; +
&nbsp;            &quot; a.assignee_id as assignee_id,&quot; +
&nbsp;            &quot; a.additional_info as additional_info,&quot; +
&nbsp;            &quot; a.end_ts as end_ts,&quot; +
&nbsp;            &quot; a.originator_id as originator_id,&quot; +
&nbsp;            &quot; a.originator_type as originator_type,&quot; +
&nbsp;            &quot; a.propagate as propagate,&quot; +
&nbsp;            &quot; a.propagate_to_owner as propagate_to_owner,&quot; +
&nbsp;            &quot; a.propagate_to_tenant as propagate_to_tenant,&quot; +
&nbsp;            &quot; a.severity as severity,&quot; +
&nbsp;            &quot; a.start_ts as start_ts,&quot; +
&nbsp;            &quot; a.tenant_id as tenant_id, &quot; +
&nbsp;            &quot; a.customer_id as customer_id, &quot; +
&nbsp;            &quot; a.propagate_relation_types as propagate_relation_types, &quot; +
&nbsp;            &quot; a.type as type, &quot; +
&nbsp;            &quot; a.originator_name as originator_name, &quot; +
&nbsp;            &quot; a.originator_label as originator_label, &quot; +
&nbsp;            &quot; coalesce(a.originator_label, a.originator_name) as originator_display_name, &quot; +
&nbsp;            &quot; a.assignee_first_name as assignee_first_name, &quot; +
&nbsp;            &quot; a.assignee_last_name as assignee_last_name, &quot; +
&nbsp;            &quot; a.assignee_email as assignee_email, &quot; +
&nbsp;            &quot; a.cleared as cleared, &quot; +
&nbsp;            &quot; a.acknowledged as acknowledged, &quot;;
&nbsp;
&nbsp;    private static final String JOIN_ENTITY_ALARMS = &quot;inner join entity_alarm ea on a.id = ea.alarm_id &quot;;
&nbsp;
&nbsp;    protected final NamedParameterJdbcTemplate jdbcTemplate;
&nbsp;    private final TransactionTemplate transactionTemplate;
&nbsp;
&nbsp;    private final DefaultQueryLogComponent queryLog;
&nbsp;
<b class="nc">&nbsp;    public DefaultAlarmQueryRepository(NamedParameterJdbcTemplate jdbcTemplate, TransactionTemplate transactionTemplate, DefaultQueryLogComponent queryLog) {</b>
<b class="nc">&nbsp;        this.jdbcTemplate = jdbcTemplate;</b>
<b class="nc">&nbsp;        this.transactionTemplate = transactionTemplate;</b>
<b class="nc">&nbsp;        this.queryLog = queryLog;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;AlarmData&gt; findAlarmDataByQueryForEntities(TenantId tenantId, AlarmDataQuery query, Collection&lt;EntityId&gt; orderedEntityIds) {
<b class="nc">&nbsp;        return transactionTemplate.execute(trStatus -&gt; {</b>
<b class="nc">&nbsp;            AlarmDataPageLink pageLink = query.getPageLink();</b>
<b class="nc">&nbsp;            SqlQueryContext ctx = new SqlQueryContext(new QueryContext(tenantId, null, EntityType.ALARM));</b>
<b class="nc">&nbsp;            ctx.addUuidListParameter(&quot;entity_ids&quot;, orderedEntityIds.stream().map(EntityId::getId).collect(Collectors.toList()));</b>
<b class="nc">&nbsp;            StringBuilder selectPart = new StringBuilder(FIELDS_SELECTION);</b>
<b class="nc">&nbsp;            StringBuilder fromPart = new StringBuilder(&quot; from alarm_info a &quot;);</b>
<b class="nc">&nbsp;            StringBuilder wherePart = new StringBuilder(&quot; where &quot;);</b>
<b class="nc">&nbsp;            StringBuilder sortPart = new StringBuilder(&quot; order by &quot;);</b>
<b class="nc">&nbsp;            StringBuilder joinPart = new StringBuilder();</b>
<b class="nc">&nbsp;            boolean addAnd = false;</b>
<b class="nc">&nbsp;            if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                selectPart.append(&quot; ea.entity_id as entity_id &quot;);</b>
<b class="nc">&nbsp;                fromPart.append(JOIN_ENTITY_ALARMS);</b>
<b class="nc">&nbsp;                wherePart.append(buildPermissionsQuery(tenantId, ctx));</b>
<b class="nc">&nbsp;                addAnd = true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                selectPart.append(&quot; a.originator_id as entity_id &quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            EntityDataSortOrder sortOrder = pageLink.getSortOrder();</b>
&nbsp;
<b class="nc">&nbsp;            if (sortOrder != null &amp;&amp; EntityKeyType.ALARM_FIELD.equals(sortOrder.getKey().getType()) &amp;&amp; ASSIGNEE_KEY.equalsIgnoreCase(sortOrder.getKey().getKey())) {</b>
<b class="nc">&nbsp;                sortOrder = new EntityDataSortOrder(new EntityKey(EntityKeyType.ALARM_FIELD, ASSIGNEE_EMAIL_KEY), sortOrder.getDirection());</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            List&lt;EntityKey&gt; alarmFields = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EntityKey key : query.getAlarmFields()) {</b>
<b class="nc">&nbsp;                if (EntityKeyType.ALARM_FIELD.equals(key.getType()) &amp;&amp; ASSIGNEE_KEY.equalsIgnoreCase(key.getKey())) {</b>
<b class="nc">&nbsp;                    alarmFields.add(new EntityKey(EntityKeyType.ALARM_FIELD, ASSIGNEE_ID_KEY));</b>
<b class="nc">&nbsp;                    alarmFields.add(new EntityKey(EntityKeyType.ALARM_FIELD, ASSIGNEE_FIRST_NAME_KEY));</b>
<b class="nc">&nbsp;                    alarmFields.add(new EntityKey(EntityKeyType.ALARM_FIELD, ASSIGNEE_LAST_NAME_KEY));</b>
<b class="nc">&nbsp;                    alarmFields.add(new EntityKey(EntityKeyType.ALARM_FIELD, ASSIGNEE_EMAIL_KEY));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    alarmFields.add(key);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            String textSearchQuery = buildTextSearchQuery(ctx, alarmFields, pageLink.getTextSearch());</b>
<b class="nc">&nbsp;            if (sortOrder != null &amp;&amp; sortOrder.getKey().getType().equals(EntityKeyType.ALARM_FIELD)) {</b>
<b class="nc">&nbsp;                String sortOrderKey = sortOrder.getKey().getKey();</b>
<b class="nc">&nbsp;                if (&quot;status&quot;.equalsIgnoreCase(sortOrderKey)) {</b>
<b class="nc">&nbsp;                    selectPart.append(&quot;, a.status as status &quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                sortPart.append(alarmFieldColumnMap.getOrDefault(sortOrderKey, sortOrderKey))</b>
<b class="nc">&nbsp;                        .append(&quot; &quot;).append(sortOrder.getDirection().name());</b>
<b class="nc">&nbsp;                if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; and ea.entity_id in (:entity_ids)&quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                    addAnd = true;</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; a.originator_id in (:entity_ids)&quot;);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                joinPart.append(&quot; inner join (select * from (VALUES&quot;);</b>
<b class="nc">&nbsp;                int entityIdIdx = 0;</b>
<b class="nc">&nbsp;                int lastEntityIdIdx = orderedEntityIds.size() - 1;</b>
<b class="nc">&nbsp;                for (EntityId entityId : orderedEntityIds) {</b>
<b class="nc">&nbsp;                    joinPart.append(&quot;(uuid(&#39;&quot;).append(entityId.getId().toString()).append(&quot;&#39;), &quot;).append(entityIdIdx).append(&quot;)&quot;);</b>
<b class="nc">&nbsp;                    if (entityIdIdx != lastEntityIdIdx) {</b>
<b class="nc">&nbsp;                        joinPart.append(&quot;,&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        joinPart.append(&quot;)&quot;);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    entityIdIdx++;</b>
&nbsp;                }
<b class="nc">&nbsp;                joinPart.append(&quot; as e(id, priority)) e &quot;);</b>
<b class="nc">&nbsp;                if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                    if (textSearchQuery.isEmpty()) {</b>
<b class="nc">&nbsp;                        joinPart.append(&quot;on ea.entity_id = e.id&quot;);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        joinPart.append(&quot;on a.entity_id = e.id&quot;);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    joinPart.append(&quot;on a.originator_id = e.id&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                sortPart.append(&quot;e.priority&quot;);</b>
&nbsp;            }
&nbsp;
&nbsp;            long startTs;
&nbsp;            long endTs;
<b class="nc">&nbsp;            if (pageLink.getTimeWindow() &gt; 0) {</b>
<b class="nc">&nbsp;                if (pageLink.getStartTs() &gt; 0) {</b>
<b class="nc">&nbsp;                    startTs = pageLink.getStartTs();</b>
<b class="nc">&nbsp;                    endTs = startTs + pageLink.getTimeWindow();</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    endTs = System.currentTimeMillis();</b>
<b class="nc">&nbsp;                    startTs = endTs - pageLink.getTimeWindow();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                startTs = pageLink.getStartTs();</b>
<b class="nc">&nbsp;                endTs = pageLink.getEndTs();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (startTs &gt; 0) {</b>
<b class="nc">&nbsp;                addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                addAnd = true;</b>
<b class="nc">&nbsp;                ctx.addLongParameter(&quot;startTime&quot;, startTs);</b>
<b class="nc">&nbsp;                wherePart.append(&quot;a.created_time &gt;= :startTime&quot;);</b>
<b class="nc">&nbsp;                if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; and ea.created_time &gt;= :startTime&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (endTs &gt; 0) {</b>
<b class="nc">&nbsp;                addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                addAnd = true;</b>
<b class="nc">&nbsp;                ctx.addLongParameter(&quot;endTime&quot;, endTs);</b>
<b class="nc">&nbsp;                wherePart.append(&quot;a.created_time &lt;= :endTime&quot;);</b>
<b class="nc">&nbsp;                if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; and ea.created_time &lt;= :endTime&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (pageLink.getTypeList() != null &amp;&amp; !pageLink.getTypeList().isEmpty()) {</b>
<b class="nc">&nbsp;                addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                addAnd = true;</b>
<b class="nc">&nbsp;                ctx.addStringListParameter(&quot;alarmTypes&quot;, pageLink.getTypeList());</b>
<b class="nc">&nbsp;                wherePart.append(&quot;a.type in (:alarmTypes)&quot;);</b>
<b class="nc">&nbsp;                if (pageLink.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; and ea.alarm_type in (:alarmTypes)&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (pageLink.getSeverityList() != null &amp;&amp; !pageLink.getSeverityList().isEmpty()) {</b>
<b class="nc">&nbsp;                addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                addAnd = true;</b>
<b class="nc">&nbsp;                ctx.addStringListParameter(&quot;alarmSeverities&quot;, pageLink.getSeverityList().stream().map(AlarmSeverity::name).collect(Collectors.toList()));</b>
<b class="nc">&nbsp;                wherePart.append(&quot;a.severity in (:alarmSeverities)&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            AlarmStatusFilter asf = AlarmStatusFilter.from(pageLink.getStatusList());</b>
<b class="nc">&nbsp;            if (asf.hasAnyFilter()) {</b>
<b class="nc">&nbsp;                if (asf.hasAckFilter()) {</b>
<b class="nc">&nbsp;                    addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                    addAnd = true;</b>
<b class="nc">&nbsp;                    ctx.addBooleanParameter(&quot;ackStatus&quot;, asf.getAckFilter());</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; a.acknowledged = :ackStatus&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (asf.hasClearFilter()) {</b>
<b class="nc">&nbsp;                    addAndIfNeeded(wherePart, addAnd);</b>
&nbsp;                    // addAnd = true; // not needed but stored as an example if someone adds new conditions
<b class="nc">&nbsp;                    ctx.addBooleanParameter(&quot;clearStatus&quot;, asf.getClearFilter());</b>
<b class="nc">&nbsp;                    wherePart.append(&quot; a.cleared = :clearStatus&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (pageLink.getAssigneeId() != null) {</b>
<b class="nc">&nbsp;                addAndIfNeeded(wherePart, addAnd);</b>
<b class="nc">&nbsp;                addAnd = true;</b>
<b class="nc">&nbsp;                ctx.addUuidParameter(&quot;assigneeId&quot;, pageLink.getAssigneeId().getId());</b>
<b class="nc">&nbsp;                wherePart.append(&quot; a.assignee_id = :assigneeId&quot;);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            String mainQuery = String.format(&quot;%s%s&quot;, selectPart, fromPart);</b>
<b class="nc">&nbsp;            if (textSearchQuery.isEmpty()) {</b>
<b class="nc">&nbsp;                mainQuery = String.format(&quot;%s%s%s&quot;, mainQuery, joinPart, wherePart);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                mainQuery = String.format(&quot;select * from (%s%s) a %s WHERE %s&quot;, mainQuery, wherePart, joinPart, textSearchQuery);</b>
&nbsp;            }
<b class="nc">&nbsp;            String countQuery = String.format(&quot;select count(*) from (%s) result&quot;, mainQuery);</b>
<b class="nc">&nbsp;            long queryTs = System.currentTimeMillis();</b>
&nbsp;            int totalElements;
&nbsp;            try {
<b class="nc">&nbsp;                totalElements = jdbcTemplate.queryForObject(countQuery, ctx, Integer.class);</b>
&nbsp;            } finally {
<b class="nc">&nbsp;                queryLog.logQuery(ctx, countQuery, System.currentTimeMillis() - queryTs);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (totalElements == 0) {</b>
<b class="nc">&nbsp;                return AlarmDataAdapter.createAlarmData(pageLink, Collections.emptyList(), totalElements, orderedEntityIds);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            String dataQuery = mainQuery + sortPart;</b>
&nbsp;
<b class="nc">&nbsp;            int startIndex = pageLink.getPageSize() * pageLink.getPage();</b>
<b class="nc">&nbsp;            if (pageLink.getPageSize() &gt; 0) {</b>
<b class="nc">&nbsp;                dataQuery = String.format(&quot;%s limit %s offset %s&quot;, dataQuery, pageLink.getPageSize(), startIndex);</b>
&nbsp;            }
<b class="nc">&nbsp;            queryTs = System.currentTimeMillis();</b>
&nbsp;            List&lt;Map&lt;String, Object&gt;&gt; rows;
&nbsp;            try {
<b class="nc">&nbsp;                rows = jdbcTemplate.queryForList(dataQuery, ctx);</b>
&nbsp;            } finally {
<b class="nc">&nbsp;                queryLog.logQuery(ctx, dataQuery, System.currentTimeMillis() - queryTs);</b>
&nbsp;            }
<b class="nc">&nbsp;            return AlarmDataAdapter.createAlarmData(pageLink, rows, totalElements, orderedEntityIds);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countAlarmsByQuery(TenantId tenantId, CustomerId customerId, AlarmCountQuery query, Collection&lt;EntityId&gt; orderedEntityIds) {
<b class="nc">&nbsp;        SqlQueryContext ctx = new SqlQueryContext(new QueryContext(tenantId, null, EntityType.ALARM));</b>
&nbsp;
<b class="nc">&nbsp;        if (query.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;            if (query.getEntityFilter() == null) {</b>
<b class="nc">&nbsp;                ctx.append(&quot;select count(distinct(a.id)) from alarm_info a &quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ctx.append(&quot;select count(a.id) from alarm_info a &quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            ctx.append(JOIN_ENTITY_ALARMS);</b>
<b class="nc">&nbsp;            if (orderedEntityIds != null) {</b>
<b class="nc">&nbsp;                if (orderedEntityIds.isEmpty()) {</b>
<b class="nc">&nbsp;                    return 0;</b>
&nbsp;                }
<b class="nc">&nbsp;                ctx.addUuidListParameter(&quot;entity_filter_entity_ids&quot;, orderedEntityIds.stream().map(EntityId::getId).collect(Collectors.toList()));</b>
<b class="nc">&nbsp;                ctx.append(&quot;where ea.entity_id in (:entity_filter_entity_ids)&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ctx.append(&quot;where a.tenant_id = :tenantId and ea.tenant_id = :tenantId&quot;);</b>
<b class="nc">&nbsp;                ctx.addUuidParameter(&quot;tenantId&quot;, tenantId.getId());</b>
<b class="nc">&nbsp;                if (customerId != null &amp;&amp; !customerId.isNullUid()) {</b>
<b class="nc">&nbsp;                    ctx.append(&quot; and a.customer_id = :customerId and ea.customer_id = :customerId&quot;);</b>
<b class="nc">&nbsp;                    ctx.addUuidParameter(&quot;customerId&quot;, customerId.getId());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            ctx.append(&quot;select count(id) from alarm_info a &quot;);</b>
<b class="nc">&nbsp;            if (orderedEntityIds != null) {</b>
<b class="nc">&nbsp;                if (orderedEntityIds.isEmpty()) {</b>
<b class="nc">&nbsp;                    return 0;</b>
&nbsp;                }
<b class="nc">&nbsp;                ctx.addUuidListParameter(&quot;entity_filter_entity_ids&quot;, orderedEntityIds.stream().map(EntityId::getId).collect(Collectors.toList()));</b>
<b class="nc">&nbsp;                ctx.append(&quot;where a.originator_id in (:entity_filter_entity_ids)&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ctx.append(&quot;where a.tenant_id = :tenantId&quot;);</b>
<b class="nc">&nbsp;                ctx.addUuidParameter(&quot;tenantId&quot;, tenantId.getId());</b>
<b class="nc">&nbsp;                if (customerId != null &amp;&amp; !customerId.isNullUid()) {</b>
<b class="nc">&nbsp;                    ctx.append(&quot; and a.customer_id = :customerId&quot;);</b>
<b class="nc">&nbsp;                    ctx.addUuidParameter(&quot;customerId&quot;, customerId.getId());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        long startTs;
&nbsp;        long endTs;
<b class="nc">&nbsp;        if (query.getTimeWindow() &gt; 0) {</b>
<b class="nc">&nbsp;            endTs = System.currentTimeMillis();</b>
<b class="nc">&nbsp;            startTs = endTs - query.getTimeWindow();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            startTs = query.getStartTs();</b>
<b class="nc">&nbsp;            endTs = query.getEndTs();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (startTs &gt; 0) {</b>
<b class="nc">&nbsp;            ctx.append(&quot; and a.created_time &gt;= :startTime&quot;);</b>
<b class="nc">&nbsp;            ctx.addLongParameter(&quot;startTime&quot;, startTs);</b>
<b class="nc">&nbsp;            if (query.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                ctx.append(&quot; and ea.created_time &gt;= :startTime&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (endTs &gt; 0) {</b>
<b class="nc">&nbsp;            ctx.append(&quot; and a.created_time &lt;= :endTime&quot;);</b>
<b class="nc">&nbsp;            ctx.addLongParameter(&quot;endTime&quot;, endTs);</b>
<b class="nc">&nbsp;            if (query.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                ctx.append(&quot; and ea.created_time &lt;= :endTime&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!CollectionUtils.isEmpty(query.getTypeList())) {</b>
<b class="nc">&nbsp;            ctx.append(&quot; and a.type in (:alarmTypes)&quot;);</b>
<b class="nc">&nbsp;            ctx.addStringListParameter(&quot;alarmTypes&quot;, query.getTypeList());</b>
<b class="nc">&nbsp;            if (query.isSearchPropagatedAlarms()) {</b>
<b class="nc">&nbsp;                ctx.append(&quot; and ea.alarm_type in (:alarmTypes)&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (query.getSeverityList() != null &amp;&amp; !query.getSeverityList().isEmpty()) {</b>
<b class="nc">&nbsp;            ctx.append(&quot; and a.severity in (:alarmSeverities)&quot;);</b>
<b class="nc">&nbsp;            ctx.addStringListParameter(&quot;alarmSeverities&quot;, query.getSeverityList().stream().map(AlarmSeverity::name).collect(Collectors.toList()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        AlarmStatusFilter asf = AlarmStatusFilter.from(query.getStatusList());</b>
<b class="nc">&nbsp;        if (asf.hasAnyFilter()) {</b>
<b class="nc">&nbsp;            if (asf.hasAckFilter()) {</b>
<b class="nc">&nbsp;                ctx.append(&quot; and a.acknowledged = :ackStatus&quot;);</b>
<b class="nc">&nbsp;                ctx.addBooleanParameter(&quot;ackStatus&quot;, asf.getAckFilter());</b>
&nbsp;            }
<b class="nc">&nbsp;            if (asf.hasClearFilter()) {</b>
<b class="nc">&nbsp;                ctx.append(&quot; and a.cleared = :clearStatus&quot;);</b>
<b class="nc">&nbsp;                ctx.addBooleanParameter(&quot;clearStatus&quot;, asf.getClearFilter());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (query.getAssigneeId() != null) {</b>
<b class="nc">&nbsp;            ctx.addUuidParameter(&quot;assigneeId&quot;, query.getAssigneeId().getId());</b>
<b class="nc">&nbsp;            ctx.append(&quot; and a.assignee_id = :assigneeId&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return transactionTemplate.execute(trStatus -&gt; {</b>
<b class="nc">&nbsp;            long queryTs = System.currentTimeMillis();</b>
&nbsp;            try {
<b class="nc">&nbsp;                return jdbcTemplate.queryForObject(ctx.getQuery(), ctx, Long.class);</b>
&nbsp;            } finally {
<b class="nc">&nbsp;                queryLog.logQuery(ctx, ctx.getQuery(), System.currentTimeMillis() - queryTs);</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private String buildTextSearchQuery(SqlQueryContext ctx, List&lt;EntityKey&gt; selectionMapping, String searchText) {
<b class="nc">&nbsp;        if (!StringUtils.isEmpty(searchText) &amp;&amp; selectionMapping != null &amp;&amp; !selectionMapping.isEmpty()) {</b>
<b class="nc">&nbsp;            String lowerSearchText = searchText.toLowerCase() + &quot;%&quot;;</b>
<b class="nc">&nbsp;            List&lt;String&gt; searchPredicates = selectionMapping.stream()</b>
<b class="nc">&nbsp;                    .map(mapping -&gt; alarmFieldColumnMap.get(mapping.getKey()))</b>
<b class="nc">&nbsp;                    .filter(Objects::nonNull)</b>
<b class="nc">&nbsp;                    .map(mapping -&gt; {</b>
<b class="nc">&nbsp;                                String paramName = mapping + &quot;_lowerSearchText&quot;;</b>
<b class="nc">&nbsp;                                ctx.addStringParameter(paramName, lowerSearchText);</b>
<b class="nc">&nbsp;                                return String.format(&quot;cast(%s as varchar) ILIKE concat(&#39;%%&#39;, :%s, &#39;%%&#39;)&quot;, mapping, paramName);</b>
&nbsp;                            }
<b class="nc">&nbsp;                    ).collect(Collectors.toList());</b>
<b class="nc">&nbsp;            return String.format(&quot;%s&quot;, String.join(&quot; or &quot;, searchPredicates));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String buildPermissionsQuery(TenantId tenantId, SqlQueryContext ctx) {
<b class="nc">&nbsp;        StringBuilder permissionsQuery = new StringBuilder();</b>
<b class="nc">&nbsp;        ctx.addUuidParameter(&quot;permissions_tenant_id&quot;, tenantId.getId());</b>
<b class="nc">&nbsp;        permissionsQuery.append(&quot; a.tenant_id = :permissions_tenant_id and ea.tenant_id = :permissions_tenant_id &quot;);</b>
<b class="nc">&nbsp;        return permissionsQuery.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addAndIfNeeded(StringBuilder wherePart, boolean addAnd) {
<b class="nc">&nbsp;        if (addAnd) {</b>
<b class="nc">&nbsp;            wherePart.append(&quot; and &quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

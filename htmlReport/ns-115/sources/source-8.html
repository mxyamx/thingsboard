<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EntityKeyMapping</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.sql.query</a>
</div>

<h1>Coverage Summary for Class: EntityKeyMapping (org.thingsboard.server.dao.sql.query)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EntityKeyMapping</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/146)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/343)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EntityKeyMapping$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/146)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/346)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.sql.query;
&nbsp;
&nbsp;import lombok.Data;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.query.BooleanFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.ComplexFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.EntityCountQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataSortOrder;
&nbsp;import org.thingsboard.server.common.data.query.EntityFilter;
&nbsp;import org.thingsboard.server.common.data.query.EntityFilterType;
&nbsp;import org.thingsboard.server.common.data.query.EntityKey;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyType;
&nbsp;import org.thingsboard.server.common.data.query.FilterPredicateType;
&nbsp;import org.thingsboard.server.common.data.query.KeyFilter;
&nbsp;import org.thingsboard.server.common.data.query.KeyFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.NumericFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.StringFilterPredicate;
&nbsp;import org.thingsboard.server.dao.model.ModelConstants;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collections;
&nbsp;import java.util.EnumMap;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;import java.util.Set;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.Stream;
&nbsp;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.splitByCommaWithoutQuotes;
&nbsp;import static org.thingsboard.server.common.data.id.EntityId.NULL_UUID;
&nbsp;import static org.thingsboard.server.dao.sql.query.DefaultEntityQueryRepository.resolveEntityType;
&nbsp;
&nbsp;@Data
&nbsp;public class EntityKeyMapping {
&nbsp;
<b class="nc">&nbsp;    private static final Map&lt;EntityType, Set&lt;String&gt;&gt; allowedEntityFieldMap = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private static final Map&lt;String, String&gt; entityFieldColumnMap = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private static final Map&lt;EntityType, Map&lt;String, String&gt;&gt; aliases = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    private static final Map&lt;EntityType, Map&lt;String, String&gt;&gt; propertiesFunctions = new EnumMap&lt;&gt;(EntityType.class);</b>
&nbsp;
&nbsp;    public static final String CREATED_TIME = &quot;createdTime&quot;;
&nbsp;    public static final String ENTITY_TYPE = &quot;entityType&quot;;
&nbsp;    public static final String NAME = &quot;name&quot;;
&nbsp;    public static final String TYPE = &quot;type&quot;;
&nbsp;    public static final String LABEL = &quot;label&quot;;
&nbsp;    public static final String DISPLAY_NAME = &quot;displayName&quot;;
&nbsp;    public static final String FIRST_NAME = &quot;firstName&quot;;
&nbsp;    public static final String LAST_NAME = &quot;lastName&quot;;
&nbsp;    public static final String EMAIL = &quot;email&quot;;
&nbsp;    public static final String TITLE = &quot;title&quot;;
&nbsp;    public static final String REGION = &quot;region&quot;;
&nbsp;    public static final String COUNTRY = &quot;country&quot;;
&nbsp;    public static final String STATE = &quot;state&quot;;
&nbsp;    public static final String CITY = &quot;city&quot;;
&nbsp;    public static final String ADDRESS = &quot;address&quot;;
&nbsp;    public static final String ADDRESS_2 = &quot;address2&quot;;
&nbsp;    public static final String ZIP = &quot;zip&quot;;
&nbsp;    public static final String PHONE = &quot;phone&quot;;
&nbsp;    public static final String ADDITIONAL_INFO = &quot;additionalInfo&quot;;
&nbsp;    public static final String RELATED_PARENT_ID = &quot;parentId&quot;;
&nbsp;    public static final String QUEUE_NAME = &quot;queueName&quot;;
&nbsp;    public static final String SERVICE_ID = &quot;serviceId&quot;;
&nbsp;    public static final String OWNER_NAME = &quot;ownerName&quot;;
&nbsp;    public static final String OWNER_TYPE = &quot;ownerType&quot;;
&nbsp;    public static final String LABELED_ENTITY_DISPLAY_NAME_SELECT_QUERY = &quot;COALESCE(NULLIF(TRIM(e.&quot; + LABEL + &quot;), &#39;&#39;), e.&quot; + NAME + &quot;)&quot;;
&nbsp;    public static final String USER_DISPLAY_NAME_SELECT_QUERY  = &quot;COALESCE(NULLIF(TRIM(CONCAT_WS(&#39; &#39;, e.first_name, e.last_name)), &#39;&#39;), e.email)&quot;;
<b class="nc">&nbsp;    public static final String OWNER_NAME_SELECT_QUERY = &quot;case when e.customer_id = &#39;&quot; + NULL_UUID + &quot;&#39; &quot; +</b>
&nbsp;            &quot;then (select title from tenant where id = e.tenant_id) &quot; +
&nbsp;            &quot;else (select title from customer where id = e.customer_id) end&quot;;
<b class="nc">&nbsp;    public static final String OWNER_TYPE_SELECT_QUERY = &quot;case when e.customer_id = &#39;&quot; + NULL_UUID + &quot;&#39; &quot; +</b>
&nbsp;            &quot;then &#39;TENANT&#39; &quot; +
&nbsp;            &quot;else &#39;CUSTOMER&#39; end&quot;;
&nbsp;    public static final String QUEUE_STATS_NAME_QUERY = &quot;concat(e.queue_name, &#39;_&#39;, e.service_id)&quot;;
<b class="nc">&nbsp;    public static final Map&lt;String, String&gt; ownerPropertiesFunctions = Map.of(</b>
&nbsp;            OWNER_NAME, OWNER_NAME_SELECT_QUERY,
&nbsp;            OWNER_TYPE, OWNER_TYPE_SELECT_QUERY
&nbsp;    );
<b class="nc">&nbsp;    public static final Map&lt;String, String&gt; labeledPropertiesFunctions = Map.of(</b>
&nbsp;            OWNER_NAME, OWNER_NAME_SELECT_QUERY,
&nbsp;            OWNER_TYPE, OWNER_TYPE_SELECT_QUERY,
&nbsp;            DISPLAY_NAME, LABELED_ENTITY_DISPLAY_NAME_SELECT_QUERY
&nbsp;    );
<b class="nc">&nbsp;    public static final Map&lt;String, String&gt; userPropertiesFunctions = Map.of(</b>
&nbsp;            OWNER_NAME, OWNER_NAME_SELECT_QUERY,
&nbsp;            OWNER_TYPE, OWNER_TYPE_SELECT_QUERY,
&nbsp;            DISPLAY_NAME, USER_DISPLAY_NAME_SELECT_QUERY
&nbsp;    );
<b class="nc">&nbsp;    public static final Map&lt;String, String&gt; queueStatsPropertiesFunctions = Map.of(NAME, QUEUE_STATS_NAME_QUERY);</b>
&nbsp;
<b class="nc">&nbsp;    public static final List&lt;String&gt; typedEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME, TYPE, ADDITIONAL_INFO);</b>
<b class="nc">&nbsp;    public static final List&lt;String&gt; widgetEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME);</b>
<b class="nc">&nbsp;    public static final List&lt;String&gt; commonEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME, ADDITIONAL_INFO);</b>
<b class="nc">&nbsp;    public static final List&lt;String&gt; dashboardEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, TITLE);</b>
<b class="nc">&nbsp;    public static final List&lt;String&gt; labeledEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME, TYPE, LABEL, ADDITIONAL_INFO);</b>
<b class="nc">&nbsp;    public static final List&lt;String&gt; contactBasedEntityFields = Arrays.asList(CREATED_TIME, ENTITY_TYPE, EMAIL, TITLE, COUNTRY, STATE, CITY, ADDRESS, ADDRESS_2, ZIP, PHONE, ADDITIONAL_INFO);</b>
&nbsp;
<b class="nc">&nbsp;    public static final Set&lt;String&gt; apiUsageStateEntityFields = new HashSet&lt;&gt;(Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME));</b>
<b class="nc">&nbsp;    public static final Set&lt;String&gt; commonEntityFieldsSet = new HashSet&lt;&gt;(commonEntityFields);</b>
<b class="nc">&nbsp;    public static final Set&lt;String&gt; relationQueryEntityFieldsSet = new HashSet&lt;&gt;(Arrays.asList(CREATED_TIME, ENTITY_TYPE, NAME, TYPE, LABEL, FIRST_NAME, LAST_NAME, EMAIL, REGION, TITLE, COUNTRY, STATE, CITY, ADDRESS, ADDRESS_2, ZIP, PHONE, ADDITIONAL_INFO, RELATED_PARENT_ID));</b>
&nbsp;
&nbsp;    static {
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.DEVICE, new HashSet&lt;&gt;(labeledEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.ASSET, new HashSet&lt;&gt;(labeledEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.ENTITY_VIEW, new HashSet&lt;&gt;(typedEntityFields));</b>
&nbsp;
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.TENANT, new HashSet&lt;&gt;(contactBasedEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.get(EntityType.TENANT).add(REGION);</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.CUSTOMER, new HashSet&lt;&gt;(contactBasedEntityFields));</b>
&nbsp;
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.USER, new HashSet&lt;&gt;(Arrays.asList(CREATED_TIME, FIRST_NAME, LAST_NAME, EMAIL, PHONE, ADDITIONAL_INFO)));</b>
&nbsp;
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.DASHBOARD, new HashSet&lt;&gt;(dashboardEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.RULE_CHAIN, new HashSet&lt;&gt;(commonEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.RULE_NODE, new HashSet&lt;&gt;(commonEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.WIDGET_TYPE, new HashSet&lt;&gt;(widgetEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.WIDGETS_BUNDLE, new HashSet&lt;&gt;(widgetEntityFields));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.API_USAGE_STATE, apiUsageStateEntityFields);</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.DEVICE_PROFILE, Set.of(CREATED_TIME, NAME, TYPE));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.ASSET_PROFILE, Set.of(CREATED_TIME, NAME));</b>
<b class="nc">&nbsp;        allowedEntityFieldMap.put(EntityType.QUEUE_STATS, new HashSet&lt;&gt;(Arrays.asList(CREATED_TIME, QUEUE_NAME, SERVICE_ID)));</b>
&nbsp;
<b class="nc">&nbsp;        entityFieldColumnMap.put(CREATED_TIME, ModelConstants.CREATED_TIME_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(ENTITY_TYPE, ModelConstants.ENTITY_TYPE_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(REGION, ModelConstants.TENANT_REGION_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(NAME, &quot;name&quot;);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(TYPE, &quot;type&quot;);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(LABEL, &quot;label&quot;);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(FIRST_NAME, ModelConstants.USER_FIRST_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(LAST_NAME, ModelConstants.USER_LAST_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(EMAIL, ModelConstants.EMAIL_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(TITLE, ModelConstants.TITLE_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(COUNTRY, ModelConstants.COUNTRY_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(STATE, ModelConstants.STATE_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(CITY, ModelConstants.CITY_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(ADDRESS, ModelConstants.ADDRESS_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(ADDRESS_2, ModelConstants.ADDRESS2_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(ZIP, ModelConstants.ZIP_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(PHONE, ModelConstants.PHONE_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(ADDITIONAL_INFO, ModelConstants.ADDITIONAL_INFO_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(RELATED_PARENT_ID, &quot;parent_id&quot;);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(QUEUE_NAME, ModelConstants.QUEUE_STATS_QUEUE_NAME_PROPERTY);</b>
<b class="nc">&nbsp;        entityFieldColumnMap.put(SERVICE_ID, ModelConstants.QUEUE_STATS_SERVICE_ID_PROPERTY);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, String&gt; contactBasedAliases = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        contactBasedAliases.put(NAME, TITLE);</b>
<b class="nc">&nbsp;        contactBasedAliases.put(LABEL, TITLE);</b>
<b class="nc">&nbsp;        contactBasedAliases.put(DISPLAY_NAME, TITLE);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.TENANT, contactBasedAliases);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.CUSTOMER, contactBasedAliases);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.DASHBOARD, contactBasedAliases);</b>
<b class="nc">&nbsp;        Map&lt;String, String&gt; deviceAndAssetAliases = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        deviceAndAssetAliases.put(TITLE, NAME);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.DEVICE, deviceAndAssetAliases);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.ASSET, deviceAndAssetAliases);</b>
<b class="nc">&nbsp;        Map&lt;String, String&gt; commonEntityAliases = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        commonEntityAliases.put(TITLE, NAME);</b>
<b class="nc">&nbsp;        commonEntityAliases.put(DISPLAY_NAME, NAME);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.ENTITY_VIEW, commonEntityAliases);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.WIDGETS_BUNDLE, commonEntityAliases);</b>
&nbsp;
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.DEVICE, labeledPropertiesFunctions);</b>
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.ASSET, labeledPropertiesFunctions);</b>
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.ENTITY_VIEW, ownerPropertiesFunctions);</b>
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.USER, userPropertiesFunctions);</b>
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.DASHBOARD, ownerPropertiesFunctions);</b>
<b class="nc">&nbsp;        propertiesFunctions.put(EntityType.QUEUE_STATS, queueStatsPropertiesFunctions);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, String&gt; userEntityAliases = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        userEntityAliases.put(TITLE, EMAIL);</b>
<b class="nc">&nbsp;        userEntityAliases.put(LABEL, EMAIL);</b>
<b class="nc">&nbsp;        userEntityAliases.put(NAME, EMAIL);</b>
<b class="nc">&nbsp;        aliases.put(EntityType.USER, userEntityAliases);</b>
&nbsp;    }
&nbsp;
&nbsp;    private int index;
&nbsp;    private String alias;
&nbsp;    private boolean isLatest;
&nbsp;    private String entityKeyColumn;
&nbsp;    private boolean isSelection;
&nbsp;    private boolean isSearchable;
&nbsp;    private boolean isSortOrder;
&nbsp;    private boolean ignore = false;
&nbsp;    private List&lt;KeyFilter&gt; keyFilters;
&nbsp;    private EntityKey entityKey;
&nbsp;    private int paramIdx = 0;
&nbsp;
&nbsp;    public boolean hasFilter() {
<b class="nc">&nbsp;        return keyFilters != null &amp;&amp; !keyFilters.isEmpty();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getValueAlias() {
<b class="nc">&nbsp;        if (entityKey.getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;            return alias;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return alias + &quot;_value&quot;;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String getTsAlias() {
<b class="nc">&nbsp;        return alias + &quot;_ts&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String toSelection(EntityFilterType filterType, EntityType entityType) {
<b class="nc">&nbsp;        if (entityKey.getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;            if (entityKey.getKey().equals(&quot;entityType&quot;) &amp;&amp; !filterType.equals(EntityFilterType.RELATIONS_QUERY)) {</b>
<b class="nc">&nbsp;                return String.format(&quot;&#39;%s&#39; as %s&quot;, entityType.name(), getValueAlias());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (getEntityKeyColumn() != null) {</b>
<b class="nc">&nbsp;                    return String.format(&quot;cast(e.%s as varchar) as %s&quot;, getEntityKeyColumn(), getValueAlias());</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    Map&lt;String, String&gt; entityPropertiesFunctions = propertiesFunctions.get(entityType);</b>
<b class="nc">&nbsp;                    String entityFieldAlias = getEntityFieldAlias(filterType, entityType);</b>
<b class="nc">&nbsp;                    if (entityPropertiesFunctions != null &amp;&amp; entityPropertiesFunctions.containsKey(entityFieldAlias)) {</b>
<b class="nc">&nbsp;                        return String.format(&quot;%s as %s&quot;, entityPropertiesFunctions.get(entityFieldAlias), getValueAlias());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return String.format(&quot;&#39;&#39; as %s&quot;, getValueAlias());</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        } else if (entityKey.getType().equals(EntityKeyType.TIME_SERIES)) {</b>
<b class="nc">&nbsp;            return buildTimeSeriesSelection();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return buildAttributeSelection();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String getEntityFieldAlias(EntityFilterType filterType, EntityType entityType) {
&nbsp;        String alias;
<b class="nc">&nbsp;        if (filterType.equals(EntityFilterType.RELATIONS_QUERY)) {</b>
<b class="nc">&nbsp;            alias = entityKey.getKey();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            alias = getAliasByEntityKeyAndType(entityKey.getKey(), entityType);</b>
&nbsp;        }
<b class="nc">&nbsp;        return alias;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Set&lt;String&gt; getExistingEntityFields(EntityFilterType filterType, EntityType entityType) {
&nbsp;        Set&lt;String&gt; existingEntityFields;
<b class="nc">&nbsp;        if (filterType.equals(EntityFilterType.RELATIONS_QUERY)) {</b>
<b class="nc">&nbsp;            existingEntityFields = relationQueryEntityFieldsSet;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            existingEntityFields = allowedEntityFieldMap.get(entityType);</b>
<b class="nc">&nbsp;            if (existingEntityFields == null) {</b>
<b class="nc">&nbsp;                existingEntityFields = commonEntityFieldsSet;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return existingEntityFields;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getAliasByEntityKeyAndType(String key, EntityType entityType) {
&nbsp;        String alias;
<b class="nc">&nbsp;        Map&lt;String, String&gt; entityAliases = aliases.get(entityType);</b>
<b class="nc">&nbsp;        if (entityAliases != null) {</b>
<b class="nc">&nbsp;            alias = entityAliases.get(key);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            alias = null;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (alias == null) {</b>
<b class="nc">&nbsp;            alias = key;</b>
&nbsp;        }
<b class="nc">&nbsp;        return alias;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Stream&lt;String&gt; toQueries(SqlQueryContext ctx, EntityFilterType filterType) {
<b class="nc">&nbsp;        if (hasFilter()) {</b>
<b class="nc">&nbsp;            String keyAlias = (entityKey.getType().equals(EntityKeyType.ENTITY_FIELD) &amp;&amp; getEntityKeyColumn() != null) ? &quot;e&quot; : alias;</b>
<b class="nc">&nbsp;            return keyFilters.stream().map(keyFilter -&gt;</b>
<b class="nc">&nbsp;                    this.buildKeyQuery(ctx, keyAlias, keyFilter, filterType));</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return Stream.empty();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String toLatestJoin(SqlQueryContext ctx, EntityFilter entityFilter, EntityType entityType) {
&nbsp;        String entityTypeStr;
<b class="nc">&nbsp;        if (entityFilter.getType().equals(EntityFilterType.RELATIONS_QUERY)) {</b>
<b class="nc">&nbsp;            entityTypeStr = &quot;entities.entity_type&quot;;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            entityTypeStr = &quot;&#39;&quot; + entityType.name() + &quot;&#39;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        ctx.addStringParameter(getKeyId(), entityKey.getKey());</b>
<b class="nc">&nbsp;        String filterQuery = toQueries(ctx, entityFilter.getType())</b>
<b class="nc">&nbsp;                .filter(StringUtils::isNotEmpty)</b>
<b class="nc">&nbsp;                .collect(Collectors.joining(&quot; and &quot;));</b>
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(filterQuery)) {</b>
<b class="nc">&nbsp;            filterQuery = &quot; AND (&quot; + filterQuery + &quot;)&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (entityKey.getType().equals(EntityKeyType.TIME_SERIES)) {</b>
<b class="nc">&nbsp;            String join = (hasFilter() &amp;&amp; hasFilterValues(ctx)) ? &quot;inner join&quot; : &quot;left join&quot;;</b>
<b class="nc">&nbsp;            return String.format(&quot;%s ts_kv_latest %s ON %s.entity_id=entities.id AND %s.key = (select key_id from key_dictionary where key = :%s_key_id) %s&quot;,</b>
&nbsp;                    join, alias, alias, alias, alias, filterQuery);
&nbsp;        } else {
&nbsp;            String query;
<b class="nc">&nbsp;            if (!entityKey.getType().equals(EntityKeyType.ATTRIBUTE)) {</b>
<b class="nc">&nbsp;                String join = (hasFilter() &amp;&amp; hasFilterValues(ctx)) ? &quot;inner join&quot; : &quot;left join&quot;;</b>
<b class="nc">&nbsp;                query = String.format(&quot;%s attribute_kv %s ON %s.entity_id=entities.id AND %s.attribute_key=(select key_id from key_dictionary where key = :%s_key_id) &quot;,</b>
&nbsp;                        join, alias, alias, alias, alias);
&nbsp;                int scope;
<b class="nc">&nbsp;                if (entityKey.getType().equals(EntityKeyType.CLIENT_ATTRIBUTE)) {</b>
<b class="nc">&nbsp;                    scope = AttributeScope.CLIENT_SCOPE.getId();</b>
<b class="nc">&nbsp;                } else if (entityKey.getType().equals(EntityKeyType.SHARED_ATTRIBUTE)) {</b>
<b class="nc">&nbsp;                    scope = AttributeScope.SHARED_SCOPE.getId(); ;</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    scope = AttributeScope.SERVER_SCOPE.getId(); ;</b>
&nbsp;                }
<b class="nc">&nbsp;                query = String.format(&quot;%s AND %s.attribute_type=%s %s&quot;, query, alias, scope, filterQuery);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                String join = (hasFilter() &amp;&amp; hasFilterValues(ctx)) ? &quot;join LATERAL&quot; : &quot;left join LATERAL&quot;;</b>
<b class="nc">&nbsp;                query = String.format(&quot;%s (select * from attribute_kv %s WHERE %s.entity_id=entities.id  AND %s.attribute_key=(select key_id from key_dictionary where key = :%s_key_id) %s &quot; +</b>
&nbsp;                                &quot;ORDER BY %s.last_update_ts DESC limit 1) as %s ON true&quot;,
&nbsp;                        join, alias, alias, alias, alias, filterQuery, alias, alias);
&nbsp;            }
<b class="nc">&nbsp;            return query;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean hasFilterValues(SqlQueryContext ctx) {
<b class="nc">&nbsp;        return Arrays.stream(ctx.getParameterNames()).anyMatch(parameterName -&gt; {</b>
<b class="nc">&nbsp;            return !parameterName.equals(getKeyId()) &amp;&amp; parameterName.startsWith(alias);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private String getKeyId() {
<b class="nc">&nbsp;        return alias + &quot;_key_id&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String buildSelections(List&lt;EntityKeyMapping&gt; mappings, EntityFilterType filterType, EntityType entityType) {
<b class="nc">&nbsp;        return mappings.stream().map(mapping -&gt; mapping.toSelection(filterType, entityType)).collect(</b>
<b class="nc">&nbsp;                Collectors.joining(&quot;, &quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String buildLatestJoins(SqlQueryContext ctx, EntityFilter entityFilter, EntityType entityType, List&lt;EntityKeyMapping&gt; latestMappings, boolean countQuery) {
<b class="nc">&nbsp;        return latestMappings.stream()</b>
<b class="nc">&nbsp;                .filter(mapping -&gt; !countQuery || mapping.hasFilter())</b>
<b class="nc">&nbsp;                .map(mapping -&gt; mapping.toLatestJoin(ctx, entityFilter, entityType))</b>
<b class="nc">&nbsp;                .collect(Collectors.joining(&quot; &quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    public static String buildQuery(SqlQueryContext ctx, List&lt;EntityKeyMapping&gt; mappings, EntityFilterType filterType) {
<b class="nc">&nbsp;        return mappings.stream()</b>
<b class="nc">&nbsp;                .flatMap(mapping -&gt; mapping.toQueries(ctx, filterType))</b>
<b class="nc">&nbsp;                .filter(StringUtils::isNotEmpty)</b>
<b class="nc">&nbsp;                .collect(Collectors.joining(&quot; AND &quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    public static List&lt;EntityKeyMapping&gt; prepareKeyMapping(EntityType entityType, EntityDataQuery query) {
<b class="nc">&nbsp;        EntityFilterType entityFilterType = query.getEntityFilter().getType();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;EntityKey&gt; entityFields = query.getEntityFields() != null ? query.getEntityFields() : Collections.emptyList();</b>
<b class="nc">&nbsp;        List&lt;EntityKey&gt; latestValues = query.getLatestValues() != null ? query.getLatestValues() : Collections.emptyList();</b>
&nbsp;        Map&lt;EntityKey, List&lt;KeyFilter&gt;&gt; filters =
<b class="nc">&nbsp;                query.getKeyFilters() != null ?</b>
<b class="nc">&nbsp;                        query.getKeyFilters().stream().collect(Collectors.groupingBy(KeyFilter::getKey)) : Collections.emptyMap();</b>
<b class="nc">&nbsp;        EntityDataSortOrder sortOrder = query.getPageLink().getSortOrder();</b>
<b class="nc">&nbsp;        EntityKey sortOrderKey = sortOrder != null ? sortOrder.getKey() : null;</b>
<b class="nc">&nbsp;        int index = 2;</b>
<b class="nc">&nbsp;        List&lt;EntityKeyMapping&gt; entityFieldsMappings = entityFields.stream().map(</b>
&nbsp;                key -&gt; {
<b class="nc">&nbsp;                    EntityKeyMapping mapping = new EntityKeyMapping();</b>
<b class="nc">&nbsp;                    mapping.setLatest(false);</b>
<b class="nc">&nbsp;                    mapping.setSelection(true);</b>
<b class="nc">&nbsp;                    mapping.setSearchable(!key.getKey().equals(ADDITIONAL_INFO));</b>
<b class="nc">&nbsp;                    mapping.setEntityKey(key);</b>
<b class="nc">&nbsp;                    mapping.setEntityKeyColumn(entityType, entityFilterType);</b>
<b class="nc">&nbsp;                    return mapping;</b>
&nbsp;                }
<b class="nc">&nbsp;        ).collect(Collectors.toList());</b>
<b class="nc">&nbsp;        List&lt;EntityKeyMapping&gt; latestMappings = latestValues.stream().map(</b>
&nbsp;                key -&gt; {
<b class="nc">&nbsp;                    EntityKeyMapping mapping = new EntityKeyMapping();</b>
<b class="nc">&nbsp;                    mapping.setLatest(true);</b>
<b class="nc">&nbsp;                    mapping.setSearchable(true);</b>
<b class="nc">&nbsp;                    mapping.setSelection(true);</b>
<b class="nc">&nbsp;                    mapping.setEntityKey(key);</b>
<b class="nc">&nbsp;                    return mapping;</b>
&nbsp;                }
<b class="nc">&nbsp;        ).collect(Collectors.toList());</b>
<b class="nc">&nbsp;        if (sortOrderKey != null) {</b>
&nbsp;            Optional&lt;EntityKeyMapping&gt; existing;
<b class="nc">&nbsp;            if (sortOrderKey.getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;                existing =</b>
<b class="nc">&nbsp;                        entityFieldsMappings.stream().filter(mapping -&gt; mapping.entityKey.equals(sortOrderKey)).findFirst();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                existing =</b>
<b class="nc">&nbsp;                        latestMappings.stream().filter(mapping -&gt; mapping.entityKey.equals(sortOrderKey)).findFirst();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (existing.isPresent()) {</b>
<b class="nc">&nbsp;                existing.get().setSortOrder(true);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                EntityKeyMapping sortOrderMapping = new EntityKeyMapping();</b>
<b class="nc">&nbsp;                sortOrderMapping.setLatest(!sortOrderKey.getType().equals(EntityKeyType.ENTITY_FIELD));</b>
<b class="nc">&nbsp;                sortOrderMapping.setSelection(true);</b>
<b class="nc">&nbsp;                sortOrderMapping.setEntityKey(sortOrderKey);</b>
<b class="nc">&nbsp;                sortOrderMapping.setSortOrder(true);</b>
<b class="nc">&nbsp;                sortOrderMapping.setIgnore(true);</b>
<b class="nc">&nbsp;                sortOrderMapping.setEntityKeyColumn(entityType, entityFilterType);</b>
<b class="nc">&nbsp;                if (sortOrderKey.getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;                    entityFieldsMappings.add(sortOrderMapping);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    latestMappings.add(sortOrderMapping);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        List&lt;EntityKeyMapping&gt; mappings = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        mappings.addAll(entityFieldsMappings);</b>
<b class="nc">&nbsp;        mappings.addAll(latestMappings);</b>
<b class="nc">&nbsp;        for (EntityKeyMapping mapping : mappings) {</b>
<b class="nc">&nbsp;            mapping.setIndex(index);</b>
<b class="nc">&nbsp;            mapping.setAlias(String.format(&quot;alias%s&quot;, index));</b>
<b class="nc">&nbsp;            mapping.setKeyFilters(filters.remove(mapping.entityKey));</b>
<b class="nc">&nbsp;            if (mapping.getEntityKey().getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;                index++;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                index += 2;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (!filters.isEmpty()) {</b>
<b class="nc">&nbsp;            for (EntityKey filterField : filters.keySet()) {</b>
<b class="nc">&nbsp;                EntityKeyMapping mapping = new EntityKeyMapping();</b>
<b class="nc">&nbsp;                mapping.setIndex(index);</b>
<b class="nc">&nbsp;                mapping.setAlias(String.format(&quot;alias%s&quot;, index));</b>
<b class="nc">&nbsp;                mapping.setKeyFilters(filters.get(filterField));</b>
<b class="nc">&nbsp;                mapping.setLatest(!filterField.getType().equals(EntityKeyType.ENTITY_FIELD));</b>
<b class="nc">&nbsp;                mapping.setEntityKey(filterField);</b>
<b class="nc">&nbsp;                mapping.setEntityKeyColumn(entityType, entityFilterType);</b>
<b class="nc">&nbsp;                mapping.setSelection(mapping.getEntityKeyColumn() == null);</b>
<b class="nc">&nbsp;                mappings.add(mapping);</b>
<b class="nc">&nbsp;                index += 1;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return mappings;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void setEntityKeyColumn(EntityType entityType, EntityFilterType entityFilterType) {
<b class="nc">&nbsp;        Set&lt;String&gt; existingEntityFields = getExistingEntityFields(entityFilterType, entityType);</b>
<b class="nc">&nbsp;        String entityFieldAlias = getEntityFieldAlias(entityFilterType, entityType);</b>
<b class="nc">&nbsp;        if (existingEntityFields.contains(entityFieldAlias)) {</b>
<b class="nc">&nbsp;            entityKeyColumn = entityFieldColumnMap.get(entityFieldAlias);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static List&lt;EntityKeyMapping&gt; prepareEntityCountKeyMapping(EntityCountQuery query) {
<b class="nc">&nbsp;        EntityType entityType = resolveEntityType(query.getEntityFilter());</b>
<b class="nc">&nbsp;        EntityFilterType entityFilterType = query.getEntityFilter().getType();</b>
&nbsp;
&nbsp;        Map&lt;EntityKey, List&lt;KeyFilter&gt;&gt; filters =
<b class="nc">&nbsp;                query.getKeyFilters() != null ?</b>
<b class="nc">&nbsp;                        query.getKeyFilters().stream().collect(Collectors.groupingBy(KeyFilter::getKey)) : Collections.emptyMap();</b>
<b class="nc">&nbsp;        int index = 2;</b>
<b class="nc">&nbsp;        List&lt;EntityKeyMapping&gt; mappings = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (!filters.isEmpty()) {</b>
<b class="nc">&nbsp;            for (EntityKey filterField : filters.keySet()) {</b>
<b class="nc">&nbsp;                EntityKeyMapping mapping = new EntityKeyMapping();</b>
<b class="nc">&nbsp;                mapping.setIndex(index);</b>
<b class="nc">&nbsp;                mapping.setAlias(String.format(&quot;alias%s&quot;, index));</b>
<b class="nc">&nbsp;                mapping.setKeyFilters(filters.get(filterField));</b>
<b class="nc">&nbsp;                mapping.setLatest(!filterField.getType().equals(EntityKeyType.ENTITY_FIELD));</b>
<b class="nc">&nbsp;                mapping.setEntityKey(filterField);</b>
<b class="nc">&nbsp;                mapping.setEntityKeyColumn(entityType, entityFilterType);</b>
<b class="nc">&nbsp;                mapping.setSelection(mapping.getEntityKeyColumn() == null);</b>
<b class="nc">&nbsp;                mappings.add(mapping);</b>
<b class="nc">&nbsp;                index += 1;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return mappings;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private String buildAttributeSelection() {
<b class="nc">&nbsp;        return buildTimeSeriesOrAttrSelection(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildTimeSeriesSelection() {
<b class="nc">&nbsp;        return buildTimeSeriesOrAttrSelection(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildTimeSeriesOrAttrSelection(boolean attr) {
<b class="nc">&nbsp;        String attrValAlias = getValueAlias();</b>
<b class="nc">&nbsp;        String attrTsAlias = getTsAlias();</b>
<b class="nc">&nbsp;        String attrValSelection =</b>
<b class="nc">&nbsp;                String.format(&quot;(coalesce(cast(%s.bool_v as varchar), &#39;&#39;) || &quot; +</b>
&nbsp;                        &quot;coalesce(%s.str_v, &#39;&#39;) || &quot; +
&nbsp;                        &quot;coalesce(cast(%s.long_v as varchar), &#39;&#39;) || &quot; +
&nbsp;                        &quot;coalesce(cast(%s.dbl_v as varchar), &#39;&#39;) || &quot; +
&nbsp;                        &quot;coalesce(cast(%s.json_v as varchar), &#39;&#39;)) as %s&quot;, alias, alias, alias, alias, alias, attrValAlias);
<b class="nc">&nbsp;        String attrTsSelection = String.format(&quot;%s.%s as %s&quot;, alias, attr ? &quot;last_update_ts&quot; : &quot;ts&quot;, attrTsAlias);</b>
<b class="nc">&nbsp;        if (this.isSortOrder) {</b>
<b class="nc">&nbsp;            String attrNumAlias = getSortOrderNumAlias();</b>
<b class="nc">&nbsp;            String attrVarcharAlias = getSortOrderStrAlias();</b>
<b class="nc">&nbsp;            String attrSortOrderSelection =</b>
<b class="nc">&nbsp;                    String.format(&quot;coalesce(%s.dbl_v, cast(%s.long_v as double precision), (case when %s.bool_v then 1 else 0 end)) %s,&quot; +</b>
&nbsp;                            &quot;coalesce(%s.str_v, cast(%s.json_v as varchar), &#39;&#39;) %s&quot;, alias, alias, alias, attrNumAlias, alias, alias, attrVarcharAlias);
<b class="nc">&nbsp;            return String.join(&quot;, &quot;, attrValSelection, attrTsSelection, attrSortOrderSelection);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return String.join(&quot;, &quot;, attrValSelection, attrTsSelection);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String getSortOrderStrAlias() {
<b class="nc">&nbsp;        return getValueAlias() + &quot;_so_varchar&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getSortOrderNumAlias() {
<b class="nc">&nbsp;        return getValueAlias() + &quot;_so_num&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildKeyQuery(SqlQueryContext ctx, String alias, KeyFilter keyFilter,
&nbsp;                                 EntityFilterType filterType) {
<b class="nc">&nbsp;        return this.buildPredicateQuery(ctx, alias, keyFilter.getKey(), keyFilter.getPredicate(), filterType);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildPredicateQuery(SqlQueryContext ctx, String alias, EntityKey key,
&nbsp;                                       KeyFilterPredicate predicate, EntityFilterType filterType) {
<b class="nc">&nbsp;        if (predicate.getType().equals(FilterPredicateType.COMPLEX)) {</b>
<b class="nc">&nbsp;            return this.buildComplexPredicateQuery(ctx, alias, key, (ComplexFilterPredicate) predicate, filterType);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return this.buildSimplePredicateQuery(ctx, alias, key, predicate, filterType);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String buildComplexPredicateQuery(SqlQueryContext ctx, String alias, EntityKey key,
&nbsp;                                              ComplexFilterPredicate predicate, EntityFilterType filterType) {
<b class="nc">&nbsp;        String result = predicate.getPredicates().stream()</b>
<b class="nc">&nbsp;                .map(keyFilterPredicate -&gt; this.buildPredicateQuery(ctx, alias, key, keyFilterPredicate, filterType))</b>
<b class="nc">&nbsp;                .filter(StringUtils::isNotEmpty)</b>
<b class="nc">&nbsp;                .collect(Collectors.joining(&quot; &quot; + predicate.getOperation().name() + &quot; &quot;));</b>
<b class="nc">&nbsp;        if (!result.trim().isEmpty()) {</b>
<b class="nc">&nbsp;            result = &quot;( &quot; + result + &quot; )&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildSimplePredicateQuery(SqlQueryContext ctx, String alias, EntityKey key,
&nbsp;                                             KeyFilterPredicate predicate, EntityFilterType filterType) {
<b class="nc">&nbsp;        if (key.getType().equals(EntityKeyType.ENTITY_FIELD)) {</b>
<b class="nc">&nbsp;            String field = (getEntityKeyColumn() != null) ? alias + &quot;.&quot; + getEntityKeyColumn() : alias;</b>
<b class="nc">&nbsp;            if (predicate.getType().equals(FilterPredicateType.NUMERIC)) {</b>
<b class="nc">&nbsp;                return this.buildNumericPredicateQuery(ctx, field, (NumericFilterPredicate) predicate);</b>
<b class="nc">&nbsp;            } else if (predicate.getType().equals(FilterPredicateType.STRING)) {</b>
<b class="nc">&nbsp;                if (key.getKey().equals(&quot;entityType&quot;) &amp;&amp; !filterType.equals(EntityFilterType.RELATIONS_QUERY)) {</b>
<b class="nc">&nbsp;                    field = ctx.getEntityType().toString();</b>
<b class="nc">&nbsp;                    return this.buildStringPredicateQuery(ctx, field, (StringFilterPredicate) predicate)</b>
<b class="nc">&nbsp;                            .replace(&quot;lower(&quot; + field, &quot;lower(&#39;&quot; + field + &quot;&#39;&quot;)</b>
<b class="nc">&nbsp;                            .replace(field + &quot; &quot;, &quot;&#39;&quot; + field + &quot;&#39; &quot;);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return this.buildStringPredicateQuery(ctx, field, (StringFilterPredicate) predicate);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                return this.buildBooleanPredicateQuery(ctx, field, (BooleanFilterPredicate) predicate);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            if (predicate.getType().equals(FilterPredicateType.NUMERIC)) {</b>
<b class="nc">&nbsp;                String longQuery = this.buildNumericPredicateQuery(ctx, alias + &quot;.long_v&quot;, (NumericFilterPredicate) predicate);</b>
<b class="nc">&nbsp;                String doubleQuery = this.buildNumericPredicateQuery(ctx, alias + &quot;.dbl_v&quot;, (NumericFilterPredicate) predicate);</b>
<b class="nc">&nbsp;                return String.format(&quot;(%s or %s)&quot;, longQuery, doubleQuery);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                String column = predicate.getType().equals(FilterPredicateType.STRING) ? &quot;str_v&quot; : &quot;bool_v&quot;;</b>
<b class="nc">&nbsp;                String field = alias + &quot;.&quot; + column;</b>
<b class="nc">&nbsp;                if (predicate.getType().equals(FilterPredicateType.STRING)) {</b>
<b class="nc">&nbsp;                    return this.buildStringPredicateQuery(ctx, field, (StringFilterPredicate) predicate);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    return this.buildBooleanPredicateQuery(ctx, field, (BooleanFilterPredicate) predicate);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String buildStringPredicateQuery(SqlQueryContext ctx, String field, StringFilterPredicate stringFilterPredicate) {
<b class="nc">&nbsp;        String operationField = field;</b>
<b class="nc">&nbsp;        String paramName = getNextParameterName(field);</b>
<b class="nc">&nbsp;        String value = stringFilterPredicate.getValue().getValue();</b>
<b class="nc">&nbsp;        if (value.isEmpty()) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        String stringOperationQuery = &quot;&quot;;</b>
<b class="nc">&nbsp;        if (stringFilterPredicate.isIgnoreCase()) {</b>
<b class="nc">&nbsp;            value = value.toLowerCase();</b>
<b class="nc">&nbsp;            operationField = String.format(&quot;lower(%s)&quot;, operationField);</b>
&nbsp;        }
<b class="nc">&nbsp;        switch (stringFilterPredicate.getOperation()) {</b>
&nbsp;            case EQUAL:
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s = :%s)&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;            case NOT_EQUAL:
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s != :%s or %s is null)&quot;, operationField, paramName, operationField);</b>
&nbsp;                break;
&nbsp;            case STARTS_WITH:
<b class="nc">&nbsp;                value += &quot;%&quot;;</b>
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s like :%s)&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;            case ENDS_WITH:
<b class="nc">&nbsp;                value = &quot;%&quot; + value;</b>
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s like :%s)&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;            case CONTAINS:
<b class="nc">&nbsp;                value = &quot;%&quot; + value + &quot;%&quot;;</b>
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s like :%s)&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;            case NOT_CONTAINS:
<b class="nc">&nbsp;                value = &quot;%&quot; + value + &quot;%&quot;;</b>
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s not like :%s or %s is null)&quot;, operationField, paramName, operationField);</b>
&nbsp;                break;
&nbsp;            case IN:
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s in (:%s))&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;            case NOT_IN:
<b class="nc">&nbsp;                stringOperationQuery = String.format(&quot;%s not in (:%s))&quot;, operationField, paramName);</b>
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        switch (stringFilterPredicate.getOperation()) {</b>
&nbsp;            case IN:
&nbsp;            case NOT_IN:
<b class="nc">&nbsp;                ctx.addStringListParameter(paramName, splitByCommaWithoutQuotes(value));</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                ctx.addStringParameter(paramName, value);</b>
&nbsp;        }
<b class="nc">&nbsp;        return String.format(&quot;((%s is not null and %s)&quot;, field, stringOperationQuery);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildNumericPredicateQuery(SqlQueryContext ctx, String field, NumericFilterPredicate numericFilterPredicate) {
<b class="nc">&nbsp;        String paramName = getNextParameterName(field);</b>
<b class="nc">&nbsp;        ctx.addDoubleParameter(paramName, numericFilterPredicate.getValue().getValue());</b>
<b class="nc">&nbsp;        String numericOperationQuery = &quot;&quot;;</b>
<b class="nc">&nbsp;        switch (numericFilterPredicate.getOperation()) {</b>
&nbsp;            case EQUAL:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s = :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case NOT_EQUAL:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s != :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case GREATER:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s &gt; :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case GREATER_OR_EQUAL:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s &gt;= :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case LESS:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s &lt; :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case LESS_OR_EQUAL:
<b class="nc">&nbsp;                numericOperationQuery = String.format(&quot;%s &lt;= :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return String.format(&quot;(%s is not null and %s)&quot;, field, numericOperationQuery);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String buildBooleanPredicateQuery(SqlQueryContext ctx, String field,
&nbsp;                                              BooleanFilterPredicate booleanFilterPredicate) {
<b class="nc">&nbsp;        String paramName = getNextParameterName(field);</b>
<b class="nc">&nbsp;        ctx.addBooleanParameter(paramName, booleanFilterPredicate.getValue().getValue());</b>
<b class="nc">&nbsp;        String booleanOperationQuery = &quot;&quot;;</b>
<b class="nc">&nbsp;        switch (booleanFilterPredicate.getOperation()) {</b>
&nbsp;            case EQUAL:
<b class="nc">&nbsp;                booleanOperationQuery = String.format(&quot;%s = :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;            case NOT_EQUAL:
<b class="nc">&nbsp;                booleanOperationQuery = String.format(&quot;%s != :%s&quot;, field, paramName);</b>
&nbsp;                break;
&nbsp;        }
<b class="nc">&nbsp;        return String.format(&quot;(%s is not null and %s)&quot;, field, booleanOperationQuery);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getNextParameterName(String field) {
<b class="nc">&nbsp;        paramIdx++;</b>
<b class="nc">&nbsp;        return field.replace(&quot;.&quot;, &quot;_&quot;) + &quot;_&quot; + paramIdx;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

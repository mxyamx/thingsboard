<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RepositoryUtils</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.edqs.util</a>
</div>

<h1>Coverage Summary for Class: RepositoryUtils (org.thingsboard.server.edqs.util)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RepositoryUtils</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/188)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/183)
  </span>
</td>
</tr>
  <tr>
    <td class="name">RepositoryUtils$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">RepositoryUtils$SimpleKeyFilter</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/188)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/190)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.edqs.util;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.edqs.DataPoint;
&nbsp;import org.thingsboard.server.common.data.permission.QueryContext;
&nbsp;import org.thingsboard.server.common.data.query.BooleanFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.ComplexFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.EntityCountQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataQuery;
&nbsp;import org.thingsboard.server.common.data.query.EntityDataSortOrder;
&nbsp;import org.thingsboard.server.common.data.query.EntityFilter;
&nbsp;import org.thingsboard.server.common.data.query.EntityKey;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyType;
&nbsp;import org.thingsboard.server.common.data.query.EntityKeyValueType;
&nbsp;import org.thingsboard.server.common.data.query.EntityListFilter;
&nbsp;import org.thingsboard.server.common.data.query.EntityNameFilter;
&nbsp;import org.thingsboard.server.common.data.query.EntityTypeFilter;
&nbsp;import org.thingsboard.server.common.data.query.FilterPredicateType;
&nbsp;import org.thingsboard.server.common.data.query.KeyFilter;
&nbsp;import org.thingsboard.server.common.data.query.KeyFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.NumericFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.RelationsQueryFilter;
&nbsp;import org.thingsboard.server.common.data.query.SingleEntityFilter;
&nbsp;import org.thingsboard.server.common.data.query.StringFilterPredicate;
&nbsp;import org.thingsboard.server.common.data.query.TsValue;
&nbsp;import org.thingsboard.server.common.data.util.CollectionsUtil;
&nbsp;import org.thingsboard.server.edqs.data.EntityData;
&nbsp;import org.thingsboard.server.edqs.query.DataKey;
&nbsp;import org.thingsboard.server.edqs.query.EdqsCountQuery;
&nbsp;import org.thingsboard.server.edqs.query.EdqsDataQuery;
&nbsp;import org.thingsboard.server.edqs.query.EdqsFilter;
&nbsp;import org.thingsboard.server.edqs.query.EdqsQuery;
&nbsp;import org.thingsboard.server.edqs.query.SortableEntityData;
&nbsp;import org.thingsboard.server.edqs.repo.KeyDictionary;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.regex.Pattern;
&nbsp;import java.util.stream.Stream;
&nbsp;
&nbsp;import static org.apache.commons.lang3.StringUtils.containsIgnoreCase;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.equalsAny;
&nbsp;import static org.thingsboard.server.common.data.StringUtils.splitByCommaWithoutQuotes;
&nbsp;import static org.thingsboard.server.common.data.query.ComplexFilterPredicate.ComplexOperation.AND;
&nbsp;import static org.thingsboard.server.common.data.query.ComplexFilterPredicate.ComplexOperation.OR;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class RepositoryUtils {</b>
&nbsp;
<b class="nc">&nbsp;    public static final Comparator&lt;SortableEntityData&gt; SORT_ASC = Comparator.comparing(SortableEntityData::getSortValue, Comparator.nullsFirst(Comparator.naturalOrder()))</b>
<b class="nc">&nbsp;            .thenComparing(sp -&gt; sp.getId().toString());</b>
&nbsp;
<b class="nc">&nbsp;    public static final Comparator&lt;SortableEntityData&gt; SORT_DESC =  Comparator.comparing(SortableEntityData::getSortValue, Comparator.nullsFirst(Comparator.naturalOrder()))</b>
<b class="nc">&nbsp;            .thenComparing(sp -&gt; sp.getId().toString()).reversed();</b>
&nbsp;
&nbsp;    public static EntityType resolveEntityType(EntityFilter entityFilter) {
<b class="nc">&nbsp;        return switch (entityFilter.getType()) {</b>
<b class="nc">&nbsp;            case SINGLE_ENTITY -&gt; ((SingleEntityFilter) entityFilter).getSingleEntity().getEntityType();</b>
<b class="nc">&nbsp;            case ENTITY_LIST -&gt; ((EntityListFilter) entityFilter).getEntityType();</b>
<b class="nc">&nbsp;            case ENTITY_NAME -&gt; ((EntityNameFilter) entityFilter).getEntityType();</b>
<b class="nc">&nbsp;            case ENTITY_TYPE -&gt; ((EntityTypeFilter) entityFilter).getEntityType();</b>
<b class="nc">&nbsp;            case ASSET_TYPE, ASSET_SEARCH_QUERY -&gt; EntityType.ASSET;</b>
<b class="nc">&nbsp;            case DEVICE_TYPE, DEVICE_SEARCH_QUERY -&gt; EntityType.DEVICE;</b>
<b class="nc">&nbsp;            case ENTITY_VIEW_TYPE, ENTITY_VIEW_SEARCH_QUERY -&gt; EntityType.ENTITY_VIEW;</b>
<b class="nc">&nbsp;            case EDGE_TYPE, EDGE_SEARCH_QUERY -&gt; EntityType.EDGE;</b>
&nbsp;            case RELATIONS_QUERY -&gt; {
<b class="nc">&nbsp;                RelationsQueryFilter rgf = (RelationsQueryFilter) entityFilter;</b>
<b class="nc">&nbsp;                yield rgf.isMultiRoot() ? rgf.getMultiRootEntitiesType() : rgf.getRootEntity().getEntityType();</b>
&nbsp;            }
<b class="nc">&nbsp;            case API_USAGE_STATE -&gt; EntityType.API_USAGE_STATE;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static boolean customerUserIsTryingToAccessTenantEntity(QueryContext ctx, EntityFilter entityFilter) {
<b class="nc">&nbsp;        if (ctx.isTenantUser()) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return switch (entityFilter.getType()) {</b>
&nbsp;                case SINGLE_ENTITY -&gt; {
<b class="nc">&nbsp;                    SingleEntityFilter seFilter = (SingleEntityFilter) entityFilter;</b>
<b class="nc">&nbsp;                    yield isSystemOrTenantEntity(seFilter.getSingleEntity().getEntityType());</b>
&nbsp;                }
&nbsp;                case ENTITY_LIST -&gt; {
<b class="nc">&nbsp;                    EntityListFilter elFilter = (EntityListFilter) entityFilter;</b>
<b class="nc">&nbsp;                    yield isSystemOrTenantEntity(elFilter.getEntityType());</b>
&nbsp;                }
&nbsp;                case ENTITY_NAME -&gt; {
<b class="nc">&nbsp;                    EntityNameFilter enFilter = (EntityNameFilter) entityFilter;</b>
<b class="nc">&nbsp;                    yield isSystemOrTenantEntity(enFilter.getEntityType());</b>
&nbsp;                }
&nbsp;                case ENTITY_TYPE -&gt; {
<b class="nc">&nbsp;                    EntityTypeFilter etFilter = (EntityTypeFilter) entityFilter;</b>
<b class="nc">&nbsp;                    yield isSystemOrTenantEntity(etFilter.getEntityType());</b>
&nbsp;                }
<b class="nc">&nbsp;                default -&gt; false;</b>
&nbsp;            };
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static boolean isSystemOrTenantEntity(EntityType entityType) {
<b class="nc">&nbsp;        return switch (entityType) {</b>
&nbsp;            case DEVICE_PROFILE, ASSET_PROFILE, RULE_CHAIN, TENANT,
<b class="nc">&nbsp;                    TENANT_PROFILE, WIDGET_TYPE, WIDGETS_BUNDLE -&gt; true;</b>
<b class="nc">&nbsp;            default -&gt; false;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static EdqsDataQuery toNewQuery(EntityDataQuery oldQuery) {
<b class="nc">&nbsp;        var query = EdqsDataQuery.builder();</b>
<b class="nc">&nbsp;        query.page(oldQuery.getPageLink().getPage());</b>
<b class="nc">&nbsp;        query.pageSize(oldQuery.getPageLink().getPageSize());</b>
<b class="nc">&nbsp;        query.textSearch(oldQuery.getPageLink().getTextSearch());</b>
<b class="nc">&nbsp;        var sortOrder = oldQuery.getPageLink().getSortOrder();</b>
<b class="nc">&nbsp;        if (sortOrder != null &amp;&amp; toNewKey(sortOrder.getKey()) != null) {</b>
<b class="nc">&nbsp;            query.sortKey(toNewKey(sortOrder.getKey()));</b>
<b class="nc">&nbsp;            query.sortDirection(sortOrder.getDirection());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            query.sortKey(new DataKey(EntityKeyType.ENTITY_FIELD, &quot;createdTime&quot;, null));</b>
<b class="nc">&nbsp;            query.sortDirection(EntityDataSortOrder.Direction.DESC);</b>
&nbsp;        }
<b class="nc">&nbsp;        query.entityFilter(oldQuery.getEntityFilter());</b>
<b class="nc">&nbsp;        query.keyFilters(toKeyFilters(oldQuery.getKeyFilters()));</b>
<b class="nc">&nbsp;        query.entityFields(toNewKeys(oldQuery.getEntityFields()));</b>
<b class="nc">&nbsp;        query.latestValues(toNewKeys(oldQuery.getLatestValues()));</b>
<b class="nc">&nbsp;        return query.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    public static EdqsCountQuery toNewQuery(EntityCountQuery oldQuery) {
<b class="nc">&nbsp;        return EdqsCountQuery.builder()</b>
<b class="nc">&nbsp;                .entityFilter(oldQuery.getEntityFilter())</b>
<b class="nc">&nbsp;                .hasKeyFilters(CollectionsUtil.isNotEmpty(oldQuery.getKeyFilters()))</b>
<b class="nc">&nbsp;                .keyFilters(toKeyFilters(oldQuery.getKeyFilters()))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private static List&lt;EdqsFilter&gt; toKeyFilters(List&lt;KeyFilter&gt; keyFilters) {
<b class="nc">&nbsp;        if (keyFilters == null || keyFilters.isEmpty()) {</b>
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            List&lt;EdqsFilter&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (KeyFilter entityFilter : keyFilters) {</b>
<b class="nc">&nbsp;                var newKey = toNewKey(entityFilter.getKey());</b>
<b class="nc">&nbsp;                if (newKey != null) {</b>
<b class="nc">&nbsp;                    result.add(new EdqsFilter(newKey, entityFilter.getValueType(), entityFilter.getPredicate()));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static DataKey toNewKey(EntityKey entityKey) {
<b class="nc">&nbsp;        if (EntityKeyType.ENTITY_FIELD.equals(entityKey.getType())) {</b>
<b class="nc">&nbsp;            return new DataKey(entityKey.getType(), entityKey.getKey(), null);</b>
&nbsp;        }
<b class="nc">&nbsp;        Integer keyId = KeyDictionary.get(entityKey.getKey());</b>
<b class="nc">&nbsp;        if (keyId != null) {</b>
<b class="nc">&nbsp;            return new DataKey(entityKey.getType(), entityKey.getKey(), keyId);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;Missing dictionary key for {}&quot;, entityKey.getKey());</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static List&lt;DataKey&gt; toNewKeys(List&lt;EntityKey&gt; entityKeys) {
<b class="nc">&nbsp;        if (entityKeys == null || entityKeys.isEmpty()) {</b>
<b class="nc">&nbsp;            return Collections.emptyList();</b>
&nbsp;        } else {
<b class="nc">&nbsp;            var result = new ArrayList&lt;DataKey&gt;(entityKeys.size());</b>
<b class="nc">&nbsp;            for (EntityKey entityKey : entityKeys) {</b>
<b class="nc">&nbsp;                var newKey = toNewKey(entityKey);</b>
<b class="nc">&nbsp;                if (newKey != null) {</b>
<b class="nc">&nbsp;                    result.add(newKey);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return result;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static boolean checkKeyFilters(EntityData entity, List&lt;EdqsFilter&gt; keyFilters) {
<b class="nc">&nbsp;        for (EdqsFilter keyFilter : keyFilters) {</b>
<b class="nc">&nbsp;            EntityKeyValueType valueType = keyFilter.valueType();</b>
<b class="nc">&nbsp;            if (valueType == null) {</b>
<b class="nc">&nbsp;                valueType = switch (keyFilter.predicate().getType()) {</b>
<b class="nc">&nbsp;                    case STRING -&gt; EntityKeyValueType.STRING;</b>
<b class="nc">&nbsp;                    case NUMERIC -&gt; EntityKeyValueType.NUMERIC;</b>
<b class="nc">&nbsp;                    case BOOLEAN -&gt; EntityKeyValueType.BOOLEAN;</b>
<b class="nc">&nbsp;                    default -&gt; throw new IllegalStateException();</b>
&nbsp;                };
&nbsp;            }
<b class="nc">&nbsp;            DataKey dataKey = keyFilter.key();</b>
<b class="nc">&nbsp;            DataPoint dp = entity.getDataPoint(dataKey, null);</b>
<b class="nc">&nbsp;            boolean checkResult = switch (valueType) {</b>
&nbsp;                case STRING -&gt; {
<b class="nc">&nbsp;                    String str = dp != null ? dp.valueToString() : null;</b>
<b class="nc">&nbsp;                    yield (dataKey.type() == EntityKeyType.ENTITY_FIELD) ? (str == null || checkKeyFilter(str, keyFilter.predicate())) :</b>
<b class="nc">&nbsp;                            (str != null &amp;&amp; checkKeyFilter(str, keyFilter.predicate()));</b>
&nbsp;                }
&nbsp;                case BOOLEAN -&gt; {
<b class="nc">&nbsp;                    Boolean booleanValue = dp != null ? dp.getBool() : null;</b>
<b class="nc">&nbsp;                    yield booleanValue != null &amp;&amp; checkKeyFilter(booleanValue, keyFilter.predicate());</b>
&nbsp;                }
&nbsp;                case DATE_TIME, NUMERIC -&gt; {
<b class="nc">&nbsp;                    Double doubleValue = dp != null ? dp.getDouble() : null;</b>
<b class="nc">&nbsp;                    yield doubleValue != null &amp;&amp; checkKeyFilter(doubleValue, keyFilter.predicate());</b>
&nbsp;                }
&nbsp;            };
<b class="nc">&nbsp;            if (!checkResult) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public static boolean checkKeyFilter(String value, KeyFilterPredicate keyFilterPredicate) {
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() == FilterPredicateType.COMPLEX) {</b>
<b class="nc">&nbsp;            return checkComplexKeyFilter(value, (ComplexFilterPredicate) keyFilterPredicate, RepositoryUtils::checkKeyFilter);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() != FilterPredicateType.STRING) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Not implemented&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        StringFilterPredicate predicate = (StringFilterPredicate) keyFilterPredicate;</b>
<b class="nc">&nbsp;        String predicateValue = predicate.getValue().getValue();</b>
<b class="nc">&nbsp;        if (StringUtils.isEmpty(predicateValue)) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (predicate.isIgnoreCase()) {</b>
<b class="nc">&nbsp;            predicateValue = predicateValue.toLowerCase();</b>
<b class="nc">&nbsp;            value = value.toLowerCase();</b>
&nbsp;        }
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case STARTS_WITH -&gt; toSqlLikePattern(predicateValue, &quot;^&quot;, &quot;.*&quot;).matcher(value).matches();</b>
<b class="nc">&nbsp;            case ENDS_WITH -&gt; toSqlLikePattern(predicateValue, &quot;.*&quot;, &quot;$&quot;).matcher(value).matches();</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case CONTAINS -&gt; toSqlLikePattern(predicateValue, &quot;.*&quot;, &quot;.*&quot;).matcher(value).matches();</b>
<b class="nc">&nbsp;            case NOT_CONTAINS -&gt; !toSqlLikePattern(predicateValue, &quot;.*&quot;, &quot;.*&quot;).matcher(value).matches();</b>
<b class="nc">&nbsp;            case IN -&gt; equalsAny(value, splitByCommaWithoutQuotes(predicateValue));</b>
<b class="nc">&nbsp;            case NOT_IN -&gt; !equalsAny(value, splitByCommaWithoutQuotes(predicateValue));</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static boolean checkKeyFilter(Double value, KeyFilterPredicate keyFilterPredicate) {
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() == FilterPredicateType.COMPLEX) {</b>
<b class="nc">&nbsp;            return checkComplexKeyFilter(value, (ComplexFilterPredicate) keyFilterPredicate, RepositoryUtils::checkKeyFilter);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() != FilterPredicateType.NUMERIC) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Not implemented&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        NumericFilterPredicate predicate = (NumericFilterPredicate) keyFilterPredicate;</b>
<b class="nc">&nbsp;        Double predicateValue = predicate.getValue().getValue();</b>
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case GREATER -&gt; value.compareTo(predicateValue) &gt; 0;</b>
<b class="nc">&nbsp;            case LESS -&gt; value.compareTo(predicateValue) &lt; 0;</b>
<b class="nc">&nbsp;            case GREATER_OR_EQUAL -&gt; value.compareTo(predicateValue) &gt;= 0;</b>
<b class="nc">&nbsp;            case LESS_OR_EQUAL -&gt; value.compareTo(predicateValue) &lt;= 0;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static boolean checkKeyFilter(Boolean value, KeyFilterPredicate keyFilterPredicate) {
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() == FilterPredicateType.COMPLEX) {</b>
<b class="nc">&nbsp;            return checkComplexKeyFilter(value, (ComplexFilterPredicate) keyFilterPredicate, RepositoryUtils::checkKeyFilter);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (keyFilterPredicate.getType() != FilterPredicateType.BOOLEAN) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Not implemented&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        BooleanFilterPredicate predicate = (BooleanFilterPredicate) keyFilterPredicate;</b>
<b class="nc">&nbsp;        Boolean predicateValue = predicate.getValue().getValue();</b>
<b class="nc">&nbsp;        return switch (predicate.getOperation()) {</b>
<b class="nc">&nbsp;            case EQUAL -&gt; value.equals(predicateValue);</b>
<b class="nc">&nbsp;            case NOT_EQUAL -&gt; !value.equals(predicateValue);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    public static &lt;T&gt; boolean checkComplexKeyFilter(T value, ComplexFilterPredicate filterPredicates,
&nbsp;                                                    SimpleKeyFilter&lt;T&gt; simpleKeyFilter) {
<b class="nc">&nbsp;        if (filterPredicates.getOperation() == AND) {</b>
<b class="nc">&nbsp;            for (KeyFilterPredicate filterPredicate : filterPredicates.getPredicates()) {</b>
<b class="nc">&nbsp;                if (!simpleKeyFilter.check(value, filterPredicate)) {</b>
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (filterPredicates.getOperation() == OR) {</b>
<b class="nc">&nbsp;            for (KeyFilterPredicate filterPredicate : filterPredicates.getPredicates()) {</b>
&nbsp;
&nbsp;                // Emulate the SQL-like behavior of ThingsBoard&#39;s Entity Data Query service:
&nbsp;                // for COMPLEX filters, return no results if filter value is empty
<b class="nc">&nbsp;                if (filterPredicate instanceof StringFilterPredicate stringFilterPredicate) {</b>
<b class="nc">&nbsp;                    if (StringUtils.isEmpty(stringFilterPredicate.getValue().getValue())) {</b>
&nbsp;                        continue;
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (simpleKeyFilter.check(value, filterPredicate)) {</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return false;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static Pattern toEntityNameSqlLikePattern(String filter) {
<b class="nc">&nbsp;        if (StringUtils.isNotBlank(filter)) {</b>
<b class="nc">&nbsp;            return toSqlLikePattern(filter, &quot;&quot;, &quot;.*&quot;, true);</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Pattern toSqlLikePattern(String value, String prefix, String suffix) {
<b class="nc">&nbsp;        return toSqlLikePattern(value, prefix, suffix, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static Pattern toSqlLikePattern(String value, String prefix, String suffix, boolean ignoreCase) {
&nbsp;        String regexValue;
<b class="nc">&nbsp;        if (value.contains(&quot;%&quot;) || value.contains(&quot;_&quot;)) {</b>
<b class="nc">&nbsp;            regexValue = value</b>
<b class="nc">&nbsp;                    .replace(&quot;_&quot;, &quot;.&quot;)</b>
<b class="nc">&nbsp;                    .replace(&quot;%&quot;, &quot;.*&quot;);</b>
<b class="nc">&nbsp;            if (&quot;^&quot;.equals(prefix)) {</b>
<b class="nc">&nbsp;                regexValue = &quot;^&quot; + regexValue + (regexValue.endsWith(&quot;.*&quot;) ? &quot;&quot; : &quot;.*&quot;);</b>
<b class="nc">&nbsp;            } else if (&quot;$&quot;.equals(suffix)) {</b>
<b class="nc">&nbsp;                regexValue = (regexValue.startsWith(&quot;.*&quot;) ? &quot;&quot; : &quot;.*&quot;) + regexValue + &quot;$&quot;;</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            regexValue = prefix + Pattern.quote(value) + suffix;</b>
&nbsp;        }
<b class="nc">&nbsp;        return ignoreCase ? Pattern.compile(regexValue, Pattern.CASE_INSENSITIVE) : Pattern.compile(regexValue);</b>
&nbsp;    }
&nbsp;
&nbsp;    @FunctionalInterface
&nbsp;    public interface SimpleKeyFilter&lt;T&gt; {
&nbsp;
&nbsp;        boolean check(T value, KeyFilterPredicate predicate);
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    public static TsValue toTsValue(long ts, DataPoint dp) {
<b class="nc">&nbsp;        if (dp != null) {</b>
<b class="nc">&nbsp;            return new TsValue(dp.getTs() &gt; 0 ? dp.getTs() : ts, dp.valueToString());</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return TsValue.EMPTY;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public static DataPoint getSortValue(EntityData entity, DataKey sortKey, QueryContext queryContext) {
<b class="nc">&nbsp;        if (sortKey == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="nc">&nbsp;       return entity.getDataPoint(sortKey, queryContext);</b>
&nbsp;    }
&nbsp;
&nbsp;    public static boolean checkFilters(EdqsQuery query, EntityData entity) {
<b class="nc">&nbsp;        if (entity == null || entity.getFields() == null) {</b>
<b class="nc">&nbsp;            return false; // Entity was already removed or not arrived yet;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (query.isHasKeyFilters() &amp;&amp; !checkKeyFilters(entity, query.getKeyFilters())) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (query instanceof EdqsDataQuery dataQuery) {</b>
<b class="nc">&nbsp;            return !dataQuery.isHasTextSearch() || checkTextSearch(entity, dataQuery);</b>
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean checkTextSearch(EntityData entityData, EdqsDataQuery query) {
<b class="nc">&nbsp;        return Stream.concat(query.getEntityFields().stream(), query.getLatestValues().stream())</b>
<b class="nc">&nbsp;                .anyMatch(key -&gt; {</b>
<b class="nc">&nbsp;                    DataPoint value = entityData.getDataPoint(key, null);</b>
<b class="nc">&nbsp;                    return value != null &amp;&amp; containsIgnoreCase(value.valueToString(), query.getTextSearch());</b>
&nbsp;                });
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

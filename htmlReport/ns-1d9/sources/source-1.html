<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AbstractBulkImportService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.sync.ie.importing.csv</a>
</div>

<h1>Coverage Summary for Class: AbstractBulkImportService (org.thingsboard.server.service.sync.ie.importing.csv)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AbstractBulkImportService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/107)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AbstractBulkImportService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AbstractBulkImportService$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AbstractBulkImportService$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">AbstractBulkImportService$EntityData</td>
  </tr>
  <tr>
    <td class="name">AbstractBulkImportService$ParsedValue</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.sync.ie.importing.csv;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.gson.JsonElement;
&nbsp;import com.google.gson.JsonObject;
&nbsp;import com.google.gson.JsonPrimitive;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import lombok.Data;
&nbsp;import lombok.SneakyThrows;
&nbsp;import org.apache.commons.lang3.exception.ExceptionUtils;
&nbsp;import org.apache.commons.lang3.tuple.Pair;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.security.core.context.SecurityContext;
&nbsp;import org.springframework.security.core.context.SecurityContextHolder;
&nbsp;import org.thingsboard.common.util.DonAsynchron;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.rule.engine.api.AttributesSaveRequest;
&nbsp;import org.thingsboard.rule.engine.api.TimeseriesSaveRequest;
&nbsp;import org.thingsboard.server.common.adaptor.JsonConverter;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.HasAdditionalInfo;
&nbsp;import org.thingsboard.server.common.data.HasTenantId;
&nbsp;import org.thingsboard.server.common.data.HasVersion;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.TenantProfile;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.UUIDBased;
&nbsp;import org.thingsboard.server.common.data.kv.AttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.BasicTsKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.DataType;
&nbsp;import org.thingsboard.server.common.data.kv.TsKvEntry;
&nbsp;import org.thingsboard.server.common.data.sync.ie.importing.csv.BulkImportColumnType;
&nbsp;import org.thingsboard.server.common.data.sync.ie.importing.csv.BulkImportRequest;
&nbsp;import org.thingsboard.server.common.data.sync.ie.importing.csv.BulkImportResult;
&nbsp;import org.thingsboard.server.common.data.tenant.profile.DefaultTenantProfileConfiguration;
&nbsp;import org.thingsboard.server.common.data.util.TypeCastUtil;
&nbsp;import org.thingsboard.server.controller.BaseController;
&nbsp;import org.thingsboard.server.dao.tenant.TbTenantProfileCache;
&nbsp;import org.thingsboard.server.service.action.EntityActionService;
&nbsp;import org.thingsboard.server.service.security.AccessValidator;
&nbsp;import org.thingsboard.server.service.security.model.SecurityUser;
&nbsp;import org.thingsboard.server.service.security.permission.AccessControlService;
&nbsp;import org.thingsboard.server.service.security.permission.Operation;
&nbsp;import org.thingsboard.server.service.security.permission.Resource;
&nbsp;import org.thingsboard.server.service.telemetry.TelemetrySubscriptionService;
&nbsp;import org.thingsboard.server.utils.CsvUtils;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.CountDownLatch;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.atomic.AtomicInteger;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.Stream;
&nbsp;
<b class="nc">&nbsp;public abstract class AbstractBulkImportService&lt;E extends HasId&lt;? extends EntityId&gt; &amp; HasTenantId&gt; {</b>
&nbsp;    @Autowired
&nbsp;    private TelemetrySubscriptionService tsSubscriptionService;
&nbsp;    @Autowired
&nbsp;    private TbTenantProfileCache tenantProfileCache;
&nbsp;    @Autowired
&nbsp;    private AccessControlService accessControlService;
&nbsp;    @Autowired
&nbsp;    private AccessValidator accessValidator;
&nbsp;    @Autowired
&nbsp;    private EntityActionService entityActionService;
&nbsp;
&nbsp;    private ExecutorService executor;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    private void initExecutor() {
<b class="nc">&nbsp;        executor = ThingsBoardExecutors.newLimitedTasksExecutor(Runtime.getRuntime().availableProcessors(), 150_000, &quot;bulk-import&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public final BulkImportResult&lt;E&gt; processBulkImport(BulkImportRequest request, SecurityUser user) throws Exception {
<b class="nc">&nbsp;        List&lt;EntityData&gt; entitiesData = parseData(request);</b>
&nbsp;
<b class="nc">&nbsp;        BulkImportResult&lt;E&gt; result = new BulkImportResult&lt;&gt;();</b>
<b class="nc">&nbsp;        CountDownLatch completionLatch = new CountDownLatch(entitiesData.size());</b>
&nbsp;
<b class="nc">&nbsp;        SecurityContext securityContext = SecurityContextHolder.getContext();</b>
&nbsp;
<b class="nc">&nbsp;        entitiesData.forEach(entityData -&gt; DonAsynchron.submit(() -&gt; {</b>
<b class="nc">&nbsp;                    SecurityContextHolder.setContext(securityContext);</b>
&nbsp;
<b class="nc">&nbsp;                    ImportedEntityInfo&lt;E&gt; importedEntityInfo = saveEntity(entityData.getFields(), user);</b>
<b class="nc">&nbsp;                    E entity = importedEntityInfo.getEntity();</b>
&nbsp;
<b class="nc">&nbsp;                    if (request.getMapping().getUpdate() || !importedEntityInfo.isUpdated()) {</b>
<b class="nc">&nbsp;                        saveKvs(user, entity, entityData.getKvs());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return importedEntityInfo;</b>
&nbsp;                },
&nbsp;                importedEntityInfo -&gt; {
<b class="nc">&nbsp;                    if (importedEntityInfo.isUpdated()) {</b>
<b class="nc">&nbsp;                        result.getUpdated().incrementAndGet();</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        result.getCreated().incrementAndGet();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    completionLatch.countDown();</b>
&nbsp;                },
&nbsp;                throwable -&gt; {
<b class="nc">&nbsp;                    result.getErrors().incrementAndGet();</b>
<b class="nc">&nbsp;                    result.getErrorsList().add(String.format(&quot;Line %d: %s&quot;, entityData.getLineNumber(), ExceptionUtils.getRootCauseMessage(throwable)));</b>
<b class="nc">&nbsp;                    completionLatch.countDown();</b>
&nbsp;                },
&nbsp;                executor));
&nbsp;
<b class="nc">&nbsp;        completionLatch.await();</b>
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    private ImportedEntityInfo&lt;E&gt; saveEntity(Map&lt;BulkImportColumnType, String&gt; fields, SecurityUser user) {
<b class="nc">&nbsp;        ImportedEntityInfo&lt;E&gt; importedEntityInfo = new ImportedEntityInfo&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;        E entity = findOrCreateEntity(user.getTenantId(), fields.get(BulkImportColumnType.NAME));</b>
<b class="nc">&nbsp;        if (entity.getId() != null) {</b>
<b class="nc">&nbsp;            importedEntityInfo.setOldEntity((E) entity.getClass().getConstructor(entity.getClass()).newInstance(entity));</b>
<b class="nc">&nbsp;            importedEntityInfo.setUpdated(true);</b>
<b class="nc">&nbsp;            if (entity instanceof HasVersion versionedEntity) {</b>
<b class="nc">&nbsp;                versionedEntity.setVersion(null); // to overwrite the entity regardless of concurrent changes</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            setOwners(entity, user);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        setEntityFields(entity, fields);</b>
<b class="nc">&nbsp;        accessControlService.checkPermission(user, Resource.of(getEntityType()), Operation.WRITE, entity.getId(), entity);</b>
&nbsp;
<b class="nc">&nbsp;        E savedEntity = saveEntity(user, entity, fields);</b>
&nbsp;
<b class="nc">&nbsp;        importedEntityInfo.setEntity(savedEntity);</b>
<b class="nc">&nbsp;        return importedEntityInfo;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    protected abstract E findOrCreateEntity(TenantId tenantId, String name);
&nbsp;
&nbsp;    protected abstract void setOwners(E entity, SecurityUser user);
&nbsp;
&nbsp;    protected abstract void setEntityFields(E entity, Map&lt;BulkImportColumnType, String&gt; fields);
&nbsp;
&nbsp;    protected abstract E saveEntity(SecurityUser user, E entity, Map&lt;BulkImportColumnType, String&gt; fields);
&nbsp;
&nbsp;    protected abstract EntityType getEntityType();
&nbsp;
&nbsp;    protected ObjectNode getOrCreateAdditionalInfoObj(HasAdditionalInfo entity) {
<b class="nc">&nbsp;        return entity.getAdditionalInfo() == null || entity.getAdditionalInfo().isNull() ?</b>
<b class="nc">&nbsp;                JacksonUtil.newObjectNode() : (ObjectNode) entity.getAdditionalInfo();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void saveKvs(SecurityUser user, E entity, Map&lt;BulkImportRequest.ColumnMapping, ParsedValue&gt; data) {
<b class="nc">&nbsp;        Arrays.stream(BulkImportColumnType.values())</b>
<b class="nc">&nbsp;                .filter(BulkImportColumnType::isKv)</b>
<b class="nc">&nbsp;                .map(kvType -&gt; {</b>
<b class="nc">&nbsp;                    JsonObject kvs = new JsonObject();</b>
<b class="nc">&nbsp;                    data.entrySet().stream()</b>
<b class="nc">&nbsp;                            .filter(dataEntry -&gt; dataEntry.getKey().getType() == kvType &amp;&amp;</b>
<b class="nc">&nbsp;                                    StringUtils.isNotEmpty(dataEntry.getKey().getKey()))</b>
<b class="nc">&nbsp;                            .forEach(dataEntry -&gt; {</b>
<b class="nc">&nbsp;                                ParsedValue value = dataEntry.getValue();</b>
<b class="nc">&nbsp;                                JsonElement kvValue = (value.getDataType() == DataType.JSON)</b>
<b class="nc">&nbsp;                                        ? (JsonElement) value.getValue()</b>
<b class="nc">&nbsp;                                        : value.toJsonPrimitive();</b>
<b class="nc">&nbsp;                                kvs.add(dataEntry.getKey().getKey(), kvValue);</b>
&nbsp;                            });
<b class="nc">&nbsp;                    return Map.entry(kvType, kvs);</b>
&nbsp;                })
<b class="nc">&nbsp;                .filter(kvsEntry -&gt; !kvsEntry.getValue().entrySet().isEmpty())</b>
<b class="nc">&nbsp;                .forEach(kvsEntry -&gt; {</b>
<b class="nc">&nbsp;                    BulkImportColumnType kvType = kvsEntry.getKey();</b>
<b class="nc">&nbsp;                    if (kvType == BulkImportColumnType.SHARED_ATTRIBUTE || kvType == BulkImportColumnType.SERVER_ATTRIBUTE) {</b>
<b class="nc">&nbsp;                        saveAttributes(user, entity, kvsEntry, kvType);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        saveTelemetry(user, entity, kvsEntry);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    private void saveTelemetry(SecurityUser user, E entity, Map.Entry&lt;BulkImportColumnType, JsonObject&gt; kvsEntry) {
<b class="nc">&nbsp;        List&lt;TsKvEntry&gt; timeseries = JsonConverter.convertToTelemetry(kvsEntry.getValue(), System.currentTimeMillis())</b>
<b class="nc">&nbsp;                .entrySet().stream()</b>
<b class="nc">&nbsp;                .flatMap(entry -&gt; entry.getValue().stream().map(kvEntry -&gt; new BasicTsKvEntry(entry.getKey(), kvEntry)))</b>
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;        accessValidator.validateEntityAndCallback(user, Operation.WRITE_TELEMETRY, entity.getId(), (result, tenantId, entityId) -&gt; {</b>
<b class="nc">&nbsp;            TenantProfile tenantProfile = tenantProfileCache.get(tenantId);</b>
<b class="nc">&nbsp;            long tenantTtl = TimeUnit.DAYS.toSeconds(((DefaultTenantProfileConfiguration) tenantProfile.getProfileData().getConfiguration()).getDefaultStorageTtlDays());</b>
<b class="nc">&nbsp;            tsSubscriptionService.saveTimeseries(TimeseriesSaveRequest.builder()</b>
<b class="nc">&nbsp;                    .tenantId(tenantId)</b>
<b class="nc">&nbsp;                    .customerId(user.getCustomerId())</b>
<b class="nc">&nbsp;                    .entityId(entityId)</b>
<b class="nc">&nbsp;                    .entries(timeseries)</b>
<b class="nc">&nbsp;                    .ttl(tenantTtl)</b>
<b class="nc">&nbsp;                    .callback(new FutureCallback&lt;&gt;() {</b>
&nbsp;                        @Override
&nbsp;                        public void onSuccess(@Nullable Void tmp) {
<b class="nc">&nbsp;                            entityActionService.logEntityAction(user, (UUIDBased &amp; EntityId) entityId, null, null,</b>
&nbsp;                                    ActionType.TIMESERIES_UPDATED, null, timeseries);
&nbsp;                        }
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void onFailure(Throwable t) {
<b class="nc">&nbsp;                            entityActionService.logEntityAction(user, (UUIDBased &amp; EntityId) entityId, null, null,</b>
<b class="nc">&nbsp;                                    ActionType.TIMESERIES_UPDATED, BaseController.toException(t), timeseries);</b>
<b class="nc">&nbsp;                            throw new RuntimeException(t);</b>
&nbsp;                        }
&nbsp;                    })
<b class="nc">&nbsp;                    .build());</b>
&nbsp;        });
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    @SneakyThrows</b>
&nbsp;    private void saveAttributes(SecurityUser user, E entity, Map.Entry&lt;BulkImportColumnType, JsonObject&gt; kvsEntry, BulkImportColumnType kvType) {
<b class="nc">&nbsp;        String scope = kvType.getKey();</b>
<b class="nc">&nbsp;        List&lt;AttributeKvEntry&gt; attributes = JsonConverter.convertToAttributes(kvsEntry.getValue());</b>
&nbsp;
<b class="nc">&nbsp;        accessValidator.validateEntityAndCallback(user, Operation.WRITE_ATTRIBUTES, entity.getId(), (result, tenantId, entityId) -&gt; {</b>
<b class="nc">&nbsp;            tsSubscriptionService.saveAttributes(AttributesSaveRequest.builder()</b>
<b class="nc">&nbsp;                    .tenantId(tenantId)</b>
<b class="nc">&nbsp;                    .entityId(entityId)</b>
<b class="nc">&nbsp;                    .scope(AttributeScope.valueOf(scope))</b>
<b class="nc">&nbsp;                    .entries(attributes)</b>
<b class="nc">&nbsp;                    .callback(new FutureCallback&lt;&gt;() {</b>
&nbsp;                        @Override
&nbsp;                        public void onSuccess(Void unused) {
<b class="nc">&nbsp;                            entityActionService.logEntityAction(user, (UUIDBased &amp; EntityId) entityId, null,</b>
<b class="nc">&nbsp;                                    null, ActionType.ATTRIBUTES_UPDATED, null, AttributeScope.valueOf(scope), attributes);</b>
&nbsp;                        }
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void onFailure(Throwable throwable) {
<b class="nc">&nbsp;                            entityActionService.logEntityAction(user, (UUIDBased &amp; EntityId) entityId, null,</b>
<b class="nc">&nbsp;                                    null, ActionType.ATTRIBUTES_UPDATED, BaseController.toException(throwable),</b>
<b class="nc">&nbsp;                                    AttributeScope.valueOf(scope), attributes);</b>
<b class="nc">&nbsp;                            throw new RuntimeException(throwable);</b>
&nbsp;                        }
&nbsp;                    })
<b class="nc">&nbsp;                    .build());</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    private List&lt;EntityData&gt; parseData(BulkImportRequest request) throws Exception {
<b class="nc">&nbsp;        List&lt;List&lt;String&gt;&gt; records = CsvUtils.parseCsv(request.getFile(), request.getMapping().getDelimiter());</b>
<b class="nc">&nbsp;        AtomicInteger linesCounter = new AtomicInteger(0);</b>
&nbsp;
<b class="nc">&nbsp;        if (request.getMapping().getHeader()) {</b>
<b class="nc">&nbsp;            records.remove(0);</b>
<b class="nc">&nbsp;            linesCounter.incrementAndGet();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;BulkImportRequest.ColumnMapping&gt; columnsMappings = request.getMapping().getColumns();</b>
<b class="nc">&nbsp;        return records.stream()</b>
<b class="nc">&nbsp;                .map(record -&gt; {</b>
<b class="nc">&nbsp;                    EntityData entityData = new EntityData();</b>
<b class="nc">&nbsp;                    Stream.iterate(0, i -&gt; i &lt; record.size(), i -&gt; i + 1)</b>
<b class="nc">&nbsp;                            .map(i -&gt; Map.entry(columnsMappings.get(i), record.get(i)))</b>
<b class="nc">&nbsp;                            .filter(entry -&gt; StringUtils.isNotEmpty(entry.getValue()))</b>
<b class="nc">&nbsp;                            .forEach(entry -&gt; {</b>
<b class="nc">&nbsp;                                if (!entry.getKey().getType().isKv()) {</b>
<b class="nc">&nbsp;                                    entityData.getFields().put(entry.getKey().getType(), entry.getValue());</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    Pair&lt;DataType, Object&gt; castResult = TypeCastUtil.castValue(entry.getValue());</b>
<b class="nc">&nbsp;                                    entityData.getKvs().put(entry.getKey(), new ParsedValue(castResult.getValue(), castResult.getKey()));</b>
&nbsp;                                }
&nbsp;                            });
<b class="nc">&nbsp;                    entityData.setLineNumber(linesCounter.incrementAndGet());</b>
<b class="nc">&nbsp;                    return entityData;</b>
&nbsp;                })
<b class="nc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    private void shutdownExecutor() {
<b class="nc">&nbsp;        if (executor != null) {</b>
<b class="nc">&nbsp;            executor.shutdownNow();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Data
&nbsp;    protected static class EntityData {
&nbsp;        private final Map&lt;BulkImportColumnType, String&gt; fields = new LinkedHashMap&lt;&gt;();
&nbsp;        private final Map&lt;BulkImportRequest.ColumnMapping, ParsedValue&gt; kvs = new LinkedHashMap&lt;&gt;();
&nbsp;        private int lineNumber;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Data
&nbsp;    protected static class ParsedValue {
&nbsp;        private final Object value;
&nbsp;        private final DataType dataType;
&nbsp;
&nbsp;        public JsonPrimitive toJsonPrimitive() {
<b class="nc">&nbsp;            return switch (dataType) {</b>
<b class="nc">&nbsp;                case STRING -&gt; new JsonPrimitive((String) value);</b>
<b class="nc">&nbsp;                case LONG -&gt; new JsonPrimitive((Long) value);</b>
<b class="nc">&nbsp;                case DOUBLE -&gt; new JsonPrimitive((Double) value);</b>
<b class="nc">&nbsp;                case BOOLEAN -&gt; new JsonPrimitive((Boolean) value);</b>
<b class="nc">&nbsp;                default -&gt; null;</b>
&nbsp;            };
&nbsp;        }
&nbsp;
&nbsp;        public String stringValue() {
<b class="nc">&nbsp;            return value.toString();</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

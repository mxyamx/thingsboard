<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TbDefaultDDFFileValidator</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.common.data.util</a>
</div>

<h1>Coverage Summary for Class: TbDefaultDDFFileValidator (org.thingsboard.server.common.data.util)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TbDefaultDDFFileValidator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.common.data.util;
&nbsp;
&nbsp;
&nbsp;import org.eclipse.leshan.core.LwM2m.LwM2mVersion;
&nbsp;import org.eclipse.leshan.core.model.DDFFileValidator;
&nbsp;import org.eclipse.leshan.core.model.InvalidDDFFileException;
&nbsp;import org.eclipse.leshan.core.util.Validate;
&nbsp;import org.w3c.dom.Node;
&nbsp;import org.xml.sax.SAXException;
&nbsp;import org.xml.sax.SAXNotRecognizedException;
&nbsp;import org.xml.sax.SAXNotSupportedException;
&nbsp;
&nbsp;import javax.xml.XMLConstants;
&nbsp;import javax.xml.transform.Source;
&nbsp;import javax.xml.transform.dom.DOMSource;
&nbsp;import javax.xml.transform.stream.StreamSource;
&nbsp;import javax.xml.validation.Schema;
&nbsp;import javax.xml.validation.SchemaFactory;
&nbsp;import javax.xml.validation.Validator;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;
&nbsp;/**
&nbsp; * A DDF File Validator.
&nbsp; * &lt;p&gt;
&nbsp; * Validate a DDF File against the embedded LWM2M schema.
&nbsp; * &lt;p&gt;
&nbsp; * Support LWM2M version 1.0 and 1.1.
&nbsp; */
&nbsp;
&nbsp;public class TbDefaultDDFFileValidator implements DDFFileValidator {
<b class="nc">&nbsp;    private static String LWM2M_V1_0_SCHEMA_PATH = &quot;/schemas/LWM2M.xsd&quot;;</b>
<b class="nc">&nbsp;    private static String LWM2M_V1_1_SCHEMA_PATH = &quot;/schemas/LWM2M-v1_1.xsd&quot;;</b>
&nbsp;
&nbsp;    private final String schema;
&nbsp;
&nbsp;    /**
&nbsp;     * Create a {@link DDFFileValidator} using the LWM2M v1.1 schema.
&nbsp;     */
&nbsp;    public TbDefaultDDFFileValidator() {
<b class="nc">&nbsp;        this(LwM2mVersion.V1_1);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Create a {@link DDFFileValidator} using schema corresponding to LWM2M {@link LwM2mVersion}.
&nbsp;     */
<b class="nc">&nbsp;    public TbDefaultDDFFileValidator(LwM2mVersion version) {</b>
<b class="nc">&nbsp;        Validate.notNull(version, &quot;version must not be null&quot;);</b>
<b class="nc">&nbsp;        if (LwM2mVersion.V1_0.equals(version)) {</b>
<b class="nc">&nbsp;            schema = LWM2M_V1_0_SCHEMA_PATH;</b>
<b class="nc">&nbsp;        } else if (LwM2mVersion.V1_1.equals(version)) {</b>
<b class="nc">&nbsp;            schema = LWM2M_V1_1_SCHEMA_PATH;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new IllegalStateException(String.format(&quot;Unsupported version %s&quot;, version));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void validate(Node xmlToValidate) throws InvalidDDFFileException {
&nbsp;        try {
<b class="nc">&nbsp;            validate(new DOMSource(xmlToValidate));</b>
&nbsp;        } catch (SAXException | IOException e) {
<b class="nc">&nbsp;            throw new InvalidDDFFileException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Validate a XML {@link Source} against the embedded LWM2M Schema.
&nbsp;     *
&nbsp;     * @param xmlToValidate an XML source to validate
&nbsp;     * @throws SAXException see {@link Validator#validate(Source)}
&nbsp;     * @throws IOException see {@link Validator#validate(Source)}
&nbsp;     */
&nbsp;    public void validate(Source xmlToValidate) throws SAXException, IOException {
<b class="nc">&nbsp;        Validator validator = getEmbeddedLwM2mSchema().newValidator();</b>
<b class="nc">&nbsp;        validator.validate(xmlToValidate);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Get the Embedded the LWM2M.xsd Schema.
&nbsp;     *
&nbsp;     * @throws SAXException see {@link SchemaFactory#newSchema(Source)}
&nbsp;     */
&nbsp;    protected Schema getEmbeddedLwM2mSchema() throws SAXException {
<b class="nc">&nbsp;        InputStream inputStream = DDFFileValidator.class.getResourceAsStream(schema);</b>
<b class="nc">&nbsp;        Source source = new StreamSource(inputStream);</b>
<b class="nc">&nbsp;        SchemaFactory schemaFactory = createSchemaFactory();</b>
<b class="nc">&nbsp;        return schemaFactory.newSchema(source);</b>
&nbsp;    }
&nbsp;
&nbsp;    protected SchemaFactory createSchemaFactory() {
<b class="nc">&nbsp;        SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</b>
&nbsp;//        SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_INSTANCE_NS_URI);
&nbsp;        try {
&nbsp;            // Create Safe SchemaFactory (not vulnerable to XXE Attacks)
&nbsp;            // --------------------------------------------------------
&nbsp;            // There is several recommendation from different source we try to apply all, even if some are maybe
&nbsp;            // redundant.
&nbsp;
&nbsp;            // from :
&nbsp;            // https://semgrep.dev/docs/cheat-sheets/java-xxe/
<b class="nc">&nbsp;            factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</b>
&nbsp;
&nbsp;            // from :
&nbsp;            // https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#schemafactory
&nbsp;//            factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, &quot;&quot;);
&nbsp;//            factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, &quot;&quot;);
&nbsp;
&nbsp;        } catch (SAXNotRecognizedException | SAXNotSupportedException e) {
<b class="nc">&nbsp;            throw new IllegalStateException(&quot;Unable to create SchemaFactory&quot;, e);</b>
&nbsp;        }
<b class="nc">&nbsp;        return factory;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > EntityViewServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.dao.entityview</a>
</div>

<h1>Coverage Summary for Class: EntityViewServiceImpl (org.thingsboard.server.dao.entityview)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EntityViewServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/198)
  </span>
</td>
</tr>
  <tr>
    <td class="name">EntityViewServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EntityViewServiceImpl$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">EntityViewServiceImpl$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/206)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.dao.entityview;
&nbsp;
&nbsp;import com.google.common.base.Function;
&nbsp;import com.google.common.util.concurrent.FluentFuture;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.MoreExecutors;
&nbsp;import jakarta.annotation.Nullable;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import org.springframework.transaction.event.TransactionalEventListener;
&nbsp;import org.thingsboard.server.common.data.EntitySubtype;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.EntityViewInfo;
&nbsp;import org.thingsboard.server.common.data.NameConflictPolicy;
&nbsp;import org.thingsboard.server.common.data.NameConflictStrategy;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.audit.ActionType;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.entityview.EntityViewSearchQuery;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityViewId;
&nbsp;import org.thingsboard.server.common.data.id.HasId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.page.PageData;
&nbsp;import org.thingsboard.server.common.data.page.PageLink;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.EntitySearchDirection;
&nbsp;import org.thingsboard.server.common.data.relation.RelationTypeGroup;
&nbsp;import org.thingsboard.server.dao.entity.CachedVersionedEntityService;
&nbsp;import org.thingsboard.server.dao.eventsourcing.ActionEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.DeleteEntityEvent;
&nbsp;import org.thingsboard.server.dao.eventsourcing.SaveEntityEvent;
&nbsp;import org.thingsboard.server.exception.DataValidationException;
&nbsp;import org.thingsboard.server.dao.service.PaginatedRemover;
&nbsp;import org.thingsboard.server.dao.service.validator.EntityViewDataValidator;
&nbsp;import org.thingsboard.server.dao.sql.JpaExecutorService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Comparator;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static com.google.common.util.concurrent.MoreExecutors.directExecutor;
&nbsp;import static org.thingsboard.server.dao.DaoUtil.toUUIDs;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateId;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validatePageLink;
&nbsp;import static org.thingsboard.server.dao.service.Validator.validateString;
&nbsp;
&nbsp;@Service(&quot;EntityViewDaoService&quot;)
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class EntityViewServiceImpl extends CachedVersionedEntityService&lt;EntityViewCacheKey, EntityViewCacheValue, EntityViewEvictEvent&gt; implements EntityViewService {</b>
&nbsp;
&nbsp;    public static final String INCORRECT_TENANT_ID = &quot;Incorrect tenantId &quot;;
&nbsp;    public static final String INCORRECT_CUSTOMER_ID = &quot;Incorrect customerId &quot;;
&nbsp;    public static final String INCORRECT_ENTITY_VIEW_ID = &quot;Incorrect entityViewId &quot;;
&nbsp;    public static final String INCORRECT_EDGE_ID = &quot;Incorrect edgeId &quot;;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EntityViewDao entityViewDao;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EntityViewDataValidator entityViewValidator;
&nbsp;
&nbsp;    @Autowired
&nbsp;    protected JpaExecutorService service;
&nbsp;
&nbsp;    @TransactionalEventListener(classes = EntityViewEvictEvent.class)
&nbsp;    @Override
&nbsp;    public void handleEvictEvent(EntityViewEvictEvent event) {
<b class="nc">&nbsp;        List&lt;EntityViewCacheKey&gt; toEvict = new ArrayList&lt;&gt;(5);</b>
<b class="nc">&nbsp;        toEvict.add(EntityViewCacheKey.byName(event.getTenantId(), event.getNewName()));</b>
<b class="nc">&nbsp;        if (event.getSavedEntityView() != null) {</b>
<b class="nc">&nbsp;            cache.put(EntityViewCacheKey.byId(event.getSavedEntityView().getId()), new EntityViewCacheValue(event.getSavedEntityView(), null));</b>
<b class="nc">&nbsp;        } else if (event.getEntityViewId() != null) {</b>
<b class="nc">&nbsp;            toEvict.add(EntityViewCacheKey.byId(event.getEntityViewId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        toEvict.add(EntityViewCacheKey.byEntityId(event.getTenantId(), event.getNewEntityId()));</b>
<b class="nc">&nbsp;        if (event.getOldEntityId() != null &amp;&amp; !event.getOldEntityId().equals(event.getNewEntityId())) {</b>
<b class="nc">&nbsp;            toEvict.add(EntityViewCacheKey.byEntityId(event.getTenantId(), event.getOldEntityId()));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (StringUtils.isNotEmpty(event.getOldName()) &amp;&amp; !event.getOldName().equals(event.getNewName())) {</b>
<b class="nc">&nbsp;            toEvict.add(EntityViewCacheKey.byName(event.getTenantId(), event.getOldName()));</b>
&nbsp;        }
<b class="nc">&nbsp;        cache.evict(toEvict);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView saveEntityView(EntityView entityView) {
<b class="nc">&nbsp;        return saveEntityView(entityView, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView saveEntityView(EntityView entityView, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        return saveEntityView(entityView, true, nameConflictStrategy);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView saveEntityView(EntityView entityView, boolean doValidate) {
<b class="nc">&nbsp;        return saveEntityView(entityView, doValidate, NameConflictStrategy.DEFAULT);</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityView saveEntityView(EntityView entityView, boolean doValidate, NameConflictStrategy nameConflictStrategy) {
<b class="nc">&nbsp;        log.trace(&quot;Executing save entity view [{}]&quot;, entityView);</b>
<b class="nc">&nbsp;        EntityView old = (entityView.getId() != null) ? entityViewDao.findById(entityView.getTenantId(), entityView.getId().getId()) : null;</b>
<b class="nc">&nbsp;        if (nameConflictStrategy.policy() == NameConflictPolicy.UNIQUIFY &amp;&amp; (old == null || !entityView.getName().equals(old.getName()))) {</b>
<b class="nc">&nbsp;            uniquifyEntityName(entityView, old, entityView::setName, EntityType.ENTITY_VIEW, nameConflictStrategy);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (doValidate) {</b>
<b class="nc">&nbsp;            entityViewValidator.validate(entityView, EntityView::getTenantId);</b>
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            EntityView saved = entityViewDao.save(entityView.getTenantId(), entityView);</b>
<b class="nc">&nbsp;            publishEvictEvent(new EntityViewEvictEvent(saved.getTenantId(), saved.getId(), saved.getEntityId(), old != null ? old.getEntityId() : null, saved.getName(), old != null ? old.getName() : null, saved));</b>
<b class="nc">&nbsp;            eventPublisher.publishEvent(SaveEntityEvent.builder().tenantId(saved.getTenantId())</b>
<b class="nc">&nbsp;                    .entityId(saved.getId()).entity(saved).created(entityView.getId() == null).build());</b>
<b class="nc">&nbsp;            return saved;</b>
&nbsp;        } catch (Exception t) {
<b class="nc">&nbsp;            checkConstraintViolation(t,</b>
&nbsp;                    &quot;entity_view_external_id_unq_key&quot;, &quot;Entity View with such external id already exists!&quot;);
&nbsp;            throw t;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView assignEntityViewToCustomer(TenantId tenantId, EntityViewId entityViewId, CustomerId customerId) {
<b class="nc">&nbsp;        EntityView entityView = findEntityViewById(tenantId, entityViewId);</b>
<b class="nc">&nbsp;        if (customerId.equals(entityView.getCustomerId())) {</b>
<b class="nc">&nbsp;            return entityView;</b>
&nbsp;        }
<b class="nc">&nbsp;        entityView.setCustomerId(customerId);</b>
<b class="nc">&nbsp;        return saveEntityView(entityView);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView unassignEntityViewFromCustomer(TenantId tenantId, EntityViewId entityViewId) {
<b class="nc">&nbsp;        EntityView entityView = findEntityViewById(tenantId, entityViewId);</b>
<b class="nc">&nbsp;        if (entityView.getCustomerId() == null) {</b>
<b class="nc">&nbsp;            return entityView;</b>
&nbsp;        }
<b class="nc">&nbsp;        entityView.setCustomerId(null);</b>
<b class="nc">&nbsp;        return saveEntityView(entityView);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unassignCustomerEntityViews(TenantId tenantId, CustomerId customerId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing unassignCustomerEntityViews, tenantId [{}], customerId [{}]&quot;, tenantId, customerId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        customerEntityViewsRemover.removeEntities(tenantId, customerId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityViewInfo findEntityViewInfoById(TenantId tenantId, EntityViewId entityViewId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewInfoById [{}]&quot;, entityViewId);</b>
<b class="nc">&nbsp;        validateId(entityViewId, id -&gt; INCORRECT_ENTITY_VIEW_ID + id);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewInfoById(tenantId, entityViewId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView findEntityViewById(TenantId tenantId, EntityViewId entityViewId) {
<b class="nc">&nbsp;        return findEntityViewById(tenantId, entityViewId, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView findEntityViewById(TenantId tenantId, EntityViewId entityViewId, boolean putInCache) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewById [{}]&quot;, entityViewId);</b>
<b class="nc">&nbsp;        validateId(entityViewId, id -&gt; INCORRECT_ENTITY_VIEW_ID + id);</b>
<b class="nc">&nbsp;        return findEntityViewByIdInternal(tenantId, entityViewId, putInCache);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;EntityView&gt; findEntityViewByIdAsync(TenantId tenantId, EntityViewId entityViewId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewByIdAsync [{}]&quot;, entityViewId);</b>
<b class="nc">&nbsp;        validateId(entityViewId, id -&gt; INCORRECT_ENTITY_VIEW_ID + id);</b>
<b class="nc">&nbsp;        return service.submit(() -&gt; findEntityViewByIdInternal(tenantId, entityViewId, true));</b>
&nbsp;    }
&nbsp;
&nbsp;    private EntityView findEntityViewByIdInternal(TenantId tenantId, EntityViewId entityViewId, boolean putInCache) {
<b class="nc">&nbsp;        EntityViewCacheValue value = cache.get(EntityViewCacheKey.byId(entityViewId), () -&gt; {</b>
<b class="nc">&nbsp;            EntityView entityView = entityViewDao.findById(tenantId, entityViewId.getId());</b>
<b class="nc">&nbsp;            return new EntityViewCacheValue(entityView, null);</b>
&nbsp;        }, putInCache);
<b class="nc">&nbsp;        return value != null ? value.getEntityView() : null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView findEntityViewByTenantIdAndName(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewByTenantIdAndName [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(EntityViewCacheKey.byName(tenantId, name),</b>
<b class="nc">&nbsp;                () -&gt; entityViewDao.findEntityViewByTenantIdAndName(tenantId.getId(), name).orElse(null)</b>
<b class="nc">&nbsp;                , EntityViewCacheValue::getEntityView, v -&gt; new EntityViewCacheValue(v, null), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;EntityView&gt; findEntityViewByTenantIdAndNameAsync(TenantId tenantId, String name) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewByTenantIdAndNameAsync [{}][{}]&quot;, tenantId, name);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        return service.submit(() -&gt; findEntityViewByTenantIdAndName(tenantId, name));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityViewInfo&gt; findEntityViewInfosByTenantId(TenantId tenantId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewInfosByTenantId, tenantId [{}], pageLink [{}]&quot;, tenantId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewInfosByTenantId(tenantId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewByTenantIdAndType(TenantId tenantId, PageLink pageLink, String type) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewByTenantIdAndType, tenantId [{}], pageLink [{}], type [{}]&quot;, tenantId, pageLink, type);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndType(tenantId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityViewInfo&gt; findEntityViewInfosByTenantIdAndType(TenantId tenantId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewInfosByTenantIdAndType, tenantId [{}], pageLink [{}], type [{}]&quot;, tenantId, pageLink, type);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewInfosByTenantIdAndType(tenantId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewsByTenantIdAndCustomerId(TenantId tenantId, CustomerId customerId,
&nbsp;                                                                       PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewByTenantIdAndCustomerId, tenantId [{}], customerId [{}],&quot; +</b>
&nbsp;                &quot; pageLink [{}]&quot;, tenantId, customerId, pageLink);
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndCustomerId(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;EntityView&gt; findEntityViewsByTenantIdAndIds(TenantId tenantId, List&lt;EntityViewId&gt; entityViewIds) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndIds, tenantId [{}], entityViewIds [{}]&quot;, tenantId, entityViewIds);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndIds(tenantId.getId(), toUUIDs(entityViewIds));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityViewInfo&gt; findEntityViewInfosByTenantIdAndCustomerId(TenantId tenantId, CustomerId customerId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewInfosByTenantIdAndCustomerId, tenantId [{}], customerId [{}],&quot; +</b>
&nbsp;                &quot; pageLink [{}]&quot;, tenantId, customerId, pageLink);
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewInfosByTenantIdAndCustomerId(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewsByTenantIdAndCustomerIdAndType(TenantId tenantId, CustomerId customerId, PageLink pageLink, String type) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndCustomerIdAndType, tenantId [{}], customerId [{}],&quot; +</b>
&nbsp;                &quot; pageLink [{}], type [{}]&quot;, tenantId, customerId, pageLink, type);
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndCustomerIdAndType(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityViewInfo&gt; findEntityViewInfosByTenantIdAndCustomerIdAndType(TenantId tenantId, CustomerId customerId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewInfosByTenantIdAndCustomerIdAndType, tenantId [{}], customerId [{}],&quot; +</b>
&nbsp;                &quot; pageLink [{}], type [{}]&quot;, tenantId, customerId, pageLink, type);
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(customerId, id -&gt; INCORRECT_CUSTOMER_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewInfosByTenantIdAndCustomerIdAndType(tenantId.getId(),</b>
<b class="nc">&nbsp;                customerId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntityView&gt;&gt; findEntityViewsByQuery(TenantId tenantId, EntityViewSearchQuery query) {
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntityRelation&gt;&gt; relations = relationService.findByQuery(tenantId, query.toEntitySearchQuery());</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntityView&gt;&gt; entityViews = Futures.transformAsync(relations, r -&gt; {</b>
<b class="nc">&nbsp;            EntitySearchDirection direction = query.toEntitySearchQuery().getParameters().getDirection();</b>
<b class="nc">&nbsp;            List&lt;ListenableFuture&lt;EntityView&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (EntityRelation relation : r) {</b>
<b class="nc">&nbsp;                EntityId entityId = direction == EntitySearchDirection.FROM ? relation.getTo() : relation.getFrom();</b>
<b class="nc">&nbsp;                if (entityId.getEntityType() == EntityType.ENTITY_VIEW) {</b>
<b class="nc">&nbsp;                    futures.add(findEntityViewByIdAsync(tenantId, new EntityViewId(entityId.getId())));</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return Futures.successfulAsList(futures);</b>
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;
<b class="nc">&nbsp;        entityViews = Futures.transform(entityViews, new Function&lt;List&lt;EntityView&gt;, List&lt;EntityView&gt;&gt;() {</b>
&nbsp;            @Nullable
&nbsp;            @Override
&nbsp;            public List&lt;EntityView&gt; apply(@Nullable List&lt;EntityView&gt; entityViewList) {
<b class="nc">&nbsp;                return entityViewList == null ? Collections.emptyList() : entityViewList.stream().filter(entityView -&gt; query.getEntityViewTypes().contains(entityView.getType())).collect(Collectors.toList());</b>
&nbsp;            }
<b class="nc">&nbsp;        }, MoreExecutors.directExecutor());</b>
&nbsp;
<b class="nc">&nbsp;        return entityViews;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntityView&gt;&gt; findEntityViewsByTenantIdAndEntityIdAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndEntityIdAsync, tenantId [{}], entityId [{}]&quot;, tenantId, entityId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(entityId.getId(), id -&gt; &quot;Incorrect entityId&quot; + id);</b>
&nbsp;
<b class="nc">&nbsp;        return service.submit(() -&gt; cache.getAndPutInTransaction(EntityViewCacheKey.byEntityId(tenantId, entityId),</b>
<b class="nc">&nbsp;                () -&gt; entityViewDao.findEntityViewsByTenantIdAndEntityId(tenantId.getId(), entityId.getId()),</b>
<b class="nc">&nbsp;                EntityViewCacheValue::getEntityViews, v -&gt; new EntityViewCacheValue(null, v), true));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;EntityView&gt; findEntityViewsByTenantIdAndEntityId(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndEntityId, tenantId [{}], entityId [{}]&quot;, tenantId, entityId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(entityId.getId(), id -&gt; &quot;Incorrect entityId&quot; + id);</b>
&nbsp;
<b class="nc">&nbsp;        return cache.getAndPutInTransaction(EntityViewCacheKey.byEntityId(tenantId, entityId),</b>
<b class="nc">&nbsp;                () -&gt; entityViewDao.findEntityViewsByTenantIdAndEntityId(tenantId.getId(), entityId.getId()),</b>
<b class="nc">&nbsp;                EntityViewCacheValue::getEntityViews, v -&gt; new EntityViewCacheValue(null, v), true);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean existsByTenantIdAndEntityId(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return entityViewDao.existsByTenantIdAndEntityId(tenantId.getId(), entityId.getId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEntityView(TenantId tenantId, EntityViewId entityViewId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteEntityView [{}]&quot;, entityViewId);</b>
<b class="nc">&nbsp;        validateId(entityViewId, id -&gt; INCORRECT_ENTITY_VIEW_ID + id);</b>
<b class="nc">&nbsp;        EntityView entityView = entityViewDao.findById(tenantId, entityViewId.getId());</b>
<b class="nc">&nbsp;        if (entityView == null) {</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        entityViewDao.removeById(tenantId, entityViewId.getId());</b>
<b class="nc">&nbsp;        publishEvictEvent(new EntityViewEvictEvent(entityView.getTenantId(), entityView.getId(), entityView.getEntityId(), null, entityView.getName(), null));</b>
<b class="nc">&nbsp;        eventPublisher.publishEvent(DeleteEntityEvent.builder().tenantId(tenantId).entityId(entityViewId).build());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteEntity(TenantId tenantId, EntityId id, boolean force) {
<b class="nc">&nbsp;        deleteEntityView(tenantId, (EntityViewId) id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteEntityViewsByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing deleteEntityViewsByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        tenantEntityViewRemover.removeEntities(tenantId, tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        deleteEntityViewsByTenantId(tenantId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; findEntityViewTypesByTenantId(TenantId tenantId) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewTypesByTenantId, tenantId [{}]&quot;, tenantId);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;EntitySubtype&gt;&gt; tenantEntityViewTypes = entityViewDao.findTenantEntityViewTypesAsync(tenantId.getId());</b>
<b class="nc">&nbsp;        return Futures.transform(tenantEntityViewTypes,</b>
&nbsp;                entityViewTypes -&gt; {
<b class="nc">&nbsp;                    entityViewTypes.sort(Comparator.comparing(EntitySubtype::getType));</b>
<b class="nc">&nbsp;                    return entityViewTypes;</b>
<b class="nc">&nbsp;                }, MoreExecutors.directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView assignEntityViewToEdge(TenantId tenantId, EntityViewId entityViewId, EdgeId edgeId) {
<b class="nc">&nbsp;        EntityView entityView = findEntityViewById(tenantId, entityViewId);</b>
<b class="nc">&nbsp;        Edge edge = edgeService.findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        if (edge == null) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign entityView to non-existent edge!&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!edge.getTenantId().getId().equals(entityView.getTenantId().getId())) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign entityView to edge from different tenant!&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean relationExists = relationService.checkRelation(tenantId, edgeId, entityView.getEntityId(),</b>
&nbsp;                EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE);
<b class="nc">&nbsp;        if (!relationExists) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t assign entity view to edge because related device/asset doesn&#39;t assigned to edge!&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            createRelation(tenantId, new EntityRelation(edgeId, entityViewId, EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to create entityView relation. Edge Id: [{}]&quot;, entityViewId, edgeId);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).edgeId(edgeId).entityId(entityViewId)</b>
<b class="nc">&nbsp;                .actionType(ActionType.ASSIGNED_TO_EDGE).build());</b>
<b class="nc">&nbsp;        return entityView;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityView unassignEntityViewFromEdge(TenantId tenantId, EntityViewId entityViewId, EdgeId edgeId) {
<b class="nc">&nbsp;        EntityView entityView = findEntityViewById(tenantId, entityViewId);</b>
<b class="nc">&nbsp;        Edge edge = edgeService.findEdgeById(tenantId, edgeId);</b>
<b class="nc">&nbsp;        if (edge == null) {</b>
<b class="nc">&nbsp;            throw new DataValidationException(&quot;Can&#39;t unassign entityView from non-existent edge!&quot;);</b>
&nbsp;        }
&nbsp;        try {
<b class="nc">&nbsp;            deleteRelation(tenantId, new EntityRelation(edgeId, entityViewId, EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;[{}] Failed to delete entityView relation. Edge Id: [{}]&quot;, entityViewId, edgeId);</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
<b class="nc">&nbsp;        eventPublisher.publishEvent(ActionEntityEvent.builder().tenantId(tenantId).edgeId(edgeId).entityId(entityViewId)</b>
<b class="nc">&nbsp;                .actionType(ActionType.UNASSIGNED_FROM_EDGE).build());</b>
<b class="nc">&nbsp;        return entityView;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewsByTenantIdAndEdgeId(TenantId tenantId, EdgeId edgeId, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndEdgeId, tenantId [{}], edgeId [{}], pageLink [{}]&quot;, tenantId, edgeId, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndEdgeId(tenantId.getId(), edgeId.getId(), pageLink);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public PageData&lt;EntityView&gt; findEntityViewsByTenantIdAndEdgeIdAndType(TenantId tenantId, EdgeId edgeId, String type, PageLink pageLink) {
<b class="nc">&nbsp;        log.trace(&quot;Executing findEntityViewsByTenantIdAndEdgeIdAndType, tenantId [{}], edgeId [{}], type [{}], pageLink [{}]&quot;, tenantId, edgeId, type, pageLink);</b>
<b class="nc">&nbsp;        validateId(tenantId, id -&gt; INCORRECT_TENANT_ID + id);</b>
<b class="nc">&nbsp;        validateId(edgeId, id -&gt; INCORRECT_EDGE_ID + id);</b>
<b class="nc">&nbsp;        validateString(type, t -&gt; &quot;Incorrect type &quot; + t);</b>
<b class="nc">&nbsp;        validatePageLink(pageLink);</b>
<b class="nc">&nbsp;        return entityViewDao.findEntityViewsByTenantIdAndEdgeIdAndType(tenantId.getId(), edgeId.getId(), type, pageLink);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;TenantId, EntityView&gt; tenantEntityViewRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        protected PageData&lt;EntityView&gt; findEntities(TenantId tenantId, TenantId id, PageLink pageLink) {
<b class="nc">&nbsp;            return entityViewDao.findEntityViewsByTenantId(id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, EntityView entity) {
<b class="nc">&nbsp;            deleteEntityView(tenantId, new EntityViewId(entity.getUuidId()));</b>
&nbsp;        }
&nbsp;    };
&nbsp;
<b class="nc">&nbsp;    private final PaginatedRemover&lt;CustomerId, EntityView&gt; customerEntityViewsRemover = new PaginatedRemover&lt;&gt;() {</b>
&nbsp;        @Override
&nbsp;        protected PageData&lt;EntityView&gt; findEntities(TenantId tenantId, CustomerId id, PageLink pageLink) {
<b class="nc">&nbsp;            return entityViewDao.findEntityViewsByTenantIdAndCustomerId(tenantId.getId(), id.getId(), pageLink);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        protected void removeEntity(TenantId tenantId, EntityView entity) {
<b class="nc">&nbsp;            unassignEntityViewFromCustomer(tenantId, new EntityViewId(entity.getUuidId()));</b>
&nbsp;        }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public Optional&lt;HasId&lt;?&gt;&gt; findEntity(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return Optional.ofNullable(findEntityViewById(tenantId, new EntityViewId(entityId.getId())));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public FluentFuture&lt;Optional&lt;HasId&lt;?&gt;&gt;&gt; findEntityAsync(TenantId tenantId, EntityId entityId) {
<b class="nc">&nbsp;        return FluentFuture.from(findEntityViewByIdAsync(tenantId, new EntityViewId(entityId.getId())))</b>
<b class="nc">&nbsp;                .transform(Optional::ofNullable, directExecutor());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public EntityType getEntityType() {
<b class="nc">&nbsp;        return EntityType.ENTITY_VIEW;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultMailService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.mail</a>
</div>

<h1>Coverage Summary for Class: DefaultMailService (org.thingsboard.server.service.mail)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultMailService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/63)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/161)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultMailService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/63)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/164)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.mail;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import freemarker.template.Configuration;
&nbsp;import freemarker.template.Template;
&nbsp;import jakarta.annotation.PostConstruct;
&nbsp;import jakarta.annotation.PreDestroy;
&nbsp;import jakarta.mail.internet.MimeMessage;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.lang3.exception.ExceptionUtils;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.context.MessageSource;
&nbsp;import org.springframework.context.annotation.Lazy;
&nbsp;import org.springframework.core.NestedRuntimeException;
&nbsp;import org.springframework.core.io.InputStreamSource;
&nbsp;import org.springframework.mail.javamail.JavaMailSender;
&nbsp;import org.springframework.mail.javamail.JavaMailSenderImpl;
&nbsp;import org.springframework.mail.javamail.MimeMessageHelper;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.ui.freemarker.FreeMarkerTemplateUtils;
&nbsp;import org.thingsboard.common.util.ThingsBoardExecutors;
&nbsp;import org.thingsboard.rule.engine.api.MailService;
&nbsp;import org.thingsboard.rule.engine.api.TbEmail;
&nbsp;import org.thingsboard.server.cache.limits.RateLimitService;
&nbsp;import org.thingsboard.server.common.data.AdminSettings;
&nbsp;import org.thingsboard.server.common.data.ApiFeature;
&nbsp;import org.thingsboard.server.common.data.ApiUsageRecordKey;
&nbsp;import org.thingsboard.server.common.data.ApiUsageRecordState;
&nbsp;import org.thingsboard.server.common.data.ApiUsageStateValue;
&nbsp;import org.thingsboard.server.common.data.StringUtils;
&nbsp;import org.thingsboard.server.common.data.exception.RateLimitExceededException;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardErrorCode;
&nbsp;import org.thingsboard.server.common.data.exception.ThingsboardException;
&nbsp;import org.thingsboard.server.common.data.id.CustomerId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.limit.LimitedApi;
&nbsp;import org.thingsboard.server.common.stats.TbApiUsageReportClient;
&nbsp;import org.thingsboard.server.dao.exception.IncorrectParameterException;
&nbsp;import org.thingsboard.server.dao.settings.AdminSettingsService;
&nbsp;import org.thingsboard.server.service.apiusage.TbApiUsageStateService;
&nbsp;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.ScheduledExecutorService;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;import java.util.concurrent.TimeoutException;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class DefaultMailService implements MailService {
&nbsp;
&nbsp;    private static final String TARGET_EMAIL = &quot;targetEmail&quot;;
&nbsp;    private static final String UTF_8 = &quot;UTF-8&quot;;
&nbsp;    private static final long DEFAULT_TIMEOUT = 10_000;
&nbsp;
&nbsp;    private final ScheduledExecutorService timeoutScheduler = ThingsBoardExecutors.newSingleThreadScheduledExecutor(&quot;mail-service-watchdog&quot;);
&nbsp;
&nbsp;    private final MessageSource messages;
&nbsp;    private final Configuration freemarkerConfig;
&nbsp;    private final AdminSettingsService adminSettingsService;
&nbsp;    private final TbApiUsageReportClient apiUsageClient;
&nbsp;    @Lazy
&nbsp;    private final TbApiUsageStateService apiUsageStateService;
&nbsp;    private final MailSenderInternalExecutorService mailExecutorService;
&nbsp;    private final PasswordResetExecutorService passwordResetExecutorService;
&nbsp;    private final TbMailContextComponent ctx;
&nbsp;    private final RateLimitService rateLimitService;
&nbsp;
&nbsp;    @Value(&quot;${mail.per_tenant_rate_limits:}&quot;)
&nbsp;    private String perTenantRateLimitConfig;
&nbsp;
&nbsp;    private TbMailSender mailSender;
&nbsp;
&nbsp;    private String mailFrom;
&nbsp;
&nbsp;    private long timeout;
&nbsp;
&nbsp;    @PostConstruct
&nbsp;    private void init() {
<b class="nc">&nbsp;        updateMailConfiguration();</b>
&nbsp;    }
&nbsp;
&nbsp;    @PreDestroy
&nbsp;    public void destroy() {
<b class="nc">&nbsp;        timeoutScheduler.shutdownNow();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateMailConfiguration() {
<b class="nc">&nbsp;        AdminSettings settings = adminSettingsService.findAdminSettingsByKey(TenantId.SYS_TENANT_ID, &quot;mail&quot;);</b>
<b class="nc">&nbsp;        if (settings != null) {</b>
<b class="nc">&nbsp;            JsonNode jsonConfig = settings.getJsonValue();</b>
<b class="nc">&nbsp;            mailSender = new TbMailSender(ctx, jsonConfig);</b>
<b class="nc">&nbsp;            mailFrom = jsonConfig.get(&quot;mailFrom&quot;).asText();</b>
<b class="nc">&nbsp;            timeout = jsonConfig.get(&quot;timeout&quot;).asLong(DEFAULT_TIMEOUT);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new IncorrectParameterException(&quot;Failed to update mail configuration. Settings not found!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendEmail(TenantId tenantId, String email, String subject, String message) throws ThingsboardException {
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendTestMail(JsonNode jsonConfig, String email) throws ThingsboardException {
<b class="nc">&nbsp;        TbMailSender testMailSender = new TbMailSender(ctx, jsonConfig);</b>
<b class="nc">&nbsp;        String mailFrom = jsonConfig.get(&quot;mailFrom&quot;).asText();</b>
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;test.message.subject&quot;, null, Locale.US);</b>
<b class="nc">&nbsp;        long timeout = jsonConfig.get(&quot;timeout&quot;).asLong(DEFAULT_TIMEOUT);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;test.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(testMailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendActivationEmail(String activationLink, long ttlMs, String email) throws ThingsboardException {
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;activation.subject&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;activationLink&quot;, activationLink);</b>
<b class="nc">&nbsp;        model.put(&quot;activationLinkTtlInHours&quot;, (int) Math.ceil(ttlMs / 3600000.0));</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;activation.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendAccountActivatedEmail(String loginLink, String email) throws ThingsboardException {
&nbsp;
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;account.activated.subject&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;loginLink&quot;, loginLink);</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;account.activated.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendResetPasswordEmail(String passwordResetLink, long ttlMs, String email) throws ThingsboardException {
&nbsp;
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;reset.password.subject&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;passwordResetLink&quot;, passwordResetLink);</b>
<b class="nc">&nbsp;        model.put(&quot;passwordResetLinkTtlInHours&quot;, (int) Math.ceil(ttlMs / 3600000.0));</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;reset.password.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendResetPasswordEmailAsync(String passwordResetLink, long ttlMs, String email) {
<b class="nc">&nbsp;        passwordResetExecutorService.execute(() -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                this.sendResetPasswordEmail(passwordResetLink, ttlMs, email);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;Error occurred: {} &quot;, e.getMessage());</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendPasswordWasResetEmail(String loginLink, String email) throws ThingsboardException {
&nbsp;
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;password.was.reset.subject&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;loginLink&quot;, loginLink);</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;password.was.reset.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void send(TenantId tenantId, CustomerId customerId, TbEmail tbEmail) throws ThingsboardException {
<b class="nc">&nbsp;        sendMail(tenantId, customerId, tbEmail, this.mailSender, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void send(TenantId tenantId, CustomerId customerId, TbEmail tbEmail, JavaMailSender javaMailSender, long timeout) throws ThingsboardException {
<b class="nc">&nbsp;        sendMail(tenantId, customerId, tbEmail, javaMailSender, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void sendMail(TenantId tenantId, CustomerId customerId, TbEmail tbEmail, JavaMailSender javaMailSender, long timeout) throws ThingsboardException {
<b class="nc">&nbsp;        if (apiUsageStateService.getApiUsageState(tenantId).isEmailSendEnabled()) {</b>
<b class="nc">&nbsp;            if (tenantId != null &amp;&amp; !tenantId.isSysTenantId() &amp;&amp; StringUtils.isNotEmpty(perTenantRateLimitConfig) &amp;&amp;</b>
<b class="nc">&nbsp;                    !rateLimitService.checkRateLimit(LimitedApi.EMAILS, (Object) tenantId, perTenantRateLimitConfig)) {</b>
<b class="nc">&nbsp;                throw new RateLimitExceededException(LimitedApi.EMAILS);</b>
&nbsp;            }
&nbsp;            try {
<b class="nc">&nbsp;                MimeMessage mailMsg = javaMailSender.createMimeMessage();</b>
<b class="nc">&nbsp;                boolean multipart = (tbEmail.getImages() != null &amp;&amp; !tbEmail.getImages().isEmpty());</b>
<b class="nc">&nbsp;                MimeMessageHelper helper = new MimeMessageHelper(mailMsg, multipart, &quot;UTF-8&quot;);</b>
<b class="nc">&nbsp;                helper.setFrom(StringUtils.isBlank(tbEmail.getFrom()) ? mailFrom : tbEmail.getFrom());</b>
<b class="nc">&nbsp;                helper.setTo(tbEmail.getTo().split(&quot;\\s*,\\s*&quot;));</b>
<b class="nc">&nbsp;                if (!StringUtils.isBlank(tbEmail.getCc())) {</b>
<b class="nc">&nbsp;                    helper.setCc(tbEmail.getCc().split(&quot;\\s*,\\s*&quot;));</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!StringUtils.isBlank(tbEmail.getBcc())) {</b>
<b class="nc">&nbsp;                    helper.setBcc(tbEmail.getBcc().split(&quot;\\s*,\\s*&quot;));</b>
&nbsp;                }
<b class="nc">&nbsp;                helper.setSubject(tbEmail.getSubject());</b>
<b class="nc">&nbsp;                helper.setText(tbEmail.getBody(), tbEmail.isHtml());</b>
&nbsp;
<b class="nc">&nbsp;                if (multipart) {</b>
<b class="nc">&nbsp;                    for (String imgId : tbEmail.getImages().keySet()) {</b>
<b class="nc">&nbsp;                        String imgValue = tbEmail.getImages().get(imgId);</b>
<b class="nc">&nbsp;                        String value = imgValue.replaceFirst(&quot;^data:image/[^;]*;base64,?&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;                        byte[] bytes = javax.xml.bind.DatatypeConverter.parseBase64Binary(value);</b>
<b class="nc">&nbsp;                        String contentType = helper.getFileTypeMap().getContentType(imgId);</b>
<b class="nc">&nbsp;                        InputStreamSource iss = () -&gt; new ByteArrayInputStream(bytes);</b>
<b class="nc">&nbsp;                        helper.addInline(imgId, iss, contentType);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                sendMailWithTimeout(javaMailSender, helper.getMimeMessage(), timeout);</b>
<b class="nc">&nbsp;                apiUsageClient.report(tenantId, customerId, ApiUsageRecordKey.EMAIL_EXEC_COUNT, 1);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                throw handleException(e);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Email sending is disabled due to API limits!&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendAccountLockoutEmail(String lockoutEmail, String email, Integer maxFailedLoginAttempts) throws ThingsboardException {
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;account.lockout.subject&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;lockoutAccount&quot;, lockoutEmail);</b>
<b class="nc">&nbsp;        model.put(&quot;maxFailedLoginAttempts&quot;, maxFailedLoginAttempts);</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;account.lockout.ftl&quot;, model);</b>
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendTwoFaVerificationEmail(String email, String verificationCode, int expirationTimeSeconds) throws ThingsboardException {
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;2fa.verification.code.subject&quot;, null, Locale.US);</b>
<b class="nc">&nbsp;        String message = mergeTemplateIntoString(&quot;2fa.verification.code.ftl&quot;, Map.of(</b>
&nbsp;                TARGET_EMAIL, email,
&nbsp;                &quot;code&quot;, verificationCode,
<b class="nc">&nbsp;                &quot;expirationTimeSeconds&quot;, expirationTimeSeconds</b>
&nbsp;        ));
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void sendApiFeatureStateEmail(ApiFeature apiFeature, ApiUsageStateValue stateValue, String email, ApiUsageRecordState recordState) throws ThingsboardException {
<b class="nc">&nbsp;        String subject = messages.getMessage(&quot;api.usage.state&quot;, null, Locale.US);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        model.put(&quot;apiFeature&quot;, apiFeature.getLabel());</b>
<b class="nc">&nbsp;        model.put(TARGET_EMAIL, email);</b>
&nbsp;
<b class="nc">&nbsp;        String message = switch (stateValue) {</b>
&nbsp;            case ENABLED -&gt; {
<b class="nc">&nbsp;                model.put(&quot;apiLabel&quot;, toEnabledValueLabel(apiFeature));</b>
<b class="nc">&nbsp;                yield mergeTemplateIntoString(&quot;state.enabled.ftl&quot;, model);</b>
&nbsp;            }
&nbsp;            case WARNING -&gt; {
<b class="nc">&nbsp;                model.put(&quot;apiValueLabel&quot;, toDisabledValueLabel(apiFeature) + &quot; &quot; + toWarningValueLabel(recordState));</b>
<b class="nc">&nbsp;                yield mergeTemplateIntoString(&quot;state.warning.ftl&quot;, model);</b>
&nbsp;            }
&nbsp;            case DISABLED -&gt; {
<b class="nc">&nbsp;                model.put(&quot;apiLimitValueLabel&quot;, toDisabledValueLabel(apiFeature) + &quot; &quot; + toDisabledValueLabel(recordState));</b>
<b class="nc">&nbsp;                yield mergeTemplateIntoString(&quot;state.disabled.ftl&quot;, model);</b>
&nbsp;            }
&nbsp;        };
&nbsp;
<b class="nc">&nbsp;        sendMail(mailSender, mailFrom, email, subject, message, timeout);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void testConnection(TenantId tenantId) throws Exception {
<b class="nc">&nbsp;        mailSender.testConnection();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isConfigured(TenantId tenantId) {
<b class="nc">&nbsp;        return mailSender != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String toEnabledValueLabel(ApiFeature apiFeature) {
<b class="nc">&nbsp;        return switch (apiFeature) {</b>
<b class="nc">&nbsp;            case DB -&gt; &quot;save&quot;;</b>
<b class="nc">&nbsp;            case TRANSPORT -&gt; &quot;receive&quot;;</b>
<b class="nc">&nbsp;            case JS -&gt; &quot;invoke&quot;;</b>
<b class="nc">&nbsp;            case RE -&gt; &quot;process&quot;;</b>
<b class="nc">&nbsp;            case EMAIL, SMS -&gt; &quot;send&quot;;</b>
<b class="nc">&nbsp;            case ALARM -&gt; &quot;create&quot;;</b>
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(&quot;Not implemented!&quot;);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private String toDisabledValueLabel(ApiFeature apiFeature) {
<b class="nc">&nbsp;        return switch (apiFeature) {</b>
<b class="nc">&nbsp;            case DB -&gt; &quot;saved&quot;;</b>
<b class="nc">&nbsp;            case TRANSPORT -&gt; &quot;received&quot;;</b>
<b class="nc">&nbsp;            case JS -&gt; &quot;invoked&quot;;</b>
<b class="nc">&nbsp;            case RE -&gt; &quot;processed&quot;;</b>
<b class="nc">&nbsp;            case EMAIL, SMS -&gt; &quot;sent&quot;;</b>
<b class="nc">&nbsp;            case ALARM -&gt; &quot;created&quot;;</b>
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(&quot;Not implemented!&quot;);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private String toWarningValueLabel(ApiUsageRecordState recordState) {
<b class="nc">&nbsp;        String valueInM = recordState.getValueAsString();</b>
<b class="nc">&nbsp;        String thresholdInM = recordState.getThresholdAsString();</b>
<b class="nc">&nbsp;        return switch (recordState.getKey()) {</b>
<b class="nc">&nbsp;            case STORAGE_DP_COUNT, TRANSPORT_DP_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed data points&quot;;</b>
<b class="nc">&nbsp;            case TRANSPORT_MSG_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed messages&quot;;</b>
<b class="nc">&nbsp;            case JS_EXEC_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed JavaScript functions&quot;;</b>
<b class="nc">&nbsp;            case TBEL_EXEC_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed Tbel functions&quot;;</b>
<b class="nc">&nbsp;            case RE_EXEC_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed Rule Engine messages&quot;;</b>
<b class="nc">&nbsp;            case EMAIL_EXEC_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed Email messages&quot;;</b>
<b class="nc">&nbsp;            case SMS_EXEC_COUNT -&gt; valueInM + &quot; out of &quot; + thresholdInM + &quot; allowed SMS messages&quot;;</b>
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(&quot;Not implemented!&quot;);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private String toDisabledValueLabel(ApiUsageRecordState recordState) {
<b class="nc">&nbsp;        return switch (recordState.getKey()) {</b>
<b class="nc">&nbsp;            case STORAGE_DP_COUNT, TRANSPORT_DP_COUNT -&gt; recordState.getValueAsString() + &quot; data points&quot;;</b>
<b class="nc">&nbsp;            case TRANSPORT_MSG_COUNT -&gt; recordState.getValueAsString() + &quot; messages&quot;;</b>
<b class="nc">&nbsp;            case JS_EXEC_COUNT -&gt; &quot;JavaScript functions &quot; + recordState.getValueAsString() + &quot; times&quot;;</b>
<b class="nc">&nbsp;            case TBEL_EXEC_COUNT -&gt; &quot;TBEL functions &quot; + recordState.getValueAsString() + &quot; times&quot;;</b>
<b class="nc">&nbsp;            case RE_EXEC_COUNT -&gt; recordState.getValueAsString() + &quot; Rule Engine messages&quot;;</b>
<b class="nc">&nbsp;            case EMAIL_EXEC_COUNT -&gt; recordState.getValueAsString() + &quot; Email messages&quot;;</b>
<b class="nc">&nbsp;            case SMS_EXEC_COUNT -&gt; recordState.getValueAsString() + &quot; SMS messages&quot;;</b>
<b class="nc">&nbsp;            default -&gt; throw new RuntimeException(&quot;Not implemented!&quot;);</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private void sendMail(JavaMailSenderImpl mailSender, String mailFrom, String email,
&nbsp;                          String subject, String message, long timeout) throws ThingsboardException {
&nbsp;        try {
<b class="nc">&nbsp;            MimeMessage mimeMsg = mailSender.createMimeMessage();</b>
<b class="nc">&nbsp;            MimeMessageHelper helper = new MimeMessageHelper(mimeMsg, UTF_8);</b>
<b class="nc">&nbsp;            helper.setFrom(mailFrom);</b>
<b class="nc">&nbsp;            helper.setTo(email);</b>
<b class="nc">&nbsp;            helper.setSubject(subject);</b>
<b class="nc">&nbsp;            helper.setText(message, true);</b>
&nbsp;
<b class="nc">&nbsp;            sendMailWithTimeout(mailSender, helper.getMimeMessage(), timeout);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            throw handleException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void sendMailWithTimeout(JavaMailSender mailSender, MimeMessage msg, long timeout) throws ThingsboardException {
<b class="nc">&nbsp;        var submittedMail = Futures.withTimeout(</b>
<b class="nc">&nbsp;                mailExecutorService.submit(() -&gt; mailSender.send(msg)),</b>
&nbsp;                timeout, TimeUnit.MILLISECONDS, timeoutScheduler);
&nbsp;        try {
<b class="nc">&nbsp;            submittedMail.get(timeout, TimeUnit.MILLISECONDS);</b>
&nbsp;        } catch (TimeoutException e) {
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Timeout!&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Unable to send mail&quot;, ExceptionUtils.getRootCause(e), ThingsboardErrorCode.GENERAL);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String mergeTemplateIntoString(String templateLocation,
&nbsp;                                           Map&lt;String, Object&gt; model) throws ThingsboardException {
&nbsp;        try {
<b class="nc">&nbsp;            Template template = freemarkerConfig.getTemplate(templateLocation);</b>
<b class="nc">&nbsp;            return FreeMarkerTemplateUtils.processTemplateIntoString(template, model);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.warn(&quot;Failed to process mail template: {}&quot;, ExceptionUtils.getRootCauseMessage(e));</b>
<b class="nc">&nbsp;            throw new ThingsboardException(&quot;Failed to process mail template: &quot; + e.getMessage(), e, ThingsboardErrorCode.GENERAL);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    protected ThingsboardException handleException(Throwable exception) {
<b class="nc">&nbsp;        if (exception instanceof ThingsboardException thingsboardException) {</b>
<b class="nc">&nbsp;            return thingsboardException;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (exception instanceof NestedRuntimeException) {</b>
<b class="nc">&nbsp;            exception = ((NestedRuntimeException) exception).getMostSpecificCause();</b>
&nbsp;        }
<b class="nc">&nbsp;        log.warn(&quot;Unable to send mail: {}&quot;, exception.getMessage());</b>
<b class="nc">&nbsp;        return new ThingsboardException(&quot;Unable to send mail: &quot; + exception.getMessage(), ThingsboardErrorCode.GENERAL);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>

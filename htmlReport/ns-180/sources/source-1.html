<!--

    Copyright © 2016-2026 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->



<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DefaultEdgeRequestsService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.thingsboard.server.service.edge.rpc.sync</a>
</div>

<h1>Coverage Summary for Class: DefaultEdgeRequestsService (org.thingsboard.server.service.edge.rpc.sync)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DefaultEdgeRequestsService</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/134)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DefaultEdgeRequestsService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultEdgeRequestsService$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultEdgeRequestsService$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DefaultEdgeRequestsService$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/82)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/181)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright © 2016-2026 The Thingsboard Authors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;package org.thingsboard.server.service.edge.rpc.sync;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.JsonNode;
&nbsp;import com.fasterxml.jackson.databind.node.ObjectNode;
&nbsp;import com.google.common.util.concurrent.FutureCallback;
&nbsp;import com.google.common.util.concurrent.Futures;
&nbsp;import com.google.common.util.concurrent.ListenableFuture;
&nbsp;import com.google.common.util.concurrent.SettableFuture;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.checkerframework.checker.nullness.qual.Nullable;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.context.annotation.Lazy;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.thingsboard.common.util.JacksonUtil;
&nbsp;import org.thingsboard.server.common.data.AttributeScope;
&nbsp;import org.thingsboard.server.common.data.EdgeUtils;
&nbsp;import org.thingsboard.server.common.data.EntityType;
&nbsp;import org.thingsboard.server.common.data.EntityView;
&nbsp;import org.thingsboard.server.common.data.edge.Edge;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEvent;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEventActionType;
&nbsp;import org.thingsboard.server.common.data.edge.EdgeEventType;
&nbsp;import org.thingsboard.server.common.data.id.DeviceId;
&nbsp;import org.thingsboard.server.common.data.id.EdgeId;
&nbsp;import org.thingsboard.server.common.data.id.EntityId;
&nbsp;import org.thingsboard.server.common.data.id.EntityIdFactory;
&nbsp;import org.thingsboard.server.common.data.id.RuleChainId;
&nbsp;import org.thingsboard.server.common.data.id.TenantId;
&nbsp;import org.thingsboard.server.common.data.id.UserId;
&nbsp;import org.thingsboard.server.common.data.id.WidgetsBundleId;
&nbsp;import org.thingsboard.server.common.data.kv.AttributeKvEntry;
&nbsp;import org.thingsboard.server.common.data.kv.DataType;
&nbsp;import org.thingsboard.server.common.data.kv.TsKvEntry;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelation;
&nbsp;import org.thingsboard.server.common.data.relation.EntityRelationsQuery;
&nbsp;import org.thingsboard.server.common.data.relation.EntitySearchDirection;
&nbsp;import org.thingsboard.server.common.data.relation.RelationTypeGroup;
&nbsp;import org.thingsboard.server.common.data.relation.RelationsSearchParameters;
&nbsp;import org.thingsboard.server.common.data.widget.WidgetType;
&nbsp;import org.thingsboard.server.common.data.widget.WidgetsBundle;
&nbsp;import org.thingsboard.server.dao.attributes.AttributesService;
&nbsp;import org.thingsboard.server.dao.cf.CalculatedFieldService;
&nbsp;import org.thingsboard.server.dao.edge.EdgeEventService;
&nbsp;import org.thingsboard.server.dao.relation.RelationService;
&nbsp;import org.thingsboard.server.dao.timeseries.TimeseriesService;
&nbsp;import org.thingsboard.server.dao.widget.WidgetTypeService;
&nbsp;import org.thingsboard.server.dao.widget.WidgetsBundleService;
&nbsp;import org.thingsboard.server.gen.edge.v1.AttributesRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.CalculatedFieldRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.DeviceCredentialsRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.EntityViewsRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RelationRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.RuleChainMetadataRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.UserCredentialsRequestMsg;
&nbsp;import org.thingsboard.server.gen.edge.v1.WidgetBundleTypesRequestMsg;
&nbsp;import org.thingsboard.server.queue.util.TbCoreComponent;
&nbsp;import org.thingsboard.server.service.entitiy.entityview.TbEntityViewService;
&nbsp;import org.thingsboard.server.service.executors.DbCallbackExecutorService;
&nbsp;import org.thingsboard.server.service.state.DefaultDeviceStateService;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;@Service
&nbsp;@TbCoreComponent
<b class="nc">&nbsp;@Slf4j</b>
<b class="nc">&nbsp;public class DefaultEdgeRequestsService implements EdgeRequestsService {</b>
&nbsp;
&nbsp;    @Autowired
&nbsp;    private EdgeEventService edgeEventService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private AttributesService attributesService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private TimeseriesService timeseriesService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private RelationService relationService;
&nbsp;
&nbsp;    @Lazy
&nbsp;    @Autowired
&nbsp;    private TbEntityViewService entityViewService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private WidgetsBundleService widgetsBundleService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private WidgetTypeService widgetTypeService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private CalculatedFieldService calculatedFieldService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private DbCallbackExecutorService dbCallbackExecutorService;
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processRuleChainMetadataRequestMsg(TenantId tenantId, Edge edge, RuleChainMetadataRequestMsg ruleChainMetadataRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processRuleChainMetadataRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), ruleChainMetadataRequestMsg);</b>
<b class="nc">&nbsp;        if (ruleChainMetadataRequestMsg.getRuleChainIdMSB() == 0 || ruleChainMetadataRequestMsg.getRuleChainIdLSB() == 0) {</b>
<b class="nc">&nbsp;            return Futures.immediateFuture(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        RuleChainId ruleChainId = new RuleChainId(new UUID(ruleChainMetadataRequestMsg.getRuleChainIdMSB(), ruleChainMetadataRequestMsg.getRuleChainIdLSB()));</b>
<b class="nc">&nbsp;        return saveEdgeEvent(tenantId, edge.getId(), EdgeEventType.RULE_CHAIN_METADATA, EdgeEventActionType.ADDED, ruleChainId, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processAttributesRequestMsg(TenantId tenantId, Edge edge, AttributesRequestMsg attributesRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processAttributesRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), attributesRequestMsg);</b>
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(</b>
<b class="nc">&nbsp;                EntityType.valueOf(attributesRequestMsg.getEntityType()),</b>
<b class="nc">&nbsp;                new UUID(attributesRequestMsg.getEntityIdMSB(), attributesRequestMsg.getEntityIdLSB()));</b>
<b class="nc">&nbsp;        final EdgeEventType entityType = EdgeUtils.getEdgeEventTypeByEntityType(entityId.getEntityType());</b>
<b class="nc">&nbsp;        if (entityType == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;[{}] Type doesn&#39;t supported {}&quot;, tenantId, entityId.getEntityType());</b>
<b class="nc">&nbsp;            return Futures.immediateFuture(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        String scope = attributesRequestMsg.getScope();</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;AttributeKvEntry&gt;&gt; findAttrFuture = attributesService.findAll(tenantId, entityId, AttributeScope.valueOf(scope));</b>
<b class="nc">&nbsp;        return Futures.transformAsync(findAttrFuture, ssAttributes</b>
<b class="nc">&nbsp;                        -&gt; processEntityAttributesAndAddToEdgeQueue(tenantId, entityId, edge, entityType, scope, ssAttributes, attributesRequestMsg),</b>
&nbsp;                dbCallbackExecutorService);
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; processEntityAttributesAndAddToEdgeQueue(TenantId tenantId, EntityId entityId, Edge edge,
&nbsp;                                                                            EdgeEventType entityType, String scope, List&lt;AttributeKvEntry&gt; ssAttributes,
&nbsp;                                                                            AttributesRequestMsg attributesRequestMsg) {
<b class="nc">&nbsp;        Map&lt;String, Object&gt; entityData = null;</b>
<b class="nc">&nbsp;        ObjectNode attributes = null;</b>
&nbsp;        ListenableFuture&lt;Void&gt; future;
&nbsp;        try {
<b class="nc">&nbsp;            if (ssAttributes == null || ssAttributes.isEmpty()) {</b>
<b class="nc">&nbsp;                log.trace(&quot;[{}][{}] No attributes found for entity {} [{}]&quot;, tenantId,</b>
<b class="nc">&nbsp;                        edge.getName(),</b>
<b class="nc">&nbsp;                        entityId.getEntityType(),</b>
<b class="nc">&nbsp;                        entityId.getId());</b>
<b class="nc">&nbsp;                future = Futures.immediateFuture(null);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                entityData = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                attributes = JacksonUtil.newObjectNode();</b>
<b class="nc">&nbsp;                for (AttributeKvEntry attr : ssAttributes) {</b>
<b class="nc">&nbsp;                    if (DefaultDeviceStateService.ACTIVITY_KEYS_WITHOUT_INACTIVITY_TIMEOUT.contains(attr.getKey())) {</b>
&nbsp;                        continue;
&nbsp;                    }
<b class="nc">&nbsp;                    if (attr.getDataType() == DataType.BOOLEAN &amp;&amp; attr.getBooleanValue().isPresent()) {</b>
<b class="nc">&nbsp;                        attributes.put(attr.getKey(), attr.getBooleanValue().get());</b>
<b class="nc">&nbsp;                    } else if (attr.getDataType() == DataType.DOUBLE &amp;&amp; attr.getDoubleValue().isPresent()) {</b>
<b class="nc">&nbsp;                        attributes.put(attr.getKey(), attr.getDoubleValue().get());</b>
<b class="nc">&nbsp;                    } else if (attr.getDataType() == DataType.LONG &amp;&amp; attr.getLongValue().isPresent()) {</b>
<b class="nc">&nbsp;                        attributes.put(attr.getKey(), attr.getLongValue().get());</b>
<b class="nc">&nbsp;                    } else if (attr.getDataType() == DataType.JSON &amp;&amp; attr.getJsonValue().isPresent()) {</b>
<b class="nc">&nbsp;                        attributes.set(attr.getKey(), JacksonUtil.toJsonNode(attr.getJsonValue().get()));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        attributes.put(attr.getKey(), attr.getValueAsString());</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (!attributes.isEmpty()) {</b>
<b class="nc">&nbsp;                    entityData.put(&quot;kv&quot;, attributes);</b>
<b class="nc">&nbsp;                    entityData.put(&quot;scope&quot;, scope);</b>
<b class="nc">&nbsp;                    JsonNode body = JacksonUtil.valueToTree(entityData);</b>
<b class="nc">&nbsp;                    log.debug(&quot;[{}] Sending attributes data msg, entityId [{}], attributes [{}]&quot;, tenantId, entityId, body);</b>
<b class="nc">&nbsp;                    future = saveEdgeEvent(tenantId, edge.getId(), entityType, EdgeEventActionType.ATTRIBUTES_UPDATED, entityId, body);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    future = Futures.immediateFuture(null);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return Futures.transformAsync(future, v -&gt; processLatestTimeseriesAndAddToEdgeQueue(tenantId, entityId, edge, entityType), dbCallbackExecutorService);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            String errMsg = String.format(&quot;[%s][%s] Failed to save attribute updates to the edge [%s], scope = %s, entityData = %s, attributes = %s&quot;,</b>
<b class="nc">&nbsp;                    tenantId, edge.getId(), attributesRequestMsg, scope, entityData, attributes);</b>
<b class="nc">&nbsp;            log.error(errMsg, e);</b>
<b class="nc">&nbsp;            return Futures.immediateFailedFuture(new RuntimeException(errMsg, e));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; processLatestTimeseriesAndAddToEdgeQueue(TenantId tenantId, EntityId entityId, Edge edge,
&nbsp;                                                                            EdgeEventType entityType) {
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;TsKvEntry&gt;&gt; getAllLatestFuture = timeseriesService.findAllLatest(tenantId, entityId);</b>
<b class="nc">&nbsp;        return Futures.transformAsync(getAllLatestFuture, tsKvEntries -&gt; {</b>
<b class="nc">&nbsp;            if (tsKvEntries == null || tsKvEntries.isEmpty()) {</b>
<b class="nc">&nbsp;                log.trace(&quot;[{}][{}] No timeseries found for entity {} [{}]&quot;, tenantId,</b>
<b class="nc">&nbsp;                        edge.getName(),</b>
<b class="nc">&nbsp;                        entityId.getEntityType(),</b>
<b class="nc">&nbsp;                        entityId.getId());</b>
<b class="nc">&nbsp;                return Futures.immediateFuture(null);</b>
&nbsp;            }
<b class="nc">&nbsp;            Map&lt;Long, Map&lt;String, Object&gt;&gt; tsData = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            for (TsKvEntry tsKvEntry : tsKvEntries) {</b>
<b class="nc">&nbsp;                if (DefaultDeviceStateService.ACTIVITY_KEYS_WITH_INACTIVITY_TIMEOUT.contains(tsKvEntry.getKey())) {</b>
&nbsp;                    continue;
&nbsp;                }
<b class="nc">&nbsp;                tsData.computeIfAbsent(tsKvEntry.getTs(), k -&gt; new HashMap&lt;&gt;()).put(tsKvEntry.getKey(), tsKvEntry.getValue());</b>
&nbsp;            }
<b class="nc">&nbsp;            List&lt;ListenableFuture&lt;Void&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;            for (Map.Entry&lt;Long, Map&lt;String, Object&gt;&gt; entry : tsData.entrySet()) {</b>
<b class="nc">&nbsp;                Map&lt;String, Object&gt; entityBody = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                entityBody.put(&quot;data&quot;, entry.getValue());</b>
<b class="nc">&nbsp;                entityBody.put(&quot;ts&quot;, entry.getKey());</b>
<b class="nc">&nbsp;                futures.add(saveEdgeEvent(tenantId, edge.getId(), entityType, EdgeEventActionType.TIMESERIES_UPDATED, entityId, JacksonUtil.valueToTree(entityBody)));</b>
&nbsp;            }
<b class="nc">&nbsp;            return Futures.transform(Futures.allAsList(futures), v -&gt; null, dbCallbackExecutorService);</b>
&nbsp;        }, dbCallbackExecutorService);
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processRelationRequestMsg(TenantId tenantId, Edge edge, RelationRequestMsg relationRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processRelationRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), relationRequestMsg);</b>
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(</b>
<b class="nc">&nbsp;                EntityType.valueOf(relationRequestMsg.getEntityType()),</b>
<b class="nc">&nbsp;                new UUID(relationRequestMsg.getEntityIdMSB(), relationRequestMsg.getEntityIdLSB()));</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;ListenableFuture&lt;List&lt;EntityRelation&gt;&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        futures.add(findRelationByQuery(tenantId, edge, entityId, EntitySearchDirection.FROM));</b>
<b class="nc">&nbsp;        futures.add(findRelationByQuery(tenantId, edge, entityId, EntitySearchDirection.TO));</b>
<b class="nc">&nbsp;        ListenableFuture&lt;List&lt;List&lt;EntityRelation&gt;&gt;&gt; relationsListFuture = Futures.allAsList(futures);</b>
<b class="nc">&nbsp;        SettableFuture&lt;Void&gt; futureToSet = SettableFuture.create();</b>
<b class="nc">&nbsp;        Futures.addCallback(relationsListFuture, new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(@Nullable List&lt;List&lt;EntityRelation&gt;&gt; relationsList) {
&nbsp;                try {
<b class="nc">&nbsp;                    if (relationsList != null &amp;&amp; !relationsList.isEmpty()) {</b>
<b class="nc">&nbsp;                        List&lt;ListenableFuture&lt;Void&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                        for (List&lt;EntityRelation&gt; entityRelations : relationsList) {</b>
<b class="nc">&nbsp;                            if (entityRelations.isEmpty()) {</b>
&nbsp;                                continue;
&nbsp;                            }
<b class="nc">&nbsp;                            log.trace(&quot;[{}][{}][{}][{}] relation(s) are going to be pushed to edge.&quot;, tenantId, edge.getId(), entityId, entityRelations.size());</b>
<b class="nc">&nbsp;                            for (EntityRelation relation : entityRelations) {</b>
&nbsp;                                try {
<b class="nc">&nbsp;                                    if (!relation.getFrom().getEntityType().equals(EntityType.EDGE) &amp;&amp;</b>
<b class="nc">&nbsp;                                            !relation.getTo().getEntityType().equals(EntityType.EDGE)) {</b>
<b class="nc">&nbsp;                                        futures.add(saveEdgeEvent(tenantId,</b>
<b class="nc">&nbsp;                                                edge.getId(),</b>
&nbsp;                                                EdgeEventType.RELATION,
&nbsp;                                                EdgeEventActionType.ADDED,
&nbsp;                                                null,
<b class="nc">&nbsp;                                                JacksonUtil.valueToTree(relation)));</b>
&nbsp;                                    }
&nbsp;                                } catch (Exception e) {
<b class="nc">&nbsp;                                    String errMsg = String.format(&quot;[%s][%s] Exception during loading relation [%s] to edge on sync!&quot;, tenantId, edge.getId(), relation);</b>
<b class="nc">&nbsp;                                    log.error(errMsg, e);</b>
<b class="nc">&nbsp;                                    futureToSet.setException(new RuntimeException(errMsg, e));</b>
&nbsp;                                    return;
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
<b class="nc">&nbsp;                        if (futures.isEmpty()) {</b>
<b class="nc">&nbsp;                            futureToSet.set(null);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            Futures.addCallback(Futures.allAsList(futures), new FutureCallback&lt;&gt;() {</b>
&nbsp;                                @Override
&nbsp;                                public void onSuccess(@Nullable List&lt;Void&gt; voids) {
<b class="nc">&nbsp;                                    futureToSet.set(null);</b>
&nbsp;                                }
&nbsp;
&nbsp;                                @Override
&nbsp;                                public void onFailure(Throwable throwable) {
<b class="nc">&nbsp;                                    String errMsg = String.format(&quot;[%s][%s] Exception during saving edge events [%s]!&quot;, tenantId, edge.getId(), relationRequestMsg);</b>
<b class="nc">&nbsp;                                    log.error(errMsg, throwable);</b>
<b class="nc">&nbsp;                                    futureToSet.setException(new RuntimeException(errMsg, throwable));</b>
&nbsp;                                }
&nbsp;                            }, dbCallbackExecutorService);
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        futureToSet.set(null);</b>
&nbsp;                    }
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.error(&quot;[{}] Exception during loading relation(s) to edge on sync!&quot;, tenantId, e);</b>
<b class="nc">&nbsp;                    futureToSet.setException(e);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                String errMsg = String.format(&quot;[%s] Can&#39;t find relation by query. Entity id [%s]!&quot;, tenantId, entityId);</b>
<b class="nc">&nbsp;                log.error(errMsg, t);</b>
<b class="nc">&nbsp;                futureToSet.setException(new RuntimeException(errMsg, t));</b>
&nbsp;            }
&nbsp;        }, dbCallbackExecutorService);
<b class="nc">&nbsp;        return futureToSet;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processCalculatedFieldRequestMsg(TenantId tenantId, Edge edge, CalculatedFieldRequestMsg calculatedFieldRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processCalculatedFieldRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), calculatedFieldRequestMsg);</b>
&nbsp;
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(</b>
<b class="nc">&nbsp;                EntityType.valueOf(calculatedFieldRequestMsg.getEntityType()),</b>
<b class="nc">&nbsp;                new UUID(calculatedFieldRequestMsg.getEntityIdMSB(), calculatedFieldRequestMsg.getEntityIdLSB()));</b>
&nbsp;
<b class="nc">&nbsp;        log.trace(&quot;[{}] processCalculatedField [{}][{}] for entity [{}][{}]&quot;, tenantId, edge.getName(), calculatedFieldRequestMsg, entityId.getEntityType(), entityId.getId());</b>
<b class="nc">&nbsp;        return saveCalculatedFieldsToEdge(tenantId, edge.getId(), entityId);</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; saveCalculatedFieldsToEdge(TenantId tenantId, EdgeId edgeId, EntityId entityId) {
<b class="nc">&nbsp;        return Futures.transformAsync(</b>
<b class="nc">&nbsp;                dbCallbackExecutorService.submit(() -&gt; calculatedFieldService.findCalculatedFieldsByEntityId(tenantId, entityId)),</b>
&nbsp;                calculatedFields -&gt; {
<b class="nc">&nbsp;                    log.trace(&quot;[{}][{}][{}][{}] calculatedField(s) are going to be pushed to edge.&quot;, tenantId, edgeId, entityId, calculatedFields.size());</b>
&nbsp;
<b class="nc">&nbsp;                    List&lt;ListenableFuture&lt;?&gt;&gt; futures = calculatedFields.stream().map(calculatedField -&gt; {</b>
&nbsp;                        try {
<b class="nc">&nbsp;                            return saveEdgeEvent(tenantId, edgeId, EdgeEventType.CALCULATED_FIELD,</b>
<b class="nc">&nbsp;                                    EdgeEventActionType.ADDED, calculatedField.getId(), JacksonUtil.valueToTree(calculatedField));</b>
&nbsp;                        } catch (Exception e) {
<b class="nc">&nbsp;                            log.error(&quot;[{}][{}] Exception during loading calculatedField [{}] to edge on sync!&quot;, tenantId, edgeId, calculatedField, e);</b>
<b class="nc">&nbsp;                            return Futures.immediateFailedFuture(e);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }).toList();</b>
&nbsp;
<b class="nc">&nbsp;                    return Futures.transform(</b>
<b class="nc">&nbsp;                            Futures.allAsList(futures),</b>
<b class="nc">&nbsp;                            voids -&gt; null,</b>
&nbsp;                            dbCallbackExecutorService
&nbsp;                    );
&nbsp;                },
&nbsp;                dbCallbackExecutorService
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;List&lt;EntityRelation&gt;&gt; findRelationByQuery(TenantId tenantId, Edge edge, EntityId entityId, EntitySearchDirection direction) {
<b class="nc">&nbsp;        EntityRelationsQuery query = new EntityRelationsQuery();</b>
<b class="nc">&nbsp;        query.setParameters(new RelationsSearchParameters(entityId, direction, 1, false));</b>
<b class="nc">&nbsp;        return relationService.findByQuery(tenantId, query);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processDeviceCredentialsRequestMsg(TenantId tenantId, Edge edge, DeviceCredentialsRequestMsg deviceCredentialsRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processDeviceCredentialsRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), deviceCredentialsRequestMsg);</b>
<b class="nc">&nbsp;        if (deviceCredentialsRequestMsg.getDeviceIdMSB() == 0 || deviceCredentialsRequestMsg.getDeviceIdLSB() == 0) {</b>
<b class="nc">&nbsp;            return Futures.immediateFuture(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        DeviceId deviceId = new DeviceId(new UUID(deviceCredentialsRequestMsg.getDeviceIdMSB(), deviceCredentialsRequestMsg.getDeviceIdLSB()));</b>
<b class="nc">&nbsp;        return saveEdgeEvent(tenantId, edge.getId(), EdgeEventType.DEVICE,</b>
&nbsp;                EdgeEventActionType.CREDENTIALS_UPDATED, deviceId, null);
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processUserCredentialsRequestMsg(TenantId tenantId, Edge edge, UserCredentialsRequestMsg userCredentialsRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processUserCredentialsRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), userCredentialsRequestMsg);</b>
<b class="nc">&nbsp;        if (userCredentialsRequestMsg.getUserIdMSB() == 0 || userCredentialsRequestMsg.getUserIdLSB() == 0) {</b>
<b class="nc">&nbsp;            return Futures.immediateFuture(null);</b>
&nbsp;        }
<b class="nc">&nbsp;        UserId userId = new UserId(new UUID(userCredentialsRequestMsg.getUserIdMSB(), userCredentialsRequestMsg.getUserIdLSB()));</b>
<b class="nc">&nbsp;        return saveEdgeEvent(tenantId, edge.getId(), EdgeEventType.USER,</b>
&nbsp;                EdgeEventActionType.CREDENTIALS_UPDATED, userId, null);
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processWidgetBundleTypesRequestMsg(TenantId tenantId, Edge edge,
&nbsp;                                                                     WidgetBundleTypesRequestMsg widgetBundleTypesRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processWidgetBundleTypesRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), widgetBundleTypesRequestMsg);</b>
<b class="nc">&nbsp;        List&lt;ListenableFuture&lt;Void&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (widgetBundleTypesRequestMsg.getWidgetBundleIdMSB() != 0 &amp;&amp; widgetBundleTypesRequestMsg.getWidgetBundleIdLSB() != 0) {</b>
<b class="nc">&nbsp;            WidgetsBundleId widgetsBundleId = new WidgetsBundleId(new UUID(widgetBundleTypesRequestMsg.getWidgetBundleIdMSB(), widgetBundleTypesRequestMsg.getWidgetBundleIdLSB()));</b>
<b class="nc">&nbsp;            WidgetsBundle widgetsBundleById = widgetsBundleService.findWidgetsBundleById(tenantId, widgetsBundleId);</b>
<b class="nc">&nbsp;            if (widgetsBundleById != null) {</b>
<b class="nc">&nbsp;                List&lt;WidgetType&gt; widgetTypesToPush =</b>
<b class="nc">&nbsp;                        widgetTypeService.findWidgetTypesByWidgetsBundleId(widgetsBundleById.getTenantId(), widgetsBundleId);</b>
<b class="nc">&nbsp;                for (WidgetType widgetType : widgetTypesToPush) {</b>
<b class="nc">&nbsp;                    futures.add(saveEdgeEvent(tenantId, edge.getId(), EdgeEventType.WIDGET_TYPE, EdgeEventActionType.ADDED, widgetType.getId(), null));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return Futures.transform(Futures.allAsList(futures), voids -&gt; null, dbCallbackExecutorService);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ListenableFuture&lt;Void&gt; processEntityViewsRequestMsg(TenantId tenantId, Edge edge, EntityViewsRequestMsg entityViewsRequestMsg) {
<b class="nc">&nbsp;        log.trace(&quot;[{}] processEntityViewsRequestMsg [{}][{}]&quot;, tenantId, edge.getName(), entityViewsRequestMsg);</b>
<b class="nc">&nbsp;        EntityId entityId = EntityIdFactory.getByTypeAndUuid(</b>
<b class="nc">&nbsp;                EntityType.valueOf(entityViewsRequestMsg.getEntityType()),</b>
<b class="nc">&nbsp;                new UUID(entityViewsRequestMsg.getEntityIdMSB(), entityViewsRequestMsg.getEntityIdLSB()));</b>
<b class="nc">&nbsp;        SettableFuture&lt;Void&gt; futureToSet = SettableFuture.create();</b>
<b class="nc">&nbsp;        Futures.addCallback(entityViewService.findEntityViewsByTenantIdAndEntityIdAsync(tenantId, entityId), new FutureCallback&lt;&gt;() {</b>
&nbsp;            @Override
&nbsp;            public void onSuccess(@Nullable List&lt;EntityView&gt; entityViews) {
<b class="nc">&nbsp;                if (entityViews == null || entityViews.isEmpty()) {</b>
<b class="nc">&nbsp;                    futureToSet.set(null);</b>
&nbsp;                    return;
&nbsp;                }
<b class="nc">&nbsp;                List&lt;ListenableFuture&lt;Void&gt;&gt; futures = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                for (EntityView entityView : entityViews) {</b>
<b class="nc">&nbsp;                    ListenableFuture&lt;Boolean&gt; future = relationService.checkRelationAsync(tenantId, edge.getId(), entityView.getId(),</b>
&nbsp;                            EntityRelation.CONTAINS_TYPE, RelationTypeGroup.EDGE);
<b class="nc">&nbsp;                    futures.add(Futures.transformAsync(future, result -&gt; {</b>
<b class="nc">&nbsp;                        if (Boolean.TRUE.equals(result)) {</b>
<b class="nc">&nbsp;                            return saveEdgeEvent(tenantId, edge.getId(), EdgeEventType.ENTITY_VIEW,</b>
<b class="nc">&nbsp;                                    EdgeEventActionType.ADDED, entityView.getId(), null);</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            return Futures.immediateFuture(null);</b>
&nbsp;                        }
&nbsp;                    }, dbCallbackExecutorService));
&nbsp;                }
<b class="nc">&nbsp;                Futures.addCallback(Futures.allAsList(futures), new FutureCallback&lt;&gt;() {</b>
&nbsp;                    @Override
&nbsp;                    public void onSuccess(@Nullable List&lt;Void&gt; result) {
<b class="nc">&nbsp;                        futureToSet.set(null);</b>
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void onFailure(Throwable t) {
<b class="nc">&nbsp;                        log.error(&quot;[{}] Exception during loading relation to edge on sync!&quot;, tenantId, t);</b>
<b class="nc">&nbsp;                        futureToSet.setException(t);</b>
&nbsp;                    }
&nbsp;                }, dbCallbackExecutorService);
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void onFailure(Throwable t) {
<b class="nc">&nbsp;                log.error(&quot;[{}] Can&#39;t find entity views by entity id [{}]&quot;, tenantId, entityId, t);</b>
<b class="nc">&nbsp;                futureToSet.setException(t);</b>
&nbsp;            }
&nbsp;        }, dbCallbackExecutorService);
<b class="nc">&nbsp;        return futureToSet;</b>
&nbsp;    }
&nbsp;
&nbsp;    private ListenableFuture&lt;Void&gt; saveEdgeEvent(TenantId tenantId,
&nbsp;                                                 EdgeId edgeId,
&nbsp;                                                 EdgeEventType type,
&nbsp;                                                 EdgeEventActionType action,
&nbsp;                                                 EntityId entityId,
&nbsp;                                                 JsonNode body) {
<b class="nc">&nbsp;        log.trace(&quot;Pushing edge event to edge queue. tenantId [{}], edgeId [{}], type [{}], action[{}], entityId [{}], body [{}]&quot;,</b>
&nbsp;                tenantId, edgeId, type, action, entityId, body);
&nbsp;
<b class="nc">&nbsp;        EdgeEvent edgeEvent = EdgeUtils.constructEdgeEvent(tenantId, edgeId, type, action, entityId, body);</b>
<b class="nc">&nbsp;        return edgeEventService.saveAsync(edgeEvent);</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-02-07 20:03</div>
</div>
</body>
</html>
